 use wsaaddress string instead inet ntop window inet ntop doe exist window xp ca nt use `const sockaddr ` wsaaddress string take lpsockaddr addr str sockaddr addr str size t str size port ret ifdef win dword dw str size size t addr len addr sa famili af inet addr len sockaddr port ntoh sockaddr addr sin port af inet addr len sockaddr port ntoh sockaddr addr sin port dw str size str size addr len wsaaddress string w addr addr len null lpwstr str dw str size ret addr sa famili af inet port ntoh sockaddr addr sin port inet ntop addr sa famili sockaddr addr sin addr str str size ret af inet port ntoh sockaddr addr sin port inet ntop addr sa famili sockaddr addr sin addr str str size ret endif ret use wsaaddress string instead inet ntop window inet ntop doe exist window xp ca nt use `const sockaddr ` wsaaddress string take lpsockaddr tcw err t tcw direct close tcw sock t sock tcw err t ret tcw ok close socket sock sock fd est log err `` close fail d sock err ret tcw err close sock err set sock sock fd sock invalid ret establish direct socket connect est server use normal call tcw err t tcw direct connect tcw sock t sock tcw opt t opt host port tcw err t ret tcw ok addrinfo addr null addrinfo cur addr sock type fd err save err port str   sock addr str  inet addrstrlen  sock port addrinfo hint n hint ai socktyp sock stream hint ai flag ai addrconfig n snprintf port str port str `` hu port n n port str errno enomem ret tcw err alloc est log info `` getaddrinfo s s host port str err getaddrinfo host port str hint addr est log err `` getaddrinfo return d s err gai strerror err ret tcw err resolv ifdef win sock err set err eai sock err set eai memori set sock err nomem resolv host set sock err nonam endif cur addr addr cur addr ret tcw ok fd socket cur addr ai famili sock stream ipproto tcp fd est log warn `` socket fail d sock err ret tcw err socket cur addr cur addr ai err addr str cur addr ai addr sock addr str sock addr str sock port err est log info `` connect s port hu sock addr str sock port connect fd cur addr ai addr cur addr ai addrlen est log warn `` connect fail d sock err ret tcw err connect close socket clobber sock err save err sock err close socket fd fd sock invalid set sock err save err cur addr cur addr ai fd sock sock fd fd est log err `` connect s hu host port ret sock err set ret establish direct socket connect est server use normal call tcw err t tcw curl close tcw sock t sock tcw err t ret tcw ok sock curl handl curl easi cleanup sock curl handl sock curl handl null sock sock fd sock invalid ret establish direct socket connect est server use normal call tcw err t set block mode tcw sock t sock block tcw err t ret tcw ok ifdef win result mode block result ioctlsocket sock sock fd fionbio mode result error https msdn microsoft com en librari window desktop ms vvs aspx ioctl ioctlsocket wsaioctl various c languag run time system use ioctl purpos unrel window socket consequ ioctlsocket function wsaioctl function defin handl socket function perform ioctl fcntl berkeley softwar distribut ioctlsocket window equival ioctl fcntl just set type accord ret tcw err fcntl flag fcntl sock sock fd f getfl flag est log err `` fcntl f getfl fail d sock err sock err set ret tcw err fcntl flag block flag o nonblock flag o nonblock fcntl sock sock fd f setfl flag est log err `` fcntl f setfl fail d sock err sock err set ret tcw err fcntl endif win ret establish socket remot server use libcurl actual send url leverag libcurl s proxi support just establish connect tcw err t tcw curl connect tcw sock t sock tcw opt t opt host port tcw err t ret tcw ok size t url size url null curlcod curlcod curl socket auth bit proxi type save err proxi type str `` n sock curl handl curl easi init sock curl handl est log err `` curl easi init fail errno enomem ret tcw err alloc want libcurl establish connect proxi server s ll use socket normal direct connect est server curlcod curl easi setopt sock curl handl curlopt connect curlcod curl ok est log err `` curl easi setopt curlopt connect return d s curlcod curl easi strerror curlcod errno einval ret tcw err url size strlen host tcw url schema port size url calloc url size url est log err `` calloc fail errno enomem ret tcw err alloc `` http tell libcurl wrap data send ssl n snprintf url url size `` http s hu host port n n url size errno enomem ret tcw err alloc curlcod curl easi setopt sock curl handl curlopt url url curlcod curl ok est log err `` curl easi setopt curlopt url return d s curlcod curl easi strerror curlcod errno einval ret tcw err proxi host port curlcod curl easi setopt sock curl handl curlopt proxi opt proxi host curlcod curl ok est log err `` curl easi setopt curlopt proxi return d s curlcod curl easi strerror curlcod errno einval ret tcw err curlcod curl easi setopt sock curl handl curlopt proxyport opt proxi port curlcod curl ok est log err `` curl easi setopt curlopt proxyport return d s curlcod curl easi strerror curlcod errno einval ret tcw err proxi protocol includ http tunnel mode opt proxi proto est client proxi http notunnel proxi type curlproxi http proxi type str `` http tunnel opt proxi proto est client proxi http tunnel proxi type curlproxi http proxi type str `` http tunnel opt proxi proto est client proxi sock proxi type curlproxi sock proxi type str `` sock opt proxi proto est client proxi sock proxi type curlproxi sock proxi type str `` sock opt proxi proto est client proxi socksa proxi type curlproxi socksa proxi type str `` socksa opt proxi proto est client proxi sock hostnam proxi type curlproxi sock hostnam proxi type str `` sock hostnam curlcod curl easi setopt sock curl handl curlopt proxytyp proxi type curlcod curl ok est log err `` curl easi setopt curlopt proxytyp return d s curlcod curl easi strerror curlcod errno einval ret tcw err opt proxi proto est client proxi http tunnel curlcod curl easi setopt sock curl handl curlopt httpproxytunnel curlcod curl ok est log err `` curl easi setopt curlopt httpproxytunnel return d s curlcod curl easi strerror curlcod errno einval ret tcw err curlcod curl easi setopt sock curl handl curlopt proxyauth curlauth basiccurlauth curlcod curl ok est log err `` curl easi setopt curlopt proxyauth return d s curlcod curl easi strerror curlcod errno einval ret tcw err usernam password opt proxi usernam opt proxi password curlcod curl easi setopt sock curl handl curlopt proxyusernam opt proxi usernam curlcod curl ok est log err `` curl easi setopt curlopt proxyusernam return d s curlcod curl easi strerror curlcod errno einval ret tcw err curlcod curl easi setopt sock curl handl curlopt proxypassword opt proxi password curlcod curl ok est log err `` curl easi setopt curlopt proxypassword return d s curlcod curl easi strerror curlcod errno einval ret tcw err auth bit opt proxi auth est client proxi auth basic auth bit curlauth basic opt proxi auth est client proxi auth ntlm auth bit curlauth ntlm auth bit curlcod curl easi setopt sock curl handl curlopt proxyauth auth bit curlcod curl ok est log err `` curl easi setopt curlopt proxyauth return d s curlcod curl easi strerror curlcod errno einval ret tcw err signal generat libcurl curlcod curl easi setopt sock curl handl curlopt nosign curlcod curl ok est log err `` curl easi setopt curlopt nosign return d s curlcod curl easi strerror curlcod errno einval ret tcw err perform curl request est log info `` curl easi perform s proxi type s url proxi type str curlcod curl easi perform sock curl handl curlcod curl ok est log err `` curl easi perform s return d s url curlcod curl easi strerror curlcod curlcod curl resolv proxi curlcod curl resolv host set sock err nonam ret tcw err resolv set sock err conn ret tcw err connect retriev socket libcurl curlcod curl easi getinfo sock curl handl curlinfo lastsocket curl socket curlcod curl ok est log err `` curl easi getinfo curlinfo lastsocket return d s curlcod curl easi strerror curlcod errno einval ret tcw err curl socket est log err `` curlinfo lastsocket invalid socket errno einval ret tcw err sock sock fd curl socket connect set socket block ret set block mode sock ret tcw ok sock err set est log err `` fail set socket block free url url null ret tcw ok save err sock err tcw curl close sock set sock err save err ret entri point establish connect remot est server tcw err t tcw connect tcw sock t sock tcw opt t opt host port sock type sock fd tcw err t ret tcw ok memset sock tcw sock t sock sock fd sock invalid sock proxi proto opt proxi proto sock proxi proto est client proxi ifdef libcurl ret tcw curl connect sock opt host port make far log messag wrong est log err `` proxi set current libcurl errno einval ret tcw err arg endif ret tcw direct connect sock opt host port ret tcw ok est log info `` success connect s hu host port sock fd sock sock fd ret entri point establish connect remot est server tcw err t tcw close tcw sock t sock tcw err t ret tcw ok sock proxi proto est client proxi ret tcw direct close sock ifdef libcurl ret tcw curl close sock endif ret