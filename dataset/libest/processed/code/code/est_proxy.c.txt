 hijack open ssl buf mem data util function allow free buf mem free under data est proxi free ossl bufmem buf mem b b data null buf mem free b bsearch compar use bsearch function perform comparison node client context array bsearch compar pa pb result client ctx lu node t client ctx lu node t pa client ctx lu node t b client ctx lu node t pb threadid b threadid result threadid b threadid result threadid b threadid result result client ctx perform search order array key search current thread id valu return client context s creat thread entri exist array thread id new creat est ctx client ctx est ctx p ctx est ctx c ctx null est error rv cur threadid cur pid getpid client ctx lu node t node zero threadid x client ctx lu node t node index window todo like need replac current thread id addit realli return pointer opaqu valu s use typic pointer pthread base environ actual pthread id helper api access actual id pthread equal use array search best chang linear search mix pid current process thread id applic fork new process e g nginx ifndef disabl pthread cur threadid pthread self endif cur threadid cur pid node client ctx lu node t bsearch cur threadid p ctx client ctx array cur max ctx array client ctx lu node t bsearch compar node null need alloc context readi use c ctx est client init p ctx ca chain raw p ctx ca chain raw len est cert format pem null c ctx null est log err `` unabl alloc initi est client context proxi use null bit mislead ident cert privat key use proxi mode one store server cert server priv key use direct set client look mix want chang context hold rv est client set auth c ctx p ctx userid p ctx password p ctx server cert p ctx server priv key rv est err est log err `` unabl set authent configur client context proxi use est destroy c ctx null rv est client set auth cred cb c ctx p ctx auth credenti cb rv est err est log err `` unabl authent credenti callback `` null wrt path segment unlik true client mode path segment chang request go upstream need obtain local proxi set time left null rv est client set server c ctx p ctx est server p ctx est port num null rv est err est log err `` unabl set upstream server configur client context proxi use est destroy c ctx null rv est client set read timeout c ctx p ctx read timeout rv est err est log err `` unabl set ssl read timeout client context est destroy c ctx null make sure s room entri node client ctx lu node t bsearch zero threadid p ctx client ctx array cur max ctx array client ctx lu node t bsearch compar node null space alloc new array copi what size current client ctx lu node t temp array cur max ctx array temp array client ctx lu node t malloc client ctx lu node t cur max ctx array memzero s temp array client ctx lu node t cur max ctx array memcpi s temp array client ctx lu node t cur max ctx array p ctx client ctx array client ctx lu node t cur max ctx array free p ctx client ctx array p ctx client ctx array temp array qsort p ctx client ctx array cur max ctx array client ctx lu node t bsearch compar node client ctx lu node t bsearch zero threadid p ctx client ctx array cur max ctx array client ctx lu node t bsearch compar index node p ctx client ctx array add array sort proper place p ctx client ctx array  index  threadid cur threadid p ctx client ctx array  index  client ctx c ctx qsort p ctx client ctx array cur max ctx array client ctx lu node t bsearch compar entri tree client context pid c ctx node client ctx c ctx proxi cleanup invok est destroy current context proxi mode proxi cleanup est ctx p ctx p ctx client ctx array null cur max ctx array p ctx client ctx array   client ctx est destroy p ctx client ctx array   client ctx free p ctx client ctx array p ctx client ctx array null routin check result code enrol attempt propag retri messag client need est error est proxi propag retri est ctx ctx http ctx ca did sign request ask client retri futur occur ca configur automat enrol send http retri respons client need propag retri respons client est log info `` ca server request retri propag client d ctx retri delay est err est server send http retri ctx http ctx ctx retri delay est err http write est err routin send pkcs encod certif est client http est error est proxi propag pkcs http ctx pkcs pkcs len http hdr  est http hdr max  hdrlen send http header snprintf http hdr est http hdr max `` s s s s est http hdr_ est http hdr eol est http hdr stat_ est http hdr eol hdrlen strnlen s http hdr est http hdr max snprintf http hdr hdrlen est http hdr max `` s s s est http hdr ct est http ct pkcs est http hdr eol hdrlen strnlen s http hdr est http hdr max snprintf http hdr hdrlen est http hdr max `` s s s est http hdr ce est http ce base est http hdr eol hdrlen strnlen s http hdr est http hdr max snprintf http hdr hdrlen est http hdr max `` s d s s est http hdr cl pkcs len est http hdr eol est http hdr eol mg write http ctx http hdr strnlen s http hdr est http hdr max est err http write send pkcs certif bodi mg write http ctx pkcs pkcs len est log err `` http write error propag pkcs est err http write est err est proxi retriev cacert issu request server obtain ca cert chain use ca cert request client ca cert chain return server pass caller s respons caller free buffer est error est proxi retriev cacert est ctx ctx cacert rtn cacert rtn len est ctx client ctx est error rv rcvd cacert len rcvd cacert ctx null est log err `` ctx pass s _ function__ est err ctx cacert rtn null cacert rtn len null est log err `` ctx pass s _ function__ est err invalid paramet cacert rtn null cacert rtn len client context thread client ctx client ctx ctx client ctx est log err `` unabl obtain client context proxi oper est err ctx rv est client cacert client ctx rcvd cacert len rv est err est log err `` unabl retriev ca cert upstream server rc s est err num str rv rv alloc buffer retriev ca cert copi rcvd cacert malloc rcvd cacert len rcvd cacert null est log err `` unabl malloc buffer cacert receiv server est err malloc rv est client copi cacert client ctx rcvd cacert rv est err est log err `` unabl copi ca cert upstream server rc s est err num str rv free rcvd cacert rv retriev ca cert normal client interfac caus client uniniti state get just pass downstream client go client context initi state client ctx est client initi cacert rtn rcvd cacert cacert rtn len rcvd cacert len est err routin connect est server attempt enrol csr pkcs buffer success x cert pkcs buffer length return cert pkcs len pkcs buffer alloc caller est error est proxi send enrol request est ctx clnt ctx buf mem pkcs pkcs pkcs len reenrol est error rv ssl ssl client connect server rv est client connect clnt ctx ssl client rv est err rv send enrol request rv est client send enrol request clnt ctx ssl client pkcs pkcs pkcs len reenrol disconnect server est client disconnect clnt ctx ssl client rv routin connect est server attempt enrol csr pkcs buffer success x cert pkcs buffer length return cert pkcs len pkcs buffer alloc caller est error est proxi set path segment est ctx client ctx path segment path segment len est error rc path segment len strnlen s path segment est max path segment len rc est store path segment client ctx path segment path segment len rc est err est log err `` fail store uri path segment `` rc est err function use server est proxi respond incom simpl enrol request function similar client api function est client enrol req bypass thing function proxi sign csr insert tls uniqu id instead includ id kp cmc ra usag extens est error est proxi handl simpl enrol est ctx ctx http ctx ssl ssl ct bodi bodi len path seg reenrol est error rv buf mem pkcs pkcs pkcs len diff x req csr null est ctx client ctx errno t safec rc make sure client sent pkcs csr request safec rc memcmp s ct `` applic pkcs `` applic pkcs `` applic pkcs diff safec rc eok est log info `` memcmp s error x x o\\n safec rc diff est err bad content type authent client est enrol auth ctx http ctx ssl path seg reenrol est http auth est srp auth est cert auth est http auth pend est err auth pend est unauthor est err auth fail pars pkcs csr client csr est server pars csr bodi bodi len csr est log err `` unabl pars pkcs csr sent client est err bad pkcs perform saniti check csr est server check csr csr est log err `` pkcs csr sent client fail saniti check x req free csr est err bad pkcs po p check proof possess challeng password pkcs request match tls uniqu id rv est tls uid auth ctx ssl csr x req free csr rv est err est err auth fail tlsuid bodi point pkcs data pass enrol routin need hi jack buf mem attach bodi new buf mem pkcs buf mem new pkcs data bodi pkcs length bodi len pkcs max bodi len client context thread client ctx client ctx ctx client ctx est log err `` unabl obtain client context proxi oper est proxi free ossl bufmem pkcs est err ctx path segment path seg valu come downstream client request s valid place ctx use client code path seg est proxi set path segment client ctx path seg alloc space hold cert expect receiv est server pkcs malloc est ca max attempt enrol csr client rv est proxi send enrol request client ctx pkcs pkcs pkcs len reenrol handl error like occur rv est err auth fail tri time do digest auth ctx auth mode auth digest ctx auth mode auth basic ctx auth mode auth token est log info `` http auth fail tri digest basic paramet rv est proxi send enrol request client ctx pkcs pkcs pkcs len reenrol rv est err ca enrol retri rv est proxi propag retri client ctx http ctx rv est err est log warn `` est enrol fail error code d rv est err ca enrol retri rv est proxi propag retri client ctx http ctx est log warn `` initi est enrol request error code d rv client ctx auth mode auth prevent open ssl free data est proxi free ossl bufmem pkcs cert respons est server let s forward est client pkcs len rv est proxi propag pkcs http ctx pkcs pkcs len free pkcs rv function use server est proxi respond incom cacert request ca cert respons set local respond local set buffer set issu request upstream server est proxi handl cacert est ctx ctx http ctx path seg est error rv est err est ctx client ctx cacert len ctx ca cert null est log info `` proxi ca cert set local respond local set ca cert respons est handl cacert ctx ctx ca cert ctx ca cert len http ctx path seg client context thread client ctx client ctx ctx client ctx est log err `` unabl obtain client context proxi oper est err ctx path segment path seg valu come downstream client request s valid place ctx use client code path seg rv est proxi set path segment client ctx path seg rv est err est log err `` unabl save path segment uri client context rv invok client code retriev cacert note need authent client sec est log info `` proxi attempt retriev ca cert upstream server rv est client cacert client ctx cacert len upstream request success retriev ca cert context rv est err est log info `` proxi ca cert retriev success server forward est client `` est handl cacert client ctx client ctx retriev ca cert client ctx retriev ca cert len http ctx path seg went wrong upstream request server treat condit est log err `` proxi server reachabl sent corrupt ca cert rv est err http rv function use server est proxi respond incom csr attribut request function similar client api function est client csrattr est proxi handl csr attr est ctx ctx http ctx path seg rv est err pop present csr data csr data pop csr len csr pop len est ctx client ctx client context thread client ctx client ctx ctx client ctx est log err `` unabl obtain client context proxi oper est err ctx path segment path seg valu come downstream client request s valid place ctx use client code path seg rv est proxi set path segment client ctx path seg rv est err est log err `` unabl save path segment uri client context rv invok client code retriev csr attribut note need authent client sec est log info `` proxi attempt retriev csr attr upstream server rv est client csrattr client ctx csr data csr len csr data point memori alloc hold csr attribut freed stack prevent free null pointer client context client ctx retriev csrattr null client ctx retriev csrattr len rv est err ctx csr pop present ctx server enabl pop rv est challeng password present csr data csr len pop present rv est err est log err `` error po p saniti check est send http error ctx http ctx est err http content est err ctx csr pop present pop present ctx csr pop present csr len csr data malloc est csrattr pop len csr data est err malloc strncpi s csr data est csrattr pop len est csrattr pop est csrattr pop len csr data  est csrattr pop len  csr len est csrattr pop len est send csrattr data ctx csr data csr len http ctx rv est add challeng password csr data csr len csr data pop csr pop len rv est err csr data free csr data est log err `` error add po p est send http error ctx http ctx est err http content est err csr data free csr data csr data csr data pop csr len csr pop len est log err `` server reachabl sent corrupt attribut est send http error ctx http ctx est err http content est err est send csrattr data ctx csr data csr len http ctx function call web server layer http request arriv listen port est proxi determin est request type dispatch request appropri handler paramt ctx pointer est ctx http ctx context pointer web server method html method request `` `` post uri pointer http uri bodi pointer html bodi content bodi len length html bodi ct html content type header est error est proxi http request est ctx ctx http ctx method uri bodi bodi len ct ssl ssl est error rc diff errno t safec rc est oper oper path seg null est error rv est err ctx est err ctx verifi context proxi client server ctx est mode est proxi est err bad mode rv est pars uri uri oper path seg rv est err est send http error ctx http ctx rv rv cacert request oper est op cacert allow safec rc strcmp s method max http method len `` diff safec rc eok est log info `` strcmp s error x x o\\n safec rc diff est send http error ctx http ctx est err wrong method free path seg path seg null est err wrong method rc est proxi handl cacert ctx http ctx path seg rc est err est send http error ctx http ctx rc free path seg path seg null rc simpl enrol request oper est op simpl enrol post allow safec rc strcmp s method max http method len `` post diff safec rc eok est log info `` strcmp s error x x o\\n safec rc diff est send http error ctx http ctx est err wrong method free path seg path seg null est err wrong method ct est log warn `` incom http header content type header\\n est send http error ctx http ctx est err bad pkcs free path seg path seg null est err bad content type bodi indic content pass enrol request correct csr requir continu proxi mode ll tri forward non exist csr bodi null est log warn `` incom http header csr content \\n est send http error ctx http ctx est err bad pkcs free path seg path seg null est err bad content len ssl context requir authent client ssl ssl mg conn ssl http ctx ssl est send http error ctx http ctx est err ssl ctx free path seg path seg null est err ssl ctx rc est proxi handl simpl enrol ctx http ctx ssl ct bodi bodi len path seg rc est err rc est err auth pend est log warn `` enrol fail rc d s \\n rc est err num str rc rc est err auth fail est send http error ctx http ctx est err auth fail est send http error ctx http ctx est err bad pkcs free path seg path seg null est err bad pkcs enrol request oper est op simpl reenrol post allow safec rc strcmp s method max http method len `` post diff safec rc eok est log info `` strcmp s error x x o\\n safec rc diff est send http error ctx http ctx est err wrong method free path seg path seg null est err wrong method ct est log warn `` incom http header content type header\\n est send http error ctx http ctx est err bad pkcs free path seg path seg null est err bad content type bodi indic content pass enrol request correct csr requir continu proxi mode ll tri forward non exist csr bodi null est log warn `` incom http header csr content \\n est send http error ctx http ctx est err bad pkcs free path seg path seg null est err bad content len ssl context requir authent client ssl ssl mg conn ssl http ctx ssl est send http error ctx http ctx est err ssl ctx free path seg path seg null est err ssl ctx rc est proxi handl simpl enrol ctx http ctx ssl ct bodi bodi len path seg rc est err rc est err auth pend est log warn `` reenrol fail rc d s \\n rc est err num str rc rc est err auth fail est send http error ctx http ctx est err auth fail est send http error ctx http ctx est err bad pkcs free path seg path seg null est err bad pkcs keygen request fixm current implement strncmp uri est keygen uri est uri max len post allow safec rc strcmp s method max http method len `` post diff safec rc eok est log info `` strcmp s error x x o\\n safec rc diff est send http error ctx http ctx est err wrong method est err wrong method ct est log warn `` incom http header content type header\\n est err bad content type est proxi handl keygen ctx est send http error ctx http ctx fixm param zero est err http write fixm need appropri code endif csr attribut request oper est op csrattr allow safec rc strcmp s method max http method len `` diff safec rc eok est log info `` strcmp s error x x o\\n safec rc diff est send http error ctx http ctx est err wrong method free path seg path seg null est err wrong method rc est proxi handl csr attr ctx http ctx path seg rc est err est send http error ctx http ctx rc free path seg path seg null rc send error uri did nt match est send http error ctx http ctx est err http free path seg path seg null est err brief est proxi start use applic start est proxi est proxi init est proxi set server call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est est error est error est proxi start est ctx ctx est mg context mgctx ctx est log err `` null context est err ctx mgctx mg start ctx mgctx ctx mg ctx mgctx est err est err ssl ctx brief est proxi stop use applic stop est proxi call prior est destroy param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer est error est error est proxi stop est ctx ctx est mg context mgctx ctx est log err `` null context est err ctx mgctx est mg context ctx mg ctx mgctx mg stop mgctx est err brief est proxi init use applic creat context est librari context use invok function api proxi mode param ca chain array contain pem encod ca cert crl entri chain certif use trust anchor establish tls connect param ca chain len length ca chain array param cacert resp chain array contain pem encod ca cert includ cacert respons paramet set contain chain certif use proxi respond ca cert request est client paramet includ proxi obtain ca certif chain configur upstream est server paramet null correct length buffer specifi cacert resp chain len param cacert resp chain len length cacert resp chain array param cert format specifi encod local extern certif chain pem der param http realm array contain http realm http auth param tls id cert pointer x contain proxi s certif tls layer param tls id key pointer evp pkey contain privat key associ proxi s certif param uid user id use authent server param pwd password use authent server function allow applic initi est server context proxi mode oper use oper ra applic provid trust ca certif use server oper use ca chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub ca certif requir complet chain trust ident certif pass tls id cert paramet root certif ident certif ca certif encod use format specifi cert format paramet e g pem contain crl entri use authent est client connect server applic provid http realm use http authent server cerif privat key use tls warn includ addit intermedi sub ca certif need complet chain trust result potenti mitm attack est ctx est ctx est proxi init ca chain ca chain len cacert resp chain cacert resp chain len est cert format cert format http realm x tls id cert evp pkey tls id key uid pwd est ctx ctx len est log version saniti check input ca chain null est log err `` trust ca certif set null tls id cert null est log err `` tls cert null tls id key null est log err `` tls privat key null http realm null est log err `` est http realm null null cert format est cert format pem est log err `` pem encod certif support `` null verifi length cert chain len strnlen s ca chain est ca max len ca chain len est log err `` length ca chain doe nt match ca chain len null cacert resp chain len strnlen s cacert resp chain est ca max len cacert resp chain len est log err `` length cacert resp chain doe nt match cacert resp chain len null alloc set proxi base est context context use oper server downstream client est proxi mode basic server function requir client capabl communic upstream server need ctx malloc est ctx ctx est log err `` malloc fail null memzero s ctx est ctx ctx est mode est proxi ctx retri period est retri period def ctx server enabl pop ctx http auth http auth requir ctx server read timeout est ssl read timeout def est client set uid pw ctx uid pwd est err est log err `` fail store userid password proxi initi free ctx null load ca certif local memori retain futur use use cacert request cacert resp chain est load ca cert ctx cacert resp chain cacert resp chain len est log err `` fail load ca certif respons buffer free ctx null load ca certif chain x store structur use verifi incom cert tls establish save way raw copi ca chain buffer use creat client context use communinc upstream server est load trust cert ctx ca chain ca chain len est log err `` fail load trust certif store est destroy ctx null ctx ca chain raw malloc ca chain len ctx ca chain raw est log err `` malloc fail est destroy ctx null memcpi s ctx ca chain raw ca chain len ca chain ca chain len ctx ca chain raw  ca chain len  \\ ctx ca chain raw len ca chain len strncpi s ctx realm max realm http realm max realm ctx server cert tls id cert ctx server priv key tls id key ctx auth mode auth basic ctx read timeout est ssl read timeout def ctx retri delay ctx retri date ctx client ctx array client ctx lu node t malloc client ctx lu node t cur max ctx array memzero s ctx client ctx array client ctx lu node t cur max ctx array ctx brief est proxi set auth mode use applic layer configur http authent method use valid ident est client param ctx pointer est proxi context return est proxi init param amod auth basic auth digest function option invok applic layer chang http authent mode mode http basic authent applic desir use digest authent instead function use set mode function invok prior start est proxi est error est error est proxi set auth mode est ctx ctx est http auth mode amod est server set auth mode ctx amod brief est proxi set auth cred cb use applic callback function param ctx est context obtain est proxi init param auth credenti cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari applic callback event doe authent credenti request est server callback function definit match follow function prototyp auth credenti cb est http auth hdr auth credenti auth credenti pointer est http auth hdr structur structur provid est librari callback function fill specif credenti request credenti valu pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon use valu valu callback follow valu est http auth cred success callback abl provid request credenti est http auth cred avail callback provid request credenti auth credenti cb paramet set null reset callback function string paramet null termin string est error est err success est err ctx est error est proxi set auth cred cb est ctx ctx auth credenti cb callback est client set auth cred cb ctx callback brief est proxi set read timeout use applic set timeout valu read oper est proxi send request est server attempt read respons server timeout valu limit time proxi wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu est ssl read timeout min maximum valu est ssl read timeout max est error est error est proxi set read timeout est ctx ctx timeout est client set read timeout ctx timeout brief est proxi set server call applic layer specifi address port est server call est proxi init prior issu est command param ctx pointer est context client session param server est server connect ascii string repres server limit charact param port tcp port est server connect est error est err success est err ctx null valu pass est context est err invalid server null valu pass est server server string est err invalid port num invalid port number input zero greater est proxi set server error check input paramet store hostnam port number est context est error est proxi set server est ctx ctx server port ctx est err ctx server null est err invalid server est max servernam len strnlen s server est max servernam len est err invalid server port port est err invalid port num strncpi s ctx est server est max servernam len server est max servernam len ctx est port num port est err