 c unit test user stori unit test client proxi mode test new api function verifi correct oper client proxi mode octob copyright c cisco system right reserv includ stdio h ifndef win includ unistd h endif includ `` est h includ curl curl h includ `` curl util h includ `` test util h includ `` st server h includ openssl ssl h ifdef cunit includ `` cunit basic h includ `` cunit autom h endif includ errno h includ fcntl h defin max_ cmds cacert null cacert len defin server domain `` localhost cisco com defin server ip `` defin server tcp port defin proxi ip `` defin proxi tcp port defin uid `` estus defin pwd `` estpwd ifndef win defin cacert `` ca est ca cacert crt defin cacert `` ca est ca cacert crt defin server cert `` ca est ca privat estservercertandkey pem defin server key `` ca est ca privat estservercertandkey pem defin client cert `` ca est ca privat estservercertandkey pem defin client key `` ca est ca privat estservercertandkey pem defin cacert `` ca\\\\est ca\\\\cacert crt defin cacert `` ca\\\\est ca\\\\cacert crt defin server cert `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin server key `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin client cert `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin client key `` ca\\\\est ca\\\\priv estservercertandkey pem critic section logger critic section logger stderr format va list l enter critic section logger critic section vfprintf stderr format l fflush stderr leav critic section logger critic section endif evp pkey generat privat key rsa rsa rsa new bignum bn bn new evp pkey pkey creat rsa keypair assign pkey bn set word bn x rsa generat key ex rsa bn null pkey evp pkey new pkey null printf `` \\n error alloc pkey structur new key pair\\n null evp pkey set rsa pkey rsa printf `` \\n error assign rsa key pair pkey structure\\n null rsa free rsa bn free bn pkey clean start server manual enrol nid rv rv st start server tcp port `` ca est ca privat estservercertandkey pem `` ca est ca privat estservercertandkey pem `` estrealm `` ca est ca cacert crt `` ca trustedcert crt `` ca est exampl ca cnf manual enrol nid rv defin max cmd buf defin max pid buf shutdown antinat fh read pid  max pid buf  cmd  max cmd buf  rv fh open `` antinat pid o rdwr read fh read pid max pid buf printf `` pid read s\\n read pid snprintf cmd max cmd buf `` kill s\\n read pid rv cmd rv printf `` fail termin antinat \\n shutdown haproxi fh readbyt count read pid  max pid buf  cmd  max cmd buf  rv fh open `` haproxi pid o rdwr readbyt count read fh read pid max pid buf read fh read pid max pid buf printf `` pid read s\\n read pid snprintf cmd max cmd buf `` kill s\\n read pid rv cmd rv printf `` fail termin haproxi \\n routin call cunit initi test suit use alloc data open resourc requir test case init suit rv ifdef win initi critic section logger critic section est init logger est log lvl info logger stderr est init logger est log lvl info null endif read ca certif cacert len read binari file cacert cacert cacert len clean start instanc est server automat enrol enabl rv start server rv routin call cunit uniniti test suit use dealloc data close resourc use test case destroy suit st stop free cacert callback function pass est client init client manual cert verifi x cur cert openssl cert error bio bio err bio err bio new fp stderr bio noclos approv print specif cert printf `` s open ssl est server cert verif fail follow error openssl cert error d s \\n _ function__ openssl cert error x verifi cert error string openssl cert error printf `` fail cert \\n x print fp stdout cur cert print signatur use fingerprint fingerprint check anticip valu determin server s cert approv x signatur print bio err cur cert sig alg cur cert signatur openssl cert error x v err unabl crl approv bio free bio err approv error check paramet api test est error e rc est ctx ectx null log func nm creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null attempt api context e rc est client set proxi null est client proxi http notunnel proxi ip proxi tcp port est client proxi auth basic `` estus `` estpwd cu assert e rc est err ctx valid e rc est client set proxi ectx est client proxi http notunnel proxi ip proxi tcp port est client proxi auth basic `` estus `` estpwd cu assert e rc est err nt set server e rc est client set proxi ectx est client proxi http notunnel null proxi tcp port est client proxi auth basic `` estus `` estpwd cu assert e rc est err invalid server server string e rc est client set proxi ectx est client proxi http notunnel `` proxi tcp port est client proxi auth basic `` estus `` estpwd cu assert e rc est err invalid server max server max server `` `` `` `` `` e rc est client set proxi ectx est client proxi http notunnel max server proxi tcp port est client proxi auth basic `` estus `` estpwd cu assert e rc est err server server `` `` `` `` `` e rc est client set proxi ectx est client proxi http notunnel server proxi tcp port est client proxi auth basic `` estus `` estpwd cu assert e rc est err invalid server nt set port e rc est client set proxi ectx est client proxi http notunnel proxi ip est client proxi auth basic `` estus `` estpwd cu assert e rc est err invalid port num proxi protocol invalid e rc est client set proxi ectx proxi ip proxi tcp port est client proxi auth basic `` estus `` estpwd cu assert e rc est err invalid client proxi protocol proxi protocol invalid e rc est client set proxi ectx proxi ip proxi tcp port est client proxi auth basic `` estus `` estpwd cu assert e rc est err invalid client proxi protocol proxi auth invalid e rc est client set proxi ectx est client proxi http notunnel proxi ip proxi tcp port `` estus `` estpwd cu assert e rc est err invalid client proxi auth max userid max userid `` `` `` `` `` e rc est client set proxi ectx est client proxi http notunnel proxi ip proxi tcp port est client proxi auth basic max userid `` estpwd cu assert e rc est err userid userid `` `` `` `` `` e rc est client set proxi ectx est client proxi http notunnel proxi ip proxi tcp port est client proxi auth basic userid `` estpwd cu assert e rc est err invalid paramet userid string e rc est client set proxi ectx est client proxi http notunnel proxi ip proxi tcp port est client proxi auth basic `` `` estpwd cu assert e rc est err invalid paramet max pwd max pwd `` `` `` `` `` e rc est client set proxi ectx est client proxi http notunnel proxi ip proxi tcp port est client proxi auth basic `` estus max pwd cu assert e rc est err pwd pwd `` `` `` `` `` e rc est client set proxi ectx est client proxi http notunnel proxi ip proxi tcp port est client proxi auth basic `` estus pwd cu assert e rc est err invalid paramet password string e rc est client set proxi ectx est client proxi http notunnel proxi ip proxi tcp port est client proxi auth basic `` estus `` cu assert e rc est err invalid paramet est destroy ectx test sock mode credenti pass test sys rc est error e rc est ctx ectx null cmd  max_ cmds  evp pkey key pkcs len log func nm set sock proxi server local snprintf cmd max_ cmds `` antinat xc antinat cfg xml sys rc cmd cu assert sys rc creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null sock e rc est client set proxi ectx est client proxi sock proxi ip proxi tcp port est client proxi auth basic null null cu assert e rc est err set authent mode use user id password e rc est client set auth ectx uid pwd null null cu assert e rc est err set est server address port est client set server ectx server ip server tcp port null generat privat key key generat privat key cu assert key null use simplifi api enrol csr e rc est client enrol ectx `` tc pkcs len key cu assert e rc est err shutdown antinat est destroy ectx test sock mode credenti pass test sys rc est error e rc est ctx ectx null cmd  max_ cmds  evp pkey key pkcs len log func nm set sock proxi server local snprintf cmd max_ cmds `` antinat xc antinat cfg xml sys rc cmd cu assert sys rc creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null sock e rc est client set proxi ectx est client proxi sock proxi ip proxi tcp port est client proxi auth basic `` estus `` estpwd cu assert e rc est err set authent mode use user id password e rc est client set auth ectx uid pwd null null cu assert e rc est err set est server address port est client set server ectx server ip server tcp port null generat privat key key generat privat key cu assert key null use simplifi api enrol csr e rc est client enrol ectx `` tc pkcs len key cu assert e rc est err shutdown antinat est destroy ectx test sock mode test sys rc est error e rc est ctx ectx null cmd  max_ cmds  evp pkey key pkcs len log func nm set sock proxi server local snprintf cmd max_ cmds `` antinat xc antinat cfg xml sys rc cmd cu assert sys rc creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null sock e rc est client set proxi ectx est client proxi sock proxi ip proxi tcp port est client proxi auth basic null null `` estus `` estpwd cu assert e rc est err set authent mode use user id password e rc est client set auth ectx uid pwd null null cu assert e rc est err set est server address port est client set server ectx server ip server tcp port null generat privat key key generat privat key cu assert key null use simplifi api enrol csr e rc est client enrol ectx `` tc pkcs len key cu assert e rc est err shutdown antinat est destroy ectx test sock mode test sys rc est error e rc est ctx ectx null cmd  max_ cmds  evp pkey key pkcs len log func nm set sock proxi server local snprintf cmd max_ cmds `` antinat xc antinat cfg xml sys rc cmd cu assert sys rc creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null sock e rc est client set proxi ectx est client proxi socksa proxi ip proxi tcp port est client proxi auth basic null null `` estus `` estpwd cu assert e rc est err set authent mode use user id password e rc est client set auth ectx uid pwd null null cu assert e rc est err set est server address port est client set server ectx server ip server tcp port null generat privat key key generat privat key cu assert key null use simplifi api enrol csr e rc est client enrol ectx `` tc pkcs len key cu assert e rc est err shutdown antinat est destroy ectx test sock mode credenti test sys rc est error e rc est ctx ectx null cmd  max_ cmds  evp pkey key pkcs len log func nm set sock proxi server local snprintf cmd max_ cmds `` antinat xc antinat cfg xml sys rc cmd cu assert sys rc creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null sock e rc est client set proxi ectx est client proxi sock proxi ip proxi tcp port est client proxi auth basic null null cu assert e rc est err set authent mode use user id password e rc est client set auth ectx uid pwd null null cu assert e rc est err set est server address port est client set server ectx server ip server tcp port null generat privat key key generat privat key cu assert key null use simplifi api enrol csr e rc est client enrol ectx `` tc pkcs len key cu assert e rc est err shutdown antinat est destroy ectx test sock mode good credenti test sys rc est error e rc est ctx ectx null cmd  max_ cmds  evp pkey key pkcs len log func nm set sock proxi server local snprintf cmd max_ cmds `` antinat xc antinat cfg goodcr xml sys rc cmd cu assert sys rc creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null sock e rc est client set proxi ectx est client proxi sock proxi ip proxi tcp port est client proxi auth basic `` estus `` estpwd cu assert e rc est err set authent mode use user id password e rc est client set auth ectx uid pwd null null cu assert e rc est err set est server address port est client set server ectx server ip server tcp port null generat privat key key generat privat key cu assert key null use simplifi api enrol csr e rc est client enrol ectx `` tc pkcs len key cu assert e rc est err shutdown antinat est destroy ectx test sock mode good credenti forgotten test sys rc est error e rc est ctx ectx null cmd  max_ cmds  evp pkey key pkcs len log func nm set sock proxi server local snprintf cmd max_ cmds `` antinat xc antinat cfg goodcr xml sys rc cmd cu assert sys rc creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null sock e rc est client set proxi ectx est client proxi sock proxi ip proxi tcp port est client proxi auth basic null null cu assert e rc est err set authent mode use user id password e rc est client set auth ectx uid pwd null null cu assert e rc est err set est server address port est client set server ectx server ip server tcp port null generat privat key key generat privat key cu assert key null use simplifi api enrol csr e rc est client enrol ectx `` tc pkcs len key cu assert e rc est err ip connect shutdown antinat est destroy ectx test sock mode bad credenti test sys rc est error e rc est ctx ectx null cmd  max_ cmds  evp pkey key pkcs len log func nm set sock proxi server local snprintf cmd max_ cmds `` antinat xc antinat cfg badcr xml sys rc cmd cu assert sys rc creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null sock e rc est client set proxi ectx est client proxi sock proxi ip proxi tcp port est client proxi auth basic `` estus `` estpwd cu assert e rc est err set authent mode use user id password e rc est client set auth ectx uid pwd null null cu assert e rc est err set est server address port est client set server ectx server ip server tcp port null generat privat key key generat privat key cu assert key null use simplifi api enrol csr e rc est client enrol ectx `` tc pkcs len key cu assert e rc est err ip connect shutdown antinat est destroy ectx test need certifc updat test sock mode domain test sys rc est error e rc est ctx ectx null cmd  max_ cmds  evp pkey key pkcs len log func nm set sock proxi server local snprintf cmd max_ cmds `` antinat xc antinat cfg xml sys rc cmd cu assert sys rc creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null sock e rc est client set proxi ectx est client proxi socksa proxi ip proxi tcp port est client proxi auth basic null null cu assert e rc est err set authent mode use user id password e rc est client set auth ectx uid pwd null null cu assert e rc est err set est server address port est client set server ectx server domain server tcp port null generat privat key key generat privat key cu assert key null use simplifi api enrol csr e rc est client enrol ectx `` tc pkcs len key cu assert e rc est err shutdown antinat est destroy ectx endif test http proxi mode note non tunnel mode test tunnel mode doe work cisco est server test sys rc est error e rc est ctx ectx null cmd  max_ cmds  evp pkey key pkcs len log func nm set http proxi server local snprintf cmd max_ cmds `` haproxi d f haproxi cfg p haproxi pid sys rc cmd cu assert sys rc creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null e rc est client set proxi ectx est client proxi http notunnel proxi ip proxi tcp port est client proxi auth basic `` estus `` estpwd cu assert e rc est err set authent mode use user id password e rc est client set auth ectx uid pwd null null cu assert e rc est err set est server address port est client set server ectx server ip server tcp port null generat privat key key generat privat key cu assert key null use simplifi api enrol csr e rc est client enrol ectx `` tc pkcs len key cu assert e rc est err shutdown haproxi est destroy ectx indic client proxi support built librari client proxi enabl est error e rc e rc est client set proxi null null null null e rc est err client proxi mode support main function set run test return cue success success run cunit error code failur add suit ifdef cunit cu p suit p suit null add suit registri p suit cu add suit `` tok auth client init suit destroy suit null p suit cu cleanup registri cu error ifndef win client proxi mode support libcurl specifi client proxi enabl add test suit null cu add test p suit `` paramet check api test null cu add test p suit `` sock mode test null cu add test p suit `` sock mode w credenti test null cu add test p suit `` sock mode test null cu add test p suit `` sock mode test null cu add test p suit `` sock mode credenti test null cu add test p suit `` sock mode good credenti test null cu add test p suit `` sock mode forgotten credenti test null cu add test p suit `` sock mode bad credenti test null cu add test p suit `` sock mode domain instead ip address test null cu add test p suit `` http proxi test cu cleanup registri cu error endif cue success endif