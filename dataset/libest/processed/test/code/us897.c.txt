 c unit test user stori client cacert june copyright c cisco system right reserv includ stdio h ifndef win includ unistd h endif includ est h ifdef cunit includ `` cunit basic h includ `` cunit autom h endif includ `` util test util h includ `` st server h max command line length generat command defin est ut max cmd len defin est ca max ca certif use verifi est server grab server s directori defin client ut cacert `` exampl server est ca cacert crt defin server port defin client ut pubkey `` est client ut keypair defin server ip `` defin uid `` estus defin pwd `` estpwd ifndef win defin client ut cacert `` ca est ca cacert crt defin cacert `` ca est ca cacert crt defin trust cert `` ca trustedcert crt defin server certkey `` ca est ca privat estservercertandkey pem defin cacert singl chain mult cert `` singlechain cert trust crt defin cacert singl chain mult cert miss `` singlechain cert missingcert crt defin cacert singl chain expir `` singlechain expir crt defin cacert multi chain crls `` trust chain revok depth implicitandcacert crt defin client ut cacert `` ca\\\\est ca cacert crt defin cacert `` ca\\\\est ca\\\\cacert crt defin trust cert `` ca\\\\trustedcert crt defin server certkey `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin cacert singl chain mult cert `` us\\\\singlechain cert trust crt defin cacert singl chain mult cert miss `` us\\\\singlechain cert missingcert crt defin cacert singl chain expir `` us\\\\singlechain expir crt defin cacert multi chain crls `` us\\\\trust chain revok depth implicitandcacert crt endif clean start server manual enrol nid rv rv st start server port server certkey server certkey `` test realm cacert trust cert `` ca est exampl ca cnf manual enrol nid sleep rv routin call cunit initi test suit generat keypair use est client ut suit init suit rv cmd  est ut max cmd len  printf `` start est client unit test pdb\\n gen keypair use est client test snprintf cmd est ut max cmd len `` openssl ecparam primev genkey s client ut pubkey printf `` s\\n cmd rv cmd start server test need talk server clean start instanc est server rv start server sleep rv routin call cunit uniniti test suit use dealloc data close resourc use test case destroy suit st stop callback function pass est client init client manual cert verifi x cur cert openssl cert error bio bio err bio err bio new fp stderr bio noclos approv print specif cert printf `` s open ssl est server cert verif fail follow error openssl cert error d s \\n _ function__ openssl cert error x verifi cert error string openssl cert error printf `` fail cert \\n x print fp stdout cur cert print signatur use fingerprint fingerprint check anticip valu determin server s cert approv x signatur print bio err cur cert sig alg cur cert signatur openssl cert error x v err unabl crl approv bio free bio err approv test initi est client context use local ca cert client cert valid public key userid password test est ctx ectx pkey null cacert null cacert len est error rc evp pkey priv key sleep read ca certif cacert len read binari file client ut cacert cacert cu assert cacert len read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey est init logger est log lvl info null ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null rc est client set auth ectx `` `` null priv key cu assert rc est err ectx est destroy ectx cacert free cacert pkey free pkey test initi est client context use local ca cert expect success initi local ca trust anchor cert mandatori test est ctx ectx pkey null cacert null cacert len evp pkey priv key sleep read ca certif cacert len read binari file client ut cacert cacert cu assert cacert len read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey ectx est client init null est cert format pem client manual cert verifi cu assert ectx null ectx est destroy ectx cacert free cacert pkey free pkey test initi est client context use local ca cert client cert valid public key userid password test est ctx ectx pkey null cacert null cacert len est error rc evp pkey priv key sleep read ca certif cacert len read binari file client ut cacert cacert cu assert cacert len read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null rc est client set auth ectx `` `` null priv key cu assert rc est err ectx est destroy ectx cacert free cacert pkey free pkey test initi est client context use explict ca cert client cert valid public key userid password test est ctx ectx pkey null cacert null cacert len est error rc evp pkey priv key read ca certif cacert len read binari file client ut cacert cacert cu assert cacert len read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null rc est client set auth ectx `` `` null priv key cu assert rc est err ectx est destroy ectx cacert free cacert pkey free pkey endif test initi est client context use explict ca cert client cert public key userid password test est ctx ectx pkey null cacert null cacert len est error rc evp pkey priv key sleep read ca certif cacert len read binari file client ut cacert cacert cu assert cacert len read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null rc est client set auth ectx `` user `` password null priv key cu assert rc est err ectx est destroy ectx cacert free cacert pkey free pkey test initi est client context use explict ca cert client cert public key userid password test est ctx ectx pkey null cacert null cacert len est error rc evp pkey priv key sleep read ca certif cacert len read binari file client ut cacert cacert cu assert cacert len read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null rc est client set auth ectx `` user null null priv key cu assert rc est err invalid paramet ectx est destroy ectx ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null rc est client set auth ectx null `` password null priv key cu assert rc est err invalid paramet ectx est destroy ectx cacert free cacert pkey free pkey test test set server valid paramet test est ctx ectx pkey null cacert null cacert len est error rc est err evp pkey priv key sleep read ca certif cacert len read binari file client ut cacert cacert read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey ectx est client init cacert cacert len est cert format pem client manual cert verifi rc est client set auth ectx `` `` null priv key cu assert rc est err rc est client set server ectx server ip server port null cu assert rc est err ectx est destroy ectx cacert free cacert pkey free pkey test test set server invalid paramet test est ctx ectx pkey null cacert null cacert len est error rc est err server `` \\ `` \\ `` \\ `` \\ `` evp pkey priv key sleep read ca certif cacert len read binari file client ut cacert cacert read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey ectx est client init cacert cacert len est cert format pem client manual cert verifi rc est client set auth ectx `` `` null priv key cu assert rc est err null server rc est client set server ectx null server port null cu assert rc est err invalid server server rc est client set server ectx server server port null cu assert rc est err invalid server port num rc est client set server ectx server ip null cu assert rc est err invalid port num port num greater max rc est client set server ectx server ip null cu assert rc est err invalid port num ectx est destroy ectx cacert free cacert pkey free pkey test test cacert request test est ctx ectx pkey null cacert null cacert len est error rc est err retriev cacert null retriev cacert len evp pkey priv key sleep read ca certif cacert len read binari file client ut cacert cacert cu assert cacert len read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null rc est client set auth ectx `` `` null priv key cu assert rc est err est client set server ectx server ip server port null issu ca cert request rc est client cacert ectx retriev cacert len success obtain valid buffer contain ca cert cu assert rc est err cu assert retriev cacert len retriev cacert malloc retriev cacert len rc est client copi cacert ectx retriev cacert output retriev ca cert compar retriev cacert printf `` \\n retriev ca cert buffer \\n s\\n retriev cacert printf `` retriev ca cert buffer length d\\n retriev cacert len free retriev cacert make sure context longer valid est client uniniti state rc est client cacert ectx retriev cacert len cu assert rc est err client initi ectx est destroy ectx cacert free cacert pkey free pkey test test cacert request invalid input paramet test est ctx ectx pkey null cacert null cacert len est error rc est err evp pkey priv key sleep read ca certif cacert len read binari file client ut cacert cacert cu assert cacert len read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null rc est client set auth ectx `` `` null priv key cu assert rc est err est client set server ectx server ip server port null issu ca cert request rc est client cacert ectx null success obtain valid buffer contain ca cert cu assert rc est err invalid paramet ectx est destroy ectx cacert free cacert pkey free pkey test test ca cert respons verif function verifi cacert respons contain singl certif test est ctx ectx pkey null cacert null cacert len est error rc est err evp pkey priv key retriev cacert null retriev cacert len stop exist server need ensur server use specif ca cert chain st stop sleep spin new instanc est server use ca cert chain contain just cert rc st start server port server certkey server certkey `` test realm cacert trust cert `` ca est exampl ca cnf cu assert rc rc sleep read thestartup ca certif cacert len read binari file client ut cacert cacert cu assert cacert len read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null rc est client set auth ectx `` `` null priv key cu assert rc est err est client set server ectx server ip server port null issu ca cert request rc est client cacert ectx retriev cacert len success obtain valid length size ca cert buffer cu assert rc est err cu assert retriev cacert len retriev cacert malloc retriev cacert len rc est client copi cacert ectx retriev cacert output retriev ca cert compar retriev cacert printf `` \\n retriev ca cert buffer \\n s\\n retriev cacert printf `` retriev ca cert buffer length d\\n retriev cacert len free retriev cacert ectx est destroy ectx cacert free cacert pkey free pkey test test ca cert respons verif function verifi cacert respons contain singl chain multipl cert test est ctx ectx pkey null cacert null cacert len est error rc est err evp pkey priv key retriev cacert null retriev cacert len stop exist server need ensur server use specif ca cert chain st stop sleep spin new instanc est server use ca cert chain contain just cert rc st start server port server certkey server certkey `` test realm cacert singl chain mult cert trust cert `` ca est exampl ca cnf cu assert rc rc sleep read thestartup ca certif cacert len read binari file client ut cacert cacert cu assert cacert len read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null rc est client set auth ectx `` `` null priv key cu assert rc est err est client set server ectx server ip server port null issu ca cert request rc est client cacert ectx retriev cacert len success obtain valid length size ca cert buffer cu assert rc est err cu assert retriev cacert len retriev cacert malloc retriev cacert len rc est client copi cacert ectx retriev cacert output retriev ca cert compar retriev cacert printf `` \\n retriev ca cert buffer \\n s\\n retriev cacert printf `` retriev ca cert buffer length d\\n retriev cacert len free retriev cacert ectx est destroy ectx cacert free cacert pkey free pkey test test ca cert respons verif function verifi cacert respons contain singl chain multipl cert miss cert chain test est ctx ectx pkey null cacert null cacert len est error rc est err evp pkey priv key retriev cacert null retriev cacert len stop exist server need ensur server use specif ca cert chain st stop sleep spin new instanc est server use ca cert chain contain just cert rc st start server port server certkey server certkey `` test realm cacert singl chain mult cert miss trust cert `` ca est exampl ca cnf cu assert rc rc sleep read thestartup ca certif cacert len read binari file client ut cacert cacert cu assert cacert len read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null rc est client set auth ectx `` `` null priv key cu assert rc est err est client set server ectx server ip server port null issu ca cert request rc est client cacert ectx retriev cacert len success obtain valid length size ca cert buffer cu assert rc est err cacert verif cu assert retriev cacert len retriev cacert len nt malloc retriev cacert malloc retriev cacert len rc est client copi cacert ectx retriev cacert est fail indic s cert provid cu assert rc est err certif output retriev ca cert compar retriev cacert printf `` \\n retriev ca cert buffer \\n s\\n retriev cacert printf `` retriev ca cert buffer length d\\n retriev cacert len free retriev cacert ectx est destroy ectx cacert free cacert pkey free pkey test test ca cert respons verif function verifi cacert respons contain singl chain multipl cert intermedi cert expir test est ctx ectx pkey null cacert null cacert len est error rc est err evp pkey priv key retriev cacert null retriev cacert len stop exist server need ensur server use specif ca cert chain st stop sleep spin new instanc est server use ca cert chain contain just cert rc st start server port server certkey server certkey `` test realm cacert singl chain expir trust cert `` ca est exampl ca cnf cu assert rc rc sleep read thestartup ca certif cacert len read binari file client ut cacert cacert cu assert cacert len read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null rc est client set auth ectx `` `` null priv key cu assert rc est err est client set server ectx server ip server port null issu ca cert request rc est client cacert ectx retriev cacert len success obtain valid length size ca cert buffer cu assert rc est err cacert verif cu assert retriev cacert len retriev cacert len nt malloc retriev cacert malloc retriev cacert len rc est client copi cacert ectx retriev cacert est fail indic s cert provid cu assert rc est err certif output retriev ca cert compar retriev cacert printf `` \\n retriev ca cert buffer \\n s\\n retriev cacert printf `` retriev ca cert buffer length d\\n retriev cacert len free retriev cacert ectx est destroy ectx cacert free cacert pkey free pkey test test ca cert respons verif function verifi cacert respons contain multipl chain multipl cert crl block crls ignor test est ctx ectx pkey null cacert null cacert len est error rc est err evp pkey priv key retriev cacert null retriev cacert len stop exist server need ensur server use specif ca cert chain st stop sleep spin new instanc est server use ca cert chain contain just cert rc st start server port server certkey server certkey `` test realm cacert multi chain crls trust cert `` ca est exampl ca cnf cu assert rc rc sleep read startup ca certif cacert len read binari file client ut cacert cacert cu assert cacert len read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null rc est client set auth ectx `` `` null priv key cu assert rc est err est client set server ectx server ip server port null issu ca cert request rc est client cacert ectx retriev cacert len success obtain valid length size ca cert buffer cu assert rc est err cu assert retriev cacert len retriev cacert len nt malloc retriev cacert malloc retriev cacert len rc est client copi cacert ectx retriev cacert est fail indic s cert provid cu assert rc est err output retriev ca cert compar retriev cacert printf `` \\n retriev ca cert buffer \\n s\\n retriev cacert printf `` retriev ca cert buffer length d\\n retriev cacert len free retriev cacert ectx est destroy ectx cacert free cacert pkey free pkey test test ssl read set timeout api set min max valu valu max test est ctx ectx pkey null cacert null cacert len est error rc est err evp pkey priv key retriev cacert null retriev cacert len read startup ca certif cacert len read binari file client ut cacert cacert cu assert cacert len read privat key file priv key read privat key client ut pubkey priv key null printf `` \\n error read privat key file s\\n client ut pubkey ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null rc est client set auth ectx `` `` null priv key cu assert rc est err est client set server ectx server ip server port null rc est client set read timeout ectx est ssl read timeout min cu assert rc est err rc est client set read timeout ectx est ssl read timeout max cu assert rc est err rc est client set read timeout ectx est ssl read timeout max cu assert rc est err invalid paramet rc est client set read timeout ectx cu assert rc est err proceed cacert verifi get broken issu ca cert request rc est client cacert ectx retriev cacert len success obtain valid length size ca cert buffer cu assert rc est err cu assert retriev cacert len retriev cacert len nt malloc retriev cacert malloc retriev cacert len rc est client copi cacert ectx retriev cacert est fail indic s cert provid cu assert rc est err output retriev ca cert compar retriev cacert printf `` \\n retriev ca cert buffer \\n s\\n retriev cacert printf `` retriev ca cert buffer length d\\n retriev cacert len free retriev cacert ectx est destroy ectx cacert free cacert pkey free pkey main function set run test return cue success success run cunit error code failur add suit cu error code cu error ifdef cunit cu p suit p suit null add suit registri p suit cu add suit `` client cacert init suit destroy suit null p suit cu cleanup registri cu error add test suit note order import test fread fprintf null cu add test p suit `` est client init local ca privat key `` test null cu add test p suit `` est client init local ca test null cu add test p suit `` est client init local ca explicit ca privat key test null cu add test p suit `` est client init local ca explicit ca client ca privat key test null cu add test p suit `` est client init local ca userid password test null cu add test p suit `` est client init local ca userid password test null cu add test p suit `` est client init local ca userid password test null cu add test p suit `` est client set server correct paramet test null cu add test p suit `` est client set server paramet test null cu add test p suit `` est client ca cert ca cert valid paramet test null cu add test p suit `` est client ca cert miss ca cert pointer test null cu add test p suit `` est client ca cert verifi chain simpl chain success test null cu add test p suit `` est client ca cert verifi chain multipl cert success test null cu add test p suit `` est client ca cert verifi chain broken chain fail test null cu add test p suit `` est client ca cert verifi chain bad date fail test null cu add test p suit `` est client ca cert verifi chain multipl chain success test null cu add test p suit `` est client ssl read timeout api test cu error cu error printf `` d\\n cu error cu cleanup registri printf `` s\\n cu error msg cu error cue success endif