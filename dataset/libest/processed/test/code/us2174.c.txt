 c unit test user stori proxi simpl enrol august copyright c cisco system right reserv includ stdio h ifndef win includ unistd h endif includ est h includ curl curl h includ `` curl util h includ `` test util h includ `` st server h includ `` st proxi h includ openssl ssl h ifdef cunit includ `` cunit basic h includ `` cunit autom h endif cacert null cacert len defin retri interv defin tcp port defin tcp server port defin tcp proxi port ifndef win defin server cert `` ca est ca privat estservercertandkey pem defin server key `` ca est ca privat estservercertandkey pem defin proxi cert `` ca est ca privat estservercertandkey pem defin proxi key `` ca est ca privat estservercertandkey pem defin proxi cert `` cert pem defin proxi key `` key pem defin cacert `` ca est ca cacert crt defin cacert `` ca est ca cacert crt defin trust cert `` ca trustedcert crt defin explicit cert `` cert ra pem defin explicit key `` key ra pem defin server cert `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin server key `` ca\\\\est ca\\\\priv estservercertandkey pem defin proxi cert `` ca est ca privat estservercertandkey pem defin proxi key `` ca est ca privat estservercertandkey pem defin proxi cert `` us\\\\cert pem defin proxi key `` us\\\\key pem defin cacert `` ca\\\\est ca\\\\cacert crt defin cacert `` ca\\\\est ca\\\\cacert crt defin trust cert `` ca\\\\trustedcert crt defin explicit cert `` us\\\\cert ra pem defin explicit key `` us\\\\key ra pem endif defin server ip `` defin tcp port tcp server port follow csr generat use follow openssl command use cat rsa req file openssl req newkey rsa keyout rsakey pem keyform pem rsa req outform pem defin pkcs rsa `` miicv tccaa ucaqaw delmak gauebh mcvvmx cz ajbg nvbag mak dmqww cg ydvqqh\\n dansvfax ej aqbg nvbao mcvjtqwnlcn rjbz emmao gauecww dcn nh mraw dg ydvqqd\\n dadyc zgl mrow gayjko zihvc naqk bfgtyc fazgl lm nvb tccasiw dqyjko zi\\nhvc naqebbqadgg epadccaqo cgg ebanp ctbr ktbganq qhxhi nlopvxc jy\\n xa qz rjbo bexzqx bt ueygnh hola isasnz zkwpv mhjwm pynt oci y\\n fog ldb anm aoksfc mlbib ccsh holhaa fr wsk rtasew muoz fuv bkw ah ij\\n kpywsd yoxu wfig ehlm gplbzq fr bidrqk nlddgi xo dd nu lmjgdakv bww\\n baw ai vpsyevf wdr hwgg xn vt mw bp cgrll systum tgyb mcx jywe\\n lu mn djj zw ds zw ixa baxzax ei r xoxhn zmtefx y gp fk kv caw eaaa aamag\\n csq gsib dqebbquaaibaqbr iw nj elj fkrh q qe svee b aqa ruf zusku k\\nlsih ucfbk qvgljnhsc qucz ibn jzeq epq sdnom fwcv mc ah qf xfgyx jgpw f\\nutn uifj di zhr wgf j nnbt hrkecw zex z hcjt eci ek dsr ao bx yrcqt c\\n wq plvm llyjc zc skhvdnyakf sygmocsw gel vliz ocay asgbi ebw\\n rk ca yzwvhjqjp cuz jecl vdkpijb zgdjamdmdj zy pye auxar wss d\\nci um h ewtmr uzb lljkj jp bxrnontgm wzm qfhx follow csr generat use follow openssl command use cat ec req file openssl req newkey ecparm keyout eckey pem keyform pem ec req outform pem defin pkcs dsa `` miicfj ccaj caqawf delmak gauebh mcvvmx cz ajbg nvbag mak dmqww cg ydvqqh\\n dansvfax ez arbg nvbao mck rtqunvb xbhbnkx dz anbg nvbas mbk rtqwi zz eqmag\\n aueaww hzhnh igrv ztea mbg gcsq gsib dqejarylzhnh qgrv zsjbwgg gmiib\\n kw yhko zizjg eatccarcg yeaq ifbykr eaa ulipbgc hhcctxgdh bfd ud opng\\n bsetpuflw qmo cxst yejalm mvkj fwbgv bwsa jbnjd ddnsp kegc gm\\n zpqd mysb qjjq yax ea atvi l r bg ggm efdhc ezm tcge qklwoa bzqcc\\na cfqdcol bfu eph ohj xaw eeepjk rjw kbg dv zt lctj bz vfnj aox smamw w\\nora nfdi zzceam yi dn cgaj vrqi dbqakk lyxo jxyvg nba bnuyswaqdu\\nso htu eurcbh ui oe kbwpj miwl pd du cruui bfxbi ana ridctkchhwi ok\\n ff qmu yoze bh mqqm ageaakbg duw rhucfu qj ttr imtxhl vzton rt vix\\n ehpu xx aoux atvkth jta cbkc ehiib e kg nug gx zd fj bub xfpk ys rtqrlfs\\n pzgi tov op kjqiw cle nkfb evdl xyt akj xub hmi nog kxhmta p\\nh ucro aaw cqyhko zizjg eaw mw adat ah uah pcq qgg kuupkdw bncm zfz wdqjs cfah\\nzn hujl xna taohjm pmc jsx t follow csr generat use follow openssl command use cat dsa req file openssl req newkey dsa dsaparm keyout dsakey pem keyform pem dsa req outform pem defin pkcs ecdsa `` miibmtcbg ibadbmqsw cqydvqqgew jvuz elmak gauecaw ctk mx ddakbg nvbac m\\n ajuudesmbagauecgw jrundbw ywmqw daydvqqldavfqi zz epmagaue\\n aww grumg zgl mrkw fw yjko zihvc naqk bfgpl ybkb uu yt mfkw ew yhko zizj c\\n aqyiko zizj daqc dqg aeousz ckd xnfzyg nlne saz qkod gtqd dddti jn\\n lp btnv ktjiktsk wsyyvq lxvnq q tui qjaamak gbyq gsmbaedrw aw\\n raig pqda tekzfpopg ufw fmrsxc nmu queyuz sqcibf lvmu mey yoqbb d\\n xifdeyzk rovbcepv khc uk defin pkcs corrupt `` miibmtcbg ibadbmqsw cqydvqqgew jvuz elmak gauecaw ctk mx ddakbg nvbac m\\n ajuudesmbagauecgw jrundbw ywmqw daydvqqldavfqi zz epmagaue\\n aww grumg zgl mrkw fw yjko zihvc naqk bfgpl ybkb uu yt mfkw ew yhko zizj c\\n aqyiko zizj daqc dqg aeousz ckd xnfzyg nlne saz qkod gtqd dddti jn\\n lp btnv ktjiktsk wsyyvq lxvnq q tui qjaamak gbyq gsmbaedrw aw\\n raig pqda tekzfpopg ufw fmrsxc nmu queyuz sqcibf lvmu mey yoqbb d\\n xifdeyzk rovbcepv khc uk follow valid csr contain po p challeng password collect use estserv dumpbin function csr work po p valu stale defin pkcs stale pop `` miibcj cbaibadarmqw dqydvqqdew zurvnuqwg zw dqyjko zihvc naqebbqad\\ng yamigjao gbapdhvrk vbr fhl ku isr zgixld ryrdsv fsm ww wvx dsx fr\\nzc ktqg juy wnyofnwxozh ce xpht hy hl l n zu mt ktlubjgqxg\\nuuahtwiyur u ekmh qwpvt uyp hzuqmql oqlm emwnih ag mbaagg\\n ij ag bgkqhki gw bcqcx ex yrujd gnzunuwyd vue wt mc aow dqyjko zihvc naqef\\n bqadg yeayenrskmf rixcp kbv lvn wnhc ltw ihcbr swfqaw rru uxdj\\n agbr gv tk tgh inwg cvz gf zh iu gok fti mn nrh zslyhf sfjbu ivr wh\\nvf lrnmqjlfp ayf wxdq dxotzwttr gzgkajr oi b defin enrol url ba `` https known est simpleenrol defin pkcs ct `` content type applic pkcs defin uidpwd good `` estus estpwd evp pkey generat privat key rsa rsa rsa new bignum bn bn new evp pkey pkey creat rsa keypair assign pkey bn set word bn x rsa generat key ex rsa bn null pkey evp pkey new pkey null printf `` \\n error alloc pkey structur new key pair\\n null evp pkey set rsa pkey rsa printf `` \\n error assign rsa key pair pkey structure\\n null rsa free rsa bn free bn pkey defin good token `` wwigrvbid ighhdm ugd gga gsb gvi iekga gvhci bb u defin differ token `` vvsb cwg ssd zsbnb qgd ggcn vu ihrv igtl zxag zn jvb sboa wrpbic nck fu zcbjjg ymbm qgd gga vlc cbvbi bya wrpbic nck fu zcbjjzl igdvd cbvbm ugb wy zsbza wx zxig zgsb gfi dqp cd xqg ssdt igvd cbnbu ysbs zxqg jvt ignhd gno igl lcbubw ktm igdvbmh igxld zwg yfyggd ghl igp zgp zh ihjp zgvi defin null token null defin token `` ssbj ywnd cbh zjl zsbbi bka xnh zjl zsanck zp zha wn igxpa ug ssdt igzp zha wn igzvci bsa wzl iakvghl sdi zsbvbmx ihdvcm rz igjd cba gvignd cbsa wtl igeg ymxh zgug dqp tdlu zlu zy ba wrl ihdpd ggg ywxs igm igigp zh iakdqp ba cbzwfo lcbjigd zxnz igl jmg ywxs igm ihro yxqg ym zm vl lcba gfjmg zigigpbm qga wg ysba glyb canckknb sbzd glsb cbjd xnza wn igfu zcbia xrja glu zy bhbm qgd ghlcm ug ywlu jqgbmib righlcm ug dqo ncko ihll ywgs ihlvd sbkbnd cbo yxzl ihrv ighvb gxlci bjighl yxige wiakssdt ihnywka wn ihjp zh ighlcm ug ym vza wrl ihlvd sancko lcaosbza gfk zxmgb yg yjhenk ieknb saosbza gfk zxmgb yg yjhenkg dqp dcm fe swg yjhenk igni yxp lcbjcm fe sancg kugci bhbma gvi igrya wr lcbt ywtl igl igeg zgymxl igzvci bt zsanckh wjl iekg yfu igrya wr ihroa xmg yxdhe sanckl jmgbm vzxig zn vu ihdo zwgd ghle sbwd wxs igd cba gug zvu iakqm vhd cbb ug ymxh ysg ywk igjsd wus igjv sancllvd sbnb rysbw yxks ihlvd sbnb rysbw yxkg dqo ncko lcba gvi zsba guga gvsb cbhb sbjpi bjighvc gug yxqgb gvhc qg ssbo ywqg zn vu iakssdt ihnd wib glu zy ba hjvd wdo ieldi bpcmxl ywz igo lcbbi ba gugcmlza wn ihnbi ancg ktgge wvha cwge wigrvbid ighhdm ugd gga gsb gvi iekga gvhci bb ug dqp jjgc rhbm rpbmcgcmlna hqga gvi zsbi zxnp zguge wiaktg idk ihno ywrlci bv zi bjcm fe swg ssdt idk ihno ywrlci bv zi bjcm fe sanck ny yxp lcbjcm fe swg yjhenk igni yxp iakdqp mb jk ighhdm ugb wvi ykgbgb wug dqp ob zlbn rh igzxzh ihrvbmz igrl igxv yg dqo nckkgbm vl zcbzbl ihbl ywnl lcbqd xnihnvb wugcm vsa wvm iakrn jvb sba glz ihzva wnl lcbra wxsa wn igl iakwwihnyxjl igfigl lcbhbm qge wigd yxjl igfigl iakqwx ihroa xmgc gfpbi bpd cdz igfsb cba gugc ft zswga xqnci bhb gwga wz ywl iakkhlvd sbz zwup iakdqp jci ba glz ihjl ywxse sbo yxbw zwpbmcgb ig zglk iekgb wfr zsbpd cbhb gwgd xa iakssdt igjvd wk igzvci bda gfd gfobja gvl igu igegd hvybmlw ihryd wnr iakdqp pa cbzwfo lcbb ug zgu jqga gfzsbbi bobx zxig ssbo zwfi ihlvd sanckknb sbzd gfu zglu zy bya wdod cbo zxjl igjlclk zsbb ug dqp pa cwg otkgchh zgvz igm igni yxp lcbjjg otkgchh zgvz igm igni yxp iakqjhenk igni yxp lcbjcm fe swg yjhenkg dqo nck fo ihlvd sdi zsbjcm fe sbb uncm ug yjhenkg dqp ibxk igigzl zxqs igzl zxqgd ggd ghl igzpcm ug dqp zb uga gs zcbte sbm zwvihrv ihro zsbma xjl iakssbu zxzlci bz ywlk iekgd fz igrvdgdla cbb u test token `` wwigrvbid ighhdm ugd gga gsb gvi iekga gvhci bb u auth cred callback call auth cred forc error auth credenti token cb applic layer callback function token base authent credenti call s regist est client use est client set auth cred cb test function requir set global valu order make callback oper way test want auth cred forc error tell function forc respons code error test token pointer hard code string token string callback provid token credenti heap base buffer ownership buffer implicit transfer et client librari est http auth cred rc auth credenti token cb est http auth hdr auth credenti token ptr null token len cu assert auth credenti mode auth token report callback call auth cred callback call test request forc error respons code callback auth cred forc error est http auth cred avail auth credenti mode auth token test token set need alloc space heap copi valu test token null token len strlen test token use strlen string larg need test est client token len printf `` \\n error determin length token string use credentials\\n est http auth cred avail token ptr malloc token len token ptr null printf `` \\n error alloc token string use credentials\\n est http auth cred avail strncpi token ptr test token strlen test token token ptr  token len  \\ far token ptr point string contain token return assign success auth credenti auth token token ptr est http auth cred success est http auth cred avail auth credenti basic cb token base instead return basic credenti userid password est http auth cred rc auth credenti basic cb est http auth hdr auth credenti cu assert auth credenti mode auth basic report callback call auth cred callback call test request forc error respons code callback auth cred forc error est http auth cred avail auth credenti mode auth basic auth credenti user malloc `` estus strncpi auth credenti user `` estus `` estus auth credenti pwd malloc `` estpwd strncpi auth credenti pwd `` estpwd `` estpwd est http auth cred success est http auth cred avail auth credenti digest cb basic base instead verfi auth mode pass digest est http auth cred rc auth credenti digest cb est http auth hdr auth credenti cu assert auth credenti mode auth digest report callback call auth cred callback call test request forc error respons code callback auth cred forc error est http auth cred avail auth credenti mode auth digest auth credenti user malloc `` estus strncpi auth credenti user `` estus `` estus auth credenti pwd malloc `` estpwd strncpi auth credenti pwd `` estpwd `` estpwd est http auth cred success est http auth cred avail endif callback function pass est client init client manual cert verifi x cur cert openssl cert error bio bio err bio err bio new fp stderr bio noclos approv print specif cert printf `` s open ssl est server cert verif fail follow error openssl cert error d s \\n _ function__ openssl cert error x verifi cert error string openssl cert error printf `` fail cert \\n x print fp stdout cur cert print signatur use fingerprint fingerprint check anticip valu determin server s cert approv x signatur print bio err cur cert sig alg cur cert signatur openssl cert error x v err unabl crl approv bio free bio err approv simpl enrol use test case perform simpl enrol simpl enrol cn server est error expect enrol rv auth credenti cb callback est ctx ectx evp pkey key est error rv pkcs len new cert null est error e rc creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null e rc est client set auth cred cb ectx callback cu assert e rc est err set est server address port est client set server ectx server tcp proxi port null generat privat key key generat privat key cu assert key null use simplifi api enrol csr rv est client enrol ectx cn pkcs len key cu assert rv expect enrol rv cleanup evp pkey free key new cert free new cert est destroy ectx simpl reenrol cn server est error expect enrol rv auth credenti cb callback est ctx ectx evp pkey key est error rv pkcs len new cert null pkcs p null bio b x cert null stack x cert null est error e rc creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null e rc est client set auth cred cb ectx callback cu assert e rc est err set est server address port est client set server ectx server tcp proxi port null generat privat key key generat privat key cu assert key null use simplifi api enrol csr rv est client enrol ectx cn pkcs len key cu assert rv est err retriev cert given est server rv est err new cert malloc pkcs len cu assert new cert null rv est client copi enrol cert ectx new cert cu assert rv est err est destroy ectx ectx null creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null cert server token mode st enabl http token auth e rc est client set auth cred cb ectx callback cu assert e rc est err set est server address port est client set server ectx server tcp port null attempt reenrol token mode convert cert x warn pure hackeri pdb convers code come test case b bio new bio f base bio new mem buf new cert pkcs len bio push b p di pkcs bio null cu assert p null bio free obj objnid p type nid pkcs cert p d sign cert nid pkcs envelop cert p d envelop cert cu assert cert null cert new cert cert pkcs blob nt iter list cert sk x valu cert cu assert cert null pdb note moment expect fail server doe understand request token authent complet assert begin fail need chang pass respons rv est client reenrol ectx cert pkcs len key cu assert rv expect enrol rv cleanup evp pkey free key new cert free new cert est destroy ectx clean start server manual enrol nid rv start est server act ca rv st start tcp server port server cert server key `` estrealm cacert trust cert `` est exampl ca cnf manual enrol manual enrol disabl po p nid ecdh nid info sleep rv est err rv start est proxi act ra server oper token auth mode rv st proxi start token tcp proxi port proxi cert proxi key `` estrealm cacert trust cert `` estus `` estpwd `` tcp server port disabl po p sleep rv stop server st stop st proxi stop sleep routin call cunit initi test suit use alloc data open resourc requir test case init suit rv est init logger est log lvl info null read ca certif cacert len read binari file cacert cacert cacert len clean start instanc est server automat enrol enabl rv start server rv routin call cunit uniniti test suit use dealloc data close resourc use test case destroy suit stop server free cacert simpl enrol proxi basic server basic make sure token auth mode did test rv log func nm rv curl http post enrol url ba pkcs ct pkcs rsa uidpwd good cacert curlauth basic null null null pass valid user id password expect server respond cu assert rv endif simpl enrol proxi token server token test log func nm auth cred callback call auth cred forc error set server token auth challeng tell server token accept st enabl http token auth st set token good token set proxi token auth challeng tell token accept st proxi enabl http token auth st proxi set srv valid token good token tell client proxi token credenti use st proxi set clnt token cred good token set est client perform simpl enrol enrol succeed simpl enrol `` tc server ip est err auth credenti token cb callback call cu assert auth cred callback call simpl enrol proxi token server basic test log func nm auth cred callback call auth cred forc error set server basic auth challeng st enabl http basic auth set proxi token auth challeng tell token accept st proxi enabl http token auth st proxi set srv valid token good token tell client proxi token credenti use st proxi set clnt token cred good token set est client perform simpl enrol enrol succeed simpl enrol `` tc server ip est err auth credenti token cb callback call cu assert auth cred callback call simpl enrol proxi basic server token test log func nm auth cred callback call auth cred forc error set server token auth challeng tell server token accept st enabl http token auth st set token good token set proxi basic auth challeng tell token accept st proxi enabl http basic auth st proxi set srv valid token good token tell client proxi token credenti use st proxi set clnt token cred good token set est client perform simpl enrol enrol succeed simpl enrol `` tc server ip est err auth credenti basic cb callback call cu assert auth cred callback call simpl enrol proxi token server token test log func nm auth cred callback call auth cred forc error set server token auth challeng tell server token accept st enabl http token auth st set token good token set proxi token auth challeng tell token accept st proxi enabl http token auth st proxi set srv valid token good token tell client proxi token credenti use st proxi set clnt token cred good token set est client perform simpl enrol enrol succeed simpl reenrol `` tc server ip est err auth credenti token cb callback call cu assert auth cred callback call main function set run test return cue success success run cunit error code failur add suit ifdef cunit cu p suit p suit null add suit registri p suit cu add suit `` token proxi init suit destroy suit null p suit cu cleanup registri cu error add test suit null cu add test p suit `` proxi enrol basic saniti test test null cu add test p suit `` proxi enrol token auth proxi server test null cu add test p suit `` proxi enrol token auth proxi token server basic test null cu add test p suit `` proxi enrol token auth proxi basic server token test null cu add test p suit `` proxi enrol token auth proxi basic server token test cu cleanup registri cu error cue success endif