 c unit test user stori client simpl enrol septemb copyright c cisco system right reserv includ stdio h ifndef win includ unistd h endif includ est h includ `` test util h includ `` st server h includ openssl ssl h includ openssl xv h ifdef cunit includ `` cunit basic h includ `` cunit autom h endif cacert null cacert len defin server port defin server ip `` defin uid `` estus defin pwd `` estpwd follow cert use fqdn test ifndef win defin cacert `` ca est ca cacert crt defin trust cert `` ca trustedcert crt defin server certkey `` ca est ca privat estservercertandkey pem defin server cert cn mismatch `` cert cn mismatch pem defin server key cn mismatch `` key cn mismatch pem defin server cert cn mismatch ip `` cert cn mismatch ip pem defin server key cn mismatch ip `` key cn mismatch ip pem defin server cert cn match wc `` cert cn match wc pem defin server key cn match wc `` key cn match wc pem defin server cert cn mismatch wc `` cert cn mismatch wc pem defin server key cn mismatch wc `` key cn mismatch wc pem defin server cert san match `` cert san match pem defin server key san match `` key san match pem defin server cert san mismatch `` cert san mismatch pem defin server key san mismatch `` key san mismatch pem defin server cert san mismatch ip `` cert san mismatch ip pem defin server key san mismatch ip `` key san mismatch ip pem defin server cert san match ip `` cert san match ip pem defin server key san match ip `` key san match ip pem defin server cert san match wc `` cert san match wc pem defin server key san match wc `` key san match wc pem defin server cert san mismatch wc `` cert san mismatch wc pem defin server key san mismatch wc `` key san mismatch wc pem defin cacert `` ca\\\\est ca\\\\cacert crt defin trust cert `` ca\\\\trustedcert crt defin server certkey `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin server cert cn mismatch `` us\\\\cert cn mismatch pem defin server key cn mismatch `` us\\\\key cn mismatch pem defin server cert cn mismatch ip `` us\\\\cert cn mismatch ip pem defin server key cn mismatch ip `` us\\\\key cn mismatch ip pem defin server cert cn match wc `` us\\\\cert cn match wc pem defin server key cn match wc `` us\\\\key cn match wc pem defin server cert cn mismatch wc `` us\\\\cert cn mismatch wc pem defin server key cn mismatch wc `` us\\\\key cn mismatch wc pem defin server cert san match `` us\\\\cert san match pem defin server key san match `` us\\\\key san match pem defin server cert san mismatch `` us\\\\cert san mismatch pem defin server key san mismatch `` us\\\\key san mismatch pem defin server cert san mismatch ip `` us\\\\cert san mismatch ip pem defin server key san mismatch ip `` us\\\\key san mismatch ip pem defin server cert san match ip `` us\\\\cert san match ip pem defin server key san match ip `` us\\\\key san match ip pem defin server cert san match wc `` us\\\\cert san match wc pem defin server key san match wc `` us\\\\key san match wc pem defin server cert san mismatch wc `` us\\\\cert san mismatch wc pem defin server key san mismatch wc `` us\\\\key san mismatch wc pem critic section logger critic section logger stderr format va list l enter critic section logger critic section vfprintf stderr format l fflush stderr leav critic section logger critic section endif defin valid csr pem `` begin certif request \\n miibh dcbg ibadbfmqsw cqydvqqgew jbvtetmbegauecaw kut zstd gfzteh\\n mbgauecgw yswzxju zxqg vlk zlci bqd hkg thrk migf magcsq gsib dqeb\\n aquaagnadcbi qkbg qcw egv bymquu skvkx zctlcka msdlw mlirs\\n sa clezbj jye sxw zq xy rtv fdrrtl l qtg tkz kidyuzdgw qqx t s\\na cv lxc utf ipiaq atuqx zah fotiw lsw aqfthib yprjzz hal xwdw id\\n aqabo aaw dqyjko zihvc naqefbqadg yeajw sj lq fazo pga gkn aeitep vaqj xl\\n lszr vjmwjl ovm patn frqymr vkb sq ddon djtg zoq iwbuj um geu\\n uux jsjv gxi qy ne ty gmms nwiwh skmkqh yvl bvgkw nfu qm dpr fmld j\\nh hbzxcaekr e\\n end certif request note array generat use xdd req der req c valid csr der   x x x xa x x x x x x x x x x xb x x x x x x x x x x x x xb x x x x x x x xc x xe x x xc x xa x x x x x xc x x x x x xc x xa x x x x xa xc x x x x x xd x xb x x x x xb xc x x xa xa x x xc x xa x x x x x xc x x x x x x x x x x xa x x x xf xd x x x x x xe xf xe x x x xf x xd x x xa x x x xf xd x x x x x x x xd x x x x x x x x xb xf xdd xd xa xdf x x xf xe x x xeb xa xe xff xc xf xd x xe xfe x x xf xce xf xfd xf xf x x xf xcc x x xce x x xc xc xbd x xa x xf xe x xfa xaf xe x xc xb x xcb xf x xc x xd x xc xfb xe xcf xe xd xde x x xc xc xe x xe x xb x xc xa xd x xc x xf xdc x xf x x xd x x x xfc x xc xd xef x xa xb x xa x x xe x x xd xbb x x xf xb x xb xeb xba x xf x xea xfd xd xd xd x x x x x xa x x xd x x xa x x x xf xd x x x x x x x x x xb xa xb x xc xea xe xf xeb x xca xa xf xfa x xd xee xf xe xa x x xe x xb xe xa x xdb xc xc xd xd xcd xc xcd xd x xa x x xd xfb x x x x xdd xf x xc xa x xf x xf x x xde xd x x x x x xf xd xc x xd x xb xc xc x xef xb xfc xc xec xdb xd x xe x xfa x xa xc xc x x xf x xa x xcc xdc xa x xf x xd xc x x xc x xf xc xf x xd x xf x x x x xf x xc x x xc x xd x valid csr der len leav need test case file outfil size t write func ptr size t size size t nmemb userdata size t written written fwrite ptr size nmemb outfil written endif clean start server manual enrol nid rv rv st start server port server certkey server certkey `` test realm cacert trust cert `` ca est exampl ca cnf manual enrol nid rv routin call cunit initi test suit use alloc data open resourc requir test case init suit rv ifdef win initi critic section logger critic section est init logger est log lvl info logger stderr endif read ca certif cacert len read binari file cacert cacert cacert len clean start instanc est server automat enrol enabl rv start server rv routin call cunit uniniti test suit use dealloc data close resourc use test case destroy suit st stop free cacert callback function pass est client init client manual cert verifi x cur cert openssl cert error bio bio err bio err bio new fp stderr bio noclos approv print specif cert printf `` s open ssl est server cert verif fail follow error openssl cert error d s \\n _ function__ openssl cert error x verifi cert error string openssl cert error printf `` fail cert \\n x print fp stdout cur cert print signatur use fingerprint fingerprint check anticip valu determin server s cert approv x signatur print bio err cur cert sig alg cur cert signatur openssl cert error x v err unabl crl approv bio free bio err approv evp pkey generat privat key rsa rsa rsa new bignum bn bn new evp pkey pkey creat rsa keypair assign pkey bn set word bn x rsa generat key ex rsa bn null pkey evp pkey new pkey null printf `` \\n error alloc pkey structur new key pair\\n null evp pkey set rsa pkey rsa printf `` \\n error assign rsa key pair pkey structure\\n null rsa free rsa bn free bn pkey popul x csr x req req evp pkey pkey cn x subj setup version number x req set version req l printf `` \\n unabl set x version \\n add common entri subj x req subject req x add entri txt subj `` cn mbstring asc cn printf `` \\n unabl creat x common entry\\n set public key request x req set pubkey req pkey printf `` \\n unabl set x public key\\n sign x certif request use digest key pass return open ssl error code x req sign ctx sign x req x req x evp pkey pkey evp md md rv evp pkey ctx pkctx null evp md ctx mctx evp md ctx init mctx evp digest sign init mctx pkctx md null pkey encod use der asn set modifi flag x req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod use cach copi x req info enc modifi rv x req sign ctx x mctx evp md ctx cleanup mctx rv function perform basic simpl enrol use uid pwd identifi client server use varieti test case modul simpl enrol cn server est error expect enrol rv est ctx ectx evp pkey key rv pkcs len new cert null attr data null attr len creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server server port null generat privat key key generat privat key cu assert key null latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv expect enrol rv use simplifi api enrol csr rv est client enrol ectx cn pkcs len key cu assert rv expect enrol rv retriev cert given est server rv est err new cert malloc pkcs len cu assert new cert null rv est client copi enrol cert ectx new cert cu assert rv est err cleanup evp pkey free key new cert free new cert est destroy ectx simpl enrol basic test perform simpleenrol use user id password identifi client server ident certif use client test log func nm simpl enrol `` tc server ip est err simpl enrol csr basic test perform simpleenrol use user id password identifi client server ident certif use client test use altern enrol method csr provid applic layer have libest generat csr test est ctx ectx evp pkey key rv pkcs len new cert null x req csr attr data null attr len log func nm creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null generat privat key key generat privat key cu assert key null generat csr csr x req new cu assert csr null rv popul x csr csr key `` tc latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err use altern api enrol exist csr rv est client enrol csr ectx csr pkcs len key cu assert rv est err retriev cert given est server rv est err new cert malloc pkcs len cu assert new cert null rv est client copi enrol cert ectx new cert cu assert rv est err cleanup x req free csr evp pkey free key new cert free new cert est destroy ectx simpl enrol csr null basic test perform simpleenrol use user id password identifi client server ident certif use client test use altern enrol method csr provid applic layer have libest generat csr attempt pass null csr fail test est ctx ectx evp pkey key rv pkcs len log func nm creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null generat privat key key generat privat key cu assert key null use altern api enrol null csr rv est client enrol csr ectx null pkcs len key cu assert rv est err csr cleanup evp pkey free key est destroy ectx simpl enrol csr corrupt test check x req helper function work propleri test x req csr badreq   `` bogus request log func nm tri pem decod csr est read x request badreq est cert format pem cu assert csr null tri der decod csr est read x request badreq est cert format der cu assert csr null tri invalid format csr est read x request badreq cu assert csr null tri invalid csr length csr est read x request badreq est cert format pem cu assert csr null tri valid pem encod csr csr est read x request valid csr pem strlen valid csr pem est cert format pem cu assert csr null csr x req free csr tri valid der encod csr csr est read x request valid csr der valid csr der len est cert format der cu assert csr null csr x req free csr c attempt enrol newli creat csr s est client enrol csr test est ctx ectx evp pkey key rv pkcs len x req csr attr data null attr len log func nm creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null generat privat key key generat privat key cu assert key null generat new csr csr x req new cu assert csr null rv popul x csr csr key `` tc cu assert csr null sign csr rv sign x req csr key evp sha latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err use altern api enrol exist csr pass rv est client enrol csr ectx csr pkcs len key cu assert rv est err cleanup x req free csr evp pkey free key est destroy ectx simpl enrol fqdn mismatch hostnam cn test confirm mismatch host server cert cn result auth failur tls layer client test rv log func nm stop exist server test need server use differ cert st stop spin new instanc est server use certif contain bogus hostnam cn rv st start server port server cert cn mismatch server key cn mismatch `` test realm cacert trust cert `` ca est exampl ca cnf cu assert rv rv simpl enrol `` tc server ip est err fqdn mismatch simpl enrol fqdn mismatch ipv address cn test confirm mismatch ip address server cert cn result auth failur tls layer client note test redund ip address match logic occur d nsname use instead common test rv log func nm stop exist server test need server use differ cert st stop spin new instanc est server use certif contain bogus hostnam cn rv st start server port server cert cn mismatch ip server key cn mismatch ip `` test realm cacert trust cert `` ca est exampl ca cnf cu assert rv rv simpl enrol `` tc server ip est err fqdn mismatch simpl enrol fqdn match wildcard cn test confirm wildcard match logic cn work cert use wildcard pattern cisco com server address localhost cisco com test rv log func nm stop exist server test need server use differ cert st stop spin new instanc est server use certif contain bogus hostnam cn rv st start server port server cert cn match wc server key cn match wc `` test realm cacert trust cert `` ca est exampl ca cnf cu assert rv rv simpl enrol `` tc `` localhost cisco com est err simpl enrol fqdn mismatch wildcard cn test confirm wildcard match logic cn work cert use wildcard pattern googl com server address localhost cisco com test rv log func nm stop exist server test need server use differ cert st stop spin new instanc est server use certif contain bogus hostnam cn rv st start server port server cert cn mismatch wc server key cn mismatch wc `` test realm cacert trust cert `` ca est exampl ca cnf cu assert rv rv simpl enrol `` tc `` localhost cisco com est err fqdn mismatch simpl enrol fqdn match hostnam subject alt test confirm match host server cert subject alt ext result auth success test rv log func nm stop exist server test need server use differ cert st stop spin new instanc est server use certif contain bogus hostnam cn rv st start server port server cert san match server key san match `` test realm cacert trust cert `` ca est exampl ca cnf cu assert rv rv simpl enrol `` tc `` localhost cisco com est err simpl enrol fqdn mismatch hostnam subject alt test confirm mismatch host server cert subject alt ext result auth failur test rv log func nm stop exist server test need server use differ cert st stop spin new instanc est server use certif contain bogus hostnam cn rv st start server port server cert san mismatch server key san mismatch `` test realm cacert trust cert `` ca est exampl ca cnf cu assert rv rv simpl enrol `` tc `` localhost cisco com est err fqdn mismatch simpl enrol fqdn mismatch ipv address subject alt test confirm mismatch ipv address server cert subject alt ext result auth failur test rv log func nm stop exist server test need server use differ cert st stop spin new instanc est server use certif contain bogus hostnam cn rv st start server port server cert san mismatch ip server key san mismatch ip `` test realm cacert trust cert `` ca est exampl ca cnf cu assert rv rv simpl enrol `` tc server ip est err fqdn mismatch simpl enrol fqdn match ipv address subject alt test confirm match ipv address server cert subject alt ext result auth success test rv log func nm stop exist server test need server use differ cert st stop spin new instanc est server use certif contain bogus hostnam cn rv st start server port server cert san match ip server key san match ip `` test realm cacert trust cert `` ca est exampl ca cnf cu assert rv rv simpl enrol `` tc server ip est err simpl enrol fqdn match hostnam subject alt wildcard test confirm hostnam match wildcard pattern server cert subject alt ext result auth success test rv log func nm stop exist server test need server use differ cert st stop spin new instanc est server use certif contain bogus hostnam cn rv st start server port server cert san match wc server key san match wc `` test realm cacert trust cert `` ca est exampl ca cnf cu assert rv rv simpl enrol `` tc `` localhost cisco com est err simpl enrol fqdn mismatch hostnam subject alt wildcard test confirm hostnam mismatch wildcard pattern server cert subject alt ext result auth fail test rv log func nm stop exist server test need server use differ cert st stop spin new instanc est server use certif contain bogus hostnam cn rv st start server port server cert san mismatch wc server key san mismatch wc `` test realm cacert trust cert `` ca est exampl ca cnf cu assert rv rv simpl enrol `` tc `` localhost cisco com est err fqdn mismatch simpl enrol crl check enabl client enabl crl check client generat crl server cert revok enrol succeed test rv est ctx ectx evp pkey key pkcs len new cert null cacrlcert null cacrlcert len attr data null attr len log func nm stop exist server test need server use differ cert st stop fqdn test complet start normal server rv start server cu assert rv generat crl append ca chain use client ifndef win `` openssl ca config ca est exampl ca cnf gencrl test crl pem sleep `` cat ca trustedcert crt testtrust crt sleep `` cat test crl pem testtrust crt sleep `` openssl ca config ca est exampl ca cnf gencrl test crl pem sleep `` type ca\\\\trustedcert crt us\\\\testtrust crt sleep `` type us\\\\test crl pem us\\\\testtrust crt sleep endif read ca certif cacrlcert len read binari file `` testtrust crt cacrlcert cu assert cacrlcert cacrlcert len creat client context ectx est client init cacrlcert cacrlcert len est cert format pem client manual cert verifi cu assert ectx null enabl crl check client rv est enabl crl ectx cu assert rv est err set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null generat privat key key generat privat key cu assert key null latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err use simplifi api enrol csr rv est client enrol ectx `` test cn pkcs len key cu assert rv est err retriev cert given est server rv est err new cert malloc pkcs len cu assert new cert null rv est client copi enrol cert ectx new cert cu assert rv est err cleanup evp pkey free key new cert free new cert est destroy ectx free cacrlcert simpl enrol crl check enabl client enabl crl check client generat crl server cert revok enrol fail test rv est ctx ectx evp pkey key pkcs len cacrlcert null cacrlcert len attr data null attr len log func nm revok server cert generat crl append ca chain use client ifndef win `` cp ca est ca index txt ca est ca index txt save sleep `` openssl ca config ca est exampl ca cnf revok ca est ca privat estservercertandkey pem sleep `` openssl ca config ca est exampl ca cnf gencrl test crl pem sleep `` cat ca trustedcert crt testtrust crt sleep `` cat test crl pem testtrust crt sleep `` cp ca est ca index txt save ca est ca index txt sleep `` copi ca\\\\est ca\\\\index txt ca\\\\est ca\\\\index txt save sleep `` openssl ca config ca\\\\est exampl ca cnf revok ca\\\\est ca\\\\private\\\\estservercertandkey pem sleep `` openssl ca config ca\\\\est exampl ca cnf gencrl us\\\\test crl pem sleep `` type ca\\\\trustedcert crt us\\\\testtrust crt sleep `` type us\\\\test crl pem us\\\\testtrust crt sleep `` copi ca\\\\est ca\\\\index txt save ca\\\\est ca\\\\index txt sleep endif read ca certif cacrlcert len read binari file `` testtrust crt cacrlcert cu assert cacrlcert cacrlcert len creat client context ectx est client init cacrlcert cacrlcert len est cert format pem client manual cert verifi cu assert ectx null enabl crl check client rv est enabl crl ectx cu assert rv est err set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null generat privat key key generat privat key cu assert key null latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err ssl connect use simplifi api enrol csr rv est client enrol ectx `` test cn pkcs len key cu assert rv est err ssl connect cleanup evp pkey free key est destroy ectx free cacrlcert simpl enrol receiv retri respons client issu enrol request receiv retri respons ensur retri valu obtain client test rv est ctx ectx evp pkey key pkcs len delay sec time t retri date attr data null attr len log func nm stop exist server test need server manual enrol mode st stop start server manual enrol mode rv start server cu assert rv creat client context use ca cert ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null generat privat key key generat privat key cu assert key null latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err use simplifi api enrol csr rv est client enrol ectx `` test cn pkcs len key cu assert rv est err ca enrol retri rv est err ca enrol retri retri durat make sure s set valu rv est client copi retri ectx delay sec retri date cu assert rv est err cu assert delay sec cleanup evp pkey free key est destroy ectx auth http basic auth enabl server enrol csr use valid cert uid b enrol csr use valid cert valid uid c enrol csr use valid cert invalid uid d enrol csr use invalid cert uid e enrol csr use invalid cert valid uid f enrol csr use invalid cert invalid uid auth http digest auth enabl server enrol csr use valid cert uid b enrol csr use valid cert valid uid c enrol csr use valid cert invalid uid d enrol csr use invalid cert uid e enrol csr use invalid cert valid uid f enrol csr use invalid cert invalid uid add suit ifdef cunit cu p suit p suit null add suit registri p suit cu add suit `` client simpenrol init suit destroy suit null p suit cu cleanup registri cu error add test suit import chang order test test stop est server restart use differ cert chang order fals negat occur null cu add test p suit `` simpl enrol test null cu add test p suit `` simpl enrol csr test null cu add test p suit `` simpl enrol null csr test null cu add test p suit `` simpl enrol corrupt csr test null cu add test p suit `` simpl enrol csr test null cu add test p suit `` simpl enrol hostnam mismatch fqdn cn test null cu add test p suit `` simpl enrol ipv mismatch fqdn cn test null cu add test p suit `` simpl enrol wildcard match fqdn cn test null cu add test p suit `` simpl enrol wildcard mismatch fqdn cn test null cu add test p suit `` simpl enrol hostnam match fqdn san test null cu add test p suit `` simpl enrol hostnam mismatch fqdn san test null cu add test p suit `` simpl enrol ipv mismatch fqdn san test null cu add test p suit `` simpl enrol ipv match fqdn san test null cu add test p suit `` simpl enrol wildcard match fqdn san test null cu add test p suit `` simpl enrol wildcard mismatch fqdn san test null cu add test p suit `` simpl enrol crl enabl valid server cert test null cu add test p suit `` simpl enrol crl enabl revok server cert test null cu add test p suit `` simpl enrol retri receiv test cu cleanup registri cu error cue success endif