 c unit test user stori server cacert june copyright c cisco system right reserv includ stdio h ifndef win includ unistd h endif includ est h includ curl curl h includ `` curl util h includ `` test util h includ `` st server h includ openssl ssl h ifdef cunit includ `` cunit basic h includ `` cunit autom h endif defin pkcs req `` miichj ccawcaqaw qtel mcmgaueax mccm vx igjignsa wvud cbpbi bk zwv ihn\\n zxag mj eymbygauebrmpuel eoldp zgdld cbttjoy miibij anbgkqhki gw baqef\\n aaocaqamiibcg kcaqea juwp xxdw ckv wpdwoy andqz fmxro leih vd nwf rsg\\ne ngcefc llnx hzom oyq memgp cy hz obhh npu kg muz rqzwmm jhxw rqob a\\ni oqek ha ph itrk vn syzloow sqon mzj wb tiq zdi rdl gj hg eibmqfv nt\\n csudf heg dn jahddd udjdxoawisz llz bo plgdo kkwq eepqhn zxei\\nc wfq xqkyr wpovl qmo wtqtfasqeu efgbx rpa eoflqj ejhoew lf t\\nq xngywnvx krp kgu sbic wvksw ps epjj zavdx qidaqabo aaw dqyjko zihvc n\\n aqefbqadgg ebaazxvoor rx av qpi mndp rzhhi doyd apbbzn vg rll hmldpgnu\\n xyzcyw qtxw ngyvt kja zci wd wr zhvn fuaw ur rzno lw vrzywwnc jrd sg\\nc uu bn xbgigf ql ddim qo psfgygc tcchba uvioi ciwf uffnybo bl pp\\nl oz beynqwygf uy ypcr ny xgkz qh xae rfe woejmc ea mjqyx wacx\\nkw gle uinzuen msc ngnt fa ailmd lq ekxcfjx ardh yz dyi ex fv\\nd pdou pktj ritv gi apm ocd xi yawqiuw\\n defin enrol url `` https known est simpleenrol defin cacert url `` https known est cacert defin pkcs ct `` content type applic pkcs defin uidpwd good `` estus estpwd defin uidpwd bad `` estus bogus defin server port ifndef win defin cacert `` ca est ca cacert crt defin explicit cert `` explicit cert pem defin explicit key `` explicit key pem defin implicit cert `` implicit cert pem defin implicit key `` implicit key pem defin revok cert `` revok cert pem defin revok key `` revok key pem defin selfsign cert `` selfsign cert pem defin selfsign key `` selfsign key pem defin cacert `` ca est ca cacert crt defin extcert `` ca ext ca cacert crt defin server cert `` ca est ca privat estservercertandkey pem defin server key `` ca est ca privat estservercertandkey pem defin server certkey `` ca est ca privat estservercertandkey pem test outfil  filenam max  `` test crt defin cacert `` ca\\\\est ca\\\\cacert crt defin explicit cert `` us\\\\explicit cert pem defin explicit key `` us\\\\explicit key pem defin implicit cert `` us\\\\implicit cert pem defin implicit key `` us\\\\implicit key pem defin revok cert `` us\\\\revok cert pem defin revok key `` us\\\\revok key pem defin selfsign cert `` us\\\\selfsign cert pem defin selfsign key `` us\\\\selfsign key pem defin cacert `` ca\\\\est ca\\\\cacert crt defin extcert `` ca\\\\ext ca\\\\cacert crt defin server cert `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin server key `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin server certkey `` ca\\\\est ca\\\\priv estservercertandkey pem test outfil  filenam max  `` us\\\\test crt endif clean cmd   sprintf cmd `` rm s test outfil cmd routin call cunit initi test suit use alloc data open resourc requir test case init suit clean est init logger est log lvl info null routin call cunit uniniti test suit use dealloc data close resourc use test case destori suit start appropri flavor st server base charact specifi b basic auth d digest auth c crl check n auth start server server type rv server type b rv st start server port server certkey server certkey `` estrealm `` ca est ca cacert crt `` ca trustedcert crt `` ca est exampl ca cnf st enabl http basic auth d rv st start server port server certkey server certkey `` estrealm `` ca est ca cacert crt `` ca trustedcert crt `` ca est exampl ca cnf st enabl http digest auth c `` openssl ca config ca est exampl ca cnf gencrl ca est ca crl pem sleep `` cat ca trustedcert crt ca est ca crl pem trustedcertsandcrl crt sleep rv st start server port server certkey server certkey `` estrealm `` ca est ca cacert crt `` trustedcertsandcrl crt `` ca est exampl ca cnf st enabl crl st disabl http auth n rv st start server port server certkey server certkey `` estrealm `` ca est ca cacert crt `` ca trustedcert crt `` ca est exampl ca cnf st disabl http auth rv rv http basic auth test use libcurl test http basic authent work est server use simpleenrol messag cacert messag doe client authent est server run list port prior test run test rv st rv st rv start server b st rv log func nm sleep rv curl http post enrol url pkcs ct pkcs req uidpwd good cacert curlauth basic null null null pass valid user id password expect server respond cu assert rv st stop sleep http basic auth failur test use libcurl test http basic authent work est server use bogus password use simpleenrol messag cacert messag doe client authent est server run prior test run test rv st rv st rv start server b st rv log func nm sleep rv curl http post enrol url pkcs ct pkcs req uidpwd bad cacert curlauth basic null null null pass invalid user id password expect server respond cu assert rv st stop sleep http digest auth test use libcurl test http digest authent work est server use simpleenrol messag cacert messag doe client authent est server run listen port prior test run test rv st rv st rv start server d st rv log func nm sleep rv curl http post enrol url pkcs ct pkcs req uidpwd good cacert curlauth digest null null null pass valid user id password expect server respond success cu assert rv st stop sleep http digest auth fail test use libcurl test http digest authent work est server negat test digest auth use simpleenrol messag cacert messag doe client authent est server run listen port prior test run test rv st rv st rv start server d st rv log func nm sleep rv curl http post enrol url pkcs ct pkcs req uidpwd bad cacert curlauth digest null null null pass invalid user id password expect server respond cu assert rv st stop sleep file outfil size t write func ptr size t size size t nmemb userdata size t written written fwrite ptr size nmemb outfil written test doe simpl cacert request look http respons code test rv cmd   st rv st rv start server d st rv log func nm sleep outfil fopen test outfil `` w rv curl http cacert url cacert write func fclose outfil expect server respond cu assert rv sprintf cmd `` openssl base d s openssl pkcs inform der text print cert test outfil rv cmd cu assert rv st stop sleep test sslversion ssl method m expect fail bio conn ssl ssl ssl ctx ssl ctx null rv st rv st rv start server d st rv log func nm ssl ctx ssl ctx new m cu assert ssl ctx null ssl context readi open socket server bind socket context conn open tcp socket ipv `` `` cu assert conn null creaea ssl session context ssl ssl new ssl ctx ssl set bio ssl conn conn readi let s initi tls handshak rv ssl connect ssl expect fail cu assert rv cu assert rv cleanup data ssl shutdown ssl ssl free ssl ssl ctx free ssl ctx st stop sleep test attempt creat ssl connect est server fail tls allow test log func nm test sslversion sslv client method test attempt creat tls connect est server fail tls allow test log func nm test sslversion tlsv client method test attempt creat tls connect est server succeed test log func nm test sslversion tlsv_ client method test attempt creat tls connect est server succeed test log func nm test sslversion tlsv_ client method test attempt use client certif verifi tls client authentiaiton work certif use explicit cert chain succeed test rv st rv st rv start server n st rv log func nm sleep rv curl http post cert enrol url pkcs ct pkcs req explicit cert explicit key cacert null pass valid user id password expect server respond cu assert rv st stop sleep test attempt use client certif verifi tls client authentiaiton work certif use implicit cert chain succeed test rv st rv st rv start server n st rv log func nm sleep rv curl http post cert enrol url pkcs ct pkcs req implicit cert implicit key cacert null pass valid user id password expect server respond cu assert rv st stop sleep test attempt use revok client certif verifi crl check work tls layer fail test rv st rv st rv start server r st rv log func nm sleep rv curl http post cert enrol url pkcs ct pkcs req revok cert revok key cacert null client cert revok tls handshak fail est server respons cu assert rv st stop test attempt use self client certif verifi cert chain reject cert valid ca fail test rv st rv st rv start server d st rv log func nm sleep rv curl http post cert enrol url pkcs ct pkcs req selfsign cert selfsign key cacert null client cert local ca extern ca tls handshak fail receiv http status messag server cu assert rv st stop tls anonym cipher suit disabl test use libcurl test est server accept anonym cipher suit client test singl cipher suit attempt simpl enrol server test rv st rv st rv start server d st rv log func nm sleep rv curl http post enrol url pkcs ct pkcs req uidpwd good cacert curlauth basic `` adh ae sha null null tls handshak fail curl cu assert rv st stop sleep null http realm initi server test cacert null cacert len bio certin keyin x x evp pkey priv key rv est ctx ctx log func nm read ca certif cacert len read binari file cacert cacert cu assert cacert len read server cert certin bio new bio s file intern rv bio read filenam certin server cert cu assert rv x pem read bio x certin null null null cu assert x null bio free certin read server key keyin bio new bio s file intern rv bio read filenam keyin server key cu assert rv priv key pem read bio privat key keyin null null null cu assert priv key null bio free keyin attempt init est server use null realm est init logger est log lvl info null ctx est server init cacert cacert len cacert cacert len est cert format pem null x priv key cu assert ctx null x free x evp pkey free priv key null server certif initi server test cacert null cacert len bio keyin evp pkey priv key rv est ctx ctx log func nm read ca certif cacert len read binari file cacert cacert cu assert cacert len read server key keyin bio new bio s file intern rv bio read filenam keyin server key cu assert rv priv key pem read bio privat key keyin null null null cu assert priv key null bio free keyin attempt init est server use null server key est init logger est log lvl info null ctx est server init cacert cacert len cacert cacert len est cert format pem `` testrealm null priv key cu assert ctx null evp pkey free priv key null server certif privat key initi server test cacert null cacert len bio certin x x rv est ctx ctx log func nm read ca certif cacert len read binari file cacert cacert cu assert cacert len read server cert certin bio new bio s file intern rv bio read filenam certin server cert cu assert rv x pem read bio x certin null null null cu assert x null bio free certin attempt init est server use null privat key est init logger est log lvl info null ctx est server init cacert cacert len cacert cacert len est cert format pem `` testrealm x null cu assert ctx null x free x null trust ca chain initi server test bio certin keyin x x evp pkey priv key rv est ctx ctx log func nm read server cert certin bio new bio s file intern rv bio read filenam certin server cert cu assert rv x pem read bio x certin null null null cu assert x null bio free certin read server key keyin bio new bio s file intern rv bio read filenam keyin server key cu assert rv priv key pem read bio privat key keyin null null null cu assert priv key null bio free keyin attempt init est server use null local ca chain est init logger est log lvl info null ctx est server init null null est cert format pem `` testrealm x priv key cu assert ctx null x free x evp pkey free priv key corrupt ca chain initi server test bio certin keyin x x evp pkey priv key rv est ctx ctx log func nm read server cert certin bio new bio s file intern rv bio read filenam certin server cert cu assert rv x pem read bio x certin null null null cu assert x null bio free certin read server key keyin bio new bio s file intern rv bio read filenam keyin server key cu assert rv priv key pem read bio privat key keyin null null null cu assert priv key null bio free keyin attempt init est server corrupt ca chain est init logger est log lvl info null ctx est server init `` bogus ca chain `` bogus ca chain est cert format pem `` testrealm x priv key cu assert ctx null x free x evp pkey free priv key test attempt simpl cacert request use post instead fail test rv st rv st rv start server d st rv log func nm sleep outfil fopen test outfil `` w rv curl http post cacert url pkcs ct pkcs req uidpwd good cacert curlauth basic null null null fclose outfil expect server respond cu assert rv st stop sleep test attempt use client certif verifi tls client authentiaiton work certif use explicit cert chain valid http authent credenti provid succeed test rv st rv st rv start server b st rv log func nm sleep rv curl http post certuid enrol url pkcs ct pkcs req uidpwd good explicit cert explicit key cacert null pass valid user id password expect server respond cu assert rv st stop sleep test attempt use client certif verifi tls client authentiaiton work certif use explicit cert chain invalid http authent credenti provid fail respons test rv st rv st rv start server d st rv log func nm sleep rv curl http post certuid enrol url pkcs ct pkcs req uidpwd bad explicit cert explicit key cacert null pass invalid user id password expect server respond cu assert rv st stop sleep test attempt enrol use certif ident client use good user id pwd est server setup perform certif authent http auth disabl fail respons test rv st rv st rv start server n st rv log func nm sleep rv curl http post enrol url pkcs ct pkcs req uidpwd good cacert curlauth basic null null null pass invalid user id password expect server respond cu assert rv st stop sleep main function set run test return cue success success run cunit error code failur add suit ifdef cunit cu p suit p suit null add suit registri p suit cu add suit `` srv cacert init suit destori suit null p suit cu cleanup registri cu error add test suit note order import test fread fprintf null cu add test p suit `` http basic auth test null cu add test p suit `` http basic auth fail test null cu add test p suit `` http digest auth test null cu add test p suit `` http digest auth fail test null cu add test p suit `` ca certif test null cu add test p suit `` ssl fail test null cu add test p suit `` tls fail test null cu add test p suit `` tls test null cu add test p suit `` tls test null cu add test p suit `` certif auth explicit cert chain test null cu add test p suit `` certif auth implicit cert chain test null cu add test p suit `` certif auth revok cert test null cu add test p suit `` certif auth self cert test null cu add test p suit `` anon cipher suit disabl test null cu add test p suit `` null realm test null cu add test p suit `` null server cert test null cu add test p suit `` null server key test null cu add test p suit `` null local ca chain test null cu add test p suit `` corrupt local ca chain test null cu add test p suit `` http post cacert test null cu add test p suit `` simpl enrol good http auth good cert test null cu add test p suit `` simpl enrol bad http auth good cert test null cu add test p suit `` simpl enrol http auth cert test cu cleanup registri cu error cue success endif