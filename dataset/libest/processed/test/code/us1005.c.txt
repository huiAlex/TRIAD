 c unit test user stori client easi provis novemb copyright c cisco system right reserv includ stdio h includ string h ifndef win includ unistd h endif includ est h includ `` test util h includ `` st server h includ openssl ssl h includ openssl xv h ifdef cunit includ `` cunit basic h includ `` cunit autom h endif ifdef win critic section logger critic section endif cacert null cacert len defin server port defin server ip `` defin uid `` estus defin pwd `` estpwd ifndef win defin cacert `` ca est ca cacert crt defin trust cert `` ca trustedcert crt defin server certkey `` ca est ca privat estservercertandkey pem defin client key `` implicit key pem defin client cert `` implicit cert pem defin cacert `` ca\\\\est ca\\\\cacert crt defin trust cert `` ca\\\\trustedcert crt defin server certkey `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin client key `` us\\\\implicit key pem defin client cert `` us\\\\implicit cert pem endif defin csr nopop `` mbqgbys gaqebarygcwcgsafl aw qcag\\ log search target null search target simpl callback use overrid log facil libest ll use look specif debug output logger stderr format va list l t log   ifndef win flockfil stderr enter critic section logger critic section endif log search target vsnprintf t log format l strstr t log log search target search target fprintf stderr `` s t log vfprintf stderr format l fflush stderr ifndef win funlockfil stderr leav critic section logger critic section endif clean start server manual enrol nid http auth enabl pop rv rv st start server port server certkey server certkey `` test realm cacert trust cert `` ca est exampl ca cnf manual enrol enabl pop nid http auth st disabl http auth rv routin call cunit initi test suit use alloc data open resourc requir test case init suit rv ifdef win initi critic section window initi critic section logger critic section endif est init logger est log lvl info logger stderr read ca certif cacert len read binari file cacert cacert cacert len clean start instanc est server automat enrol enabl rv start server rv routin call cunit uniniti test suit use dealloc data close resourc use test case destroy suit st stop free cacert evp pkey generat privat key rsa rsa rsa new bignum bn bn new evp pkey pkey creat rsa keypair assign pkey bn set word bn x rsa generat key ex rsa bn null pkey evp pkey new pkey null printf `` \\n error alloc pkey structur new key pair\\n null evp pkey set rsa pkey rsa printf `` \\n error assign rsa key pair pkey structure\\n null rsa free rsa bn free bn pkey function perform easi provis oper use uid pwd identifi client server use varieti test case modul easi provis cn server ba hint use cert est ctx ectx evp pkey new key rv pkcs len ca cert len new cert null evp pkey key null key raw key len cert raw cert len x cert null bio creat client context ectx est client init cacert cacert len est cert format pem null cu assert ectx null use cert read privat key key len read binari file client key key raw cu assert key len key est load key key raw key len est format pem cu assert key null free key raw read old cert cert len read binari file client cert cert raw cu assert cert len bio new mem buf cert raw cert len cu assert null cert pem read bio x aux null null null cu assert cert null cert bio free free cert raw set authent mode use user id password rv est client set auth ectx uid pwd cert key cu assert rv est err ba hint rv est client enabl basic auth hint ectx cu assert rv est err set est server address port est client set server ectx server server port null generat new privat key new key generat privat key cu assert new key null attempt provis new cert rv est client provis cert ectx cn pkcs len ca cert len new key cu assert rv est err evp pkey free new key retriev cert given est server rv est err new cert malloc pkcs len cu assert new cert null rv est client copi enrol cert ectx new cert cu assert rv est err new cert free new cert est destroy ectx retriev copi new ca cert rv est err new cert malloc ca cert len cu assert new cert null rv est client copi cacert ectx new cert cu assert rv est err new cert free new cert est destroy ectx evp pkey free key x free cert cleanup est destroy ectx easi provis http basic auth client cert basic test perform trust enrol sequenc cacert csrattr simpleenrol use user id password identifi client server ident certif use client test log func nm easi provis `` tc server ip easi provis http basic auth hint enabl client cert basic test perform trust enrol sequenc cacert csrattr simpleenrol use user id password identifi client server ident certif use client test log func nm easi provis `` tc server ip easi provis client cert http basic auth enabl basic test perform trust enrol sequenc cacert csrattr simpleenrol use user id password identifi client server ident certif use client test log func nm easi provis `` tc server ip easi provis client cert http basic auth hint enabl basic test perform trust enrol sequenc cacert csrattr simpleenrol use user id password identifi client server ident certif use client test log func nm easi provis `` tc server ip null pointer test test plen calen evp pkey key rv est ctx ectx log func nm creat valid context ectx est client init cacert cacert len est cert format pem null cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null creat valid key pair key generat privat key cu assert key null tri null context rv est client provis cert null `` test plen calen key cu assert rv est err ctx tri null p length rv est client provis cert ectx `` test null calen key cu assert rv est err invalid paramet tri null cacert length rv est client provis cert ectx `` test plen null key cu assert rv est err invalid paramet tri null key rv est client provis cert ectx `` test plen calen null cu assert rv est err key evp pkey free key est destroy ectx enabl pop server enabl csr attribut server w o challeng password oid test log func nm restart server po p enabl st stop start server set csr attribut valu doe nt includ challeng password oid st set csrattr csr nopop search debug appropri output confirm po p behavior work desir log search target `` client includ challeng password csr\\ search target provis new cert easi provis `` tc server ip cu assert search target set csr attribut valu st set csrattr null disabl pop server enabl csr attribut server w o challeng password oid test log func nm restart server po p disabl st stop start server set csr attribut valu doe nt includ challeng password oid st set csrattr csr nopop search debug appropri output confirm po p behavior work desir log search target `` cert request doe contain po p\\ search target provis new cert easi provis `` tc server ip cu assert search target set csr attribut valu st set csrattr null enabl pop server enabl csr attribut server w challeng password oid test log func nm restart server po p enabl st stop start server set csr attribut valu includ challeng password oid st set csrattr null search debug appropri output confirm po p behavior work desir log search target `` client includ challeng password csr\\ search target provis new cert easi provis `` tc server ip cu assert search target set csr attribut valu st set csrattr null disabl pop server enabl csr attribut server w challeng password oid test log func nm restart server po p disabl st stop start server set csr attribut valu includ challeng password oid st set csrattr null search debug appropri output confirm po p behavior work desir log search target `` client includ challeng password csr\\ search target provis new cert easi provis `` tc server ip cu assert search target set csr attribut valu st set csrattr null enabl pop server disabl csr attribut server test log func nm restart server po p enabl st stop start server set csr attribut valu includ challeng password oid st set csrattr null st disabl csr cb search debug appropri output confirm po p behavior work desir log search target `` client includ challeng password csr\\ search target provis new cert easi provis `` tc server ip cu assert search target set csr attribut valu st set csrattr null disabl pop server disabl csr attribut server test log func nm restart server po p disabl st stop start server set csr attribut valu includ challeng password oid st set csrattr null st disabl csr cb search debug appropri output confirm po p behavior work desir log search target `` cert request doe contain po p\\ search target provis new cert easi provis `` tc server ip cu assert search target set csr attribut valu st set csrattr null test cae repeat test http auth disabl server easi provis client cert http basic auth disabl basic test perform trust enrol sequenc cacert csrattr simpleenrol use user id password identifi client server ident certif use client test log func nm restart server http auth disabl st stop start server easi provis `` tc server ip easi provis client cert http basic auth hint enabl basic test perform trust enrol sequenc cacert csrattr simpleenrol use user id password identifi client server ident certif use client test log func nm easi provis `` tc server ip add suit ifdef cunit cu p suit p suit null add suit registri p suit cu add suit `` client easi provis init suit destroy suit null p suit cu cleanup registri cu error add test suit import chang order test test stop est server restart use differ cert chang order fals negat occur null cu add test p suit `` easi provis cert test null cu add test p suit `` easi provis cert http ba hint test null cu add test p suit `` easi provis w cert test null cu add test p suit `` easi provis w cert http ba hint test null cu add test p suit `` null pointer test null cu add test p suit `` enabl po p challeng password test null cu add test p suit `` disabl po p challeng password test null cu add test p suit `` enabl po p w challeng password test null cu add test p suit `` disabl po p w challeng password test null cu add test p suit `` enabl po p csr disabl test null cu add test p suit `` disabl po p csr disabl test null cu add test p suit `` easi provis w cert server auth test null cu add test p suit `` easi provis w cert http ba hint server auth test cu cleanup registri cu error cue success endif