 c unit test user stori proxi reenrol octob copyright c cisco system right reserv includ stdio h ifndef win includ unistd h endif includ est h includ curl curl h includ `` curl util h includ `` test util h includ `` st server h includ `` st proxi h includ openssl ssl h ifdef cunit includ `` cunit basic h includ `` cunit autom h endif cacert null cacert len defin tcp server port defin tcp proxi port follow csr generat use follow openssl command use cat rsa req file openssl req newkey rsa keyout rsakey pem keyform pem rsa req outform pem defin pkcs rsa `` miicv tccaa ucaqaw delmak gauebh mcvvmx cz ajbg nvbag mak dmqww cg ydvqqh\\n dansvfax ej aqbg nvbao mcvjtqwnlcn rjbz emmao gauecww dcn nh mraw dg ydvqqd\\n dadyc zgl mrow gayjko zihvc naqk bfgtyc fazgl lm nvb tccasiw dqyjko zi\\nhvc naqebbqadgg epadccaqo cgg ebanp ctbr ktbganq qhxhi nlopvxc jy\\n xa qz rjbo bexzqx bt ueygnh hola isasnz zkwpv mhjwm pynt oci y\\n fog ldb anm aoksfc mlbib ccsh holhaa fr wsk rtasew muoz fuv bkw ah ij\\n kpywsd yoxu wfig ehlm gplbzq fr bidrqk nlddgi xo dd nu lmjgdakv bww\\n baw ai vpsyevf wdr hwgg xn vt mw bp cgrll systum tgyb mcx jywe\\n lu mn djj zw ds zw ixa baxzax ei r xoxhn zmtefx y gp fk kv caw eaaa aamag\\n csq gsib dqebbquaaibaqbr iw nj elj fkrh q qe svee b aqa ruf zusku k\\nlsih ucfbk qvgljnhsc qucz ibn jzeq epq sdnom fwcv mc ah qf xfgyx jgpw f\\nutn uifj di zhr wgf j nnbt hrkecw zex z hcjt eci ek dsr ao bx yrcqt c\\n wq plvm llyjc zc skhvdnyakf sygmocsw gel vliz ocay asgbi ebw\\n rk ca yzwvhjqjp cuz jecl vdkpijb zgdjamdmdj zy pye auxar wss d\\nci um h ewtmr uzb lljkj jp bxrnontgm wzm qfhx defin pkcs corrupt `` miicv tccaa ucaqaw delmak gauebh mcvvmx cz ajbg nvbag mak dmqww cg ydvqqh\\n dansvfax ej aqbg nvbao mcvjtqwnlcn rjbz emmao gauecww dcn nh mraw dg ydvqqd\\n dadyc zgl mrow gayjko zihvc naqk bfgtyc fazgl lm nvb tccasiw dqyjko zi\\nhvc naqebbqadgg epadccaqo cgg ebanp ctbr ktbganq qhxhi nlopvxc jy\\n xa qz rjbo bexzqx bt ueygnh hola isasnz zkwpv mhjwm pynt oci y\\n fog ldb anm aoksfc mlbib ccsh holhaa fr wsk rtasew muoz fuv bkw ah ij\\n kpywsd yoxu wfig ehlm gplbzq fr bidrqk nlddgi xo dd nu lmjgdakv bww\\n baw ai vpsyevf wdr hwgg xn vt mw bp cgrll systum tgyb mcx jywe\\n lu mn djj zw ds zw ixa baxzax ei r xoxhn zmtefx y gp fk kv caw eaaa aamag\\n csq gsib dqebbquaaibaqbr iw nj elj fkrh q qe svee b aqa ruf zusku k\\nlsih ucfbk qvgljnhsc qucz ibn jzeq epq sdnom fwcv mc ah qf xfgyx jgpw f\\nutn uifj di zhr wgf j nnbt hrkecw zex z hcjt eci ek dsr ao bx yrcqt c\\n wq plvm llyjc zc skhvdnyakf sygmocsw gel vliz ocay asgbi ebw\\n rk ca yzwvhjqjp cuz jecl vdkpijb zgdfffmdmdj zy pye auxar wss d\\nci um h ewtmr uzb lljkj jp bxrnontgm wzm qfhx defin server ip `` defin reenrol url ba `` https known est simplereenrol defin pkcs ct `` content type applic pkcs defin uidpwd good `` estus estpwd defin uid `` estus defin pwd `` estpwd ifndef win defin cacert `` ca est ca cacert crt defin trust cert `` ca trustedcert crt defin server certkey `` ca est ca privat estservercertandkey pem defin proxi cert `` cert pem defin proxi key `` key pem defin untrust cert `` cert untrust pem defin untrust key `` key untrust pem defin expir key `` key expir pem defin expir cert `` cert expir pem defin tc cert txt `` tc new cert txt defin tc cert b `` tc new cert pkcsb defin tc cert pk `` tc new cert pkcs defin tc cert pem `` tc new cert pem defin cacert `` ca\\\\est ca\\\\cacert crt defin trust cert `` ca\\\\trustedcert crt defin server certkey `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin proxi cert `` us\\\\cert pem defin proxi key `` us\\\\key pem defin untrust cert `` us\\\\cert untrust pem defin untrust key `` us\\\\key untrust pem defin expir key `` us\\\\key expir pem defin expir cert `` us\\\\cert expir pem defin tc cert txt `` us\\\\tc new cert txt defin tc cert b `` us\\\\tc new cert pkcsb defin tc cert pk `` us\\\\tc new cert pkcs defin tc cert pem `` us\\\\tc new cert pem endif clean cmd   temporari file creat various test case ifndef win sprintf cmd `` rm s tc cert txt cmd sprintf cmd `` rm s tc cert b cmd sprintf cmd `` rm s tc cert pk cmd sprintf cmd `` rm s tc cert pem cmd sprintf cmd `` del s tc cert txt cmd sprintf cmd `` del s tc cert b cmd sprintf cmd `` del s tc cert pk cmd sprintf cmd `` del s tc cert pem cmd endif start server manual enrol nid rv start est server act ca rv st start tcp server port server certkey server certkey `` test realm cacert trust cert `` est exampl ca cnf manual enrol nid rv est err rv start est proxi actg ra rv st proxi start tcp proxi port proxi cert proxi key `` test realm cacert trust cert `` estus `` estpwd `` tcp server port nid rv routin call cunit initi test suit use alloc data open resourc requir test case init suit rv est init logger est log lvl info null read ca certif cacert len read binari file cacert cacert cacert len clean start instanc est server automat enrol enabl rv start server rv routin call cunit uniniti test suit use dealloc data close resourc use test case destori suit st stop st proxi stop free cacert simpl reenrol rsa test use libcurl test simpl reenrol bit rsa csr http basic authent use test rv log func nm rv curl http post reenrol url ba pkcs ct pkcs rsa uidpwd good cacert curlauth basic null null null pass valid user id password expect server respond cu assert rv test use exist expir cert attempt enrol expir cert contain x extens verifi new issu cert preserv extens use grep note preserv extens requir open ssl ca enabl `` copi extens knob open ssl config file test suit use uniqu copi est exampl ca cnf test est ctx ectx evp pkey key key raw key len cert raw cert len rv pkcs len new cert null x cert null bio cmd   attr data null attr len log func nm creat client context ectx est client init cacert cacert len est cert format pem null cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip tcp proxi port null read privat key key len read binari file expir key key raw cu assert key len key est load key key raw key len est format pem cu assert key null free key raw read old cert cert len read binari file expir cert cert raw cu assert cert len bio new mem buf cert raw cert len cu assert null cert pem read bio x aux null null null cu assert cert null cert bio free free cert raw latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err enrol expir cert contain x extens rv est client reenrol ectx cert pkcs len key cu assert rv est err retriev cert given est server rv est err new cert malloc pkcs len cu assert new cert null rv est client copi enrol cert ectx new cert cu assert rv est err save cert local file rv write binari file tc cert b new cert pkcs len cu assert rv base decod cert respons sprintf cmd `` openssl base d s s tc cert b tc cert pk rv cmd cu assert rv convert pkcs cert pem cert sprintf cmd `` openssl pkcs s inform der print cert s tc cert pk tc cert pem rv cmd cu assert rv convert pem cert textual represent cert sprintf cmd `` openssl x text s s tc cert pem tc cert txt rv cmd cu assert rv verifi jimbob dns extens preserv rv grep tc cert txt `` jimbob cu assert rv verifi bobcat dns extens preserv rv grep tc cert txt `` bobcat cu assert rv verifi ip address extens preserv rv grep tc cert txt `` cu assert rv verifi repudi key usag extens preserv rv grep tc cert txt `` repudi cu assert rv verifi public key preserv rv grep tc cert txt `` e ca fbc b bc cu assert rv clean new cert free new cert est destroy ectx simpl reenrol corrupt csr use libcurl send reenrol request contain corrupt csr test rv log func nm rv curl http post reenrol url ba pkcs ct pkcs corrupt uidpwd good cacert curlauth basic null null null pass bad csr expect server respond cu assert rv test attempt enrol expir cert est server configur manual approv server send retri respons verifi proxi propag retri respons client test est ctx ectx evp pkey key key raw key len cert raw cert len rv pkcs len x cert null bio retri val time t time val attr data null attr len log func nm stop server st stop st proxi stop restart server manual approv enabl rv start server cu assert rv creat client context ectx est client init cacert cacert len est cert format pem null cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip tcp proxi port null read privat key key len read binari file expir key key raw cu assert key len key est load key key raw key len est format pem cu assert key null free key raw read old cert cert len read binari file expir cert cert raw cu assert cert len bio new mem buf cert raw cert len cu assert null cert pem read bio x aux null null null cu assert cert null cert bio free free cert raw latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err enrol expir cert contain x extens rv est client reenrol ectx cert pkcs len key cu assert rv est err ca enrol retri server configur retri valu second rv est client copi retri ectx retri val time val cu assert rv est err cu assert retri val clean est destroy ectx stop server st stop st proxi stop restart server manual approv disabl rv start server cu assert rv test attempt enrol expir cert est server configur po p enabl proxi server use cert doe nt contain id kp cmc ra result failur test rv log func nm make sure po p enabl server st enabl pop stop proxi server restart use differ ident cert st proxi stop restart proxi server use cert rv st proxi start tcp proxi port server certkey server certkey `` test realm cacert trust cert `` estus `` estpwd `` tcp server port cu assert rv use libcurl send enrol request use libcurl includ po p rv curl http post reenrol url ba pkcs ct pkcs rsa uidpwd good cacert curlauth basic null null null po p check fail cu assert rv stop proxi server st proxi stop restart proxi server use cert rv st proxi start tcp proxi port proxi cert proxi key `` test realm cacert trust cert `` estus `` estpwd `` tcp server port cu assert rv test attempt enrol expir cert est server configur po p disabl proxi server use cert doe nt contain id kp cmc ra result success reenrol test rv log func nm make sure po p disabl server st disabl pop stop proxi server restart use differ ident cert st proxi stop restart proxi server use cert rv st proxi start tcp proxi port server certkey server certkey `` test realm cacert trust cert `` estus `` estpwd `` tcp server port cu assert rv use libcurl send enrol request use libcurl includ po p rv curl http post reenrol url ba pkcs ct pkcs rsa uidpwd good cacert curlauth basic null null null reenrol work po p enabl cu assert rv stop proxi server st proxi stop restart proxi server use cert rv st proxi start tcp proxi port proxi cert proxi key `` test realm cacert trust cert `` estus `` estpwd `` tcp server port cu assert rv enabl po p server forthcom test case st enabl pop test attempt enrol expir cert est server configur po p disabl proxi server use cert doe nt contain id kp cmc ra csr contain po p forc check result failur ra cert doe nt contain id kp cmc ra follow includ use applic use hack est ctx valu mid way test includ `` src est est locl h test rv est ctx ectx evp pkey key key raw key len cert raw cert len pkcs len x cert null bio attr data null attr len log func nm make sure po p disabl server st disabl pop stop proxi server restart use differ ident cert st proxi stop restart proxi server use cert rv st proxi start tcp proxi port server certkey server certkey `` test realm cacert trust cert `` estus `` estpwd `` tcp server port cu assert rv creat client context ectx est client init cacert cacert len est cert format pem null cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip tcp proxi port null read privat key key len read binari file expir key key raw cu assert key len key est load key key raw key len est format pem cu assert key null free key raw read old cert cert len read binari file expir cert cert raw cu assert cert len bio new mem buf cert raw cert len cu assert null cert pem read bio x aux null null null cu assert cert null cert bio free free cert raw latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err enrol expir cert contain x extens ectx csr pop requir hack test attempt need forc challeng password csr rv est client reenrol ectx cert pkcs len key cu assert rv est err http bad req stop proxi server st proxi stop restart proxi server use cert rv st proxi start tcp proxi port proxi cert proxi key `` test realm cacert trust cert `` estus `` estpwd `` tcp server port cu assert rv enabl po p server forthcom test case st enabl pop est destroy ectx test use exist expir cert attempt enrol po p disabl est server test est ctx ectx evp pkey key key raw key len cert raw cert len x cert null rv pkcs len bio attr data null attr len log func nm make sure po p disabl server st disabl pop creat client context ectx est client init cacert cacert len est cert format pem null cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip tcp proxi port null read privat key key len read binari file expir key key raw cu assert key len key est load key key raw key len est format pem cu assert key null free key raw read old cert cert len read binari file expir cert cert raw cu assert cert len bio new mem buf cert raw cert len cu assert null cert pem read bio x aux null null null cu assert cert null cert bio free free cert raw latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err enrol expir cert contain x extens rv est client reenrol ectx cert pkcs len key cu assert rv est err est destroy ectx enabl po p server forthcom test case st enabl pop test use exist expir cert attempt enrol po p disabl est server csr doe contain po p test rv log func nm make sure po p disabl server st disabl pop use libcurl send enrol request use libcurl includ po p rv curl http post reenrol url ba pkcs ct pkcs rsa uidpwd good cacert curlauth basic null null null reenrol work po p enabl cu assert rv enabl po p server forthcom test case st enabl pop test use bad password configur est proxi context caus est server reject reenrol request test rv log func nm stop proxi server restart use differ ident cert st proxi stop restart proxi server use cert rv st proxi start tcp proxi port proxi cert proxi key `` test realm cacert trust cert `` estus `` bogus `` tcp server port cu assert rv rv curl http post reenrol url ba pkcs ct pkcs rsa uidpwd good cacert curlauth basic null null null cu assert rv stop proxi server st proxi stop restart proxi server use cert rv st proxi start tcp proxi port proxi cert proxi key `` test realm cacert trust cert `` estus `` estpwd `` tcp server port cu assert rv test rv http code curl hnd curl slist slist log func nm stop proxi server restart use differ ident cert st proxi stop restart proxi server use untrust cert rv st proxi start tcp proxi port untrust cert untrust key `` test realm cacert trust cert `` estus `` estpwd `` tcp server port cu assert rv nt use normal curl util api need disabl tls peer verif special test set content type header http request slist null slist curl slist append slist pkcs ct setup field curl requir hnd curl easi init curl easi setopt hnd curlopt url reenrol url ba curl easi setopt hnd curlopt noprogress l curl easi setopt hnd curlopt userpwd uidpwd good curl easi setopt hnd curlopt postfield pkcs rsa curl easi setopt hnd curlopt postfields larg curl t strlen pkcs rsa curl easi setopt hnd curlopt userag `` curl curl easi setopt hnd curlopt httpheader slist curl easi setopt hnd curlopt maxredir l curl easi setopt hnd curlopt ssl verifyp l curl easi setopt hnd curlopt httpauth curlauth basic curl easi setopt hnd curlopt cainfo cacert curl easi setopt hnd curlopt verbos l curl easi setopt hnd curlopt tcp keepal l curl easi setopt hnd curlopt forbid reus l issu http request curl easi perform hnd http repons status code server curl easi getinfo hnd curlinfo respons code http code curl easi cleanup hnd hnd null curl slist free slist slist null cu assert http code stop proxi server st proxi stop restart proxi server use cert rv st proxi start tcp proxi port proxi cert proxi key `` test realm cacert trust cert `` estus `` estpwd `` tcp server port cu assert rv simpl reenrol rsa test use libcurl test simpl reenrol bit rsa csr http basic authent use po p enabl proxi caus failur libcurl doe nt includ po p test rv log func nm st proxi enabl pop rv curl http post reenrol url ba pkcs ct pkcs rsa uidpwd good cacert curlauth basic null null null fail proxi fail po p check cu assert rv st proxi disabl pop main function set run test return cue success success run cunit error code failur add suit ifdef cunit cu p suit p suit null add suit registri p suit cu add suit `` proxi simpreenrol init suit destori suit null p suit cu cleanup registri cu error add test suit null cu add test p suit `` enrol rsa cert test null cu add test p suit `` enrol expir cert test null cu add test p suit `` enrol corrupt csr test null cu add test p suit `` enrol expir cert retri test null cu add test p suit `` enrol proxi id kp cmc ra srv po p test null cu add test p suit `` enrol proxi id kp cmc ra w o srv po p test null cu add test p suit `` enrol proxi id kp cmc ra w o srv po p csr po p test null cu add test p suit `` enrol expir cert w o srv po p csr po p test null cu add test p suit `` enrol expir cert w o srv po p csr po p test null cu add test p suit `` enrol proxi misconfigur http auth test null cu add test p suit `` enrol proxi untrust ident cert test null cu add test p suit `` enrol po p enabl proxi csr po p test cu cleanup registri cu error cue success endif