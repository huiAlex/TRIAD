 c unit test user stori csr attribut enforc octob copyright c cisco system right reserv includ stdio h ifndef win includ unistd h endif includ est h includ `` test util h includ openssl ssl h includ openssl xv h includ `` st server h ifdef cunit includ `` cunit basic h includ `` cunit autom h endif ifndef win defin cacert `` ca est ca cacert crt defin cacert `` ca est ca cacert crt defin server cert `` ca est ca privat estservercertandkey pem defin server key `` ca est ca privat estservercertandkey pem defin cacert `` ca\\\\est ca\\\\cacert crt defin cacert `` ca\\\\est ca\\\\cacert crt defin server cert `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin server key `` ca\\\\est ca\\\\private\\\\estservercertandkey pem endif defin uid `` estus defin pwd `` estpwd defin server port defin server ip `` defin attr pop `` mas gcsq gsib dqejbw\\ defin attr cn `` maugaueaw\\ defin attr test `` mhegbi gaqebaryw ig ydi dc bmrs tgvbhcn nl ifnfvcbhci ay ljk osx igrhd gew laydi dc cmsugag aw ydi dc eexl qyxjz zsbtrvqg yxmg mi otku mi bk yxrh bg urg qqaig ydvqqdbggqhkj opqqdag\\ est ctx ectx cacert null cacert len attr handl csrattr request csr len path seg app data csr data csr len strlen attr csr data malloc csr len strncpi csr data attr csr len csr data  csr len  csr data clean start server rv start est server act ca rv st start server port server cert server key `` estrealm cacert `` ca trustedcert crt `` ca est exampl ca cnf manual enrol disabl po p ecdh nid info rv est err printf `` \\n unabl start est server \\n rv st enabl csrattr enforc rv est set csr cb ectx handl csrattr request rv est err printf `` \\n unabl set est csr attribut callback \\n rv sleep rv routin call cunit initi test suit use alloc data open resourc requir test case init suit rv clean printf `` \\n start server csr attribut enforc unit test \\n attr attr pop est init logger est log lvl info null read ca certif cacert len read binari file cacert cacert cacert len start instanc est server automat enrol enabl rv start server rv stop server st stop sleep routin call cunit uniniti test suit use dealloc data close resourc use test case destroy suit stop server free cacert printf `` complet csr attribut enforc unit test \\n evp pkey generat privat key rsa rsa rsa new bignum bn bn new evp pkey pkey creat rsa keypair assign pkey bn set word bn x rsa generat key ex rsa bn null pkey evp pkey new pkey null printf `` \\n error alloc pkey structur new key pair\\n null evp pkey set rsa pkey rsa printf `` \\n error assign rsa key pair pkey structure\\n null rsa free rsa bn free bn pkey function generat ec public privat key pair use certif provis evp pkey generat ec privat key nid ec key eckey ec group group null bio tdata key data key len bio keyin evp pkey new priv key asn flag openssl ec name curv point convers form t form point convers uncompress generat ec key group ec group new curv nid nid x_ primev ec group set asn flag group asn flag ec group set point convers form group form eckey ec key new ec key set group eckey group ec key generat key eckey printf `` fail generat ec key\\n null bio new bio s mem pem write bio ecpkparamet group pem write bio ecpriv key eckey null null null null key len bio mem data tdata key data malloc key len memcpi key data tdata key len ec key free eckey bio free read evp pkey keyin bio new bio s mem keyin bio new mem buf key data key len read privat key file expect pem encod privat key use der encod invok di privat key bio instead new priv key pem read bio privat key keyin null null null new priv key null printf `` \\n error read pem encod privat key\\n err print error fp stderr null bio free keyin free key data new priv key test attempt doe simpl enrol client provid csr attribut challeng password enrol succeed test est ctx ctx evp pkey key rv pkcs len new cert null log func nm creat client context ctx est client init cacert cacert len est cert format pem null cu assert ctx null rv est client forc pop ctx cu assert rv est err set authent mode use user id password rv est client set auth ctx uid pwd null null cu assert rv est err set est server address port est client set server ctx server ip server port null generat privat key key generat privat key cu assert key null use simplifi api enrol csr rv est client enrol ctx `` test pkcs len key cu assert rv est err retriev cert given est server rv est err new cert malloc pkcs len cu assert new cert null rv est client copi enrol cert ctx new cert cu assert rv est err cleanup evp pkey free key new cert free new cert est destroy ctx routin build pkcs csr est error popul x request x req req evp pkey pkey cn x subj rv setup version number rv x req set version req l cu assert rv rv err print error fp stderr est err x ver add common entri subj x req subject req rv x add entri txt subj `` cn mbstring asc cn cu assert rv rv err print error fp stderr est err x cn add serial number entri rv x add entri nid subj nid serial number mbstring asc `` b cu assert rv rv err print error fp stderr est err x cn add attribut server expect rv x req add attr txt req `` mbstring asc `` dummymac cu assert rv rv err print error fp stderr est err unknown rv x req add attr txt req `` mbstring asc `` dummi cu assert rv rv err print error fp stderr est err unknown rv x req add attr txt req `` mbstring asc `` dummi cu assert rv rv err print error fp stderr est err unknown rv x req add attr txt req `` mbstring asc `` dummi cu assert rv rv err print error fp stderr est err unknown rv x req add attr txt req `` mbstring asc `` dummi cu assert rv rv err print error fp stderr est err unknown rv x req add attr txt req `` mbstring asc `` cu assert rv rv err print error fp stderr est err unknown rv x req add attr txt req `` mbstring asc `` cu assert rv rv err print error fp stderr est err unknown rv x req add attr nid req nid serial number mbstring asc `` cu assert rv rv err print error fp stderr est err unknown set public key request rv x req set pubkey req pkey cu assert rv rv err print error fp stderr est err x pubkey x req print fp stderr req est err sign x certif request use digest key pass return open ssl error code x req sign ctx sign x req x req x evp pkey pkey evp md md rv evp pkey ctx pkctx null evp md ctx mctx evp md ctx init mctx evp digest sign init mctx pkctx md null pkey encod use der asn set modifi flag x req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod use cach copi x req info enc modifi rv x req sign ctx x mctx evp md ctx cleanup mctx rv endif test attempt doe simpl enrol client provid requir csr attribut csr enrol succeed test x req req null evp pkey key null pkcs len new cert null rv est ctx ctx null log func nm set list attribut server attr attr test generat privat key key generat ec privat key nid secpr cu assert key null req x req new cu assert req null rv popul x request req key `` test cu assert rv est err sign request ossl rv sign x req req key evp sha cu assert ossl rv ossl rv err print error fp stderr endif creat client context ctx est client init cacert cacert len est cert format pem null cu assert ctx null rv est client forc pop ctx cu assert rv est err set authent mode use user id password rv est client set auth ctx uid pwd null null cu assert rv est err set est server address port est client set server ctx server ip server port null use simplifi api enrol csr rv est client enrol csr ctx req pkcs len key cu assert rv est err retriev cert given est server rv est err new cert malloc pkcs len cu assert new cert null rv est client copi enrol cert ctx new cert cu assert rv est err cleanup new cert free new cert ctx est destroy ctx req x req free req key evp pkey free key test attempt doe simpl enrol client provid requir csr attribut csr bit curv use enrol fail server csr attr specifi use bit curv test x req req null evp pkey key null pkcs len rv est ctx ctx null log func nm set list attribut server attr attr test generat privat key key generat ec privat key nid secpr cu assert key null req x req new cu assert req null rv popul x request req key `` test cu assert rv est err creat client context ctx est client init cacert cacert len est cert format pem null cu assert ctx null rv est client forc pop ctx cu assert rv est err set authent mode use user id password rv est client set auth ctx uid pwd null null cu assert rv est err set est server address port est client set server ctx server ip server port null use simplifi api enrol csr rv est client enrol csr ctx req pkcs len key cu assert rv est err http bad req cleanup ctx est destroy ctx req x req free req key evp pkey free key test attempt doe simpl enrol client provid requir csr attribut csr sha use signatur enrol fail server csr attr sha test x req req null evp pkey key null pkcs len rv est ctx ctx null log func nm set list attribut server attr attr test generat privat key key generat ec privat key nid secpr cu assert key null req x req new cu assert req null rv popul x request req key `` test cu assert rv est err creat client context ctx est client init cacert cacert len est cert format pem null cu assert ctx null rv est client forc pop ctx cu assert rv est err chang sha signatur rv est client set sign digest ctx nid sha cu assert rv est err set authent mode use user id password rv est client set auth ctx uid pwd null null cu assert rv est err set est server address port est client set server ctx server ip server port null use simplifi api enrol csr rv est client enrol csr ctx req pkcs len key cu assert rv est err http bad req cleanup ctx est destroy ctx req x req free req key evp pkey free key test attempt doe simpl enrol server csr attribut configur common csr attribut server configur api callback test evp pkey key null pkcs len rv est ctx ctx null log func nm disabl csr attr callback server context rv est set csr cb ectx null cu assert rv est err configur csr attribut valu rv est server init csrattr ectx attr cn strlen attr cn cu assert rv est err generat privat key key generat privat key cu assert key null creat client context ctx est client init cacert cacert len est cert format pem null cu assert ctx null set authent mode use user id password rv est client set auth ctx uid pwd null null cu assert rv est err rv est client forc pop ctx cu assert rv est err set est server address port est client set server ctx server ip server port null enrol new cert rv est client enrol ctx `` test pkcs len key cu assert rv est err cleanup ctx est destroy ctx key evp pkey free key test attempt doe simpl enrol client provid requir csr attribut csr client provid larg quantiti addit attriut test x req req null evp pkey key null pkcs len new cert null rv est ctx ctx null t attr str   log func nm set list attribut server attr attr test generat privat key key generat ec privat key nid secpr cu assert key null req x req new cu assert req null rv popul x request req key `` test cu assert rv est err jam attribut request caus failur est server base decod csr safe c constraint max string size safe c default byte sprintf t attr str `` d rv x req add attr txt req t attr str mbstring asc `` cu assert rv rv err print error fp stderr creat client context ctx est client init cacert cacert len est cert format pem null cu assert ctx null rv est client forc pop ctx cu assert rv est err set authent mode use user id password rv est client set auth ctx uid pwd null null cu assert rv est err set est server address port est client set server ctx server ip server port null use simplifi api enrol csr rv est client enrol csr ctx req pkcs len key cu assert rv est err retriev cert given est server rv est err new cert malloc pkcs len cu assert new cert null rv est client copi enrol cert ctx new cert cu assert rv est err cleanup new cert free new cert ctx est destroy ctx req x req free req key evp pkey free key test attempt doe simpl enrol client provid requir csr attribut csr client provid attribut valu test x req req null evp pkey key null pkcs len new cert null rv est ctx ctx null log func nm set list attribut server attr attr test generat privat key key generat ec privat key nid secpr cu assert key null req x req new cu assert req null rv popul x request req key `` test cu assert rv est err add attribut valu rv x req add attr txt req `` mbstring asc `` attribut valu potenti caus problem est server cu assert rv rv err print error fp stderr add attribut rv x req add attr txt req `` mbstring asc `` cu assert rv rv err print error fp stderr creat client context ctx est client init cacert cacert len est cert format pem null cu assert ctx null rv est client forc pop ctx cu assert rv est err set authent mode use user id password rv est client set auth ctx uid pwd null null cu assert rv est err set est server address port est client set server ctx server ip server port null use simplifi api enrol csr rv est client enrol csr ctx req pkcs len key cu assert rv est err retriev cert given est server rv est err new cert malloc pkcs len cu assert new cert null rv est client copi enrol cert ctx new cert cu assert rv est err cleanup new cert free new cert ctx est destroy ctx req x req free req key evp pkey free key test attempt doe simpl enrol server csr attribut configur po p enabl test evp pkey key null pkcs len rv est ctx ctx null log func nm st enabl pop disabl csr attr callback server context rv est set csr cb ectx null cu assert rv est err generat privat key key generat ec privat key nid secpr cu assert key null creat client context ctx est client init cacert cacert len est cert format pem null cu assert ctx null rv est client forc pop ctx cu assert rv est err set authent mode use user id password rv est client set auth ctx uid pwd null null cu assert rv est err set est server address port est client set server ctx server ip server port null enrol new cert rv est client enrol ctx `` test pkcs len key cu assert rv est err cleanup ctx est destroy ctx key evp pkey free key test attempt doe simpl enrol server csr attribut configur po p disabl test evp pkey key null pkcs len rv est ctx ctx null log func nm st disabl pop disabl csr attr callback server context rv est set csr cb ectx null cu assert rv est err generat privat key key generat ec privat key nid secpr cu assert key null creat client context ctx est client init cacert cacert len est cert format pem null cu assert ctx null set authent mode use user id password rv est client set auth ctx uid pwd null null cu assert rv est err set est server address port est client set server ctx server ip server port null enrol new cert rv est client enrol ctx `` test pkcs len key cu assert rv est err cleanup ctx est destroy ctx key evp pkey free key main function set run test return cue success success run cunit error code failur add suit ifdef cunit cu p suit p suit null add suit registri p suit cu add suit `` csr attr enforc init suit destroy suit null p suit cu cleanup registri cu error add test suit note order import test fread fprintf null cu add test p suit `` attribut requir w pop test null cu add test p suit `` attribut provid w pop test null cu add test p suit `` ec public key wrong curv w pop test null cu add test p suit `` wrong hash algorithm signatur w pop test null cu add test p suit `` cn use config w pop test null cu add test p suit `` lot attribut w pop test null cu add test p suit `` attribut w pop test null cu add test p suit `` csr attr server w pop test null cu add test p suit `` csr attr server w o pop test cu cleanup registri cu error cue success endif