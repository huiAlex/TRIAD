 c unit test user stori enabl token auth mode server march copyright c cisco system right reserv includ stdio h ifndef win includ unistd h endif includ est h includ curl curl h includ `` curl util h includ `` test util h includ `` st server h includ openssl ssl h ifdef cunit includ `` cunit basic h includ `` cunit autom h endif includ errno h cacert null cacert len defin tcp port follow csr generat use follow openssl command theng use cat rsa req file openssl req newkey rsa keyout rsakey pem keyform pem rsa req outform pem defin pkcs rsa `` miicv tccaa ucaqaw delmak gauebh mcvvmx cz ajbg nvbag mak dmqww cg ydvqqh\\n dansvfax ej aqbg nvbao mcvjtqwnlcn rjbz emmao gauecww dcn nh mraw dg ydvqqd\\n dadyc zgl mrow gayjko zihvc naqk bfgtyc fazgl lm nvb tccasiw dqyjko zi\\nhvc naqebbqadgg epadccaqo cgg ebanp ctbr ktbganq qhxhi nlopvxc jy\\n xa qz rjbo bexzqx bt ueygnh hola isasnz zkwpv mhjwm pynt oci y\\n fog ldb anm aoksfc mlbib ccsh holhaa fr wsk rtasew muoz fuv bkw ah ij\\n kpywsd yoxu wfig ehlm gplbzq fr bidrqk nlddgi xo dd nu lmjgdakv bww\\n baw ai vpsyevf wdr hwgg xn vt mw bp cgrll systum tgyb mcx jywe\\n lu mn djj zw ds zw ixa baxzax ei r xoxhn zmtefx y gp fk kv caw eaaa aamag\\n csq gsib dqebbquaaibaqbr iw nj elj fkrh q qe svee b aqa ruf zusku k\\nlsih ucfbk qvgljnhsc qucz ibn jzeq epq sdnom fwcv mc ah qf xfgyx jgpw f\\nutn uifj di zhr wgf j nnbt hrkecw zex z hcjt eci ek dsr ao bx yrcqt c\\n wq plvm llyjc zc skhvdnyakf sygmocsw gel vliz ocay asgbi ebw\\n rk ca yzwvhjqjp cuz jecl vdkpijb zgdjamdmdj zy pye auxar wss d\\nci um h ewtmr uzb lljkj jp bxrnontgm wzm qfhx defin pkcs_ req `` miiezj ccak caqaw itepmagaueaww gskp uzxnmqw daydvqqfew uw mdaw mtcc\\n ai iw dqyjko zihvc naqebbqadgg ipadccago cgg ibalf ll hxqz obi kwdf xsa zl\\n jyr cpxmi qit yp iigl lv htt wzlouou bb gb xki fgq smj roelw cn\\n dih tjd gbc xm dmh dedgzpj aqur sigvnvg uzowjfugyi rh\\ndfsj ou emf zwwrmg bqzvb ddpnbdw la tk qrsxfhdb ndnsh nsyx d e\\n ixdu cfeg hqx hinuod zze anyu qmbufwoh el ub qugub mjur ynrqnii\\nduvq ujkhj nwz ih labda mw sm cejuw kbay uzzkrqo vkb wzz fsd ytn s\\n vvov mddeok xw iih grjygt wne yolonbfuevg bw eie fjb falxw\\nsp ialk gfcubit rhb bk tj gf udryp ss kdqx hnm wbxyzvk tkc nwsol\\net zp tk bto ujbn wpuq yoi ugm zt gp sp jeet dy mjha pze vk ftm uwq\\nb etoxkub gwcv xv wfi bx evvet gnsi eqezpvwsc ya cy y ofuco etr ekr\\ngap ddez vti pnpeq azu tngo ox pqr cpgbdnz uet sdd ox knfmnmwq yin\\n zpmxhtz ra kvsclv jag mbaagg adanbgkqhki gw baqufaaocag eajmw ziub\\n ushw qbfs ytsxt ks ztvun qxj nmtzz quoq okx dkpzs kx lnv hkm fqcx ag\\ngb ew xk apva mddghc nj xoq gkcl zdm gjo req zwzv tdroz pyenvg l yz sa\\nxzew pg whl vqvk vcp hneuif bgireo v fxq cauut qhg hax yww\\n jmypi ggaad zruicl qtlu aduxi ymup fcsjxzr rp elf pl oi b fa zp\\nsrzll opwn rdxvff xog xt xvir ihvhnwjkm dzykovat msa guc mdnjm kib\\n nbvhfgk bvqopsngkwn eoj rsa ksx tefm oxmp cr aer nd vog otw zdquqy \\n budmg xt wo gs kigo rhawberyw qdi rl bgg n pkzdpm yitef zvp n xw gqlj gx\\nsj twe rknggh ucuu fs rgqg ysggi dsif lhb xjnci rgq xpnrf mi rk b\\ne syvki ixt zf abtjk ubt vfo krfq nxulb jyebh lt yphjubza esw es\\nk zzpzn k gsq up whn efevi cwprnpv vnr khf bauk gr sekknzwf v yf\\n xnq wy otgdo luusg fdjsq nh amlmx cn y\\n defin enrol url ba `` https known est simpleenrol defin pkcs ct `` content type applic pkcs defin uidpwd good `` estus estpwd ifndef win defin cacert `` ca est ca cacert crt defin cacert `` ca est ca cacert crt defin trust cert `` ca trustedcert crt defin server cert `` ca est ca privat estservercertandkey pem defin server key `` ca est ca privat estservercertandkey pem defin client cert `` ca est ca privat estservercertandkey pem defin client key `` ca est ca privat estservercertandkey pem defin cacert `` ca\\\\est ca\\\\cacert crt defin cacert `` ca\\\\est ca\\\\cacert crt defin trust cert `` ca\\\\trustedcert crt defin server cert `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin server key `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin client cert `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin client key `` ca\\\\est ca\\\\private\\\\estservercertandkey pem endif curl data cb pass curl call curl data receiv function specifi retriev http header test s use retriev http header look `` bearer token author challeng bearer size t curl data cb ptr size t size size t nmemb userdata rc bearer warn strstr danger assum null termin string http header came est server know null termin rc strstr ptr `` www authent bearer rc bearer size nmemb clean start server manual enrol nid rv rv st start tcp port server cert server key `` test realm cacert trust cert `` ca est exampl ca cnf manual enrol nid rv routin call cunit initi test suit use alloc data open resourc requir test case init suit rv est init logger est log lvl info null read ca certif cacert len read binari file cacert cacert cacert len clean start instanc est server automat enrol enabl rv start server rv routin call cunit uniniti test suit use dealloc data close resourc use test case destroy suit st stop free cacert est server set auth mode unit test test paramet est server set auth mode test cacert null cacert len bio certin keyin x x evp pkey priv key rv est ctx ctx est error est rv log func nm read ca certif cacert len read binari file cacert cacert cu assert cacert len read server cert certin bio new bio s file intern rv bio read filenam certin server cert cu assert rv x pem read bio x certin null null null cu assert x null bio free certin read server key keyin bio new bio s file intern rv bio read filenam keyin server key cu assert rv priv key pem read bio privat key keyin null null null cu assert priv key null bio free keyin init est server mode est init logger est log lvl info null ctx est server init cacert cacert len cacert cacert len est cert format pem `` testrealm x priv key cu assert ctx null est rv est server set auth mode ctx auth cu assert est rv est err bad mode est rv est server set auth mode ctx auth basic cu assert est rv est err est rv est server set auth mode ctx auth digest cu assert est rv est err est rv est server set auth mode ctx auth token cu assert est rv est err est rv est server set auth mode ctx xffffffff cu assert est rv est err bad mode make sure nt allow digest mode fip mode fip mode set est rv est server set auth mode ctx auth digest cu assert est rv est err bad mode fip mode set x free x evp pkey free priv key est destroy ctx simpl enrol token auth mode goal test verifi est server respond correct auth challeng s configur token auth mode perform saniti check perform http basic request server mode http basic auth test configur server token auth mode issu request doe contain auth header forc server respond token auth challeng header test rv log func nm rv curl http post enrol url ba pkcs ct pkcs rsa uidpwd good cacert curlauth basic null null null specifi basic server basic expect server respond cu assert rv server token mode note numer place s probabl safe test set danger chang fli oper set note code set enabl function st enabl http token auth bearer rv curl http post cert write enrol url ba pkcs ct pkcs rsa client cert client key cacert curl data cb curl data cb chang auth mode server expect fail captur actual auth challeng expect server respond cu assert rv cu assert bearer main function set run test return cue success success run cunit error code failur add suit ifdef cunit cu p suit p suit null add suit registri p suit cu add suit `` cfg tok auth init suit destroy suit null p suit cu cleanup registri cu error add test suit null cu add test p suit `` check parm test null cu add test p suit `` attempt enrol basic pass test cu cleanup registri cu error cue success endif