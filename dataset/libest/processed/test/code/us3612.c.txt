 c unit test user stori encrypt privat key support juli copyright c cisco system right reserv includ stdio h ifndef win includ unistd h endif includ est h includ `` test util h includ `` st server h includ openssl ssl h includ openssl xv h ifdef cunit includ `` cunit basic h includ `` cunit autom h endif cacert null key password null cacert len defin server port defin server ip `` defin uid `` estus defin pwd `` estpwd defin good pwd `` defin bad pwd `` thiscantpossiblywork defin rsa keysiz key wrap algorithm option use protect privat key defin est privat key enc evp aes_ cbc follow cert use fqdn test ifndef win defin cacert `` ca est ca cacert crt defin trust cert `` ca trustedcert crt defin server certkey `` ca est ca privat estservercertandkey pem defin privat key file `` key pem defin cacert `` ca\\\\est ca\\\\cacert crt defin trust cert `` ca\\\\trustedcert crt defin server certkey `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin privat key file `` us\\\\us key pem critic section logger critic section logger stderr format va list l enter critic section logger critic section vfprintf stderr format l fflush stderr leav critic section logger critic section endif bio copi data bio data lenp data tdata data len data len bio mem data tdata data malloc data len data memcpi data tdata data len data  data len  \\ make sure s \\ termin use string data lenp data lenp data len printf `` malloc fail data generat privat rsa key key size pem password cb cb key data null rsa rsa rsa new rsa null bignum bn bn new bn rsa free rsa null bn set word bn x rsa generat key ex rsa key size bn null bio bio new bio s mem pem write bio rsapriv key rsa cb est privat key enc null null cb null key data bio copi data null bio free key data key data   happen passphras enter stdin doe verifi charact free key data key data null cb key data rsa free rsa bn free bn key data generat privat ec key curv nid pem password cb cb ec key eckey ec group group null key data null asn flag openssl ec name curv point convers form t form point convers uncompress generat ec key eckey ec key new eckey null group ec group new curv curv nid ec group set asn flag group asn flag ec group set point convers form group form ec key set group eckey group ec key generat key eckey null bio bio new bio s mem pem write bio ecpkparamet group pem write bio ecpriv key eckey cb est privat key enc null null cb null key data bio copi data null bio free key data strstr key data `` begin ec privat key happen passphras enter stdin doe verifi charact free key data key data null cb key data ec key free eckey key data string password cb buf size wflag data hard code password suit strncpi buf key password size strnlen buf size clean start server manual enrol nid rv rv st start server port server certkey server certkey `` test realm cacert trust cert `` ca est exampl ca cnf manual enrol nid rv routin call cunit initi test suit use alloc data open resourc requir test case init suit rv ifdef win initi critic section logger critic section est init logger est log lvl info logger stderr endif read ca certif cacert len read binari file cacert cacert cacert len clean start instanc est server automat enrol enabl rv start server rv routin call cunit uniniti test suit use dealloc data close resourc use test case destroy suit st stop free cacert callback function pass est client init client manual cert verifi x cur cert openssl cert error bio bio err bio err bio new fp stderr bio noclos approv print specif cert printf `` s open ssl est server cert verif fail follow error openssl cert error d s \\n _ function__ openssl cert error x verifi cert error string openssl cert error printf `` fail cert \\n x print fp stdout cur cert print signatur use fingerprint fingerprint check anticip valu determin server s cert approv x signatur print bio err cur cert sig alg cur cert signatur openssl cert error x v err unabl crl approv bio free bio err approv simpl enrol b client load password prortect privat key correct passphras attempt enrol certif test est ctx ectx evp pkey key rv pkcs len new cert null attr data null attr len creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null read test privat key generat command openssl genrsa ae passout pass key pem key password good pwd key read protect privat key privat key file string password cb cu assert key null latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err use simplifi api enrol csr rv est client enrol ectx `` tcus pkcs len key cu assert rv est err retriev cert given est server rv est err new cert malloc pkcs len cu assert new cert null rv est client copi enrol cert ectx new cert cu assert rv est err cleanup evp pkey free key new cert free new cert est destroy ectx simpl enrol csr load password protect privat key incorrect password attempt enrol certif fail test est ctx ectx evp pkey key rv pkcs len new cert null attr data null attr len creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null read test privat key generat command openssl genrsa ae passout pass key pem key password bad pwd key read protect privat key privat key file string password cb cu assert key null latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err use simplifi api enrol csr rv est client enrol ectx `` tc pkcs len key cu assert rv est err cleanup evp pkey free key new cert free new cert est destroy ectx simpl enrol csr chang password use callback read protect privat key file test est ctx ectx evp pkey key rv pkcs len new cert null attr data null attr len creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null read test privat key generat command openssl genrsa ae passout pass key pem key password good pwd key read protect privat key privat key file string password cb cu assert key null chang password evp pkey remain unaffect key password bad pwd latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err use simplifi api enrol csr rv est client enrol ectx `` tcus pkcs len key cu assert rv est err retriev cert given est server rv est err new cert malloc pkcs len cu assert new cert null rv est client copi enrol cert ectx new cert cu assert rv est err cleanup evp pkey free key new cert free new cert est destroy ectx test key generat util function associ password callback test new pkey null generat rsa key password new pkey generat privat rsa key rsa keysiz null cu assert new pkey null printf `` \\n s\\n new pkey free new pkey new pkey null generat rsa key password key password good pwd new pkey generat privat rsa key rsa keysiz string password cb cu assert new pkey null printf `` \\n s\\n new pkey free new pkey new pkey null generat ec key password new pkey generat privat ec key obj snnid `` primev null cu assert new pkey null printf `` \\n s\\n new pkey free new pkey new pkey null generat ec key password new pkey generat privat ec key obj snnid `` primev string password cb cu assert new pkey null printf `` \\n s\\n new pkey free new pkey new pkey null add suit ifdef cunit cu p suit p suit null add suit registri p suit cu add suit `` encrypt privat key init suit destroy suit null p suit cu cleanup registri cu error add test suit null cu add test p suit `` client simpl enrol w correct pwd test null cu add test p suit `` client simpl enrol w incorrect pwd test null cu add test p suit `` client simpl enrol w incorrect pwd test null cu add test p suit `` keygen test test cu cleanup registri cu error cue success endif