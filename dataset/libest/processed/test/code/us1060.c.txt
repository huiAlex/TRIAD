 c unit test user stori tls srp support server proxi copyright c cisco system right reserv includ stdio h includ string h ifndef win includ unistd h includ pthread h endif includ est h includ curl curl h includ `` test util h includ `` curl util h includ `` st server h includ `` st proxi h includ openssl ssl h includ openssl xv h ifdef cunit includ `` cunit basic h includ `` cunit autom h endif defin server port defin server ip `` defin uid `` estus defin pwd `` estpwd ifndef win defin cacert `` ca est ca cacert crt defin trust cert `` ca trustedcert crt defin server certkey `` ca est ca privat estservercertandkey pem defin vfile `` passwd srpv defin explicit cert `` explicit cert pem defin explicit key `` explicit key pem defin selfsign cert `` selfsign cert pem defin selfsign key `` selfsign key pem defin cacert `` ca\\\\est ca\\\\cacert crt defin trust cert `` ca\\\\trustedcert crt defin server certkey `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin vfile `` us\\\\passwd srpv defin explicit cert `` us\\\\explicit cert pem defin explicit key `` us\\\\explicit key pem defin selfsign cert `` us\\\\selfsign cert pem defin selfsign key `` us\\\\selfsign key pem endif defin enrol url `` https known est simpleenrol defin uidpwd good `` estus estpwd defin uidpwd bad `` estus xxx defin pkcs ct `` content type applic pkcs defin proxi enrol url `` https known est simpleenrol defin proxi port defin pkcs req `` miichj ccawcaqaw qtel mcmgaueax mccm vx igjignsa wvud cbpbi bk zwv ihn\\n zxag mj eymbygauebrmpuel eoldp zgdld cbttjoy miibij anbgkqhki gw baqef\\n aaocaqamiibcg kcaqea juwp xxdw ckv wpdwoy andqz fmxro leih vd nwf rsg\\ne ngcefc llnx hzom oyq memgp cy hz obhh npu kg muz rqzwmm jhxw rqob a\\ni oqek ha ph itrk vn syzloow sqon mzj wb tiq zdi rdl gj hg eibmqfv nt\\n csudf heg dn jahddd udjdxoawisz llz bo plgdo kkwq eepqhn zxei\\nc wfq xqkyr wpovl qmo wtqtfasqeu efgbx rpa eoflqj ejhoew lf t\\nq xngywnvx krp kgu sbic wvksw ps epjj zavdx qidaqabo aaw dqyjko zihvc n\\n aqefbqadgg ebaazxvoor rx av qpi mndp rzhhi doyd apbbzn vg rll hmldpgnu\\n xyzcyw qtxw ngyvt kja zci wd wr zhvn fuaw ur rzno lw vrzywwnc jrd sg\\nc uu bn xbgigf ql ddim qo psfgygc tcchba uvioi ciwf uffnybo bl pp\\nl oz beynqwygf uy ypcr ny xgkz qh xae rfe woejmc ea mjqyx wacx\\nkw gle uinzuen msc ngnt fa ailmd lq ekxcfjx ardh yz dyi ex fv\\nd pdou pktj ritv gi apm ocd xi yawqiuw\\n log search target null search target cacert null cacert len srp vbase srpdb null ifdef win critic section logger critic section endif simpl callback use overrid log facil libest ll use look specif debug output logger stderr format va list l t log   ifndef win flockfil stderr enter critic section logger critic section endif log search target vsnprintf t log format l strstr t log log search target search target fprintf stderr `` s t log vfprintf stderr format l fflush stderr ifndef win funlockfil stderr leav critic section logger critic section endif start server cert key http auth enabl pop enabl srp rv enabl srp rv st start srp server port cert key `` test realm cacert trust cert `` ca est exampl ca cnf enabl pop vfile rv st start server port cert key `` test realm cacert trust cert `` ca est exampl ca cnf enabl pop http auth st disabl http auth rv routin call cunit initi test suit use alloc data open resourc requir test case init suit rv ifdef win initi critic section window initi critic section logger critic section endif est init logger est log lvl info logger stderr start instanc est server automat enrol enabl rv start server server certkey server certkey start instanc proxi srp enabl rv st proxi start srp proxi port server certkey server certkey `` proxi realm cacert trust cert uid pwd server ip server port vfile read ca certif use client api test cacert len read binari file cacert cacert cacert len srpdb srp vbase new null srpdb printf `` \\n unabl alloc srp verifi databas abort \\n srp vbase init srpdb vfile srp error printf `` \\n unabl initi srp verifi databas abort \\n rv routin call cunit uniniti test suit use dealloc data close resourc use test case destroy suit srpdb srp vbase free srpdb st stop st proxi stop free cacert srp srp server srp mode srp good srp bad srp client srp mode http http http requir server http mode test curl cert curl key curl http auth client srp mode curl srp server http mode server http server srp mode server srp expect http result matrix unit test matrix server srp support curl use est client po p disabl server test case tri cover varieti configur potenti scenario client variat includ curl cert certif curl use null curl key key curl use null curl http auth http auth credenti use curl client srp mode good bad determin srp credenti use curl server configur server use follow variat server http mode http auth requir disabl mean occur tls auth fail server srp mode srp enabl disabl server expect http result expect http status code receiv curl srp fail result fail tls session curl return zero http layer communic tls succeed http auth fail server http respons client enrol succeed server send http respons matrix test matrix   `` null null uidpwd good srp good http requir srp `` null null uidpwd good srp bad http requir srp `` null null uidpwd good srp http requir srp `` null null uidpwd good srp good http srp `` null null uidpwd good srp bad http srp `` null null uidpwd good srp http srp `` null null uidpwd good srp good http srp `` null null uidpwd good srp bad http srp `` null null uidpwd good srp http srp `` null null uidpwd bad srp good http requir srp `` null null uidpwd bad srp bad http requir srp `` null null uidpwd bad srp http requir srp `` null null uidpwd bad srp good http srp `` null null uidpwd bad srp bad http srp `` null null uidpwd bad srp http srp `` null null uidpwd bad srp good http srp `` null null uidpwd bad srp bad http srp `` null null uidpwd bad srp http srp `` null null uidpwd good srp good http requir srp `` null null uidpwd good srp bad http requir srp `` null null uidpwd good srp http requir srp `` null null uidpwd good srp good http srp `` null null uidpwd good srp bad http srp `` null null uidpwd good srp http srp `` null null uidpwd good srp good http srp `` null null uidpwd good srp bad http srp `` null null uidpwd good srp http srp `` null null uidpwd bad srp good http requir srp `` null null uidpwd bad srp bad http requir srp `` null null uidpwd bad srp http requir srp `` null null uidpwd bad srp good http srp `` null null uidpwd bad srp bad http srp `` null null uidpwd bad srp http srp `` null null uidpwd bad srp good http srp `` null null uidpwd bad srp bad http srp `` null null uidpwd bad srp http srp `` explicit cert explicit key uidpwd good srp http requir srp `` explicit cert explicit key uidpwd bad srp http requir srp `` explicit cert explicit key uidpwd good srp http srp `` explicit cert explicit key uidpwd bad srp http srp `` explicit cert explicit key uidpwd good srp http srp `` explicit cert explicit key uidpwd bad srp http srp `` explicit cert explicit key uidpwd good srp http requir srp `` explicit cert explicit key uidpwd bad srp http requir srp `` explicit cert explicit key uidpwd good srp http srp `` explicit cert explicit key uidpwd bad srp http srp `` explicit cert explicit key uidpwd good srp http srp `` explicit cert explicit key uidpwd bad srp http srp `` selfsign cert selfsign key uidpwd good srp http requir srp `` selfsign cert selfsign key uidpwd bad srp http requir srp `` selfsign cert selfsign key uidpwd good srp http srp `` selfsign cert selfsign key uidpwd bad srp http srp `` selfsign cert selfsign key uidpwd good srp http srp `` selfsign cert selfsign key uidpwd bad srp http srp `` selfsign cert selfsign key uidpwd good srp http requir srp `` selfsign cert selfsign key uidpwd bad srp http requir srp `` selfsign cert selfsign key uidpwd good srp http srp `` selfsign cert selfsign key uidpwd bad srp http srp `` selfsign cert selfsign key uidpwd good srp http srp `` selfsign cert selfsign key uidpwd bad srp http srp worker entri test matrix read configur entri configur server client need attempt simpl enrol use curl client argument index entri tabl test matrix item rv log func nm printf `` \\n run matrix test s\\n test matrix   test stop server restart make sure s correct mode st stop sleep test matrix   server srp srp rv start server server certkey server certkey rv start server server certkey server certkey cu assert rv set server http auth configur test matrix   server http http st disabl http auth http st enabl http auth st set http auth http requir st enabl http auth st set http auth requir test matrix   curl srp srp good rv curl http post srp enrol url pkcs ct pkcs req test matrix   curl http auth null curlauth basic null `` srp user `` srp pwd null null srp bad rv curl http post srp enrol url pkcs ct pkcs req test matrix   curl http auth null curlauth basic null `` srp user `` boguspwd null null srp srp disabl test case use client certif test matrix   curl cert rv curl http post certuid enrol url pkcs ct pkcs req test matrix   curl http auth test matrix   curl cert test matrix   curl key cacert null rv curl http post enrol url pkcs ct pkcs req test matrix   curl http auth cacert curlauth basic null null null cu assert rv test matrix   expect http result rv test matrix   expect http result printf `` \\n matrix test s fail rv d\\n test matrix   test rv test run test matrix test test cnt test matrix test matrix   test cnt test matrix item test verifi happi path est proxi configur srp mode client attempt use srp connect proxi server doe use srp perform simpl enrol oper test rv log func nm restart est server srp disabl st stop sleep rv start server server certkey server certkey cu assert rv rv curl http post srp proxi enrol url pkcs ct pkcs req uidpwd good null curlauth basic null `` srp user `` srp pwd null null pass valid srp user id password expect server respond success cu assert rv test verifi simpl enrol fail est client provid bad srp password connect proxi server doe use srp test rv log func nm rv curl http post srp proxi enrol url pkcs ct pkcs req uidpwd good null curlauth basic null `` srp user `` boguspwd null null cu assert rv test verifi simpl enrol fail est client provid bad http password srp use connect proxi server doe use srp test rv log func nm rv curl http post srp proxi enrol url pkcs ct pkcs req uidpwd bad null curlauth basic null `` srp user `` srp pwd null null cu assert rv test verifi simpl enrol work est client provid http password srp use connect proxi server doe use srp http auth disabl proxi test rv log func nm st proxi http disabl rv curl http post srp proxi enrol url pkcs ct pkcs req null null curlauth null `` srp user `` srp pwd null null cu assert rv add suit ifdef cunit cu p suit p suit null add suit registri p suit cu add suit `` tls srp server proxi init suit destroy suit null p suit cu cleanup registri cu error add test suit import chang order test test stop est server restart use differ cert chang order fals negat occur null cu add test p suit `` tls srp server matrix master test null cu add test p suit `` tls srp proxi enrol w srp test null cu add test p suit `` tls srp proxi enrol bad srp pwd test null cu add test p suit `` tls srp proxi enrol bad http pwd test null cu add test p suit `` tls srp proxi enrol w o http auth test cu cleanup registri cu error cue success endif