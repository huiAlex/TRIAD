 c unit test user stori client enrol octob copyright c cisco system right reserv includ stdio h ifndef win includ unistd h endif includ est h includ est ossl util h includ `` test util h includ `` st server h includ openssl ssl h includ openssl xv h ifdef cunit includ `` cunit basic h includ `` cunit autom h endif cacert null cacert len defin server port defin server ip `` defin uid `` estus defin pwd `` estpwd ifndef win defin cacert `` ca est ca cacert crt defin trust cert `` ca trustedcert crt defin server certkey `` ca est ca privat estservercertandkey pem defin tc cert txt `` tc new cert txt defin tc cert b `` tc new cert pkcsb defin tc cert pk `` tc new cert pkcs defin tc cert pem `` tc new cert pem defin tc csr tc csr pem defin tc key tc key pem defin tc cert tc cert pem defin tc key tc key pem defin tc cert tc cert pem defin cacert `` ca\\\\est ca\\\\cacert crt defin trust cert `` ca\\\\trustedcert crt defin server certkey `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin tc cert txt `` us\\\\tc new cert txt defin tc cert b `` us\\\\tc new cert pkcsb defin tc cert pk `` us\\\\tc new cert pkcs defin tc cert pem `` us\\\\tc new cert pem defin tc csr us\\\\tc csr pem defin tc key us\\\\tc key pem defin tc cert us\\\\tc cert pem defin tc key us\\\\tc key pem defin tc cert us\\\\tc cert pem critic section logger critic section logger stderr format va list l enter critic section logger critic section vfprintf stderr format l fflush stderr leav critic section logger critic section endif clean cmd   temporari file creat various test case ifndef win sprintf cmd `` rm s tc cert txt cmd sprintf cmd `` rm s tc cert b cmd sprintf cmd `` rm s tc cert pk cmd sprintf cmd `` rm s tc cert pem cmd sprintf cmd `` rm s tc cert cmd sprintf cmd `` rm s tc key cmd sprintf cmd `` rm s tc csr cmd sprintf cmd `` del s tc cert txt cmd sprintf cmd `` del s tc cert b cmd sprintf cmd `` del s tc cert pk cmd sprintf cmd `` del s tc cert pem cmd sprintf cmd `` del s tc cert cmd sprintf cmd `` del s tc key cmd sprintf cmd `` del s tc csr cmd endif start instanc est server run separ thread use test client api modul start server manual enrol nid rv rv st start server port server certkey server certkey `` estrealm cacert trust cert `` est exampl ca cnf manual enrol nid rv routin call cunit initi test suit use alloc data open resourc requir test case init suit rv ifdef win initi critic section logger critic section est init logger est log lvl info logger stderr endif read ca certif cacert len read binari file cacert cacert cacert len clean start instanc est server automat enrol enabl rv start server rv routin call cunit uniniti test suit use dealloc data close resourc use test case destroy suit st stop free cacert evp pkey generat privat key rsa rsa rsa new bignum bn bn new evp pkey pkey creat rsa keypair assign pkey bn set word bn x rsa generat key ex rsa bn null pkey evp pkey new pkey null printf `` \\n error alloc pkey structur new key pair\\n null evp pkey set rsa pkey rsa printf `` \\n error assign rsa key pair pkey structure\\n null rsa free rsa bn free bn pkey callback function pass est client init client manual cert verifi x cur cert openssl cert error bio bio err bio err bio new fp stderr bio noclos approv openssl cert error x v err unabl crl print specif cert printf `` s open ssl est server cert verif fail follow error openssl cert error d s \\n _ function__ openssl cert error x verifi cert error string openssl cert error printf `` fail cert \\n x print fp stdout cur cert print signatur use fingerprint fingerprint check anticip valu determin server s cert approv x signatur print bio err cur cert sig alg cur cert signatur bio free bio err approv function perform basic simpl enrol use uid pwd identifi client server use variet test case modul test est ctx ectx evp pkey key rv pkcs len new cert null pkcs p null bio b x cert null stack x cert null attr data null attr len log func nm creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null generat privat key key generat privat key cu assert key null latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err use simplifi api enrol csr rv est client enrol ectx `` tc pkcs len key cu assert rv est err rv est err retriev cert given est server rv est err new cert malloc pkcs len cu assert new cert null rv est client copi enrol cert ectx new cert cu assert rv est err convert cert x warn pure hackeri b bio new bio f base bio new mem buf new cert pkcs len bio push b p di pkcs bio null cu assert p null bio free obj objnid p type nid pkcs cert p d sign cert nid pkcs envelop cert p d envelop cert cu assert cert null cert new cert cert pkcs blob nt iter list cert sk x valu cert cu assert cert null wow s lot work final x nt just love open ssl x represent cert let s tri enrol cert ca rv est client reenrol ectx cert pkcs len key cu assert rv est err cleanup cert x free cert evp pkey free key new cert free new cert est destroy ectx test use exist expir cert attempt enrol expir cert contain x extens verifi new issu cert preserv extens use grep note preserv extens requir open ssl ca enabl `` copi extens knob open ssl config file test suit use uniqu copi est exampl ca cnf test est ctx ectx evp pkey key key raw key len cert raw cert len rv pkcs len new cert null x cert null bio cmd   attr data null attr len log func nm creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null read privat key key len read binari file `` key expir pem key raw cu assert key len key est load key key raw key len est format pem cu assert key null free key raw read old cert cert len read binari file `` cert expir pem cert raw cu assert cert len bio new mem buf cert raw cert len cu assert null cert pem read bio x aux null null null cu assert cert null cert bio free free cert raw latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err enrol expir cert contain x extens rv est client reenrol ectx cert pkcs len key cu assert rv est err retriev cert given est server rv est err new cert malloc pkcs len cu assert new cert null rv est client copi enrol cert ectx new cert cu assert rv est err save cert local file rv write binari file tc cert b new cert pkcs len cu assert rv base decod cert respons sprintf cmd `` openssl base d s s tc cert b tc cert pk rv cmd cu assert rv convert pkcs cert pem cert sprintf cmd `` openssl pkcs s inform der print cert s tc cert pk tc cert pem rv cmd cu assert rv convert pem cert textual represent cert sprintf cmd `` openssl x text s s tc cert pem tc cert txt rv cmd cu assert rv verifi jimbob dns extens preserv rv grep tc cert txt `` jimbob cu assert rv verifi bobcat dns extens preserv rv grep tc cert txt `` bobcat cu assert rv verifi ip address extens preserv rv grep tc cert txt cu assert rv verifi repudi key usag extens preserv rv grep tc cert txt repudi cu assert rv verifi public key preserv rv grep tc cert txt `` e ca fbc b bc cu assert rv clean new cert free new cert est destroy ectx test enrol api ensur grace handl null x cert pointer test est ctx ectx evp pkey key pkcs len rv attr data null attr len log func nm creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null generat privat key key generat privat key cu assert key null latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err enrol use null x pointer rv est client reenrol ectx null pkcs len key cu assert rv est err cert clean evp pkey free key est destroy ectx test enrol api ensur grace handl null evp pkey pointer test est ctx ectx pkcs len rv x cert null cert raw cert len bio attr data null attr len log func nm creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null read old cert use enrol cert len read binari file `` cert expir pem cert raw cu assert cert len bio new mem buf cert raw cert len cu assert null cert pem read bio x aux null null null cu assert cert null cert bio free free cert raw latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err enrol use null evp key pointer rv est client reenrol ectx cert pkcs len null cu assert rv est err key clean x free cert est destroy ectx test attempt enrol corrupt cert public key cert corrupt test est ctx ectx evp pkey key key raw key len cert raw cert len rv pkcs len x cert null bio attr data null attr len log func nm creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null read privat key key len read binari file `` key corrupt pem key raw cu assert key len key est load key key raw key len est format pem cu assert key null free key raw read old cert cert len read binari file `` cert corrupt pem cert raw cu assert cert len bio new mem buf cert raw cert len cu assert null cert pem read bio x aux null null null cu assert cert null cert bio free free cert raw latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err enrol expir cert contain x extens rv est client reenrol ectx cert pkcs len key cu assert rv est err client invalid key clean est destroy ectx test attempt enrol expir cert est server configur manual approv server send retri respons test est ctx ectx evp pkey key key raw key len cert raw cert len rv pkcs len x cert null bio attr data null attr len log func nm stop server st stop restart server manual approv enabl rv start server cu assert rv creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null read privat key key len read binari file `` key expir pem key raw cu assert key len key est load key key raw key len est format pem cu assert key null free key raw read old cert cert len read binari file `` cert expir pem cert raw cu assert cert len bio new mem buf cert raw cert len cu assert null cert pem read bio x aux null null null cu assert cert null cert bio free free cert raw latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err enrol expir cert contain x extens rv est client reenrol ectx cert pkcs len key cu assert rv est err ca enrol retri clean est destroy ectx stop server st stop restart server manual approv disabl rv start server cu assert rv verifi bogus user id password fail use http basic auth test est ctx ectx evp pkey key key raw key len cert raw cert len rv pkcs len x cert null bio attr data null attr len log func nm creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx `` hoagi `` chili null null cu assert rv est err set est server address port est client set server ectx server ip server port null read privat key key len read binari file `` key expir pem key raw cu assert key len key est load key key raw key len est format pem cu assert key null free key raw read old cert cert len read binari file `` cert expir pem cert raw cu assert cert len bio new mem buf cert raw cert len cu assert null cert pem read bio x aux null null null cu assert cert null cert bio free free cert raw latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err enrol expir cert contain x extens rv est client reenrol ectx cert pkcs len key cu assert rv est err auth fail est destroy ectx verifi good user id password pass use http digest auth test est ctx ectx evp pkey key key raw key len cert raw cert len rv pkcs len x cert null bio attr data null attr len log func nm enabl http digest authent st enabl http digest auth creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx uid pwd null null cu assert rv est err set est server address port est client set server ectx server ip server port null read privat key key len read binari file `` key expir pem key raw cu assert key len key est load key key raw key len est format pem cu assert key null free key raw read old cert cert len read binari file `` cert expir pem cert raw cu assert cert len bio new mem buf cert raw cert len cu assert null cert pem read bio x aux null null null cu assert cert null cert bio free free cert raw latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err enrol expir cert contain x extens rv est client reenrol ectx cert pkcs len key cu assert rv est err est destroy ectx enabl http basic authent st enabl http basic auth verifi bogus user id password fail use http digest auth test est ctx ectx evp pkey key key raw key len cert raw cert len rv pkcs len x cert null bio attr data null attr len http status log func nm enabl http digest authent st enabl http digest auth creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null set authent mode use user id password rv est client set auth ectx `` jdoe `` panther null null cu assert rv est err set est server address port est client set server ectx server ip server port null read privat key key len read binari file `` key expir pem key raw cu assert key len key est load key key raw key len est format pem cu assert key null free key raw read old cert cert len read binari file `` cert expir pem cert raw cu assert cert len bio new mem buf cert raw cert len cu assert null cert pem read bio x aux null null null cu assert cert null cert bio free free cert raw latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err enrol expir cert contain x extens rv est client reenrol ectx cert pkcs len key cu assert rv est err auth fail check http status code reenrol oper http status est client http status ectx cu assert http status est destroy ectx enabl http basic authent st enabl http basic auth verifi server fail authent client send valid ident cert doe nt provid http auth credenti test cmd   rv est ctx ectx evp pkey key key raw key len cert raw cert len pkcs len x cert null bio attr data null attr len log func nm creat csr sprintf cmd `` openssl req new node s newkey rsa keyout s subj cn `` `` config ca est exampl ca cnf tc csr tc key rv cmd cu assert rv sign csr use local ca sprintf cmd `` openssl ca s batch config ca est exampl ca cnf infil s tc cert tc csr rv cmd cu assert rv creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null read privat key key len read binari file tc key key raw cu assert key len key est load key key raw key len est format pem cu assert key null free key raw read old cert cert len read binari file tc cert cert raw cu assert cert len bio new mem buf cert raw cert len cu assert null cert pem read bio x aux null null null cu assert cert null cert bio free free cert raw set authent mode use certif http auth credenti provid rv est client set auth ectx null null cert key cu assert rv est err set est server address port est client set server ectx server ip server port null latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err enrol cert fail did nt provid valid http auth credenti rv est client enrol ectx `` tc pkcs len key cu assert rv est err auth fail enrol cert work provid valid cert identifi http auth nt requir enrol server enabl http auth rv est client reenrol ectx cert pkcs len key cu assert rv est err est destroy ectx verifi server fail authent client send expir identi cert use valid http auth credenti test rv est ctx ectx evp pkey key key raw key len cert raw cert len pkcs len x cert null bio attr data null attr len log func nm creat client context ectx est client init cacert cacert len est cert format pem client manual cert verifi cu assert ectx null read privat key key len read binari file tc key key raw cu assert key len key est load key key raw key len est format pem cu assert key null free key raw read old cert cert len read binari file tc cert cert raw cu assert cert len bio new mem buf cert raw cert len cu assert null cert pem read bio x aux null null null cu assert cert null cert bio free free cert raw set authent mode use expir certif valid http auth credenti rv est client set auth ectx uid pwd cert key cu assert rv est err set est server address port est client set server ectx server ip server port null latest csr attribut rv est client csrattr ectx attr data attr len cu assert rv est err ssl connect enrol cert rv est client reenrol ectx cert pkcs len key cu assert rv est err ssl connect est destroy ectx add suit ifdef cunit cu p suit p suit null add suit registri p suit cu add suit `` client reenrol init suit destroy suit null p suit cu cleanup registri cu error add test suit null cu add test p suit `` simpl enrol enrol test null cu add test p suit `` enrol expir cert extens test null cu add test p suit `` enrol use null cert test null cu add test p suit `` enrol use null key test null cu add test p suit `` enrol use corrupt x cert test null cu add test p suit `` enrol retri test null cu add test p suit `` enrol invalid uid pwd basic test null cu add test p suit `` enrol valid uid pwd digest test null cu add test p suit `` enrol invalid uid pwd digest test null cu add test p suit `` enrol valid certif http auth test null cu add test p suit `` enrol expir certif http auth test cu cleanup registri cu error cue success endif