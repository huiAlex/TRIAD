 c unit test user stori proxi simpl enrol august copyright c cisco system right reserv includ stdio h ifndef win includ unistd h endif includ est h includ curl curl h includ `` curl util h includ `` test util h includ `` st server h includ `` st proxi h includ openssl ssl h ifdef cunit includ `` cunit basic h includ `` cunit autom h endif cacert null cacert len defin retri interv defin tcp port defin tcp server port defin tcp proxi port ifndef win test outfil  filenam max  `` test hdr defin server cert `` ca est ca privat estservercertandkey pem defin server key `` ca est ca privat estservercertandkey pem defin proxi cert `` ca est ca privat estservercertandkey pem defin proxi key `` ca est ca privat estservercertandkey pem defin proxi cert `` cert pem defin proxi key `` key pem defin cacert `` ca est ca cacert crt defin trust cert `` ca trustedcert crt test outfil  filenam max  `` us\\\\test hdr defin server cert `` ca\\\\est ca private\\\\estservercertandkey pem defin server key `` ca\\\\est ca\\\\private\\\\estservercertandkey pem defin proxi cert `` ca est ca privat estservercertandkey pem defin proxi key `` ca est ca privat estservercertandkey pem defin proxi cert `` us\\\\cert pem defin proxi key `` us\\\\key pem defin cacert `` ca\\\\est ca\\\\cacert crt defin trust cert `` ca\\\\trustedcert crt endif follow csr generat use follow openssl command use cat rsa req file openssl req newkey rsa keyout rsakey pem keyform pem rsa req outform pem defin pkcs rsa `` miicv tccaa ucaqaw delmak gauebh mcvvmx cz ajbg nvbag mak dmqww cg ydvqqh\\n dansvfax ej aqbg nvbao mcvjtqwnlcn rjbz emmao gauecww dcn nh mraw dg ydvqqd\\n dadyc zgl mrow gayjko zihvc naqk bfgtyc fazgl lm nvb tccasiw dqyjko zi\\nhvc naqebbqadgg epadccaqo cgg ebanp ctbr ktbganq qhxhi nlopvxc jy\\n xa qz rjbo bexzqx bt ueygnh hola isasnz zkwpv mhjwm pynt oci y\\n fog ldb anm aoksfc mlbib ccsh holhaa fr wsk rtasew muoz fuv bkw ah ij\\n kpywsd yoxu wfig ehlm gplbzq fr bidrqk nlddgi xo dd nu lmjgdakv bww\\n baw ai vpsyevf wdr hwgg xn vt mw bp cgrll systum tgyb mcx jywe\\n lu mn djj zw ds zw ixa baxzax ei r xoxhn zmtefx y gp fk kv caw eaaa aamag\\n csq gsib dqebbquaaibaqbr iw nj elj fkrh q qe svee b aqa ruf zusku k\\nlsih ucfbk qvgljnhsc qucz ibn jzeq epq sdnom fwcv mc ah qf xfgyx jgpw f\\nutn uifj di zhr wgf j nnbt hrkecw zex z hcjt eci ek dsr ao bx yrcqt c\\n wq plvm llyjc zc skhvdnyakf sygmocsw gel vliz ocay asgbi ebw\\n rk ca yzwvhjqjp cuz jecl vdkpijb zgdjamdmdj zy pye auxar wss d\\nci um h ewtmr uzb lljkj jp bxrnontgm wzm qfhx follow csr generat use follow openssl command use cat ec req file openssl req newkey ecparm keyout eckey pem keyform pem ec req outform pem defin pkcs dsa `` miicfj ccaj caqawf delmak gauebh mcvvmx cz ajbg nvbag mak dmqww cg ydvqqh\\n dansvfax ez arbg nvbao mck rtqunvb xbhbnkx dz anbg nvbas mbk rtqwi zz eqmag\\n aueaww hzhnh igrv ztea mbg gcsq gsib dqejarylzhnh qgrv zsjbwgg gmiib\\n kw yhko zizjg eatccarcg yeaq ifbykr eaa ulipbgc hhcctxgdh bfd ud opng\\n bsetpuflw qmo cxst yejalm mvkj fwbgv bwsa jbnjd ddnsp kegc gm\\n zpqd mysb qjjq yax ea atvi l r bg ggm efdhc ezm tcge qklwoa bzqcc\\na cfqdcol bfu eph ohj xaw eeepjk rjw kbg dv zt lctj bz vfnj aox smamw w\\nora nfdi zzceam yi dn cgaj vrqi dbqakk lyxo jxyvg nba bnuyswaqdu\\nso htu eurcbh ui oe kbwpj miwl pd du cruui bfxbi ana ridctkchhwi ok\\n ff qmu yoze bh mqqm ageaakbg duw rhucfu qj ttr imtxhl vzton rt vix\\n ehpu xx aoux atvkth jta cbkc ehiib e kg nug gx zd fj bub xfpk ys rtqrlfs\\n pzgi tov op kjqiw cle nkfb evdl xyt akj xub hmi nog kxhmta p\\nh ucro aaw cqyhko zizjg eaw mw adat ah uah pcq qgg kuupkdw bncm zfz wdqjs cfah\\nzn hujl xna taohjm pmc jsx t follow csr generat use follow openssl command use cat dsa req file openssl req newkey dsa dsaparm keyout dsakey pem keyform pem dsa req outform pem defin pkcs ecdsa `` miibmtcbg ibadbmqsw cqydvqqgew jvuz elmak gauecaw ctk mx ddakbg nvbac m\\n ajuudesmbagauecgw jrundbw ywmqw daydvqqldavfqi zz epmagaue\\n aww grumg zgl mrkw fw yjko zihvc naqk bfgpl ybkb uu yt mfkw ew yhko zizj c\\n aqyiko zizj daqc dqg aeousz ckd xnfzyg nlne saz qkod gtqd dddti jn\\n lp btnv ktjiktsk wsyyvq lxvnq q tui qjaamak gbyq gsmbaedrw aw\\n raig pqda tekzfpopg ufw fmrsxc nmu queyuz sqcibf lvmu mey yoqbb d\\n xifdeyzk rovbcepv khc uk defin pkcs corrupt `` miibmtcbg ibadbmqsw cqydvqqgew jvuz elmak gauecaw ctk mx ddakbg nvbac m\\n ajuudesmbagauecgw jrundbw ywmqw daydvqqldavfqi zz epmagaue\\n aww grumg zgl mrkw fw yjko zihvc naqk bfgpl ybkb uu yt mfkw ew yhko zizj c\\n aqyiko zizj daqc dqg aeousz ckd xnfzyg nlne saz qkod gtqd dddti jn\\n lp btnv ktjiktsk wsyyvq lxvnq q tui qjaamak gbyq gsmbaedrw aw\\n raig pqda tekzfpopg ufw fmrsxc nmu queyuz sqcibf lvmu mey yoqbb d\\n xifdeyzk rovbcepv khc uk follow valid csr contain po p challeng password collect use estserv dumpbin function csr work po p valu stale defin pkcs stale pop `` miibcj cbaibadarmqw dqydvqqdew zurvnuqwg zw dqyjko zihvc naqebbqad\\ng yamigjao gbapdhvrk vbr fhl ku isr zgixld ryrdsv fsm ww wvx dsx fr\\nzc ktqg juy wnyofnwxozh ce xpht hy hl l n zu mt ktlubjgqxg\\nuuahtwiyur u ekmh qwpvt uyp hzuqmql oqlm emwnih ag mbaagg\\n ij ag bgkqhki gw bcqcx ex yrujd gnzunuwyd vue wt mc aow dqyjko zihvc naqef\\n bqadg yeayenrskmf rixcp kbv lvn wnhc ltw ihcbr swfqaw rru uxdj\\n agbr gv tk tgh inwg cvz gf zh iu gok fti mn nrh zslyhf sfjbu ivr wh\\nvf lrnmqjlfp ayf wxdq dxotzwttr gzgkajr oi b defin enrol url ba `` https known est simpleenrol defin pkcs ct `` content type applic pkcs defin uidpwd good `` estus estpwd defin cacert `` ca est ca cacert crt defin explicit cert `` cert ra pem defin explicit key `` key ra pem evp pkey generat privat key rsa rsa rsa new bignum bn bn new evp pkey pkey creat rsa keypair assign pkey bn set word bn x rsa generat key ex rsa bn null pkey evp pkey new pkey null printf `` \\n error alloc pkey structur new key pair\\n null evp pkey set rsa pkey rsa printf `` \\n error assign rsa key pair pkey structure\\n null rsa free rsa bn free bn pkey callback function pass est client init client manual cert verifi x cur cert openssl cert error bio bio err bio err bio new fp stderr bio noclos approv print specif cert printf `` s open ssl est server cert verif fail follow error openssl cert error d s \\n _ function__ openssl cert error x verifi cert error string openssl cert error printf `` fail cert \\n x print fp stdout cur cert print signatur use fingerprint fingerprint check anticip valu determin server s cert approv x signatur print bio err cur cert sig alg cur cert signatur openssl cert error x v err unabl crl approv bio free bio err approv file outfil size t write func ptr size t size size t nmemb userdata size t written written fwrite ptr size nmemb outfil written clean start server manual enrol nid rv start est server act ca rv st start tcp server port server cert server key `` estrealm cacert trust cert `` est exampl ca cnf manual enrol manual enrol disabl po p nid ecdh nid info sleep rv est err rv start est proxi act ra rv st proxi start tcp proxi port proxi cert proxi key `` estrealm cacert trust cert `` estus `` estpwd `` tcp server port disabl po p nid ecdh nid info sleep rv stop server st stop st proxi stop sleep routin call cunit initi test suit use alloc data open resourc requir test case init suit rv est init logger est log lvl info null read ca certif cacert len read binari file cacert cacert cacert len clean start instanc est server automat enrol enabl rv start server rv routin call cunit uniniti test suit use dealloc data close resourc use test case destroy suit stop server free cacert simpl enrol rsa test use libcurl test simpl enrol bit rsa csr http basic authent use test rv log func nm rv curl http post enrol url ba pkcs ct pkcs rsa uidpwd good cacert curlauth basic null null null pass valid user id password expect server respond cu assert rv simpl enrol ec prime test use libcurl test simpl enrol bit ec csr http basic authent use test rv log func nm rv curl http post enrol url ba pkcs ct pkcs ecdsa uidpwd good cacert curlauth basic null null null pass valid user id password expect server respond cu assert rv simpl enrol dsa prime test use libcurl test simpl enrol bit dsa csr http basic authent use test rv log func nm rv curl http post enrol url ba pkcs ct pkcs dsa uidpwd good cacert curlauth basic null null null pass valid user id password expect server respond cu assert rv simpl enrol corrupt pkcs test use libcurl test simpl enrol usinga corrupt csr http basic authent use test rv log func nm rv curl http post enrol url ba pkcs ct pkcs corrupt uidpwd good cacert curlauth basic null null null csr valid server respond cu assert rv simpl enrol manual enrol test verifi server send appropri retri respons test rv log func nm stop est server stop server restart server manual enrol enabl start server outfil fopen test outfil `` w rv curl http post enrol url ba pkcs ct pkcs rsa uidpwd good cacert curlauth basic null null write func fclose outfil server nt seen csr past respond retri respons cu assert rv verifi retri valu sprintf cmd `` grep retri s grep d test outfil retri interv rv cmd rv grep test outfil `` retri cu assert rv avoid wait retri period simul manual enrol wait second tri enrol cert sleep rv curl http post enrol url ba pkcs ct pkcs rsa uidpwd good cacert curlauth basic null null null enrol request succeed time simul manual enrol automat enrol second attempt cu assert rv stop est server stop server restart server manual enrol disabl start server simpl enrol po p check fail curl test verifi server verifi po p client csr curl doe set po p est enrol fail test rv log func nm st enabl pop send valid enrol request use curl curl doe includ po p rv curl http post enrol url ba pkcs ct pkcs rsa uidpwd good cacert curlauth basic null null null server respond failur code cu assert rv st disabl pop simpl enrol po p check succeed estclient test verifi proxi verifi po p client csr use estclient support po p test rv est ctx c ctx evp pkey new pkey pkcs pkcs len attr data attr len log func nm test requir po p enabl st enabl pop creat client context c ctx est client init cacert cacert len est cert format pem client manual cert verifi cu assert c ctx null c ctx specifi user id password server run basic authent mode rv est client set auth c ctx `` estus `` estpwd null null cu assert rv est err est client set server c ctx `` tcp proxi port null keypair use enrol new pkey generat privat key rv est client csrattr c ctx attr data attr len cu assert rv est err attempt enrol csr rv est client enrol c ctx `` test cn pkcs len new pkey cu assert rv est err client librari obtain new client certif retriev librari pkcs malloc pkcs len pkcs rv est client copi enrol cert c ctx pkcs cu assert rv est err clean est destroy c ctx evp pkey free new pkey free pkcs disabl po p futur test case st disabl pop simpl enrol po p disabl csr contain valid po p test ensur server handl scenario csr includ valid po p server did nt request use cisco est client generat csr contain valid po p s way includ valid po p use curl tls channel bind inform known advanc follow includ use applic use hack est ctx valu mid way test includ `` src est est locl h test est ctx ctx rv cacert caclen evp pkey new pkey pkcs pkcs len attr data attr len log func nm make sure est server po p disabl st disabl pop read ca cert caclen read binari file cacert cacert cu assert cacert len init client context ctx est client init cacert caclen est cert format pem client manual cert verifi ll use simpl http auth identifi rv est client set auth ctx `` estus `` estpwd null null cu assert rv est err est client set server ctx `` tcp proxi port null creat space hold cert generat privat key new pkey generat privat key rv est client csrattr ctx attr data attr len cu assert rv est err attempt enrol ctx csr pop requir hack test attempt need forc challeng password csr rv est client enrol ctx `` test pkcs len new pkey cu assert rv est err pkcs malloc pkcs len rv est client copi enrol cert ctx pkcs free pkcs est destroy ctx simpl enrol po p disabl csr contain invalid po p test ensur server handl scenario csr includ invalid po p server did nt request test rv log func nm make sure est server po p disabl st disabl pop rv curl http post enrol url ba pkcs ct pkcs stale pop uidpwd good cacert curlauth basic null null null enrol request fail po p invalid expect respons cu assert rv main function set run test return cue success success run cunit error code failur add suit ifdef cunit cu p suit p suit null add suit registri p suit cu add suit `` srv simpenrol init suit destroy suit null p suit cu cleanup registri cu error add test suit null cu add test p suit `` enrol rsa cert test null cu add test p suit `` enrol ecdsa cert test null cu add test p suit `` enrol dsa cert test null cu add test p suit `` enrol corrupt ecdsa cert test null cu add test p suit `` enrol retri manual approv `` test null cu add test p suit `` enrol po p fail curl test null cu add test p suit `` enrol po p succeed estclient test null cu add test p suit `` enrol w po p disabl csr includ valid po p test null cu add test p suit `` enrol w po p disabl csr includ invalid po p test cu cleanup registri cu error cue success endif