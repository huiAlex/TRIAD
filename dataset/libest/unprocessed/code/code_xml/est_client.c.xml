<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<unit xmlns="http://www.srcML.org/srcML/src" xmlns:cpp="http://www.srcML.org/srcML/cpp" xmlns:pos="http://www.srcML.org/srcML/position" revision="1.0.0" language="C" filename="source_code/est_client.c" pos:tabs="8"><comment type="block" pos:start="1:1" pos:end="6:3">/*
 * Utility function to set the certificate and private key to use
 * for a SSL context.
 *
 * Returns 0 on success
 */</comment>
<function pos:start="7:1" pos:end="32:1"><type pos:start="7:1" pos:end="7:3"><name pos:start="7:1" pos:end="7:3">int</name></type> <name pos:start="7:5" pos:end="7:31">est_client_set_cert_and_key</name> <parameter_list pos:start="7:33" pos:end="7:73">(<parameter pos:start="7:34" pos:end="7:45"><decl pos:start="7:34" pos:end="7:45"><type pos:start="7:34" pos:end="7:45"><name pos:start="7:34" pos:end="7:40">SSL_CTX</name> <modifier pos:start="7:42" pos:end="7:42">*</modifier></type><name pos:start="7:43" pos:end="7:45">ctx</name></decl></parameter>, <parameter pos:start="7:48" pos:end="7:57"><decl pos:start="7:48" pos:end="7:57"><type pos:start="7:48" pos:end="7:57"><name pos:start="7:48" pos:end="7:51">X509</name> <modifier pos:start="7:53" pos:end="7:53">*</modifier></type><name pos:start="7:54" pos:end="7:57">cert</name></decl></parameter>, <parameter pos:start="7:60" pos:end="7:72"><decl pos:start="7:60" pos:end="7:72"><type pos:start="7:60" pos:end="7:72"><name pos:start="7:60" pos:end="7:67">EVP_PKEY</name> <modifier pos:start="7:69" pos:end="7:69">*</modifier></type><name pos:start="7:70" pos:end="7:72">key</name></decl></parameter>)</parameter_list>
<block pos:start="8:1" pos:end="32:1">{<block_content pos:start="10:5" pos:end="31:13">

    <if_stmt pos:start="10:5" pos:end="14:5"><if pos:start="10:5" pos:end="14:5">if <condition pos:start="10:8" pos:end="10:48">(<expr pos:start="10:9" pos:end="10:47"><call pos:start="10:9" pos:end="10:42"><name pos:start="10:9" pos:end="10:31">SSL_CTX_use_certificate</name><argument_list pos:start="10:32" pos:end="10:42">(<argument pos:start="10:33" pos:end="10:35"><expr pos:start="10:33" pos:end="10:35"><name pos:start="10:33" pos:end="10:35">ctx</name></expr></argument>, <argument pos:start="10:38" pos:end="10:41"><expr pos:start="10:38" pos:end="10:41"><name pos:start="10:38" pos:end="10:41">cert</name></expr></argument>)</argument_list></call> <operator pos:start="10:44" pos:end="10:45">&lt;=</operator> <literal type="number" pos:start="10:47" pos:end="10:47">0</literal></expr>)</condition> <block pos:start="10:50" pos:end="14:5">{<block_content pos:start="11:9" pos:end="13:17">
        <expr_stmt pos:start="11:9" pos:end="11:49"><expr pos:start="11:9" pos:end="11:48"><call pos:start="11:9" pos:end="11:48"><name pos:start="11:9" pos:end="11:19">EST_LOG_ERR</name><argument_list pos:start="11:20" pos:end="11:48">(<argument pos:start="11:21" pos:end="11:47"><expr pos:start="11:21" pos:end="11:47"><literal type="string" pos:start="11:21" pos:end="11:47">"Error setting certificate"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="12:9" pos:end="12:31"><expr pos:start="12:9" pos:end="12:30"><call pos:start="12:9" pos:end="12:30"><name pos:start="12:9" pos:end="12:28">ossl_dump_ssl_errors</name><argument_list pos:start="12:29" pos:end="12:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="13:9" pos:end="13:17">return <expr pos:start="13:16" pos:end="13:16"><literal type="number" pos:start="13:16" pos:end="13:16">1</literal></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="16:5" pos:end="21:5"><if pos:start="16:5" pos:end="21:5">if <condition pos:start="16:8" pos:end="16:46">(<expr pos:start="16:9" pos:end="16:45"><call pos:start="16:9" pos:end="16:40"><name pos:start="16:9" pos:end="16:30">SSL_CTX_use_PrivateKey</name><argument_list pos:start="16:31" pos:end="16:40">(<argument pos:start="16:32" pos:end="16:34"><expr pos:start="16:32" pos:end="16:34"><name pos:start="16:32" pos:end="16:34">ctx</name></expr></argument>, <argument pos:start="16:37" pos:end="16:39"><expr pos:start="16:37" pos:end="16:39"><name pos:start="16:37" pos:end="16:39">key</name></expr></argument>)</argument_list></call> <operator pos:start="16:42" pos:end="16:43">&lt;=</operator> <literal type="number" pos:start="16:45" pos:end="16:45">0</literal></expr>)</condition> <block pos:start="16:48" pos:end="21:5">{<block_content pos:start="18:9" pos:end="20:17">

        <expr_stmt pos:start="18:9" pos:end="18:49"><expr pos:start="18:9" pos:end="18:48"><call pos:start="18:9" pos:end="18:48"><name pos:start="18:9" pos:end="18:19">EST_LOG_ERR</name><argument_list pos:start="18:20" pos:end="18:48">(<argument pos:start="18:21" pos:end="18:47"><expr pos:start="18:21" pos:end="18:47"><literal type="string" pos:start="18:21" pos:end="18:47">"Unable to set private key"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="19:9" pos:end="19:31"><expr pos:start="19:9" pos:end="19:30"><call pos:start="19:9" pos:end="19:30"><name pos:start="19:9" pos:end="19:28">ossl_dump_ssl_errors</name><argument_list pos:start="19:29" pos:end="19:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="20:9" pos:end="20:17">return <expr pos:start="20:16" pos:end="20:16"><literal type="number" pos:start="20:16" pos:end="20:16">1</literal></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="23:5" pos:end="25:7">/*
     * Verify the key matches the cert
     */</comment>
    <if_stmt pos:start="26:5" pos:end="30:5"><if pos:start="26:5" pos:end="30:5">if <condition pos:start="26:8" pos:end="26:40">(<expr pos:start="26:9" pos:end="26:39"><operator pos:start="26:9" pos:end="26:9">!</operator><call pos:start="26:10" pos:end="26:39"><name pos:start="26:10" pos:end="26:34">SSL_CTX_check_private_key</name><argument_list pos:start="26:35" pos:end="26:39">(<argument pos:start="26:36" pos:end="26:38"><expr pos:start="26:36" pos:end="26:38"><name pos:start="26:36" pos:end="26:38">ctx</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="26:42" pos:end="30:5">{<block_content pos:start="27:9" pos:end="29:17">
        <expr_stmt pos:start="27:9" pos:end="27:77"><expr pos:start="27:9" pos:end="27:76"><call pos:start="27:9" pos:end="27:76"><name pos:start="27:9" pos:end="27:19">EST_LOG_ERR</name><argument_list pos:start="27:20" pos:end="27:76">(<argument pos:start="27:21" pos:end="27:75"><expr pos:start="27:21" pos:end="27:75"><literal type="string" pos:start="27:21" pos:end="27:75">"Private key does not match the certificate public key"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="28:9" pos:end="28:31"><expr pos:start="28:9" pos:end="28:30"><call pos:start="28:9" pos:end="28:30"><name pos:start="28:9" pos:end="28:28">ossl_dump_ssl_errors</name><argument_list pos:start="28:29" pos:end="28:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="29:9" pos:end="29:17">return <expr pos:start="29:16" pos:end="29:16"><literal type="number" pos:start="29:16" pos:end="29:16">1</literal></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <return pos:start="31:5" pos:end="31:13">return <expr pos:start="31:12" pos:end="31:12"><literal type="number" pos:start="31:12" pos:end="31:12">0</literal></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="33:1" pos:end="36:3">/*
 * Sign an X509 certificate request using the digest and the key passed.
 * Returns OpenSSL error code from X509_REQ_sign_ctx();
 */</comment>
<function pos:start="37:1" pos:end="63:1"><type pos:start="37:1" pos:end="37:10"><specifier pos:start="37:1" pos:end="37:6">static</specifier> <name pos:start="37:8" pos:end="37:10">int</name></type> <name pos:start="37:12" pos:end="37:35">est_client_X509_REQ_sign</name> <parameter_list pos:start="37:37" pos:end="37:83">(<parameter pos:start="37:38" pos:end="37:48"><decl pos:start="37:38" pos:end="37:48"><type pos:start="37:38" pos:end="37:48"><name pos:start="37:38" pos:end="37:45">X509_REQ</name> <modifier pos:start="37:47" pos:end="37:47">*</modifier></type><name pos:start="37:48" pos:end="37:48">x</name></decl></parameter>, <parameter pos:start="37:51" pos:end="37:64"><decl pos:start="37:51" pos:end="37:64"><type pos:start="37:51" pos:end="37:64"><name pos:start="37:51" pos:end="37:58">EVP_PKEY</name> <modifier pos:start="37:60" pos:end="37:60">*</modifier></type><name pos:start="37:61" pos:end="37:64">pkey</name></decl></parameter>, <parameter pos:start="37:67" pos:end="37:82"><decl pos:start="37:67" pos:end="37:82"><type pos:start="37:67" pos:end="37:82"><specifier pos:start="37:67" pos:end="37:71">const</specifier> <name pos:start="37:73" pos:end="37:78">EVP_MD</name> <modifier pos:start="37:80" pos:end="37:80">*</modifier></type><name pos:start="37:81" pos:end="37:82">md</name></decl></parameter>)</parameter_list>
<block pos:start="38:1" pos:end="63:1">{<block_content pos:start="39:5" pos:end="62:16">
    <decl_stmt pos:start="39:5" pos:end="39:11"><decl pos:start="39:5" pos:end="39:10"><type pos:start="39:5" pos:end="39:7"><name pos:start="39:5" pos:end="39:7">int</name></type> <name pos:start="39:9" pos:end="39:10">rv</name></decl>;</decl_stmt>
    <decl_stmt pos:start="40:5" pos:end="40:31"><decl pos:start="40:5" pos:end="40:30"><type pos:start="40:5" pos:end="40:18"><name pos:start="40:5" pos:end="40:16">EVP_PKEY_CTX</name> <modifier pos:start="40:18" pos:end="40:18">*</modifier></type><name pos:start="40:19" pos:end="40:23">pkctx</name> <init pos:start="40:25" pos:end="40:30">= <expr pos:start="40:27" pos:end="40:30"><name pos:start="40:27" pos:end="40:30">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="41:5" pos:end="41:20"><decl pos:start="41:5" pos:end="41:19"><type pos:start="41:5" pos:end="41:14"><name pos:start="41:5" pos:end="41:14">EVP_MD_CTX</name></type> <name pos:start="41:16" pos:end="41:19">mctx</name></decl>;</decl_stmt>

    <expr_stmt pos:start="43:5" pos:end="43:27"><expr pos:start="43:5" pos:end="43:26"><call pos:start="43:5" pos:end="43:26"><name pos:start="43:5" pos:end="43:19">EVP_MD_CTX_init</name><argument_list pos:start="43:20" pos:end="43:26">(<argument pos:start="43:21" pos:end="43:25"><expr pos:start="43:21" pos:end="43:25"><operator pos:start="43:21" pos:end="43:21">&amp;</operator><name pos:start="43:22" pos:end="43:25">mctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <if_stmt pos:start="45:5" pos:end="47:5"><if pos:start="45:5" pos:end="47:5">if <condition pos:start="45:8" pos:end="45:59">(<expr pos:start="45:9" pos:end="45:58"><operator pos:start="45:9" pos:end="45:9">!</operator><call pos:start="45:10" pos:end="45:58"><name pos:start="45:10" pos:end="45:27">EVP_DigestSignInit</name><argument_list pos:start="45:28" pos:end="45:58">(<argument pos:start="45:29" pos:end="45:33"><expr pos:start="45:29" pos:end="45:33"><operator pos:start="45:29" pos:end="45:29">&amp;</operator><name pos:start="45:30" pos:end="45:33">mctx</name></expr></argument>, <argument pos:start="45:36" pos:end="45:41"><expr pos:start="45:36" pos:end="45:41"><operator pos:start="45:36" pos:end="45:36">&amp;</operator><name pos:start="45:37" pos:end="45:41">pkctx</name></expr></argument>, <argument pos:start="45:44" pos:end="45:45"><expr pos:start="45:44" pos:end="45:45"><name pos:start="45:44" pos:end="45:45">md</name></expr></argument>, <argument pos:start="45:48" pos:end="45:51"><expr pos:start="45:48" pos:end="45:51"><name pos:start="45:48" pos:end="45:51">NULL</name></expr></argument>, <argument pos:start="45:54" pos:end="45:57"><expr pos:start="45:54" pos:end="45:57"><name pos:start="45:54" pos:end="45:57">pkey</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="45:61" pos:end="47:5">{<block_content pos:start="46:9" pos:end="46:17">
        <return pos:start="46:9" pos:end="46:17">return <expr pos:start="46:16" pos:end="46:16"><literal type="number" pos:start="46:16" pos:end="46:16">0</literal></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="49:5" pos:end="56:7">/*
     * Encode using DER (ASN.1) 
     *
     * We have to set the modified flag on the X509_REQ because
     * OpenSSL keeps a cached copy of the DER encoded data in some
     * cases.  Setting this flag tells OpenSSL to run the ASN
     * encoding again rather than using the cached copy.
     */</comment>
    <expr_stmt pos:start="57:5" pos:end="57:34"><expr pos:start="57:5" pos:end="57:33"><name pos:start="57:5" pos:end="57:29"><name pos:start="57:5" pos:end="57:5">x</name><operator pos:start="57:6" pos:end="57:7">-&gt;</operator><name pos:start="57:8" pos:end="57:15">req_info</name><operator pos:start="57:16" pos:end="57:17">-&gt;</operator><name pos:start="57:18" pos:end="57:20">enc</name><operator pos:start="57:21" pos:end="57:21">.</operator><name pos:start="57:22" pos:end="57:29">modified</name></name> <operator pos:start="57:31" pos:end="57:31">=</operator> <literal type="number" pos:start="57:33" pos:end="57:33">1</literal></expr>;</expr_stmt> 
    <expr_stmt pos:start="58:5" pos:end="58:37"><expr pos:start="58:5" pos:end="58:36"><name pos:start="58:5" pos:end="58:6">rv</name> <operator pos:start="58:8" pos:end="58:8">=</operator> <call pos:start="58:10" pos:end="58:36"><name pos:start="58:10" pos:end="58:26">X509_REQ_sign_ctx</name><argument_list pos:start="58:27" pos:end="58:36">(<argument pos:start="58:28" pos:end="58:28"><expr pos:start="58:28" pos:end="58:28"><name pos:start="58:28" pos:end="58:28">x</name></expr></argument>, <argument pos:start="58:31" pos:end="58:35"><expr pos:start="58:31" pos:end="58:35"><operator pos:start="58:31" pos:end="58:31">&amp;</operator><name pos:start="58:32" pos:end="58:35">mctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <expr_stmt pos:start="60:5" pos:end="60:30"><expr pos:start="60:5" pos:end="60:29"><call pos:start="60:5" pos:end="60:29"><name pos:start="60:5" pos:end="60:22">EVP_MD_CTX_cleanup</name><argument_list pos:start="60:23" pos:end="60:29">(<argument pos:start="60:24" pos:end="60:28"><expr pos:start="60:24" pos:end="60:28"><operator pos:start="60:24" pos:end="60:24">&amp;</operator><name pos:start="60:25" pos:end="60:28">mctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <return pos:start="62:5" pos:end="62:16">return <expr pos:start="62:12" pos:end="62:15"><operator pos:start="62:12" pos:end="62:12">(</operator><name pos:start="62:13" pos:end="62:14">rv</name><operator pos:start="62:15" pos:end="62:15">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="64:1" pos:end="76:3">/*
 * populate_x509_request will build an x509 request buffer.  It does this by
 * calls into OpenSSL to insert the fields of the x509 header.
 *
 * Parameters:
 *	req:	pointer to the buffer that is to hold the x509 request header
 *	pkey:   public key to be placed into the x509 request
 *	cn:     Common Name to be placed into the x509 request
 *      cp:     challenge password to be placed into the x509 header
 *
 * Return value:
 *	EST_ERR_NONE if success
 */</comment>
<function pos:start="77:1" pos:end="125:1"><type pos:start="77:1" pos:end="77:16"><specifier pos:start="77:1" pos:end="77:6">static</specifier> <name pos:start="77:8" pos:end="77:16">EST_ERROR</name></type> <name pos:start="77:18" pos:end="77:38">populate_x509_request</name> <parameter_list pos:start="77:40" pos:end="78:59">(<parameter pos:start="77:41" pos:end="77:52"><decl pos:start="77:41" pos:end="77:52"><type pos:start="77:41" pos:end="77:52"><name pos:start="77:41" pos:end="77:47">EST_CTX</name> <modifier pos:start="77:49" pos:end="77:49">*</modifier></type><name pos:start="77:50" pos:end="77:52">ctx</name></decl></parameter>, <parameter pos:start="77:55" pos:end="77:67"><decl pos:start="77:55" pos:end="77:67"><type pos:start="77:55" pos:end="77:67"><name pos:start="77:55" pos:end="77:62">X509_REQ</name> <modifier pos:start="77:64" pos:end="77:64">*</modifier></type><name pos:start="77:65" pos:end="77:67">req</name></decl></parameter>, <parameter pos:start="77:70" pos:end="77:83"><decl pos:start="77:70" pos:end="77:83"><type pos:start="77:70" pos:end="77:83"><name pos:start="77:70" pos:end="77:77">EVP_PKEY</name> <modifier pos:start="77:79" pos:end="77:79">*</modifier></type><name pos:start="77:80" pos:end="77:83">pkey</name></decl></parameter>, 
					<parameter pos:start="78:41" pos:end="78:48"><decl pos:start="78:41" pos:end="78:48"><type pos:start="78:41" pos:end="78:48"><name pos:start="78:41" pos:end="78:44">char</name> <modifier pos:start="78:46" pos:end="78:46">*</modifier></type><name pos:start="78:47" pos:end="78:48">cn</name></decl></parameter>, <parameter pos:start="78:51" pos:end="78:58"><decl pos:start="78:51" pos:end="78:58"><type pos:start="78:51" pos:end="78:58"><name pos:start="78:51" pos:end="78:54">char</name> <modifier pos:start="78:56" pos:end="78:56">*</modifier></type><name pos:start="78:57" pos:end="78:58">cp</name></decl></parameter>)</parameter_list>
<block pos:start="79:1" pos:end="125:1">{<block_content pos:start="80:5" pos:end="124:26">
    <decl_stmt pos:start="80:5" pos:end="80:20"><decl pos:start="80:5" pos:end="80:19"><type pos:start="80:5" pos:end="80:15"><name pos:start="80:5" pos:end="80:13">X509_NAME</name> <modifier pos:start="80:15" pos:end="80:15">*</modifier></type><name pos:start="80:16" pos:end="80:19">subj</name></decl>;</decl_stmt>


    <comment type="block" pos:start="83:5" pos:end="83:30">/* setup version number */</comment>
    <if_stmt pos:start="84:5" pos:end="88:5"><if pos:start="84:5" pos:end="88:5">if <condition pos:start="84:8" pos:end="84:39">(<expr pos:start="84:9" pos:end="84:38"><operator pos:start="84:9" pos:end="84:9">!</operator><call pos:start="84:10" pos:end="84:38"><name pos:start="84:10" pos:end="84:29">X509_REQ_set_version</name><argument_list pos:start="84:30" pos:end="84:38">(<argument pos:start="84:31" pos:end="84:33"><expr pos:start="84:31" pos:end="84:33"><name pos:start="84:31" pos:end="84:33">req</name></expr></argument>, <argument pos:start="84:36" pos:end="84:37"><expr pos:start="84:36" pos:end="84:37"><literal type="number" pos:start="84:36" pos:end="84:37">0L</literal></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="84:41" pos:end="88:5">{<block_content pos:start="85:9" pos:end="87:34">
        <expr_stmt pos:start="85:9" pos:end="85:50"><expr pos:start="85:9" pos:end="85:49"><call pos:start="85:9" pos:end="85:49"><name pos:start="85:9" pos:end="85:19">EST_LOG_ERR</name><argument_list pos:start="85:20" pos:end="85:49">(<argument pos:start="85:21" pos:end="85:48"><expr pos:start="85:21" pos:end="85:48"><literal type="string" pos:start="85:21" pos:end="85:48">"Unable to set X509 version"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt pos:start="86:9" pos:end="86:31"><expr pos:start="86:9" pos:end="86:30"><call pos:start="86:9" pos:end="86:30"><name pos:start="86:9" pos:end="86:28">ossl_dump_ssl_errors</name><argument_list pos:start="86:29" pos:end="86:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="87:9" pos:end="87:34">return <expr pos:start="87:16" pos:end="87:33"><operator pos:start="87:16" pos:end="87:16">(</operator><name pos:start="87:17" pos:end="87:32">EST_ERR_X509_VER</name><operator pos:start="87:33" pos:end="87:33">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="90:5" pos:end="92:7">/*
     * Add Common Name entry
     */</comment>
    <expr_stmt pos:start="93:5" pos:end="93:42"><expr pos:start="93:5" pos:end="93:41"><name pos:start="93:5" pos:end="93:8">subj</name> <operator pos:start="93:10" pos:end="93:10">=</operator> <call pos:start="93:12" pos:end="93:41"><name pos:start="93:12" pos:end="93:36">X509_REQ_get_subject_name</name><argument_list pos:start="93:37" pos:end="93:41">(<argument pos:start="93:38" pos:end="93:40"><expr pos:start="93:38" pos:end="93:40"><name pos:start="93:38" pos:end="93:40">req</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="94:5" pos:end="99:5"><if pos:start="94:5" pos:end="99:5">if <condition pos:start="94:8" pos:end="95:67">(<expr pos:start="94:9" pos:end="95:66"><operator pos:start="94:9" pos:end="94:9">!</operator><call pos:start="94:10" pos:end="95:66"><name pos:start="94:10" pos:end="94:35">X509_NAME_add_entry_by_txt</name><argument_list pos:start="94:36" pos:end="95:66">(<argument pos:start="94:37" pos:end="94:40"><expr pos:start="94:37" pos:end="94:40"><name pos:start="94:37" pos:end="94:40">subj</name></expr></argument>, <argument pos:start="94:43" pos:end="94:46"><expr pos:start="94:43" pos:end="94:46"><literal type="string" pos:start="94:43" pos:end="94:46">"CN"</literal></expr></argument>, <argument pos:start="94:49" pos:end="94:60"><expr pos:start="94:49" pos:end="94:60"><name pos:start="94:49" pos:end="94:60">MBSTRING_ASC</name></expr></argument>,
                                    <argument pos:start="95:37" pos:end="95:54"><expr pos:start="95:37" pos:end="95:54"><operator pos:start="95:37" pos:end="95:37">(</operator><name pos:start="95:38" pos:end="95:45">unsigned</name> <name pos:start="95:47" pos:end="95:50">char</name><operator pos:start="95:51" pos:end="95:51">*</operator><operator pos:start="95:52" pos:end="95:52">)</operator><name pos:start="95:53" pos:end="95:54">cn</name></expr></argument>, <argument pos:start="95:57" pos:end="95:58"><expr pos:start="95:57" pos:end="95:58"><operator pos:start="95:57" pos:end="95:57">-</operator><literal type="number" pos:start="95:58" pos:end="95:58">1</literal></expr></argument>, <argument pos:start="95:61" pos:end="95:62"><expr pos:start="95:61" pos:end="95:62"><operator pos:start="95:61" pos:end="95:61">-</operator><literal type="number" pos:start="95:62" pos:end="95:62">1</literal></expr></argument>, <argument pos:start="95:65" pos:end="95:65"><expr pos:start="95:65" pos:end="95:65"><literal type="number" pos:start="95:65" pos:end="95:65">0</literal></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="95:69" pos:end="99:5">{<block_content pos:start="96:9" pos:end="98:33">
        <expr_stmt pos:start="96:9" pos:end="96:54"><expr pos:start="96:9" pos:end="96:53"><call pos:start="96:9" pos:end="96:53"><name pos:start="96:9" pos:end="96:19">EST_LOG_ERR</name><argument_list pos:start="96:20" pos:end="96:53">(<argument pos:start="96:21" pos:end="96:52"><expr pos:start="96:21" pos:end="96:52"><literal type="string" pos:start="96:21" pos:end="96:52">"Unable to set X509 common name"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt pos:start="97:9" pos:end="97:31"><expr pos:start="97:9" pos:end="97:30"><call pos:start="97:9" pos:end="97:30"><name pos:start="97:9" pos:end="97:28">ossl_dump_ssl_errors</name><argument_list pos:start="97:29" pos:end="97:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="98:9" pos:end="98:33">return <expr pos:start="98:16" pos:end="98:32"><operator pos:start="98:16" pos:end="98:16">(</operator><name pos:start="98:17" pos:end="98:31">EST_ERR_X509_CN</name><operator pos:start="98:32" pos:end="98:32">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="101:5" pos:end="105:7">/*
     * Add challengePassword attribute if required
     * No need to remove/add attributes here, only the PoP is
     * part of the simple enroll flow.
     */</comment>
    <if_stmt pos:start="106:5" pos:end="114:5"><if pos:start="106:5" pos:end="114:5">if <condition pos:start="106:8" pos:end="106:55">(<expr pos:start="106:9" pos:end="106:54"><name pos:start="106:9" pos:end="106:29"><name pos:start="106:9" pos:end="106:11">ctx</name><operator pos:start="106:12" pos:end="106:13">-&gt;</operator><name pos:start="106:14" pos:end="106:29">csr_pop_required</name></name> <operator pos:start="106:31" pos:end="106:32">||</operator> <name pos:start="106:34" pos:end="106:54"><name pos:start="106:34" pos:end="106:36">ctx</name><operator pos:start="106:37" pos:end="106:38">-&gt;</operator><name pos:start="106:39" pos:end="106:54">client_force_pop</name></name></expr>)</condition> <block pos:start="106:57" pos:end="114:5">{<block_content pos:start="107:9" pos:end="113:9">
	<expr_stmt pos:start="107:9" pos:end="107:69"><expr pos:start="107:9" pos:end="107:68"><call pos:start="107:9" pos:end="107:68"><name pos:start="107:9" pos:end="107:20">EST_LOG_INFO</name><argument_list pos:start="107:21" pos:end="107:68">(<argument pos:start="107:22" pos:end="107:67"><expr pos:start="107:22" pos:end="107:67"><literal type="string" pos:start="107:22" pos:end="107:67">"Client will include challengePassword in CSR"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="108:9" pos:end="113:9"><if pos:start="108:9" pos:end="113:9">if <condition pos:start="108:12" pos:end="109:77">(<expr pos:start="108:13" pos:end="109:76"><operator pos:start="108:13" pos:end="108:13">!</operator><call pos:start="108:14" pos:end="109:76"><name pos:start="108:14" pos:end="108:38">X509_REQ_add1_attr_by_NID</name><argument_list pos:start="108:39" pos:end="109:76">(<argument pos:start="108:40" pos:end="108:42"><expr pos:start="108:40" pos:end="108:42"><name pos:start="108:40" pos:end="108:42">req</name></expr></argument>, <argument pos:start="108:45" pos:end="108:71"><expr pos:start="108:45" pos:end="108:71"><name pos:start="108:45" pos:end="108:71">NID_pkcs9_challengePassword</name></expr></argument>,
                                       <argument pos:start="109:40" pos:end="109:51"><expr pos:start="109:40" pos:end="109:51"><name pos:start="109:40" pos:end="109:51">MBSTRING_ASC</name></expr></argument>, <argument pos:start="109:54" pos:end="109:71"><expr pos:start="109:54" pos:end="109:71"><operator pos:start="109:54" pos:end="109:54">(</operator><name pos:start="109:55" pos:end="109:62">unsigned</name> <name pos:start="109:64" pos:end="109:67">char</name><operator pos:start="109:68" pos:end="109:68">*</operator><operator pos:start="109:69" pos:end="109:69">)</operator><name pos:start="109:70" pos:end="109:71">cp</name></expr></argument>, <argument pos:start="109:74" pos:end="109:75"><expr pos:start="109:74" pos:end="109:75"><operator pos:start="109:74" pos:end="109:74">-</operator><literal type="number" pos:start="109:75" pos:end="109:75">1</literal></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="109:79" pos:end="113:9">{<block_content pos:start="110:13" pos:end="112:39">
            <expr_stmt pos:start="110:13" pos:end="110:74"><expr pos:start="110:13" pos:end="110:73"><call pos:start="110:13" pos:end="110:73"><name pos:start="110:13" pos:end="110:23">EST_LOG_ERR</name><argument_list pos:start="110:24" pos:end="110:73">(<argument pos:start="110:25" pos:end="110:72"><expr pos:start="110:25" pos:end="110:72"><literal type="string" pos:start="110:25" pos:end="110:72">"Unable to set X509 challengePassword attribute"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt pos:start="111:13" pos:end="111:35"><expr pos:start="111:13" pos:end="111:34"><call pos:start="111:13" pos:end="111:34"><name pos:start="111:13" pos:end="111:32">ossl_dump_ssl_errors</name><argument_list pos:start="111:33" pos:end="111:34">()</argument_list></call></expr>;</expr_stmt>
            <return pos:start="112:13" pos:end="112:39">return <expr pos:start="112:20" pos:end="112:38"><operator pos:start="112:20" pos:end="112:20">(</operator><name pos:start="112:21" pos:end="112:37">EST_ERR_X509_ATTR</name><operator pos:start="112:38" pos:end="112:38">)</operator></expr>;</return>
        </block_content>}</block></if></if_stmt>
    </block_content>}</block></if></if_stmt>
    <comment type="block" pos:start="115:5" pos:end="117:7">/*
     * Set the public key on the request
     */</comment>
    <if_stmt pos:start="118:5" pos:end="122:5"><if pos:start="118:5" pos:end="122:5">if <condition pos:start="118:8" pos:end="118:40">(<expr pos:start="118:9" pos:end="118:39"><operator pos:start="118:9" pos:end="118:9">!</operator><call pos:start="118:10" pos:end="118:39"><name pos:start="118:10" pos:end="118:28">X509_REQ_set_pubkey</name><argument_list pos:start="118:29" pos:end="118:39">(<argument pos:start="118:30" pos:end="118:32"><expr pos:start="118:30" pos:end="118:32"><name pos:start="118:30" pos:end="118:32">req</name></expr></argument>, <argument pos:start="118:35" pos:end="118:38"><expr pos:start="118:35" pos:end="118:38"><name pos:start="118:35" pos:end="118:38">pkey</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="118:42" pos:end="122:5">{<block_content pos:start="119:9" pos:end="121:37">
        <expr_stmt pos:start="119:9" pos:end="119:48"><expr pos:start="119:9" pos:end="119:47"><call pos:start="119:9" pos:end="119:47"><name pos:start="119:9" pos:end="119:19">EST_LOG_ERR</name><argument_list pos:start="119:20" pos:end="119:47">(<argument pos:start="119:21" pos:end="119:46"><expr pos:start="119:21" pos:end="119:46"><literal type="string" pos:start="119:21" pos:end="119:46">"Unable to set public key"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt pos:start="120:9" pos:end="120:31"><expr pos:start="120:9" pos:end="120:30"><call pos:start="120:9" pos:end="120:30"><name pos:start="120:9" pos:end="120:28">ossl_dump_ssl_errors</name><argument_list pos:start="120:29" pos:end="120:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="121:9" pos:end="121:37">return <expr pos:start="121:16" pos:end="121:36"><operator pos:start="121:16" pos:end="121:16">(</operator><name pos:start="121:17" pos:end="121:35">EST_ERR_X509_PUBKEY</name><operator pos:start="121:36" pos:end="121:36">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <return pos:start="124:5" pos:end="124:26">return <expr pos:start="124:12" pos:end="124:25"><operator pos:start="124:12" pos:end="124:12">(</operator><name pos:start="124:13" pos:end="124:24">EST_ERR_NONE</name><operator pos:start="124:25" pos:end="124:25">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="126:1" pos:end="136:3">/*
 * This function will generate a PKCS10 request.
 *
 * Parameters:
 *	cn:	Common Name to put into the certificate.
 *	cp:     TLS unique ID for the SSL session, becomes the challenge password
 *	pkey:	Private key to use for signing the request.
 *
 * Return value:
 *	EST_ERR_NONE if success
 */</comment>
<function pos:start="137:1" pos:end="171:1"><type pos:start="137:1" pos:end="137:16"><specifier pos:start="137:1" pos:end="137:6">static</specifier> <name pos:start="137:8" pos:end="137:16">EST_ERROR</name></type> <name pos:start="137:18" pos:end="137:36">est_generate_pkcs10</name> <parameter_list pos:start="137:38" pos:end="138:72">(<parameter pos:start="137:39" pos:end="137:50"><decl pos:start="137:39" pos:end="137:50"><type pos:start="137:39" pos:end="137:50"><name pos:start="137:39" pos:end="137:45">EST_CTX</name> <modifier pos:start="137:47" pos:end="137:47">*</modifier></type><name pos:start="137:48" pos:end="137:50">ctx</name></decl></parameter>, <parameter pos:start="137:53" pos:end="137:60"><decl pos:start="137:53" pos:end="137:60"><type pos:start="137:53" pos:end="137:60"><name pos:start="137:53" pos:end="137:56">char</name> <modifier pos:start="137:58" pos:end="137:58">*</modifier></type><name pos:start="137:59" pos:end="137:60">cn</name></decl></parameter>, <parameter pos:start="137:63" pos:end="137:70"><decl pos:start="137:63" pos:end="137:70"><type pos:start="137:63" pos:end="137:70"><name pos:start="137:63" pos:end="137:66">char</name> <modifier pos:start="137:68" pos:end="137:68">*</modifier></type><name pos:start="137:69" pos:end="137:70">cp</name></decl></parameter>, 
	                              <parameter pos:start="138:39" pos:end="138:52"><decl pos:start="138:39" pos:end="138:52"><type pos:start="138:39" pos:end="138:52"><name pos:start="138:39" pos:end="138:46">EVP_PKEY</name> <modifier pos:start="138:48" pos:end="138:48">*</modifier></type><name pos:start="138:49" pos:end="138:52">pkey</name></decl></parameter>, <parameter pos:start="138:55" pos:end="138:71"><decl pos:start="138:55" pos:end="138:71"><type pos:start="138:55" pos:end="138:71"><name pos:start="138:55" pos:end="138:62">X509_REQ</name> <modifier pos:start="138:64" pos:end="138:64">*</modifier><modifier pos:start="138:65" pos:end="138:65">*</modifier></type><name pos:start="138:66" pos:end="138:71">pkcs10</name></decl></parameter>)</parameter_list>
<block pos:start="139:1" pos:end="171:1">{<block_content pos:start="140:5" pos:end="170:26">
    <decl_stmt pos:start="140:5" pos:end="140:25"><decl pos:start="140:5" pos:end="140:24"><type pos:start="140:5" pos:end="140:14"><name pos:start="140:5" pos:end="140:12">X509_REQ</name> <modifier pos:start="140:14" pos:end="140:14">*</modifier></type><name pos:start="140:15" pos:end="140:17">req</name> <init pos:start="140:19" pos:end="140:24">= <expr pos:start="140:21" pos:end="140:24"><name pos:start="140:21" pos:end="140:24">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="141:5" pos:end="141:17"><decl pos:start="141:5" pos:end="141:16"><type pos:start="141:5" pos:end="141:13"><name pos:start="141:5" pos:end="141:13">EST_ERROR</name></type> <name pos:start="141:15" pos:end="141:16">rv</name></decl>;</decl_stmt>
    <decl_stmt pos:start="142:5" pos:end="142:20"><decl pos:start="142:5" pos:end="142:19"><type pos:start="142:5" pos:end="142:7"><name pos:start="142:5" pos:end="142:7">int</name></type> <name pos:start="142:9" pos:end="142:15">ossl_rv</name> <init pos:start="142:17" pos:end="142:19">= <expr pos:start="142:19" pos:end="142:19"><literal type="number" pos:start="142:19" pos:end="142:19">0</literal></expr></init></decl>;</decl_stmt>

    <expr_stmt pos:start="144:5" pos:end="144:25"><expr pos:start="144:5" pos:end="144:24"><name pos:start="144:5" pos:end="144:7">req</name> <operator pos:start="144:9" pos:end="144:9">=</operator> <call pos:start="144:11" pos:end="144:24"><name pos:start="144:11" pos:end="144:22">X509_REQ_new</name><argument_list pos:start="144:23" pos:end="144:24">()</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="145:5" pos:end="149:5"><if pos:start="145:5" pos:end="149:5">if <condition pos:start="145:8" pos:end="145:20">(<expr pos:start="145:9" pos:end="145:19"><name pos:start="145:9" pos:end="145:11">req</name> <operator pos:start="145:13" pos:end="145:14">==</operator> <name pos:start="145:16" pos:end="145:19">NULL</name></expr>)</condition> <block pos:start="145:22" pos:end="149:5">{<block_content pos:start="146:9" pos:end="148:32">
        <expr_stmt pos:start="146:9" pos:end="146:51"><expr pos:start="146:9" pos:end="146:50"><call pos:start="146:9" pos:end="146:50"><name pos:start="146:9" pos:end="146:19">EST_LOG_ERR</name><argument_list pos:start="146:20" pos:end="146:50">(<argument pos:start="146:21" pos:end="146:49"><expr pos:start="146:21" pos:end="146:49"><literal type="string" pos:start="146:21" pos:end="146:49">"Unable to allocate X509_REQ"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="147:9" pos:end="147:31"><expr pos:start="147:9" pos:end="147:30"><call pos:start="147:9" pos:end="147:30"><name pos:start="147:9" pos:end="147:28">ossl_dump_ssl_errors</name><argument_list pos:start="147:29" pos:end="147:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="148:9" pos:end="148:32">return <expr pos:start="148:16" pos:end="148:31"><operator pos:start="148:16" pos:end="148:16">(</operator><name pos:start="148:17" pos:end="148:30">EST_ERR_MALLOC</name><operator pos:start="148:31" pos:end="148:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="151:5" pos:end="151:55"><expr pos:start="151:5" pos:end="151:54"><name pos:start="151:5" pos:end="151:6">rv</name> <operator pos:start="151:8" pos:end="151:8">=</operator> <call pos:start="151:10" pos:end="151:54"><name pos:start="151:10" pos:end="151:30">populate_x509_request</name><argument_list pos:start="151:31" pos:end="151:54">(<argument pos:start="151:32" pos:end="151:34"><expr pos:start="151:32" pos:end="151:34"><name pos:start="151:32" pos:end="151:34">ctx</name></expr></argument>, <argument pos:start="151:37" pos:end="151:39"><expr pos:start="151:37" pos:end="151:39"><name pos:start="151:37" pos:end="151:39">req</name></expr></argument>, <argument pos:start="151:42" pos:end="151:45"><expr pos:start="151:42" pos:end="151:45"><name pos:start="151:42" pos:end="151:45">pkey</name></expr></argument>, <argument pos:start="151:48" pos:end="151:49"><expr pos:start="151:48" pos:end="151:49"><name pos:start="151:48" pos:end="151:49">cn</name></expr></argument>, <argument pos:start="151:52" pos:end="151:53"><expr pos:start="151:52" pos:end="151:53"><name pos:start="151:52" pos:end="151:53">cp</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="152:5" pos:end="155:5"><if pos:start="152:5" pos:end="155:5">if <condition pos:start="152:8" pos:end="152:27">(<expr pos:start="152:9" pos:end="152:26"><name pos:start="152:9" pos:end="152:10">rv</name> <operator pos:start="152:12" pos:end="152:13">!=</operator> <name pos:start="152:15" pos:end="152:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="152:29" pos:end="155:5">{<block_content pos:start="153:9" pos:end="154:20">
        <expr_stmt pos:start="153:9" pos:end="153:27"><expr pos:start="153:9" pos:end="153:26"><call pos:start="153:9" pos:end="153:26"><name pos:start="153:9" pos:end="153:21">X509_REQ_free</name><argument_list pos:start="153:22" pos:end="153:26">(<argument pos:start="153:23" pos:end="153:25"><expr pos:start="153:23" pos:end="153:25"><name pos:start="153:23" pos:end="153:25">req</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="154:9" pos:end="154:20">return <expr pos:start="154:16" pos:end="154:19"><operator pos:start="154:16" pos:end="154:16">(</operator><name pos:start="154:17" pos:end="154:18">rv</name><operator pos:start="154:19" pos:end="154:19">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="157:5" pos:end="159:7">/*
     * Sign the request
     */</comment>
    <expr_stmt pos:start="160:5" pos:end="160:71"><expr pos:start="160:5" pos:end="160:70"><name pos:start="160:5" pos:end="160:11">ossl_rv</name> <operator pos:start="160:13" pos:end="160:13">=</operator> <call pos:start="160:15" pos:end="160:70"><name pos:start="160:15" pos:end="160:38">est_client_X509_REQ_sign</name><argument_list pos:start="160:39" pos:end="160:70">(<argument pos:start="160:40" pos:end="160:42"><expr pos:start="160:40" pos:end="160:42"><name pos:start="160:40" pos:end="160:42">req</name></expr></argument>, <argument pos:start="160:45" pos:end="160:48"><expr pos:start="160:45" pos:end="160:48"><name pos:start="160:45" pos:end="160:48">pkey</name></expr></argument>, <argument pos:start="160:51" pos:end="160:69"><expr pos:start="160:51" pos:end="160:69"><name pos:start="160:51" pos:end="160:69"><name pos:start="160:51" pos:end="160:53">ctx</name><operator pos:start="160:54" pos:end="160:55">-&gt;</operator><name pos:start="160:56" pos:end="160:69">signing_digest</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="161:5" pos:end="166:5"><if pos:start="161:5" pos:end="166:5">if <condition pos:start="161:8" pos:end="161:17">(<expr pos:start="161:9" pos:end="161:16"><operator pos:start="161:9" pos:end="161:9">!</operator><name pos:start="161:10" pos:end="161:16">ossl_rv</name></expr>)</condition> <block pos:start="161:19" pos:end="166:5">{<block_content pos:start="162:9" pos:end="165:35">
        <expr_stmt pos:start="162:9" pos:end="162:56"><expr pos:start="162:9" pos:end="162:55"><call pos:start="162:9" pos:end="162:55"><name pos:start="162:9" pos:end="162:19">EST_LOG_ERR</name><argument_list pos:start="162:20" pos:end="162:55">(<argument pos:start="162:21" pos:end="162:54"><expr pos:start="162:21" pos:end="162:54"><literal type="string" pos:start="162:21" pos:end="162:54">"Unable to sign X509 cert request"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="163:9" pos:end="163:27"><expr pos:start="163:9" pos:end="163:26"><call pos:start="163:9" pos:end="163:26"><name pos:start="163:9" pos:end="163:21">X509_REQ_free</name><argument_list pos:start="163:22" pos:end="163:26">(<argument pos:start="163:23" pos:end="163:25"><expr pos:start="163:23" pos:end="163:25"><name pos:start="163:23" pos:end="163:25">req</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="164:9" pos:end="164:31"><expr pos:start="164:9" pos:end="164:30"><call pos:start="164:9" pos:end="164:30"><name pos:start="164:9" pos:end="164:28">ossl_dump_ssl_errors</name><argument_list pos:start="164:29" pos:end="164:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="165:9" pos:end="165:35">return <expr pos:start="165:16" pos:end="165:34"><operator pos:start="165:16" pos:end="165:16">(</operator><name pos:start="165:17" pos:end="165:33">EST_ERR_X509_SIGN</name><operator pos:start="165:34" pos:end="165:34">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="168:5" pos:end="168:18"><expr pos:start="168:5" pos:end="168:17"><operator pos:start="168:5" pos:end="168:5">*</operator><name pos:start="168:6" pos:end="168:11">pkcs10</name> <operator pos:start="168:13" pos:end="168:13">=</operator> <name pos:start="168:15" pos:end="168:17">req</name></expr>;</expr_stmt>

    <return pos:start="170:5" pos:end="170:26">return <expr pos:start="170:12" pos:end="170:25"><operator pos:start="170:12" pos:end="170:12">(</operator><name pos:start="170:13" pos:end="170:24">EST_ERR_NONE</name><operator pos:start="170:25" pos:end="170:25">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="172:1" pos:end="180:3">/*
 * This function is a callback used by OpenSSL's verify_cert function.
 * It's called at the end of a cert verification to allow an opportunity to
 * gather more information regarding a failing cert verification, and to
 * possibly change the result of the verification.
 *
 * This callback is similar to the ossl routine, but does not alter
 * the verification result.
 */</comment>
<function pos:start="181:1" pos:end="202:1"><type pos:start="181:1" pos:end="181:10"><specifier pos:start="181:1" pos:end="181:6">static</specifier> <name pos:start="181:8" pos:end="181:10">int</name></type> <name pos:start="181:12" pos:end="181:38">est_client_cacert_verify_cb</name> <parameter_list pos:start="181:40" pos:end="181:68">(<parameter pos:start="181:41" pos:end="181:46"><decl pos:start="181:41" pos:end="181:46"><type pos:start="181:41" pos:end="181:46"><name pos:start="181:41" pos:end="181:43">int</name></type> <name pos:start="181:45" pos:end="181:46">ok</name></decl></parameter>, <parameter pos:start="181:49" pos:end="181:67"><decl pos:start="181:49" pos:end="181:67"><type pos:start="181:49" pos:end="181:67"><name pos:start="181:49" pos:end="181:62">X509_STORE_CTX</name> <modifier pos:start="181:64" pos:end="181:64">*</modifier></type><name pos:start="181:65" pos:end="181:67">ctx</name></decl></parameter>)</parameter_list>
<block pos:start="182:1" pos:end="202:1">{<block_content pos:start="183:5" pos:end="201:16">
    <decl_stmt pos:start="183:5" pos:end="183:51"><decl pos:start="183:5" pos:end="183:50"><type pos:start="183:5" pos:end="183:7"><name pos:start="183:5" pos:end="183:7">int</name></type> <name pos:start="183:9" pos:end="183:18">cert_error</name> <init pos:start="183:20" pos:end="183:50">= <expr pos:start="183:22" pos:end="183:50"><call pos:start="183:22" pos:end="183:50"><name pos:start="183:22" pos:end="183:45">X509_STORE_CTX_get_error</name><argument_list pos:start="183:46" pos:end="183:50">(<argument pos:start="183:47" pos:end="183:49"><expr pos:start="183:47" pos:end="183:49"><name pos:start="183:47" pos:end="183:49">ctx</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="184:5" pos:end="184:62"><decl pos:start="184:5" pos:end="184:61"><type pos:start="184:5" pos:end="184:10"><name pos:start="184:5" pos:end="184:8">X509</name> <modifier pos:start="184:10" pos:end="184:10">*</modifier></type><name pos:start="184:11" pos:end="184:22">current_cert</name> <init pos:start="184:24" pos:end="184:61">= <expr pos:start="184:26" pos:end="184:61"><call pos:start="184:26" pos:end="184:61"><name pos:start="184:26" pos:end="184:56">X509_STORE_CTX_get_current_cert</name><argument_list pos:start="184:57" pos:end="184:61">(<argument pos:start="184:58" pos:end="184:60"><expr pos:start="184:58" pos:end="184:60"><name pos:start="184:58" pos:end="184:60">ctx</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

    <expr_stmt pos:start="186:5" pos:end="186:72"><expr pos:start="186:5" pos:end="186:71"><call pos:start="186:5" pos:end="186:71"><name pos:start="186:5" pos:end="186:16">EST_LOG_INFO</name><argument_list pos:start="186:17" pos:end="186:71">(<argument pos:start="186:18" pos:end="186:54"><expr pos:start="186:18" pos:end="186:54"><literal type="string" pos:start="186:18" pos:end="186:54">"enter function: ok=%d cert_error=%d"</literal></expr></argument>, <argument pos:start="186:57" pos:end="186:58"><expr pos:start="186:57" pos:end="186:58"><name pos:start="186:57" pos:end="186:58">ok</name></expr></argument>, <argument pos:start="186:61" pos:end="186:70"><expr pos:start="186:61" pos:end="186:70"><name pos:start="186:61" pos:end="186:70">cert_error</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <if_stmt pos:start="188:5" pos:end="200:5"><if pos:start="188:5" pos:end="200:5">if <condition pos:start="188:8" pos:end="188:12">(<expr pos:start="188:9" pos:end="188:11"><operator pos:start="188:9" pos:end="188:9">!</operator><name pos:start="188:10" pos:end="188:11">ok</name></expr>)</condition> <block pos:start="188:14" pos:end="200:5">{<block_content pos:start="189:9" pos:end="199:64">
        <if_stmt pos:start="189:9" pos:end="194:9"><if pos:start="189:9" pos:end="194:9">if <condition pos:start="189:12" pos:end="189:25">(<expr pos:start="189:13" pos:end="189:24"><name pos:start="189:13" pos:end="189:24">current_cert</name></expr>)</condition> <block pos:start="189:27" pos:end="194:9">{<block_content pos:start="190:13" pos:end="193:25">
            <expr_stmt pos:start="190:13" pos:end="192:54"><expr pos:start="190:13" pos:end="192:53"><call pos:start="190:13" pos:end="192:53"><name pos:start="190:13" pos:end="190:33">X509_NAME_print_ex_fp</name><argument_list pos:start="190:34" pos:end="192:53">(<argument pos:start="190:35" pos:end="190:40"><expr pos:start="190:35" pos:end="190:40"><name pos:start="190:35" pos:end="190:40">stdout</name></expr></argument>,
                                  <argument pos:start="191:35" pos:end="191:69"><expr pos:start="191:35" pos:end="191:69"><call pos:start="191:35" pos:end="191:69"><name pos:start="191:35" pos:end="191:55">X509_get_subject_name</name><argument_list pos:start="191:56" pos:end="191:69">(<argument pos:start="191:57" pos:end="191:68"><expr pos:start="191:57" pos:end="191:68"><name pos:start="191:57" pos:end="191:68">current_cert</name></expr></argument>)</argument_list></call></expr></argument>,
                                  <argument pos:start="192:35" pos:end="192:35"><expr pos:start="192:35" pos:end="192:35"><literal type="number" pos:start="192:35" pos:end="192:35">0</literal></expr></argument>, <argument pos:start="192:38" pos:end="192:52"><expr pos:start="192:38" pos:end="192:52"><name pos:start="192:38" pos:end="192:52">XN_FLAG_ONELINE</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="193:13" pos:end="193:25"><expr pos:start="193:13" pos:end="193:24"><call pos:start="193:13" pos:end="193:24"><name pos:start="193:13" pos:end="193:18">printf</name><argument_list pos:start="193:19" pos:end="193:24">(<argument pos:start="193:20" pos:end="193:23"><expr pos:start="193:20" pos:end="193:23"><literal type="string" pos:start="193:20" pos:end="193:23">"\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></if></if_stmt>
        <expr_stmt pos:start="195:9" pos:end="199:64"><expr pos:start="195:9" pos:end="199:63"><call pos:start="195:9" pos:end="199:63"><name pos:start="195:9" pos:end="195:20">EST_LOG_INFO</name><argument_list pos:start="195:21" pos:end="199:63">(<argument pos:start="195:22" pos:end="195:59"><expr pos:start="195:22" pos:end="195:59"><literal type="string" pos:start="195:22" pos:end="195:59">"%s error %d at %d depth lookup: %s\n"</literal></expr></argument>,
                     <argument pos:start="196:22" pos:end="196:76"><expr pos:start="196:22" pos:end="196:76"><ternary pos:start="196:22" pos:end="196:76"><condition pos:start="196:22" pos:end="196:58"><expr pos:start="196:22" pos:end="196:56"><call pos:start="196:22" pos:end="196:56"><name pos:start="196:22" pos:end="196:51">X509_STORE_CTX_get0_parent_ctx</name><argument_list pos:start="196:52" pos:end="196:56">(<argument pos:start="196:53" pos:end="196:55"><expr pos:start="196:53" pos:end="196:55"><name pos:start="196:53" pos:end="196:55">ctx</name></expr></argument>)</argument_list></call></expr> ?</condition><then pos:start="196:60" pos:end="196:71"> <expr pos:start="196:60" pos:end="196:71"><literal type="string" pos:start="196:60" pos:end="196:71">"[CRL path]"</literal></expr> </then><else pos:start="196:73" pos:end="196:76">: <expr pos:start="196:75" pos:end="196:76"><literal type="string" pos:start="196:75" pos:end="196:76">""</literal></expr></else></ternary></expr></argument>,
                     <argument pos:start="197:22" pos:end="197:31"><expr pos:start="197:22" pos:end="197:31"><name pos:start="197:22" pos:end="197:31">cert_error</name></expr></argument>,
                     <argument pos:start="198:22" pos:end="198:56"><expr pos:start="198:22" pos:end="198:56"><call pos:start="198:22" pos:end="198:56"><name pos:start="198:22" pos:end="198:51">X509_STORE_CTX_get_error_depth</name><argument_list pos:start="198:52" pos:end="198:56">(<argument pos:start="198:53" pos:end="198:55"><expr pos:start="198:53" pos:end="198:55"><name pos:start="198:53" pos:end="198:55">ctx</name></expr></argument>)</argument_list></call></expr></argument>,
                     <argument pos:start="199:22" pos:end="199:62"><expr pos:start="199:22" pos:end="199:62"><call pos:start="199:22" pos:end="199:62"><name pos:start="199:22" pos:end="199:50">X509_verify_cert_error_string</name><argument_list pos:start="199:51" pos:end="199:62">(<argument pos:start="199:52" pos:end="199:61"><expr pos:start="199:52" pos:end="199:61"><name pos:start="199:52" pos:end="199:61">cert_error</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    <return pos:start="201:5" pos:end="201:16">return <expr pos:start="201:12" pos:end="201:15"><operator pos:start="201:12" pos:end="201:12">(</operator><name pos:start="201:13" pos:end="201:14">ok</name><operator pos:start="201:15" pos:end="201:15">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="203:1" pos:end="215:3">/*
 * This function will remove CRLs from a received cacert response buffer.
 *
 * Parameters:
 *	ctx:	EST Context representing this session
 *  cacerts:    pointer to the buffer holding the resulting CA certs 
 *  cacerts_len: length of the cacerts buffer
 *       p7:    pointer to the pkcs7 buffer that was received
 *
 * Return value:
 *	EST_ERR_NONE if success
 
 */</comment>
<function pos:start="216:1" pos:end="310:1"><type pos:start="216:1" pos:end="216:16"><specifier pos:start="216:1" pos:end="216:6">static</specifier> <name pos:start="216:8" pos:end="216:16">EST_ERROR</name></type> <name pos:start="216:18" pos:end="216:39">est_client_remove_crls</name> <parameter_list pos:start="216:41" pos:end="217:69">(<parameter pos:start="216:42" pos:end="216:53"><decl pos:start="216:42" pos:end="216:53"><type pos:start="216:42" pos:end="216:53"><name pos:start="216:42" pos:end="216:48">EST_CTX</name> <modifier pos:start="216:50" pos:end="216:50">*</modifier></type><name pos:start="216:51" pos:end="216:53">ctx</name></decl></parameter>, <parameter pos:start="216:56" pos:end="216:77"><decl pos:start="216:56" pos:end="216:77"><type pos:start="216:56" pos:end="216:77"><name pos:start="216:56" pos:end="216:63">unsigned</name> <name pos:start="216:65" pos:end="216:68">char</name> <modifier pos:start="216:70" pos:end="216:70">*</modifier></type><name pos:start="216:71" pos:end="216:77">cacerts</name></decl></parameter>,
                                         <parameter pos:start="217:42" pos:end="217:57"><decl pos:start="217:42" pos:end="217:57"><type pos:start="217:42" pos:end="217:57"><name pos:start="217:42" pos:end="217:44">int</name> <modifier pos:start="217:46" pos:end="217:46">*</modifier></type><name pos:start="217:47" pos:end="217:57">cacerts_len</name></decl></parameter>, <parameter pos:start="217:60" pos:end="217:68"><decl pos:start="217:60" pos:end="217:68"><type pos:start="217:60" pos:end="217:68"><name pos:start="217:60" pos:end="217:64">PKCS7</name> <modifier pos:start="217:66" pos:end="217:66">*</modifier></type><name pos:start="217:67" pos:end="217:68">p7</name></decl></parameter>)</parameter_list>
<block pos:start="218:1" pos:end="310:1">{<block_content pos:start="219:5" pos:end="309:24">
    <decl_stmt pos:start="219:5" pos:end="219:16"><decl pos:start="219:5" pos:end="219:15"><type pos:start="219:5" pos:end="219:7"><name pos:start="219:5" pos:end="219:7">int</name></type> <name pos:start="219:9" pos:end="219:11">nid</name> <init pos:start="219:13" pos:end="219:15">= <expr pos:start="219:15" pos:end="219:15"><literal type="number" pos:start="219:15" pos:end="219:15">0</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="220:5" pos:end="220:23"><decl pos:start="220:5" pos:end="220:22"><type pos:start="220:5" pos:end="220:7"><name pos:start="220:5" pos:end="220:7">int</name></type> <name pos:start="220:9" pos:end="220:18">crls_found</name> <init pos:start="220:20" pos:end="220:22">= <expr pos:start="220:22" pos:end="220:22"><literal type="number" pos:start="220:22" pos:end="220:22">0</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="221:5" pos:end="221:24"><decl pos:start="221:5" pos:end="221:23"><type pos:start="221:5" pos:end="221:9"><name pos:start="221:5" pos:end="221:7">BIO</name> <modifier pos:start="221:9" pos:end="221:9">*</modifier></type><name pos:start="221:10" pos:end="221:16">b64_enc</name> <init pos:start="221:18" pos:end="221:23">= <expr pos:start="221:20" pos:end="221:23"><name pos:start="221:20" pos:end="221:23">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="222:5" pos:end="222:26"><decl pos:start="222:5" pos:end="222:25"><type pos:start="222:5" pos:end="222:9"><name pos:start="222:5" pos:end="222:7">BIO</name> <modifier pos:start="222:9" pos:end="222:9">*</modifier></type><name pos:start="222:10" pos:end="222:18">p7bio_out</name> <init pos:start="222:20" pos:end="222:25">= <expr pos:start="222:22" pos:end="222:25"><name pos:start="222:22" pos:end="222:25">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="223:5" pos:end="223:28"><decl pos:start="223:5" pos:end="223:27"><type pos:start="223:5" pos:end="223:7"><name pos:start="223:5" pos:end="223:7">int</name></type> <name pos:start="223:9" pos:end="223:23">new_cacerts_len</name> <init pos:start="223:25" pos:end="223:27">= <expr pos:start="223:27" pos:end="223:27"><literal type="number" pos:start="223:27" pos:end="223:27">0</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="224:5" pos:end="224:33"><decl pos:start="224:5" pos:end="224:32"><type pos:start="224:5" pos:end="224:10"><name pos:start="224:5" pos:end="224:8">char</name> <modifier pos:start="224:10" pos:end="224:10">*</modifier></type><name pos:start="224:11" pos:end="224:25">new_cacerts_buf</name> <init pos:start="224:27" pos:end="224:32">= <expr pos:start="224:29" pos:end="224:32"><name pos:start="224:29" pos:end="224:32">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="225:5" pos:end="225:18"><decl pos:start="225:5" pos:end="225:17"><type pos:start="225:5" pos:end="225:7"><name pos:start="225:5" pos:end="225:7">int</name></type> <name pos:start="225:9" pos:end="225:13">count</name> <init pos:start="225:15" pos:end="225:17">= <expr pos:start="225:17" pos:end="225:17"><literal type="number" pos:start="225:17" pos:end="225:17">0</literal></expr></init></decl>;</decl_stmt>    
    
    <expr_stmt pos:start="227:5" pos:end="227:30"><expr pos:start="227:5" pos:end="227:29"><name pos:start="227:5" pos:end="227:7">nid</name><operator pos:start="227:8" pos:end="227:8">=</operator><call pos:start="227:9" pos:end="227:29"><name pos:start="227:9" pos:end="227:19">OBJ_obj2nid</name><argument_list pos:start="227:20" pos:end="227:29">(<argument pos:start="227:21" pos:end="227:28"><expr pos:start="227:21" pos:end="227:28"><name pos:start="227:21" pos:end="227:28"><name pos:start="227:21" pos:end="227:22">p7</name><operator pos:start="227:23" pos:end="227:24">-&gt;</operator><name pos:start="227:25" pos:end="227:28">type</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <switch pos:start="228:5" pos:end="248:9">switch <condition pos:start="228:12" pos:end="228:16">(<expr pos:start="228:13" pos:end="228:15"><name pos:start="228:13" pos:end="228:15">nid</name></expr>)</condition>
        <block pos:start="229:9" pos:end="248:9">{<block_content pos:start="230:9" pos:end="247:18">
        <case pos:start="230:9" pos:end="230:30">case <expr pos:start="230:14" pos:end="230:29"><name pos:start="230:14" pos:end="230:29">NID_pkcs7_signed</name></expr>:</case>
            <if_stmt pos:start="231:13" pos:end="235:13"><if pos:start="231:13" pos:end="235:13">if <condition pos:start="231:16" pos:end="231:32">(<expr pos:start="231:17" pos:end="231:31"><name pos:start="231:17" pos:end="231:31"><name pos:start="231:17" pos:end="231:18">p7</name><operator pos:start="231:19" pos:end="231:20">-&gt;</operator><name pos:start="231:21" pos:end="231:21">d</name><operator pos:start="231:22" pos:end="231:22">.</operator><name pos:start="231:23" pos:end="231:26">sign</name><operator pos:start="231:27" pos:end="231:28">-&gt;</operator><name pos:start="231:29" pos:end="231:31">crl</name></name></expr>)</condition> <block pos:start="231:34" pos:end="235:13">{<block_content pos:start="232:17" pos:end="234:31">
                <expr_stmt pos:start="232:17" pos:end="232:69"><expr pos:start="232:17" pos:end="232:68"><call pos:start="232:17" pos:end="232:68"><name pos:start="232:17" pos:end="232:36">sk_X509_CRL_pop_free</name><argument_list pos:start="232:37" pos:end="232:68">(<argument pos:start="232:38" pos:end="232:52"><expr pos:start="232:38" pos:end="232:52"><name pos:start="232:38" pos:end="232:52"><name pos:start="232:38" pos:end="232:39">p7</name><operator pos:start="232:40" pos:end="232:41">-&gt;</operator><name pos:start="232:42" pos:end="232:42">d</name><operator pos:start="232:43" pos:end="232:43">.</operator><name pos:start="232:44" pos:end="232:47">sign</name><operator pos:start="232:48" pos:end="232:49">-&gt;</operator><name pos:start="232:50" pos:end="232:52">crl</name></name></expr></argument>, <argument pos:start="232:55" pos:end="232:67"><expr pos:start="232:55" pos:end="232:67"><name pos:start="232:55" pos:end="232:67">X509_CRL_free</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt pos:start="233:17" pos:end="233:39"><expr pos:start="233:17" pos:end="233:38"><name pos:start="233:17" pos:end="233:31"><name pos:start="233:17" pos:end="233:18">p7</name><operator pos:start="233:19" pos:end="233:20">-&gt;</operator><name pos:start="233:21" pos:end="233:21">d</name><operator pos:start="233:22" pos:end="233:22">.</operator><name pos:start="233:23" pos:end="233:26">sign</name><operator pos:start="233:27" pos:end="233:28">-&gt;</operator><name pos:start="233:29" pos:end="233:31">crl</name></name> <operator pos:start="233:33" pos:end="233:33">=</operator> <name pos:start="233:35" pos:end="233:38">NULL</name></expr>;</expr_stmt>
                <expr_stmt pos:start="234:17" pos:end="234:31"><expr pos:start="234:17" pos:end="234:30"><name pos:start="234:17" pos:end="234:26">crls_found</name> <operator pos:start="234:28" pos:end="234:28">=</operator> <literal type="number" pos:start="234:30" pos:end="234:30">1</literal></expr>;</expr_stmt>
            </block_content>}</block></if></if_stmt>
            <break pos:start="236:13" pos:end="236:18">break;</break>
        <case pos:start="237:9" pos:end="237:42">case <expr pos:start="237:14" pos:end="237:41"><name pos:start="237:14" pos:end="237:41">NID_pkcs7_signedAndEnveloped</name></expr>:</case>
            <if_stmt pos:start="238:13" pos:end="242:13"><if pos:start="238:13" pos:end="242:13">if <condition pos:start="238:16" pos:end="238:48">(<expr pos:start="238:17" pos:end="238:47"><name pos:start="238:17" pos:end="238:47"><name pos:start="238:17" pos:end="238:18">p7</name><operator pos:start="238:19" pos:end="238:20">-&gt;</operator><name pos:start="238:21" pos:end="238:21">d</name><operator pos:start="238:22" pos:end="238:22">.</operator><name pos:start="238:23" pos:end="238:42">signed_and_enveloped</name><operator pos:start="238:43" pos:end="238:44">-&gt;</operator><name pos:start="238:45" pos:end="238:47">crl</name></name></expr>)</condition> <block pos:start="238:50" pos:end="242:13">{<block_content pos:start="239:17" pos:end="241:31">
                <expr_stmt pos:start="239:17" pos:end="239:85"><expr pos:start="239:17" pos:end="239:84"><call pos:start="239:17" pos:end="239:84"><name pos:start="239:17" pos:end="239:36">sk_X509_CRL_pop_free</name><argument_list pos:start="239:37" pos:end="239:84">(<argument pos:start="239:38" pos:end="239:68"><expr pos:start="239:38" pos:end="239:68"><name pos:start="239:38" pos:end="239:68"><name pos:start="239:38" pos:end="239:39">p7</name><operator pos:start="239:40" pos:end="239:41">-&gt;</operator><name pos:start="239:42" pos:end="239:42">d</name><operator pos:start="239:43" pos:end="239:43">.</operator><name pos:start="239:44" pos:end="239:63">signed_and_enveloped</name><operator pos:start="239:64" pos:end="239:65">-&gt;</operator><name pos:start="239:66" pos:end="239:68">crl</name></name></expr></argument>, <argument pos:start="239:71" pos:end="239:83"><expr pos:start="239:71" pos:end="239:83"><name pos:start="239:71" pos:end="239:83">X509_CRL_free</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt pos:start="240:17" pos:end="240:39"><expr pos:start="240:17" pos:end="240:38"><name pos:start="240:17" pos:end="240:31"><name pos:start="240:17" pos:end="240:18">p7</name><operator pos:start="240:19" pos:end="240:20">-&gt;</operator><name pos:start="240:21" pos:end="240:21">d</name><operator pos:start="240:22" pos:end="240:22">.</operator><name pos:start="240:23" pos:end="240:26">sign</name><operator pos:start="240:27" pos:end="240:28">-&gt;</operator><name pos:start="240:29" pos:end="240:31">crl</name></name> <operator pos:start="240:33" pos:end="240:33">=</operator> <name pos:start="240:35" pos:end="240:38">NULL</name></expr>;</expr_stmt>
                <expr_stmt pos:start="241:17" pos:end="241:31"><expr pos:start="241:17" pos:end="241:30"><name pos:start="241:17" pos:end="241:26">crls_found</name> <operator pos:start="241:28" pos:end="241:28">=</operator> <literal type="number" pos:start="241:30" pos:end="241:30">1</literal></expr>;</expr_stmt>
            </block_content>}</block></if></if_stmt>
            <break pos:start="243:13" pos:end="243:18">break;</break>
        <default pos:start="244:9" pos:end="244:16">default:</default>
            <expr_stmt pos:start="245:13" pos:end="245:64"><expr pos:start="245:13" pos:end="245:63"><call pos:start="245:13" pos:end="245:63"><name pos:start="245:13" pos:end="245:23">EST_LOG_ERR</name><argument_list pos:start="245:24" pos:end="245:63">(<argument pos:start="245:25" pos:end="245:62"><expr pos:start="245:25" pos:end="245:62"><literal type="string" pos:start="245:25" pos:end="245:62">"Invalid NID value on PKCS7 structure"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return pos:start="246:13" pos:end="246:49">return <expr pos:start="246:20" pos:end="246:48"><operator pos:start="246:20" pos:end="246:20">(</operator><name pos:start="246:21" pos:end="246:47">EST_ERR_CACERT_VERIFICATION</name><operator pos:start="246:48" pos:end="246:48">)</operator></expr>;</return>            
            <break pos:start="247:13" pos:end="247:18">break;</break>
        </block_content>}</block></switch>

    <comment type="block" pos:start="250:5" pos:end="259:7">/*
     * If CRLs were removed, then the original PKCS7 buffer needs to be
     * updated.  This will always be base64 encoded.
     * - Allocate the BIOs,
     * - Write the PKCS7 struct back into PEM format,
     * - Get the pointer and length to the new base64 PEM encoded buffer,
     * - and then copy it into the original buffer that was passed in.
     * Since the CRLs are being removed, the new buffer will always be shorter
     * and will fit into the original buffer.
     */</comment>
    <if_stmt pos:start="260:5" pos:end="305:5"><if pos:start="260:5" pos:end="305:5">if <condition pos:start="260:8" pos:end="260:19">(<expr pos:start="260:9" pos:end="260:18"><name pos:start="260:9" pos:end="260:18">crls_found</name></expr>)</condition> <block pos:start="260:21" pos:end="305:5">{<block_content pos:start="262:9" pos:end="304:39">

        <expr_stmt pos:start="262:9" pos:end="262:83"><expr pos:start="262:9" pos:end="262:82"><call pos:start="262:9" pos:end="262:82"><name pos:start="262:9" pos:end="262:20">EST_LOG_INFO</name><argument_list pos:start="262:21" pos:end="262:82">(<argument pos:start="262:22" pos:end="262:81"><expr pos:start="262:22" pos:end="262:81"><literal type="string" pos:start="262:22" pos:end="262:81">"CRL(s) attached with the CA Certificates.  Removing CRL(s)"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        
        <expr_stmt pos:start="264:9" pos:end="264:42"><expr pos:start="264:9" pos:end="264:41"><name pos:start="264:9" pos:end="264:15">b64_enc</name> <operator pos:start="264:17" pos:end="264:17">=</operator> <call pos:start="264:19" pos:end="264:41"><name pos:start="264:19" pos:end="264:25">BIO_new</name><argument_list pos:start="264:26" pos:end="264:41">(<argument pos:start="264:27" pos:end="264:40"><expr pos:start="264:27" pos:end="264:40"><call pos:start="264:27" pos:end="264:40"><name pos:start="264:27" pos:end="264:38">BIO_f_base64</name><argument_list pos:start="264:39" pos:end="264:40">()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="265:9" pos:end="269:9"><if pos:start="265:9" pos:end="269:9">if <condition pos:start="265:12" pos:end="265:28">(<expr pos:start="265:13" pos:end="265:27"><name pos:start="265:13" pos:end="265:19">b64_enc</name> <operator pos:start="265:21" pos:end="265:22">==</operator> <name pos:start="265:24" pos:end="265:27">NULL</name></expr>)</condition> <block pos:start="265:30" pos:end="269:9">{<block_content pos:start="266:13" pos:end="268:35">
            <expr_stmt pos:start="266:13" pos:end="266:42"><expr pos:start="266:13" pos:end="266:41"><call pos:start="266:13" pos:end="266:41"><name pos:start="266:13" pos:end="266:23">EST_LOG_ERR</name><argument_list pos:start="266:24" pos:end="266:41">(<argument pos:start="266:25" pos:end="266:40"><expr pos:start="266:25" pos:end="266:40"><literal type="string" pos:start="266:25" pos:end="266:40">"BIO_new failed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="267:13" pos:end="267:35"><expr pos:start="267:13" pos:end="267:34"><call pos:start="267:13" pos:end="267:34"><name pos:start="267:13" pos:end="267:32">ossl_dump_ssl_errors</name><argument_list pos:start="267:33" pos:end="267:34">()</argument_list></call></expr>;</expr_stmt>
            <return pos:start="268:13" pos:end="268:35">return<expr pos:start="268:19" pos:end="268:34"><operator pos:start="268:19" pos:end="268:19">(</operator><name pos:start="268:20" pos:end="268:33">EST_ERR_MALLOC</name><operator pos:start="268:34" pos:end="268:34">)</operator></expr>;</return>
        </block_content>}</block></if></if_stmt>
        <expr_stmt pos:start="270:9" pos:end="270:41"><expr pos:start="270:9" pos:end="270:40"><name pos:start="270:9" pos:end="270:17">p7bio_out</name> <operator pos:start="270:19" pos:end="270:19">=</operator> <call pos:start="270:21" pos:end="270:40"><name pos:start="270:21" pos:end="270:27">BIO_new</name><argument_list pos:start="270:28" pos:end="270:40">(<argument pos:start="270:29" pos:end="270:39"><expr pos:start="270:29" pos:end="270:39"><call pos:start="270:29" pos:end="270:39"><name pos:start="270:29" pos:end="270:37">BIO_s_mem</name><argument_list pos:start="270:38" pos:end="270:39">()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="271:9" pos:end="275:9"><if pos:start="271:9" pos:end="275:9">if <condition pos:start="271:12" pos:end="271:30">(<expr pos:start="271:13" pos:end="271:29"><name pos:start="271:13" pos:end="271:21">p7bio_out</name> <operator pos:start="271:23" pos:end="271:24">==</operator> <name pos:start="271:26" pos:end="271:29">NULL</name></expr>)</condition> <block pos:start="271:32" pos:end="275:9">{<block_content pos:start="272:13" pos:end="274:35">
            <expr_stmt pos:start="272:13" pos:end="272:63"><expr pos:start="272:13" pos:end="272:62"><call pos:start="272:13" pos:end="272:62"><name pos:start="272:13" pos:end="272:23">EST_LOG_ERR</name><argument_list pos:start="272:24" pos:end="272:62">(<argument pos:start="272:25" pos:end="272:61"><expr pos:start="272:25" pos:end="272:61"><literal type="string" pos:start="272:25" pos:end="272:61">"Unable to access the CA cert buffer"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="273:13" pos:end="273:35"><expr pos:start="273:13" pos:end="273:34"><call pos:start="273:13" pos:end="273:34"><name pos:start="273:13" pos:end="273:32">ossl_dump_ssl_errors</name><argument_list pos:start="273:33" pos:end="273:34">()</argument_list></call></expr>;</expr_stmt>
            <return pos:start="274:13" pos:end="274:35">return<expr pos:start="274:19" pos:end="274:34"><operator pos:start="274:19" pos:end="274:19">(</operator><name pos:start="274:20" pos:end="274:33">EST_ERR_MALLOC</name><operator pos:start="274:34" pos:end="274:34">)</operator></expr>;</return>
        </block_content>}</block></if></if_stmt>
        <expr_stmt pos:start="276:9" pos:end="276:49"><expr pos:start="276:9" pos:end="276:48"><name pos:start="276:9" pos:end="276:17">p7bio_out</name> <operator pos:start="276:19" pos:end="276:19">=</operator> <call pos:start="276:21" pos:end="276:48"><name pos:start="276:21" pos:end="276:28">BIO_push</name><argument_list pos:start="276:29" pos:end="276:48">(<argument pos:start="276:30" pos:end="276:36"><expr pos:start="276:30" pos:end="276:36"><name pos:start="276:30" pos:end="276:36">b64_enc</name></expr></argument>, <argument pos:start="276:39" pos:end="276:47"><expr pos:start="276:39" pos:end="276:47"><name pos:start="276:39" pos:end="276:47">p7bio_out</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        
        <expr_stmt pos:start="278:9" pos:end="278:41"><expr pos:start="278:9" pos:end="278:40"><call pos:start="278:9" pos:end="278:40"><name pos:start="278:9" pos:end="278:17">memzero_s</name><argument_list pos:start="278:18" pos:end="278:40">(<argument pos:start="278:19" pos:end="278:25"><expr pos:start="278:19" pos:end="278:25"><name pos:start="278:19" pos:end="278:25">cacerts</name></expr></argument>, <argument pos:start="278:28" pos:end="278:39"><expr pos:start="278:28" pos:end="278:39"><operator pos:start="278:28" pos:end="278:28">*</operator><name pos:start="278:29" pos:end="278:39">cacerts_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        
        <expr_stmt pos:start="280:9" pos:end="280:45"><expr pos:start="280:9" pos:end="280:44"><name pos:start="280:9" pos:end="280:13">count</name> <operator pos:start="280:15" pos:end="280:15">=</operator> <call pos:start="280:17" pos:end="280:44"><name pos:start="280:17" pos:end="280:29">i2d_PKCS7_bio</name><argument_list pos:start="280:30" pos:end="280:44">(<argument pos:start="280:31" pos:end="280:39"><expr pos:start="280:31" pos:end="280:39"><name pos:start="280:31" pos:end="280:39">p7bio_out</name></expr></argument>, <argument pos:start="280:42" pos:end="280:43"><expr pos:start="280:42" pos:end="280:43"><name pos:start="280:42" pos:end="280:43">p7</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="281:9" pos:end="286:9"><if pos:start="281:9" pos:end="286:9">if <condition pos:start="281:12" pos:end="281:23">(<expr pos:start="281:13" pos:end="281:22"><name pos:start="281:13" pos:end="281:17">count</name> <operator pos:start="281:19" pos:end="281:20">==</operator> <literal type="number" pos:start="281:22" pos:end="281:22">0</literal></expr>)</condition> <block pos:start="281:25" pos:end="286:9">{<block_content pos:start="282:13" pos:end="285:49">
            <expr_stmt pos:start="282:13" pos:end="282:54"><expr pos:start="282:13" pos:end="282:53"><call pos:start="282:13" pos:end="282:53"><name pos:start="282:13" pos:end="282:23">EST_LOG_ERR</name><argument_list pos:start="282:24" pos:end="282:53">(<argument pos:start="282:25" pos:end="282:52"><expr pos:start="282:25" pos:end="282:52"><literal type="string" pos:start="282:25" pos:end="282:52">"PEM_write_bio_PKCS7 failed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="283:13" pos:end="283:35"><expr pos:start="283:13" pos:end="283:34"><call pos:start="283:13" pos:end="283:34"><name pos:start="283:13" pos:end="283:32">ossl_dump_ssl_errors</name><argument_list pos:start="283:33" pos:end="283:34">()</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="284:13" pos:end="284:36"><expr pos:start="284:13" pos:end="284:35"><call pos:start="284:13" pos:end="284:35"><name pos:start="284:13" pos:end="284:24">BIO_free_all</name><argument_list pos:start="284:25" pos:end="284:35">(<argument pos:start="284:26" pos:end="284:34"><expr pos:start="284:26" pos:end="284:34"><name pos:start="284:26" pos:end="284:34">p7bio_out</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>            
            <return pos:start="285:13" pos:end="285:49">return <expr pos:start="285:20" pos:end="285:48"><operator pos:start="285:20" pos:end="285:20">(</operator><name pos:start="285:21" pos:end="285:47">EST_ERR_CACERT_VERIFICATION</name><operator pos:start="285:48" pos:end="285:48">)</operator></expr>;</return>
        </block_content>}</block></if></if_stmt>
        <expr_stmt pos:start="287:9" pos:end="287:35"><expr pos:start="287:9" pos:end="287:34"><operator pos:start="287:9" pos:end="287:9">(</operator><name pos:start="287:10" pos:end="287:13">void</name><operator pos:start="287:14" pos:end="287:14">)</operator><call pos:start="287:15" pos:end="287:34"><name pos:start="287:15" pos:end="287:23">BIO_flush</name><argument_list pos:start="287:24" pos:end="287:34">(<argument pos:start="287:25" pos:end="287:33"><expr pos:start="287:25" pos:end="287:33"><name pos:start="287:25" pos:end="287:33">p7bio_out</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

        <comment type="block" pos:start="289:9" pos:end="292:11">/*
         * BIO_get_mem_data just returns the pointer and length to the data
         * contained in the mem BIO.  Nothing is allocated and passed back
         */</comment>
        <expr_stmt pos:start="293:9" pos:end="293:86"><expr pos:start="293:9" pos:end="293:85"><name pos:start="293:9" pos:end="293:23">new_cacerts_len</name> <operator pos:start="293:25" pos:end="293:25">=</operator> <operator pos:start="293:27" pos:end="293:27">(</operator><name pos:start="293:28" pos:end="293:30">int</name><operator pos:start="293:31" pos:end="293:31">)</operator> <call pos:start="293:33" pos:end="293:85"><name pos:start="293:33" pos:end="293:48">BIO_get_mem_data</name><argument_list pos:start="293:49" pos:end="293:85">(<argument pos:start="293:50" pos:end="293:58"><expr pos:start="293:50" pos:end="293:58"><name pos:start="293:50" pos:end="293:58">p7bio_out</name></expr></argument>, <argument pos:start="293:61" pos:end="293:84"><expr pos:start="293:61" pos:end="293:84"><operator pos:start="293:61" pos:end="293:61">(</operator><name pos:start="293:62" pos:end="293:65">char</name><operator pos:start="293:66" pos:end="293:66">*</operator><operator pos:start="293:67" pos:end="293:67">*</operator><operator pos:start="293:68" pos:end="293:68">)</operator><operator pos:start="293:69" pos:end="293:69">&amp;</operator><name pos:start="293:70" pos:end="293:84">new_cacerts_buf</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="294:9" pos:end="299:9"><if pos:start="294:9" pos:end="299:9">if <condition pos:start="294:12" pos:end="294:33">(<expr pos:start="294:13" pos:end="294:32"><name pos:start="294:13" pos:end="294:27">new_cacerts_len</name> <operator pos:start="294:29" pos:end="294:30">&lt;=</operator> <literal type="number" pos:start="294:32" pos:end="294:32">0</literal></expr>)</condition> <block pos:start="294:35" pos:end="299:9">{<block_content pos:start="295:13" pos:end="298:49">
            <expr_stmt pos:start="295:13" pos:end="295:53"><expr pos:start="295:13" pos:end="295:52"><call pos:start="295:13" pos:end="295:52"><name pos:start="295:13" pos:end="295:23">EST_LOG_ERR</name><argument_list pos:start="295:24" pos:end="295:52">(<argument pos:start="295:25" pos:end="295:51"><expr pos:start="295:25" pos:end="295:51"><literal type="string" pos:start="295:25" pos:end="295:51">"Failed to copy PKCS7 data"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="296:13" pos:end="296:35"><expr pos:start="296:13" pos:end="296:34"><call pos:start="296:13" pos:end="296:34"><name pos:start="296:13" pos:end="296:32">ossl_dump_ssl_errors</name><argument_list pos:start="296:33" pos:end="296:34">()</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="297:13" pos:end="297:36"><expr pos:start="297:13" pos:end="297:35"><call pos:start="297:13" pos:end="297:35"><name pos:start="297:13" pos:end="297:24">BIO_free_all</name><argument_list pos:start="297:25" pos:end="297:35">(<argument pos:start="297:26" pos:end="297:34"><expr pos:start="297:26" pos:end="297:34"><name pos:start="297:26" pos:end="297:34">p7bio_out</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>            
            <return pos:start="298:13" pos:end="298:49">return <expr pos:start="298:20" pos:end="298:48"><operator pos:start="298:20" pos:end="298:20">(</operator><name pos:start="298:21" pos:end="298:47">EST_ERR_CACERT_VERIFICATION</name><operator pos:start="298:48" pos:end="298:48">)</operator></expr>;</return>
        </block_content>}</block></if></if_stmt>
        <comment type="block" pos:start="300:9" pos:end="302:11">/*
         * copy the new buffer back into the old buffer
         */</comment>
        <expr_stmt pos:start="303:9" pos:end="303:74"><expr pos:start="303:9" pos:end="303:73"><call pos:start="303:9" pos:end="303:73"><name pos:start="303:9" pos:end="303:16">memcpy_s</name><argument_list pos:start="303:17" pos:end="303:73">(<argument pos:start="303:18" pos:end="303:24"><expr pos:start="303:18" pos:end="303:24"><name pos:start="303:18" pos:end="303:24">cacerts</name></expr></argument>, <argument pos:start="303:27" pos:end="303:38"><expr pos:start="303:27" pos:end="303:38"><operator pos:start="303:27" pos:end="303:27">*</operator><name pos:start="303:28" pos:end="303:38">cacerts_len</name></expr></argument>, <argument pos:start="303:41" pos:end="303:55"><expr pos:start="303:41" pos:end="303:55"><name pos:start="303:41" pos:end="303:55">new_cacerts_buf</name></expr></argument>, <argument pos:start="303:58" pos:end="303:72"><expr pos:start="303:58" pos:end="303:72"><name pos:start="303:58" pos:end="303:72">new_cacerts_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="304:9" pos:end="304:39"><expr pos:start="304:9" pos:end="304:38"><operator pos:start="304:9" pos:end="304:9">*</operator><name pos:start="304:10" pos:end="304:20">cacerts_len</name> <operator pos:start="304:22" pos:end="304:22">=</operator> <name pos:start="304:24" pos:end="304:38">new_cacerts_len</name></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="307:5" pos:end="307:28"><expr pos:start="307:5" pos:end="307:27"><call pos:start="307:5" pos:end="307:27"><name pos:start="307:5" pos:end="307:16">BIO_free_all</name><argument_list pos:start="307:17" pos:end="307:27">(<argument pos:start="307:18" pos:end="307:26"><expr pos:start="307:18" pos:end="307:26"><name pos:start="307:18" pos:end="307:26">p7bio_out</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <return pos:start="309:5" pos:end="309:24">return <expr pos:start="309:12" pos:end="309:23"><name pos:start="309:12" pos:end="309:23">EST_ERR_NONE</name></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="311:1" pos:end="315:3">/*
 * This function will decode the passed base64 encoded buffer and return the
 * decoded cacerts. If returning EST_ERR_NONE, caller is responsible for
 * freeing the cacerts_decoded buffer
 */</comment>
<function pos:start="316:1" pos:end="360:1"><type pos:start="316:1" pos:end="316:16"><specifier pos:start="316:1" pos:end="316:6">static</specifier> <name pos:start="316:8" pos:end="316:16">EST_ERROR</name></type> <name pos:start="316:18" pos:end="316:35">b64_decode_cacerts</name> <parameter_list pos:start="316:37" pos:end="318:62">(<parameter pos:start="316:38" pos:end="316:59"><decl pos:start="316:38" pos:end="316:59"><type pos:start="316:38" pos:end="316:59"><name pos:start="316:38" pos:end="316:45">unsigned</name> <name pos:start="316:47" pos:end="316:50">char</name> <modifier pos:start="316:52" pos:end="316:52">*</modifier></type><name pos:start="316:53" pos:end="316:59">cacerts</name></decl></parameter>, <parameter pos:start="316:62" pos:end="316:77"><decl pos:start="316:62" pos:end="316:77"><type pos:start="316:62" pos:end="316:77"><name pos:start="316:62" pos:end="316:64">int</name> <modifier pos:start="316:66" pos:end="316:66">*</modifier></type><name pos:start="316:67" pos:end="316:77">cacerts_len</name></decl></parameter>,
                                     <parameter pos:start="317:38" pos:end="317:68"><decl pos:start="317:38" pos:end="317:68"><type pos:start="317:38" pos:end="317:68"><name pos:start="317:38" pos:end="317:45">unsigned</name> <name pos:start="317:47" pos:end="317:50">char</name> <modifier pos:start="317:52" pos:end="317:52">*</modifier><modifier pos:start="317:53" pos:end="317:53">*</modifier></type><name pos:start="317:54" pos:end="317:68">cacerts_decoded</name></decl></parameter>,
                                     <parameter pos:start="318:38" pos:end="318:61"><decl pos:start="318:38" pos:end="318:61"><type pos:start="318:38" pos:end="318:61"><name pos:start="318:38" pos:end="318:40">int</name> <modifier pos:start="318:42" pos:end="318:42">*</modifier></type><name pos:start="318:43" pos:end="318:61">cacerts_decoded_len</name></decl></parameter>)</parameter_list>
<block pos:start="319:1" pos:end="360:1">{<block_content pos:start="320:5" pos:end="359:26">
    <decl_stmt pos:start="320:5" pos:end="320:19"><decl pos:start="320:5" pos:end="320:18"><type pos:start="320:5" pos:end="320:9"><name pos:start="320:5" pos:end="320:7">BIO</name> <modifier pos:start="320:9" pos:end="320:9">*</modifier></type><name pos:start="320:10" pos:end="320:11">in</name> <init pos:start="320:13" pos:end="320:18">= <expr pos:start="320:15" pos:end="320:18"><name pos:start="320:15" pos:end="320:18">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="321:5" pos:end="321:20"><decl pos:start="321:5" pos:end="321:19"><type pos:start="321:5" pos:end="321:9"><name pos:start="321:5" pos:end="321:7">BIO</name> <modifier pos:start="321:9" pos:end="321:9">*</modifier></type><name pos:start="321:10" pos:end="321:12">b64</name> <init pos:start="321:14" pos:end="321:19">= <expr pos:start="321:16" pos:end="321:19"><name pos:start="321:16" pos:end="321:19">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="322:5" pos:end="322:31"><decl pos:start="322:5" pos:end="322:30"><type pos:start="322:5" pos:end="322:19"><name pos:start="322:5" pos:end="322:12">unsigned</name> <name pos:start="322:14" pos:end="322:17">char</name> <modifier pos:start="322:19" pos:end="322:19">*</modifier></type><name pos:start="322:20" pos:end="322:30">decoded_buf</name></decl>;</decl_stmt>
    <decl_stmt pos:start="323:5" pos:end="323:24"><decl pos:start="323:5" pos:end="323:23"><type pos:start="323:5" pos:end="323:7"><name pos:start="323:5" pos:end="323:7">int</name></type> <name pos:start="323:9" pos:end="323:23">decoded_buf_len</name></decl>;</decl_stmt>

    <expr_stmt pos:start="325:5" pos:end="325:28"><expr pos:start="325:5" pos:end="325:27"><operator pos:start="325:5" pos:end="325:5">*</operator><name pos:start="325:6" pos:end="325:20">cacerts_decoded</name> <operator pos:start="325:22" pos:end="325:22">=</operator> <name pos:start="325:24" pos:end="325:27">NULL</name></expr>;</expr_stmt>
    <expr_stmt pos:start="326:5" pos:end="326:29"><expr pos:start="326:5" pos:end="326:28"><operator pos:start="326:5" pos:end="326:5">*</operator><name pos:start="326:6" pos:end="326:24">cacerts_decoded_len</name> <operator pos:start="326:26" pos:end="326:26">=</operator> <literal type="number" pos:start="326:28" pos:end="326:28">0</literal></expr>;</expr_stmt>
    
    <expr_stmt pos:start="328:5" pos:end="328:34"><expr pos:start="328:5" pos:end="328:33"><name pos:start="328:5" pos:end="328:7">b64</name> <operator pos:start="328:9" pos:end="328:9">=</operator> <call pos:start="328:11" pos:end="328:33"><name pos:start="328:11" pos:end="328:17">BIO_new</name><argument_list pos:start="328:18" pos:end="328:33">(<argument pos:start="328:19" pos:end="328:32"><expr pos:start="328:19" pos:end="328:32"><call pos:start="328:19" pos:end="328:32"><name pos:start="328:19" pos:end="328:30">BIO_f_base64</name><argument_list pos:start="328:31" pos:end="328:32">()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="329:5" pos:end="333:5"><if pos:start="329:5" pos:end="333:5">if <condition pos:start="329:8" pos:end="329:20">(<expr pos:start="329:9" pos:end="329:19"><name pos:start="329:9" pos:end="329:11">b64</name> <operator pos:start="329:13" pos:end="329:14">==</operator> <name pos:start="329:16" pos:end="329:19">NULL</name></expr>)</condition> <block pos:start="329:22" pos:end="333:5">{<block_content pos:start="330:9" pos:end="332:32">
        <expr_stmt pos:start="330:9" pos:end="330:38"><expr pos:start="330:9" pos:end="330:37"><call pos:start="330:9" pos:end="330:37"><name pos:start="330:9" pos:end="330:19">EST_LOG_ERR</name><argument_list pos:start="330:20" pos:end="330:37">(<argument pos:start="330:21" pos:end="330:36"><expr pos:start="330:21" pos:end="330:36"><literal type="string" pos:start="330:21" pos:end="330:36">"BIO_new failed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="331:9" pos:end="331:31"><expr pos:start="331:9" pos:end="331:30"><call pos:start="331:9" pos:end="331:30"><name pos:start="331:9" pos:end="331:28">ossl_dump_ssl_errors</name><argument_list pos:start="331:29" pos:end="331:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="332:9" pos:end="332:32">return <expr pos:start="332:16" pos:end="332:31"><operator pos:start="332:16" pos:end="332:16">(</operator><name pos:start="332:17" pos:end="332:30">EST_ERR_MALLOC</name><operator pos:start="332:31" pos:end="332:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>    
    <comment type="block" pos:start="334:5" pos:end="336:7">/*
     * Decoding will always take up less than the original buffer.
     */</comment>
    <expr_stmt pos:start="337:5" pos:end="337:48"><expr pos:start="337:5" pos:end="337:47"><name pos:start="337:5" pos:end="337:6">in</name> <operator pos:start="337:8" pos:end="337:8">=</operator> <call pos:start="337:10" pos:end="337:47"><name pos:start="337:10" pos:end="337:24">BIO_new_mem_buf</name><argument_list pos:start="337:25" pos:end="337:47">(<argument pos:start="337:26" pos:end="337:32"><expr pos:start="337:26" pos:end="337:32"><name pos:start="337:26" pos:end="337:32">cacerts</name></expr></argument>, <argument pos:start="337:35" pos:end="337:46"><expr pos:start="337:35" pos:end="337:46"><operator pos:start="337:35" pos:end="337:35">*</operator><name pos:start="337:36" pos:end="337:46">cacerts_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>    
    <if_stmt pos:start="338:5" pos:end="343:5"><if pos:start="338:5" pos:end="343:5">if <condition pos:start="338:8" pos:end="338:19">(<expr pos:start="338:9" pos:end="338:18"><name pos:start="338:9" pos:end="338:10">in</name> <operator pos:start="338:12" pos:end="338:13">==</operator> <name pos:start="338:15" pos:end="338:18">NULL</name></expr>)</condition> <block pos:start="338:21" pos:end="343:5">{<block_content pos:start="339:9" pos:end="342:32">
        <expr_stmt pos:start="339:9" pos:end="339:59"><expr pos:start="339:9" pos:end="339:58"><call pos:start="339:9" pos:end="339:58"><name pos:start="339:9" pos:end="339:19">EST_LOG_ERR</name><argument_list pos:start="339:20" pos:end="339:58">(<argument pos:start="339:21" pos:end="339:57"><expr pos:start="339:21" pos:end="339:57"><literal type="string" pos:start="339:21" pos:end="339:57">"Unable to access the CA cert buffer"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="340:9" pos:end="340:31"><expr pos:start="340:9" pos:end="340:30"><call pos:start="340:9" pos:end="340:30"><name pos:start="340:9" pos:end="340:28">ossl_dump_ssl_errors</name><argument_list pos:start="340:29" pos:end="340:30">()</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="341:9" pos:end="341:26"><expr pos:start="341:9" pos:end="341:25"><call pos:start="341:9" pos:end="341:25"><name pos:start="341:9" pos:end="341:20">BIO_free_all</name><argument_list pos:start="341:21" pos:end="341:25">(<argument pos:start="341:22" pos:end="341:24"><expr pos:start="341:22" pos:end="341:24"><name pos:start="341:22" pos:end="341:24">b64</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="342:9" pos:end="342:32">return <expr pos:start="342:16" pos:end="342:31"><operator pos:start="342:16" pos:end="342:16">(</operator><name pos:start="342:17" pos:end="342:30">EST_ERR_MALLOC</name><operator pos:start="342:31" pos:end="342:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="344:5" pos:end="344:27"><expr pos:start="344:5" pos:end="344:26"><name pos:start="344:5" pos:end="344:6">in</name> <operator pos:start="344:8" pos:end="344:8">=</operator> <call pos:start="344:10" pos:end="344:26"><name pos:start="344:10" pos:end="344:17">BIO_push</name><argument_list pos:start="344:18" pos:end="344:26">(<argument pos:start="344:19" pos:end="344:21"><expr pos:start="344:19" pos:end="344:21"><name pos:start="344:19" pos:end="344:21">b64</name></expr></argument>, <argument pos:start="344:24" pos:end="344:25"><expr pos:start="344:24" pos:end="344:25"><name pos:start="344:24" pos:end="344:25">in</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>    
    <expr_stmt pos:start="345:5" pos:end="345:39"><expr pos:start="345:5" pos:end="345:38"><name pos:start="345:5" pos:end="345:15">decoded_buf</name> <operator pos:start="345:17" pos:end="345:17">=</operator> <call pos:start="345:19" pos:end="345:38"><name pos:start="345:19" pos:end="345:24">malloc</name><argument_list pos:start="345:25" pos:end="345:38">(<argument pos:start="345:26" pos:end="345:37"><expr pos:start="345:26" pos:end="345:37"><operator pos:start="345:26" pos:end="345:26">*</operator><name pos:start="345:27" pos:end="345:37">cacerts_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="346:5" pos:end="350:5"><if pos:start="346:5" pos:end="350:5">if <condition pos:start="346:8" pos:end="346:28">(<expr pos:start="346:9" pos:end="346:27"><name pos:start="346:9" pos:end="346:19">decoded_buf</name> <operator pos:start="346:21" pos:end="346:22">==</operator> <name pos:start="346:24" pos:end="346:27">NULL</name></expr>)</condition> <block pos:start="346:30" pos:end="350:5">{<block_content pos:start="347:9" pos:end="349:32">
        <expr_stmt pos:start="347:9" pos:end="347:68"><expr pos:start="347:9" pos:end="347:67"><call pos:start="347:9" pos:end="347:67"><name pos:start="347:9" pos:end="347:19">EST_LOG_ERR</name><argument_list pos:start="347:20" pos:end="347:67">(<argument pos:start="347:21" pos:end="347:66"><expr pos:start="347:21" pos:end="347:66"><literal type="string" pos:start="347:21" pos:end="347:66">"Unable to allocate CA cert buffer for decode"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="348:9" pos:end="348:25"><expr pos:start="348:9" pos:end="348:24"><call pos:start="348:9" pos:end="348:24"><name pos:start="348:9" pos:end="348:20">BIO_free_all</name><argument_list pos:start="348:21" pos:end="348:24">(<argument pos:start="348:22" pos:end="348:23"><expr pos:start="348:22" pos:end="348:23"><name pos:start="348:22" pos:end="348:23">in</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>        
        <return pos:start="349:9" pos:end="349:32">return <expr pos:start="349:16" pos:end="349:31"><operator pos:start="349:16" pos:end="349:16">(</operator><name pos:start="349:17" pos:end="349:30">EST_ERR_MALLOC</name><operator pos:start="349:31" pos:end="349:31">)</operator></expr>;</return>        
    </block_content>}</block></if></if_stmt>
    
    <expr_stmt pos:start="352:5" pos:end="352:62"><expr pos:start="352:5" pos:end="352:61"><name pos:start="352:5" pos:end="352:19">decoded_buf_len</name> <operator pos:start="352:21" pos:end="352:21">=</operator> <call pos:start="352:23" pos:end="352:61"><name pos:start="352:23" pos:end="352:30">BIO_read</name><argument_list pos:start="352:31" pos:end="352:61">(<argument pos:start="352:32" pos:end="352:33"><expr pos:start="352:32" pos:end="352:33"><name pos:start="352:32" pos:end="352:33">in</name></expr></argument>, <argument pos:start="352:36" pos:end="352:46"><expr pos:start="352:36" pos:end="352:46"><name pos:start="352:36" pos:end="352:46">decoded_buf</name></expr></argument>, <argument pos:start="352:49" pos:end="352:60"><expr pos:start="352:49" pos:end="352:60"><operator pos:start="352:49" pos:end="352:49">*</operator><name pos:start="352:50" pos:end="352:60">cacerts_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    
    <expr_stmt pos:start="354:5" pos:end="354:35"><expr pos:start="354:5" pos:end="354:34"><operator pos:start="354:5" pos:end="354:5">*</operator><name pos:start="354:6" pos:end="354:20">cacerts_decoded</name> <operator pos:start="354:22" pos:end="354:22">=</operator> <name pos:start="354:24" pos:end="354:34">decoded_buf</name></expr>;</expr_stmt>
    <expr_stmt pos:start="355:5" pos:end="355:43"><expr pos:start="355:5" pos:end="355:42"><operator pos:start="355:5" pos:end="355:5">*</operator><name pos:start="355:6" pos:end="355:24">cacerts_decoded_len</name> <operator pos:start="355:26" pos:end="355:26">=</operator> <name pos:start="355:28" pos:end="355:42">decoded_buf_len</name></expr>;</expr_stmt>

    <expr_stmt pos:start="357:5" pos:end="357:21"><expr pos:start="357:5" pos:end="357:20"><call pos:start="357:5" pos:end="357:20"><name pos:start="357:5" pos:end="357:16">BIO_free_all</name><argument_list pos:start="357:17" pos:end="357:20">(<argument pos:start="357:18" pos:end="357:19"><expr pos:start="357:18" pos:end="357:19"><name pos:start="357:18" pos:end="357:19">in</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    
    <return pos:start="359:5" pos:end="359:26">return <expr pos:start="359:12" pos:end="359:25"><operator pos:start="359:12" pos:end="359:12">(</operator><name pos:start="359:13" pos:end="359:24">EST_ERR_NONE</name><operator pos:start="359:25" pos:end="359:25">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="361:1" pos:end="363:3">/*
 * If returning EST_ERR_NONE, caller is responsible for freeing the PKCS7 struct
 */</comment>
<function pos:start="364:1" pos:end="393:1"><type pos:start="364:1" pos:end="364:16"><specifier pos:start="364:1" pos:end="364:6">static</specifier> <name pos:start="364:8" pos:end="364:16">EST_ERROR</name></type> <name pos:start="364:18" pos:end="364:29">create_PKCS7</name> <parameter_list pos:start="364:31" pos:end="365:48">(<parameter pos:start="364:32" pos:end="364:61"><decl pos:start="364:32" pos:end="364:61"><type pos:start="364:32" pos:end="364:61"><name pos:start="364:32" pos:end="364:39">unsigned</name> <name pos:start="364:41" pos:end="364:44">char</name> <modifier pos:start="364:46" pos:end="364:46">*</modifier></type><name pos:start="364:47" pos:end="364:61">cacerts_decoded</name></decl></parameter>, <parameter pos:start="364:64" pos:end="364:86"><decl pos:start="364:64" pos:end="364:86"><type pos:start="364:64" pos:end="364:86"><name pos:start="364:64" pos:end="364:66">int</name></type> <name pos:start="364:68" pos:end="364:86">cacerts_decoded_len</name></decl></parameter>,
                               <parameter pos:start="365:32" pos:end="365:47"><decl pos:start="365:32" pos:end="365:47"><type pos:start="365:32" pos:end="365:47"><name pos:start="365:32" pos:end="365:36">PKCS7</name> <modifier pos:start="365:38" pos:end="365:38">*</modifier><modifier pos:start="365:39" pos:end="365:39">*</modifier></type><name pos:start="365:40" pos:end="365:47">pkcs7out</name></decl></parameter>)</parameter_list>
<block pos:start="366:1" pos:end="393:1">{<block_content pos:start="367:5" pos:end="392:24">
    <decl_stmt pos:start="367:5" pos:end="367:25"><decl pos:start="367:5" pos:end="367:24"><type pos:start="367:5" pos:end="367:9"><name pos:start="367:5" pos:end="367:7">BIO</name> <modifier pos:start="367:9" pos:end="367:9">*</modifier></type><name pos:start="367:10" pos:end="367:17">p7bio_in</name> <init pos:start="367:19" pos:end="367:24">= <expr pos:start="367:21" pos:end="367:24"><name pos:start="367:21" pos:end="367:24">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="368:5" pos:end="368:24"><decl pos:start="368:5" pos:end="368:23"><type pos:start="368:5" pos:end="368:11"><name pos:start="368:5" pos:end="368:9">PKCS7</name> <modifier pos:start="368:11" pos:end="368:11">*</modifier></type><name pos:start="368:12" pos:end="368:16">pkcs7</name> <init pos:start="368:18" pos:end="368:23">= <expr pos:start="368:20" pos:end="368:23"><name pos:start="368:20" pos:end="368:23">NULL</name></expr></init></decl>;</decl_stmt>

    <comment type="block" pos:start="370:5" pos:end="373:7">/*
     * Now get the PKCS7 formatted buffer of certificates read into a stack of
     * X509 certs
     */</comment>
    <expr_stmt pos:start="374:5" pos:end="374:69"><expr pos:start="374:5" pos:end="374:68"><name pos:start="374:5" pos:end="374:12">p7bio_in</name> <operator pos:start="374:14" pos:end="374:14">=</operator> <call pos:start="374:16" pos:end="374:68"><name pos:start="374:16" pos:end="374:30">BIO_new_mem_buf</name><argument_list pos:start="374:31" pos:end="374:68">(<argument pos:start="374:32" pos:end="374:46"><expr pos:start="374:32" pos:end="374:46"><name pos:start="374:32" pos:end="374:46">cacerts_decoded</name></expr></argument>, <argument pos:start="374:49" pos:end="374:67"><expr pos:start="374:49" pos:end="374:67"><name pos:start="374:49" pos:end="374:67">cacerts_decoded_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="375:5" pos:end="379:5"><if pos:start="375:5" pos:end="379:5">if <condition pos:start="375:8" pos:end="375:25">(<expr pos:start="375:9" pos:end="375:24"><name pos:start="375:9" pos:end="375:16">p7bio_in</name> <operator pos:start="375:18" pos:end="375:19">==</operator> <name pos:start="375:21" pos:end="375:24">NULL</name></expr>)</condition> <block pos:start="375:27" pos:end="379:5">{<block_content pos:start="376:9" pos:end="378:32">
        <expr_stmt pos:start="376:9" pos:end="376:57"><expr pos:start="376:9" pos:end="376:56"><call pos:start="376:9" pos:end="376:56"><name pos:start="376:9" pos:end="376:19">EST_LOG_ERR</name><argument_list pos:start="376:20" pos:end="376:56">(<argument pos:start="376:21" pos:end="376:55"><expr pos:start="376:21" pos:end="376:55"><literal type="string" pos:start="376:21" pos:end="376:55">"Unable to access the PKCS7 buffer"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="377:9" pos:end="377:31"><expr pos:start="377:9" pos:end="377:30"><call pos:start="377:9" pos:end="377:30"><name pos:start="377:9" pos:end="377:28">ossl_dump_ssl_errors</name><argument_list pos:start="377:29" pos:end="377:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="378:9" pos:end="378:32">return <expr pos:start="378:16" pos:end="378:31"><operator pos:start="378:16" pos:end="378:16">(</operator><name pos:start="378:17" pos:end="378:30">EST_ERR_MALLOC</name><operator pos:start="378:31" pos:end="378:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
        
    <expr_stmt pos:start="381:5" pos:end="381:41"><expr pos:start="381:5" pos:end="381:40"><name pos:start="381:5" pos:end="381:9">pkcs7</name> <operator pos:start="381:11" pos:end="381:11">=</operator> <call pos:start="381:13" pos:end="381:40"><name pos:start="381:13" pos:end="381:25">d2i_PKCS7_bio</name><argument_list pos:start="381:26" pos:end="381:40">(<argument pos:start="381:27" pos:end="381:34"><expr pos:start="381:27" pos:end="381:34"><name pos:start="381:27" pos:end="381:34">p7bio_in</name></expr></argument>,<argument pos:start="381:36" pos:end="381:39"><expr pos:start="381:36" pos:end="381:39"><name pos:start="381:36" pos:end="381:39">NULL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <if_stmt pos:start="383:5" pos:end="388:5"><if pos:start="383:5" pos:end="388:5">if <condition pos:start="383:8" pos:end="383:22">(<expr pos:start="383:9" pos:end="383:21"><name pos:start="383:9" pos:end="383:13">pkcs7</name> <operator pos:start="383:15" pos:end="383:16">==</operator> <name pos:start="383:18" pos:end="383:21">NULL</name></expr>)</condition> <block pos:start="383:24" pos:end="388:5">{<block_content pos:start="384:9" pos:end="387:38">
        <expr_stmt pos:start="384:9" pos:end="384:72"><expr pos:start="384:9" pos:end="384:71"><call pos:start="384:9" pos:end="384:71"><name pos:start="384:9" pos:end="384:19">EST_LOG_ERR</name><argument_list pos:start="384:20" pos:end="384:71">(<argument pos:start="384:21" pos:end="384:70"><expr pos:start="384:21" pos:end="384:70"><literal type="string" pos:start="384:21" pos:end="384:70">"Unable to read in PKCS7 based certificate buffer"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="385:9" pos:end="385:31"><expr pos:start="385:9" pos:end="385:30"><call pos:start="385:9" pos:end="385:30"><name pos:start="385:9" pos:end="385:28">ossl_dump_ssl_errors</name><argument_list pos:start="385:29" pos:end="385:30">()</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="386:9" pos:end="386:31"><expr pos:start="386:9" pos:end="386:30"><call pos:start="386:9" pos:end="386:30"><name pos:start="386:9" pos:end="386:20">BIO_free_all</name><argument_list pos:start="386:21" pos:end="386:30">(<argument pos:start="386:22" pos:end="386:29"><expr pos:start="386:22" pos:end="386:29"><name pos:start="386:22" pos:end="386:29">p7bio_in</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>   
        <return pos:start="387:9" pos:end="387:38">return <expr pos:start="387:16" pos:end="387:37"><operator pos:start="387:16" pos:end="387:16">(</operator><name pos:start="387:17" pos:end="387:36">EST_ERR_LOAD_CACERTS</name><operator pos:start="387:37" pos:end="387:37">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="390:5" pos:end="390:27"><expr pos:start="390:5" pos:end="390:26"><call pos:start="390:5" pos:end="390:26"><name pos:start="390:5" pos:end="390:16">BIO_free_all</name><argument_list pos:start="390:17" pos:end="390:26">(<argument pos:start="390:18" pos:end="390:25"><expr pos:start="390:18" pos:end="390:25"><name pos:start="390:18" pos:end="390:25">p7bio_in</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="391:5" pos:end="391:22"><expr pos:start="391:5" pos:end="391:21"><operator pos:start="391:5" pos:end="391:5">*</operator><name pos:start="391:6" pos:end="391:13">pkcs7out</name> <operator pos:start="391:15" pos:end="391:15">=</operator> <name pos:start="391:17" pos:end="391:21">pkcs7</name></expr>;</expr_stmt>
    <return pos:start="392:5" pos:end="392:24">return <expr pos:start="392:12" pos:end="392:23"><name pos:start="392:12" pos:end="392:23">EST_ERR_NONE</name></expr>;</return>    
</block_content>}</block></function>
<comment type="block" pos:start="394:1" pos:end="410:3">/*
 * This function is invoked when the CACerts response has been received.  The
 * cert chain is built into a cert store and then each certificate is verified
 * against this store essentially verifying the cert chain against itself to
 * ensure that each intermediate can be verified back to one of the included
 * root certs in the CACerts response.  If CRLs are attached these will be
 * removed and a new PKCS7 buffer is created.
 *
 * Parameters:
 *	ctx:	EST Context representing this session
 *  cacerts:    pointer to the buffer holding the received CA certs 
 *  cacerts_len: length of the cacerts buffer
 *
 * Return value:
 *	EST_ERR_NONE if success
 
 */</comment>
<function pos:start="411:1" pos:end="553:1"><type pos:start="411:1" pos:end="411:16"><specifier pos:start="411:1" pos:end="411:6">static</specifier> <name pos:start="411:8" pos:end="411:16">EST_ERROR</name></type> <name pos:start="411:18" pos:end="411:35">verify_cacert_resp</name> <parameter_list pos:start="411:37" pos:end="412:54">(<parameter pos:start="411:38" pos:end="411:49"><decl pos:start="411:38" pos:end="411:49"><type pos:start="411:38" pos:end="411:49"><name pos:start="411:38" pos:end="411:44">EST_CTX</name> <modifier pos:start="411:46" pos:end="411:46">*</modifier></type><name pos:start="411:47" pos:end="411:49">ctx</name></decl></parameter>, <parameter pos:start="411:52" pos:end="411:73"><decl pos:start="411:52" pos:end="411:73"><type pos:start="411:52" pos:end="411:73"><name pos:start="411:52" pos:end="411:59">unsigned</name> <name pos:start="411:61" pos:end="411:64">char</name> <modifier pos:start="411:66" pos:end="411:66">*</modifier></type><name pos:start="411:67" pos:end="411:73">cacerts</name></decl></parameter>,
                                     <parameter pos:start="412:38" pos:end="412:53"><decl pos:start="412:38" pos:end="412:53"><type pos:start="412:38" pos:end="412:53"><name pos:start="412:38" pos:end="412:40">int</name> <modifier pos:start="412:42" pos:end="412:42">*</modifier></type><name pos:start="412:43" pos:end="412:53">cacerts_len</name></decl></parameter>)</parameter_list>
<block pos:start="413:1" pos:end="553:1">{<block_content pos:start="414:5" pos:end="552:5">
    <decl_stmt pos:start="414:5" pos:end="414:15"><decl pos:start="414:5" pos:end="414:14"><type pos:start="414:5" pos:end="414:7"><name pos:start="414:5" pos:end="414:7">int</name></type> <name pos:start="414:9" pos:end="414:10">rv</name> <init pos:start="414:12" pos:end="414:14">= <expr pos:start="414:14" pos:end="414:14"><literal type="number" pos:start="414:14" pos:end="414:14">0</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="415:5" pos:end="415:19"><decl pos:start="415:5" pos:end="415:18"><type pos:start="415:5" pos:end="415:7"><name pos:start="415:5" pos:end="415:7">int</name></type> <name pos:start="415:9" pos:end="415:14">failed</name> <init pos:start="415:16" pos:end="415:18">= <expr pos:start="415:18" pos:end="415:18"><literal type="number" pos:start="415:18" pos:end="415:18">0</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="416:5" pos:end="416:36"><decl pos:start="416:5" pos:end="416:35"><type pos:start="416:5" pos:end="416:13"><name pos:start="416:5" pos:end="416:13">EST_ERROR</name></type> <name pos:start="416:15" pos:end="416:20">est_rc</name> <init pos:start="416:22" pos:end="416:35">= <expr pos:start="416:24" pos:end="416:35"><name pos:start="416:24" pos:end="416:35">EST_ERR_NONE</name></expr></init></decl>;</decl_stmt>
    
    <decl_stmt pos:start="418:5" pos:end="418:46"><decl pos:start="418:5" pos:end="418:45"><type pos:start="418:5" pos:end="418:17"><name pos:start="418:5" pos:end="418:14">X509_STORE</name>  <modifier pos:start="418:17" pos:end="418:17">*</modifier></type><name pos:start="418:18" pos:end="418:38">trusted_cacerts_store</name> <init pos:start="418:40" pos:end="418:45">= <expr pos:start="418:42" pos:end="418:45"><name pos:start="418:42" pos:end="418:45">NULL</name></expr></init></decl>;</decl_stmt>
    
    <expr_stmt pos:start="420:5" pos:end="420:33"><expr pos:start="420:5" pos:end="420:32"><call pos:start="420:5" pos:end="420:18"><name pos:start="420:5" pos:end="420:12">STACK_OF</name><argument_list pos:start="420:13" pos:end="420:18">(<argument pos:start="420:14" pos:end="420:17"><expr pos:start="420:14" pos:end="420:17"><name pos:start="420:14" pos:end="420:17">X509</name></expr></argument>)</argument_list></call> <operator pos:start="420:20" pos:end="420:20">*</operator><name pos:start="420:21" pos:end="420:25">stack</name> <operator pos:start="420:27" pos:end="420:27">=</operator> <name pos:start="420:29" pos:end="420:32">NULL</name></expr>;</expr_stmt>
    <decl_stmt pos:start="421:5" pos:end="421:30"><decl pos:start="421:5" pos:end="421:29"><type pos:start="421:5" pos:end="421:10"><name pos:start="421:5" pos:end="421:8">X509</name> <modifier pos:start="421:10" pos:end="421:10">*</modifier></type><name pos:start="421:11" pos:end="421:22">current_cert</name> <init pos:start="421:24" pos:end="421:29">= <expr pos:start="421:26" pos:end="421:29"><name pos:start="421:26" pos:end="421:29">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="422:5" pos:end="422:10"><decl pos:start="422:5" pos:end="422:9"><type pos:start="422:5" pos:end="422:7"><name pos:start="422:5" pos:end="422:7">int</name></type> <name pos:start="422:9" pos:end="422:9">i</name></decl>;</decl_stmt>
    
    <decl_stmt pos:start="424:5" pos:end="424:42"><decl pos:start="424:5" pos:end="424:41"><type pos:start="424:5" pos:end="424:19"><name pos:start="424:5" pos:end="424:12">unsigned</name> <name pos:start="424:14" pos:end="424:17">char</name> <modifier pos:start="424:19" pos:end="424:19">*</modifier></type><name pos:start="424:20" pos:end="424:34">cacerts_decoded</name> <init pos:start="424:36" pos:end="424:41">= <expr pos:start="424:38" pos:end="424:41"><name pos:start="424:38" pos:end="424:41">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="425:5" pos:end="425:33"><decl pos:start="425:5" pos:end="425:32"><type pos:start="425:5" pos:end="425:7"><name pos:start="425:5" pos:end="425:7">int</name></type>  <name pos:start="425:10" pos:end="425:28">cacerts_decoded_len</name> <init pos:start="425:30" pos:end="425:32">= <expr pos:start="425:32" pos:end="425:32"><literal type="number" pos:start="425:32" pos:end="425:32">0</literal></expr></init></decl>;</decl_stmt>

    <decl_stmt pos:start="427:5" pos:end="427:37"><decl pos:start="427:5" pos:end="427:36"><type pos:start="427:5" pos:end="427:20"><name pos:start="427:5" pos:end="427:18">X509_STORE_CTX</name> <modifier pos:start="427:20" pos:end="427:20">*</modifier></type><name pos:start="427:21" pos:end="427:29">store_ctx</name> <init pos:start="427:31" pos:end="427:36">= <expr pos:start="427:33" pos:end="427:36"><name pos:start="427:33" pos:end="427:36">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="428:5" pos:end="428:24"><decl pos:start="428:5" pos:end="428:23"><type pos:start="428:5" pos:end="428:11"><name pos:start="428:5" pos:end="428:9">PKCS7</name> <modifier pos:start="428:11" pos:end="428:11">*</modifier></type><name pos:start="428:12" pos:end="428:16">pkcs7</name> <init pos:start="428:18" pos:end="428:23">= <expr pos:start="428:20" pos:end="428:23"><name pos:start="428:20" pos:end="428:23">NULL</name></expr></init></decl>;</decl_stmt>
    
    <if_stmt pos:start="430:5" pos:end="434:5"><if pos:start="430:5" pos:end="434:5">if <condition pos:start="430:8" pos:end="430:59">(<expr pos:start="430:9" pos:end="430:58"><name pos:start="430:9" pos:end="430:11">ctx</name> <operator pos:start="430:13" pos:end="430:14">==</operator> <name pos:start="430:16" pos:end="430:19">NULL</name> <operator pos:start="430:21" pos:end="430:22">||</operator> <name pos:start="430:24" pos:end="430:30">cacerts</name> <operator pos:start="430:32" pos:end="430:33">==</operator> <name pos:start="430:35" pos:end="430:38">NULL</name> <operator pos:start="430:40" pos:end="430:41">||</operator> <name pos:start="430:43" pos:end="430:53">cacerts_len</name> <operator pos:start="430:55" pos:end="430:56">==</operator> <literal type="number" pos:start="430:58" pos:end="430:58">0</literal></expr>)</condition> <block pos:start="430:61" pos:end="434:5">{<block_content pos:start="431:9" pos:end="433:44">
        <expr_stmt pos:start="431:9" pos:end="432:47"><expr pos:start="431:9" pos:end="432:46"><call pos:start="431:9" pos:end="432:46"><name pos:start="431:9" pos:end="431:19">EST_LOG_ERR</name><argument_list pos:start="431:20" pos:end="432:46">(<argument pos:start="431:21" pos:end="431:79"><expr pos:start="431:21" pos:end="431:79"><literal type="string" pos:start="431:21" pos:end="431:79">"Invalid parameter. ctx = %x cacerts = %x cacerts_len = %x"</literal></expr></argument>,
                    <argument pos:start="432:21" pos:end="432:23"><expr pos:start="432:21" pos:end="432:23"><name pos:start="432:21" pos:end="432:23">ctx</name></expr></argument>, <argument pos:start="432:26" pos:end="432:32"><expr pos:start="432:26" pos:end="432:32"><name pos:start="432:26" pos:end="432:32">cacerts</name></expr></argument>, <argument pos:start="432:35" pos:end="432:45"><expr pos:start="432:35" pos:end="432:45"><name pos:start="432:35" pos:end="432:45">cacerts_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="433:9" pos:end="433:44">return <expr pos:start="433:16" pos:end="433:43"><operator pos:start="433:16" pos:end="433:16">(</operator><name pos:start="433:17" pos:end="433:42">EST_ERR_INVALID_PARAMETERS</name><operator pos:start="433:43" pos:end="433:43">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>    

    <comment type="block" pos:start="436:5" pos:end="440:7">/*
     * - Base64 decode the incoming ca certs buffer,
     * - convert to a PKCS7 structure,
     * - extract out the stack of certs.
     */</comment>
    <expr_stmt pos:start="441:5" pos:end="442:68"><expr pos:start="441:5" pos:end="442:67"><name pos:start="441:5" pos:end="441:6">rv</name> <operator pos:start="441:8" pos:end="441:8">=</operator> <call pos:start="441:10" pos:end="442:67"><name pos:start="441:10" pos:end="441:27">b64_decode_cacerts</name><argument_list pos:start="441:28" pos:end="442:67">(<argument pos:start="441:29" pos:end="441:35"><expr pos:start="441:29" pos:end="441:35"><name pos:start="441:29" pos:end="441:35">cacerts</name></expr></argument>, <argument pos:start="441:38" pos:end="441:48"><expr pos:start="441:38" pos:end="441:48"><name pos:start="441:38" pos:end="441:48">cacerts_len</name></expr></argument>,
                            <argument pos:start="442:29" pos:end="442:44"><expr pos:start="442:29" pos:end="442:44"><operator pos:start="442:29" pos:end="442:29">&amp;</operator><name pos:start="442:30" pos:end="442:44">cacerts_decoded</name></expr></argument>, <argument pos:start="442:47" pos:end="442:66"><expr pos:start="442:47" pos:end="442:66"><operator pos:start="442:47" pos:end="442:47">&amp;</operator><name pos:start="442:48" pos:end="442:66">cacerts_decoded_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="443:5" pos:end="446:5"><if pos:start="443:5" pos:end="446:5">if <condition pos:start="443:8" pos:end="443:27">(<expr pos:start="443:9" pos:end="443:26"><name pos:start="443:9" pos:end="443:10">rv</name> <operator pos:start="443:12" pos:end="443:13">!=</operator> <name pos:start="443:15" pos:end="443:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="443:29" pos:end="446:5">{<block_content pos:start="444:9" pos:end="445:20">
        <expr_stmt pos:start="444:9" pos:end="444:65"><expr pos:start="444:9" pos:end="444:64"><call pos:start="444:9" pos:end="444:64"><name pos:start="444:9" pos:end="444:19">EST_LOG_ERR</name><argument_list pos:start="444:20" pos:end="444:64">(<argument pos:start="444:21" pos:end="444:63"><expr pos:start="444:21" pos:end="444:63"><literal type="string" pos:start="444:21" pos:end="444:63">"Base64 decode of received CA certs failed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="445:9" pos:end="445:20">return <expr pos:start="445:16" pos:end="445:19"><operator pos:start="445:16" pos:end="445:16">(</operator><name pos:start="445:17" pos:end="445:18">rv</name><operator pos:start="445:19" pos:end="445:19">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="447:5" pos:end="447:68"><expr pos:start="447:5" pos:end="447:67"><name pos:start="447:5" pos:end="447:6">rv</name> <operator pos:start="447:8" pos:end="447:8">=</operator> <call pos:start="447:10" pos:end="447:67"><name pos:start="447:10" pos:end="447:21">create_PKCS7</name><argument_list pos:start="447:22" pos:end="447:67">(<argument pos:start="447:23" pos:end="447:37"><expr pos:start="447:23" pos:end="447:37"><name pos:start="447:23" pos:end="447:37">cacerts_decoded</name></expr></argument>, <argument pos:start="447:40" pos:end="447:58"><expr pos:start="447:40" pos:end="447:58"><name pos:start="447:40" pos:end="447:58">cacerts_decoded_len</name></expr></argument>, <argument pos:start="447:61" pos:end="447:66"><expr pos:start="447:61" pos:end="447:66"><operator pos:start="447:61" pos:end="447:61">&amp;</operator><name pos:start="447:62" pos:end="447:66">pkcs7</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="448:5" pos:end="452:5"><if pos:start="448:5" pos:end="452:5">if <condition pos:start="448:8" pos:end="448:27">(<expr pos:start="448:9" pos:end="448:26"><name pos:start="448:9" pos:end="448:10">rv</name> <operator pos:start="448:12" pos:end="448:13">!=</operator> <name pos:start="448:15" pos:end="448:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="448:29" pos:end="452:5">{<block_content pos:start="449:9" pos:end="451:20">
        <expr_stmt pos:start="449:9" pos:end="449:76"><expr pos:start="449:9" pos:end="449:75"><call pos:start="449:9" pos:end="449:75"><name pos:start="449:9" pos:end="449:19">EST_LOG_ERR</name><argument_list pos:start="449:20" pos:end="449:75">(<argument pos:start="449:21" pos:end="449:74"><expr pos:start="449:21" pos:end="449:74"><literal type="string" pos:start="449:21" pos:end="449:74">"Failed to build PKCS7 structure from receievd buffer"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="450:9" pos:end="450:30"><expr pos:start="450:9" pos:end="450:29"><call pos:start="450:9" pos:end="450:29"><name pos:start="450:9" pos:end="450:12">free</name><argument_list pos:start="450:13" pos:end="450:29">(<argument pos:start="450:14" pos:end="450:28"><expr pos:start="450:14" pos:end="450:28"><name pos:start="450:14" pos:end="450:28">cacerts_decoded</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="451:9" pos:end="451:20">return <expr pos:start="451:16" pos:end="451:19"><operator pos:start="451:16" pos:end="451:16">(</operator><name pos:start="451:17" pos:end="451:18">rv</name><operator pos:start="451:19" pos:end="451:19">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="453:5" pos:end="453:39"><expr pos:start="453:5" pos:end="453:38"><name pos:start="453:5" pos:end="453:6">rv</name> <operator pos:start="453:8" pos:end="453:8">=</operator> <call pos:start="453:10" pos:end="453:38"><name pos:start="453:10" pos:end="453:23">PKCS7_to_stack</name><argument_list pos:start="453:24" pos:end="453:38">(<argument pos:start="453:25" pos:end="453:29"><expr pos:start="453:25" pos:end="453:29"><name pos:start="453:25" pos:end="453:29">pkcs7</name></expr></argument>, <argument pos:start="453:32" pos:end="453:37"><expr pos:start="453:32" pos:end="453:37"><operator pos:start="453:32" pos:end="453:32">&amp;</operator><name pos:start="453:33" pos:end="453:37">stack</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>    
    <if_stmt pos:start="454:5" pos:end="459:5"><if pos:start="454:5" pos:end="459:5">if <condition pos:start="454:8" pos:end="454:27">(<expr pos:start="454:9" pos:end="454:26"><name pos:start="454:9" pos:end="454:10">rv</name> <operator pos:start="454:12" pos:end="454:13">!=</operator> <name pos:start="454:15" pos:end="454:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="454:29" pos:end="459:5">{<block_content pos:start="455:9" pos:end="458:20">
        <expr_stmt pos:start="455:9" pos:end="455:79"><expr pos:start="455:9" pos:end="455:78"><call pos:start="455:9" pos:end="455:78"><name pos:start="455:9" pos:end="455:19">EST_LOG_ERR</name><argument_list pos:start="455:20" pos:end="455:78">(<argument pos:start="455:21" pos:end="455:77"><expr pos:start="455:21" pos:end="455:77"><literal type="string" pos:start="455:21" pos:end="455:77">"Could not obtain stack of ca certs from PKCS7 structure"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="456:9" pos:end="456:30"><expr pos:start="456:9" pos:end="456:29"><call pos:start="456:9" pos:end="456:29"><name pos:start="456:9" pos:end="456:12">free</name><argument_list pos:start="456:13" pos:end="456:29">(<argument pos:start="456:14" pos:end="456:28"><expr pos:start="456:14" pos:end="456:28"><name pos:start="456:14" pos:end="456:28">cacerts_decoded</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="457:9" pos:end="457:26"><expr pos:start="457:9" pos:end="457:25"><call pos:start="457:9" pos:end="457:25"><name pos:start="457:9" pos:end="457:18">PKCS7_free</name><argument_list pos:start="457:19" pos:end="457:25">(<argument pos:start="457:20" pos:end="457:24"><expr pos:start="457:20" pos:end="457:24"><name pos:start="457:20" pos:end="457:24">pkcs7</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="458:9" pos:end="458:20">return <expr pos:start="458:16" pos:end="458:19"><operator pos:start="458:16" pos:end="458:16">(</operator><name pos:start="458:17" pos:end="458:18">rv</name><operator pos:start="458:19" pos:end="458:19">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
    
    <comment type="block" pos:start="461:5" pos:end="468:7">/*
     * At this point we have the stack of X509 certs that make up
     * the CA certs response sent from the EST server.
     * - Build a store of "trusted" certs to use in the verify
     * - walk through each cert and verify it 
     *   - Build a store context from the store and the cert to be verified and
     *     call the verify function
     */</comment>
    <expr_stmt pos:start="469:5" pos:end="469:45"><expr pos:start="469:5" pos:end="469:44"><name pos:start="469:5" pos:end="469:25">trusted_cacerts_store</name> <operator pos:start="469:27" pos:end="469:27">=</operator> <call pos:start="469:29" pos:end="469:44"><name pos:start="469:29" pos:end="469:42">X509_STORE_new</name><argument_list pos:start="469:43" pos:end="469:44">()</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="470:5" pos:end="478:5"><if pos:start="470:5" pos:end="478:5">if <condition pos:start="470:8" pos:end="470:38">(<expr pos:start="470:9" pos:end="470:37"><name pos:start="470:9" pos:end="470:29">trusted_cacerts_store</name> <operator pos:start="470:31" pos:end="470:32">==</operator> <name pos:start="470:34" pos:end="470:37">NULL</name></expr>)</condition> <block pos:start="470:40" pos:end="478:5">{<block_content pos:start="471:9" pos:end="477:32">
        <expr_stmt pos:start="471:9" pos:end="471:53"><expr pos:start="471:9" pos:end="471:52"><call pos:start="471:9" pos:end="471:52"><name pos:start="471:9" pos:end="471:19">EST_LOG_ERR</name><argument_list pos:start="471:20" pos:end="471:52">(<argument pos:start="471:21" pos:end="471:51"><expr pos:start="471:21" pos:end="471:51"><literal type="string" pos:start="471:21" pos:end="471:51">"Unable to allocate cert store"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="472:9" pos:end="472:31"><expr pos:start="472:9" pos:end="472:30"><call pos:start="472:9" pos:end="472:30"><name pos:start="472:9" pos:end="472:28">ossl_dump_ssl_errors</name><argument_list pos:start="472:29" pos:end="472:30">()</argument_list></call></expr>;</expr_stmt>
        
        <expr_stmt pos:start="474:9" pos:end="474:30"><expr pos:start="474:9" pos:end="474:29"><call pos:start="474:9" pos:end="474:29"><name pos:start="474:9" pos:end="474:12">free</name><argument_list pos:start="474:13" pos:end="474:29">(<argument pos:start="474:14" pos:end="474:28"><expr pos:start="474:14" pos:end="474:28"><name pos:start="474:14" pos:end="474:28">cacerts_decoded</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="475:9" pos:end="475:26"><expr pos:start="475:9" pos:end="475:25"><call pos:start="475:9" pos:end="475:25"><name pos:start="475:9" pos:end="475:18">PKCS7_free</name><argument_list pos:start="475:19" pos:end="475:25">(<argument pos:start="475:20" pos:end="475:24"><expr pos:start="475:20" pos:end="475:24"><name pos:start="475:20" pos:end="475:24">pkcs7</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        
        <return pos:start="477:9" pos:end="477:32">return <expr pos:start="477:16" pos:end="477:31"><operator pos:start="477:16" pos:end="477:16">(</operator><name pos:start="477:17" pos:end="477:30">EST_ERR_MALLOC</name><operator pos:start="477:31" pos:end="477:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="480:5" pos:end="480:81"><expr pos:start="480:5" pos:end="480:80"><call pos:start="480:5" pos:end="480:80"><name pos:start="480:5" pos:end="480:28">X509_STORE_set_verify_cb</name><argument_list pos:start="480:29" pos:end="480:80">(<argument pos:start="480:30" pos:end="480:50"><expr pos:start="480:30" pos:end="480:50"><name pos:start="480:30" pos:end="480:50">trusted_cacerts_store</name></expr></argument>, <argument pos:start="480:53" pos:end="480:79"><expr pos:start="480:53" pos:end="480:79"><name pos:start="480:53" pos:end="480:79">est_client_cacert_verify_cb</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <for pos:start="482:5" pos:end="494:5">for <control pos:start="482:9" pos:end="482:40">(<init pos:start="482:10" pos:end="482:13"><expr pos:start="482:10" pos:end="482:12"><name pos:start="482:10" pos:end="482:10">i</name><operator pos:start="482:11" pos:end="482:11">=</operator><literal type="number" pos:start="482:12" pos:end="482:12">0</literal></expr>;</init> <condition pos:start="482:15" pos:end="482:35"><expr pos:start="482:15" pos:end="482:34"><name pos:start="482:15" pos:end="482:15">i</name><operator pos:start="482:16" pos:end="482:16">&lt;</operator><call pos:start="482:17" pos:end="482:34"><name pos:start="482:17" pos:end="482:27">sk_X509_num</name><argument_list pos:start="482:28" pos:end="482:34">(<argument pos:start="482:29" pos:end="482:33"><expr pos:start="482:29" pos:end="482:33"><name pos:start="482:29" pos:end="482:33">stack</name></expr></argument>)</argument_list></call></expr>;</condition> <incr pos:start="482:37" pos:end="482:39"><expr pos:start="482:37" pos:end="482:39"><name pos:start="482:37" pos:end="482:37">i</name><operator pos:start="482:38" pos:end="482:39">++</operator></expr></incr>)</control> <block pos:start="482:42" pos:end="494:5">{<block_content pos:start="483:9" pos:end="493:9">
        <expr_stmt pos:start="483:9" pos:end="483:47"><expr pos:start="483:9" pos:end="483:46"><name pos:start="483:9" pos:end="483:20">current_cert</name> <operator pos:start="483:22" pos:end="483:22">=</operator> <call pos:start="483:24" pos:end="483:46"><name pos:start="483:24" pos:end="483:36">sk_X509_value</name><argument_list pos:start="483:37" pos:end="483:46">(<argument pos:start="483:38" pos:end="483:42"><expr pos:start="483:38" pos:end="483:42"><name pos:start="483:38" pos:end="483:42">stack</name></expr></argument>, <argument pos:start="483:45" pos:end="483:45"><expr pos:start="483:45" pos:end="483:45"><name pos:start="483:45" pos:end="483:45">i</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

        <comment type="block" pos:start="485:9" pos:end="488:11">/*
         * Is it self signed?  If so, add it in the trusted store, otherwise,
         * add it to the untrusted store.
         */</comment>
        <expr_stmt pos:start="489:9" pos:end="489:59"><expr pos:start="489:9" pos:end="489:58"><name pos:start="489:9" pos:end="489:10">rv</name> <operator pos:start="489:12" pos:end="489:12">=</operator> <call pos:start="489:14" pos:end="489:58"><name pos:start="489:14" pos:end="489:30">X509_check_issued</name><argument_list pos:start="489:31" pos:end="489:58">(<argument pos:start="489:32" pos:end="489:43"><expr pos:start="489:32" pos:end="489:43"><name pos:start="489:32" pos:end="489:43">current_cert</name></expr></argument>, <argument pos:start="489:46" pos:end="489:57"><expr pos:start="489:46" pos:end="489:57"><name pos:start="489:46" pos:end="489:57">current_cert</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if_stmt pos:start="490:9" pos:end="493:9"><if pos:start="490:9" pos:end="493:9">if <condition pos:start="490:12" pos:end="490:28">(<expr pos:start="490:13" pos:end="490:27"><name pos:start="490:13" pos:end="490:14">rv</name> <operator pos:start="490:16" pos:end="490:17">==</operator> <name pos:start="490:19" pos:end="490:27">X509_V_OK</name></expr>)</condition> <block pos:start="490:30" pos:end="493:9">{<block_content pos:start="491:13" pos:end="492:69">
            <expr_stmt pos:start="491:13" pos:end="491:82"><expr pos:start="491:13" pos:end="491:81"><call pos:start="491:13" pos:end="491:81"><name pos:start="491:13" pos:end="491:24">EST_LOG_INFO</name><argument_list pos:start="491:25" pos:end="491:81">(<argument pos:start="491:26" pos:end="491:60"><expr pos:start="491:26" pos:end="491:60"><literal type="string" pos:start="491:26" pos:end="491:60">"Adding cert to trusted store (%s)"</literal></expr></argument>, <argument pos:start="491:63" pos:end="491:80"><expr pos:start="491:63" pos:end="491:80"><name pos:start="491:63" pos:end="491:80"><name pos:start="491:63" pos:end="491:74">current_cert</name><operator pos:start="491:75" pos:end="491:76">-&gt;</operator><name pos:start="491:77" pos:end="491:80">name</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="492:13" pos:end="492:69"><expr pos:start="492:13" pos:end="492:68"><call pos:start="492:13" pos:end="492:68"><name pos:start="492:13" pos:end="492:31">X509_STORE_add_cert</name><argument_list pos:start="492:32" pos:end="492:68">(<argument pos:start="492:33" pos:end="492:53"><expr pos:start="492:33" pos:end="492:53"><name pos:start="492:33" pos:end="492:53">trusted_cacerts_store</name></expr></argument>, <argument pos:start="492:56" pos:end="492:67"><expr pos:start="492:56" pos:end="492:67"><name pos:start="492:56" pos:end="492:67">current_cert</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></if></if_stmt>
    </block_content>}</block></for>

    <comment type="block" pos:start="496:5" pos:end="498:7">/*
     * set up a X509 Store Context
     */</comment>
    <expr_stmt pos:start="499:5" pos:end="499:37"><expr pos:start="499:5" pos:end="499:36"><name pos:start="499:5" pos:end="499:13">store_ctx</name> <operator pos:start="499:15" pos:end="499:15">=</operator> <call pos:start="499:17" pos:end="499:36"><name pos:start="499:17" pos:end="499:34">X509_STORE_CTX_new</name><argument_list pos:start="499:35" pos:end="499:36">()</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="500:5" pos:end="509:5"><if pos:start="500:5" pos:end="509:5">if <condition pos:start="500:8" pos:end="500:26">(<expr pos:start="500:9" pos:end="500:25"><name pos:start="500:9" pos:end="500:17">store_ctx</name> <operator pos:start="500:19" pos:end="500:20">==</operator> <name pos:start="500:22" pos:end="500:25">NULL</name></expr>)</condition> <block pos:start="500:28" pos:end="509:5">{<block_content pos:start="501:9" pos:end="508:31">
        <expr_stmt pos:start="501:9" pos:end="501:62"><expr pos:start="501:9" pos:end="501:61"><call pos:start="501:9" pos:end="501:61"><name pos:start="501:9" pos:end="501:19">EST_LOG_ERR</name><argument_list pos:start="501:20" pos:end="501:61">(<argument pos:start="501:21" pos:end="501:60"><expr pos:start="501:21" pos:end="501:60"><literal type="string" pos:start="501:21" pos:end="501:60">"Unable to allocate a new store context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="502:9" pos:end="502:31"><expr pos:start="502:9" pos:end="502:30"><call pos:start="502:9" pos:end="502:30"><name pos:start="502:9" pos:end="502:28">ossl_dump_ssl_errors</name><argument_list pos:start="502:29" pos:end="502:30">()</argument_list></call></expr>;</expr_stmt>
        
        <expr_stmt pos:start="504:9" pos:end="504:30"><expr pos:start="504:9" pos:end="504:29"><call pos:start="504:9" pos:end="504:29"><name pos:start="504:9" pos:end="504:12">free</name><argument_list pos:start="504:13" pos:end="504:29">(<argument pos:start="504:14" pos:end="504:28"><expr pos:start="504:14" pos:end="504:28"><name pos:start="504:14" pos:end="504:28">cacerts_decoded</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="505:9" pos:end="505:26"><expr pos:start="505:9" pos:end="505:25"><call pos:start="505:9" pos:end="505:25"><name pos:start="505:9" pos:end="505:18">PKCS7_free</name><argument_list pos:start="505:19" pos:end="505:25">(<argument pos:start="505:20" pos:end="505:24"><expr pos:start="505:20" pos:end="505:24"><name pos:start="505:20" pos:end="505:24">pkcs7</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="506:9" pos:end="506:47"><expr pos:start="506:9" pos:end="506:46"><call pos:start="506:9" pos:end="506:46"><name pos:start="506:9" pos:end="506:23">X509_STORE_free</name><argument_list pos:start="506:24" pos:end="506:46">(<argument pos:start="506:25" pos:end="506:45"><expr pos:start="506:25" pos:end="506:45"><name pos:start="506:25" pos:end="506:45">trusted_cacerts_store</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        
        <return pos:start="508:9" pos:end="508:31">return<expr pos:start="508:15" pos:end="508:30"><operator pos:start="508:15" pos:end="508:15">(</operator><name pos:start="508:16" pos:end="508:29">EST_ERR_MALLOC</name><operator pos:start="508:30" pos:end="508:30">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <for pos:start="511:5" pos:end="536:5">for <control pos:start="511:9" pos:end="511:40">(<init pos:start="511:10" pos:end="511:13"><expr pos:start="511:10" pos:end="511:12"><name pos:start="511:10" pos:end="511:10">i</name><operator pos:start="511:11" pos:end="511:11">=</operator><literal type="number" pos:start="511:12" pos:end="511:12">0</literal></expr>;</init> <condition pos:start="511:15" pos:end="511:35"><expr pos:start="511:15" pos:end="511:34"><name pos:start="511:15" pos:end="511:15">i</name><operator pos:start="511:16" pos:end="511:16">&lt;</operator><call pos:start="511:17" pos:end="511:34"><name pos:start="511:17" pos:end="511:27">sk_X509_num</name><argument_list pos:start="511:28" pos:end="511:34">(<argument pos:start="511:29" pos:end="511:33"><expr pos:start="511:29" pos:end="511:33"><name pos:start="511:29" pos:end="511:33">stack</name></expr></argument>)</argument_list></call></expr>;</condition> <incr pos:start="511:37" pos:end="511:39"><expr pos:start="511:37" pos:end="511:39"><name pos:start="511:37" pos:end="511:37">i</name><operator pos:start="511:38" pos:end="511:39">++</operator></expr></incr>)</control> <block pos:start="511:42" pos:end="536:5">{<block_content pos:start="513:9" pos:end="535:9">

        <if_stmt pos:start="513:9" pos:end="523:9"><if pos:start="513:9" pos:end="523:9">if <condition pos:start="513:12" pos:end="513:80">(<expr pos:start="513:13" pos:end="513:79"><operator pos:start="513:13" pos:end="513:13">!</operator><call pos:start="513:14" pos:end="513:79"><name pos:start="513:14" pos:end="513:32">X509_STORE_CTX_init</name><argument_list pos:start="513:33" pos:end="513:79">(<argument pos:start="513:34" pos:end="513:42"><expr pos:start="513:34" pos:end="513:42"><name pos:start="513:34" pos:end="513:42">store_ctx</name></expr></argument>, <argument pos:start="513:45" pos:end="513:65"><expr pos:start="513:45" pos:end="513:65"><name pos:start="513:45" pos:end="513:65">trusted_cacerts_store</name></expr></argument>, <argument pos:start="513:68" pos:end="513:71"><expr pos:start="513:68" pos:end="513:71"><name pos:start="513:68" pos:end="513:71">NULL</name></expr></argument>, <argument pos:start="513:74" pos:end="513:78"><expr pos:start="513:74" pos:end="513:78"><name pos:start="513:74" pos:end="513:78">stack</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="513:82" pos:end="523:9">{<block_content pos:start="514:13" pos:end="522:37">
            <expr_stmt pos:start="514:13" pos:end="514:70"><expr pos:start="514:13" pos:end="514:69"><call pos:start="514:13" pos:end="514:69"><name pos:start="514:13" pos:end="514:23">EST_LOG_ERR</name><argument_list pos:start="514:24" pos:end="514:69">(<argument pos:start="514:25" pos:end="514:68"><expr pos:start="514:25" pos:end="514:68"><literal type="string" pos:start="514:25" pos:end="514:68">"Unable to initialize the new store context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="515:13" pos:end="515:35"><expr pos:start="515:13" pos:end="515:34"><call pos:start="515:13" pos:end="515:34"><name pos:start="515:13" pos:end="515:32">ossl_dump_ssl_errors</name><argument_list pos:start="515:33" pos:end="515:34">()</argument_list></call></expr>;</expr_stmt>

            <expr_stmt pos:start="517:13" pos:end="517:34"><expr pos:start="517:13" pos:end="517:33"><call pos:start="517:13" pos:end="517:33"><name pos:start="517:13" pos:end="517:16">free</name><argument_list pos:start="517:17" pos:end="517:33">(<argument pos:start="517:18" pos:end="517:32"><expr pos:start="517:18" pos:end="517:32"><name pos:start="517:18" pos:end="517:32">cacerts_decoded</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="518:13" pos:end="518:30"><expr pos:start="518:13" pos:end="518:29"><call pos:start="518:13" pos:end="518:29"><name pos:start="518:13" pos:end="518:22">PKCS7_free</name><argument_list pos:start="518:23" pos:end="518:29">(<argument pos:start="518:24" pos:end="518:28"><expr pos:start="518:24" pos:end="518:28"><name pos:start="518:24" pos:end="518:28">pkcs7</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="519:13" pos:end="519:51"><expr pos:start="519:13" pos:end="519:50"><call pos:start="519:13" pos:end="519:50"><name pos:start="519:13" pos:end="519:27">X509_STORE_free</name><argument_list pos:start="519:28" pos:end="519:50">(<argument pos:start="519:29" pos:end="519:49"><expr pos:start="519:29" pos:end="519:49"><name pos:start="519:29" pos:end="519:49">trusted_cacerts_store</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="520:13" pos:end="520:43"><expr pos:start="520:13" pos:end="520:42"><call pos:start="520:13" pos:end="520:42"><name pos:start="520:13" pos:end="520:31">X509_STORE_CTX_free</name><argument_list pos:start="520:32" pos:end="520:42">(<argument pos:start="520:33" pos:end="520:41"><expr pos:start="520:33" pos:end="520:41"><name pos:start="520:33" pos:end="520:41">store_ctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            
            <return pos:start="522:13" pos:end="522:37">return <expr pos:start="522:20" pos:end="522:36"><operator pos:start="522:20" pos:end="522:20">(</operator> <name pos:start="522:22" pos:end="522:35">EST_ERR_MALLOC</name><operator pos:start="522:36" pos:end="522:36">)</operator></expr>;</return>
        </block_content>}</block></if></if_stmt>
        <expr_stmt pos:start="524:9" pos:end="524:47"><expr pos:start="524:9" pos:end="524:46"><name pos:start="524:9" pos:end="524:20">current_cert</name> <operator pos:start="524:22" pos:end="524:22">=</operator> <call pos:start="524:24" pos:end="524:46"><name pos:start="524:24" pos:end="524:36">sk_X509_value</name><argument_list pos:start="524:37" pos:end="524:46">(<argument pos:start="524:38" pos:end="524:42"><expr pos:start="524:38" pos:end="524:42"><name pos:start="524:38" pos:end="524:42">stack</name></expr></argument>, <argument pos:start="524:45" pos:end="524:45"><expr pos:start="524:45" pos:end="524:45"><name pos:start="524:45" pos:end="524:45">i</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="525:9" pos:end="525:70"><expr pos:start="525:9" pos:end="525:69"><call pos:start="525:9" pos:end="525:69"><name pos:start="525:9" pos:end="525:20">EST_LOG_INFO</name><argument_list pos:start="525:21" pos:end="525:69">(<argument pos:start="525:22" pos:end="525:48"><expr pos:start="525:22" pos:end="525:48"><literal type="string" pos:start="525:22" pos:end="525:48">"Adding cert to store (%s)"</literal></expr></argument>, <argument pos:start="525:51" pos:end="525:68"><expr pos:start="525:51" pos:end="525:68"><name pos:start="525:51" pos:end="525:68"><name pos:start="525:51" pos:end="525:62">current_cert</name><operator pos:start="525:63" pos:end="525:64">-&gt;</operator><name pos:start="525:65" pos:end="525:68">name</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt pos:start="526:9" pos:end="526:57"><expr pos:start="526:9" pos:end="526:56"><call pos:start="526:9" pos:end="526:56"><name pos:start="526:9" pos:end="526:31">X509_STORE_CTX_set_cert</name><argument_list pos:start="526:32" pos:end="526:56">(<argument pos:start="526:33" pos:end="526:41"><expr pos:start="526:33" pos:end="526:41"><name pos:start="526:33" pos:end="526:41">store_ctx</name></expr></argument>, <argument pos:start="526:44" pos:end="526:55"><expr pos:start="526:44" pos:end="526:55"><name pos:start="526:44" pos:end="526:55">current_cert</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        
        <expr_stmt pos:start="528:9" pos:end="528:41"><expr pos:start="528:9" pos:end="528:40"><name pos:start="528:9" pos:end="528:10">rv</name> <operator pos:start="528:12" pos:end="528:12">=</operator> <call pos:start="528:14" pos:end="528:40"><name pos:start="528:14" pos:end="528:29">X509_verify_cert</name><argument_list pos:start="528:30" pos:end="528:40">(<argument pos:start="528:31" pos:end="528:39"><expr pos:start="528:31" pos:end="528:39"><name pos:start="528:31" pos:end="528:39">store_ctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="529:9" pos:end="535:9"><if pos:start="529:9" pos:end="535:9">if <condition pos:start="529:12" pos:end="529:16">(<expr pos:start="529:13" pos:end="529:15"><operator pos:start="529:13" pos:end="529:13">!</operator><name pos:start="529:14" pos:end="529:15">rv</name></expr>)</condition> <block pos:start="529:18" pos:end="535:9">{<block_content pos:start="533:13" pos:end="534:23">
            <comment type="block" pos:start="530:13" pos:end="532:15">/*
             * this cert failed verification.  Log this and continue on
             */</comment>
            <expr_stmt pos:start="533:13" pos:end="533:85"><expr pos:start="533:13" pos:end="533:84"><call pos:start="533:13" pos:end="533:84"><name pos:start="533:13" pos:end="533:24">EST_LOG_WARN</name><argument_list pos:start="533:25" pos:end="533:84">(<argument pos:start="533:26" pos:end="533:63"><expr pos:start="533:26" pos:end="533:63"><literal type="string" pos:start="533:26" pos:end="533:63">"Certificate failed verification (%s)"</literal></expr></argument>, <argument pos:start="533:66" pos:end="533:83"><expr pos:start="533:66" pos:end="533:83"><name pos:start="533:66" pos:end="533:83"><name pos:start="533:66" pos:end="533:77">current_cert</name><operator pos:start="533:78" pos:end="533:79">-&gt;</operator><name pos:start="533:80" pos:end="533:83">name</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="534:13" pos:end="534:23"><expr pos:start="534:13" pos:end="534:22"><name pos:start="534:13" pos:end="534:18">failed</name> <operator pos:start="534:20" pos:end="534:20">=</operator> <literal type="number" pos:start="534:22" pos:end="534:22">1</literal></expr>;</expr_stmt>
        </block_content>}</block></if></if_stmt>
    </block_content>}</block></for>

    <comment type="block" pos:start="538:5" pos:end="540:7">/*
     * Finally, remove any CRLs that might be attached.
     */</comment>
    <expr_stmt pos:start="541:5" pos:end="541:70"><expr pos:start="541:5" pos:end="541:69"><name pos:start="541:5" pos:end="541:10">est_rc</name> <operator pos:start="541:12" pos:end="541:12">=</operator> <call pos:start="541:14" pos:end="541:69"><name pos:start="541:14" pos:end="541:35">est_client_remove_crls</name><argument_list pos:start="541:36" pos:end="541:69">(<argument pos:start="541:37" pos:end="541:39"><expr pos:start="541:37" pos:end="541:39"><name pos:start="541:37" pos:end="541:39">ctx</name></expr></argument>, <argument pos:start="541:42" pos:end="541:48"><expr pos:start="541:42" pos:end="541:48"><name pos:start="541:42" pos:end="541:48">cacerts</name></expr></argument>, <argument pos:start="541:51" pos:end="541:61"><expr pos:start="541:51" pos:end="541:61"><name pos:start="541:51" pos:end="541:61">cacerts_len</name></expr></argument>, <argument pos:start="541:64" pos:end="541:68"><expr pos:start="541:64" pos:end="541:68"><name pos:start="541:64" pos:end="541:68">pkcs7</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <expr_stmt pos:start="543:5" pos:end="543:26"><expr pos:start="543:5" pos:end="543:25"><call pos:start="543:5" pos:end="543:25"><name pos:start="543:5" pos:end="543:8">free</name><argument_list pos:start="543:9" pos:end="543:25">(<argument pos:start="543:10" pos:end="543:24"><expr pos:start="543:10" pos:end="543:24"><name pos:start="543:10" pos:end="543:24">cacerts_decoded</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="544:5" pos:end="544:43"><expr pos:start="544:5" pos:end="544:42"><call pos:start="544:5" pos:end="544:42"><name pos:start="544:5" pos:end="544:19">X509_STORE_free</name><argument_list pos:start="544:20" pos:end="544:42">(<argument pos:start="544:21" pos:end="544:41"><expr pos:start="544:21" pos:end="544:41"><name pos:start="544:21" pos:end="544:41">trusted_cacerts_store</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="545:5" pos:end="545:35"><expr pos:start="545:5" pos:end="545:34"><call pos:start="545:5" pos:end="545:34"><name pos:start="545:5" pos:end="545:23">X509_STORE_CTX_free</name><argument_list pos:start="545:24" pos:end="545:34">(<argument pos:start="545:25" pos:end="545:33"><expr pos:start="545:25" pos:end="545:33"><name pos:start="545:25" pos:end="545:33">store_ctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="546:5" pos:end="546:22"><expr pos:start="546:5" pos:end="546:21"><call pos:start="546:5" pos:end="546:21"><name pos:start="546:5" pos:end="546:14">PKCS7_free</name><argument_list pos:start="546:15" pos:end="546:21">(<argument pos:start="546:16" pos:end="546:20"><expr pos:start="546:16" pos:end="546:20"><name pos:start="546:16" pos:end="546:20">pkcs7</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    
    <if_stmt pos:start="548:5" pos:end="552:5"><if pos:start="548:5" pos:end="550:5">if <condition pos:start="548:8" pos:end="548:15">(<expr pos:start="548:9" pos:end="548:14"><name pos:start="548:9" pos:end="548:14">failed</name></expr>)</condition> <block pos:start="548:17" pos:end="550:5">{<block_content pos:start="549:9" pos:end="549:45">
        <return pos:start="549:9" pos:end="549:45">return <expr pos:start="549:16" pos:end="549:44"><operator pos:start="549:16" pos:end="549:16">(</operator><name pos:start="549:17" pos:end="549:43">EST_ERR_CACERT_VERIFICATION</name><operator pos:start="549:44" pos:end="549:44">)</operator></expr>;</return>
    </block_content>}</block></if> <else pos:start="550:7" pos:end="552:5">else <block pos:start="550:12" pos:end="552:5">{<block_content pos:start="551:9" pos:end="551:22">
        <return pos:start="551:9" pos:end="551:22">return <expr pos:start="551:16" pos:end="551:21"><name pos:start="551:16" pos:end="551:21">est_rc</name></expr>;</return>
    </block_content>}</block></else></if_stmt>
</block_content>}</block></function>
<comment type="block" pos:start="554:1" pos:end="569:3">/*
 * This function is registered with SSL to be called during the verification
 * of each certificate in the server's identity cert chain.  The main purpose
 * is to look for the case where the cert could not be verified.  In this case,
 * if the EST client app has registered a callback to receive these untrusted
 * certs, it will be forwarded up to the EST client application.
 *
 * Parameters:
 *	ok:	The status of this certificate from the SSL verify code.
 *   x_ctx:     Ptr to the X509 certificate store structure  
 *
 * Return value:
 *   int: The potentially modified status after processing this certificate. This cane
 *        be modified by the ET client application if they've provided a callback
 *        allowing it to be processed, or modified here in this callback.
 */</comment>
<function pos:start="570:1" pos:end="687:1"><type pos:start="570:1" pos:end="570:10"><specifier pos:start="570:1" pos:end="570:6">static</specifier> <name pos:start="570:8" pos:end="570:10">int</name></type> <name pos:start="570:12" pos:end="570:25">cert_verify_cb</name> <parameter_list pos:start="570:27" pos:end="570:57">(<parameter pos:start="570:28" pos:end="570:33"><decl pos:start="570:28" pos:end="570:33"><type pos:start="570:28" pos:end="570:33"><name pos:start="570:28" pos:end="570:30">int</name></type> <name pos:start="570:32" pos:end="570:33">ok</name></decl></parameter>, <parameter pos:start="570:36" pos:end="570:56"><decl pos:start="570:36" pos:end="570:56"><type pos:start="570:36" pos:end="570:56"><name pos:start="570:36" pos:end="570:49">X509_STORE_CTX</name> <modifier pos:start="570:51" pos:end="570:51">*</modifier></type><name pos:start="570:52" pos:end="570:56">x_ctx</name></decl></parameter>)</parameter_list>
<block pos:start="571:1" pos:end="687:1">{<block_content pos:start="572:5" pos:end="686:21">
    <decl_stmt pos:start="572:5" pos:end="572:16"><decl pos:start="572:5" pos:end="572:15"><type pos:start="572:5" pos:end="572:12"><name pos:start="572:5" pos:end="572:7">SSL</name>    <modifier pos:start="572:12" pos:end="572:12">*</modifier></type><name pos:start="572:13" pos:end="572:15">ssl</name></decl>;</decl_stmt>
    <decl_stmt pos:start="573:5" pos:end="573:19"><decl pos:start="573:5" pos:end="573:18"><type pos:start="573:5" pos:end="573:13"><name pos:start="573:5" pos:end="573:11">EST_CTX</name> <modifier pos:start="573:13" pos:end="573:13">*</modifier></type><name pos:start="573:14" pos:end="573:18">e_ctx</name></decl>;</decl_stmt>
    <decl_stmt pos:start="574:5" pos:end="574:20"><decl pos:start="574:5" pos:end="574:19"><type pos:start="574:5" pos:end="574:7"><name pos:start="574:5" pos:end="574:7">int</name></type>     <name pos:start="574:13" pos:end="574:19">approve</name></decl>;</decl_stmt>
    <decl_stmt pos:start="575:5" pos:end="575:23"><decl pos:start="575:5" pos:end="575:22"><type pos:start="575:5" pos:end="575:7"><name pos:start="575:5" pos:end="575:7">int</name></type> <name pos:start="575:9" pos:end="575:18">cert_error</name> <init pos:start="575:20" pos:end="575:22">= <expr pos:start="575:22" pos:end="575:22"><literal type="number" pos:start="575:22" pos:end="575:22">0</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="576:5" pos:end="576:30"><decl pos:start="576:5" pos:end="576:29"><type pos:start="576:5" pos:end="576:10"><name pos:start="576:5" pos:end="576:8">X509</name> <modifier pos:start="576:10" pos:end="576:10">*</modifier></type><name pos:start="576:11" pos:end="576:22">current_cert</name> <init pos:start="576:24" pos:end="576:29">= <expr pos:start="576:26" pos:end="576:29"><name pos:start="576:26" pos:end="576:29">NULL</name></expr></init></decl>;</decl_stmt>

    <expr_stmt pos:start="578:5" pos:end="578:17"><expr pos:start="578:5" pos:end="578:16"><name pos:start="578:5" pos:end="578:11">approve</name> <operator pos:start="578:13" pos:end="578:13">=</operator> <name pos:start="578:15" pos:end="578:16">ok</name></expr>;</expr_stmt>
    
    <if_stmt pos:start="580:5" pos:end="583:5"><if pos:start="580:5" pos:end="583:5">if <condition pos:start="580:8" pos:end="580:22">(<expr pos:start="580:9" pos:end="580:21"><name pos:start="580:9" pos:end="580:13">x_ctx</name> <operator pos:start="580:15" pos:end="580:16">==</operator> <name pos:start="580:18" pos:end="580:21">NULL</name></expr>)</condition> <block pos:start="580:24" pos:end="583:5">{<block_content pos:start="581:9" pos:end="582:25">
        <expr_stmt pos:start="581:9" pos:end="581:52"><expr pos:start="581:9" pos:end="581:51"><call pos:start="581:9" pos:end="581:51"><name pos:start="581:9" pos:end="581:19">EST_LOG_ERR</name><argument_list pos:start="581:20" pos:end="581:51">(<argument pos:start="581:21" pos:end="581:50"><expr pos:start="581:21" pos:end="581:50"><literal type="string" pos:start="581:21" pos:end="581:50">"Invalid X509 context pointer"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="582:9" pos:end="582:25">return <expr pos:start="582:16" pos:end="582:24"><operator pos:start="582:16" pos:end="582:16">(</operator><name pos:start="582:17" pos:end="582:23">approve</name><operator pos:start="582:24" pos:end="582:24">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>    
    
    <expr_stmt pos:start="585:5" pos:end="585:49"><expr pos:start="585:5" pos:end="585:48"><name pos:start="585:5" pos:end="585:14">cert_error</name> <operator pos:start="585:16" pos:end="585:16">=</operator> <call pos:start="585:18" pos:end="585:48"><name pos:start="585:18" pos:end="585:41">X509_STORE_CTX_get_error</name><argument_list pos:start="585:42" pos:end="585:48">(<argument pos:start="585:43" pos:end="585:47"><expr pos:start="585:43" pos:end="585:47"><name pos:start="585:43" pos:end="585:47">x_ctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="586:5" pos:end="586:58"><expr pos:start="586:5" pos:end="586:57"><name pos:start="586:5" pos:end="586:16">current_cert</name> <operator pos:start="586:18" pos:end="586:18">=</operator> <call pos:start="586:20" pos:end="586:57"><name pos:start="586:20" pos:end="586:50">X509_STORE_CTX_get_current_cert</name><argument_list pos:start="586:51" pos:end="586:57">(<argument pos:start="586:52" pos:end="586:56"><expr pos:start="586:52" pos:end="586:56"><name pos:start="586:52" pos:end="586:56">x_ctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <expr_stmt pos:start="588:5" pos:end="589:72"><expr pos:start="588:5" pos:end="589:71"><call pos:start="588:5" pos:end="589:71"><name pos:start="588:5" pos:end="588:16">EST_LOG_INFO</name><argument_list pos:start="588:17" pos:end="589:71">(<argument pos:start="588:18" pos:end="588:76"><expr pos:start="588:18" pos:end="588:76"><literal type="string" pos:start="588:18" pos:end="588:76">"entering: Cert passed up from OpenSSL. error = %d (%s) \n"</literal></expr></argument>,
                 <argument pos:start="589:18" pos:end="589:27"><expr pos:start="589:18" pos:end="589:27"><name pos:start="589:18" pos:end="589:27">cert_error</name></expr></argument>, <argument pos:start="589:30" pos:end="589:70"><expr pos:start="589:30" pos:end="589:70"><call pos:start="589:30" pos:end="589:70"><name pos:start="589:30" pos:end="589:58">X509_verify_cert_error_string</name><argument_list pos:start="589:59" pos:end="589:70">(<argument pos:start="589:60" pos:end="589:69"><expr pos:start="589:60" pos:end="589:69"><name pos:start="589:60" pos:end="589:69">cert_error</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block" pos:start="591:5" pos:end="595:7">/*
     * Retrieve the pointer to the SSL structure for this connection and then
     * the application specific data stored into the SSL object.  This will be
     * our EST ctx for this EST session.
     */</comment>
    <if_stmt pos:start="596:5" pos:end="599:5"><if pos:start="596:5" pos:end="599:5">if <condition pos:start="596:8" pos:end="596:59">(<expr pos:start="596:9" pos:end="596:58"><name pos:start="596:9" pos:end="596:30">e_ctx_ssl_exdata_index</name> <operator pos:start="596:32" pos:end="596:33">==</operator> <name pos:start="596:35" pos:end="596:58">SSL_EXDATA_INDEX_INVALID</name></expr>)</condition> <block pos:start="596:61" pos:end="599:5">{<block_content pos:start="597:9" pos:end="598:25">
        <expr_stmt pos:start="597:9" pos:end="597:70"><expr pos:start="597:9" pos:end="597:69"><call pos:start="597:9" pos:end="597:69"><name pos:start="597:9" pos:end="597:19">EST_LOG_ERR</name><argument_list pos:start="597:20" pos:end="597:69">(<argument pos:start="597:21" pos:end="597:68"><expr pos:start="597:21" pos:end="597:68"><literal type="string" pos:start="597:21" pos:end="597:68">"Invalid SSL exdata index for EST context value"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="598:9" pos:end="598:25">return <expr pos:start="598:16" pos:end="598:24"><operator pos:start="598:16" pos:end="598:16">(</operator><name pos:start="598:17" pos:end="598:23">approve</name><operator pos:start="598:24" pos:end="598:24">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
        
    <expr_stmt pos:start="601:5" pos:end="601:82"><expr pos:start="601:5" pos:end="601:81"><name pos:start="601:5" pos:end="601:7">ssl</name> <operator pos:start="601:9" pos:end="601:9">=</operator> <call pos:start="601:11" pos:end="601:81"><name pos:start="601:11" pos:end="601:36">X509_STORE_CTX_get_ex_data</name><argument_list pos:start="601:37" pos:end="601:81">(<argument pos:start="601:38" pos:end="601:42"><expr pos:start="601:38" pos:end="601:42"><name pos:start="601:38" pos:end="601:42">x_ctx</name></expr></argument>, <argument pos:start="601:45" pos:end="601:80"><expr pos:start="601:45" pos:end="601:80"><call pos:start="601:45" pos:end="601:80"><name pos:start="601:45" pos:end="601:78">SSL_get_ex_data_X509_STORE_CTX_idx</name><argument_list pos:start="601:79" pos:end="601:80">()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="602:5" pos:end="605:5"><if pos:start="602:5" pos:end="605:5">if <condition pos:start="602:8" pos:end="602:13">(<expr pos:start="602:9" pos:end="602:12"><operator pos:start="602:9" pos:end="602:9">!</operator><name pos:start="602:10" pos:end="602:12">ssl</name></expr>)</condition> <block pos:start="602:15" pos:end="605:5">{<block_content pos:start="603:9" pos:end="604:25">
        <expr_stmt pos:start="603:9" pos:end="603:92"><expr pos:start="603:9" pos:end="603:91"><call pos:start="603:9" pos:end="603:91"><name pos:start="603:9" pos:end="603:19">EST_LOG_ERR</name><argument_list pos:start="603:20" pos:end="603:91">(<argument pos:start="603:21" pos:end="603:90"><expr pos:start="603:21" pos:end="603:90"><literal type="string" pos:start="603:21" pos:end="603:90">"NULL pointer retrieved for SSL session pointer from X509 ctx ex_data"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="604:9" pos:end="604:25">return <expr pos:start="604:16" pos:end="604:24"><operator pos:start="604:16" pos:end="604:16">(</operator><name pos:start="604:17" pos:end="604:23">approve</name><operator pos:start="604:24" pos:end="604:24">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>        
    <expr_stmt pos:start="606:5" pos:end="606:57"><expr pos:start="606:5" pos:end="606:56"><name pos:start="606:5" pos:end="606:9">e_ctx</name> <operator pos:start="606:11" pos:end="606:11">=</operator> <call pos:start="606:13" pos:end="606:56"><name pos:start="606:13" pos:end="606:27">SSL_get_ex_data</name><argument_list pos:start="606:28" pos:end="606:56">(<argument pos:start="606:29" pos:end="606:31"><expr pos:start="606:29" pos:end="606:31"><name pos:start="606:29" pos:end="606:31">ssl</name></expr></argument>, <argument pos:start="606:34" pos:end="606:55"><expr pos:start="606:34" pos:end="606:55"><name pos:start="606:34" pos:end="606:55">e_ctx_ssl_exdata_index</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="607:5" pos:end="610:5"><if pos:start="607:5" pos:end="610:5">if <condition pos:start="607:8" pos:end="607:15">(<expr pos:start="607:9" pos:end="607:14"><operator pos:start="607:9" pos:end="607:9">!</operator><name pos:start="607:10" pos:end="607:14">e_ctx</name></expr>)</condition> <block pos:start="607:17" pos:end="610:5">{<block_content pos:start="608:9" pos:end="609:25">
        <expr_stmt pos:start="608:9" pos:end="608:79"><expr pos:start="608:9" pos:end="608:78"><call pos:start="608:9" pos:end="608:78"><name pos:start="608:9" pos:end="608:19">EST_LOG_ERR</name><argument_list pos:start="608:20" pos:end="608:78">(<argument pos:start="608:21" pos:end="608:77"><expr pos:start="608:21" pos:end="608:77"><literal type="string" pos:start="608:21" pos:end="608:77">"NULL pointer retrieved for EST context from SSL ex_data"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="609:9" pos:end="609:25">return <expr pos:start="609:16" pos:end="609:24"><operator pos:start="609:16" pos:end="609:16">(</operator><name pos:start="609:17" pos:end="609:23">approve</name><operator pos:start="609:24" pos:end="609:24">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>        

    <if_stmt pos:start="612:5" pos:end="685:5"><if pos:start="612:5" pos:end="685:5">if <condition pos:start="612:8" pos:end="612:12">(<expr pos:start="612:9" pos:end="612:11"><operator pos:start="612:9" pos:end="612:9">!</operator><name pos:start="612:10" pos:end="612:11">ok</name></expr>)</condition> <block pos:start="612:14" pos:end="685:5">{<block_content pos:start="613:9" pos:end="684:9">
        <switch pos:start="613:9" pos:end="684:9">switch <condition pos:start="613:16" pos:end="613:27">(<expr pos:start="613:17" pos:end="613:26"><name pos:start="613:17" pos:end="613:26">cert_error</name></expr>)</condition> <block pos:start="613:29" pos:end="684:9">{<block_content pos:start="625:9" pos:end="683:18">

            <comment type="block" pos:start="615:13" pos:end="624:15">/*
             * Cases where we notify the client application:
             *
             * CERT_UNTRUSTED is what is expected, but not what we get in the
             * case where we cannot verify our server's cert.
             * SELF_SIGNED_CERT_IN_CHAIN is what currently results with our server
             * when we cannot verify its cert.
             * UNABLE_TO_GET_CRL is passed up to make sure the application knows
             * that although
             */</comment>
        <case pos:start="625:9" pos:end="625:39">case <expr pos:start="625:14" pos:end="625:38"><name pos:start="625:14" pos:end="625:38">X509_V_ERR_CERT_UNTRUSTED</name></expr>:</case>
        <case pos:start="626:9" pos:end="626:50">case <expr pos:start="626:14" pos:end="626:49"><name pos:start="626:14" pos:end="626:49">X509_V_ERR_SELF_SIGNED_CERT_IN_CHAIN</name></expr>:</case>  
        <case pos:start="627:9" pos:end="627:42">case <expr pos:start="627:14" pos:end="627:41"><name pos:start="627:14" pos:end="627:41">X509_V_ERR_UNABLE_TO_GET_CRL</name></expr>:</case>
            
            <comment type="block" pos:start="629:13" pos:end="633:15">/*
             * If the application provided a callback then go ahead and pass
             * this cert store up.  If not, then log a warning and return what
             * SSL gave us for a status.
             */</comment>            
            <if_stmt pos:start="634:13" pos:end="657:13"><if pos:start="634:13" pos:end="640:13">if <condition pos:start="634:16" pos:end="634:45">(<expr pos:start="634:17" pos:end="634:44"><name pos:start="634:17" pos:end="634:44"><name pos:start="634:17" pos:end="634:21">e_ctx</name><operator pos:start="634:22" pos:end="634:23">-&gt;</operator><name pos:start="634:24" pos:end="634:44">manual_cert_verify_cb</name></name></expr>)</condition> <block pos:start="634:47" pos:end="640:13">{<block_content pos:start="636:17" pos:end="638:81">
                
                <expr_stmt pos:start="636:17" pos:end="636:99"><expr pos:start="636:17" pos:end="636:98"><call pos:start="636:17" pos:end="636:98"><name pos:start="636:17" pos:end="636:28">EST_LOG_INFO</name><argument_list pos:start="636:29" pos:end="636:98">(<argument pos:start="636:30" pos:end="636:97"><expr pos:start="636:30" pos:end="636:97"><literal type="string" pos:start="636:30" pos:end="636:97">"EST client application server cert verify function is registered\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>

                <expr_stmt pos:start="638:17" pos:end="638:81"><expr pos:start="638:17" pos:end="638:80"><name pos:start="638:17" pos:end="638:23">approve</name> <operator pos:start="638:25" pos:end="638:25">=</operator> <call pos:start="638:27" pos:end="638:80"><name pos:start="638:27" pos:end="638:54"><name pos:start="638:27" pos:end="638:31">e_ctx</name><operator pos:start="638:32" pos:end="638:33">-&gt;</operator><name pos:start="638:34" pos:end="638:54">manual_cert_verify_cb</name></name><argument_list pos:start="638:55" pos:end="638:80">(<argument pos:start="638:56" pos:end="638:67"><expr pos:start="638:56" pos:end="638:67"><name pos:start="638:56" pos:end="638:67">current_cert</name></expr></argument>, <argument pos:start="638:70" pos:end="638:79"><expr pos:start="638:70" pos:end="638:79"><name pos:start="638:70" pos:end="638:79">cert_error</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                
            </block_content>}</block></if> <else pos:start="640:15" pos:end="657:13">else <block pos:start="640:20" pos:end="657:13">{<block_content pos:start="642:17" pos:end="656:17">
                                
                <expr_stmt pos:start="642:17" pos:end="642:99"><expr pos:start="642:17" pos:end="642:98"><call pos:start="642:17" pos:end="642:98"><name pos:start="642:17" pos:end="642:28">EST_LOG_INFO</name><argument_list pos:start="642:29" pos:end="642:98">(<argument pos:start="642:30" pos:end="642:97"><expr pos:start="642:30" pos:end="642:97"><literal type="string" pos:start="642:30" pos:end="642:97">"NO EST client application server cert verify function registered\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>

                <if_stmt pos:start="644:17" pos:end="656:17"><if pos:start="644:17" pos:end="656:17">if <condition pos:start="644:20" pos:end="644:63">(<expr pos:start="644:21" pos:end="644:62"><name pos:start="644:21" pos:end="644:30">cert_error</name> <operator pos:start="644:32" pos:end="644:33">==</operator> <name pos:start="644:35" pos:end="644:62">X509_V_ERR_UNABLE_TO_GET_CRL</name></expr>)</condition> <block pos:start="644:65" pos:end="656:17">{<block_content pos:start="654:21" pos:end="655:32">

                    <comment type="block" pos:start="646:21" pos:end="653:23">/*
                     * We've enabled CRL checking in the TLS stack.  If the
                     * application hasn't loaded a CRL, then this verify error
                     * can occur.  The peer's cert is valid, but we can't
                     * confirm if it was revoked.  The app has not provided
                     * a way for us to notify on this, so our only option is
                     * to log a warning and proceed on.
                     */</comment>
                    <expr_stmt pos:start="654:21" pos:end="654:77"><expr pos:start="654:21" pos:end="654:76"><call pos:start="654:21" pos:end="654:76"><name pos:start="654:21" pos:end="654:32">EST_LOG_WARN</name><argument_list pos:start="654:33" pos:end="654:76">(<argument pos:start="654:34" pos:end="654:75"><expr pos:start="654:34" pos:end="654:75"><literal type="string" pos:start="654:34" pos:end="654:75">"No CRL loaded, TLS peer will be allowed."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                    <expr_stmt pos:start="655:21" pos:end="655:32"><expr pos:start="655:21" pos:end="655:31"><name pos:start="655:21" pos:end="655:27">approve</name> <operator pos:start="655:29" pos:end="655:29">=</operator> <literal type="number" pos:start="655:31" pos:end="655:31">1</literal></expr>;</expr_stmt>
                </block_content>}</block></if></if_stmt>
            </block_content>}</block></else></if_stmt>
            <break pos:start="658:13" pos:end="658:18">break;</break>

        <comment type="block" pos:start="660:9" pos:end="662:11">/* The remainder of these will result in the ok state remaining unchanged
         * and a EST log warning message being logged.
         */</comment>
        <case pos:start="663:9" pos:end="663:43">case <expr pos:start="663:14" pos:end="663:42"><name pos:start="663:14" pos:end="663:42">X509_V_ERR_NO_EXPLICIT_POLICY</name></expr>:</case>
        <case pos:start="664:9" pos:end="664:41">case <expr pos:start="664:14" pos:end="664:40"><name pos:start="664:14" pos:end="664:40">X509_V_ERR_CERT_HAS_EXPIRED</name></expr>:</case>

        <comment type="block" pos:start="666:9" pos:end="669:11">/* since we are just checking the certificates, it is
         * ok if they are self signed. But we should still warn
         * the user.
         */</comment>
        <case pos:start="670:9" pos:end="670:52">case <expr pos:start="670:14" pos:end="670:51"><name pos:start="670:14" pos:end="670:51">X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT</name></expr>:</case>
        <comment type="block" pos:start="671:9" pos:end="671:49">/* Continue after extension errors too */</comment>
        <case pos:start="672:9" pos:end="672:35">case <expr pos:start="672:14" pos:end="672:34"><name pos:start="672:14" pos:end="672:34">X509_V_ERR_INVALID_CA</name></expr>:</case>
        <case pos:start="673:9" pos:end="673:39">case <expr pos:start="673:14" pos:end="673:38"><name pos:start="673:14" pos:end="673:38">X509_V_ERR_INVALID_NON_CA</name></expr>:</case>
        <case pos:start="674:9" pos:end="674:45">case <expr pos:start="674:14" pos:end="674:44"><name pos:start="674:14" pos:end="674:44">X509_V_ERR_PATH_LENGTH_EXCEEDED</name></expr>:</case>
        <case pos:start="675:9" pos:end="675:40">case <expr pos:start="675:14" pos:end="675:39"><name pos:start="675:14" pos:end="675:39">X509_V_ERR_INVALID_PURPOSE</name></expr>:</case>
        <case pos:start="676:9" pos:end="676:40">case <expr pos:start="676:14" pos:end="676:39"><name pos:start="676:14" pos:end="676:39">X509_V_ERR_CRL_HAS_EXPIRED</name></expr>:</case>
        <case pos:start="677:9" pos:end="677:42">case <expr pos:start="677:14" pos:end="677:41"><name pos:start="677:14" pos:end="677:41">X509_V_ERR_CRL_NOT_YET_VALID</name></expr>:</case>
        <case pos:start="678:9" pos:end="678:53">case <expr pos:start="678:14" pos:end="678:52"><name pos:start="678:14" pos:end="678:52">X509_V_ERR_UNHANDLED_CRITICAL_EXTENSION</name></expr>:</case>
        <case pos:start="679:9" pos:end="679:37">case <expr pos:start="679:14" pos:end="679:36"><name pos:start="679:14" pos:end="679:36">X509_V_ERR_CERT_REVOKED</name></expr>:</case>
        <default pos:start="680:9" pos:end="680:16">default:</default>
            <expr_stmt pos:start="681:13" pos:end="682:80"><expr pos:start="681:13" pos:end="682:79"><call pos:start="681:13" pos:end="682:79"><name pos:start="681:13" pos:end="681:24">EST_LOG_WARN</name><argument_list pos:start="681:25" pos:end="682:79">(<argument pos:start="681:26" pos:end="681:71"><expr pos:start="681:26" pos:end="681:71"><literal type="string" pos:start="681:26" pos:end="681:71">"Certificate verify failed (reason = %d) (%s)"</literal></expr></argument>,
                         <argument pos:start="682:26" pos:end="682:35"><expr pos:start="682:26" pos:end="682:35"><name pos:start="682:26" pos:end="682:35">cert_error</name></expr></argument>, <argument pos:start="682:38" pos:end="682:78"><expr pos:start="682:38" pos:end="682:78"><call pos:start="682:38" pos:end="682:78"><name pos:start="682:38" pos:end="682:66">X509_verify_cert_error_string</name><argument_list pos:start="682:67" pos:end="682:78">(<argument pos:start="682:68" pos:end="682:77"><expr pos:start="682:68" pos:end="682:77"><name pos:start="682:68" pos:end="682:77">cert_error</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <break pos:start="683:13" pos:end="683:18">break;</break>
        </block_content>}</block></switch>
    </block_content>}</block></if></if_stmt>
    <return pos:start="686:5" pos:end="686:21">return <expr pos:start="686:12" pos:end="686:20"><operator pos:start="686:12" pos:end="686:12">(</operator><name pos:start="686:13" pos:end="686:19">approve</name><operator pos:start="686:20" pos:end="686:20">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="688:1" pos:end="699:3">/*
 * This function is used to create and initialize an
 * SSL_CTX that will be used for client and proxy EST operations.
 * The SSL_CTX is stored on the EST_CTX.
 *
 * Parameters:
 *	ctx:	EST Context
 *
 * Return value:
 *	EST_ERROR
 *         EST_ERR_NONE if success
 */</comment>
<function pos:start="700:1" pos:end="799:1"><type pos:start="700:1" pos:end="700:16"><specifier pos:start="700:1" pos:end="700:6">static</specifier> <name pos:start="700:8" pos:end="700:16">EST_ERROR</name></type> <name pos:start="700:18" pos:end="700:40">est_client_init_ssl_ctx</name> <parameter_list pos:start="700:42" pos:end="700:55">(<parameter pos:start="700:43" pos:end="700:54"><decl pos:start="700:43" pos:end="700:54"><type pos:start="700:43" pos:end="700:51"><name pos:start="700:43" pos:end="700:49">EST_CTX</name> <modifier pos:start="700:51" pos:end="700:51">*</modifier></type><name pos:start="700:52" pos:end="700:54">ctx</name></decl></parameter>)</parameter_list>
<block pos:start="701:1" pos:end="799:1">{<block_content pos:start="702:5" pos:end="798:14">
    <decl_stmt pos:start="702:5" pos:end="702:23"><decl pos:start="702:5" pos:end="702:22"><type pos:start="702:5" pos:end="702:17"><name pos:start="702:5" pos:end="702:11">SSL_CTX</name>     <modifier pos:start="702:17" pos:end="702:17">*</modifier></type><name pos:start="702:18" pos:end="702:22">s_ctx</name></decl>;</decl_stmt>
    <decl_stmt pos:start="703:5" pos:end="703:34"><decl pos:start="703:5" pos:end="703:33"><type pos:start="703:5" pos:end="703:23"><name pos:start="703:5" pos:end="703:21">X509_VERIFY_PARAM</name> <modifier pos:start="703:23" pos:end="703:23">*</modifier></type><name pos:start="703:24" pos:end="703:26">vpm</name> <init pos:start="703:28" pos:end="703:33">= <expr pos:start="703:30" pos:end="703:33"><name pos:start="703:30" pos:end="703:33">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="704:5" pos:end="704:32"><decl pos:start="704:5" pos:end="704:31"><type pos:start="704:5" pos:end="704:13"><name pos:start="704:5" pos:end="704:13">EST_ERROR</name></type> <name pos:start="704:15" pos:end="704:16">rv</name> <init pos:start="704:18" pos:end="704:31">= <expr pos:start="704:20" pos:end="704:31"><name pos:start="704:20" pos:end="704:31">EST_ERR_NONE</name></expr></init></decl>;</decl_stmt>

    <expr_stmt pos:start="706:5" pos:end="706:22"><expr pos:start="706:5" pos:end="706:21"><call pos:start="706:5" pos:end="706:21"><name pos:start="706:5" pos:end="706:19">est_log_version</name><argument_list pos:start="706:20" pos:end="706:21">()</argument_list></call></expr>;</expr_stmt>

    <if_stmt pos:start="708:5" pos:end="711:5"><if pos:start="708:5" pos:end="711:5">if <condition pos:start="708:8" pos:end="708:20">(<expr pos:start="708:9" pos:end="708:19"><name pos:start="708:9" pos:end="708:11">ctx</name> <operator pos:start="708:13" pos:end="708:14">==</operator> <name pos:start="708:16" pos:end="708:19">NULL</name></expr>)</condition> <block pos:start="708:22" pos:end="711:5">{<block_content pos:start="709:9" pos:end="710:30">
        <expr_stmt pos:start="709:9" pos:end="709:47"><expr pos:start="709:9" pos:end="709:46"><call pos:start="709:9" pos:end="709:46"><name pos:start="709:9" pos:end="709:19">EST_LOG_ERR</name><argument_list pos:start="709:20" pos:end="709:46">(<argument pos:start="709:21" pos:end="709:45"><expr pos:start="709:21" pos:end="709:45"><literal type="string" pos:start="709:21" pos:end="709:45">"Invalid context pointer"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="710:9" pos:end="710:30">return <expr pos:start="710:16" pos:end="710:29"><name pos:start="710:16" pos:end="710:29">EST_ERR_NO_CTX</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
        
    <if_stmt pos:start="713:5" pos:end="717:5"><if pos:start="713:5" pos:end="717:5">if <condition pos:start="713:8" pos:end="713:62">(<expr pos:start="713:9" pos:end="713:61"><operator pos:start="713:9" pos:end="713:9">(</operator><name pos:start="713:10" pos:end="713:14">s_ctx</name> <operator pos:start="713:16" pos:end="713:16">=</operator> <call pos:start="713:18" pos:end="713:52"><name pos:start="713:18" pos:end="713:28">SSL_CTX_new</name><argument_list pos:start="713:29" pos:end="713:52">(<argument pos:start="713:30" pos:end="713:51"><expr pos:start="713:30" pos:end="713:51"><call pos:start="713:30" pos:end="713:51"><name pos:start="713:30" pos:end="713:49">SSLv23_client_method</name><argument_list pos:start="713:50" pos:end="713:51">()</argument_list></call></expr></argument>)</argument_list></call><operator pos:start="713:53" pos:end="713:53">)</operator> <operator pos:start="713:55" pos:end="713:56">==</operator> <name pos:start="713:58" pos:end="713:61">NULL</name></expr>)</condition> <block pos:start="713:64" pos:end="717:5">{<block_content pos:start="714:9" pos:end="716:35">
        <expr_stmt pos:start="714:9" pos:end="714:60"><expr pos:start="714:9" pos:end="714:59"><call pos:start="714:9" pos:end="714:59"><name pos:start="714:9" pos:end="714:19">EST_LOG_ERR</name><argument_list pos:start="714:20" pos:end="714:59">(<argument pos:start="714:21" pos:end="714:58"><expr pos:start="714:21" pos:end="714:58"><literal type="string" pos:start="714:21" pos:end="714:58">"Failed to obtain a new SSL Context\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="715:9" pos:end="715:31"><expr pos:start="715:9" pos:end="715:30"><call pos:start="715:9" pos:end="715:30"><name pos:start="715:9" pos:end="715:28">ossl_dump_ssl_errors</name><argument_list pos:start="715:29" pos:end="715:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="716:9" pos:end="716:35">return <expr pos:start="716:16" pos:end="716:34"><name pos:start="716:16" pos:end="716:34">EST_ERR_SSL_CTX_NEW</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="719:5" pos:end="721:7">/*
     * Only TLS 1.1 or above can be used for EST
     */</comment>
    <expr_stmt pos:start="722:5" pos:end="724:41"><expr pos:start="722:5" pos:end="724:40"><call pos:start="722:5" pos:end="724:40"><name pos:start="722:5" pos:end="722:23">SSL_CTX_set_options</name><argument_list pos:start="722:24" pos:end="724:40">(<argument pos:start="722:25" pos:end="722:29"><expr pos:start="722:25" pos:end="722:29"><name pos:start="722:25" pos:end="722:29">s_ctx</name></expr></argument>, <argument pos:start="722:32" pos:end="724:39"><expr pos:start="722:32" pos:end="724:39"><name pos:start="722:32" pos:end="722:46">SSL_OP_NO_SSLv2</name> <operator pos:start="722:48" pos:end="722:48">|</operator>
                        <name pos:start="723:25" pos:end="723:39">SSL_OP_NO_SSLv3</name> <operator pos:start="723:41" pos:end="723:41">|</operator>
                        <name pos:start="724:25" pos:end="724:39">SSL_OP_NO_TLSv1</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block" pos:start="726:5" pos:end="728:7">/*
     * limit the cipher suites that are offered
     */</comment>
    <if_stmt pos:start="729:5" pos:end="733:5"><if pos:start="729:5" pos:end="733:5">if <condition pos:start="729:8" pos:end="729:57">(<expr pos:start="729:9" pos:end="729:56"><operator pos:start="729:9" pos:end="729:9">!</operator><call pos:start="729:10" pos:end="729:56"><name pos:start="729:10" pos:end="729:32">SSL_CTX_set_cipher_list</name><argument_list pos:start="729:33" pos:end="729:56">(<argument pos:start="729:34" pos:end="729:38"><expr pos:start="729:34" pos:end="729:38"><name pos:start="729:34" pos:end="729:38">s_ctx</name></expr></argument>, <argument pos:start="729:41" pos:end="729:55"><expr pos:start="729:41" pos:end="729:55"><name pos:start="729:41" pos:end="729:55">EST_CIPHER_LIST</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="729:59" pos:end="733:5">{<block_content pos:start="730:9" pos:end="732:39"> 
        <expr_stmt pos:start="730:9" pos:end="730:57"><expr pos:start="730:9" pos:end="730:56"><call pos:start="730:9" pos:end="730:56"><name pos:start="730:9" pos:end="730:19">EST_LOG_ERR</name><argument_list pos:start="730:20" pos:end="730:56">(<argument pos:start="730:21" pos:end="730:55"><expr pos:start="730:21" pos:end="730:55"><literal type="string" pos:start="730:21" pos:end="730:55">"Failed to set SSL cipher suites\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="731:9" pos:end="731:31"><expr pos:start="731:9" pos:end="731:30"><call pos:start="731:9" pos:end="731:30"><name pos:start="731:9" pos:end="731:28">ossl_dump_ssl_errors</name><argument_list pos:start="731:29" pos:end="731:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="732:9" pos:end="732:39">return <expr pos:start="732:16" pos:end="732:38"><name pos:start="732:16" pos:end="732:38">EST_ERR_SSL_CIPHER_LIST</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="735:5" pos:end="737:7">/*
     * Make sure we're verifying the server
     */</comment>
    <expr_stmt pos:start="738:5" pos:end="739:39"><expr pos:start="738:5" pos:end="739:38"><call pos:start="738:5" pos:end="739:38"><name pos:start="738:5" pos:end="738:22">SSL_CTX_set_verify</name><argument_list pos:start="738:23" pos:end="739:38">(<argument pos:start="738:24" pos:end="738:28"><expr pos:start="738:24" pos:end="738:28"><name pos:start="738:24" pos:end="738:28">s_ctx</name></expr></argument>, <argument pos:start="738:31" pos:end="738:77"><expr pos:start="738:31" pos:end="738:77"><name pos:start="738:31" pos:end="738:45">SSL_VERIFY_PEER</name><operator pos:start="738:46" pos:end="738:46">|</operator><name pos:start="738:47" pos:end="738:77">SSL_VERIFY_FAIL_IF_NO_PEER_CERT</name></expr></argument>,
                       <argument pos:start="739:24" pos:end="739:37"><expr pos:start="739:24" pos:end="739:37"><name pos:start="739:24" pos:end="739:37">cert_verify_cb</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block" pos:start="741:5" pos:end="748:7">/*
     * leverage the cert store we already created from the
     * trusted CA chain provided by the application.
     *
     * In either case, the SSL stack will clean up the cert store during the
     * SSL_CTX_free(), so let's remove our reference to it so we don't try to
     * clean it up ourselves later
     */</comment>
    <expr_stmt pos:start="749:5" pos:end="749:60"><expr pos:start="749:5" pos:end="749:59"><call pos:start="749:5" pos:end="749:59"><name pos:start="749:5" pos:end="749:26">SSL_CTX_set_cert_store</name><argument_list pos:start="749:27" pos:end="749:59">(<argument pos:start="749:28" pos:end="749:32"><expr pos:start="749:28" pos:end="749:32"><name pos:start="749:28" pos:end="749:32">s_ctx</name></expr></argument>, <argument pos:start="749:35" pos:end="749:58"><expr pos:start="749:35" pos:end="749:58"><name pos:start="749:35" pos:end="749:58"><name pos:start="749:35" pos:end="749:37">ctx</name><operator pos:start="749:38" pos:end="749:39">-&gt;</operator><name pos:start="749:40" pos:end="749:58">trusted_certs_store</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="750:5" pos:end="750:36"><expr pos:start="750:5" pos:end="750:35"><name pos:start="750:5" pos:end="750:28"><name pos:start="750:5" pos:end="750:7">ctx</name><operator pos:start="750:8" pos:end="750:9">-&gt;</operator><name pos:start="750:10" pos:end="750:28">trusted_certs_store</name></name> <operator pos:start="750:30" pos:end="750:30">=</operator> <name pos:start="750:32" pos:end="750:35">NULL</name></expr>;</expr_stmt>        

    <comment type="block" pos:start="752:5" pos:end="758:7">/*
     * Set up X509 params and assign them to the SSL ctx
     * - Enable CRL checks
     * - Max # of untrusted CA certs that can exist in a chain
     * - ensure that the cert is being used as intended, if
     *   it contains the X509 KeyUsage extension
     */</comment>
    <expr_stmt pos:start="759:5" pos:end="759:34"><expr pos:start="759:5" pos:end="759:33"><name pos:start="759:5" pos:end="759:7">vpm</name> <operator pos:start="759:9" pos:end="759:9">=</operator> <call pos:start="759:11" pos:end="759:33"><name pos:start="759:11" pos:end="759:31">X509_VERIFY_PARAM_new</name><argument_list pos:start="759:32" pos:end="759:33">()</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="760:5" pos:end="764:5"><if pos:start="760:5" pos:end="764:5">if <condition pos:start="760:8" pos:end="760:20">(<expr pos:start="760:9" pos:end="760:19"><name pos:start="760:9" pos:end="760:11">vpm</name> <operator pos:start="760:13" pos:end="760:14">==</operator> <name pos:start="760:16" pos:end="760:19">NULL</name></expr>)</condition> <block pos:start="760:22" pos:end="764:5">{<block_content pos:start="761:9" pos:end="763:32">
        <expr_stmt pos:start="761:9" pos:end="761:71"><expr pos:start="761:9" pos:end="761:70"><call pos:start="761:9" pos:end="761:70"><name pos:start="761:9" pos:end="761:19">EST_LOG_ERR</name><argument_list pos:start="761:20" pos:end="761:70">(<argument pos:start="761:21" pos:end="761:69"><expr pos:start="761:21" pos:end="761:69"><literal type="string" pos:start="761:21" pos:end="761:69">"Unable to allocate a verify parameter structure"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="762:9" pos:end="762:31"><expr pos:start="762:9" pos:end="762:30"><call pos:start="762:9" pos:end="762:30"><name pos:start="762:9" pos:end="762:28">ossl_dump_ssl_errors</name><argument_list pos:start="762:29" pos:end="762:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="763:9" pos:end="763:32">return <expr pos:start="763:16" pos:end="763:31"><operator pos:start="763:16" pos:end="763:16">(</operator><name pos:start="763:17" pos:end="763:30">EST_ERR_MALLOC</name><operator pos:start="763:31" pos:end="763:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
        
    <comment type="block" pos:start="766:5" pos:end="766:27">/* Enable CRL checks */</comment>
    <if_stmt pos:start="767:5" pos:end="770:5"><if pos:start="767:5" pos:end="770:5">if <condition pos:start="767:8" pos:end="767:24">(<expr pos:start="767:9" pos:end="767:23"><name pos:start="767:9" pos:end="767:23"><name pos:start="767:9" pos:end="767:11">ctx</name><operator pos:start="767:12" pos:end="767:13">-&gt;</operator><name pos:start="767:14" pos:end="767:23">enable_crl</name></name></expr>)</condition> <block pos:start="767:26" pos:end="770:5">{<block_content pos:start="768:9" pos:end="769:63">
	<expr_stmt pos:start="768:9" pos:end="769:63"><expr pos:start="768:9" pos:end="769:62"><call pos:start="768:9" pos:end="769:62"><name pos:start="768:9" pos:end="768:35">X509_VERIFY_PARAM_set_flags</name><argument_list pos:start="768:36" pos:end="769:62">(<argument pos:start="768:37" pos:end="768:39"><expr pos:start="768:37" pos:end="768:39"><name pos:start="768:37" pos:end="768:39">vpm</name></expr></argument>, <argument pos:start="768:42" pos:end="769:61"><expr pos:start="768:42" pos:end="769:61"><name pos:start="768:42" pos:end="768:62">X509_V_FLAG_CRL_CHECK</name> <operator pos:start="768:64" pos:end="768:64">|</operator>
                                    <name pos:start="769:37" pos:end="769:61">X509_V_FLAG_CRL_CHECK_ALL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="771:5" pos:end="772:59"><expr pos:start="771:5" pos:end="772:58"><call pos:start="771:5" pos:end="772:58"><name pos:start="771:5" pos:end="771:31">X509_VERIFY_PARAM_set_flags</name><argument_list pos:start="771:32" pos:end="772:58">(<argument pos:start="771:33" pos:end="771:35"><expr pos:start="771:33" pos:end="771:35"><name pos:start="771:33" pos:end="771:35">vpm</name></expr></argument>, <argument pos:start="771:38" pos:end="772:57"><expr pos:start="771:38" pos:end="772:57"><name pos:start="771:38" pos:end="771:58">X509_V_FLAG_CRL_CHECK</name> <operator pos:start="771:60" pos:end="771:60">|</operator>
                                <name pos:start="772:33" pos:end="772:57">X509_V_FLAG_CRL_CHECK_ALL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="773:5" pos:end="773:59"><expr pos:start="773:5" pos:end="773:58"><call pos:start="773:5" pos:end="773:58"><name pos:start="773:5" pos:end="773:31">X509_VERIFY_PARAM_set_depth</name><argument_list pos:start="773:32" pos:end="773:58">(<argument pos:start="773:33" pos:end="773:35"><expr pos:start="773:33" pos:end="773:35"><name pos:start="773:33" pos:end="773:35">vpm</name></expr></argument>, <argument pos:start="773:38" pos:end="773:57"><expr pos:start="773:38" pos:end="773:57"><name pos:start="773:38" pos:end="773:57">EST_TLS_VERIFY_DEPTH</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <expr_stmt pos:start="775:5" pos:end="775:64"><expr pos:start="775:5" pos:end="775:63"><call pos:start="775:5" pos:end="775:63"><name pos:start="775:5" pos:end="775:33">X509_VERIFY_PARAM_set_purpose</name><argument_list pos:start="775:34" pos:end="775:63">(<argument pos:start="775:35" pos:end="775:37"><expr pos:start="775:35" pos:end="775:37"><name pos:start="775:35" pos:end="775:37">vpm</name></expr></argument>, <argument pos:start="775:40" pos:end="775:62"><expr pos:start="775:40" pos:end="775:62"><name pos:start="775:40" pos:end="775:62">X509_PURPOSE_SSL_SERVER</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <expr_stmt pos:start="777:5" pos:end="777:35"><expr pos:start="777:5" pos:end="777:34"><call pos:start="777:5" pos:end="777:34"><name pos:start="777:5" pos:end="777:22">SSL_CTX_set1_param</name><argument_list pos:start="777:23" pos:end="777:34">(<argument pos:start="777:24" pos:end="777:28"><expr pos:start="777:24" pos:end="777:28"><name pos:start="777:24" pos:end="777:28">s_ctx</name></expr></argument>, <argument pos:start="777:31" pos:end="777:33"><expr pos:start="777:31" pos:end="777:33"><name pos:start="777:31" pos:end="777:33">vpm</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="778:5" pos:end="778:32"><expr pos:start="778:5" pos:end="778:31"><call pos:start="778:5" pos:end="778:31"><name pos:start="778:5" pos:end="778:26">X509_VERIFY_PARAM_free</name><argument_list pos:start="778:27" pos:end="778:31">(<argument pos:start="778:28" pos:end="778:30"><expr pos:start="778:28" pos:end="778:30"><name pos:start="778:28" pos:end="778:30">vpm</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block" pos:start="780:5" pos:end="784:7">/*
     * Save the reference to the SSL session
     * This will be used later when matching the EST_CTX to the SSL context
     * in est_ssl_info_cb().
     */</comment>
    <expr_stmt pos:start="785:5" pos:end="785:25"><expr pos:start="785:5" pos:end="785:24"><name pos:start="785:5" pos:end="785:16"><name pos:start="785:5" pos:end="785:7">ctx</name><operator pos:start="785:8" pos:end="785:9">-&gt;</operator><name pos:start="785:10" pos:end="785:16">ssl_ctx</name></name> <operator pos:start="785:18" pos:end="785:18">=</operator> <name pos:start="785:20" pos:end="785:24">s_ctx</name></expr>;</expr_stmt>

    <if_stmt pos:start="787:5" pos:end="789:5"><if pos:start="787:5" pos:end="789:5">if <condition pos:start="787:8" pos:end="787:59">(<expr pos:start="787:9" pos:end="787:58"><name pos:start="787:9" pos:end="787:30">e_ctx_ssl_exdata_index</name> <operator pos:start="787:32" pos:end="787:33">==</operator> <name pos:start="787:35" pos:end="787:58">SSL_EXDATA_INDEX_INVALID</name></expr>)</condition> <block pos:start="787:61" pos:end="789:5">{<block_content pos:start="788:9" pos:end="788:90">
        <expr_stmt pos:start="788:9" pos:end="788:90"><expr pos:start="788:9" pos:end="788:89"><name pos:start="788:9" pos:end="788:30">e_ctx_ssl_exdata_index</name> <operator pos:start="788:32" pos:end="788:32">=</operator> <call pos:start="788:34" pos:end="788:89"><name pos:start="788:34" pos:end="788:53">SSL_get_ex_new_index</name><argument_list pos:start="788:54" pos:end="788:89">(<argument pos:start="788:55" pos:end="788:55"><expr pos:start="788:55" pos:end="788:55"><literal type="number" pos:start="788:55" pos:end="788:55">0</literal></expr></argument>, <argument pos:start="788:58" pos:end="788:70"><expr pos:start="788:58" pos:end="788:70"><literal type="string" pos:start="788:58" pos:end="788:70">"EST Context"</literal></expr></argument>, <argument pos:start="788:73" pos:end="788:76"><expr pos:start="788:73" pos:end="788:76"><name pos:start="788:73" pos:end="788:76">NULL</name></expr></argument>, <argument pos:start="788:79" pos:end="788:82"><expr pos:start="788:79" pos:end="788:82"><name pos:start="788:79" pos:end="788:82">NULL</name></expr></argument>, <argument pos:start="788:85" pos:end="788:88"><expr pos:start="788:85" pos:end="788:88"><name pos:start="788:85" pos:end="788:88">NULL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>    
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="791:5" pos:end="795:7">/*
     * This last config setting is not ctx based, but instead, global to the
     * entire libcrypto library.  Need to ensure that CSR string attributes
     * are added in ASCII printable format.
     */</comment>
    <expr_stmt pos:start="796:5" pos:end="796:51"><expr pos:start="796:5" pos:end="796:50"><call pos:start="796:5" pos:end="796:50"><name pos:start="796:5" pos:end="796:32">ASN1_STRING_set_default_mask</name><argument_list pos:start="796:33" pos:end="796:50">(<argument pos:start="796:34" pos:end="796:49"><expr pos:start="796:34" pos:end="796:49"><name pos:start="796:34" pos:end="796:49">B_ASN1_PRINTABLE</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    
    <return pos:start="798:5" pos:end="798:14">return <expr pos:start="798:12" pos:end="798:13"><name pos:start="798:12" pos:end="798:13">rv</name></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="800:1" pos:end="806:3">/*
 * This function calculates the digest value to be
 * used in HTTP requests when the server has asked
 * the client to use HTTP digest authentication.
 * It uses the tokens that were parsed from the HTTP
 * server response earlier to calculate the digest.
 */</comment>
<function pos:start="807:1" pos:end="885:1"><type pos:start="807:1" pos:end="807:22"><specifier pos:start="807:1" pos:end="807:6">static</specifier> <name pos:start="807:8" pos:end="807:15">unsigned</name> <name pos:start="807:17" pos:end="807:20">char</name> <modifier pos:start="807:22" pos:end="807:22">*</modifier></type><name pos:start="807:23" pos:end="807:53">est_client_generate_auth_digest</name> <parameter_list pos:start="807:55" pos:end="808:77">(<parameter pos:start="807:56" pos:end="807:67"><decl pos:start="807:56" pos:end="807:67"><type pos:start="807:56" pos:end="807:67"><name pos:start="807:56" pos:end="807:62">EST_CTX</name> <modifier pos:start="807:64" pos:end="807:64">*</modifier></type><name pos:start="807:65" pos:end="807:67">ctx</name></decl></parameter>, <parameter pos:start="807:70" pos:end="807:78"><decl pos:start="807:70" pos:end="807:78"><type pos:start="807:70" pos:end="807:78"><name pos:start="807:70" pos:end="807:73">char</name> <modifier pos:start="807:75" pos:end="807:75">*</modifier></type><name pos:start="807:76" pos:end="807:78">uri</name></decl></parameter>,
                                                       <parameter pos:start="808:56" pos:end="808:65"><decl pos:start="808:56" pos:end="808:65"><type pos:start="808:56" pos:end="808:65"><name pos:start="808:56" pos:end="808:59">char</name> <modifier pos:start="808:61" pos:end="808:61">*</modifier></type><name pos:start="808:62" pos:end="808:65">user</name></decl></parameter>, <parameter pos:start="808:68" pos:end="808:76"><decl pos:start="808:68" pos:end="808:76"><type pos:start="808:68" pos:end="808:76"><name pos:start="808:68" pos:end="808:71">char</name> <modifier pos:start="808:73" pos:end="808:73">*</modifier></type><name pos:start="808:74" pos:end="808:76">pwd</name></decl></parameter>)</parameter_list>
<block pos:start="809:1" pos:end="885:1">{<block_content pos:start="810:5" pos:end="884:16">
    <decl_stmt pos:start="810:5" pos:end="810:22"><decl pos:start="810:5" pos:end="810:21"><type pos:start="810:5" pos:end="810:16"><name pos:start="810:5" pos:end="810:14">EVP_MD_CTX</name> <modifier pos:start="810:16" pos:end="810:16">*</modifier></type><name pos:start="810:17" pos:end="810:21">mdctx</name></decl>;</decl_stmt>
    <decl_stmt pos:start="811:5" pos:end="811:33"><decl pos:start="811:5" pos:end="811:32"><type pos:start="811:5" pos:end="811:18"><specifier pos:start="811:5" pos:end="811:9">const</specifier> <name pos:start="811:11" pos:end="811:16">EVP_MD</name> <modifier pos:start="811:18" pos:end="811:18">*</modifier></type><name pos:start="811:19" pos:end="811:20">md</name> <init pos:start="811:22" pos:end="811:32">= <expr pos:start="811:24" pos:end="811:32"><call pos:start="811:24" pos:end="811:32"><name pos:start="811:24" pos:end="811:30">EVP_md5</name><argument_list pos:start="811:31" pos:end="811:32">()</argument_list></call></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="812:5" pos:end="812:33"><decl pos:start="812:5" pos:end="812:32"><type pos:start="812:5" pos:end="812:11"><name pos:start="812:5" pos:end="812:11">uint8_t</name></type> <name pos:start="812:13" pos:end="812:32"><name pos:start="812:13" pos:end="812:15">ha1</name><index pos:start="812:16" pos:end="812:32">[<expr pos:start="812:17" pos:end="812:31"><name pos:start="812:17" pos:end="812:31">EVP_MAX_MD_SIZE</name></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt pos:start="813:5" pos:end="813:25"><decl pos:start="813:5" pos:end="813:24"><type pos:start="813:5" pos:end="813:16"><name pos:start="813:5" pos:end="813:12">unsigned</name> <name pos:start="813:14" pos:end="813:16">int</name></type> <name pos:start="813:18" pos:end="813:24">ha1_len</name></decl>;</decl_stmt>
    <decl_stmt pos:start="814:5" pos:end="814:45"><decl pos:start="814:5" pos:end="814:44"><type pos:start="814:5" pos:end="814:8"><name pos:start="814:5" pos:end="814:8">char</name></type> <name pos:start="814:10" pos:end="814:44"><name pos:start="814:10" pos:end="814:16">ha1_str</name><index pos:start="814:17" pos:end="814:44">[<expr pos:start="814:18" pos:end="814:43"><name pos:start="814:18" pos:end="814:43">EST_MAX_MD5_DIGEST_STR_LEN</name></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt pos:start="815:5" pos:end="815:33"><decl pos:start="815:5" pos:end="815:32"><type pos:start="815:5" pos:end="815:11"><name pos:start="815:5" pos:end="815:11">uint8_t</name></type> <name pos:start="815:13" pos:end="815:32"><name pos:start="815:13" pos:end="815:15">ha2</name><index pos:start="815:16" pos:end="815:32">[<expr pos:start="815:17" pos:end="815:31"><name pos:start="815:17" pos:end="815:31">EVP_MAX_MD_SIZE</name></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt pos:start="816:5" pos:end="816:25"><decl pos:start="816:5" pos:end="816:24"><type pos:start="816:5" pos:end="816:16"><name pos:start="816:5" pos:end="816:12">unsigned</name> <name pos:start="816:14" pos:end="816:16">int</name></type> <name pos:start="816:18" pos:end="816:24">ha2_len</name></decl>;</decl_stmt>
    <decl_stmt pos:start="817:5" pos:end="817:45"><decl pos:start="817:5" pos:end="817:44"><type pos:start="817:5" pos:end="817:8"><name pos:start="817:5" pos:end="817:8">char</name></type> <name pos:start="817:10" pos:end="817:44"><name pos:start="817:10" pos:end="817:16">ha2_str</name><index pos:start="817:17" pos:end="817:44">[<expr pos:start="817:18" pos:end="817:43"><name pos:start="817:18" pos:end="817:43">EST_MAX_MD5_DIGEST_STR_LEN</name></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt pos:start="818:5" pos:end="818:35"><decl pos:start="818:5" pos:end="818:34"><type pos:start="818:5" pos:end="818:8"><name pos:start="818:5" pos:end="818:8">char</name></type> <name pos:start="818:10" pos:end="818:21"><name pos:start="818:10" pos:end="818:18">nonce_cnt</name><index pos:start="818:19" pos:end="818:21">[<expr pos:start="818:20" pos:end="818:20"><literal type="number" pos:start="818:20" pos:end="818:20">9</literal></expr>]</index></name> <init pos:start="818:23" pos:end="818:34">= <expr pos:start="818:25" pos:end="818:34"><literal type="string" pos:start="818:25" pos:end="818:34">"00000001"</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="819:5" pos:end="819:42"><decl pos:start="819:5" pos:end="819:41"><type pos:start="819:5" pos:end="819:17"><name pos:start="819:5" pos:end="819:12">unsigned</name> <name pos:start="819:14" pos:end="819:17">char</name></type> <name pos:start="819:19" pos:end="819:41"><name pos:start="819:19" pos:end="819:24">digest</name><index pos:start="819:25" pos:end="819:41">[<expr pos:start="819:26" pos:end="819:40"><name pos:start="819:26" pos:end="819:40">EVP_MAX_MD_SIZE</name></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt pos:start="820:5" pos:end="820:23"><decl pos:start="820:5" pos:end="820:22"><type pos:start="820:5" pos:end="820:16"><name pos:start="820:5" pos:end="820:12">unsigned</name> <name pos:start="820:14" pos:end="820:16">int</name></type> <name pos:start="820:18" pos:end="820:22">d_len</name></decl>;</decl_stmt>
    <decl_stmt pos:start="821:5" pos:end="821:22"><decl pos:start="821:5" pos:end="821:21"><type pos:start="821:5" pos:end="821:19"><name pos:start="821:5" pos:end="821:12">unsigned</name> <name pos:start="821:14" pos:end="821:17">char</name> <modifier pos:start="821:19" pos:end="821:19">*</modifier></type><name pos:start="821:20" pos:end="821:21">rv</name></decl>;</decl_stmt>

    <comment type="block" pos:start="823:5" pos:end="825:7">/*
     * Calculate HA1 using username, realm, password, and server nonce
     */</comment>
    <expr_stmt pos:start="826:5" pos:end="826:32"><expr pos:start="826:5" pos:end="826:31"><name pos:start="826:5" pos:end="826:9">mdctx</name> <operator pos:start="826:11" pos:end="826:11">=</operator> <call pos:start="826:13" pos:end="826:31"><name pos:start="826:13" pos:end="826:29">EVP_MD_CTX_create</name><argument_list pos:start="826:30" pos:end="826:31">()</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="827:5" pos:end="830:5"><if pos:start="827:5" pos:end="830:5">if <condition pos:start="827:8" pos:end="827:44">(<expr pos:start="827:9" pos:end="827:43"><operator pos:start="827:9" pos:end="827:9">!</operator><call pos:start="827:10" pos:end="827:43"><name pos:start="827:10" pos:end="827:26">EVP_DigestInit_ex</name><argument_list pos:start="827:27" pos:end="827:43">(<argument pos:start="827:28" pos:end="827:32"><expr pos:start="827:28" pos:end="827:32"><name pos:start="827:28" pos:end="827:32">mdctx</name></expr></argument>, <argument pos:start="827:35" pos:end="827:36"><expr pos:start="827:35" pos:end="827:36"><name pos:start="827:35" pos:end="827:36">md</name></expr></argument>, <argument pos:start="827:39" pos:end="827:42"><expr pos:start="827:39" pos:end="827:42"><name pos:start="827:39" pos:end="827:42">NULL</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="827:46" pos:end="830:5">{<block_content pos:start="828:9" pos:end="829:20">
        <expr_stmt pos:start="828:9" pos:end="828:51"><expr pos:start="828:9" pos:end="828:50"><call pos:start="828:9" pos:end="828:50"><name pos:start="828:9" pos:end="828:19">EST_LOG_ERR</name><argument_list pos:start="828:20" pos:end="828:50">(<argument pos:start="828:21" pos:end="828:49"><expr pos:start="828:21" pos:end="828:49"><literal type="string" pos:start="828:21" pos:end="828:49">"Unable to Initialize digest"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="829:9" pos:end="829:20">return <expr pos:start="829:16" pos:end="829:19"><name pos:start="829:16" pos:end="829:19">NULL</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="831:5" pos:end="831:63"><expr pos:start="831:5" pos:end="831:62"><call pos:start="831:5" pos:end="831:62"><name pos:start="831:5" pos:end="831:20">EVP_DigestUpdate</name><argument_list pos:start="831:21" pos:end="831:62">(<argument pos:start="831:22" pos:end="831:26"><expr pos:start="831:22" pos:end="831:26"><name pos:start="831:22" pos:end="831:26">mdctx</name></expr></argument>, <argument pos:start="831:29" pos:end="831:32"><expr pos:start="831:29" pos:end="831:32"><name pos:start="831:29" pos:end="831:32">user</name></expr></argument>, <argument pos:start="831:35" pos:end="831:61"><expr pos:start="831:35" pos:end="831:61"><call pos:start="831:35" pos:end="831:61"><name pos:start="831:35" pos:end="831:43">strnlen_s</name><argument_list pos:start="831:44" pos:end="831:61">(<argument pos:start="831:45" pos:end="831:48"><expr pos:start="831:45" pos:end="831:48"><name pos:start="831:45" pos:end="831:48">user</name></expr></argument>, <argument pos:start="831:51" pos:end="831:60"><expr pos:start="831:51" pos:end="831:60"><name pos:start="831:51" pos:end="831:60">MAX_UIDPWD</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="832:5" pos:end="832:36"><expr pos:start="832:5" pos:end="832:35"><call pos:start="832:5" pos:end="832:35"><name pos:start="832:5" pos:end="832:20">EVP_DigestUpdate</name><argument_list pos:start="832:21" pos:end="832:35">(<argument pos:start="832:22" pos:end="832:26"><expr pos:start="832:22" pos:end="832:26"><name pos:start="832:22" pos:end="832:26">mdctx</name></expr></argument>, <argument pos:start="832:29" pos:end="832:31"><expr pos:start="832:29" pos:end="832:31"><literal type="string" pos:start="832:29" pos:end="832:31">":"</literal></expr></argument>, <argument pos:start="832:34" pos:end="832:34"><expr pos:start="832:34" pos:end="832:34"><literal type="number" pos:start="832:34" pos:end="832:34">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="833:5" pos:end="833:74"><expr pos:start="833:5" pos:end="833:73"><call pos:start="833:5" pos:end="833:73"><name pos:start="833:5" pos:end="833:20">EVP_DigestUpdate</name><argument_list pos:start="833:21" pos:end="833:73">(<argument pos:start="833:22" pos:end="833:26"><expr pos:start="833:22" pos:end="833:26"><name pos:start="833:22" pos:end="833:26">mdctx</name></expr></argument>, <argument pos:start="833:29" pos:end="833:38"><expr pos:start="833:29" pos:end="833:38"><name pos:start="833:29" pos:end="833:38"><name pos:start="833:29" pos:end="833:31">ctx</name><operator pos:start="833:32" pos:end="833:33">-&gt;</operator><name pos:start="833:34" pos:end="833:38">realm</name></name></expr></argument>, <argument pos:start="833:41" pos:end="833:72"><expr pos:start="833:41" pos:end="833:72"><call pos:start="833:41" pos:end="833:72"><name pos:start="833:41" pos:end="833:49">strnlen_s</name><argument_list pos:start="833:50" pos:end="833:72">(<argument pos:start="833:51" pos:end="833:60"><expr pos:start="833:51" pos:end="833:60"><name pos:start="833:51" pos:end="833:60"><name pos:start="833:51" pos:end="833:53">ctx</name><operator pos:start="833:54" pos:end="833:55">-&gt;</operator><name pos:start="833:56" pos:end="833:60">realm</name></name></expr></argument>, <argument pos:start="833:63" pos:end="833:71"><expr pos:start="833:63" pos:end="833:71"><name pos:start="833:63" pos:end="833:71">MAX_REALM</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="834:5" pos:end="834:36"><expr pos:start="834:5" pos:end="834:35"><call pos:start="834:5" pos:end="834:35"><name pos:start="834:5" pos:end="834:20">EVP_DigestUpdate</name><argument_list pos:start="834:21" pos:end="834:35">(<argument pos:start="834:22" pos:end="834:26"><expr pos:start="834:22" pos:end="834:26"><name pos:start="834:22" pos:end="834:26">mdctx</name></expr></argument>, <argument pos:start="834:29" pos:end="834:31"><expr pos:start="834:29" pos:end="834:31"><literal type="string" pos:start="834:29" pos:end="834:31">":"</literal></expr></argument>, <argument pos:start="834:34" pos:end="834:34"><expr pos:start="834:34" pos:end="834:34"><literal type="number" pos:start="834:34" pos:end="834:34">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="835:5" pos:end="835:61"><expr pos:start="835:5" pos:end="835:60"><call pos:start="835:5" pos:end="835:60"><name pos:start="835:5" pos:end="835:20">EVP_DigestUpdate</name><argument_list pos:start="835:21" pos:end="835:60">(<argument pos:start="835:22" pos:end="835:26"><expr pos:start="835:22" pos:end="835:26"><name pos:start="835:22" pos:end="835:26">mdctx</name></expr></argument>, <argument pos:start="835:29" pos:end="835:31"><expr pos:start="835:29" pos:end="835:31"><name pos:start="835:29" pos:end="835:31">pwd</name></expr></argument>, <argument pos:start="835:34" pos:end="835:59"><expr pos:start="835:34" pos:end="835:59"><call pos:start="835:34" pos:end="835:59"><name pos:start="835:34" pos:end="835:42">strnlen_s</name><argument_list pos:start="835:43" pos:end="835:59">(<argument pos:start="835:44" pos:end="835:46"><expr pos:start="835:44" pos:end="835:46"><name pos:start="835:44" pos:end="835:46">pwd</name></expr></argument>, <argument pos:start="835:49" pos:end="835:58"><expr pos:start="835:49" pos:end="835:58"><name pos:start="835:49" pos:end="835:58">MAX_UIDPWD</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="836:5" pos:end="836:42"><expr pos:start="836:5" pos:end="836:41"><call pos:start="836:5" pos:end="836:41"><name pos:start="836:5" pos:end="836:19">EVP_DigestFinal</name><argument_list pos:start="836:20" pos:end="836:41">(<argument pos:start="836:21" pos:end="836:25"><expr pos:start="836:21" pos:end="836:25"><name pos:start="836:21" pos:end="836:25">mdctx</name></expr></argument>, <argument pos:start="836:28" pos:end="836:30"><expr pos:start="836:28" pos:end="836:30"><name pos:start="836:28" pos:end="836:30">ha1</name></expr></argument>, <argument pos:start="836:33" pos:end="836:40"><expr pos:start="836:33" pos:end="836:40"><operator pos:start="836:33" pos:end="836:33">&amp;</operator><name pos:start="836:34" pos:end="836:40">ha1_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="837:5" pos:end="837:30"><expr pos:start="837:5" pos:end="837:29"><call pos:start="837:5" pos:end="837:29"><name pos:start="837:5" pos:end="837:22">EVP_MD_CTX_destroy</name><argument_list pos:start="837:23" pos:end="837:29">(<argument pos:start="837:24" pos:end="837:28"><expr pos:start="837:24" pos:end="837:28"><name pos:start="837:24" pos:end="837:28">mdctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="838:5" pos:end="838:42"><expr pos:start="838:5" pos:end="838:41"><call pos:start="838:5" pos:end="838:41"><name pos:start="838:5" pos:end="838:18">est_hex_to_str</name><argument_list pos:start="838:19" pos:end="838:41">(<argument pos:start="838:20" pos:end="838:26"><expr pos:start="838:20" pos:end="838:26"><name pos:start="838:20" pos:end="838:26">ha1_str</name></expr></argument>, <argument pos:start="838:29" pos:end="838:31"><expr pos:start="838:29" pos:end="838:31"><name pos:start="838:29" pos:end="838:31">ha1</name></expr></argument>, <argument pos:start="838:34" pos:end="838:40"><expr pos:start="838:34" pos:end="838:40"><name pos:start="838:34" pos:end="838:40">ha1_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block" pos:start="840:5" pos:end="842:7">/*
     * Calculate HA2 using method, URI,
     */</comment>
    <expr_stmt pos:start="843:5" pos:end="843:32"><expr pos:start="843:5" pos:end="843:31"><name pos:start="843:5" pos:end="843:9">mdctx</name> <operator pos:start="843:11" pos:end="843:11">=</operator> <call pos:start="843:13" pos:end="843:31"><name pos:start="843:13" pos:end="843:29">EVP_MD_CTX_create</name><argument_list pos:start="843:30" pos:end="843:31">()</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="844:5" pos:end="847:5"><if pos:start="844:5" pos:end="847:5">if <condition pos:start="844:8" pos:end="844:44">(<expr pos:start="844:9" pos:end="844:43"><operator pos:start="844:9" pos:end="844:9">!</operator><call pos:start="844:10" pos:end="844:43"><name pos:start="844:10" pos:end="844:26">EVP_DigestInit_ex</name><argument_list pos:start="844:27" pos:end="844:43">(<argument pos:start="844:28" pos:end="844:32"><expr pos:start="844:28" pos:end="844:32"><name pos:start="844:28" pos:end="844:32">mdctx</name></expr></argument>, <argument pos:start="844:35" pos:end="844:36"><expr pos:start="844:35" pos:end="844:36"><name pos:start="844:35" pos:end="844:36">md</name></expr></argument>, <argument pos:start="844:39" pos:end="844:42"><expr pos:start="844:39" pos:end="844:42"><name pos:start="844:39" pos:end="844:42">NULL</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="844:46" pos:end="847:5">{<block_content pos:start="845:9" pos:end="846:20">
        <expr_stmt pos:start="845:9" pos:end="845:51"><expr pos:start="845:9" pos:end="845:50"><call pos:start="845:9" pos:end="845:50"><name pos:start="845:9" pos:end="845:19">EST_LOG_ERR</name><argument_list pos:start="845:20" pos:end="845:50">(<argument pos:start="845:21" pos:end="845:49"><expr pos:start="845:21" pos:end="845:49"><literal type="string" pos:start="845:21" pos:end="845:49">"Unable to Initialize digest"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="846:9" pos:end="846:20">return <expr pos:start="846:16" pos:end="846:19"><name pos:start="846:16" pos:end="846:19">NULL</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="848:5" pos:end="848:39"><expr pos:start="848:5" pos:end="848:38"><call pos:start="848:5" pos:end="848:38"><name pos:start="848:5" pos:end="848:20">EVP_DigestUpdate</name><argument_list pos:start="848:21" pos:end="848:38">(<argument pos:start="848:22" pos:end="848:26"><expr pos:start="848:22" pos:end="848:26"><name pos:start="848:22" pos:end="848:26">mdctx</name></expr></argument>, <argument pos:start="848:29" pos:end="848:34"><expr pos:start="848:29" pos:end="848:34"><literal type="string" pos:start="848:29" pos:end="848:34">"POST"</literal></expr></argument>, <argument pos:start="848:37" pos:end="848:37"><expr pos:start="848:37" pos:end="848:37"><literal type="number" pos:start="848:37" pos:end="848:37">4</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="849:5" pos:end="849:36"><expr pos:start="849:5" pos:end="849:35"><call pos:start="849:5" pos:end="849:35"><name pos:start="849:5" pos:end="849:20">EVP_DigestUpdate</name><argument_list pos:start="849:21" pos:end="849:35">(<argument pos:start="849:22" pos:end="849:26"><expr pos:start="849:22" pos:end="849:26"><name pos:start="849:22" pos:end="849:26">mdctx</name></expr></argument>, <argument pos:start="849:29" pos:end="849:31"><expr pos:start="849:29" pos:end="849:31"><literal type="string" pos:start="849:29" pos:end="849:31">":"</literal></expr></argument>, <argument pos:start="849:34" pos:end="849:34"><expr pos:start="849:34" pos:end="849:34"><literal type="number" pos:start="849:34" pos:end="849:34">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="850:5" pos:end="850:60"><expr pos:start="850:5" pos:end="850:59"><call pos:start="850:5" pos:end="850:59"><name pos:start="850:5" pos:end="850:20">EVP_DigestUpdate</name><argument_list pos:start="850:21" pos:end="850:59">(<argument pos:start="850:22" pos:end="850:26"><expr pos:start="850:22" pos:end="850:26"><name pos:start="850:22" pos:end="850:26">mdctx</name></expr></argument>, <argument pos:start="850:29" pos:end="850:31"><expr pos:start="850:29" pos:end="850:31"><name pos:start="850:29" pos:end="850:31">uri</name></expr></argument>, <argument pos:start="850:34" pos:end="850:58"><expr pos:start="850:34" pos:end="850:58"><call pos:start="850:34" pos:end="850:58"><name pos:start="850:34" pos:end="850:42">strnlen_s</name><argument_list pos:start="850:43" pos:end="850:58">(<argument pos:start="850:44" pos:end="850:46"><expr pos:start="850:44" pos:end="850:46"><name pos:start="850:44" pos:end="850:46">uri</name></expr></argument>, <argument pos:start="850:49" pos:end="850:57"><expr pos:start="850:49" pos:end="850:57"><name pos:start="850:49" pos:end="850:57">MAX_REALM</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="851:5" pos:end="851:42"><expr pos:start="851:5" pos:end="851:41"><call pos:start="851:5" pos:end="851:41"><name pos:start="851:5" pos:end="851:19">EVP_DigestFinal</name><argument_list pos:start="851:20" pos:end="851:41">(<argument pos:start="851:21" pos:end="851:25"><expr pos:start="851:21" pos:end="851:25"><name pos:start="851:21" pos:end="851:25">mdctx</name></expr></argument>, <argument pos:start="851:28" pos:end="851:30"><expr pos:start="851:28" pos:end="851:30"><name pos:start="851:28" pos:end="851:30">ha2</name></expr></argument>, <argument pos:start="851:33" pos:end="851:40"><expr pos:start="851:33" pos:end="851:40"><operator pos:start="851:33" pos:end="851:33">&amp;</operator><name pos:start="851:34" pos:end="851:40">ha2_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="852:5" pos:end="852:30"><expr pos:start="852:5" pos:end="852:29"><call pos:start="852:5" pos:end="852:29"><name pos:start="852:5" pos:end="852:22">EVP_MD_CTX_destroy</name><argument_list pos:start="852:23" pos:end="852:29">(<argument pos:start="852:24" pos:end="852:28"><expr pos:start="852:24" pos:end="852:28"><name pos:start="852:24" pos:end="852:28">mdctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="853:5" pos:end="853:42"><expr pos:start="853:5" pos:end="853:41"><call pos:start="853:5" pos:end="853:41"><name pos:start="853:5" pos:end="853:18">est_hex_to_str</name><argument_list pos:start="853:19" pos:end="853:41">(<argument pos:start="853:20" pos:end="853:26"><expr pos:start="853:20" pos:end="853:26"><name pos:start="853:20" pos:end="853:26">ha2_str</name></expr></argument>, <argument pos:start="853:29" pos:end="853:31"><expr pos:start="853:29" pos:end="853:31"><name pos:start="853:29" pos:end="853:31">ha2</name></expr></argument>, <argument pos:start="853:34" pos:end="853:40"><expr pos:start="853:34" pos:end="853:40"><name pos:start="853:34" pos:end="853:40">ha2_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block" pos:start="855:5" pos:end="857:7">/*
     * Calculate auth digest using HA1, nonce, nonce count, client nonce, qop, HA2
     */</comment>
    <expr_stmt pos:start="858:5" pos:end="858:32"><expr pos:start="858:5" pos:end="858:31"><name pos:start="858:5" pos:end="858:9">mdctx</name> <operator pos:start="858:11" pos:end="858:11">=</operator> <call pos:start="858:13" pos:end="858:31"><name pos:start="858:13" pos:end="858:29">EVP_MD_CTX_create</name><argument_list pos:start="858:30" pos:end="858:31">()</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="859:5" pos:end="862:5"><if pos:start="859:5" pos:end="862:5">if <condition pos:start="859:8" pos:end="859:44">(<expr pos:start="859:9" pos:end="859:43"><operator pos:start="859:9" pos:end="859:9">!</operator><call pos:start="859:10" pos:end="859:43"><name pos:start="859:10" pos:end="859:26">EVP_DigestInit_ex</name><argument_list pos:start="859:27" pos:end="859:43">(<argument pos:start="859:28" pos:end="859:32"><expr pos:start="859:28" pos:end="859:32"><name pos:start="859:28" pos:end="859:32">mdctx</name></expr></argument>, <argument pos:start="859:35" pos:end="859:36"><expr pos:start="859:35" pos:end="859:36"><name pos:start="859:35" pos:end="859:36">md</name></expr></argument>, <argument pos:start="859:39" pos:end="859:42"><expr pos:start="859:39" pos:end="859:42"><name pos:start="859:39" pos:end="859:42">NULL</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="859:46" pos:end="862:5">{<block_content pos:start="860:9" pos:end="861:20">
        <expr_stmt pos:start="860:9" pos:end="860:51"><expr pos:start="860:9" pos:end="860:50"><call pos:start="860:9" pos:end="860:50"><name pos:start="860:9" pos:end="860:19">EST_LOG_ERR</name><argument_list pos:start="860:20" pos:end="860:50">(<argument pos:start="860:21" pos:end="860:49"><expr pos:start="860:21" pos:end="860:49"><literal type="string" pos:start="860:21" pos:end="860:49">"Unable to Initialize digest"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="861:9" pos:end="861:20">return <expr pos:start="861:16" pos:end="861:19"><name pos:start="861:16" pos:end="861:19">NULL</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="863:5" pos:end="863:50"><expr pos:start="863:5" pos:end="863:49"><call pos:start="863:5" pos:end="863:49"><name pos:start="863:5" pos:end="863:20">EVP_DigestUpdate</name><argument_list pos:start="863:21" pos:end="863:49">(<argument pos:start="863:22" pos:end="863:26"><expr pos:start="863:22" pos:end="863:26"><name pos:start="863:22" pos:end="863:26">mdctx</name></expr></argument>, <argument pos:start="863:29" pos:end="863:35"><expr pos:start="863:29" pos:end="863:35"><name pos:start="863:29" pos:end="863:35">ha1_str</name></expr></argument>, <argument pos:start="863:38" pos:end="863:48"><expr pos:start="863:38" pos:end="863:48"><name pos:start="863:38" pos:end="863:44">ha1_len</name> <operator pos:start="863:46" pos:end="863:46">*</operator> <literal type="number" pos:start="863:48" pos:end="863:48">2</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="864:5" pos:end="864:36"><expr pos:start="864:5" pos:end="864:35"><call pos:start="864:5" pos:end="864:35"><name pos:start="864:5" pos:end="864:20">EVP_DigestUpdate</name><argument_list pos:start="864:21" pos:end="864:35">(<argument pos:start="864:22" pos:end="864:26"><expr pos:start="864:22" pos:end="864:26"><name pos:start="864:22" pos:end="864:26">mdctx</name></expr></argument>, <argument pos:start="864:29" pos:end="864:31"><expr pos:start="864:29" pos:end="864:31"><literal type="string" pos:start="864:29" pos:end="864:31">":"</literal></expr></argument>, <argument pos:start="864:34" pos:end="864:34"><expr pos:start="864:34" pos:end="864:34"><literal type="number" pos:start="864:34" pos:end="864:34">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="865:5" pos:end="865:78"><expr pos:start="865:5" pos:end="865:77"><call pos:start="865:5" pos:end="865:77"><name pos:start="865:5" pos:end="865:20">EVP_DigestUpdate</name><argument_list pos:start="865:21" pos:end="865:77">(<argument pos:start="865:22" pos:end="865:26"><expr pos:start="865:22" pos:end="865:26"><name pos:start="865:22" pos:end="865:26">mdctx</name></expr></argument>, <argument pos:start="865:29" pos:end="865:40"><expr pos:start="865:29" pos:end="865:40"><name pos:start="865:29" pos:end="865:40"><name pos:start="865:29" pos:end="865:31">ctx</name><operator pos:start="865:32" pos:end="865:33">-&gt;</operator><name pos:start="865:34" pos:end="865:40">s_nonce</name></name></expr></argument>, <argument pos:start="865:43" pos:end="865:76"><expr pos:start="865:43" pos:end="865:76"><call pos:start="865:43" pos:end="865:76"><name pos:start="865:43" pos:end="865:51">strnlen_s</name><argument_list pos:start="865:52" pos:end="865:76">(<argument pos:start="865:53" pos:end="865:64"><expr pos:start="865:53" pos:end="865:64"><name pos:start="865:53" pos:end="865:64"><name pos:start="865:53" pos:end="865:55">ctx</name><operator pos:start="865:56" pos:end="865:57">-&gt;</operator><name pos:start="865:58" pos:end="865:64">s_nonce</name></name></expr></argument>, <argument pos:start="865:67" pos:end="865:75"><expr pos:start="865:67" pos:end="865:75"><name pos:start="865:67" pos:end="865:75">MAX_NONCE</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="866:5" pos:end="866:36"><expr pos:start="866:5" pos:end="866:35"><call pos:start="866:5" pos:end="866:35"><name pos:start="866:5" pos:end="866:20">EVP_DigestUpdate</name><argument_list pos:start="866:21" pos:end="866:35">(<argument pos:start="866:22" pos:end="866:26"><expr pos:start="866:22" pos:end="866:26"><name pos:start="866:22" pos:end="866:26">mdctx</name></expr></argument>, <argument pos:start="866:29" pos:end="866:31"><expr pos:start="866:29" pos:end="866:31"><literal type="string" pos:start="866:29" pos:end="866:31">":"</literal></expr></argument>, <argument pos:start="866:34" pos:end="866:34"><expr pos:start="866:34" pos:end="866:34"><literal type="number" pos:start="866:34" pos:end="866:34">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="867:5" pos:end="867:69"><expr pos:start="867:5" pos:end="867:68"><call pos:start="867:5" pos:end="867:68"><name pos:start="867:5" pos:end="867:20">EVP_DigestUpdate</name><argument_list pos:start="867:21" pos:end="867:68">(<argument pos:start="867:22" pos:end="867:26"><expr pos:start="867:22" pos:end="867:26"><name pos:start="867:22" pos:end="867:26">mdctx</name></expr></argument>, <argument pos:start="867:29" pos:end="867:37"><expr pos:start="867:29" pos:end="867:37"><name pos:start="867:29" pos:end="867:37">nonce_cnt</name></expr></argument>, <argument pos:start="867:40" pos:end="867:67"><expr pos:start="867:40" pos:end="867:67"><call pos:start="867:40" pos:end="867:67"><name pos:start="867:40" pos:end="867:48">strnlen_s</name><argument_list pos:start="867:49" pos:end="867:67">(<argument pos:start="867:50" pos:end="867:58"><expr pos:start="867:50" pos:end="867:58"><name pos:start="867:50" pos:end="867:58">nonce_cnt</name></expr></argument>, <argument pos:start="867:61" pos:end="867:66"><expr pos:start="867:61" pos:end="867:66"><name pos:start="867:61" pos:end="867:66">MAX_NC</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="868:5" pos:end="868:36"><expr pos:start="868:5" pos:end="868:35"><call pos:start="868:5" pos:end="868:35"><name pos:start="868:5" pos:end="868:20">EVP_DigestUpdate</name><argument_list pos:start="868:21" pos:end="868:35">(<argument pos:start="868:22" pos:end="868:26"><expr pos:start="868:22" pos:end="868:26"><name pos:start="868:22" pos:end="868:26">mdctx</name></expr></argument>, <argument pos:start="868:29" pos:end="868:31"><expr pos:start="868:29" pos:end="868:31"><literal type="string" pos:start="868:29" pos:end="868:31">":"</literal></expr></argument>, <argument pos:start="868:34" pos:end="868:34"><expr pos:start="868:34" pos:end="868:34"><literal type="number" pos:start="868:34" pos:end="868:34">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="869:5" pos:end="869:78"><expr pos:start="869:5" pos:end="869:77"><call pos:start="869:5" pos:end="869:77"><name pos:start="869:5" pos:end="869:20">EVP_DigestUpdate</name><argument_list pos:start="869:21" pos:end="869:77">(<argument pos:start="869:22" pos:end="869:26"><expr pos:start="869:22" pos:end="869:26"><name pos:start="869:22" pos:end="869:26">mdctx</name></expr></argument>, <argument pos:start="869:29" pos:end="869:40"><expr pos:start="869:29" pos:end="869:40"><name pos:start="869:29" pos:end="869:40"><name pos:start="869:29" pos:end="869:31">ctx</name><operator pos:start="869:32" pos:end="869:33">-&gt;</operator><name pos:start="869:34" pos:end="869:40">c_nonce</name></name></expr></argument>, <argument pos:start="869:43" pos:end="869:76"><expr pos:start="869:43" pos:end="869:76"><call pos:start="869:43" pos:end="869:76"><name pos:start="869:43" pos:end="869:51">strnlen_s</name><argument_list pos:start="869:52" pos:end="869:76">(<argument pos:start="869:53" pos:end="869:64"><expr pos:start="869:53" pos:end="869:64"><name pos:start="869:53" pos:end="869:64"><name pos:start="869:53" pos:end="869:55">ctx</name><operator pos:start="869:56" pos:end="869:57">-&gt;</operator><name pos:start="869:58" pos:end="869:64">c_nonce</name></name></expr></argument>, <argument pos:start="869:67" pos:end="869:75"><expr pos:start="869:67" pos:end="869:75"><name pos:start="869:67" pos:end="869:75">MAX_NONCE</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="870:5" pos:end="870:36"><expr pos:start="870:5" pos:end="870:35"><call pos:start="870:5" pos:end="870:35"><name pos:start="870:5" pos:end="870:20">EVP_DigestUpdate</name><argument_list pos:start="870:21" pos:end="870:35">(<argument pos:start="870:22" pos:end="870:26"><expr pos:start="870:22" pos:end="870:26"><name pos:start="870:22" pos:end="870:26">mdctx</name></expr></argument>, <argument pos:start="870:29" pos:end="870:31"><expr pos:start="870:29" pos:end="870:31"><literal type="string" pos:start="870:29" pos:end="870:31">":"</literal></expr></argument>, <argument pos:start="870:34" pos:end="870:34"><expr pos:start="870:34" pos:end="870:34"><literal type="number" pos:start="870:34" pos:end="870:34">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="871:5" pos:end="871:39"><expr pos:start="871:5" pos:end="871:38"><call pos:start="871:5" pos:end="871:38"><name pos:start="871:5" pos:end="871:20">EVP_DigestUpdate</name><argument_list pos:start="871:21" pos:end="871:38">(<argument pos:start="871:22" pos:end="871:26"><expr pos:start="871:22" pos:end="871:26"><name pos:start="871:22" pos:end="871:26">mdctx</name></expr></argument>, <argument pos:start="871:29" pos:end="871:34"><expr pos:start="871:29" pos:end="871:34"><literal type="string" pos:start="871:29" pos:end="871:34">"auth"</literal></expr></argument>, <argument pos:start="871:37" pos:end="871:37"><expr pos:start="871:37" pos:end="871:37"><literal type="number" pos:start="871:37" pos:end="871:37">4</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="872:5" pos:end="872:36"><expr pos:start="872:5" pos:end="872:35"><call pos:start="872:5" pos:end="872:35"><name pos:start="872:5" pos:end="872:20">EVP_DigestUpdate</name><argument_list pos:start="872:21" pos:end="872:35">(<argument pos:start="872:22" pos:end="872:26"><expr pos:start="872:22" pos:end="872:26"><name pos:start="872:22" pos:end="872:26">mdctx</name></expr></argument>, <argument pos:start="872:29" pos:end="872:31"><expr pos:start="872:29" pos:end="872:31"><literal type="string" pos:start="872:29" pos:end="872:31">":"</literal></expr></argument>, <argument pos:start="872:34" pos:end="872:34"><expr pos:start="872:34" pos:end="872:34"><literal type="number" pos:start="872:34" pos:end="872:34">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="873:5" pos:end="873:50"><expr pos:start="873:5" pos:end="873:49"><call pos:start="873:5" pos:end="873:49"><name pos:start="873:5" pos:end="873:20">EVP_DigestUpdate</name><argument_list pos:start="873:21" pos:end="873:49">(<argument pos:start="873:22" pos:end="873:26"><expr pos:start="873:22" pos:end="873:26"><name pos:start="873:22" pos:end="873:26">mdctx</name></expr></argument>, <argument pos:start="873:29" pos:end="873:35"><expr pos:start="873:29" pos:end="873:35"><name pos:start="873:29" pos:end="873:35">ha2_str</name></expr></argument>, <argument pos:start="873:38" pos:end="873:48"><expr pos:start="873:38" pos:end="873:48"><name pos:start="873:38" pos:end="873:44">ha2_len</name> <operator pos:start="873:46" pos:end="873:46">*</operator> <literal type="number" pos:start="873:48" pos:end="873:48">2</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="874:5" pos:end="874:43"><expr pos:start="874:5" pos:end="874:42"><call pos:start="874:5" pos:end="874:42"><name pos:start="874:5" pos:end="874:19">EVP_DigestFinal</name><argument_list pos:start="874:20" pos:end="874:42">(<argument pos:start="874:21" pos:end="874:25"><expr pos:start="874:21" pos:end="874:25"><name pos:start="874:21" pos:end="874:25">mdctx</name></expr></argument>, <argument pos:start="874:28" pos:end="874:33"><expr pos:start="874:28" pos:end="874:33"><name pos:start="874:28" pos:end="874:33">digest</name></expr></argument>, <argument pos:start="874:36" pos:end="874:41"><expr pos:start="874:36" pos:end="874:41"><operator pos:start="874:36" pos:end="874:36">&amp;</operator><name pos:start="874:37" pos:end="874:41">d_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="875:5" pos:end="875:30"><expr pos:start="875:5" pos:end="875:29"><call pos:start="875:5" pos:end="875:29"><name pos:start="875:5" pos:end="875:22">EVP_MD_CTX_destroy</name><argument_list pos:start="875:23" pos:end="875:29">(<argument pos:start="875:24" pos:end="875:28"><expr pos:start="875:24" pos:end="875:28"><name pos:start="875:24" pos:end="875:28">mdctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <expr_stmt pos:start="877:5" pos:end="877:44"><expr pos:start="877:5" pos:end="877:43"><name pos:start="877:5" pos:end="877:6">rv</name> <operator pos:start="877:8" pos:end="877:8">=</operator> <call pos:start="877:10" pos:end="877:43"><name pos:start="877:10" pos:end="877:15">malloc</name><argument_list pos:start="877:16" pos:end="877:43">(<argument pos:start="877:17" pos:end="877:42"><expr pos:start="877:17" pos:end="877:42"><name pos:start="877:17" pos:end="877:42">EST_MAX_MD5_DIGEST_STR_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="878:5" pos:end="881:5"><if pos:start="878:5" pos:end="881:5">if <condition pos:start="878:8" pos:end="878:19">(<expr pos:start="878:9" pos:end="878:18"><name pos:start="878:9" pos:end="878:10">rv</name> <operator pos:start="878:12" pos:end="878:13">==</operator> <name pos:start="878:15" pos:end="878:18">NULL</name></expr>)</condition> <block pos:start="878:21" pos:end="881:5">{<block_content pos:start="879:9" pos:end="880:20">
        <expr_stmt pos:start="879:9" pos:end="879:60"><expr pos:start="879:9" pos:end="879:59"><call pos:start="879:9" pos:end="879:59"><name pos:start="879:9" pos:end="879:19">EST_LOG_ERR</name><argument_list pos:start="879:20" pos:end="879:59">(<argument pos:start="879:21" pos:end="879:58"><expr pos:start="879:21" pos:end="879:58"><literal type="string" pos:start="879:21" pos:end="879:58">"Unable to allocate memory for digest"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="880:9" pos:end="880:20">return <expr pos:start="880:16" pos:end="880:19"><name pos:start="880:16" pos:end="880:19">NULL</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    
    <expr_stmt pos:start="883:5" pos:end="883:46"><expr pos:start="883:5" pos:end="883:45"><call pos:start="883:5" pos:end="883:45"><name pos:start="883:5" pos:end="883:18">est_hex_to_str</name><argument_list pos:start="883:19" pos:end="883:45">(<argument pos:start="883:20" pos:end="883:29"><expr pos:start="883:20" pos:end="883:29"><operator pos:start="883:20" pos:end="883:20">(</operator><name pos:start="883:21" pos:end="883:24">char</name> <operator pos:start="883:26" pos:end="883:26">*</operator><operator pos:start="883:27" pos:end="883:27">)</operator><name pos:start="883:28" pos:end="883:29">rv</name></expr></argument>, <argument pos:start="883:32" pos:end="883:37"><expr pos:start="883:32" pos:end="883:37"><name pos:start="883:32" pos:end="883:37">digest</name></expr></argument>, <argument pos:start="883:40" pos:end="883:44"><expr pos:start="883:40" pos:end="883:44"><name pos:start="883:40" pos:end="883:44">d_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return pos:start="884:5" pos:end="884:16">return <expr pos:start="884:12" pos:end="884:15"><operator pos:start="884:12" pos:end="884:12">(</operator><name pos:start="884:13" pos:end="884:14">rv</name><operator pos:start="884:15" pos:end="884:15">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="886:1" pos:end="891:3">/*
 * est_client_retrieve_credentials() is used to retrieve the credentials when
 * the server has requested either BASIC or DIGEST mode.  The values needed from
 * the application layer in either mode are the same, username, password, but the
 * API will indicate the mode to the callback in case anything changes.
 */</comment>
<function pos:start="892:1" pos:end="950:1"><type pos:start="892:1" pos:end="892:11"><specifier pos:start="892:1" pos:end="892:6">static</specifier> <name pos:start="892:8" pos:end="892:11">void</name></type> <name pos:start="892:13" pos:end="892:43">est_client_retrieve_credentials</name> <parameter_list pos:start="892:45" pos:end="893:67">(<parameter pos:start="892:46" pos:end="892:57"><decl pos:start="892:46" pos:end="892:57"><type pos:start="892:46" pos:end="892:57"><name pos:start="892:46" pos:end="892:52">EST_CTX</name> <modifier pos:start="892:54" pos:end="892:54">*</modifier></type><name pos:start="892:55" pos:end="892:57">ctx</name></decl></parameter>, <parameter pos:start="892:60" pos:end="892:87"><decl pos:start="892:60" pos:end="892:87"><type pos:start="892:60" pos:end="892:87"><name pos:start="892:60" pos:end="892:77">EST_HTTP_AUTH_MODE</name></type> <name pos:start="892:79" pos:end="892:87">auth_mode</name></decl></parameter>,
                                             <parameter pos:start="893:46" pos:end="893:55"><decl pos:start="893:46" pos:end="893:55"><type pos:start="893:46" pos:end="893:55"><name pos:start="893:46" pos:end="893:49">char</name> <modifier pos:start="893:51" pos:end="893:51">*</modifier></type><name pos:start="893:52" pos:end="893:55">user</name></decl></parameter>, <parameter pos:start="893:58" pos:end="893:66"><decl pos:start="893:58" pos:end="893:66"><type pos:start="893:58" pos:end="893:66"><name pos:start="893:58" pos:end="893:61">char</name> <modifier pos:start="893:63" pos:end="893:63">*</modifier></type><name pos:start="893:64" pos:end="893:66">pwd</name></decl></parameter>)</parameter_list> 
<block pos:start="894:1" pos:end="950:1">{<block_content pos:start="895:5" pos:end="949:48">
    <decl_stmt pos:start="895:5" pos:end="895:39"><decl pos:start="895:5" pos:end="895:38"><type pos:start="895:5" pos:end="895:21"><name pos:start="895:5" pos:end="895:21">EST_HTTP_AUTH_HDR</name></type> <name pos:start="895:23" pos:end="895:38">auth_credentials</name></decl>;</decl_stmt>
    <decl_stmt pos:start="896:5" pos:end="896:29"><decl pos:start="896:5" pos:end="896:28"><type pos:start="896:5" pos:end="896:25"><name pos:start="896:5" pos:end="896:25">EST_HTTP_AUTH_CRED_RC</name></type> <name pos:start="896:27" pos:end="896:28">rc</name></decl>;</decl_stmt>
    
    <comment type="block" pos:start="898:5" pos:end="901:7">/*
     * See if we only have one part of them.  If so, reset the part we
     * have.
     */</comment>
    <if_stmt pos:start="902:5" pos:end="904:5"><if pos:start="902:5" pos:end="904:5">if <condition pos:start="902:8" pos:end="902:31">(<expr pos:start="902:9" pos:end="902:30"><name pos:start="902:9" pos:end="902:22"><name pos:start="902:9" pos:end="902:11">ctx</name><operator pos:start="902:12" pos:end="902:13">-&gt;</operator><name pos:start="902:14" pos:end="902:19">userid</name><index pos:start="902:20" pos:end="902:22">[<expr pos:start="902:21" pos:end="902:21"><literal type="number" pos:start="902:21" pos:end="902:21">0</literal></expr>]</index></name> <operator pos:start="902:24" pos:end="902:25">!=</operator> <literal type="char" pos:start="902:27" pos:end="902:30">'\0'</literal></expr>)</condition> <block pos:start="902:33" pos:end="904:5">{<block_content pos:start="903:9" pos:end="903:52">
        <expr_stmt pos:start="903:9" pos:end="903:52"><expr pos:start="903:9" pos:end="903:51"><call pos:start="903:9" pos:end="903:51"><name pos:start="903:9" pos:end="903:17">memzero_s</name><argument_list pos:start="903:18" pos:end="903:51">(<argument pos:start="903:19" pos:end="903:29"><expr pos:start="903:19" pos:end="903:29"><name pos:start="903:19" pos:end="903:29"><name pos:start="903:19" pos:end="903:21">ctx</name><operator pos:start="903:22" pos:end="903:23">-&gt;</operator><name pos:start="903:24" pos:end="903:29">userid</name></name></expr></argument>, <argument pos:start="903:32" pos:end="903:50"><expr pos:start="903:32" pos:end="903:50"><sizeof pos:start="903:32" pos:end="903:50">sizeof<argument_list pos:start="903:38" pos:end="903:50">(<argument pos:start="903:39" pos:end="903:49"><expr pos:start="903:39" pos:end="903:49"><name pos:start="903:39" pos:end="903:49"><name pos:start="903:39" pos:end="903:41">ctx</name><operator pos:start="903:42" pos:end="903:43">-&gt;</operator><name pos:start="903:44" pos:end="903:49">userid</name></name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
            
    <if_stmt pos:start="906:5" pos:end="908:5"><if pos:start="906:5" pos:end="908:5">if <condition pos:start="906:8" pos:end="906:33">(<expr pos:start="906:9" pos:end="906:32"><name pos:start="906:9" pos:end="906:24"><name pos:start="906:9" pos:end="906:11">ctx</name><operator pos:start="906:12" pos:end="906:13">-&gt;</operator><name pos:start="906:14" pos:end="906:21">password</name><index pos:start="906:22" pos:end="906:24">[<expr pos:start="906:23" pos:end="906:23"><literal type="number" pos:start="906:23" pos:end="906:23">0</literal></expr>]</index></name> <operator pos:start="906:26" pos:end="906:27">!=</operator> <literal type="char" pos:start="906:29" pos:end="906:32">'\0'</literal></expr>)</condition> <block pos:start="906:35" pos:end="908:5">{<block_content pos:start="907:9" pos:end="907:56">
        <expr_stmt pos:start="907:9" pos:end="907:56"><expr pos:start="907:9" pos:end="907:55"><call pos:start="907:9" pos:end="907:55"><name pos:start="907:9" pos:end="907:17">memzero_s</name><argument_list pos:start="907:18" pos:end="907:55">(<argument pos:start="907:19" pos:end="907:31"><expr pos:start="907:19" pos:end="907:31"><name pos:start="907:19" pos:end="907:31"><name pos:start="907:19" pos:end="907:21">ctx</name><operator pos:start="907:22" pos:end="907:23">-&gt;</operator><name pos:start="907:24" pos:end="907:31">password</name></name></expr></argument>, <argument pos:start="907:34" pos:end="907:54"><expr pos:start="907:34" pos:end="907:54"><sizeof pos:start="907:34" pos:end="907:54">sizeof<argument_list pos:start="907:40" pos:end="907:54">(<argument pos:start="907:41" pos:end="907:53"><expr pos:start="907:41" pos:end="907:53"><name pos:start="907:41" pos:end="907:53"><name pos:start="907:41" pos:end="907:43">ctx</name><operator pos:start="907:44" pos:end="907:45">-&gt;</operator><name pos:start="907:46" pos:end="907:53">password</name></name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
                
    <comment type="block" pos:start="910:5" pos:end="912:7">/*
     * Need to ask the application layer for the credentials
     */</comment>
    <expr_stmt pos:start="913:5" pos:end="913:59"><expr pos:start="913:5" pos:end="913:58"><call pos:start="913:5" pos:end="913:58"><name pos:start="913:5" pos:end="913:13">memzero_s</name><argument_list pos:start="913:14" pos:end="913:58">(<argument pos:start="913:15" pos:end="913:31"><expr pos:start="913:15" pos:end="913:31"><operator pos:start="913:15" pos:end="913:15">&amp;</operator><name pos:start="913:16" pos:end="913:31">auth_credentials</name></expr></argument>, <argument pos:start="913:34" pos:end="913:57"><expr pos:start="913:34" pos:end="913:57"><sizeof pos:start="913:34" pos:end="913:57">sizeof<argument_list pos:start="913:40" pos:end="913:57">(<argument pos:start="913:41" pos:end="913:56"><expr pos:start="913:41" pos:end="913:56"><name pos:start="913:41" pos:end="913:56">auth_credentials</name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            
    <if_stmt pos:start="915:5" pos:end="921:5"><if pos:start="915:5" pos:end="921:5">if <condition pos:start="915:8" pos:end="915:33">(<expr pos:start="915:9" pos:end="915:32"><name pos:start="915:9" pos:end="915:32"><name pos:start="915:9" pos:end="915:11">ctx</name><operator pos:start="915:12" pos:end="915:13">-&gt;</operator><name pos:start="915:14" pos:end="915:32">auth_credentials_cb</name></name></expr>)</condition> <block pos:start="915:35" pos:end="921:5">{<block_content pos:start="916:9" pos:end="920:9">
        <expr_stmt pos:start="916:9" pos:end="916:42"><expr pos:start="916:9" pos:end="916:41"><name pos:start="916:9" pos:end="916:29"><name pos:start="916:9" pos:end="916:24">auth_credentials</name><operator pos:start="916:25" pos:end="916:25">.</operator><name pos:start="916:26" pos:end="916:29">mode</name></name> <operator pos:start="916:31" pos:end="916:31">=</operator> <name pos:start="916:33" pos:end="916:41">auth_mode</name></expr>;</expr_stmt>
        <expr_stmt pos:start="917:9" pos:end="917:57"><expr pos:start="917:9" pos:end="917:56"><name pos:start="917:9" pos:end="917:10">rc</name> <operator pos:start="917:12" pos:end="917:12">=</operator> <call pos:start="917:14" pos:end="917:56"><name pos:start="917:14" pos:end="917:37"><name pos:start="917:14" pos:end="917:16">ctx</name><operator pos:start="917:17" pos:end="917:18">-&gt;</operator><name pos:start="917:19" pos:end="917:37">auth_credentials_cb</name></name><argument_list pos:start="917:38" pos:end="917:56">(<argument pos:start="917:39" pos:end="917:55"><expr pos:start="917:39" pos:end="917:55"><operator pos:start="917:39" pos:end="917:39">&amp;</operator><name pos:start="917:40" pos:end="917:55">auth_credentials</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="918:9" pos:end="920:9"><if pos:start="918:9" pos:end="920:9">if <condition pos:start="918:12" pos:end="918:51">(<expr pos:start="918:13" pos:end="918:50"><name pos:start="918:13" pos:end="918:14">rc</name> <operator pos:start="918:16" pos:end="918:17">==</operator> <name pos:start="918:19" pos:end="918:50">EST_HTTP_AUTH_CRED_NOT_AVAILABLE</name></expr>)</condition> <block pos:start="918:53" pos:end="920:9">{<block_content pos:start="919:13" pos:end="919:76">
            <expr_stmt pos:start="919:13" pos:end="919:76"><expr pos:start="919:13" pos:end="919:75"><call pos:start="919:13" pos:end="919:75"><name pos:start="919:13" pos:end="919:23">EST_LOG_ERR</name><argument_list pos:start="919:24" pos:end="919:75">(<argument pos:start="919:25" pos:end="919:74"><expr pos:start="919:25" pos:end="919:74"><literal type="string" pos:start="919:25" pos:end="919:74">"Attempt to obtain token from application failed."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></if></if_stmt>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="923:5" pos:end="926:7">/*
     * Did we get the credentials we expected?  If not, point to a NULL string
     * to generate the header
     */</comment>
    <if_stmt pos:start="927:5" pos:end="936:5"><if pos:start="927:5" pos:end="929:5">if <condition pos:start="927:8" pos:end="927:38">(<expr pos:start="927:9" pos:end="927:37"><name pos:start="927:9" pos:end="927:29"><name pos:start="927:9" pos:end="927:24">auth_credentials</name><operator pos:start="927:25" pos:end="927:25">.</operator><name pos:start="927:26" pos:end="927:29">user</name></name> <operator pos:start="927:31" pos:end="927:32">==</operator> <name pos:start="927:34" pos:end="927:37">NULL</name></expr>)</condition> <block pos:start="927:40" pos:end="929:5">{<block_content pos:start="928:9" pos:end="928:23">
        <expr_stmt pos:start="928:9" pos:end="928:23"><expr pos:start="928:9" pos:end="928:22"><name pos:start="928:9" pos:end="928:15"><name pos:start="928:9" pos:end="928:12">user</name><index pos:start="928:13" pos:end="928:15">[<expr pos:start="928:14" pos:end="928:14"><literal type="number" pos:start="928:14" pos:end="928:14">0</literal></expr>]</index></name> <operator pos:start="928:17" pos:end="928:17">=</operator> <literal type="char" pos:start="928:19" pos:end="928:22">'\0'</literal></expr>;</expr_stmt> 
    </block_content>}</block></if> <if type="elseif" pos:start="929:7" pos:end="932:5">else if <condition pos:start="929:15" pos:end="929:75">(<expr pos:start="929:16" pos:end="929:74"><name pos:start="929:16" pos:end="929:25">MAX_UIDPWD</name> <operator pos:start="929:27" pos:end="929:27">&lt;</operator> <call pos:start="929:29" pos:end="929:74"><name pos:start="929:29" pos:end="929:37">strnlen_s</name><argument_list pos:start="929:38" pos:end="929:74">(<argument pos:start="929:39" pos:end="929:59"><expr pos:start="929:39" pos:end="929:59"><name pos:start="929:39" pos:end="929:59"><name pos:start="929:39" pos:end="929:54">auth_credentials</name><operator pos:start="929:55" pos:end="929:55">.</operator><name pos:start="929:56" pos:end="929:59">user</name></name></expr></argument>, <argument pos:start="929:62" pos:end="929:73"><expr pos:start="929:62" pos:end="929:73"><name pos:start="929:62" pos:end="929:71">MAX_UIDPWD</name><operator pos:start="929:72" pos:end="929:72">+</operator><literal type="number" pos:start="929:73" pos:end="929:73">1</literal></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="929:77" pos:end="932:5">{<block_content pos:start="930:9" pos:end="931:23">
        <expr_stmt pos:start="930:9" pos:end="930:80"><expr pos:start="930:9" pos:end="930:79"><call pos:start="930:9" pos:end="930:79"><name pos:start="930:9" pos:end="930:19">EST_LOG_ERR</name><argument_list pos:start="930:20" pos:end="930:79">(<argument pos:start="930:21" pos:end="930:66"><expr pos:start="930:21" pos:end="930:66"><literal type="string" pos:start="930:21" pos:end="930:66">"Userid provided is larger than the max of %d"</literal></expr></argument>, <argument pos:start="930:69" pos:end="930:78"><expr pos:start="930:69" pos:end="930:78"><name pos:start="930:69" pos:end="930:78">MAX_UIDPWD</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="931:9" pos:end="931:23"><expr pos:start="931:9" pos:end="931:22"><name pos:start="931:9" pos:end="931:15"><name pos:start="931:9" pos:end="931:12">user</name><index pos:start="931:13" pos:end="931:15">[<expr pos:start="931:14" pos:end="931:14"><literal type="number" pos:start="931:14" pos:end="931:14">0</literal></expr>]</index></name> <operator pos:start="931:17" pos:end="931:17">=</operator> <literal type="char" pos:start="931:19" pos:end="931:22">'\0'</literal></expr>;</expr_stmt> 
    </block_content>}</block></if> <else pos:start="932:7" pos:end="936:5">else <block pos:start="932:12" pos:end="936:5">{<block_content pos:start="933:9" pos:end="935:9">
        <if_stmt pos:start="933:9" pos:end="935:9"><if pos:start="933:9" pos:end="935:9">if <condition pos:start="933:12" pos:end="933:82">(<expr pos:start="933:13" pos:end="933:81"><name pos:start="933:13" pos:end="933:15">EOK</name> <operator pos:start="933:17" pos:end="933:18">!=</operator> <call pos:start="933:20" pos:end="933:81"><name pos:start="933:20" pos:end="933:28">strncpy_s</name><argument_list pos:start="933:29" pos:end="933:81">(<argument pos:start="933:30" pos:end="933:33"><expr pos:start="933:30" pos:end="933:33"><name pos:start="933:30" pos:end="933:33">user</name></expr></argument>, <argument pos:start="933:36" pos:end="933:45"><expr pos:start="933:36" pos:end="933:45"><name pos:start="933:36" pos:end="933:45">MAX_UIDPWD</name></expr></argument>, <argument pos:start="933:48" pos:end="933:68"><expr pos:start="933:48" pos:end="933:68"><name pos:start="933:48" pos:end="933:68"><name pos:start="933:48" pos:end="933:63">auth_credentials</name><operator pos:start="933:64" pos:end="933:64">.</operator><name pos:start="933:65" pos:end="933:68">user</name></name></expr></argument>, <argument pos:start="933:71" pos:end="933:80"><expr pos:start="933:71" pos:end="933:80"><name pos:start="933:71" pos:end="933:80">MAX_UIDPWD</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="933:84" pos:end="935:9">{<block_content pos:start="934:13" pos:end="934:52">
            <expr_stmt pos:start="934:13" pos:end="934:52"><expr pos:start="934:13" pos:end="934:51"><call pos:start="934:13" pos:end="934:51"><name pos:start="934:13" pos:end="934:23">EST_LOG_ERR</name><argument_list pos:start="934:24" pos:end="934:51">(<argument pos:start="934:25" pos:end="934:50"><expr pos:start="934:25" pos:end="934:50"><literal type="string" pos:start="934:25" pos:end="934:50">"Invalid User ID provided"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></if></if_stmt>
    </block_content>}</block></else></if_stmt>
    
    <if_stmt pos:start="938:5" pos:end="947:5"><if pos:start="938:5" pos:end="940:5">if <condition pos:start="938:8" pos:end="938:37">(<expr pos:start="938:9" pos:end="938:36"><name pos:start="938:9" pos:end="938:28"><name pos:start="938:9" pos:end="938:24">auth_credentials</name><operator pos:start="938:25" pos:end="938:25">.</operator><name pos:start="938:26" pos:end="938:28">pwd</name></name> <operator pos:start="938:30" pos:end="938:31">==</operator> <name pos:start="938:33" pos:end="938:36">NULL</name></expr>)</condition> <block pos:start="938:39" pos:end="940:5">{<block_content pos:start="939:9" pos:end="939:22">
        <expr_stmt pos:start="939:9" pos:end="939:22"><expr pos:start="939:9" pos:end="939:21"><name pos:start="939:9" pos:end="939:14"><name pos:start="939:9" pos:end="939:11">pwd</name><index pos:start="939:12" pos:end="939:14">[<expr pos:start="939:13" pos:end="939:13"><literal type="number" pos:start="939:13" pos:end="939:13">0</literal></expr>]</index></name> <operator pos:start="939:16" pos:end="939:16">=</operator> <literal type="char" pos:start="939:18" pos:end="939:21">'\0'</literal></expr>;</expr_stmt> 
    </block_content>}</block></if> <if type="elseif" pos:start="940:7" pos:end="943:5">else if <condition pos:start="940:15" pos:end="940:74">(<expr pos:start="940:16" pos:end="940:73"><name pos:start="940:16" pos:end="940:25">MAX_UIDPWD</name> <operator pos:start="940:27" pos:end="940:27">&lt;</operator> <call pos:start="940:29" pos:end="940:73"><name pos:start="940:29" pos:end="940:37">strnlen_s</name><argument_list pos:start="940:38" pos:end="940:73">(<argument pos:start="940:39" pos:end="940:58"><expr pos:start="940:39" pos:end="940:58"><name pos:start="940:39" pos:end="940:58"><name pos:start="940:39" pos:end="940:54">auth_credentials</name><operator pos:start="940:55" pos:end="940:55">.</operator><name pos:start="940:56" pos:end="940:58">pwd</name></name></expr></argument>, <argument pos:start="940:61" pos:end="940:72"><expr pos:start="940:61" pos:end="940:72"><name pos:start="940:61" pos:end="940:70">MAX_UIDPWD</name><operator pos:start="940:71" pos:end="940:71">+</operator><literal type="number" pos:start="940:72" pos:end="940:72">1</literal></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="940:76" pos:end="943:5">{<block_content pos:start="941:9" pos:end="942:22">
        <expr_stmt pos:start="941:9" pos:end="941:82"><expr pos:start="941:9" pos:end="941:81"><call pos:start="941:9" pos:end="941:81"><name pos:start="941:9" pos:end="941:19">EST_LOG_ERR</name><argument_list pos:start="941:20" pos:end="941:81">(<argument pos:start="941:21" pos:end="941:68"><expr pos:start="941:21" pos:end="941:68"><literal type="string" pos:start="941:21" pos:end="941:68">"Password provided is larger than the max of %d"</literal></expr></argument>, <argument pos:start="941:71" pos:end="941:80"><expr pos:start="941:71" pos:end="941:80"><name pos:start="941:71" pos:end="941:80">MAX_UIDPWD</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="942:9" pos:end="942:22"><expr pos:start="942:9" pos:end="942:21"><name pos:start="942:9" pos:end="942:14"><name pos:start="942:9" pos:end="942:11">pwd</name><index pos:start="942:12" pos:end="942:14">[<expr pos:start="942:13" pos:end="942:13"><literal type="number" pos:start="942:13" pos:end="942:13">0</literal></expr>]</index></name> <operator pos:start="942:16" pos:end="942:16">=</operator> <literal type="char" pos:start="942:18" pos:end="942:21">'\0'</literal></expr>;</expr_stmt> 
    </block_content>}</block></if> <else pos:start="943:7" pos:end="947:5">else <block pos:start="943:12" pos:end="947:5">{<block_content pos:start="944:9" pos:end="946:9">
        <if_stmt pos:start="944:9" pos:end="946:9"><if pos:start="944:9" pos:end="946:9">if <condition pos:start="944:12" pos:end="944:80">(<expr pos:start="944:13" pos:end="944:79"><name pos:start="944:13" pos:end="944:15">EOK</name> <operator pos:start="944:17" pos:end="944:18">!=</operator> <call pos:start="944:20" pos:end="944:79"><name pos:start="944:20" pos:end="944:28">strncpy_s</name><argument_list pos:start="944:29" pos:end="944:79">(<argument pos:start="944:30" pos:end="944:32"><expr pos:start="944:30" pos:end="944:32"><name pos:start="944:30" pos:end="944:32">pwd</name></expr></argument>, <argument pos:start="944:35" pos:end="944:44"><expr pos:start="944:35" pos:end="944:44"><name pos:start="944:35" pos:end="944:44">MAX_UIDPWD</name></expr></argument>, <argument pos:start="944:47" pos:end="944:66"><expr pos:start="944:47" pos:end="944:66"><name pos:start="944:47" pos:end="944:66"><name pos:start="944:47" pos:end="944:62">auth_credentials</name><operator pos:start="944:63" pos:end="944:63">.</operator><name pos:start="944:64" pos:end="944:66">pwd</name></name></expr></argument>, <argument pos:start="944:69" pos:end="944:78"><expr pos:start="944:69" pos:end="944:78"><name pos:start="944:69" pos:end="944:78">MAX_UIDPWD</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="944:82" pos:end="946:9">{<block_content pos:start="945:13" pos:end="945:58">
            <expr_stmt pos:start="945:13" pos:end="945:58"><expr pos:start="945:13" pos:end="945:57"><call pos:start="945:13" pos:end="945:57"><name pos:start="945:13" pos:end="945:23">EST_LOG_ERR</name><argument_list pos:start="945:24" pos:end="945:57">(<argument pos:start="945:25" pos:end="945:56"><expr pos:start="945:25" pos:end="945:56"><literal type="string" pos:start="945:25" pos:end="945:56">"Invalid User password provided"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></if></if_stmt>
    </block_content>}</block></else></if_stmt>

    <expr_stmt pos:start="949:5" pos:end="949:48"><expr pos:start="949:5" pos:end="949:47"><call pos:start="949:5" pos:end="949:47"><name pos:start="949:5" pos:end="949:28">cleanse_auth_credentials</name><argument_list pos:start="949:29" pos:end="949:47">(<argument pos:start="949:30" pos:end="949:46"><expr pos:start="949:30" pos:end="949:46"><operator pos:start="949:30" pos:end="949:30">&amp;</operator><name pos:start="949:31" pos:end="949:46">auth_credentials</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>    
</block_content>}</block></function>
<comment type="block" pos:start="951:1" pos:end="960:3">/*
 * This function adds the HTTP authentication header to
 * an outgoing HTTP request, allowing the server to
 * authenticate the EST client.
 *
 * Parameters:
 *	ctx:	    EST context
 *	hdr:        pointer to the buffer to hold the header
 *      uri:        pointer to a buffer that holds the uri to be used in the header
 */</comment>
<function pos:start="961:1" pos:end="1141:1"><type pos:start="961:1" pos:end="961:11"><specifier pos:start="961:1" pos:end="961:6">static</specifier> <name pos:start="961:8" pos:end="961:11">void</name></type> <name pos:start="961:13" pos:end="961:35">est_client_add_auth_hdr</name> <parameter_list pos:start="961:37" pos:end="961:72">(<parameter pos:start="961:38" pos:end="961:49"><decl pos:start="961:38" pos:end="961:49"><type pos:start="961:38" pos:end="961:49"><name pos:start="961:38" pos:end="961:44">EST_CTX</name> <modifier pos:start="961:46" pos:end="961:46">*</modifier></type><name pos:start="961:47" pos:end="961:49">ctx</name></decl></parameter>, <parameter pos:start="961:52" pos:end="961:60"><decl pos:start="961:52" pos:end="961:60"><type pos:start="961:52" pos:end="961:60"><name pos:start="961:52" pos:end="961:55">char</name> <modifier pos:start="961:57" pos:end="961:57">*</modifier></type><name pos:start="961:58" pos:end="961:60">hdr</name></decl></parameter>, <parameter pos:start="961:63" pos:end="961:71"><decl pos:start="961:63" pos:end="961:71"><type pos:start="961:63" pos:end="961:71"><name pos:start="961:63" pos:end="961:66">char</name> <modifier pos:start="961:68" pos:end="961:68">*</modifier></type><name pos:start="961:69" pos:end="961:71">uri</name></decl></parameter>)</parameter_list>
<block pos:start="962:1" pos:end="1141:1">{<block_content pos:start="963:5" pos:end="1140:5">
    <decl_stmt pos:start="963:5" pos:end="963:16"><decl pos:start="963:5" pos:end="963:15"><type pos:start="963:5" pos:end="963:7"><name pos:start="963:5" pos:end="963:7">int</name></type> <name pos:start="963:9" pos:end="963:15">hdr_len</name></decl>;</decl_stmt>
    <decl_stmt pos:start="964:5" pos:end="964:26"><decl pos:start="964:5" pos:end="964:25"><type pos:start="964:5" pos:end="964:19"><name pos:start="964:5" pos:end="964:12">unsigned</name> <name pos:start="964:14" pos:end="964:17">char</name> <modifier pos:start="964:19" pos:end="964:19">*</modifier></type><name pos:start="964:20" pos:end="964:25">digest</name></decl>;</decl_stmt>
    <decl_stmt pos:start="965:5" pos:end="965:35"><decl pos:start="965:5" pos:end="965:34"><type pos:start="965:5" pos:end="965:17"><name pos:start="965:5" pos:end="965:12">unsigned</name> <name pos:start="965:14" pos:end="965:17">char</name></type> <name pos:start="965:19" pos:end="965:34"><name pos:start="965:19" pos:end="965:31">client_random</name><index pos:start="965:32" pos:end="965:34">[<expr pos:start="965:33" pos:end="965:33"><literal type="number" pos:start="965:33" pos:end="965:33">8</literal></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt pos:start="966:5" pos:end="966:30"><decl pos:start="966:5" pos:end="966:29"><type pos:start="966:5" pos:end="966:8"><name pos:start="966:5" pos:end="966:8">char</name></type> <name pos:start="966:10" pos:end="966:29"><name pos:start="966:10" pos:end="966:13">both</name><index pos:start="966:14" pos:end="966:29">[<expr pos:start="966:15" pos:end="966:28"><name pos:start="966:15" pos:end="966:24">MAX_UIDPWD</name><operator pos:start="966:25" pos:end="966:25">*</operator><literal type="number" pos:start="966:26" pos:end="966:26">2</literal><operator pos:start="966:27" pos:end="966:27">+</operator><literal type="number" pos:start="966:28" pos:end="966:28">2</literal></expr>]</index></name></decl>;</decl_stmt> <comment type="block" pos:start="966:32" pos:end="966:64">/* both UID and PWD + ":" + /0 */</comment>
    <decl_stmt pos:start="967:5" pos:end="967:34"><decl pos:start="967:5" pos:end="967:33"><type pos:start="967:5" pos:end="967:8"><name pos:start="967:5" pos:end="967:8">char</name></type> <name pos:start="967:10" pos:end="967:33"><name pos:start="967:10" pos:end="967:17">both_b64</name><index pos:start="967:18" pos:end="967:33">[<expr pos:start="967:19" pos:end="967:32"><literal type="number" pos:start="967:19" pos:end="967:19">2</literal><operator pos:start="967:20" pos:end="967:20">*</operator><literal type="number" pos:start="967:21" pos:end="967:21">2</literal><operator pos:start="967:22" pos:end="967:22">*</operator><name pos:start="967:23" pos:end="967:32">MAX_UIDPWD</name></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt pos:start="968:5" pos:end="968:21"><decl pos:start="968:5" pos:end="968:20"><type pos:start="968:5" pos:end="968:7"><name pos:start="968:5" pos:end="968:7">int</name></type> <name pos:start="968:9" pos:end="968:16">both_len</name> <init pos:start="968:18" pos:end="968:20">= <expr pos:start="968:20" pos:end="968:20"><literal type="number" pos:start="968:20" pos:end="968:20">0</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="969:5" pos:end="969:39"><decl pos:start="969:5" pos:end="969:38"><type pos:start="969:5" pos:end="969:21"><name pos:start="969:5" pos:end="969:21">EST_HTTP_AUTH_HDR</name></type> <name pos:start="969:23" pos:end="969:38">auth_credentials</name></decl>;</decl_stmt>
    <decl_stmt pos:start="970:5" pos:end="970:29"><decl pos:start="970:5" pos:end="970:28"><type pos:start="970:5" pos:end="970:25"><name pos:start="970:5" pos:end="970:25">EST_HTTP_AUTH_CRED_RC</name></type> <name pos:start="970:27" pos:end="970:28">rc</name></decl>;</decl_stmt>
    <decl_stmt pos:start="971:5" pos:end="971:23"><decl pos:start="971:5" pos:end="971:22"><type pos:start="971:5" pos:end="971:10"><name pos:start="971:5" pos:end="971:8">char</name> <modifier pos:start="971:10" pos:end="971:10">*</modifier></type><name pos:start="971:11" pos:end="971:15">token</name> <init pos:start="971:17" pos:end="971:22">= <expr pos:start="971:19" pos:end="971:22"><name pos:start="971:19" pos:end="971:22">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="972:5" pos:end="972:41"><decl pos:start="972:5" pos:end="972:40"><type pos:start="972:5" pos:end="972:8"><name pos:start="972:5" pos:end="972:8">char</name></type> <name pos:start="972:10" pos:end="972:40"><name pos:start="972:10" pos:end="972:18">token_b64</name><index pos:start="972:19" pos:end="972:40">[<expr pos:start="972:20" pos:end="972:39"><name pos:start="972:20" pos:end="972:37">MAX_AUTH_TOKEN_LEN</name><operator pos:start="972:38" pos:end="972:38">*</operator><literal type="number" pos:start="972:39" pos:end="972:39">2</literal></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt pos:start="973:5" pos:end="973:28"><decl pos:start="973:5" pos:end="973:27"><type pos:start="973:5" pos:end="973:8"><name pos:start="973:5" pos:end="973:8">char</name></type> <name pos:start="973:10" pos:end="973:27"><name pos:start="973:10" pos:end="973:13">user</name><index pos:start="973:14" pos:end="973:27">[<expr pos:start="973:15" pos:end="973:26"><name pos:start="973:15" pos:end="973:24">MAX_UIDPWD</name><operator pos:start="973:25" pos:end="973:25">+</operator><literal type="number" pos:start="973:26" pos:end="973:26">1</literal></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt pos:start="974:5" pos:end="974:27"><decl pos:start="974:5" pos:end="974:26"><type pos:start="974:5" pos:end="974:8"><name pos:start="974:5" pos:end="974:8">char</name></type> <name pos:start="974:10" pos:end="974:26"><name pos:start="974:10" pos:end="974:12">pwd</name><index pos:start="974:13" pos:end="974:26">[<expr pos:start="974:14" pos:end="974:25"><name pos:start="974:14" pos:end="974:23">MAX_UIDPWD</name><operator pos:start="974:24" pos:end="974:24">+</operator><literal type="number" pos:start="974:25" pos:end="974:25">1</literal></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt pos:start="975:5" pos:end="975:20"><decl pos:start="975:5" pos:end="975:19"><type pos:start="975:5" pos:end="975:7"><name pos:start="975:5" pos:end="975:7">int</name></type> <name pos:start="975:9" pos:end="975:15">enc_len</name> <init pos:start="975:17" pos:end="975:19">= <expr pos:start="975:19" pos:end="975:19"><literal type="number" pos:start="975:19" pos:end="975:19">0</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="976:5" pos:end="976:22"><decl pos:start="976:5" pos:end="976:21"><type pos:start="976:5" pos:end="976:7"><name pos:start="976:5" pos:end="976:7">int</name></type> <name pos:start="976:9" pos:end="976:17">token_len</name> <init pos:start="976:19" pos:end="976:21">= <expr pos:start="976:21" pos:end="976:21"><literal type="number" pos:start="976:21" pos:end="976:21">0</literal></expr></init></decl>;</decl_stmt>

    <expr_stmt pos:start="978:5" pos:end="978:36"><expr pos:start="978:5" pos:end="978:35"><call pos:start="978:5" pos:end="978:35"><name pos:start="978:5" pos:end="978:13">memzero_s</name><argument_list pos:start="978:14" pos:end="978:35">(<argument pos:start="978:15" pos:end="978:18"><expr pos:start="978:15" pos:end="978:18"><name pos:start="978:15" pos:end="978:18">both</name></expr></argument>, <argument pos:start="978:21" pos:end="978:34"><expr pos:start="978:21" pos:end="978:34"><name pos:start="978:21" pos:end="978:30">MAX_UIDPWD</name><operator pos:start="978:31" pos:end="978:31">*</operator><literal type="number" pos:start="978:32" pos:end="978:33">2</literal><operator pos:start="978:33" pos:end="978:33">+</operator><literal type="number" pos:start="978:34" pos:end="978:34">2</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="979:5" pos:end="979:40"><expr pos:start="979:5" pos:end="979:39"><call pos:start="979:5" pos:end="979:39"><name pos:start="979:5" pos:end="979:13">memzero_s</name><argument_list pos:start="979:14" pos:end="979:39">(<argument pos:start="979:15" pos:end="979:22"><expr pos:start="979:15" pos:end="979:22"><name pos:start="979:15" pos:end="979:22">both_b64</name></expr></argument>, <argument pos:start="979:25" pos:end="979:38"><expr pos:start="979:25" pos:end="979:38"><literal type="number" pos:start="979:25" pos:end="979:25">2</literal><operator pos:start="979:26" pos:end="979:26">*</operator><literal type="number" pos:start="979:27" pos:end="979:27">2</literal><operator pos:start="979:28" pos:end="979:28">*</operator><name pos:start="979:29" pos:end="979:38">MAX_UIDPWD</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    
    <expr_stmt pos:start="981:5" pos:end="981:59"><expr pos:start="981:5" pos:end="981:58"><name pos:start="981:5" pos:end="981:11">hdr_len</name> <operator pos:start="981:13" pos:end="981:13">=</operator> <operator pos:start="981:15" pos:end="981:15">(</operator><name pos:start="981:16" pos:end="981:18">int</name><operator pos:start="981:19" pos:end="981:19">)</operator> <call pos:start="981:21" pos:end="981:58"><name pos:start="981:21" pos:end="981:29">strnlen_s</name><argument_list pos:start="981:30" pos:end="981:58">(<argument pos:start="981:31" pos:end="981:33"><expr pos:start="981:31" pos:end="981:33"><name pos:start="981:31" pos:end="981:33">hdr</name></expr></argument>, <argument pos:start="981:36" pos:end="981:57"><expr pos:start="981:36" pos:end="981:57"><name pos:start="981:36" pos:end="981:57">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="982:5" pos:end="985:5"><if pos:start="982:5" pos:end="985:5">if <condition pos:start="982:8" pos:end="982:42">(<expr pos:start="982:9" pos:end="982:41"><name pos:start="982:9" pos:end="982:15">hdr_len</name> <operator pos:start="982:17" pos:end="982:18">==</operator> <name pos:start="982:20" pos:end="982:41">EST_HTTP_REQ_TOTAL_LEN</name></expr>)</condition> <block pos:start="982:44" pos:end="985:5">{<block_content pos:start="983:9" pos:end="984:45">
        <expr_stmt pos:start="983:9" pos:end="984:45"><expr pos:start="983:9" pos:end="984:44"><call pos:start="983:9" pos:end="984:44"><name pos:start="983:9" pos:end="983:20">EST_LOG_WARN</name><argument_list pos:start="983:21" pos:end="984:44">(<argument pos:start="983:22" pos:end="983:86"><expr pos:start="983:22" pos:end="983:86"><literal type="string" pos:start="983:22" pos:end="983:86">"Authentication header took up the maximum amount in buffer (%d)"</literal></expr></argument>,
                     <argument pos:start="984:22" pos:end="984:43"><expr pos:start="984:22" pos:end="984:43"><name pos:start="984:22" pos:end="984:43">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    
    <switch pos:start="987:5" pos:end="1140:5">switch <condition pos:start="987:12" pos:end="987:27">(<expr pos:start="987:13" pos:end="987:26"><name pos:start="987:13" pos:end="987:26"><name pos:start="987:13" pos:end="987:15">ctx</name><operator pos:start="987:16" pos:end="987:17">-&gt;</operator><name pos:start="987:18" pos:end="987:26">auth_mode</name></name></expr>)</condition> <block pos:start="987:29" pos:end="1140:5">{<block_content pos:start="988:5" pos:end="1139:14">
    <case pos:start="988:5" pos:end="988:20">case <expr pos:start="988:10" pos:end="988:19"><name pos:start="988:10" pos:end="988:19">AUTH_BASIC</name></expr>:</case>
        <comment type="block" pos:start="989:9" pos:end="994:11">/*
         * make sure we have both parts of the credentials to send.  If we do,
         * then we're operating in the original mode where the app layer
         * provides them up front before they're needed.  If not, then we can
         * now go ask for them from the app layer.
         */</comment>
        <if_stmt pos:start="995:9" pos:end="1012:9"><if pos:start="995:9" pos:end="1006:9">if <condition pos:start="995:12" pos:end="995:63">(<expr pos:start="995:13" pos:end="995:62"><name pos:start="995:13" pos:end="995:26"><name pos:start="995:13" pos:end="995:15">ctx</name><operator pos:start="995:16" pos:end="995:17">-&gt;</operator><name pos:start="995:18" pos:end="995:23">userid</name><index pos:start="995:24" pos:end="995:26">[<expr pos:start="995:25" pos:end="995:25"><literal type="number" pos:start="995:25" pos:end="995:25">0</literal></expr>]</index></name> <operator pos:start="995:28" pos:end="995:29">==</operator> <literal type="char" pos:start="995:31" pos:end="995:34">'\0'</literal> <operator pos:start="995:36" pos:end="995:37">&amp;&amp;</operator> <name pos:start="995:39" pos:end="995:54"><name pos:start="995:39" pos:end="995:41">ctx</name><operator pos:start="995:42" pos:end="995:43">-&gt;</operator><name pos:start="995:44" pos:end="995:51">password</name><index pos:start="995:52" pos:end="995:54">[<expr pos:start="995:53" pos:end="995:53"><literal type="number" pos:start="995:53" pos:end="995:53">0</literal></expr>]</index></name> <operator pos:start="995:56" pos:end="995:57">==</operator> <literal type="char" pos:start="995:59" pos:end="995:62">'\0'</literal></expr>)</condition> <block pos:start="995:65" pos:end="1006:9">{<block_content pos:start="997:13" pos:end="1005:63">

            <expr_stmt pos:start="997:13" pos:end="997:42"><expr pos:start="997:13" pos:end="997:41"><call pos:start="997:13" pos:end="997:41"><name pos:start="997:13" pos:end="997:21">memzero_s</name><argument_list pos:start="997:22" pos:end="997:41">(<argument pos:start="997:23" pos:end="997:26"><expr pos:start="997:23" pos:end="997:26"><name pos:start="997:23" pos:end="997:26">user</name></expr></argument>, <argument pos:start="997:29" pos:end="997:40"><expr pos:start="997:29" pos:end="997:40"><name pos:start="997:29" pos:end="997:38">MAX_UIDPWD</name><operator pos:start="997:39" pos:end="997:39">+</operator><literal type="number" pos:start="997:40" pos:end="997:40">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="998:13" pos:end="998:41"><expr pos:start="998:13" pos:end="998:40"><call pos:start="998:13" pos:end="998:40"><name pos:start="998:13" pos:end="998:21">memzero_s</name><argument_list pos:start="998:22" pos:end="998:40">(<argument pos:start="998:23" pos:end="998:25"><expr pos:start="998:23" pos:end="998:25"><name pos:start="998:23" pos:end="998:25">pwd</name></expr></argument>, <argument pos:start="998:28" pos:end="998:39"><expr pos:start="998:28" pos:end="998:39"><name pos:start="998:28" pos:end="998:37">MAX_UIDPWD</name><operator pos:start="998:38" pos:end="998:38">+</operator><literal type="number" pos:start="998:39" pos:end="998:39">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            
            <expr_stmt pos:start="1000:13" pos:end="1000:76"><expr pos:start="1000:13" pos:end="1000:75"><call pos:start="1000:13" pos:end="1000:75"><name pos:start="1000:13" pos:end="1000:43">est_client_retrieve_credentials</name><argument_list pos:start="1000:44" pos:end="1000:75">(<argument pos:start="1000:45" pos:end="1000:47"><expr pos:start="1000:45" pos:end="1000:47"><name pos:start="1000:45" pos:end="1000:47">ctx</name></expr></argument>, <argument pos:start="1000:50" pos:end="1000:63"><expr pos:start="1000:50" pos:end="1000:63"><name pos:start="1000:50" pos:end="1000:63"><name pos:start="1000:50" pos:end="1000:52">ctx</name><operator pos:start="1000:53" pos:end="1000:54">-&gt;</operator><name pos:start="1000:55" pos:end="1000:63">auth_mode</name></name></expr></argument>, <argument pos:start="1000:66" pos:end="1000:69"><expr pos:start="1000:66" pos:end="1000:69"><name pos:start="1000:66" pos:end="1000:69">user</name></expr></argument>, <argument pos:start="1000:72" pos:end="1000:74"><expr pos:start="1000:72" pos:end="1000:74"><name pos:start="1000:72" pos:end="1000:74">pwd</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            
            <comment type="block" pos:start="1002:13" pos:end="1004:15">/*
             * regardless of what comes back, build the string containing both
             */</comment>            
            <expr_stmt pos:start="1005:13" pos:end="1005:63"><expr pos:start="1005:13" pos:end="1005:62"><call pos:start="1005:13" pos:end="1005:62"><name pos:start="1005:13" pos:end="1005:20">snprintf</name><argument_list pos:start="1005:21" pos:end="1005:62">(<argument pos:start="1005:22" pos:end="1005:25"><expr pos:start="1005:22" pos:end="1005:25"><name pos:start="1005:22" pos:end="1005:25">both</name></expr></argument>, <argument pos:start="1005:28" pos:end="1005:41"><expr pos:start="1005:28" pos:end="1005:41"><name pos:start="1005:28" pos:end="1005:37">MAX_UIDPWD</name><operator pos:start="1005:38" pos:end="1005:38">*</operator><literal type="number" pos:start="1005:39" pos:end="1005:40">2</literal><operator pos:start="1005:40" pos:end="1005:40">+</operator><literal type="number" pos:start="1005:41" pos:end="1005:41">2</literal></expr></argument>, <argument pos:start="1005:44" pos:end="1005:50"><expr pos:start="1005:44" pos:end="1005:50"><literal type="string" pos:start="1005:44" pos:end="1005:50">"%s:%s"</literal></expr></argument>, <argument pos:start="1005:53" pos:end="1005:56"><expr pos:start="1005:53" pos:end="1005:56"><name pos:start="1005:53" pos:end="1005:56">user</name></expr></argument>, <argument pos:start="1005:59" pos:end="1005:61"><expr pos:start="1005:59" pos:end="1005:61"><name pos:start="1005:59" pos:end="1005:61">pwd</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></if> <else pos:start="1006:11" pos:end="1012:9">else <block pos:start="1006:16" pos:end="1012:9">{<block_content pos:start="1010:13" pos:end="1011:36">
            <comment type="block" pos:start="1007:13" pos:end="1009:15">/*
             * Use what was given during configuration through est_client_set_auth
             */</comment>
            <expr_stmt pos:start="1010:13" pos:end="1011:36"><expr pos:start="1010:13" pos:end="1011:35"><call pos:start="1010:13" pos:end="1011:35"><name pos:start="1010:13" pos:end="1010:20">snprintf</name><argument_list pos:start="1010:21" pos:end="1011:35">(<argument pos:start="1010:22" pos:end="1010:25"><expr pos:start="1010:22" pos:end="1010:25"><name pos:start="1010:22" pos:end="1010:25">both</name></expr></argument>, <argument pos:start="1010:28" pos:end="1010:41"><expr pos:start="1010:28" pos:end="1010:41"><name pos:start="1010:28" pos:end="1010:37">MAX_UIDPWD</name><operator pos:start="1010:38" pos:end="1010:38">*</operator><literal type="number" pos:start="1010:39" pos:end="1010:40">2</literal><operator pos:start="1010:40" pos:end="1010:40">+</operator><literal type="number" pos:start="1010:41" pos:end="1010:41">2</literal></expr></argument>, <argument pos:start="1010:44" pos:end="1010:50"><expr pos:start="1010:44" pos:end="1010:50"><literal type="string" pos:start="1010:44" pos:end="1010:50">"%s:%s"</literal></expr></argument>, <argument pos:start="1010:53" pos:end="1010:63"><expr pos:start="1010:53" pos:end="1010:63"><name pos:start="1010:53" pos:end="1010:63"><name pos:start="1010:53" pos:end="1010:55">ctx</name><operator pos:start="1010:56" pos:end="1010:57">-&gt;</operator><name pos:start="1010:58" pos:end="1010:63">userid</name></name></expr></argument>,
                     <argument pos:start="1011:22" pos:end="1011:34"><expr pos:start="1011:22" pos:end="1011:34"><name pos:start="1011:22" pos:end="1011:34"><name pos:start="1011:22" pos:end="1011:24">ctx</name><operator pos:start="1011:25" pos:end="1011:26">-&gt;</operator><name pos:start="1011:27" pos:end="1011:34">password</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></else></if_stmt>
        
        <comment type="block" pos:start="1014:9" pos:end="1016:11">/*
         * base64 encode the combined string and build the HTTP auth header
         */</comment>
        <expr_stmt pos:start="1017:9" pos:end="1017:51"><expr pos:start="1017:9" pos:end="1017:50"><name pos:start="1017:9" pos:end="1017:16">both_len</name> <operator pos:start="1017:18" pos:end="1017:18">=</operator> <call pos:start="1017:20" pos:end="1017:50"><name pos:start="1017:20" pos:end="1017:28">strnlen_s</name><argument_list pos:start="1017:29" pos:end="1017:50">(<argument pos:start="1017:30" pos:end="1017:33"><expr pos:start="1017:30" pos:end="1017:33"><name pos:start="1017:30" pos:end="1017:33">both</name></expr></argument>, <argument pos:start="1017:36" pos:end="1017:49"><expr pos:start="1017:36" pos:end="1017:49"><name pos:start="1017:36" pos:end="1017:45">MAX_UIDPWD</name><operator pos:start="1017:46" pos:end="1017:46">*</operator><literal type="number" pos:start="1017:47" pos:end="1017:48">2</literal><operator pos:start="1017:48" pos:end="1017:48">+</operator><literal type="number" pos:start="1017:49" pos:end="1017:49">2</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1018:9" pos:end="1018:94"><expr pos:start="1018:9" pos:end="1018:93"><name pos:start="1018:9" pos:end="1018:15">enc_len</name> <operator pos:start="1018:17" pos:end="1018:17">=</operator> <call pos:start="1018:19" pos:end="1018:93"><name pos:start="1018:19" pos:end="1018:35">est_base64_encode</name><argument_list pos:start="1018:36" pos:end="1018:93">(<argument pos:start="1018:37" pos:end="1018:54"><expr pos:start="1018:37" pos:end="1018:54"><operator pos:start="1018:37" pos:end="1018:37">(</operator><specifier pos:start="1018:38" pos:end="1018:42">const</specifier> <name pos:start="1018:44" pos:end="1018:47">char</name> <operator pos:start="1018:49" pos:end="1018:49">*</operator><operator pos:start="1018:50" pos:end="1018:50">)</operator><name pos:start="1018:51" pos:end="1018:54">both</name></expr></argument>, <argument pos:start="1018:57" pos:end="1018:64"><expr pos:start="1018:57" pos:end="1018:64"><name pos:start="1018:57" pos:end="1018:64">both_len</name></expr></argument>, <argument pos:start="1018:67" pos:end="1018:74"><expr pos:start="1018:67" pos:end="1018:74"><name pos:start="1018:67" pos:end="1018:74">both_b64</name></expr></argument>, <argument pos:start="1018:77" pos:end="1018:92"><expr pos:start="1018:77" pos:end="1018:92"><operator pos:start="1018:77" pos:end="1018:77">(</operator><literal type="number" pos:start="1018:78" pos:end="1018:78">2</literal><operator pos:start="1018:79" pos:end="1018:79">*</operator><literal type="number" pos:start="1018:80" pos:end="1018:80">2</literal><operator pos:start="1018:81" pos:end="1018:81">*</operator><name pos:start="1018:82" pos:end="1018:91">MAX_UIDPWD</name><operator pos:start="1018:92" pos:end="1018:92">)</operator></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="1019:9" pos:end="1021:9"><if pos:start="1019:9" pos:end="1021:9">if <condition pos:start="1019:12" pos:end="1019:25">(<expr pos:start="1019:13" pos:end="1019:24"><name pos:start="1019:13" pos:end="1019:19">enc_len</name> <operator pos:start="1019:21" pos:end="1019:22">&lt;=</operator> <literal type="number" pos:start="1019:24" pos:end="1019:24">0</literal></expr>)</condition> <block pos:start="1019:27" pos:end="1021:9">{<block_content pos:start="1020:13" pos:end="1020:61">
            <expr_stmt pos:start="1020:13" pos:end="1020:61"><expr pos:start="1020:13" pos:end="1020:60"><call pos:start="1020:13" pos:end="1020:60"><name pos:start="1020:13" pos:end="1020:23">EST_LOG_ERR</name><argument_list pos:start="1020:24" pos:end="1020:60">(<argument pos:start="1020:25" pos:end="1020:59"><expr pos:start="1020:25" pos:end="1020:59"><literal type="string" pos:start="1020:25" pos:end="1020:59">"Unable to encode basic auth value"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></if></if_stmt>    
        <expr_stmt pos:start="1022:9" pos:end="1023:58"><expr pos:start="1022:9" pos:end="1023:57"><call pos:start="1022:9" pos:end="1023:57"><name pos:start="1022:9" pos:end="1022:16">snprintf</name><argument_list pos:start="1022:17" pos:end="1023:57">(<argument pos:start="1022:18" pos:end="1022:30"><expr pos:start="1022:18" pos:end="1022:30"><name pos:start="1022:18" pos:end="1022:20">hdr</name> <operator pos:start="1022:22" pos:end="1022:22">+</operator> <name pos:start="1022:24" pos:end="1022:30">hdr_len</name></expr></argument>, <argument pos:start="1022:33" pos:end="1022:62"><expr pos:start="1022:33" pos:end="1022:62"><name pos:start="1022:33" pos:end="1022:54">EST_HTTP_REQ_TOTAL_LEN</name><operator pos:start="1022:55" pos:end="1022:55">-</operator><name pos:start="1022:56" pos:end="1022:62">hdr_len</name></expr></argument>,
                 <argument pos:start="1023:18" pos:end="1023:46"><expr pos:start="1023:18" pos:end="1023:46"><literal type="string" pos:start="1023:18" pos:end="1023:46">"Authorization: Basic %s\r\n"</literal></expr></argument>, <argument pos:start="1023:49" pos:end="1023:56"><expr pos:start="1023:49" pos:end="1023:56"><name pos:start="1023:49" pos:end="1023:56">both_b64</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <break pos:start="1024:9" pos:end="1024:14">break;</break>
    <case pos:start="1025:5" pos:end="1025:21">case <expr pos:start="1025:10" pos:end="1025:20"><name pos:start="1025:10" pos:end="1025:20">AUTH_DIGEST</name></expr>:</case>

        <comment type="block" pos:start="1027:9" pos:end="1027:37">/* Generate a client nonce */</comment>
        <if_stmt pos:start="1028:9" pos:end="1033:9"><if pos:start="1028:9" pos:end="1033:9">if <condition pos:start="1028:12" pos:end="1028:42">(<expr pos:start="1028:13" pos:end="1028:41"><operator pos:start="1028:13" pos:end="1028:13">!</operator><call pos:start="1028:14" pos:end="1028:41"><name pos:start="1028:14" pos:end="1028:23">RAND_bytes</name><argument_list pos:start="1028:24" pos:end="1028:41">(<argument pos:start="1028:25" pos:end="1028:37"><expr pos:start="1028:25" pos:end="1028:37"><name pos:start="1028:25" pos:end="1028:37">client_random</name></expr></argument>, <argument pos:start="1028:40" pos:end="1028:40"><expr pos:start="1028:40" pos:end="1028:40"><literal type="number" pos:start="1028:40" pos:end="1028:40">8</literal></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="1028:44" pos:end="1033:9">{<block_content pos:start="1029:13" pos:end="1032:18">
            <expr_stmt pos:start="1029:13" pos:end="1029:62"><expr pos:start="1029:13" pos:end="1029:61"><call pos:start="1029:13" pos:end="1029:61"><name pos:start="1029:13" pos:end="1029:23">EST_LOG_ERR</name><argument_list pos:start="1029:24" pos:end="1029:61">(<argument pos:start="1029:25" pos:end="1029:60"><expr pos:start="1029:25" pos:end="1029:60"><literal type="string" pos:start="1029:25" pos:end="1029:60">"RNG failure while generating nonce"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <comment type="block" pos:start="1030:13" pos:end="1030:44">/* Force hdr to a null string */</comment>
            <expr_stmt pos:start="1031:13" pos:end="1031:51"><expr pos:start="1031:13" pos:end="1031:50"><call pos:start="1031:13" pos:end="1031:50"><name pos:start="1031:13" pos:end="1031:21">memzero_s</name><argument_list pos:start="1031:22" pos:end="1031:50">(<argument pos:start="1031:23" pos:end="1031:25"><expr pos:start="1031:23" pos:end="1031:25"><name pos:start="1031:23" pos:end="1031:25">hdr</name></expr></argument>, <argument pos:start="1031:28" pos:end="1031:49"><expr pos:start="1031:28" pos:end="1031:49"><name pos:start="1031:28" pos:end="1031:49">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <break pos:start="1032:13" pos:end="1032:18">break;</break>
        </block_content>}</block></if></if_stmt>
        
        <expr_stmt pos:start="1035:9" pos:end="1035:55"><expr pos:start="1035:9" pos:end="1035:54"><call pos:start="1035:9" pos:end="1035:54"><name pos:start="1035:9" pos:end="1035:22">est_hex_to_str</name><argument_list pos:start="1035:23" pos:end="1035:54">(<argument pos:start="1035:24" pos:end="1035:35"><expr pos:start="1035:24" pos:end="1035:35"><name pos:start="1035:24" pos:end="1035:35"><name pos:start="1035:24" pos:end="1035:26">ctx</name><operator pos:start="1035:27" pos:end="1035:28">-&gt;</operator><name pos:start="1035:29" pos:end="1035:35">c_nonce</name></name></expr></argument>, <argument pos:start="1035:38" pos:end="1035:50"><expr pos:start="1035:38" pos:end="1035:50"><name pos:start="1035:38" pos:end="1035:50">client_random</name></expr></argument>, <argument pos:start="1035:53" pos:end="1035:53"><expr pos:start="1035:53" pos:end="1035:53"><literal type="number" pos:start="1035:53" pos:end="1035:53">8</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>

        <comment type="block" pos:start="1037:9" pos:end="1041:11">/*
         * Check to see if the application layer has provided username and password
         * up front during configuration.  If it has not, go retrieve them now, otherwise,
         * copy them into the local buffers to get them ready
         */</comment>
        <if_stmt pos:start="1042:9" pos:end="1055:9"><if pos:start="1042:9" pos:end="1048:9">if <condition pos:start="1042:12" pos:end="1042:63">(<expr pos:start="1042:13" pos:end="1042:62"><name pos:start="1042:13" pos:end="1042:26"><name pos:start="1042:13" pos:end="1042:15">ctx</name><operator pos:start="1042:16" pos:end="1042:17">-&gt;</operator><name pos:start="1042:18" pos:end="1042:23">userid</name><index pos:start="1042:24" pos:end="1042:26">[<expr pos:start="1042:25" pos:end="1042:25"><literal type="number" pos:start="1042:25" pos:end="1042:25">0</literal></expr>]</index></name> <operator pos:start="1042:28" pos:end="1042:29">==</operator> <literal type="char" pos:start="1042:31" pos:end="1042:34">'\0'</literal> <operator pos:start="1042:36" pos:end="1042:37">&amp;&amp;</operator> <name pos:start="1042:39" pos:end="1042:54"><name pos:start="1042:39" pos:end="1042:41">ctx</name><operator pos:start="1042:42" pos:end="1042:43">-&gt;</operator><name pos:start="1042:44" pos:end="1042:51">password</name><index pos:start="1042:52" pos:end="1042:54">[<expr pos:start="1042:53" pos:end="1042:53"><literal type="number" pos:start="1042:53" pos:end="1042:53">0</literal></expr>]</index></name> <operator pos:start="1042:56" pos:end="1042:57">==</operator> <literal type="char" pos:start="1042:59" pos:end="1042:62">'\0'</literal></expr>)</condition> <block pos:start="1042:65" pos:end="1048:9">{<block_content pos:start="1044:13" pos:end="1047:76">

            <expr_stmt pos:start="1044:13" pos:end="1044:42"><expr pos:start="1044:13" pos:end="1044:41"><call pos:start="1044:13" pos:end="1044:41"><name pos:start="1044:13" pos:end="1044:21">memzero_s</name><argument_list pos:start="1044:22" pos:end="1044:41">(<argument pos:start="1044:23" pos:end="1044:26"><expr pos:start="1044:23" pos:end="1044:26"><name pos:start="1044:23" pos:end="1044:26">user</name></expr></argument>, <argument pos:start="1044:29" pos:end="1044:40"><expr pos:start="1044:29" pos:end="1044:40"><name pos:start="1044:29" pos:end="1044:38">MAX_UIDPWD</name><operator pos:start="1044:39" pos:end="1044:39">+</operator><literal type="number" pos:start="1044:40" pos:end="1044:40">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="1045:13" pos:end="1045:41"><expr pos:start="1045:13" pos:end="1045:40"><call pos:start="1045:13" pos:end="1045:40"><name pos:start="1045:13" pos:end="1045:21">memzero_s</name><argument_list pos:start="1045:22" pos:end="1045:40">(<argument pos:start="1045:23" pos:end="1045:25"><expr pos:start="1045:23" pos:end="1045:25"><name pos:start="1045:23" pos:end="1045:25">pwd</name></expr></argument>, <argument pos:start="1045:28" pos:end="1045:39"><expr pos:start="1045:28" pos:end="1045:39"><name pos:start="1045:28" pos:end="1045:37">MAX_UIDPWD</name><operator pos:start="1045:38" pos:end="1045:38">+</operator><literal type="number" pos:start="1045:39" pos:end="1045:39">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            
            <expr_stmt pos:start="1047:13" pos:end="1047:76"><expr pos:start="1047:13" pos:end="1047:75"><call pos:start="1047:13" pos:end="1047:75"><name pos:start="1047:13" pos:end="1047:43">est_client_retrieve_credentials</name><argument_list pos:start="1047:44" pos:end="1047:75">(<argument pos:start="1047:45" pos:end="1047:47"><expr pos:start="1047:45" pos:end="1047:47"><name pos:start="1047:45" pos:end="1047:47">ctx</name></expr></argument>, <argument pos:start="1047:50" pos:end="1047:63"><expr pos:start="1047:50" pos:end="1047:63"><name pos:start="1047:50" pos:end="1047:63"><name pos:start="1047:50" pos:end="1047:52">ctx</name><operator pos:start="1047:53" pos:end="1047:54">-&gt;</operator><name pos:start="1047:55" pos:end="1047:63">auth_mode</name></name></expr></argument>, <argument pos:start="1047:66" pos:end="1047:69"><expr pos:start="1047:66" pos:end="1047:69"><name pos:start="1047:66" pos:end="1047:69">user</name></expr></argument>, <argument pos:start="1047:72" pos:end="1047:74"><expr pos:start="1047:72" pos:end="1047:74"><name pos:start="1047:72" pos:end="1047:74">pwd</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></if> <else pos:start="1048:11" pos:end="1055:9">else <block pos:start="1048:16" pos:end="1055:9">{<block_content pos:start="1049:13" pos:end="1054:13">
            <if_stmt pos:start="1049:13" pos:end="1051:13"><if pos:start="1049:13" pos:end="1051:13">if <condition pos:start="1049:16" pos:end="1049:76">(<expr pos:start="1049:17" pos:end="1049:75"><name pos:start="1049:17" pos:end="1049:19">EOK</name> <operator pos:start="1049:21" pos:end="1049:22">!=</operator> <call pos:start="1049:24" pos:end="1049:75"><name pos:start="1049:24" pos:end="1049:32">strncpy_s</name><argument_list pos:start="1049:33" pos:end="1049:75">(<argument pos:start="1049:34" pos:end="1049:37"><expr pos:start="1049:34" pos:end="1049:37"><name pos:start="1049:34" pos:end="1049:37">user</name></expr></argument>, <argument pos:start="1049:40" pos:end="1049:49"><expr pos:start="1049:40" pos:end="1049:49"><name pos:start="1049:40" pos:end="1049:49">MAX_UIDPWD</name></expr></argument>, <argument pos:start="1049:52" pos:end="1049:62"><expr pos:start="1049:52" pos:end="1049:62"><name pos:start="1049:52" pos:end="1049:62"><name pos:start="1049:52" pos:end="1049:54">ctx</name><operator pos:start="1049:55" pos:end="1049:56">-&gt;</operator><name pos:start="1049:57" pos:end="1049:62">userid</name></name></expr></argument>, <argument pos:start="1049:65" pos:end="1049:74"><expr pos:start="1049:65" pos:end="1049:74"><name pos:start="1049:65" pos:end="1049:74">MAX_UIDPWD</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="1049:78" pos:end="1051:13">{<block_content pos:start="1050:17" pos:end="1050:56">
                <expr_stmt pos:start="1050:17" pos:end="1050:56"><expr pos:start="1050:17" pos:end="1050:55"><call pos:start="1050:17" pos:end="1050:55"><name pos:start="1050:17" pos:end="1050:27">EST_LOG_ERR</name><argument_list pos:start="1050:28" pos:end="1050:55">(<argument pos:start="1050:29" pos:end="1050:54"><expr pos:start="1050:29" pos:end="1050:54"><literal type="string" pos:start="1050:29" pos:end="1050:54">"Invalid User ID provided"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            </block_content>}</block></if></if_stmt>
            <if_stmt pos:start="1052:13" pos:end="1054:13"><if pos:start="1052:13" pos:end="1054:13">if <condition pos:start="1052:16" pos:end="1052:77">(<expr pos:start="1052:17" pos:end="1052:76"><name pos:start="1052:17" pos:end="1052:19">EOK</name> <operator pos:start="1052:21" pos:end="1052:22">!=</operator> <call pos:start="1052:24" pos:end="1052:76"><name pos:start="1052:24" pos:end="1052:32">strncpy_s</name><argument_list pos:start="1052:33" pos:end="1052:76">(<argument pos:start="1052:34" pos:end="1052:36"><expr pos:start="1052:34" pos:end="1052:36"><name pos:start="1052:34" pos:end="1052:36">pwd</name></expr></argument>, <argument pos:start="1052:39" pos:end="1052:48"><expr pos:start="1052:39" pos:end="1052:48"><name pos:start="1052:39" pos:end="1052:48">MAX_UIDPWD</name></expr></argument>, <argument pos:start="1052:51" pos:end="1052:63"><expr pos:start="1052:51" pos:end="1052:63"><name pos:start="1052:51" pos:end="1052:63"><name pos:start="1052:51" pos:end="1052:53">ctx</name><operator pos:start="1052:54" pos:end="1052:55">-&gt;</operator><name pos:start="1052:56" pos:end="1052:63">password</name></name></expr></argument>, <argument pos:start="1052:66" pos:end="1052:75"><expr pos:start="1052:66" pos:end="1052:75"><name pos:start="1052:66" pos:end="1052:75">MAX_UIDPWD</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="1052:79" pos:end="1054:13">{<block_content pos:start="1053:17" pos:end="1053:62">
                <expr_stmt pos:start="1053:17" pos:end="1053:62"><expr pos:start="1053:17" pos:end="1053:61"><call pos:start="1053:17" pos:end="1053:61"><name pos:start="1053:17" pos:end="1053:27">EST_LOG_ERR</name><argument_list pos:start="1053:28" pos:end="1053:61">(<argument pos:start="1053:29" pos:end="1053:60"><expr pos:start="1053:29" pos:end="1053:60"><literal type="string" pos:start="1053:29" pos:end="1053:60">"Invalid User password provided"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            </block_content>}</block></if></if_stmt>
        </block_content>}</block></else></if_stmt>
        
        <expr_stmt pos:start="1057:9" pos:end="1057:70"><expr pos:start="1057:9" pos:end="1057:69"><name pos:start="1057:9" pos:end="1057:14">digest</name> <operator pos:start="1057:16" pos:end="1057:16">=</operator> <call pos:start="1057:18" pos:end="1057:69"><name pos:start="1057:18" pos:end="1057:48">est_client_generate_auth_digest</name><argument_list pos:start="1057:49" pos:end="1057:69">(<argument pos:start="1057:50" pos:end="1057:52"><expr pos:start="1057:50" pos:end="1057:52"><name pos:start="1057:50" pos:end="1057:52">ctx</name></expr></argument>, <argument pos:start="1057:55" pos:end="1057:57"><expr pos:start="1057:55" pos:end="1057:57"><name pos:start="1057:55" pos:end="1057:57">uri</name></expr></argument>, <argument pos:start="1057:60" pos:end="1057:63"><expr pos:start="1057:60" pos:end="1057:63"><name pos:start="1057:60" pos:end="1057:63">user</name></expr></argument>, <argument pos:start="1057:66" pos:end="1057:68"><expr pos:start="1057:66" pos:end="1057:68"><name pos:start="1057:66" pos:end="1057:68">pwd</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="1058:9" pos:end="1066:9"><if pos:start="1058:9" pos:end="1066:9">if <condition pos:start="1058:12" pos:end="1058:27">(<expr pos:start="1058:13" pos:end="1058:26"><name pos:start="1058:13" pos:end="1058:18">digest</name> <operator pos:start="1058:20" pos:end="1058:21">==</operator> <name pos:start="1058:23" pos:end="1058:26">NULL</name></expr>)</condition> <block pos:start="1058:29" pos:end="1066:9">{<block_content pos:start="1059:13" pos:end="1065:18">
            <expr_stmt pos:start="1059:13" pos:end="1059:57"><expr pos:start="1059:13" pos:end="1059:56"><call pos:start="1059:13" pos:end="1059:56"><name pos:start="1059:13" pos:end="1059:23">EST_LOG_ERR</name><argument_list pos:start="1059:24" pos:end="1059:56">(<argument pos:start="1059:25" pos:end="1059:55"><expr pos:start="1059:25" pos:end="1059:55"><literal type="string" pos:start="1059:25" pos:end="1059:55">"Error while generating digest"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <comment type="block" pos:start="1060:13" pos:end="1060:44">/* Force hdr to a null string */</comment>
            <expr_stmt pos:start="1061:13" pos:end="1061:51"><expr pos:start="1061:13" pos:end="1061:50"><call pos:start="1061:13" pos:end="1061:50"><name pos:start="1061:13" pos:end="1061:21">memzero_s</name><argument_list pos:start="1061:22" pos:end="1061:50">(<argument pos:start="1061:23" pos:end="1061:25"><expr pos:start="1061:23" pos:end="1061:25"><name pos:start="1061:23" pos:end="1061:25">hdr</name></expr></argument>, <argument pos:start="1061:28" pos:end="1061:49"><expr pos:start="1061:28" pos:end="1061:49"><name pos:start="1061:28" pos:end="1061:49">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="1062:13" pos:end="1062:49"><expr pos:start="1062:13" pos:end="1062:48"><call pos:start="1062:13" pos:end="1062:48"><name pos:start="1062:13" pos:end="1062:21">memzero_s</name><argument_list pos:start="1062:22" pos:end="1062:48">(<argument pos:start="1062:23" pos:end="1062:34"><expr pos:start="1062:23" pos:end="1062:34"><name pos:start="1062:23" pos:end="1062:34"><name pos:start="1062:23" pos:end="1062:25">ctx</name><operator pos:start="1062:26" pos:end="1062:27">-&gt;</operator><name pos:start="1062:28" pos:end="1062:34">c_nonce</name></name></expr></argument>, <argument pos:start="1062:37" pos:end="1062:47"><expr pos:start="1062:37" pos:end="1062:47"><name pos:start="1062:37" pos:end="1062:45">MAX_NONCE</name><operator pos:start="1062:46" pos:end="1062:46">+</operator><literal type="number" pos:start="1062:47" pos:end="1062:47">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="1063:13" pos:end="1063:42"><expr pos:start="1063:13" pos:end="1063:41"><call pos:start="1063:13" pos:end="1063:41"><name pos:start="1063:13" pos:end="1063:21">memzero_s</name><argument_list pos:start="1063:22" pos:end="1063:41">(<argument pos:start="1063:23" pos:end="1063:26"><expr pos:start="1063:23" pos:end="1063:26"><name pos:start="1063:23" pos:end="1063:26">user</name></expr></argument>, <argument pos:start="1063:29" pos:end="1063:40"><expr pos:start="1063:29" pos:end="1063:40"><name pos:start="1063:29" pos:end="1063:38">MAX_UIDPWD</name><operator pos:start="1063:39" pos:end="1063:39">+</operator><literal type="number" pos:start="1063:40" pos:end="1063:40">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="1064:13" pos:end="1064:41"><expr pos:start="1064:13" pos:end="1064:40"><call pos:start="1064:13" pos:end="1064:40"><name pos:start="1064:13" pos:end="1064:21">memzero_s</name><argument_list pos:start="1064:22" pos:end="1064:40">(<argument pos:start="1064:23" pos:end="1064:25"><expr pos:start="1064:23" pos:end="1064:25"><name pos:start="1064:23" pos:end="1064:25">pwd</name></expr></argument>, <argument pos:start="1064:28" pos:end="1064:39"><expr pos:start="1064:28" pos:end="1064:39"><name pos:start="1064:28" pos:end="1064:37">MAX_UIDPWD</name><operator pos:start="1064:38" pos:end="1064:38">+</operator><literal type="number" pos:start="1064:39" pos:end="1064:39">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <break pos:start="1065:13" pos:end="1065:18">break;</break>
        </block_content>}</block></if></if_stmt>
            
        <expr_stmt pos:start="1068:9" pos:end="1075:24"><expr pos:start="1068:9" pos:end="1075:23"><call pos:start="1068:9" pos:end="1075:23"><name pos:start="1068:9" pos:end="1068:16">snprintf</name><argument_list pos:start="1068:17" pos:end="1075:23">(<argument pos:start="1068:18" pos:end="1068:30"><expr pos:start="1068:18" pos:end="1068:30"><name pos:start="1068:18" pos:end="1068:20">hdr</name> <operator pos:start="1068:22" pos:end="1068:22">+</operator> <name pos:start="1068:24" pos:end="1068:30">hdr_len</name></expr></argument>, <argument pos:start="1068:33" pos:end="1068:62"><expr pos:start="1068:33" pos:end="1068:62"><name pos:start="1068:33" pos:end="1068:54">EST_HTTP_REQ_TOTAL_LEN</name><operator pos:start="1068:55" pos:end="1068:55">-</operator><name pos:start="1068:56" pos:end="1068:62">hdr_len</name></expr></argument>,
                 <argument pos:start="1069:18" pos:end="1069:159"><expr pos:start="1069:18" pos:end="1069:159"><literal type="string" pos:start="1069:18" pos:end="1069:159">"Authorization: Digest username=\"%s\", realm=\"%s\", nonce=\"%s\", uri=\"%s\", cnonce=\"%s\", nc=00000001, qop=\"auth\", response=\"%s\"\r\n"</literal></expr></argument>,
                <argument pos:start="1070:17" pos:end="1070:20"><expr pos:start="1070:17" pos:end="1070:20"><name pos:start="1070:17" pos:end="1070:20">user</name></expr></argument>,
                <argument pos:start="1071:17" pos:end="1071:26"><expr pos:start="1071:17" pos:end="1071:26"><name pos:start="1071:17" pos:end="1071:26"><name pos:start="1071:17" pos:end="1071:19">ctx</name><operator pos:start="1071:20" pos:end="1071:21">-&gt;</operator><name pos:start="1071:22" pos:end="1071:26">realm</name></name></expr></argument>,
                <argument pos:start="1072:17" pos:end="1072:28"><expr pos:start="1072:17" pos:end="1072:28"><name pos:start="1072:17" pos:end="1072:28"><name pos:start="1072:17" pos:end="1072:19">ctx</name><operator pos:start="1072:20" pos:end="1072:21">-&gt;</operator><name pos:start="1072:22" pos:end="1072:28">s_nonce</name></name></expr></argument>,
                <argument pos:start="1073:17" pos:end="1073:19"><expr pos:start="1073:17" pos:end="1073:19"><name pos:start="1073:17" pos:end="1073:19">uri</name></expr></argument>,
                <argument pos:start="1074:17" pos:end="1074:28"><expr pos:start="1074:17" pos:end="1074:28"><name pos:start="1074:17" pos:end="1074:28"><name pos:start="1074:17" pos:end="1074:19">ctx</name><operator pos:start="1074:20" pos:end="1074:21">-&gt;</operator><name pos:start="1074:22" pos:end="1074:28">c_nonce</name></name></expr></argument>,
                <argument pos:start="1075:17" pos:end="1075:22"><expr pos:start="1075:17" pos:end="1075:22"><name pos:start="1075:17" pos:end="1075:22">digest</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1076:9" pos:end="1076:54"><expr pos:start="1076:9" pos:end="1076:53"><call pos:start="1076:9" pos:end="1076:53"><name pos:start="1076:9" pos:end="1076:17">memzero_s</name><argument_list pos:start="1076:18" pos:end="1076:53">(<argument pos:start="1076:19" pos:end="1076:24"><expr pos:start="1076:19" pos:end="1076:24"><name pos:start="1076:19" pos:end="1076:24">digest</name></expr></argument>, <argument pos:start="1076:27" pos:end="1076:52"><expr pos:start="1076:27" pos:end="1076:52"><name pos:start="1076:27" pos:end="1076:52">EST_MAX_MD5_DIGEST_STR_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1077:9" pos:end="1077:45"><expr pos:start="1077:9" pos:end="1077:44"><call pos:start="1077:9" pos:end="1077:44"><name pos:start="1077:9" pos:end="1077:17">memzero_s</name><argument_list pos:start="1077:18" pos:end="1077:44">(<argument pos:start="1077:19" pos:end="1077:30"><expr pos:start="1077:19" pos:end="1077:30"><name pos:start="1077:19" pos:end="1077:30"><name pos:start="1077:19" pos:end="1077:21">ctx</name><operator pos:start="1077:22" pos:end="1077:23">-&gt;</operator><name pos:start="1077:24" pos:end="1077:30">c_nonce</name></name></expr></argument>, <argument pos:start="1077:33" pos:end="1077:43"><expr pos:start="1077:33" pos:end="1077:43"><name pos:start="1077:33" pos:end="1077:41">MAX_NONCE</name><operator pos:start="1077:42" pos:end="1077:42">+</operator><literal type="number" pos:start="1077:43" pos:end="1077:43">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1078:9" pos:end="1078:38"><expr pos:start="1078:9" pos:end="1078:37"><call pos:start="1078:9" pos:end="1078:37"><name pos:start="1078:9" pos:end="1078:17">memzero_s</name><argument_list pos:start="1078:18" pos:end="1078:37">(<argument pos:start="1078:19" pos:end="1078:22"><expr pos:start="1078:19" pos:end="1078:22"><name pos:start="1078:19" pos:end="1078:22">user</name></expr></argument>, <argument pos:start="1078:25" pos:end="1078:36"><expr pos:start="1078:25" pos:end="1078:36"><name pos:start="1078:25" pos:end="1078:34">MAX_UIDPWD</name><operator pos:start="1078:35" pos:end="1078:35">+</operator><literal type="number" pos:start="1078:36" pos:end="1078:36">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1079:9" pos:end="1079:37"><expr pos:start="1079:9" pos:end="1079:36"><call pos:start="1079:9" pos:end="1079:36"><name pos:start="1079:9" pos:end="1079:17">memzero_s</name><argument_list pos:start="1079:18" pos:end="1079:36">(<argument pos:start="1079:19" pos:end="1079:21"><expr pos:start="1079:19" pos:end="1079:21"><name pos:start="1079:19" pos:end="1079:21">pwd</name></expr></argument>, <argument pos:start="1079:24" pos:end="1079:35"><expr pos:start="1079:24" pos:end="1079:35"><name pos:start="1079:24" pos:end="1079:33">MAX_UIDPWD</name><operator pos:start="1079:34" pos:end="1079:34">+</operator><literal type="number" pos:start="1079:35" pos:end="1079:35">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1080:9" pos:end="1080:21"><expr pos:start="1080:9" pos:end="1080:20"><call pos:start="1080:9" pos:end="1080:20"><name pos:start="1080:9" pos:end="1080:12">free</name><argument_list pos:start="1080:13" pos:end="1080:20">(<argument pos:start="1080:14" pos:end="1080:19"><expr pos:start="1080:14" pos:end="1080:19"><name pos:start="1080:14" pos:end="1080:19">digest</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <break pos:start="1081:9" pos:end="1081:14">break;</break>
    <case pos:start="1082:5" pos:end="1082:20">case <expr pos:start="1082:10" pos:end="1082:19"><name pos:start="1082:10" pos:end="1082:19">AUTH_TOKEN</name></expr>:</case>
        
        <expr_stmt pos:start="1084:9" pos:end="1084:68"><expr pos:start="1084:9" pos:end="1084:67"><call pos:start="1084:9" pos:end="1084:67"><name pos:start="1084:9" pos:end="1084:20">EST_LOG_INFO</name><argument_list pos:start="1084:21" pos:end="1084:67">(<argument pos:start="1084:22" pos:end="1084:66"><expr pos:start="1084:22" pos:end="1084:66"><literal type="string" pos:start="1084:22" pos:end="1084:66">"Server requested Token based authentication"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>

        <expr_stmt pos:start="1086:9" pos:end="1086:63"><expr pos:start="1086:9" pos:end="1086:62"><call pos:start="1086:9" pos:end="1086:62"><name pos:start="1086:9" pos:end="1086:17">memzero_s</name><argument_list pos:start="1086:18" pos:end="1086:62">(<argument pos:start="1086:19" pos:end="1086:35"><expr pos:start="1086:19" pos:end="1086:35"><operator pos:start="1086:19" pos:end="1086:19">&amp;</operator><name pos:start="1086:20" pos:end="1086:35">auth_credentials</name></expr></argument>, <argument pos:start="1086:38" pos:end="1086:61"><expr pos:start="1086:38" pos:end="1086:61"><sizeof pos:start="1086:38" pos:end="1086:61">sizeof<argument_list pos:start="1086:44" pos:end="1086:61">(<argument pos:start="1086:45" pos:end="1086:60"><expr pos:start="1086:45" pos:end="1086:60"><name pos:start="1086:45" pos:end="1086:60">auth_credentials</name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        
        <if_stmt pos:start="1088:9" pos:end="1094:9"><if pos:start="1088:9" pos:end="1094:9">if <condition pos:start="1088:12" pos:end="1088:37">(<expr pos:start="1088:13" pos:end="1088:36"><name pos:start="1088:13" pos:end="1088:36"><name pos:start="1088:13" pos:end="1088:15">ctx</name><operator pos:start="1088:16" pos:end="1088:17">-&gt;</operator><name pos:start="1088:18" pos:end="1088:36">auth_credentials_cb</name></name></expr>)</condition> <block pos:start="1088:39" pos:end="1094:9">{<block_content pos:start="1089:13" pos:end="1093:13">    
            <expr_stmt pos:start="1089:13" pos:end="1089:47"><expr pos:start="1089:13" pos:end="1089:46"><name pos:start="1089:13" pos:end="1089:33"><name pos:start="1089:13" pos:end="1089:28">auth_credentials</name><operator pos:start="1089:29" pos:end="1089:29">.</operator><name pos:start="1089:30" pos:end="1089:33">mode</name></name> <operator pos:start="1089:35" pos:end="1089:35">=</operator> <name pos:start="1089:37" pos:end="1089:46">AUTH_TOKEN</name></expr>;</expr_stmt>
            <expr_stmt pos:start="1090:13" pos:end="1090:61"><expr pos:start="1090:13" pos:end="1090:60"><name pos:start="1090:13" pos:end="1090:14">rc</name> <operator pos:start="1090:16" pos:end="1090:16">=</operator> <call pos:start="1090:18" pos:end="1090:60"><name pos:start="1090:18" pos:end="1090:41"><name pos:start="1090:18" pos:end="1090:20">ctx</name><operator pos:start="1090:21" pos:end="1090:22">-&gt;</operator><name pos:start="1090:23" pos:end="1090:41">auth_credentials_cb</name></name><argument_list pos:start="1090:42" pos:end="1090:60">(<argument pos:start="1090:43" pos:end="1090:59"><expr pos:start="1090:43" pos:end="1090:59"><operator pos:start="1090:43" pos:end="1090:43">&amp;</operator><name pos:start="1090:44" pos:end="1090:59">auth_credentials</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <if_stmt pos:start="1091:13" pos:end="1093:13"><if pos:start="1091:13" pos:end="1093:13">if <condition pos:start="1091:16" pos:end="1091:55">(<expr pos:start="1091:17" pos:end="1091:54"><name pos:start="1091:17" pos:end="1091:18">rc</name> <operator pos:start="1091:20" pos:end="1091:21">==</operator> <name pos:start="1091:23" pos:end="1091:54">EST_HTTP_AUTH_CRED_NOT_AVAILABLE</name></expr>)</condition> <block pos:start="1091:57" pos:end="1093:13">{<block_content pos:start="1092:17" pos:end="1092:80">
                <expr_stmt pos:start="1092:17" pos:end="1092:80"><expr pos:start="1092:17" pos:end="1092:79"><call pos:start="1092:17" pos:end="1092:79"><name pos:start="1092:17" pos:end="1092:27">EST_LOG_ERR</name><argument_list pos:start="1092:28" pos:end="1092:79">(<argument pos:start="1092:29" pos:end="1092:78"><expr pos:start="1092:29" pos:end="1092:78"><literal type="string" pos:start="1092:29" pos:end="1092:78">"Attempt to obtain token from application failed."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            </block_content>}</block></if></if_stmt>
        </block_content>}</block></if></if_stmt>

        <comment type="block" pos:start="1096:9" pos:end="1099:11">/*
         * Did we get the credentials we expected?  If not, point to a NULL string
         * to generate the header
         */</comment>
        <if_stmt pos:start="1100:9" pos:end="1117:9"><if pos:start="1100:9" pos:end="1103:9">if <condition pos:start="1100:12" pos:end="1100:48">(<expr pos:start="1100:13" pos:end="1100:47"><name pos:start="1100:13" pos:end="1100:39"><name pos:start="1100:13" pos:end="1100:28">auth_credentials</name><operator pos:start="1100:29" pos:end="1100:29">.</operator><name pos:start="1100:30" pos:end="1100:39">auth_token</name></name> <operator pos:start="1100:41" pos:end="1100:42">==</operator> <name pos:start="1100:44" pos:end="1100:47">NULL</name></expr>)</condition> <block pos:start="1100:50" pos:end="1103:9">{<block_content pos:start="1101:13" pos:end="1102:23">
            <expr_stmt pos:start="1101:13" pos:end="1101:93"><expr pos:start="1101:13" pos:end="1101:92"><call pos:start="1101:13" pos:end="1101:92"><name pos:start="1101:13" pos:end="1101:23">EST_LOG_ERR</name><argument_list pos:start="1101:24" pos:end="1101:92">(<argument pos:start="1101:25" pos:end="1101:91"><expr pos:start="1101:25" pos:end="1101:91"><literal type="string" pos:start="1101:25" pos:end="1101:91">"Requested token credentials, but application did not provide any."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="1102:13" pos:end="1102:23"><expr pos:start="1102:13" pos:end="1102:22"><name pos:start="1102:13" pos:end="1102:17">token</name> <operator pos:start="1102:19" pos:end="1102:19">=</operator> <literal type="string" pos:start="1102:21" pos:end="1102:22">""</literal></expr>;</expr_stmt> 
        </block_content>}</block></if> <else pos:start="1103:11" pos:end="1117:9">else <block pos:start="1103:16" pos:end="1117:9">{<block_content pos:start="1110:13" pos:end="1116:13">

            <comment type="block" pos:start="1105:13" pos:end="1109:15">/*
             * Make sure the token we were given is not too long.
             * If it is, force it to NULL to cause the auth failure at
             * the server just as if no credentials were provided
             */</comment>
            <if_stmt pos:start="1110:13" pos:end="1116:13"><if pos:start="1110:13" pos:end="1114:13">if <condition pos:start="1110:16" pos:end="1110:98">(<expr pos:start="1110:17" pos:end="1110:97"><name pos:start="1110:17" pos:end="1110:34">MAX_AUTH_TOKEN_LEN</name> <operator pos:start="1110:36" pos:end="1110:36">&lt;</operator> <call pos:start="1110:38" pos:end="1110:97"><name pos:start="1110:38" pos:end="1110:46">strnlen_s</name><argument_list pos:start="1110:47" pos:end="1110:97">(<argument pos:start="1110:48" pos:end="1110:74"><expr pos:start="1110:48" pos:end="1110:74"><name pos:start="1110:48" pos:end="1110:74"><name pos:start="1110:48" pos:end="1110:63">auth_credentials</name><operator pos:start="1110:64" pos:end="1110:64">.</operator><name pos:start="1110:65" pos:end="1110:74">auth_token</name></name></expr></argument>, <argument pos:start="1110:77" pos:end="1110:96"><expr pos:start="1110:77" pos:end="1110:96"><name pos:start="1110:77" pos:end="1110:94">MAX_AUTH_TOKEN_LEN</name><operator pos:start="1110:95" pos:end="1110:95">+</operator><literal type="number" pos:start="1110:96" pos:end="1110:96">1</literal></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="1110:100" pos:end="1114:13">{<block_content pos:start="1111:17" pos:end="1113:27">
                <expr_stmt pos:start="1111:17" pos:end="1112:48"><expr pos:start="1111:17" pos:end="1112:47"><call pos:start="1111:17" pos:end="1112:47"><name pos:start="1111:17" pos:end="1111:27">EST_LOG_ERR</name><argument_list pos:start="1111:28" pos:end="1112:47">(<argument pos:start="1111:29" pos:end="1111:73"><expr pos:start="1111:29" pos:end="1111:73"><literal type="string" pos:start="1111:29" pos:end="1111:73">"Token provided is larger than the max of %d"</literal></expr></argument>,
                            <argument pos:start="1112:29" pos:end="1112:46"><expr pos:start="1112:29" pos:end="1112:46"><name pos:start="1112:29" pos:end="1112:46">MAX_AUTH_TOKEN_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt pos:start="1113:17" pos:end="1113:27"><expr pos:start="1113:17" pos:end="1113:26"><name pos:start="1113:17" pos:end="1113:21">token</name> <operator pos:start="1113:23" pos:end="1113:23">=</operator> <literal type="string" pos:start="1113:25" pos:end="1113:26">""</literal></expr>;</expr_stmt>
            </block_content>}</block></if> <else pos:start="1114:15" pos:end="1116:13">else <block pos:start="1114:20" pos:end="1116:13">{<block_content pos:start="1115:17" pos:end="1115:52">
                <expr_stmt pos:start="1115:17" pos:end="1115:52"><expr pos:start="1115:17" pos:end="1115:51"><name pos:start="1115:17" pos:end="1115:21">token</name> <operator pos:start="1115:23" pos:end="1115:23">=</operator> <name pos:start="1115:25" pos:end="1115:51"><name pos:start="1115:25" pos:end="1115:40">auth_credentials</name><operator pos:start="1115:41" pos:end="1115:41">.</operator><name pos:start="1115:42" pos:end="1115:51">auth_token</name></name></expr>;</expr_stmt>
            </block_content>}</block></else></if_stmt>
        </block_content>}</block></else></if_stmt>

        <comment type="block" pos:start="1119:9" pos:end="1121:11">/*
         * base64 encode the combined string and build the HTTP auth header
         */</comment>
        <expr_stmt pos:start="1122:9" pos:end="1122:51"><expr pos:start="1122:9" pos:end="1122:50"><call pos:start="1122:9" pos:end="1122:50"><name pos:start="1122:9" pos:end="1122:17">memzero_s</name><argument_list pos:start="1122:18" pos:end="1122:50">(<argument pos:start="1122:19" pos:end="1122:27"><expr pos:start="1122:19" pos:end="1122:27"><name pos:start="1122:19" pos:end="1122:27">token_b64</name></expr></argument>, <argument pos:start="1122:30" pos:end="1122:49"><expr pos:start="1122:30" pos:end="1122:49"><name pos:start="1122:30" pos:end="1122:47">MAX_AUTH_TOKEN_LEN</name><operator pos:start="1122:48" pos:end="1122:48">*</operator><literal type="number" pos:start="1122:49" pos:end="1122:49">2</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1123:9" pos:end="1123:57"><expr pos:start="1123:9" pos:end="1123:56"><name pos:start="1123:9" pos:end="1123:17">token_len</name> <operator pos:start="1123:19" pos:end="1123:19">=</operator> <call pos:start="1123:21" pos:end="1123:56"><name pos:start="1123:21" pos:end="1123:29">strnlen_s</name><argument_list pos:start="1123:30" pos:end="1123:56">(<argument pos:start="1123:31" pos:end="1123:35"><expr pos:start="1123:31" pos:end="1123:35"><name pos:start="1123:31" pos:end="1123:35">token</name></expr></argument>, <argument pos:start="1123:38" pos:end="1123:55"><expr pos:start="1123:38" pos:end="1123:55"><name pos:start="1123:38" pos:end="1123:55">MAX_AUTH_TOKEN_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1124:9" pos:end="1125:69"><expr pos:start="1124:9" pos:end="1125:68"><name pos:start="1124:9" pos:end="1124:15">enc_len</name> <operator pos:start="1124:17" pos:end="1124:17">=</operator> <call pos:start="1124:19" pos:end="1125:68"><name pos:start="1124:19" pos:end="1124:35">est_base64_encode</name><argument_list pos:start="1124:36" pos:end="1125:68">(<argument pos:start="1124:37" pos:end="1124:55"><expr pos:start="1124:37" pos:end="1124:55"><operator pos:start="1124:37" pos:end="1124:37">(</operator><specifier pos:start="1124:38" pos:end="1124:42">const</specifier> <name pos:start="1124:44" pos:end="1124:47">char</name> <operator pos:start="1124:49" pos:end="1124:49">*</operator><operator pos:start="1124:50" pos:end="1124:50">)</operator><name pos:start="1124:51" pos:end="1124:55">token</name></expr></argument>, <argument pos:start="1124:58" pos:end="1124:66"><expr pos:start="1124:58" pos:end="1124:66"><name pos:start="1124:58" pos:end="1124:66">token_len</name></expr></argument>,
                                    <argument pos:start="1125:37" pos:end="1125:45"><expr pos:start="1125:37" pos:end="1125:45"><name pos:start="1125:37" pos:end="1125:45">token_b64</name></expr></argument>, <argument pos:start="1125:48" pos:end="1125:67"><expr pos:start="1125:48" pos:end="1125:67"><name pos:start="1125:48" pos:end="1125:65">MAX_AUTH_TOKEN_LEN</name><operator pos:start="1125:66" pos:end="1125:66">*</operator><literal type="number" pos:start="1125:67" pos:end="1125:67">2</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        
        <if_stmt pos:start="1127:9" pos:end="1129:9"><if pos:start="1127:9" pos:end="1129:9">if <condition pos:start="1127:12" pos:end="1127:25">(<expr pos:start="1127:13" pos:end="1127:24"><name pos:start="1127:13" pos:end="1127:19">enc_len</name> <operator pos:start="1127:21" pos:end="1127:22">&lt;=</operator> <literal type="number" pos:start="1127:24" pos:end="1127:24">0</literal></expr>)</condition> <block pos:start="1127:27" pos:end="1129:9">{<block_content pos:start="1128:13" pos:end="1128:68">
            <expr_stmt pos:start="1128:13" pos:end="1128:68"><expr pos:start="1128:13" pos:end="1128:67"><call pos:start="1128:13" pos:end="1128:67"><name pos:start="1128:13" pos:end="1128:23">EST_LOG_ERR</name><argument_list pos:start="1128:24" pos:end="1128:67">(<argument pos:start="1128:25" pos:end="1128:66"><expr pos:start="1128:25" pos:end="1128:66"><literal type="string" pos:start="1128:25" pos:end="1128:66">"Unable to encode bearer token auth value"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></if></if_stmt>    
        
        <expr_stmt pos:start="1131:9" pos:end="1132:60"><expr pos:start="1131:9" pos:end="1132:59"><call pos:start="1131:9" pos:end="1132:59"><name pos:start="1131:9" pos:end="1131:16">snprintf</name><argument_list pos:start="1131:17" pos:end="1132:59">(<argument pos:start="1131:18" pos:end="1131:30"><expr pos:start="1131:18" pos:end="1131:30"><name pos:start="1131:18" pos:end="1131:20">hdr</name> <operator pos:start="1131:22" pos:end="1131:22">+</operator> <name pos:start="1131:24" pos:end="1131:30">hdr_len</name></expr></argument>, <argument pos:start="1131:33" pos:end="1131:62"><expr pos:start="1131:33" pos:end="1131:62"><name pos:start="1131:33" pos:end="1131:54">EST_HTTP_REQ_TOTAL_LEN</name><operator pos:start="1131:55" pos:end="1131:55">-</operator><name pos:start="1131:56" pos:end="1131:62">hdr_len</name></expr></argument>,
                 <argument pos:start="1132:18" pos:end="1132:47"><expr pos:start="1132:18" pos:end="1132:47"><literal type="string" pos:start="1132:18" pos:end="1132:47">"Authorization: Bearer %s\r\n"</literal></expr></argument>, <argument pos:start="1132:50" pos:end="1132:58"><expr pos:start="1132:50" pos:end="1132:58"><name pos:start="1132:50" pos:end="1132:58">token_b64</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

        <expr_stmt pos:start="1134:9" pos:end="1134:52"><expr pos:start="1134:9" pos:end="1134:51"><call pos:start="1134:9" pos:end="1134:51"><name pos:start="1134:9" pos:end="1134:32">cleanse_auth_credentials</name><argument_list pos:start="1134:33" pos:end="1134:51">(<argument pos:start="1134:34" pos:end="1134:50"><expr pos:start="1134:34" pos:end="1134:50"><operator pos:start="1134:34" pos:end="1134:34">&amp;</operator><name pos:start="1134:35" pos:end="1134:50">auth_credentials</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        
        <break pos:start="1136:9" pos:end="1136:14">break;</break>
    <default pos:start="1137:5" pos:end="1137:12">default:</default>
        <expr_stmt pos:start="1138:9" pos:end="1138:73"><expr pos:start="1138:9" pos:end="1138:72"><call pos:start="1138:9" pos:end="1138:72"><name pos:start="1138:9" pos:end="1138:20">EST_LOG_INFO</name><argument_list pos:start="1138:21" pos:end="1138:72">(<argument pos:start="1138:22" pos:end="1138:71"><expr pos:start="1138:22" pos:end="1138:71"><literal type="string" pos:start="1138:22" pos:end="1138:71">"No HTTP auth mode set, sending anonymous request"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <break pos:start="1139:9" pos:end="1139:14">break;</break>
    </block_content>}</block></switch>
</block_content>}</block></function>
<comment type="block" pos:start="1142:1" pos:end="1149:3">/*
 * This function is used to build the HTTP header for
 * the CAcerts request flow.
 *
 * Parameters:
 *	ctx:	    EST context
 *	hdr:        pointer to the buffer to hold the header
 */</comment>
<function pos:start="1150:1" pos:end="1172:1"><type pos:start="1150:1" pos:end="1150:10"><specifier pos:start="1150:1" pos:end="1150:6">static</specifier> <name pos:start="1150:8" pos:end="1150:10">int</name></type> <name pos:start="1150:12" pos:end="1150:42">est_client_build_cacerts_header</name> <parameter_list pos:start="1150:44" pos:end="1150:68">(<parameter pos:start="1150:45" pos:end="1150:56"><decl pos:start="1150:45" pos:end="1150:56"><type pos:start="1150:45" pos:end="1150:56"><name pos:start="1150:45" pos:end="1150:51">EST_CTX</name> <modifier pos:start="1150:53" pos:end="1150:53">*</modifier></type><name pos:start="1150:54" pos:end="1150:56">ctx</name></decl></parameter>, <parameter pos:start="1150:59" pos:end="1150:67"><decl pos:start="1150:59" pos:end="1150:67"><type pos:start="1150:59" pos:end="1150:67"><name pos:start="1150:59" pos:end="1150:62">char</name> <modifier pos:start="1150:64" pos:end="1150:64">*</modifier></type><name pos:start="1150:65" pos:end="1150:67">hdr</name></decl></parameter>)</parameter_list>
<block pos:start="1151:1" pos:end="1172:1">{<block_content pos:start="1152:5" pos:end="1171:21">
    <decl_stmt pos:start="1152:5" pos:end="1152:16"><decl pos:start="1152:5" pos:end="1152:15"><type pos:start="1152:5" pos:end="1152:7"><name pos:start="1152:5" pos:end="1152:7">int</name></type> <name pos:start="1152:9" pos:end="1152:15">hdr_len</name></decl>;</decl_stmt>

    <expr_stmt pos:start="1154:5" pos:end="1164:48"><expr pos:start="1154:5" pos:end="1164:47"><call pos:start="1154:5" pos:end="1164:47"><name pos:start="1154:5" pos:end="1154:12">snprintf</name><argument_list pos:start="1154:13" pos:end="1164:47">(<argument pos:start="1154:14" pos:end="1154:16"><expr pos:start="1154:14" pos:end="1154:16"><name pos:start="1154:14" pos:end="1154:16">hdr</name></expr></argument>, <argument pos:start="1154:19" pos:end="1154:40"><expr pos:start="1154:19" pos:end="1154:40"><name pos:start="1154:19" pos:end="1154:40">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>, <argument pos:start="1154:43" pos:end="1158:29"><expr pos:start="1154:43" pos:end="1158:29"><literal type="string" pos:start="1154:43" pos:end="1154:70">"GET %s%s%s/%s HTTP/1.1\r\n"</literal>
            <literal type="string" pos:start="1155:13" pos:end="1155:32">"User-Agent: %s\r\n"</literal>
            <literal type="string" pos:start="1156:13" pos:end="1156:35">"Connection: close\r\n"</literal>
            <literal type="string" pos:start="1157:13" pos:end="1157:29">"Host: %s:%d\r\n"</literal>
            <literal type="string" pos:start="1158:13" pos:end="1158:29">"Accept: */*\r\n"</literal></expr></argument>,
            <argument pos:start="1159:13" pos:end="1159:27"><expr pos:start="1159:13" pos:end="1159:27"><name pos:start="1159:13" pos:end="1159:27">EST_PATH_PREFIX</name></expr></argument>,
            <argument pos:start="1160:13" pos:end="1160:42"><expr pos:start="1160:13" pos:end="1160:42"><operator pos:start="1160:13" pos:end="1160:13">(</operator><ternary pos:start="1160:14" pos:end="1160:41"><condition pos:start="1160:14" pos:end="1160:35"><expr pos:start="1160:14" pos:end="1160:34"><name pos:start="1160:14" pos:end="1160:34"><name pos:start="1160:14" pos:end="1160:16">ctx</name><operator pos:start="1160:17" pos:end="1160:18">-&gt;</operator><name pos:start="1160:19" pos:end="1160:34">uri_path_segment</name></name></expr>?</condition><then pos:start="1160:36" pos:end="1160:38"><expr pos:start="1160:36" pos:end="1160:38"><literal type="string" pos:start="1160:36" pos:end="1160:38">"/"</literal></expr></then><else pos:start="1160:39" pos:end="1160:41">:<expr pos:start="1160:40" pos:end="1160:41"><literal type="string" pos:start="1160:40" pos:end="1160:41">""</literal></expr></else></ternary><operator pos:start="1160:42" pos:end="1160:42">)</operator></expr></argument>,
            <argument pos:start="1161:13" pos:end="1161:60"><expr pos:start="1161:13" pos:end="1161:60"><operator pos:start="1161:13" pos:end="1161:13">(</operator><ternary pos:start="1161:14" pos:end="1161:59"><condition pos:start="1161:14" pos:end="1161:35"><expr pos:start="1161:14" pos:end="1161:34"><name pos:start="1161:14" pos:end="1161:34"><name pos:start="1161:14" pos:end="1161:16">ctx</name><operator pos:start="1161:17" pos:end="1161:18">-&gt;</operator><name pos:start="1161:19" pos:end="1161:34">uri_path_segment</name></name></expr>?</condition><then pos:start="1161:36" pos:end="1161:56"><expr pos:start="1161:36" pos:end="1161:56"><name pos:start="1161:36" pos:end="1161:56"><name pos:start="1161:36" pos:end="1161:38">ctx</name><operator pos:start="1161:39" pos:end="1161:40">-&gt;</operator><name pos:start="1161:41" pos:end="1161:56">uri_path_segment</name></name></expr></then><else pos:start="1161:57" pos:end="1161:59">:<expr pos:start="1161:58" pos:end="1161:59"><literal type="string" pos:start="1161:58" pos:end="1161:59">""</literal></expr></else></ternary><operator pos:start="1161:60" pos:end="1161:60">)</operator></expr></argument>,
            <argument pos:start="1162:13" pos:end="1162:27"><expr pos:start="1162:13" pos:end="1162:27"><name pos:start="1162:13" pos:end="1162:27">EST_GET_CACERTS</name></expr></argument>, 
            <argument pos:start="1163:13" pos:end="1163:35"><expr pos:start="1163:13" pos:end="1163:35"><name pos:start="1163:13" pos:end="1163:35">EST_HTTP_HDR_EST_CLIENT</name></expr></argument>,
            <argument pos:start="1164:13" pos:end="1164:27"><expr pos:start="1164:13" pos:end="1164:27"><name pos:start="1164:13" pos:end="1164:27"><name pos:start="1164:13" pos:end="1164:15">ctx</name><operator pos:start="1164:16" pos:end="1164:17">-&gt;</operator><name pos:start="1164:18" pos:end="1164:27">est_server</name></name></expr></argument>, <argument pos:start="1164:30" pos:end="1164:46"><expr pos:start="1164:30" pos:end="1164:46"><name pos:start="1164:30" pos:end="1164:46"><name pos:start="1164:30" pos:end="1164:32">ctx</name><operator pos:start="1164:33" pos:end="1164:34">-&gt;</operator><name pos:start="1164:35" pos:end="1164:46">est_port_num</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1165:5" pos:end="1165:59"><expr pos:start="1165:5" pos:end="1165:58"><name pos:start="1165:5" pos:end="1165:11">hdr_len</name> <operator pos:start="1165:13" pos:end="1165:13">=</operator> <operator pos:start="1165:15" pos:end="1165:15">(</operator><name pos:start="1165:16" pos:end="1165:18">int</name><operator pos:start="1165:19" pos:end="1165:19">)</operator> <call pos:start="1165:21" pos:end="1165:58"><name pos:start="1165:21" pos:end="1165:29">strnlen_s</name><argument_list pos:start="1165:30" pos:end="1165:58">(<argument pos:start="1165:31" pos:end="1165:33"><expr pos:start="1165:31" pos:end="1165:33"><name pos:start="1165:31" pos:end="1165:33">hdr</name></expr></argument>, <argument pos:start="1165:36" pos:end="1165:57"><expr pos:start="1165:36" pos:end="1165:57"><name pos:start="1165:36" pos:end="1165:57">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1166:5" pos:end="1169:5"><if pos:start="1166:5" pos:end="1169:5">if <condition pos:start="1166:8" pos:end="1166:42">(<expr pos:start="1166:9" pos:end="1166:41"><name pos:start="1166:9" pos:end="1166:15">hdr_len</name> <operator pos:start="1166:17" pos:end="1166:18">==</operator> <name pos:start="1166:20" pos:end="1166:41">EST_HTTP_REQ_TOTAL_LEN</name></expr>)</condition> <block pos:start="1166:44" pos:end="1169:5">{<block_content pos:start="1167:9" pos:end="1168:45">
        <expr_stmt pos:start="1167:9" pos:end="1168:45"><expr pos:start="1167:9" pos:end="1168:44"><call pos:start="1167:9" pos:end="1168:44"><name pos:start="1167:9" pos:end="1167:20">EST_LOG_WARN</name><argument_list pos:start="1167:21" pos:end="1168:44">(<argument pos:start="1167:22" pos:end="1167:80"><expr pos:start="1167:22" pos:end="1167:80"><literal type="string" pos:start="1167:22" pos:end="1167:80">"CA Certs header took up the maximum amount in buffer (%d)"</literal></expr></argument>,
                     <argument pos:start="1168:22" pos:end="1168:43"><expr pos:start="1168:22" pos:end="1168:43"><name pos:start="1168:22" pos:end="1168:43">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    
    <return pos:start="1171:5" pos:end="1171:21">return <expr pos:start="1171:12" pos:end="1171:20"><operator pos:start="1171:12" pos:end="1171:12">(</operator><name pos:start="1171:13" pos:end="1171:19">hdr_len</name><operator pos:start="1171:20" pos:end="1171:20">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="1173:1" pos:end="1180:3">/*
 * This function is used to build the HTTP header for
 * the CSR attributes request flow.
 *
 * Parameters:
 *	ctx:	    EST context
 *	hdr:        pointer to the buffer to hold the header
 */</comment>
<function pos:start="1181:1" pos:end="1203:1"><type pos:start="1181:1" pos:end="1181:10"><specifier pos:start="1181:1" pos:end="1181:6">static</specifier> <name pos:start="1181:8" pos:end="1181:10">int</name></type> <name pos:start="1181:12" pos:end="1181:38">est_client_build_csr_header</name> <parameter_list pos:start="1181:40" pos:end="1181:64">(<parameter pos:start="1181:41" pos:end="1181:52"><decl pos:start="1181:41" pos:end="1181:52"><type pos:start="1181:41" pos:end="1181:52"><name pos:start="1181:41" pos:end="1181:47">EST_CTX</name> <modifier pos:start="1181:49" pos:end="1181:49">*</modifier></type><name pos:start="1181:50" pos:end="1181:52">ctx</name></decl></parameter>, <parameter pos:start="1181:55" pos:end="1181:63"><decl pos:start="1181:55" pos:end="1181:63"><type pos:start="1181:55" pos:end="1181:63"><name pos:start="1181:55" pos:end="1181:58">char</name> <modifier pos:start="1181:60" pos:end="1181:60">*</modifier></type><name pos:start="1181:61" pos:end="1181:63">hdr</name></decl></parameter>)</parameter_list>
<block pos:start="1182:1" pos:end="1203:1">{<block_content pos:start="1183:5" pos:end="1202:21">
    <decl_stmt pos:start="1183:5" pos:end="1183:16"><decl pos:start="1183:5" pos:end="1183:15"><type pos:start="1183:5" pos:end="1183:7"><name pos:start="1183:5" pos:end="1183:7">int</name></type> <name pos:start="1183:9" pos:end="1183:15">hdr_len</name></decl>;</decl_stmt>

    <expr_stmt pos:start="1185:5" pos:end="1195:48"><expr pos:start="1185:5" pos:end="1195:47"><call pos:start="1185:5" pos:end="1195:47"><name pos:start="1185:5" pos:end="1185:12">snprintf</name><argument_list pos:start="1185:13" pos:end="1195:47">(<argument pos:start="1185:14" pos:end="1185:16"><expr pos:start="1185:14" pos:end="1185:16"><name pos:start="1185:14" pos:end="1185:16">hdr</name></expr></argument>, <argument pos:start="1185:19" pos:end="1185:40"><expr pos:start="1185:19" pos:end="1185:40"><name pos:start="1185:19" pos:end="1185:40">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>,<argument pos:start="1185:42" pos:end="1189:29"><expr pos:start="1185:42" pos:end="1189:29"><literal type="string" pos:start="1185:42" pos:end="1185:69">"GET %s%s%s/%s HTTP/1.1\r\n"</literal>
            <literal type="string" pos:start="1186:13" pos:end="1186:32">"User-Agent: %s\r\n"</literal>
            <literal type="string" pos:start="1187:13" pos:end="1187:35">"Connection: close\r\n"</literal>
            <literal type="string" pos:start="1188:13" pos:end="1188:29">"Host: %s:%d\r\n"</literal>
            <literal type="string" pos:start="1189:13" pos:end="1189:29">"Accept: */*\r\n"</literal></expr></argument>,
            <argument pos:start="1190:13" pos:end="1190:27"><expr pos:start="1190:13" pos:end="1190:27"><name pos:start="1190:13" pos:end="1190:27">EST_PATH_PREFIX</name></expr></argument>,
            <argument pos:start="1191:13" pos:end="1191:42"><expr pos:start="1191:13" pos:end="1191:42"><operator pos:start="1191:13" pos:end="1191:13">(</operator><ternary pos:start="1191:14" pos:end="1191:41"><condition pos:start="1191:14" pos:end="1191:35"><expr pos:start="1191:14" pos:end="1191:34"><name pos:start="1191:14" pos:end="1191:34"><name pos:start="1191:14" pos:end="1191:16">ctx</name><operator pos:start="1191:17" pos:end="1191:18">-&gt;</operator><name pos:start="1191:19" pos:end="1191:34">uri_path_segment</name></name></expr>?</condition><then pos:start="1191:36" pos:end="1191:38"><expr pos:start="1191:36" pos:end="1191:38"><literal type="string" pos:start="1191:36" pos:end="1191:38">"/"</literal></expr></then><else pos:start="1191:39" pos:end="1191:41">:<expr pos:start="1191:40" pos:end="1191:41"><literal type="string" pos:start="1191:40" pos:end="1191:41">""</literal></expr></else></ternary><operator pos:start="1191:42" pos:end="1191:42">)</operator></expr></argument>,
            <argument pos:start="1192:13" pos:end="1192:60"><expr pos:start="1192:13" pos:end="1192:60"><operator pos:start="1192:13" pos:end="1192:13">(</operator><ternary pos:start="1192:14" pos:end="1192:59"><condition pos:start="1192:14" pos:end="1192:35"><expr pos:start="1192:14" pos:end="1192:34"><name pos:start="1192:14" pos:end="1192:34"><name pos:start="1192:14" pos:end="1192:16">ctx</name><operator pos:start="1192:17" pos:end="1192:18">-&gt;</operator><name pos:start="1192:19" pos:end="1192:34">uri_path_segment</name></name></expr>?</condition><then pos:start="1192:36" pos:end="1192:56"><expr pos:start="1192:36" pos:end="1192:56"><name pos:start="1192:36" pos:end="1192:56"><name pos:start="1192:36" pos:end="1192:38">ctx</name><operator pos:start="1192:39" pos:end="1192:40">-&gt;</operator><name pos:start="1192:41" pos:end="1192:56">uri_path_segment</name></name></expr></then><else pos:start="1192:57" pos:end="1192:59">:<expr pos:start="1192:58" pos:end="1192:59"><literal type="string" pos:start="1192:58" pos:end="1192:59">""</literal></expr></else></ternary><operator pos:start="1192:60" pos:end="1192:60">)</operator></expr></argument>,
            <argument pos:start="1193:13" pos:end="1193:28"><expr pos:start="1193:13" pos:end="1193:28"><name pos:start="1193:13" pos:end="1193:28">EST_GET_CSRATTRS</name></expr></argument>,
            <argument pos:start="1194:13" pos:end="1194:35"><expr pos:start="1194:13" pos:end="1194:35"><name pos:start="1194:13" pos:end="1194:35">EST_HTTP_HDR_EST_CLIENT</name></expr></argument>,
            <argument pos:start="1195:13" pos:end="1195:27"><expr pos:start="1195:13" pos:end="1195:27"><name pos:start="1195:13" pos:end="1195:27"><name pos:start="1195:13" pos:end="1195:15">ctx</name><operator pos:start="1195:16" pos:end="1195:17">-&gt;</operator><name pos:start="1195:18" pos:end="1195:27">est_server</name></name></expr></argument>, <argument pos:start="1195:30" pos:end="1195:46"><expr pos:start="1195:30" pos:end="1195:46"><name pos:start="1195:30" pos:end="1195:46"><name pos:start="1195:30" pos:end="1195:32">ctx</name><operator pos:start="1195:33" pos:end="1195:34">-&gt;</operator><name pos:start="1195:35" pos:end="1195:46">est_port_num</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1196:5" pos:end="1196:61"><expr pos:start="1196:5" pos:end="1196:60"><call pos:start="1196:5" pos:end="1196:60"><name pos:start="1196:5" pos:end="1196:27">est_client_add_auth_hdr</name><argument_list pos:start="1196:28" pos:end="1196:60">(<argument pos:start="1196:29" pos:end="1196:31"><expr pos:start="1196:29" pos:end="1196:31"><name pos:start="1196:29" pos:end="1196:31">ctx</name></expr></argument>, <argument pos:start="1196:34" pos:end="1196:36"><expr pos:start="1196:34" pos:end="1196:36"><name pos:start="1196:34" pos:end="1196:36">hdr</name></expr></argument>, <argument pos:start="1196:39" pos:end="1196:59"><expr pos:start="1196:39" pos:end="1196:59"><name pos:start="1196:39" pos:end="1196:59">EST_SIMPLE_ENROLL_URI</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1197:5" pos:end="1197:59"><expr pos:start="1197:5" pos:end="1197:58"><name pos:start="1197:5" pos:end="1197:11">hdr_len</name> <operator pos:start="1197:13" pos:end="1197:13">=</operator> <operator pos:start="1197:15" pos:end="1197:15">(</operator><name pos:start="1197:16" pos:end="1197:18">int</name><operator pos:start="1197:19" pos:end="1197:19">)</operator> <call pos:start="1197:21" pos:end="1197:58"><name pos:start="1197:21" pos:end="1197:29">strnlen_s</name><argument_list pos:start="1197:30" pos:end="1197:58">(<argument pos:start="1197:31" pos:end="1197:33"><expr pos:start="1197:31" pos:end="1197:33"><name pos:start="1197:31" pos:end="1197:33">hdr</name></expr></argument>, <argument pos:start="1197:36" pos:end="1197:57"><expr pos:start="1197:36" pos:end="1197:57"><name pos:start="1197:36" pos:end="1197:57">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1198:5" pos:end="1201:5"><if pos:start="1198:5" pos:end="1201:5">if <condition pos:start="1198:8" pos:end="1198:42">(<expr pos:start="1198:9" pos:end="1198:41"><name pos:start="1198:9" pos:end="1198:15">hdr_len</name> <operator pos:start="1198:17" pos:end="1198:18">==</operator> <name pos:start="1198:20" pos:end="1198:41">EST_HTTP_REQ_TOTAL_LEN</name></expr>)</condition> <block pos:start="1198:44" pos:end="1201:5">{<block_content pos:start="1199:9" pos:end="1200:45">
        <expr_stmt pos:start="1199:9" pos:end="1200:45"><expr pos:start="1199:9" pos:end="1200:44"><call pos:start="1199:9" pos:end="1200:44"><name pos:start="1199:9" pos:end="1199:20">EST_LOG_WARN</name><argument_list pos:start="1199:21" pos:end="1200:44">(<argument pos:start="1199:22" pos:end="1199:94"><expr pos:start="1199:22" pos:end="1199:94"><literal type="string" pos:start="1199:22" pos:end="1199:94">"CSR attributes request header took up the maximum amount in buffer (%d)"</literal></expr></argument>,
                     <argument pos:start="1200:22" pos:end="1200:43"><expr pos:start="1200:22" pos:end="1200:43"><name pos:start="1200:22" pos:end="1200:43">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    <return pos:start="1202:5" pos:end="1202:21">return <expr pos:start="1202:12" pos:end="1202:20"><operator pos:start="1202:12" pos:end="1202:12">(</operator><name pos:start="1202:13" pos:end="1202:19">hdr_len</name><operator pos:start="1202:20" pos:end="1202:20">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="1204:1" pos:end="1210:3">/*
 * This function does the work for the CSR attributes request flow.
 *
 * Parameters:
 *	ctx:	    EST context
 *	ssl:	    SSL context
 */</comment>
<function pos:start="1211:1" pos:end="1294:1"><type pos:start="1211:1" pos:end="1211:10"><specifier pos:start="1211:1" pos:end="1211:6">static</specifier> <name pos:start="1211:8" pos:end="1211:10">int</name></type> <name pos:start="1211:12" pos:end="1211:43">est_client_send_csrattrs_request</name> <parameter_list pos:start="1211:45" pos:end="1213:63">(<parameter pos:start="1211:46" pos:end="1211:57"><decl pos:start="1211:46" pos:end="1211:57"><type pos:start="1211:46" pos:end="1211:57"><name pos:start="1211:46" pos:end="1211:52">EST_CTX</name> <modifier pos:start="1211:54" pos:end="1211:54">*</modifier></type><name pos:start="1211:55" pos:end="1211:57">ctx</name></decl></parameter>, <parameter pos:start="1211:60" pos:end="1211:67"><decl pos:start="1211:60" pos:end="1211:67"><type pos:start="1211:60" pos:end="1211:67"><name pos:start="1211:60" pos:end="1211:62">SSL</name> <modifier pos:start="1211:64" pos:end="1211:64">*</modifier></type><name pos:start="1211:65" pos:end="1211:67">ssl</name></decl></parameter>,
					     <parameter pos:start="1212:46" pos:end="1212:69"><decl pos:start="1212:46" pos:end="1212:69"><type pos:start="1212:46" pos:end="1212:69"><name pos:start="1212:46" pos:end="1212:53">unsigned</name> <name pos:start="1212:55" pos:end="1212:58">char</name> <modifier pos:start="1212:60" pos:end="1212:60">*</modifier><modifier pos:start="1212:61" pos:end="1212:61">*</modifier></type><name pos:start="1212:62" pos:end="1212:69">csrattrs</name></decl></parameter>, 
					     <parameter pos:start="1213:46" pos:end="1213:62"><decl pos:start="1213:46" pos:end="1213:62"><type pos:start="1213:46" pos:end="1213:62"><name pos:start="1213:46" pos:end="1213:48">int</name> <modifier pos:start="1213:50" pos:end="1213:50">*</modifier></type><name pos:start="1213:51" pos:end="1213:62">csrattrs_len</name></decl></parameter>)</parameter_list>
<block pos:start="1214:1" pos:end="1294:1">{<block_content pos:start="1215:5" pos:end="1293:16">
    <decl_stmt pos:start="1215:5" pos:end="1215:27"><decl pos:start="1215:5" pos:end="1215:26"><type pos:start="1215:5" pos:end="1215:17"><name pos:start="1215:5" pos:end="1215:8">char</name>        <modifier pos:start="1215:17" pos:end="1215:17">*</modifier></type><name pos:start="1215:18" pos:end="1215:26">http_data</name></decl>;</decl_stmt>
    <decl_stmt pos:start="1216:5" pos:end="1216:16"><decl pos:start="1216:5" pos:end="1216:15"><type pos:start="1216:5" pos:end="1216:7"><name pos:start="1216:5" pos:end="1216:7">int</name></type> <name pos:start="1216:9" pos:end="1216:15">hdr_len</name></decl>;</decl_stmt>
    <decl_stmt pos:start="1217:5" pos:end="1217:30"><decl pos:start="1217:5" pos:end="1217:17"><type pos:start="1217:5" pos:end="1217:7"><name pos:start="1217:5" pos:end="1217:7">int</name></type> <name pos:start="1217:9" pos:end="1217:17">read_size</name></decl>, <decl pos:start="1217:20" pos:end="1217:29"><type ref="prev" pos:start="1217:5" pos:end="1217:7"/><name pos:start="1217:20" pos:end="1217:29">write_size</name></decl>;</decl_stmt>
    <decl_stmt pos:start="1218:5" pos:end="1218:40"><decl pos:start="1218:5" pos:end="1218:39"><type pos:start="1218:5" pos:end="1218:19"><name pos:start="1218:5" pos:end="1218:12">unsigned</name> <name pos:start="1218:14" pos:end="1218:17">char</name> <modifier pos:start="1218:19" pos:end="1218:19">*</modifier></type><name pos:start="1218:20" pos:end="1218:32">csr_attrs_buf</name> <init pos:start="1218:34" pos:end="1218:39">= <expr pos:start="1218:36" pos:end="1218:39"><name pos:start="1218:36" pos:end="1218:39">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="1219:5" pos:end="1219:11"><decl pos:start="1219:5" pos:end="1219:10"><type pos:start="1219:5" pos:end="1219:7"><name pos:start="1219:5" pos:end="1219:7">int</name></type> <name pos:start="1219:9" pos:end="1219:10">rv</name></decl>;</decl_stmt>

    <comment type="block" pos:start="1221:5" pos:end="1221:23">/* assume defeat */</comment>
    <expr_stmt pos:start="1222:5" pos:end="1222:21"><expr pos:start="1222:5" pos:end="1222:20"><operator pos:start="1222:5" pos:end="1222:5">*</operator><name pos:start="1222:6" pos:end="1222:13">csrattrs</name> <operator pos:start="1222:15" pos:end="1222:15">=</operator> <name pos:start="1222:17" pos:end="1222:20">NULL</name></expr>;</expr_stmt>
    <expr_stmt pos:start="1223:5" pos:end="1223:22"><expr pos:start="1223:5" pos:end="1223:21"><operator pos:start="1223:5" pos:end="1223:5">*</operator><name pos:start="1223:6" pos:end="1223:17">csrattrs_len</name> <operator pos:start="1223:19" pos:end="1223:19">=</operator> <literal type="number" pos:start="1223:21" pos:end="1223:21">0</literal></expr>;</expr_stmt>
    <comment type="block" pos:start="1224:5" pos:end="1230:7">/*
     * Build the HTTP request
     * - allocate buffer: header, no data, terminating characters
     * - build the header
     * - no data
     * - terminate it
     */</comment>    
    <expr_stmt pos:start="1231:5" pos:end="1231:47"><expr pos:start="1231:5" pos:end="1231:46"><name pos:start="1231:5" pos:end="1231:13">http_data</name> <operator pos:start="1231:15" pos:end="1231:15">=</operator> <call pos:start="1231:17" pos:end="1231:46"><name pos:start="1231:17" pos:end="1231:22">malloc</name><argument_list pos:start="1231:23" pos:end="1231:46">(<argument pos:start="1231:24" pos:end="1231:45"><expr pos:start="1231:24" pos:end="1231:45"><name pos:start="1231:24" pos:end="1231:45">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1232:5" pos:end="1235:5"><if pos:start="1232:5" pos:end="1235:5">if <condition pos:start="1232:8" pos:end="1232:26">(<expr pos:start="1232:9" pos:end="1232:25"><name pos:start="1232:9" pos:end="1232:17">http_data</name> <operator pos:start="1232:19" pos:end="1232:20">==</operator> <name pos:start="1232:22" pos:end="1232:25">NULL</name></expr>)</condition> <block pos:start="1232:28" pos:end="1235:5">{<block_content pos:start="1233:9" pos:end="1234:30">
        <expr_stmt pos:start="1233:9" pos:end="1233:63"><expr pos:start="1233:9" pos:end="1233:62"><call pos:start="1233:9" pos:end="1233:62"><name pos:start="1233:9" pos:end="1233:19">EST_LOG_ERR</name><argument_list pos:start="1233:20" pos:end="1233:62">(<argument pos:start="1233:21" pos:end="1233:61"><expr pos:start="1233:21" pos:end="1233:61"><literal type="string" pos:start="1233:21" pos:end="1233:61">"Unable to allocate memory for http_data"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="1234:9" pos:end="1234:30">return <expr pos:start="1234:16" pos:end="1234:29"><name pos:start="1234:16" pos:end="1234:29">EST_ERR_MALLOC</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    
    <expr_stmt pos:start="1237:5" pos:end="1237:58"><expr pos:start="1237:5" pos:end="1237:57"><name pos:start="1237:5" pos:end="1237:11">hdr_len</name> <operator pos:start="1237:13" pos:end="1237:13">=</operator> <call pos:start="1237:15" pos:end="1237:57"><name pos:start="1237:15" pos:end="1237:41">est_client_build_csr_header</name><argument_list pos:start="1237:42" pos:end="1237:57">(<argument pos:start="1237:43" pos:end="1237:45"><expr pos:start="1237:43" pos:end="1237:45"><name pos:start="1237:43" pos:end="1237:45">ctx</name></expr></argument>, <argument pos:start="1237:48" pos:end="1237:56"><expr pos:start="1237:48" pos:end="1237:56"><name pos:start="1237:48" pos:end="1237:56">http_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <if_stmt pos:start="1239:5" pos:end="1243:5"><if pos:start="1239:5" pos:end="1243:5">if <condition pos:start="1239:8" pos:end="1239:21">(<expr pos:start="1239:9" pos:end="1239:20"><name pos:start="1239:9" pos:end="1239:15">hdr_len</name> <operator pos:start="1239:17" pos:end="1239:18">==</operator> <literal type="number" pos:start="1239:20" pos:end="1239:20">0</literal></expr>)</condition> <block pos:start="1239:23" pos:end="1243:5">{<block_content pos:start="1240:9" pos:end="1242:50">
        <expr_stmt pos:start="1240:9" pos:end="1240:79"><expr pos:start="1240:9" pos:end="1240:78"><call pos:start="1240:9" pos:end="1240:78"><name pos:start="1240:9" pos:end="1240:19">EST_LOG_ERR</name><argument_list pos:start="1240:20" pos:end="1240:78">(<argument pos:start="1240:21" pos:end="1240:77"><expr pos:start="1240:21" pos:end="1240:77"><literal type="string" pos:start="1240:21" pos:end="1240:77">"CSR attributes HTTP header could not be built correctly"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1241:9" pos:end="1241:24"><expr pos:start="1241:9" pos:end="1241:23"><call pos:start="1241:9" pos:end="1241:23"><name pos:start="1241:9" pos:end="1241:12">free</name><argument_list pos:start="1241:13" pos:end="1241:23">(<argument pos:start="1241:14" pos:end="1241:22"><expr pos:start="1241:14" pos:end="1241:22"><name pos:start="1241:14" pos:end="1241:22">http_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="1242:9" pos:end="1242:50">return <expr pos:start="1242:16" pos:end="1242:49"><operator pos:start="1242:16" pos:end="1242:16">(</operator><name pos:start="1242:17" pos:end="1242:48">EST_ERR_HTTP_CANNOT_BUILD_HEADER</name><operator pos:start="1242:49" pos:end="1242:49">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>    

    <comment type="block" pos:start="1245:5" pos:end="1247:7">/*
     * terminate the HTTP header
     */</comment>
    <expr_stmt pos:start="1248:5" pos:end="1248:74"><expr pos:start="1248:5" pos:end="1248:73"><call pos:start="1248:5" pos:end="1248:73"><name pos:start="1248:5" pos:end="1248:12">snprintf</name><argument_list pos:start="1248:13" pos:end="1248:73">(<argument pos:start="1248:14" pos:end="1248:32"><expr pos:start="1248:14" pos:end="1248:32"><name pos:start="1248:14" pos:end="1248:22">http_data</name> <operator pos:start="1248:24" pos:end="1248:24">+</operator> <name pos:start="1248:26" pos:end="1248:32">hdr_len</name></expr></argument>, <argument pos:start="1248:35" pos:end="1248:64"><expr pos:start="1248:35" pos:end="1248:64"><name pos:start="1248:35" pos:end="1248:56">EST_HTTP_REQ_TOTAL_LEN</name><operator pos:start="1248:57" pos:end="1248:57">-</operator><name pos:start="1248:58" pos:end="1248:64">hdr_len</name></expr></argument>, <argument pos:start="1248:67" pos:end="1248:72"><expr pos:start="1248:67" pos:end="1248:72"><literal type="string" pos:start="1248:67" pos:end="1248:72">"\r\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1249:5" pos:end="1249:17"><expr pos:start="1249:5" pos:end="1249:16"><name pos:start="1249:5" pos:end="1249:11">hdr_len</name> <operator pos:start="1249:13" pos:end="1249:14">+=</operator> <literal type="number" pos:start="1249:16" pos:end="1249:16">2</literal></expr>;</expr_stmt>

    <comment type="block" pos:start="1251:5" pos:end="1253:7">/*
     * no data is being sent so go ahead and terminate the HTTP request
     */</comment>
    <expr_stmt pos:start="1254:5" pos:end="1254:74"><expr pos:start="1254:5" pos:end="1254:73"><call pos:start="1254:5" pos:end="1254:73"><name pos:start="1254:5" pos:end="1254:12">snprintf</name><argument_list pos:start="1254:13" pos:end="1254:73">(<argument pos:start="1254:14" pos:end="1254:32"><expr pos:start="1254:14" pos:end="1254:32"><name pos:start="1254:14" pos:end="1254:22">http_data</name> <operator pos:start="1254:24" pos:end="1254:24">+</operator> <name pos:start="1254:26" pos:end="1254:32">hdr_len</name></expr></argument>, <argument pos:start="1254:35" pos:end="1254:64"><expr pos:start="1254:35" pos:end="1254:64"><name pos:start="1254:35" pos:end="1254:56">EST_HTTP_REQ_TOTAL_LEN</name><operator pos:start="1254:57" pos:end="1254:57">-</operator><name pos:start="1254:58" pos:end="1254:64">hdr_len</name></expr></argument>, <argument pos:start="1254:67" pos:end="1254:72"><expr pos:start="1254:67" pos:end="1254:72"><literal type="string" pos:start="1254:67" pos:end="1254:72">"\r\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1255:5" pos:end="1255:17"><expr pos:start="1255:5" pos:end="1255:16"><name pos:start="1255:5" pos:end="1255:11">hdr_len</name> <operator pos:start="1255:13" pos:end="1255:14">+=</operator> <literal type="number" pos:start="1255:16" pos:end="1255:16">2</literal></expr>;</expr_stmt>


    <comment type="block" pos:start="1258:5" pos:end="1260:7">/*
     * Send the request to the server and wait for a response
     */</comment>
    <expr_stmt pos:start="1261:5" pos:end="1261:30"><expr pos:start="1261:5" pos:end="1261:29"><name pos:start="1261:5" pos:end="1261:25"><name pos:start="1261:5" pos:end="1261:7">ctx</name><operator pos:start="1261:8" pos:end="1261:9">-&gt;</operator><name pos:start="1261:10" pos:end="1261:25">last_http_status</name></name> <operator pos:start="1261:27" pos:end="1261:27">=</operator> <literal type="number" pos:start="1261:29" pos:end="1261:29">0</literal></expr>;</expr_stmt>
    <expr_stmt pos:start="1262:5" pos:end="1262:52"><expr pos:start="1262:5" pos:end="1262:51"><name pos:start="1262:5" pos:end="1262:14">write_size</name> <operator pos:start="1262:16" pos:end="1262:16">=</operator> <call pos:start="1262:18" pos:end="1262:51"><name pos:start="1262:18" pos:end="1262:26">SSL_write</name><argument_list pos:start="1262:27" pos:end="1262:51">(<argument pos:start="1262:28" pos:end="1262:30"><expr pos:start="1262:28" pos:end="1262:30"><name pos:start="1262:28" pos:end="1262:30">ssl</name></expr></argument>, <argument pos:start="1262:33" pos:end="1262:41"><expr pos:start="1262:33" pos:end="1262:41"><name pos:start="1262:33" pos:end="1262:41">http_data</name></expr></argument>, <argument pos:start="1262:44" pos:end="1262:50"><expr pos:start="1262:44" pos:end="1262:50"><name pos:start="1262:44" pos:end="1262:50">hdr_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1263:5" pos:end="1291:5"><if pos:start="1263:5" pos:end="1267:5">if <condition pos:start="1263:8" pos:end="1263:23">(<expr pos:start="1263:9" pos:end="1263:22"><name pos:start="1263:9" pos:end="1263:18">write_size</name> <operator pos:start="1263:20" pos:end="1263:20">&lt;</operator> <literal type="number" pos:start="1263:22" pos:end="1263:22">0</literal></expr>)</condition> <block pos:start="1263:25" pos:end="1267:5">{<block_content pos:start="1264:9" pos:end="1266:31">
        <expr_stmt pos:start="1264:9" pos:end="1264:39"><expr pos:start="1264:9" pos:end="1264:38"><call pos:start="1264:9" pos:end="1264:38"><name pos:start="1264:9" pos:end="1264:19">EST_LOG_ERR</name><argument_list pos:start="1264:20" pos:end="1264:38">(<argument pos:start="1264:21" pos:end="1264:37"><expr pos:start="1264:21" pos:end="1264:37"><literal type="string" pos:start="1264:21" pos:end="1264:37">"TLS write error"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt pos:start="1265:9" pos:end="1265:31"><expr pos:start="1265:9" pos:end="1265:30"><call pos:start="1265:9" pos:end="1265:30"><name pos:start="1265:9" pos:end="1265:28">ossl_dump_ssl_errors</name><argument_list pos:start="1265:29" pos:end="1265:30">()</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1266:9" pos:end="1266:31"><expr pos:start="1266:9" pos:end="1266:30"><name pos:start="1266:9" pos:end="1266:10">rv</name> <operator pos:start="1266:12" pos:end="1266:12">=</operator> <name pos:start="1266:14" pos:end="1266:30">EST_ERR_SSL_WRITE</name></expr>;</expr_stmt>
    </block_content>}</block></if> <else pos:start="1267:7" pos:end="1291:5">else <block pos:start="1267:12" pos:end="1291:5">{<block_content pos:start="1268:9" pos:end="1290:9">
        <expr_stmt pos:start="1268:9" pos:end="1269:42"><expr pos:start="1268:9" pos:end="1269:41"><call pos:start="1268:9" pos:end="1269:41"><name pos:start="1268:9" pos:end="1268:20">EST_LOG_INFO</name><argument_list pos:start="1268:21" pos:end="1269:41">(<argument pos:start="1268:22" pos:end="1268:63"><expr pos:start="1268:22" pos:end="1268:63"><literal type="string" pos:start="1268:22" pos:end="1268:63">"TLS wrote %d bytes, attempted %d bytes\n"</literal></expr></argument>,
                     <argument pos:start="1269:22" pos:end="1269:31"><expr pos:start="1269:22" pos:end="1269:31"><name pos:start="1269:22" pos:end="1269:31">write_size</name></expr></argument>, <argument pos:start="1269:34" pos:end="1269:40"><expr pos:start="1269:34" pos:end="1269:40"><name pos:start="1269:34" pos:end="1269:40">hdr_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

	<comment type="block" pos:start="1271:9" pos:end="1273:11">/*
         * Try to get the response from the server
         */</comment>
        <expr_stmt pos:start="1274:9" pos:end="1275:61"><expr pos:start="1274:9" pos:end="1275:60"><name pos:start="1274:9" pos:end="1274:10">rv</name> <operator pos:start="1274:12" pos:end="1274:12">=</operator> <call pos:start="1274:14" pos:end="1275:60"><name pos:start="1274:14" pos:end="1274:32">est_io_get_response</name><argument_list pos:start="1274:33" pos:end="1275:60">(<argument pos:start="1274:34" pos:end="1274:36"><expr pos:start="1274:34" pos:end="1274:36"><name pos:start="1274:34" pos:end="1274:36">ctx</name></expr></argument>, <argument pos:start="1274:39" pos:end="1274:41"><expr pos:start="1274:39" pos:end="1274:41"><name pos:start="1274:39" pos:end="1274:41">ssl</name></expr></argument>, <argument pos:start="1274:44" pos:end="1274:58"><expr pos:start="1274:44" pos:end="1274:58"><name pos:start="1274:44" pos:end="1274:58">EST_OP_CSRATTRS</name></expr></argument>,
                                 <argument pos:start="1275:34" pos:end="1275:47"><expr pos:start="1275:34" pos:end="1275:47"><operator pos:start="1275:34" pos:end="1275:34">&amp;</operator><name pos:start="1275:35" pos:end="1275:47">csr_attrs_buf</name></expr></argument>, <argument pos:start="1275:50" pos:end="1275:59"><expr pos:start="1275:50" pos:end="1275:59"><operator pos:start="1275:50" pos:end="1275:50">&amp;</operator><name pos:start="1275:51" pos:end="1275:59">read_size</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <switch pos:start="1276:9" pos:end="1290:9">switch <condition pos:start="1276:16" pos:end="1276:19">(<expr pos:start="1276:17" pos:end="1276:18"><name pos:start="1276:17" pos:end="1276:18">rv</name></expr>)</condition> <block pos:start="1276:21" pos:end="1290:9">{<block_content pos:start="1277:9" pos:end="1289:18">
        <case pos:start="1277:9" pos:end="1277:26">case <expr pos:start="1277:14" pos:end="1277:25"><name pos:start="1277:14" pos:end="1277:25">EST_ERR_NONE</name></expr>:</case>
	    <if_stmt pos:start="1278:13" pos:end="1281:13"><if pos:start="1278:13" pos:end="1281:13">if <condition pos:start="1278:16" pos:end="1278:38">(<expr pos:start="1278:17" pos:end="1278:37"><name pos:start="1278:17" pos:end="1278:29">csr_attrs_buf</name> <operator pos:start="1278:31" pos:end="1278:32">!=</operator> <name pos:start="1278:34" pos:end="1278:37">NULL</name></expr>)</condition> <block pos:start="1278:40" pos:end="1281:13">{<block_content pos:start="1279:17" pos:end="1280:42">
		<expr_stmt pos:start="1279:17" pos:end="1279:42"><expr pos:start="1279:17" pos:end="1279:41"><operator pos:start="1279:17" pos:end="1279:17">*</operator><name pos:start="1279:18" pos:end="1279:25">csrattrs</name> <operator pos:start="1279:27" pos:end="1279:27">=</operator> <name pos:start="1279:29" pos:end="1279:41">csr_attrs_buf</name></expr>;</expr_stmt>
		<expr_stmt pos:start="1280:17" pos:end="1280:42"><expr pos:start="1280:17" pos:end="1280:41"><operator pos:start="1280:17" pos:end="1280:17">*</operator><name pos:start="1280:18" pos:end="1280:29">csrattrs_len</name> <operator pos:start="1280:31" pos:end="1280:31">=</operator> <name pos:start="1280:33" pos:end="1280:41">read_size</name></expr>;</expr_stmt>
            </block_content>}</block></if></if_stmt>
            <break pos:start="1282:13" pos:end="1282:18">break;</break>
        <case pos:start="1283:9" pos:end="1283:31">case <expr pos:start="1283:14" pos:end="1283:30"><name pos:start="1283:14" pos:end="1283:30">EST_ERR_AUTH_FAIL</name></expr>:</case>
        <default pos:start="1284:9" pos:end="1284:16">default:</default>
            <expr_stmt pos:start="1285:13" pos:end="1285:83"><expr pos:start="1285:13" pos:end="1285:82"><call pos:start="1285:13" pos:end="1285:82"><name pos:start="1285:13" pos:end="1285:23">EST_LOG_ERR</name><argument_list pos:start="1285:24" pos:end="1285:82">(<argument pos:start="1285:25" pos:end="1285:53"><expr pos:start="1285:25" pos:end="1285:53"><literal type="string" pos:start="1285:25" pos:end="1285:53">"EST request failed: %d (%s)"</literal></expr></argument>, <argument pos:start="1285:56" pos:end="1285:57"><expr pos:start="1285:56" pos:end="1285:57"><name pos:start="1285:56" pos:end="1285:57">rv</name></expr></argument>, <argument pos:start="1285:60" pos:end="1285:81"><expr pos:start="1285:60" pos:end="1285:81"><call pos:start="1285:60" pos:end="1285:81"><name pos:start="1285:60" pos:end="1285:77">EST_ERR_NUM_TO_STR</name><argument_list pos:start="1285:78" pos:end="1285:81">(<argument pos:start="1285:79" pos:end="1285:80"><expr pos:start="1285:79" pos:end="1285:80"><name pos:start="1285:79" pos:end="1285:80">rv</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <if_stmt pos:start="1286:13" pos:end="1288:13"><if pos:start="1286:13" pos:end="1288:13">if <condition pos:start="1286:16" pos:end="1286:30">(<expr pos:start="1286:17" pos:end="1286:29"><name pos:start="1286:17" pos:end="1286:29">csr_attrs_buf</name></expr>)</condition> <block pos:start="1286:32" pos:end="1288:13">{<block_content pos:start="1287:17" pos:end="1287:36">
                <expr_stmt pos:start="1287:17" pos:end="1287:36"><expr pos:start="1287:17" pos:end="1287:35"><call pos:start="1287:17" pos:end="1287:35"><name pos:start="1287:17" pos:end="1287:20">free</name><argument_list pos:start="1287:21" pos:end="1287:35">(<argument pos:start="1287:22" pos:end="1287:34"><expr pos:start="1287:22" pos:end="1287:34"><name pos:start="1287:22" pos:end="1287:34">csr_attrs_buf</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            </block_content>}</block></if></if_stmt>
            <break pos:start="1289:13" pos:end="1289:18">break;</break>
        </block_content>}</block></switch>
    </block_content>}</block></else></if_stmt>
    <expr_stmt pos:start="1292:5" pos:end="1292:20"><expr pos:start="1292:5" pos:end="1292:19"><call pos:start="1292:5" pos:end="1292:19"><name pos:start="1292:5" pos:end="1292:8">free</name><argument_list pos:start="1292:9" pos:end="1292:19">(<argument pos:start="1292:10" pos:end="1292:18"><expr pos:start="1292:10" pos:end="1292:18"><name pos:start="1292:10" pos:end="1292:18">http_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return pos:start="1293:5" pos:end="1293:16">return <expr pos:start="1293:12" pos:end="1293:15"><operator pos:start="1293:12" pos:end="1293:12">(</operator><name pos:start="1293:13" pos:end="1293:14">rv</name><operator pos:start="1293:15" pos:end="1293:15">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="1295:1" pos:end="1303:3">/*
 * This function is used to build the HTTP header for
 * the Simple Enroll flow.
 *
 * Parameters:
 *	ctx:	    EST context
 *	hdr:        pointer to the buffer to hold the header
 *      pkcs10_len: length of the buffer pointed to by hdr 
 */</comment>
<function pos:start="1304:1" pos:end="1329:1"><type pos:start="1304:1" pos:end="1304:10"><specifier pos:start="1304:1" pos:end="1304:6">static</specifier> <name pos:start="1304:8" pos:end="1304:10">int</name></type> <name pos:start="1304:12" pos:end="1304:41">est_client_build_enroll_header</name> <parameter_list pos:start="1304:43" pos:end="1304:83">(<parameter pos:start="1304:44" pos:end="1304:55"><decl pos:start="1304:44" pos:end="1304:55"><type pos:start="1304:44" pos:end="1304:55"><name pos:start="1304:44" pos:end="1304:50">EST_CTX</name> <modifier pos:start="1304:52" pos:end="1304:52">*</modifier></type><name pos:start="1304:53" pos:end="1304:55">ctx</name></decl></parameter>, <parameter pos:start="1304:58" pos:end="1304:66"><decl pos:start="1304:58" pos:end="1304:66"><type pos:start="1304:58" pos:end="1304:66"><name pos:start="1304:58" pos:end="1304:61">char</name> <modifier pos:start="1304:63" pos:end="1304:63">*</modifier></type><name pos:start="1304:64" pos:end="1304:66">hdr</name></decl></parameter>, <parameter pos:start="1304:69" pos:end="1304:82"><decl pos:start="1304:69" pos:end="1304:82"><type pos:start="1304:69" pos:end="1304:82"><name pos:start="1304:69" pos:end="1304:71">int</name></type> <name pos:start="1304:73" pos:end="1304:82">pkcs10_len</name></decl></parameter>)</parameter_list>
<block pos:start="1305:1" pos:end="1329:1">{<block_content pos:start="1306:5" pos:end="1328:21">
    <decl_stmt pos:start="1306:5" pos:end="1306:16"><decl pos:start="1306:5" pos:end="1306:15"><type pos:start="1306:5" pos:end="1306:7"><name pos:start="1306:5" pos:end="1306:7">int</name></type> <name pos:start="1306:9" pos:end="1306:15">hdr_len</name></decl>;</decl_stmt>

    <expr_stmt pos:start="1308:5" pos:end="1320:60"><expr pos:start="1308:5" pos:end="1320:59"><call pos:start="1308:5" pos:end="1320:59"><name pos:start="1308:5" pos:end="1308:12">snprintf</name><argument_list pos:start="1308:13" pos:end="1320:59">(<argument pos:start="1308:14" pos:end="1308:16"><expr pos:start="1308:14" pos:end="1308:16"><name pos:start="1308:14" pos:end="1308:16">hdr</name></expr></argument>, <argument pos:start="1308:19" pos:end="1308:40"><expr pos:start="1308:19" pos:end="1308:40"><name pos:start="1308:19" pos:end="1308:40">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>, <argument pos:start="1308:43" pos:end="1314:36"><expr pos:start="1308:43" pos:end="1314:36"><literal type="string" pos:start="1308:43" pos:end="1308:71">"POST %s%s%s/%s HTTP/1.1\r\n"</literal>
            <literal type="string" pos:start="1309:13" pos:end="1309:32">"User-Agent: %s\r\n"</literal>
            <literal type="string" pos:start="1310:13" pos:end="1310:35">"Connection: close\r\n"</literal>
            <literal type="string" pos:start="1311:13" pos:end="1311:29">"Host: %s:%d\r\n"</literal>
            <literal type="string" pos:start="1312:13" pos:end="1312:29">"Accept: */*\r\n"</literal>
            <literal type="string" pos:start="1313:13" pos:end="1313:50">"Content-Type: application/pkcs10\r\n"</literal>
            <literal type="string" pos:start="1314:13" pos:end="1314:36">"Content-Length: %d\r\n"</literal></expr></argument>,
            <argument pos:start="1315:13" pos:end="1315:27"><expr pos:start="1315:13" pos:end="1315:27"><name pos:start="1315:13" pos:end="1315:27">EST_PATH_PREFIX</name></expr></argument>,
            <argument pos:start="1316:13" pos:end="1316:42"><expr pos:start="1316:13" pos:end="1316:42"><operator pos:start="1316:13" pos:end="1316:13">(</operator><ternary pos:start="1316:14" pos:end="1316:41"><condition pos:start="1316:14" pos:end="1316:35"><expr pos:start="1316:14" pos:end="1316:34"><name pos:start="1316:14" pos:end="1316:34"><name pos:start="1316:14" pos:end="1316:16">ctx</name><operator pos:start="1316:17" pos:end="1316:18">-&gt;</operator><name pos:start="1316:19" pos:end="1316:34">uri_path_segment</name></name></expr>?</condition><then pos:start="1316:36" pos:end="1316:38"><expr pos:start="1316:36" pos:end="1316:38"><literal type="string" pos:start="1316:36" pos:end="1316:38">"/"</literal></expr></then><else pos:start="1316:39" pos:end="1316:41">:<expr pos:start="1316:40" pos:end="1316:41"><literal type="string" pos:start="1316:40" pos:end="1316:41">""</literal></expr></else></ternary><operator pos:start="1316:42" pos:end="1316:42">)</operator></expr></argument>,
            <argument pos:start="1317:13" pos:end="1317:60"><expr pos:start="1317:13" pos:end="1317:60"><operator pos:start="1317:13" pos:end="1317:13">(</operator><ternary pos:start="1317:14" pos:end="1317:59"><condition pos:start="1317:14" pos:end="1317:35"><expr pos:start="1317:14" pos:end="1317:34"><name pos:start="1317:14" pos:end="1317:34"><name pos:start="1317:14" pos:end="1317:16">ctx</name><operator pos:start="1317:17" pos:end="1317:18">-&gt;</operator><name pos:start="1317:19" pos:end="1317:34">uri_path_segment</name></name></expr>?</condition><then pos:start="1317:36" pos:end="1317:56"><expr pos:start="1317:36" pos:end="1317:56"><name pos:start="1317:36" pos:end="1317:56"><name pos:start="1317:36" pos:end="1317:38">ctx</name><operator pos:start="1317:39" pos:end="1317:40">-&gt;</operator><name pos:start="1317:41" pos:end="1317:56">uri_path_segment</name></name></expr></then><else pos:start="1317:57" pos:end="1317:59">:<expr pos:start="1317:58" pos:end="1317:59"><literal type="string" pos:start="1317:58" pos:end="1317:59">""</literal></expr></else></ternary><operator pos:start="1317:60" pos:end="1317:60">)</operator></expr></argument>,
            <argument pos:start="1318:13" pos:end="1318:29"><expr pos:start="1318:13" pos:end="1318:29"><name pos:start="1318:13" pos:end="1318:29">EST_SIMPLE_ENROLL</name></expr></argument>, 
            <argument pos:start="1319:13" pos:end="1319:35"><expr pos:start="1319:13" pos:end="1319:35"><name pos:start="1319:13" pos:end="1319:35">EST_HTTP_HDR_EST_CLIENT</name></expr></argument>,
            <argument pos:start="1320:13" pos:end="1320:27"><expr pos:start="1320:13" pos:end="1320:27"><name pos:start="1320:13" pos:end="1320:27"><name pos:start="1320:13" pos:end="1320:15">ctx</name><operator pos:start="1320:16" pos:end="1320:17">-&gt;</operator><name pos:start="1320:18" pos:end="1320:27">est_server</name></name></expr></argument>, <argument pos:start="1320:30" pos:end="1320:46"><expr pos:start="1320:30" pos:end="1320:46"><name pos:start="1320:30" pos:end="1320:46"><name pos:start="1320:30" pos:end="1320:32">ctx</name><operator pos:start="1320:33" pos:end="1320:34">-&gt;</operator><name pos:start="1320:35" pos:end="1320:46">est_port_num</name></name></expr></argument>, <argument pos:start="1320:49" pos:end="1320:58"><expr pos:start="1320:49" pos:end="1320:58"><name pos:start="1320:49" pos:end="1320:58">pkcs10_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1321:5" pos:end="1321:61"><expr pos:start="1321:5" pos:end="1321:60"><call pos:start="1321:5" pos:end="1321:60"><name pos:start="1321:5" pos:end="1321:27">est_client_add_auth_hdr</name><argument_list pos:start="1321:28" pos:end="1321:60">(<argument pos:start="1321:29" pos:end="1321:31"><expr pos:start="1321:29" pos:end="1321:31"><name pos:start="1321:29" pos:end="1321:31">ctx</name></expr></argument>, <argument pos:start="1321:34" pos:end="1321:36"><expr pos:start="1321:34" pos:end="1321:36"><name pos:start="1321:34" pos:end="1321:36">hdr</name></expr></argument>, <argument pos:start="1321:39" pos:end="1321:59"><expr pos:start="1321:39" pos:end="1321:59"><name pos:start="1321:39" pos:end="1321:59">EST_SIMPLE_ENROLL_URI</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1322:5" pos:end="1322:59"><expr pos:start="1322:5" pos:end="1322:58"><name pos:start="1322:5" pos:end="1322:11">hdr_len</name> <operator pos:start="1322:13" pos:end="1322:13">=</operator> <operator pos:start="1322:15" pos:end="1322:15">(</operator><name pos:start="1322:16" pos:end="1322:18">int</name><operator pos:start="1322:19" pos:end="1322:19">)</operator> <call pos:start="1322:21" pos:end="1322:58"><name pos:start="1322:21" pos:end="1322:29">strnlen_s</name><argument_list pos:start="1322:30" pos:end="1322:58">(<argument pos:start="1322:31" pos:end="1322:33"><expr pos:start="1322:31" pos:end="1322:33"><name pos:start="1322:31" pos:end="1322:33">hdr</name></expr></argument>, <argument pos:start="1322:36" pos:end="1322:57"><expr pos:start="1322:36" pos:end="1322:57"><name pos:start="1322:36" pos:end="1322:57">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1323:5" pos:end="1326:5"><if pos:start="1323:5" pos:end="1326:5">if <condition pos:start="1323:8" pos:end="1323:42">(<expr pos:start="1323:9" pos:end="1323:41"><name pos:start="1323:9" pos:end="1323:15">hdr_len</name> <operator pos:start="1323:17" pos:end="1323:18">==</operator> <name pos:start="1323:20" pos:end="1323:41">EST_HTTP_REQ_TOTAL_LEN</name></expr>)</condition> <block pos:start="1323:44" pos:end="1326:5">{<block_content pos:start="1324:9" pos:end="1325:45">
        <expr_stmt pos:start="1324:9" pos:end="1325:45"><expr pos:start="1324:9" pos:end="1325:44"><call pos:start="1324:9" pos:end="1325:44"><name pos:start="1324:9" pos:end="1324:20">EST_LOG_WARN</name><argument_list pos:start="1324:21" pos:end="1325:44">(<argument pos:start="1324:22" pos:end="1324:93"><expr pos:start="1324:22" pos:end="1324:93"><literal type="string" pos:start="1324:22" pos:end="1324:93">"Client enroll request header took up the maximum amount in buffer (%d)"</literal></expr></argument>,
                     <argument pos:start="1325:22" pos:end="1325:43"><expr pos:start="1325:22" pos:end="1325:43"><name pos:start="1325:22" pos:end="1325:43">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    
    <return pos:start="1328:5" pos:end="1328:21">return <expr pos:start="1328:12" pos:end="1328:20"><operator pos:start="1328:12" pos:end="1328:12">(</operator><name pos:start="1328:13" pos:end="1328:19">hdr_len</name><operator pos:start="1328:20" pos:end="1328:20">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="1330:1" pos:end="1338:3">/*
 * This function is used to build the HTTP header for
 * the Simple ReEnroll flow.
 *
 * Parameters:
 *	ctx:	    EST context
 *	hdr:        pointer to the buffer to hold the header
 *      pkcs10_len: length of the buffer pointed to by hdr 
 */</comment>
<function pos:start="1339:1" pos:end="1363:1"><type pos:start="1339:1" pos:end="1339:10"><specifier pos:start="1339:1" pos:end="1339:6">static</specifier> <name pos:start="1339:8" pos:end="1339:10">int</name></type> <name pos:start="1339:12" pos:end="1339:43">est_client_build_reenroll_header</name> <parameter_list pos:start="1339:45" pos:end="1339:85">(<parameter pos:start="1339:46" pos:end="1339:57"><decl pos:start="1339:46" pos:end="1339:57"><type pos:start="1339:46" pos:end="1339:57"><name pos:start="1339:46" pos:end="1339:52">EST_CTX</name> <modifier pos:start="1339:54" pos:end="1339:54">*</modifier></type><name pos:start="1339:55" pos:end="1339:57">ctx</name></decl></parameter>, <parameter pos:start="1339:60" pos:end="1339:68"><decl pos:start="1339:60" pos:end="1339:68"><type pos:start="1339:60" pos:end="1339:68"><name pos:start="1339:60" pos:end="1339:63">char</name> <modifier pos:start="1339:65" pos:end="1339:65">*</modifier></type><name pos:start="1339:66" pos:end="1339:68">hdr</name></decl></parameter>, <parameter pos:start="1339:71" pos:end="1339:84"><decl pos:start="1339:71" pos:end="1339:84"><type pos:start="1339:71" pos:end="1339:84"><name pos:start="1339:71" pos:end="1339:73">int</name></type> <name pos:start="1339:75" pos:end="1339:84">pkcs10_len</name></decl></parameter>)</parameter_list>
<block pos:start="1340:1" pos:end="1363:1">{<block_content pos:start="1341:5" pos:end="1362:21">
    <decl_stmt pos:start="1341:5" pos:end="1341:16"><decl pos:start="1341:5" pos:end="1341:15"><type pos:start="1341:5" pos:end="1341:7"><name pos:start="1341:5" pos:end="1341:7">int</name></type> <name pos:start="1341:9" pos:end="1341:15">hdr_len</name></decl>;</decl_stmt>

    <expr_stmt pos:start="1343:5" pos:end="1355:60"><expr pos:start="1343:5" pos:end="1355:59"><call pos:start="1343:5" pos:end="1355:59"><name pos:start="1343:5" pos:end="1343:12">snprintf</name><argument_list pos:start="1343:13" pos:end="1355:59">(<argument pos:start="1343:14" pos:end="1343:16"><expr pos:start="1343:14" pos:end="1343:16"><name pos:start="1343:14" pos:end="1343:16">hdr</name></expr></argument>, <argument pos:start="1343:19" pos:end="1343:40"><expr pos:start="1343:19" pos:end="1343:40"><name pos:start="1343:19" pos:end="1343:40">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>, <argument pos:start="1343:43" pos:end="1349:36"><expr pos:start="1343:43" pos:end="1349:36"><literal type="string" pos:start="1343:43" pos:end="1343:71">"POST %s%s%s/%s HTTP/1.1\r\n"</literal>
            <literal type="string" pos:start="1344:13" pos:end="1344:32">"User-Agent: %s\r\n"</literal>
            <literal type="string" pos:start="1345:13" pos:end="1345:35">"Connection: close\r\n"</literal>
            <literal type="string" pos:start="1346:13" pos:end="1346:29">"Host: %s:%d\r\n"</literal>
            <literal type="string" pos:start="1347:13" pos:end="1347:29">"Accept: */*\r\n"</literal>
            <literal type="string" pos:start="1348:13" pos:end="1348:50">"Content-Type: application/pkcs10\r\n"</literal>
            <literal type="string" pos:start="1349:13" pos:end="1349:36">"Content-Length: %d\r\n"</literal></expr></argument>,
            <argument pos:start="1350:13" pos:end="1350:27"><expr pos:start="1350:13" pos:end="1350:27"><name pos:start="1350:13" pos:end="1350:27">EST_PATH_PREFIX</name></expr></argument>,
            <argument pos:start="1351:13" pos:end="1351:42"><expr pos:start="1351:13" pos:end="1351:42"><operator pos:start="1351:13" pos:end="1351:13">(</operator><ternary pos:start="1351:14" pos:end="1351:41"><condition pos:start="1351:14" pos:end="1351:35"><expr pos:start="1351:14" pos:end="1351:34"><name pos:start="1351:14" pos:end="1351:34"><name pos:start="1351:14" pos:end="1351:16">ctx</name><operator pos:start="1351:17" pos:end="1351:18">-&gt;</operator><name pos:start="1351:19" pos:end="1351:34">uri_path_segment</name></name></expr>?</condition><then pos:start="1351:36" pos:end="1351:38"><expr pos:start="1351:36" pos:end="1351:38"><literal type="string" pos:start="1351:36" pos:end="1351:38">"/"</literal></expr></then><else pos:start="1351:39" pos:end="1351:41">:<expr pos:start="1351:40" pos:end="1351:41"><literal type="string" pos:start="1351:40" pos:end="1351:41">""</literal></expr></else></ternary><operator pos:start="1351:42" pos:end="1351:42">)</operator></expr></argument>,
            <argument pos:start="1352:13" pos:end="1352:60"><expr pos:start="1352:13" pos:end="1352:60"><operator pos:start="1352:13" pos:end="1352:13">(</operator><ternary pos:start="1352:14" pos:end="1352:59"><condition pos:start="1352:14" pos:end="1352:35"><expr pos:start="1352:14" pos:end="1352:34"><name pos:start="1352:14" pos:end="1352:34"><name pos:start="1352:14" pos:end="1352:16">ctx</name><operator pos:start="1352:17" pos:end="1352:18">-&gt;</operator><name pos:start="1352:19" pos:end="1352:34">uri_path_segment</name></name></expr>?</condition><then pos:start="1352:36" pos:end="1352:56"><expr pos:start="1352:36" pos:end="1352:56"><name pos:start="1352:36" pos:end="1352:56"><name pos:start="1352:36" pos:end="1352:38">ctx</name><operator pos:start="1352:39" pos:end="1352:40">-&gt;</operator><name pos:start="1352:41" pos:end="1352:56">uri_path_segment</name></name></expr></then><else pos:start="1352:57" pos:end="1352:59">:<expr pos:start="1352:58" pos:end="1352:59"><literal type="string" pos:start="1352:58" pos:end="1352:59">""</literal></expr></else></ternary><operator pos:start="1352:60" pos:end="1352:60">)</operator></expr></argument>,
            <argument pos:start="1353:13" pos:end="1353:31"><expr pos:start="1353:13" pos:end="1353:31"><name pos:start="1353:13" pos:end="1353:31">EST_SIMPLE_REENROLL</name></expr></argument>, 
            <argument pos:start="1354:13" pos:end="1354:35"><expr pos:start="1354:13" pos:end="1354:35"><name pos:start="1354:13" pos:end="1354:35">EST_HTTP_HDR_EST_CLIENT</name></expr></argument>,
            <argument pos:start="1355:13" pos:end="1355:27"><expr pos:start="1355:13" pos:end="1355:27"><name pos:start="1355:13" pos:end="1355:27"><name pos:start="1355:13" pos:end="1355:15">ctx</name><operator pos:start="1355:16" pos:end="1355:17">-&gt;</operator><name pos:start="1355:18" pos:end="1355:27">est_server</name></name></expr></argument>, <argument pos:start="1355:30" pos:end="1355:46"><expr pos:start="1355:30" pos:end="1355:46"><name pos:start="1355:30" pos:end="1355:46"><name pos:start="1355:30" pos:end="1355:32">ctx</name><operator pos:start="1355:33" pos:end="1355:34">-&gt;</operator><name pos:start="1355:35" pos:end="1355:46">est_port_num</name></name></expr></argument>, <argument pos:start="1355:49" pos:end="1355:58"><expr pos:start="1355:49" pos:end="1355:58"><name pos:start="1355:49" pos:end="1355:58">pkcs10_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1356:5" pos:end="1356:61"><expr pos:start="1356:5" pos:end="1356:60"><call pos:start="1356:5" pos:end="1356:60"><name pos:start="1356:5" pos:end="1356:27">est_client_add_auth_hdr</name><argument_list pos:start="1356:28" pos:end="1356:60">(<argument pos:start="1356:29" pos:end="1356:31"><expr pos:start="1356:29" pos:end="1356:31"><name pos:start="1356:29" pos:end="1356:31">ctx</name></expr></argument>, <argument pos:start="1356:34" pos:end="1356:36"><expr pos:start="1356:34" pos:end="1356:36"><name pos:start="1356:34" pos:end="1356:36">hdr</name></expr></argument>, <argument pos:start="1356:39" pos:end="1356:59"><expr pos:start="1356:39" pos:end="1356:59"><name pos:start="1356:39" pos:end="1356:59">EST_SIMPLE_ENROLL_URI</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1357:5" pos:end="1357:59"><expr pos:start="1357:5" pos:end="1357:58"><name pos:start="1357:5" pos:end="1357:11">hdr_len</name> <operator pos:start="1357:13" pos:end="1357:13">=</operator> <operator pos:start="1357:15" pos:end="1357:15">(</operator><name pos:start="1357:16" pos:end="1357:18">int</name><operator pos:start="1357:19" pos:end="1357:19">)</operator> <call pos:start="1357:21" pos:end="1357:58"><name pos:start="1357:21" pos:end="1357:29">strnlen_s</name><argument_list pos:start="1357:30" pos:end="1357:58">(<argument pos:start="1357:31" pos:end="1357:33"><expr pos:start="1357:31" pos:end="1357:33"><name pos:start="1357:31" pos:end="1357:33">hdr</name></expr></argument>, <argument pos:start="1357:36" pos:end="1357:57"><expr pos:start="1357:36" pos:end="1357:57"><name pos:start="1357:36" pos:end="1357:57">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1358:5" pos:end="1361:5"><if pos:start="1358:5" pos:end="1361:5">if <condition pos:start="1358:8" pos:end="1358:42">(<expr pos:start="1358:9" pos:end="1358:41"><name pos:start="1358:9" pos:end="1358:15">hdr_len</name> <operator pos:start="1358:17" pos:end="1358:18">==</operator> <name pos:start="1358:20" pos:end="1358:41">EST_HTTP_REQ_TOTAL_LEN</name></expr>)</condition> <block pos:start="1358:44" pos:end="1361:5">{<block_content pos:start="1359:9" pos:end="1360:45">
        <expr_stmt pos:start="1359:9" pos:end="1360:45"><expr pos:start="1359:9" pos:end="1360:44"><call pos:start="1359:9" pos:end="1360:44"><name pos:start="1359:9" pos:end="1359:20">EST_LOG_WARN</name><argument_list pos:start="1359:21" pos:end="1360:44">(<argument pos:start="1359:22" pos:end="1359:95"><expr pos:start="1359:22" pos:end="1359:95"><literal type="string" pos:start="1359:22" pos:end="1359:95">"Client reenroll request header took up the maximum amount in buffer (%d)"</literal></expr></argument>,
                     <argument pos:start="1360:22" pos:end="1360:43"><expr pos:start="1360:22" pos:end="1360:43"><name pos:start="1360:22" pos:end="1360:43">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    <return pos:start="1362:5" pos:end="1362:21">return <expr pos:start="1362:12" pos:end="1362:20"><operator pos:start="1362:12" pos:end="1362:12">(</operator><name pos:start="1362:13" pos:end="1362:19">hdr_len</name><operator pos:start="1362:20" pos:end="1362:20">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="1364:1" pos:end="1380:3">/*
 * This function sends the HTTP request for a Simple Enroll
 * The CSR (pkcs10) is already built at this point.  This
 * function simply creates the HTTP header and body and puts
 * it on the wire.  It then waits for a response from the
 * server and copies the response to a buffer provided by
 * the caller
 *
 * Parameters:
 *	ctx:	    EST context
 *	ssl:	    SSL context
 *	bptr:	    pointer containing PKCS10 CSR
 *	pkcs7:	    pointer that will receive the pkcs7 response
 *	pkcs7_len:  length of pkcs7 response
 *	reenroll:   Set to 1 to do a reenroll instead of an enroll
 *
 */</comment>
<function pos:start="1381:1" pos:end="1486:1"><type pos:start="1381:1" pos:end="1381:3"><name pos:start="1381:1" pos:end="1381:3">int</name></type> <name pos:start="1381:5" pos:end="1381:34">est_client_send_enroll_request</name> <parameter_list pos:start="1381:36" pos:end="1383:49">(<parameter pos:start="1381:37" pos:end="1381:48"><decl pos:start="1381:37" pos:end="1381:48"><type pos:start="1381:37" pos:end="1381:48"><name pos:start="1381:37" pos:end="1381:43">EST_CTX</name> <modifier pos:start="1381:45" pos:end="1381:45">*</modifier></type><name pos:start="1381:46" pos:end="1381:48">ctx</name></decl></parameter>, <parameter pos:start="1381:51" pos:end="1381:58"><decl pos:start="1381:51" pos:end="1381:58"><type pos:start="1381:51" pos:end="1381:58"><name pos:start="1381:51" pos:end="1381:53">SSL</name> <modifier pos:start="1381:55" pos:end="1381:55">*</modifier></type><name pos:start="1381:56" pos:end="1381:58">ssl</name></decl></parameter>, <parameter pos:start="1381:61" pos:end="1381:73"><decl pos:start="1381:61" pos:end="1381:73"><type pos:start="1381:61" pos:end="1381:73"><name pos:start="1381:61" pos:end="1381:67">BUF_MEM</name> <modifier pos:start="1381:69" pos:end="1381:69">*</modifier></type><name pos:start="1381:70" pos:end="1381:73">bptr</name></decl></parameter>,
                                    <parameter pos:start="1382:37" pos:end="1382:56"><decl pos:start="1382:37" pos:end="1382:56"><type pos:start="1382:37" pos:end="1382:56"><name pos:start="1382:37" pos:end="1382:44">unsigned</name> <name pos:start="1382:46" pos:end="1382:49">char</name> <modifier pos:start="1382:51" pos:end="1382:51">*</modifier></type><name pos:start="1382:52" pos:end="1382:56">pkcs7</name></decl></parameter>, <parameter pos:start="1382:59" pos:end="1382:72"><decl pos:start="1382:59" pos:end="1382:72"><type pos:start="1382:59" pos:end="1382:72"><name pos:start="1382:59" pos:end="1382:61">int</name> <modifier pos:start="1382:63" pos:end="1382:63">*</modifier></type><name pos:start="1382:64" pos:end="1382:72">pkcs7_len</name></decl></parameter>,
				    <parameter pos:start="1383:37" pos:end="1383:48"><decl pos:start="1383:37" pos:end="1383:48"><type pos:start="1383:37" pos:end="1383:48"><name pos:start="1383:37" pos:end="1383:39">int</name></type> <name pos:start="1383:41" pos:end="1383:48">reenroll</name></decl></parameter>)</parameter_list>
<block pos:start="1384:1" pos:end="1486:1">{<block_content pos:start="1385:5" pos:end="1485:16">
    <decl_stmt pos:start="1385:5" pos:end="1385:20"><decl pos:start="1385:5" pos:end="1385:19"><type pos:start="1385:5" pos:end="1385:10"><name pos:start="1385:5" pos:end="1385:8">char</name> <modifier pos:start="1385:10" pos:end="1385:10">*</modifier></type><name pos:start="1385:11" pos:end="1385:19">http_data</name></decl>;</decl_stmt>
    <decl_stmt pos:start="1386:5" pos:end="1386:16"><decl pos:start="1386:5" pos:end="1386:15"><type pos:start="1386:5" pos:end="1386:7"><name pos:start="1386:5" pos:end="1386:7">int</name></type> <name pos:start="1386:9" pos:end="1386:15">hdr_len</name></decl>;</decl_stmt>
    <decl_stmt pos:start="1387:5" pos:end="1387:19"><decl pos:start="1387:5" pos:end="1387:18"><type pos:start="1387:5" pos:end="1387:7"><name pos:start="1387:5" pos:end="1387:7">int</name></type> <name pos:start="1387:9" pos:end="1387:18">write_size</name></decl>;</decl_stmt>
    <decl_stmt pos:start="1388:5" pos:end="1388:37"><decl pos:start="1388:5" pos:end="1388:36"><type pos:start="1388:5" pos:end="1388:19"><name pos:start="1388:5" pos:end="1388:12">unsigned</name> <name pos:start="1388:14" pos:end="1388:17">char</name> <modifier pos:start="1388:19" pos:end="1388:19">*</modifier></type><name pos:start="1388:20" pos:end="1388:29">enroll_buf</name> <init pos:start="1388:31" pos:end="1388:36">= <expr pos:start="1388:33" pos:end="1388:36"><name pos:start="1388:33" pos:end="1388:36">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="1389:5" pos:end="1389:27"><decl pos:start="1389:5" pos:end="1389:26"><type pos:start="1389:5" pos:end="1389:7"><name pos:start="1389:5" pos:end="1389:7">int</name></type> <name pos:start="1389:9" pos:end="1389:22">enroll_buf_len</name> <init pos:start="1389:24" pos:end="1389:26">= <expr pos:start="1389:26" pos:end="1389:26"><literal type="number" pos:start="1389:26" pos:end="1389:26">0</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="1390:5" pos:end="1390:11"><decl pos:start="1390:5" pos:end="1390:10"><type pos:start="1390:5" pos:end="1390:7"><name pos:start="1390:5" pos:end="1390:7">int</name></type> <name pos:start="1390:9" pos:end="1390:10">rv</name></decl>;</decl_stmt>

    <comment type="block" pos:start="1392:5" pos:end="1395:7">/*
     * Assume the enroll will fail, set return length to zero
     * to be defensive.
     */</comment>
    <expr_stmt pos:start="1396:5" pos:end="1396:19"><expr pos:start="1396:5" pos:end="1396:18"><operator pos:start="1396:5" pos:end="1396:5">*</operator><name pos:start="1396:6" pos:end="1396:14">pkcs7_len</name> <operator pos:start="1396:16" pos:end="1396:16">=</operator> <literal type="number" pos:start="1396:18" pos:end="1396:18">0</literal></expr>;</expr_stmt>

    <comment type="block" pos:start="1398:5" pos:end="1404:7">/*
     * Build the HTTP request
     * - allocate buffer: header, data, terminating characters
     * - build the header
     * - no data
     * - terminate it
     */</comment>    
    <expr_stmt pos:start="1405:5" pos:end="1405:47"><expr pos:start="1405:5" pos:end="1405:46"><name pos:start="1405:5" pos:end="1405:13">http_data</name> <operator pos:start="1405:15" pos:end="1405:15">=</operator> <call pos:start="1405:17" pos:end="1405:46"><name pos:start="1405:17" pos:end="1405:22">malloc</name><argument_list pos:start="1405:23" pos:end="1405:46">(<argument pos:start="1405:24" pos:end="1405:45"><expr pos:start="1405:24" pos:end="1405:45"><name pos:start="1405:24" pos:end="1405:45">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1406:5" pos:end="1409:5"><if pos:start="1406:5" pos:end="1409:5">if <condition pos:start="1406:8" pos:end="1406:26">(<expr pos:start="1406:9" pos:end="1406:25"><name pos:start="1406:9" pos:end="1406:17">http_data</name> <operator pos:start="1406:19" pos:end="1406:20">==</operator> <name pos:start="1406:22" pos:end="1406:25">NULL</name></expr>)</condition> <block pos:start="1406:28" pos:end="1409:5">{<block_content pos:start="1407:9" pos:end="1408:30">
        <expr_stmt pos:start="1407:9" pos:end="1407:63"><expr pos:start="1407:9" pos:end="1407:62"><call pos:start="1407:9" pos:end="1407:62"><name pos:start="1407:9" pos:end="1407:19">EST_LOG_ERR</name><argument_list pos:start="1407:20" pos:end="1407:62">(<argument pos:start="1407:21" pos:end="1407:61"><expr pos:start="1407:21" pos:end="1407:61"><literal type="string" pos:start="1407:21" pos:end="1407:61">"Unable to allocate memory for http_data"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="1408:9" pos:end="1408:30">return <expr pos:start="1408:16" pos:end="1408:29"><name pos:start="1408:16" pos:end="1408:29">EST_ERR_MALLOC</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="1411:5" pos:end="1417:5"><if pos:start="1411:5" pos:end="1414:5">if <condition pos:start="1411:8" pos:end="1411:18">(<expr pos:start="1411:9" pos:end="1411:17"><operator pos:start="1411:9" pos:end="1411:9">!</operator><name pos:start="1411:10" pos:end="1411:17">reenroll</name></expr>)</condition> <block pos:start="1411:20" pos:end="1414:5">{<block_content pos:start="1413:9" pos:end="1413:85">
	<comment type="block" pos:start="1412:9" pos:end="1412:37">/* Perform a /simpleenroll */</comment>
        <expr_stmt pos:start="1413:9" pos:end="1413:85"><expr pos:start="1413:9" pos:end="1413:84"><name pos:start="1413:9" pos:end="1413:15">hdr_len</name> <operator pos:start="1413:17" pos:end="1413:17">=</operator> <call pos:start="1413:19" pos:end="1413:84"><name pos:start="1413:19" pos:end="1413:48">est_client_build_enroll_header</name><argument_list pos:start="1413:49" pos:end="1413:84">(<argument pos:start="1413:50" pos:end="1413:52"><expr pos:start="1413:50" pos:end="1413:52"><name pos:start="1413:50" pos:end="1413:52">ctx</name></expr></argument>, <argument pos:start="1413:55" pos:end="1413:63"><expr pos:start="1413:55" pos:end="1413:63"><name pos:start="1413:55" pos:end="1413:63">http_data</name></expr></argument>, <argument pos:start="1413:66" pos:end="1413:83"><expr pos:start="1413:66" pos:end="1413:83"><operator pos:start="1413:66" pos:end="1413:66">(</operator><name pos:start="1413:67" pos:end="1413:69">int</name><operator pos:start="1413:70" pos:end="1413:70">)</operator> <name pos:start="1413:72" pos:end="1413:83"><name pos:start="1413:72" pos:end="1413:75">bptr</name><operator pos:start="1413:76" pos:end="1413:77">-&gt;</operator><name pos:start="1413:78" pos:end="1413:83">length</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if> <else pos:start="1414:7" pos:end="1417:5">else <block pos:start="1414:12" pos:end="1417:5">{<block_content pos:start="1416:9" pos:end="1416:87">
	<comment type="block" pos:start="1415:9" pos:end="1415:39">/* Perform a /simplereenroll */</comment>
        <expr_stmt pos:start="1416:9" pos:end="1416:87"><expr pos:start="1416:9" pos:end="1416:86"><name pos:start="1416:9" pos:end="1416:15">hdr_len</name> <operator pos:start="1416:17" pos:end="1416:17">=</operator> <call pos:start="1416:19" pos:end="1416:86"><name pos:start="1416:19" pos:end="1416:50">est_client_build_reenroll_header</name><argument_list pos:start="1416:51" pos:end="1416:86">(<argument pos:start="1416:52" pos:end="1416:54"><expr pos:start="1416:52" pos:end="1416:54"><name pos:start="1416:52" pos:end="1416:54">ctx</name></expr></argument>, <argument pos:start="1416:57" pos:end="1416:65"><expr pos:start="1416:57" pos:end="1416:65"><name pos:start="1416:57" pos:end="1416:65">http_data</name></expr></argument>, <argument pos:start="1416:68" pos:end="1416:85"><expr pos:start="1416:68" pos:end="1416:85"><operator pos:start="1416:68" pos:end="1416:68">(</operator><name pos:start="1416:69" pos:end="1416:71">int</name><operator pos:start="1416:72" pos:end="1416:72">)</operator> <name pos:start="1416:74" pos:end="1416:85"><name pos:start="1416:74" pos:end="1416:77">bptr</name><operator pos:start="1416:78" pos:end="1416:79">-&gt;</operator><name pos:start="1416:80" pos:end="1416:85">length</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></else></if_stmt>

    <if_stmt pos:start="1419:5" pos:end="1423:5"><if pos:start="1419:5" pos:end="1423:5">if <condition pos:start="1419:8" pos:end="1419:21">(<expr pos:start="1419:9" pos:end="1419:20"><name pos:start="1419:9" pos:end="1419:15">hdr_len</name> <operator pos:start="1419:17" pos:end="1419:18">==</operator> <literal type="number" pos:start="1419:20" pos:end="1419:20">0</literal></expr>)</condition> <block pos:start="1419:23" pos:end="1423:5">{<block_content pos:start="1420:9" pos:end="1422:50">
        <expr_stmt pos:start="1420:9" pos:end="1420:71"><expr pos:start="1420:9" pos:end="1420:70"><call pos:start="1420:9" pos:end="1420:70"><name pos:start="1420:9" pos:end="1420:19">EST_LOG_ERR</name><argument_list pos:start="1420:20" pos:end="1420:70">(<argument pos:start="1420:21" pos:end="1420:69"><expr pos:start="1420:21" pos:end="1420:69"><literal type="string" pos:start="1420:21" pos:end="1420:69">"Enroll HTTP header could not be built correctly"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1421:9" pos:end="1421:24"><expr pos:start="1421:9" pos:end="1421:23"><call pos:start="1421:9" pos:end="1421:23"><name pos:start="1421:9" pos:end="1421:12">free</name><argument_list pos:start="1421:13" pos:end="1421:23">(<argument pos:start="1421:14" pos:end="1421:22"><expr pos:start="1421:14" pos:end="1421:22"><name pos:start="1421:14" pos:end="1421:22">http_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="1422:9" pos:end="1422:50">return <expr pos:start="1422:16" pos:end="1422:49"><operator pos:start="1422:16" pos:end="1422:16">(</operator><name pos:start="1422:17" pos:end="1422:48">EST_ERR_HTTP_CANNOT_BUILD_HEADER</name><operator pos:start="1422:49" pos:end="1422:49">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
        
    <comment type="block" pos:start="1425:5" pos:end="1427:7">/*
     * terminate the HTTP header
     */</comment>
    <expr_stmt pos:start="1428:5" pos:end="1428:73"><expr pos:start="1428:5" pos:end="1428:72"><call pos:start="1428:5" pos:end="1428:72"><name pos:start="1428:5" pos:end="1428:12">snprintf</name><argument_list pos:start="1428:13" pos:end="1428:72">(<argument pos:start="1428:14" pos:end="1428:32"><expr pos:start="1428:14" pos:end="1428:32"><name pos:start="1428:14" pos:end="1428:22">http_data</name> <operator pos:start="1428:24" pos:end="1428:24">+</operator> <name pos:start="1428:26" pos:end="1428:32">hdr_len</name></expr></argument>,<argument pos:start="1428:34" pos:end="1428:63"><expr pos:start="1428:34" pos:end="1428:63"><name pos:start="1428:34" pos:end="1428:55">EST_HTTP_REQ_TOTAL_LEN</name><operator pos:start="1428:56" pos:end="1428:56">-</operator><name pos:start="1428:57" pos:end="1428:63">hdr_len</name></expr></argument>, <argument pos:start="1428:66" pos:end="1428:71"><expr pos:start="1428:66" pos:end="1428:71"><literal type="string" pos:start="1428:66" pos:end="1428:71">"\r\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1429:5" pos:end="1429:17"><expr pos:start="1429:5" pos:end="1429:16"><name pos:start="1429:5" pos:end="1429:11">hdr_len</name> <operator pos:start="1429:13" pos:end="1429:14">+=</operator> <literal type="number" pos:start="1429:16" pos:end="1429:16">2</literal></expr>;</expr_stmt>

    <comment type="block" pos:start="1431:5" pos:end="1433:7">/*
     * Build the HTTP body containing the pkcs10 request
     */</comment>
    <expr_stmt pos:start="1434:5" pos:end="1435:48"><expr pos:start="1434:5" pos:end="1435:47"><call pos:start="1434:5" pos:end="1435:47"><name pos:start="1434:5" pos:end="1434:12">memcpy_s</name><argument_list pos:start="1434:13" pos:end="1435:47">(<argument pos:start="1434:14" pos:end="1434:32"><expr pos:start="1434:14" pos:end="1434:32"><name pos:start="1434:14" pos:end="1434:22">http_data</name> <operator pos:start="1434:24" pos:end="1434:24">+</operator> <name pos:start="1434:26" pos:end="1434:32">hdr_len</name></expr></argument>, <argument pos:start="1434:35" pos:end="1434:55"><expr pos:start="1434:35" pos:end="1434:55"><name pos:start="1434:35" pos:end="1434:55">EST_HTTP_REQ_DATA_MAX</name></expr></argument>,
             <argument pos:start="1435:14" pos:end="1435:23"><expr pos:start="1435:14" pos:end="1435:23"><name pos:start="1435:14" pos:end="1435:23"><name pos:start="1435:14" pos:end="1435:17">bptr</name><operator pos:start="1435:18" pos:end="1435:19">-&gt;</operator><name pos:start="1435:20" pos:end="1435:23">data</name></name></expr></argument>, <argument pos:start="1435:26" pos:end="1435:46"><expr pos:start="1435:26" pos:end="1435:46"><operator pos:start="1435:26" pos:end="1435:26">(</operator><name pos:start="1435:27" pos:end="1435:33">rsize_t</name><operator pos:start="1435:34" pos:end="1435:34">)</operator><name pos:start="1435:35" pos:end="1435:46"><name pos:start="1435:35" pos:end="1435:38">bptr</name><operator pos:start="1435:39" pos:end="1435:40">-&gt;</operator><name pos:start="1435:41" pos:end="1435:46">length</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1436:5" pos:end="1436:28"><expr pos:start="1436:5" pos:end="1436:27"><name pos:start="1436:5" pos:end="1436:11">hdr_len</name> <operator pos:start="1436:13" pos:end="1436:14">+=</operator> <name pos:start="1436:16" pos:end="1436:27"><name pos:start="1436:16" pos:end="1436:19">bptr</name><operator pos:start="1436:20" pos:end="1436:21">-&gt;</operator><name pos:start="1436:22" pos:end="1436:27">length</name></name></expr>;</expr_stmt>

    <comment type="block" pos:start="1438:5" pos:end="1440:7">/*
     * terminate the HTTP request
     */</comment>
    <expr_stmt pos:start="1441:5" pos:end="1441:73"><expr pos:start="1441:5" pos:end="1441:72"><call pos:start="1441:5" pos:end="1441:72"><name pos:start="1441:5" pos:end="1441:12">snprintf</name><argument_list pos:start="1441:13" pos:end="1441:72">(<argument pos:start="1441:14" pos:end="1441:32"><expr pos:start="1441:14" pos:end="1441:32"><name pos:start="1441:14" pos:end="1441:22">http_data</name> <operator pos:start="1441:24" pos:end="1441:24">+</operator> <name pos:start="1441:26" pos:end="1441:32">hdr_len</name></expr></argument>, <argument pos:start="1441:35" pos:end="1441:64"><expr pos:start="1441:35" pos:end="1441:64"><name pos:start="1441:35" pos:end="1441:56">EST_HTTP_REQ_TOTAL_LEN</name><operator pos:start="1441:57" pos:end="1441:57">-</operator><name pos:start="1441:58" pos:end="1441:64">hdr_len</name></expr></argument>,<argument pos:start="1441:66" pos:end="1441:71"><expr pos:start="1441:66" pos:end="1441:71"><literal type="string" pos:start="1441:66" pos:end="1441:71">"\r\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1442:5" pos:end="1442:17"><expr pos:start="1442:5" pos:end="1442:16"><name pos:start="1442:5" pos:end="1442:11">hdr_len</name> <operator pos:start="1442:13" pos:end="1442:14">+=</operator> <literal type="number" pos:start="1442:16" pos:end="1442:16">2</literal></expr>;</expr_stmt>


    <comment type="block" pos:start="1445:5" pos:end="1447:7">/*
     * Send the request to the server and wait for a response
     */</comment>
    <expr_stmt pos:start="1448:5" pos:end="1448:30"><expr pos:start="1448:5" pos:end="1448:29"><name pos:start="1448:5" pos:end="1448:25"><name pos:start="1448:5" pos:end="1448:7">ctx</name><operator pos:start="1448:8" pos:end="1448:9">-&gt;</operator><name pos:start="1448:10" pos:end="1448:25">last_http_status</name></name> <operator pos:start="1448:27" pos:end="1448:27">=</operator> <literal type="number" pos:start="1448:29" pos:end="1448:29">0</literal></expr>;</expr_stmt>
    <expr_stmt pos:start="1449:5" pos:end="1449:52"><expr pos:start="1449:5" pos:end="1449:51"><name pos:start="1449:5" pos:end="1449:14">write_size</name> <operator pos:start="1449:16" pos:end="1449:16">=</operator> <call pos:start="1449:18" pos:end="1449:51"><name pos:start="1449:18" pos:end="1449:26">SSL_write</name><argument_list pos:start="1449:27" pos:end="1449:51">(<argument pos:start="1449:28" pos:end="1449:30"><expr pos:start="1449:28" pos:end="1449:30"><name pos:start="1449:28" pos:end="1449:30">ssl</name></expr></argument>, <argument pos:start="1449:33" pos:end="1449:41"><expr pos:start="1449:33" pos:end="1449:41"><name pos:start="1449:33" pos:end="1449:41">http_data</name></expr></argument>, <argument pos:start="1449:44" pos:end="1449:50"><expr pos:start="1449:44" pos:end="1449:50"><name pos:start="1449:44" pos:end="1449:50">hdr_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1450:5" pos:end="1481:5"><if pos:start="1450:5" pos:end="1454:5">if <condition pos:start="1450:8" pos:end="1450:23">(<expr pos:start="1450:9" pos:end="1450:22"><name pos:start="1450:9" pos:end="1450:18">write_size</name> <operator pos:start="1450:20" pos:end="1450:20">&lt;</operator> <literal type="number" pos:start="1450:22" pos:end="1450:22">0</literal></expr>)</condition> <block pos:start="1450:25" pos:end="1454:5">{<block_content pos:start="1451:9" pos:end="1453:31">
        <expr_stmt pos:start="1451:9" pos:end="1451:39"><expr pos:start="1451:9" pos:end="1451:38"><call pos:start="1451:9" pos:end="1451:38"><name pos:start="1451:9" pos:end="1451:19">EST_LOG_ERR</name><argument_list pos:start="1451:20" pos:end="1451:38">(<argument pos:start="1451:21" pos:end="1451:37"><expr pos:start="1451:21" pos:end="1451:37"><literal type="string" pos:start="1451:21" pos:end="1451:37">"TLS write error"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt pos:start="1452:9" pos:end="1452:31"><expr pos:start="1452:9" pos:end="1452:30"><call pos:start="1452:9" pos:end="1452:30"><name pos:start="1452:9" pos:end="1452:28">ossl_dump_ssl_errors</name><argument_list pos:start="1452:29" pos:end="1452:30">()</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1453:9" pos:end="1453:31"><expr pos:start="1453:9" pos:end="1453:30"><name pos:start="1453:9" pos:end="1453:10">rv</name> <operator pos:start="1453:12" pos:end="1453:12">=</operator> <name pos:start="1453:14" pos:end="1453:30">EST_ERR_SSL_WRITE</name></expr>;</expr_stmt>
    </block_content>}</block></if> <else pos:start="1454:7" pos:end="1481:5">else <block pos:start="1454:12" pos:end="1481:5">{<block_content pos:start="1455:9" pos:end="1480:25">
        <expr_stmt pos:start="1455:9" pos:end="1456:42"><expr pos:start="1455:9" pos:end="1456:41"><call pos:start="1455:9" pos:end="1456:41"><name pos:start="1455:9" pos:end="1455:20">EST_LOG_INFO</name><argument_list pos:start="1455:21" pos:end="1456:41">(<argument pos:start="1455:22" pos:end="1455:63"><expr pos:start="1455:22" pos:end="1455:63"><literal type="string" pos:start="1455:22" pos:end="1455:63">"TLS wrote %d bytes, attempted %d bytes\n"</literal></expr></argument>,
                     <argument pos:start="1456:22" pos:end="1456:31"><expr pos:start="1456:22" pos:end="1456:31"><name pos:start="1456:22" pos:end="1456:31">write_size</name></expr></argument>, <argument pos:start="1456:34" pos:end="1456:40"><expr pos:start="1456:34" pos:end="1456:40"><name pos:start="1456:34" pos:end="1456:40">hdr_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

        <comment type="block" pos:start="1458:9" pos:end="1460:11">/*
         * Try to get the response from the server
         */</comment>
        <expr_stmt pos:start="1461:9" pos:end="1462:63"><expr pos:start="1461:9" pos:end="1462:62"><name pos:start="1461:9" pos:end="1461:10">rv</name> <operator pos:start="1461:12" pos:end="1461:12">=</operator> <call pos:start="1461:14" pos:end="1462:62"><name pos:start="1461:14" pos:end="1461:32">est_io_get_response</name><argument_list pos:start="1461:33" pos:end="1462:62">(<argument pos:start="1461:34" pos:end="1461:36"><expr pos:start="1461:34" pos:end="1461:36"><name pos:start="1461:34" pos:end="1461:36">ctx</name></expr></argument>, <argument pos:start="1461:39" pos:end="1461:41"><expr pos:start="1461:39" pos:end="1461:41"><name pos:start="1461:39" pos:end="1461:41">ssl</name></expr></argument>, <argument pos:start="1461:44" pos:end="1461:63"><expr pos:start="1461:44" pos:end="1461:63"><name pos:start="1461:44" pos:end="1461:63">EST_OP_SIMPLE_ENROLL</name></expr></argument>,
                                 <argument pos:start="1462:34" pos:end="1462:44"><expr pos:start="1462:34" pos:end="1462:44"><operator pos:start="1462:34" pos:end="1462:34">&amp;</operator><name pos:start="1462:35" pos:end="1462:44">enroll_buf</name></expr></argument>, <argument pos:start="1462:47" pos:end="1462:61"><expr pos:start="1462:47" pos:end="1462:61"><operator pos:start="1462:47" pos:end="1462:47">&amp;</operator><name pos:start="1462:48" pos:end="1462:61">enroll_buf_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <switch pos:start="1463:9" pos:end="1479:9">switch <condition pos:start="1463:16" pos:end="1463:19">(<expr pos:start="1463:17" pos:end="1463:18"><name pos:start="1463:17" pos:end="1463:18">rv</name></expr>)</condition> <block pos:start="1463:21" pos:end="1479:9">{<block_content pos:start="1464:9" pos:end="1478:18">
        <case pos:start="1464:9" pos:end="1464:26">case <expr pos:start="1464:14" pos:end="1464:25"><name pos:start="1464:14" pos:end="1464:25">EST_ERR_NONE</name></expr>:</case>
            <if_stmt pos:start="1465:13" pos:end="1469:13"><if pos:start="1465:13" pos:end="1469:13">if <condition pos:start="1465:16" pos:end="1465:36">(<expr pos:start="1465:17" pos:end="1465:35"><name pos:start="1465:17" pos:end="1465:30">enroll_buf_len</name> <operator pos:start="1465:32" pos:end="1465:33">==</operator> <literal type="number" pos:start="1465:35" pos:end="1465:35">0</literal></expr>)</condition> <block pos:start="1465:38" pos:end="1469:13">{<block_content pos:start="1466:17" pos:end="1468:22">
                <expr_stmt pos:start="1466:17" pos:end="1466:66"><expr pos:start="1466:17" pos:end="1466:65"><call pos:start="1466:17" pos:end="1466:65"><name pos:start="1466:17" pos:end="1466:27">EST_LOG_ERR</name><argument_list pos:start="1466:28" pos:end="1466:65">(<argument pos:start="1466:29" pos:end="1466:64"><expr pos:start="1466:29" pos:end="1466:64"><literal type="string" pos:start="1466:29" pos:end="1466:64">"Enroll buf is zero bytes in length"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt pos:start="1467:17" pos:end="1467:45"><expr pos:start="1467:17" pos:end="1467:44"><name pos:start="1467:17" pos:end="1467:18">rv</name> <operator pos:start="1467:20" pos:end="1467:20">=</operator> <name pos:start="1467:22" pos:end="1467:44">EST_ERR_ZERO_LENGTH_BUF</name></expr>;</expr_stmt>
                <break pos:start="1468:17" pos:end="1468:22">break;</break>
            </block_content>}</block></if></if_stmt>
            <expr_stmt pos:start="1470:13" pos:end="1470:81"><expr pos:start="1470:13" pos:end="1470:80"><call pos:start="1470:13" pos:end="1470:80"><name pos:start="1470:13" pos:end="1470:20">memcpy_s</name><argument_list pos:start="1470:21" pos:end="1470:80">(<argument pos:start="1470:22" pos:end="1470:26"><expr pos:start="1470:22" pos:end="1470:26"><name pos:start="1470:22" pos:end="1470:26">pkcs7</name></expr></argument>, <argument pos:start="1470:29" pos:end="1470:51"><expr pos:start="1470:29" pos:end="1470:51"><name pos:start="1470:29" pos:end="1470:51">EST_MAX_CLIENT_CERT_LEN</name></expr></argument>, <argument pos:start="1470:54" pos:end="1470:63"><expr pos:start="1470:54" pos:end="1470:63"><name pos:start="1470:54" pos:end="1470:63">enroll_buf</name></expr></argument>, <argument pos:start="1470:66" pos:end="1470:79"><expr pos:start="1470:66" pos:end="1470:79"><name pos:start="1470:66" pos:end="1470:79">enroll_buf_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="1471:13" pos:end="1471:40"><expr pos:start="1471:13" pos:end="1471:39"><operator pos:start="1471:13" pos:end="1471:13">*</operator><name pos:start="1471:14" pos:end="1471:22">pkcs7_len</name> <operator pos:start="1471:24" pos:end="1471:24">=</operator> <name pos:start="1471:26" pos:end="1471:39">enroll_buf_len</name></expr>;</expr_stmt>
            <break pos:start="1472:13" pos:end="1472:18">break;</break>
        <case pos:start="1473:9" pos:end="1473:31">case <expr pos:start="1473:14" pos:end="1473:30"><name pos:start="1473:14" pos:end="1473:30">EST_ERR_AUTH_FAIL</name></expr>:</case>
            <expr_stmt pos:start="1474:13" pos:end="1474:46"><expr pos:start="1474:13" pos:end="1474:45"><call pos:start="1474:13" pos:end="1474:45"><name pos:start="1474:13" pos:end="1474:24">EST_LOG_WARN</name><argument_list pos:start="1474:25" pos:end="1474:45">(<argument pos:start="1474:26" pos:end="1474:44"><expr pos:start="1474:26" pos:end="1474:44"><literal type="string" pos:start="1474:26" pos:end="1474:44">"HTTP auth failure"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <break pos:start="1475:13" pos:end="1475:18">break;</break>
        <default pos:start="1476:9" pos:end="1476:16">default:</default>
            <expr_stmt pos:start="1477:13" pos:end="1477:83"><expr pos:start="1477:13" pos:end="1477:82"><call pos:start="1477:13" pos:end="1477:82"><name pos:start="1477:13" pos:end="1477:23">EST_LOG_ERR</name><argument_list pos:start="1477:24" pos:end="1477:82">(<argument pos:start="1477:25" pos:end="1477:53"><expr pos:start="1477:25" pos:end="1477:53"><literal type="string" pos:start="1477:25" pos:end="1477:53">"EST request failed: %d (%s)"</literal></expr></argument>, <argument pos:start="1477:56" pos:end="1477:57"><expr pos:start="1477:56" pos:end="1477:57"><name pos:start="1477:56" pos:end="1477:57">rv</name></expr></argument>, <argument pos:start="1477:60" pos:end="1477:81"><expr pos:start="1477:60" pos:end="1477:81"><call pos:start="1477:60" pos:end="1477:81"><name pos:start="1477:60" pos:end="1477:77">EST_ERR_NUM_TO_STR</name><argument_list pos:start="1477:78" pos:end="1477:81">(<argument pos:start="1477:79" pos:end="1477:80"><expr pos:start="1477:79" pos:end="1477:80"><name pos:start="1477:79" pos:end="1477:80">rv</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <break pos:start="1478:13" pos:end="1478:18">break;</break>
        </block_content>}</block></switch>
        <expr_stmt pos:start="1480:9" pos:end="1480:25"><expr pos:start="1480:9" pos:end="1480:24"><call pos:start="1480:9" pos:end="1480:24"><name pos:start="1480:9" pos:end="1480:12">free</name><argument_list pos:start="1480:13" pos:end="1480:24">(<argument pos:start="1480:14" pos:end="1480:23"><expr pos:start="1480:14" pos:end="1480:23"><name pos:start="1480:14" pos:end="1480:23">enroll_buf</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></else></if_stmt>
    <expr_stmt pos:start="1482:5" pos:end="1482:77"><expr pos:start="1482:5" pos:end="1482:76"><call pos:start="1482:5" pos:end="1482:76"><name pos:start="1482:5" pos:end="1482:19">OPENSSL_cleanse</name><argument_list pos:start="1482:20" pos:end="1482:76">(<argument pos:start="1482:21" pos:end="1482:29"><expr pos:start="1482:21" pos:end="1482:29"><name pos:start="1482:21" pos:end="1482:29">http_data</name></expr></argument>, <argument pos:start="1482:32" pos:end="1482:75"><expr pos:start="1482:32" pos:end="1482:75"><call pos:start="1482:32" pos:end="1482:75"><name pos:start="1482:32" pos:end="1482:40">strnlen_s</name><argument_list pos:start="1482:41" pos:end="1482:75">(<argument pos:start="1482:42" pos:end="1482:50"><expr pos:start="1482:42" pos:end="1482:50"><name pos:start="1482:42" pos:end="1482:50">http_data</name></expr></argument>, <argument pos:start="1482:53" pos:end="1482:74"><expr pos:start="1482:53" pos:end="1482:74"><name pos:start="1482:53" pos:end="1482:74">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1483:5" pos:end="1483:20"><expr pos:start="1483:5" pos:end="1483:19"><call pos:start="1483:5" pos:end="1483:19"><name pos:start="1483:5" pos:end="1483:8">free</name><argument_list pos:start="1483:9" pos:end="1483:19">(<argument pos:start="1483:10" pos:end="1483:18"><expr pos:start="1483:10" pos:end="1483:18"><name pos:start="1483:10" pos:end="1483:18">http_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1484:5" pos:end="1484:21"><expr pos:start="1484:5" pos:end="1484:20"><name pos:start="1484:5" pos:end="1484:13">http_data</name> <operator pos:start="1484:15" pos:end="1484:15">=</operator> <name pos:start="1484:17" pos:end="1484:20">NULL</name></expr>;</expr_stmt>
    <return pos:start="1485:5" pos:end="1485:16">return <expr pos:start="1485:12" pos:end="1485:15"><operator pos:start="1485:12" pos:end="1485:12">(</operator><name pos:start="1485:13" pos:end="1485:14">rv</name><operator pos:start="1485:15" pos:end="1485:15">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="1487:1" pos:end="1493:3">/*
 * This function does a sanity check on the X509
 * prior to attempting to convert the X509 to
 * a CSR for a reenroll operation.
 *
 * Returns an EST_ERROR code
 */</comment>
<function pos:start="1494:1" pos:end="1512:1"><type pos:start="1494:1" pos:end="1494:16"><specifier pos:start="1494:1" pos:end="1494:6">static</specifier> <name pos:start="1494:8" pos:end="1494:16">EST_ERROR</name></type> <name pos:start="1494:18" pos:end="1494:38">est_client_check_x509</name> <parameter_list pos:start="1494:40" pos:end="1494:51">(<parameter pos:start="1494:41" pos:end="1494:50"><decl pos:start="1494:41" pos:end="1494:50"><type pos:start="1494:41" pos:end="1494:46"><name pos:start="1494:41" pos:end="1494:44">X509</name> <modifier pos:start="1494:46" pos:end="1494:46">*</modifier></type><name pos:start="1494:47" pos:end="1494:50">cert</name></decl></parameter>)</parameter_list> 
<block pos:start="1495:1" pos:end="1512:1">{<block_content pos:start="1499:5" pos:end="1511:26">
    <comment type="block" pos:start="1496:5" pos:end="1498:7">/*
     * Make sure the cert is signed
     */</comment>
    <if_stmt pos:start="1499:5" pos:end="1502:5"><if pos:start="1499:5" pos:end="1502:5">if<condition pos:start="1499:7" pos:end="1499:24">(<expr pos:start="1499:8" pos:end="1499:23"><operator pos:start="1499:8" pos:end="1499:8">!</operator><name pos:start="1499:9" pos:end="1499:23"><name pos:start="1499:9" pos:end="1499:12">cert</name><operator pos:start="1499:13" pos:end="1499:14">-&gt;</operator><name pos:start="1499:15" pos:end="1499:23">signature</name></name></expr>)</condition> <block pos:start="1499:26" pos:end="1502:5">{<block_content pos:start="1500:9" pos:end="1501:34">
	<expr_stmt pos:start="1500:9" pos:end="1500:78"><expr pos:start="1500:9" pos:end="1500:77"><call pos:start="1500:9" pos:end="1500:77"><name pos:start="1500:9" pos:end="1500:19">EST_LOG_ERR</name><argument_list pos:start="1500:20" pos:end="1500:77">(<argument pos:start="1500:21" pos:end="1500:76"><expr pos:start="1500:21" pos:end="1500:76"><literal type="string" pos:start="1500:21" pos:end="1500:76">"The certificate provided does not contain a signature."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return pos:start="1501:9" pos:end="1501:34">return <expr pos:start="1501:16" pos:end="1501:33"><operator pos:start="1501:16" pos:end="1501:16">(</operator><name pos:start="1501:17" pos:end="1501:32">EST_ERR_BAD_X509</name><operator pos:start="1501:33" pos:end="1501:33">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="1504:5" pos:end="1506:7">/*
     * Make sure the signature length is not invalid 
     */</comment>
    <if_stmt pos:start="1507:5" pos:end="1510:5"><if pos:start="1507:5" pos:end="1510:5">if <condition pos:start="1507:8" pos:end="1507:37">(<expr pos:start="1507:9" pos:end="1507:36"><name pos:start="1507:9" pos:end="1507:31"><name pos:start="1507:9" pos:end="1507:12">cert</name><operator pos:start="1507:13" pos:end="1507:14">-&gt;</operator><name pos:start="1507:15" pos:end="1507:23">signature</name><operator pos:start="1507:24" pos:end="1507:25">-&gt;</operator><name pos:start="1507:26" pos:end="1507:31">length</name></name> <operator pos:start="1507:33" pos:end="1507:34">&lt;=</operator> <literal type="number" pos:start="1507:36" pos:end="1507:36">0</literal></expr>)</condition> <block pos:start="1507:39" pos:end="1510:5">{<block_content pos:start="1508:9" pos:end="1509:34">
	<expr_stmt pos:start="1508:9" pos:end="1508:86"><expr pos:start="1508:9" pos:end="1508:85"><call pos:start="1508:9" pos:end="1508:85"><name pos:start="1508:9" pos:end="1508:19">EST_LOG_ERR</name><argument_list pos:start="1508:20" pos:end="1508:85">(<argument pos:start="1508:21" pos:end="1508:84"><expr pos:start="1508:21" pos:end="1508:84"><literal type="string" pos:start="1508:21" pos:end="1508:84">"The certificate provided contains an invalid signature length."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return pos:start="1509:9" pos:end="1509:34">return <expr pos:start="1509:16" pos:end="1509:33"><operator pos:start="1509:16" pos:end="1509:16">(</operator><name pos:start="1509:17" pos:end="1509:32">EST_ERR_BAD_X509</name><operator pos:start="1509:33" pos:end="1509:33">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <return pos:start="1511:5" pos:end="1511:26">return <expr pos:start="1511:12" pos:end="1511:25"><operator pos:start="1511:12" pos:end="1511:12">(</operator><name pos:start="1511:13" pos:end="1511:24">EST_ERR_NONE</name><operator pos:start="1511:25" pos:end="1511:25">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="1513:1" pos:end="1523:3">/*
 * This function is used to clear any ChallengePassword
 * attributes in an X509 CSR.  This is used because when
 * HTTP authentication is used during the enrollment
 * process, the PoP value will change when the client
 * sends the second HTTP request that contains the HTTP
 * authorization values. Since the CSR is reused between
 * both the initial and secondary requests, we need to
 * clear the PoP value from the CSR before submitting
 * the secondary request.
 */</comment>
<function pos:start="1524:1" pos:end="1556:1"><type pos:start="1524:1" pos:end="1524:11"><specifier pos:start="1524:1" pos:end="1524:6">static</specifier> <name pos:start="1524:8" pos:end="1524:11">void</name></type> <name pos:start="1524:13" pos:end="1524:36">est_client_clear_csr_pop</name> <parameter_list pos:start="1524:38" pos:end="1524:52">(<parameter pos:start="1524:39" pos:end="1524:51"><decl pos:start="1524:39" pos:end="1524:51"><type pos:start="1524:39" pos:end="1524:48"><name pos:start="1524:39" pos:end="1524:46">X509_REQ</name> <modifier pos:start="1524:48" pos:end="1524:48">*</modifier></type><name pos:start="1524:49" pos:end="1524:51">csr</name></decl></parameter>)</parameter_list>
<block pos:start="1525:1" pos:end="1556:1">{<block_content pos:start="1526:5" pos:end="1555:5">
    <decl_stmt pos:start="1526:5" pos:end="1526:16"><decl pos:start="1526:5" pos:end="1526:15"><type pos:start="1526:5" pos:end="1526:7"><name pos:start="1526:5" pos:end="1526:7">int</name></type> <name pos:start="1526:9" pos:end="1526:11">pos</name> <init pos:start="1526:13" pos:end="1526:15">= <expr pos:start="1526:15" pos:end="1526:15"><literal type="number" pos:start="1526:15" pos:end="1526:15">0</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="1527:5" pos:end="1527:25"><decl pos:start="1527:5" pos:end="1527:24"><type pos:start="1527:5" pos:end="1527:20"><name pos:start="1527:5" pos:end="1527:18">X509_ATTRIBUTE</name> <modifier pos:start="1527:20" pos:end="1527:20">*</modifier></type><name pos:start="1527:21" pos:end="1527:24">attr</name></decl>;</decl_stmt>

    <comment type="block" pos:start="1529:5" pos:end="1533:7">/*
     * The challenge password (PoP) may be in the CSR 
     * more than once.  This should never happen, but
     * we're being defensive.
     */</comment>
    <while pos:start="1534:5" pos:end="1555:5">while <condition pos:start="1534:11" pos:end="1534:20">(<expr pos:start="1534:12" pos:end="1534:19"><name pos:start="1534:12" pos:end="1534:14">pos</name> <operator pos:start="1534:16" pos:end="1534:17">&gt;=</operator> <literal type="number" pos:start="1534:19" pos:end="1534:19">0</literal></expr>)</condition> <block pos:start="1534:22" pos:end="1555:5">{<block_content pos:start="1538:9" pos:end="1554:9">
	<comment type="block" pos:start="1535:9" pos:end="1537:11">/*
	 * Look for the PoP value in the CSR 
	 */</comment>
	<expr_stmt pos:start="1538:9" pos:end="1538:77"><expr pos:start="1538:9" pos:end="1538:76"><name pos:start="1538:9" pos:end="1538:11">pos</name> <operator pos:start="1538:13" pos:end="1538:13">=</operator> <call pos:start="1538:15" pos:end="1538:76"><name pos:start="1538:15" pos:end="1538:38">X509_REQ_get_attr_by_NID</name><argument_list pos:start="1538:39" pos:end="1538:76">(<argument pos:start="1538:40" pos:end="1538:42"><expr pos:start="1538:40" pos:end="1538:42"><name pos:start="1538:40" pos:end="1538:42">csr</name></expr></argument>, <argument pos:start="1538:45" pos:end="1538:71"><expr pos:start="1538:45" pos:end="1538:71"><name pos:start="1538:45" pos:end="1538:71">NID_pkcs9_challengePassword</name></expr></argument>, <argument pos:start="1538:74" pos:end="1538:75"><expr pos:start="1538:74" pos:end="1538:75"><operator pos:start="1538:74" pos:end="1538:74">-</operator><literal type="number" pos:start="1538:75" pos:end="1538:75">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if_stmt pos:start="1539:9" pos:end="1554:9"><if pos:start="1539:9" pos:end="1554:9">if <condition pos:start="1539:12" pos:end="1539:21">(<expr pos:start="1539:13" pos:end="1539:20"><name pos:start="1539:13" pos:end="1539:15">pos</name> <operator pos:start="1539:17" pos:end="1539:18">&gt;=</operator> <literal type="number" pos:start="1539:20" pos:end="1539:20">0</literal></expr>)</condition> <block pos:start="1539:23" pos:end="1554:9">{<block_content pos:start="1543:13" pos:end="1553:13">
	    <comment type="block" pos:start="1540:13" pos:end="1542:15">/* 
	     * If found, delete it
	     */</comment>
	    <expr_stmt pos:start="1543:13" pos:end="1543:50"><expr pos:start="1543:13" pos:end="1543:49"><name pos:start="1543:13" pos:end="1543:16">attr</name> <operator pos:start="1543:18" pos:end="1543:18">=</operator> <call pos:start="1543:20" pos:end="1543:49"><name pos:start="1543:20" pos:end="1543:39">X509_REQ_delete_attr</name><argument_list pos:start="1543:40" pos:end="1543:49">(<argument pos:start="1543:41" pos:end="1543:43"><expr pos:start="1543:41" pos:end="1543:43"><name pos:start="1543:41" pos:end="1543:43">csr</name></expr></argument>, <argument pos:start="1543:46" pos:end="1543:48"><expr pos:start="1543:46" pos:end="1543:48"><name pos:start="1543:46" pos:end="1543:48">pos</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <if_stmt pos:start="1544:13" pos:end="1553:13"><if pos:start="1544:13" pos:end="1553:13">if <condition pos:start="1544:16" pos:end="1544:21">(<expr pos:start="1544:17" pos:end="1544:20"><name pos:start="1544:17" pos:end="1544:20">attr</name></expr>)</condition> <block pos:start="1544:23" pos:end="1553:13">{<block_content pos:start="1552:17" pos:end="1552:42">
		<comment type="block" pos:start="1545:17" pos:end="1551:19">/*
		 * There are no docs in OpenSSL that show how
		 * to use X509_REQ_delete_attr.  Going to assume
		 * we need to free the attribute ourselves.  There
		 * do not appear to be any good examples on how
		 * to use this API.
		 */</comment>
		<expr_stmt pos:start="1552:17" pos:end="1552:42"><expr pos:start="1552:17" pos:end="1552:41"><call pos:start="1552:17" pos:end="1552:41"><name pos:start="1552:17" pos:end="1552:35">X509_ATTRIBUTE_free</name><argument_list pos:start="1552:36" pos:end="1552:41">(<argument pos:start="1552:37" pos:end="1552:40"><expr pos:start="1552:37" pos:end="1552:40"><name pos:start="1552:37" pos:end="1552:40">attr</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    </block_content>}</block></if></if_stmt>
	</block_content>}</block></if></if_stmt>
    </block_content>}</block></while>
</block_content>}</block></function>
<comment type="block" pos:start="1557:1" pos:end="1564:3">/*
 * This function does the work of converting the X509_REQ* to
 * the base64 encoded DER format as specified in the EST RFC.
 * Once converted to the proper format, this routine will
 * forward the request to the server, check the response,
 * and save the cert on the local context where it can be
 * retrieved later by the application layer.
 */</comment>
<function pos:start="1565:1" pos:end="1680:1"><type pos:start="1565:1" pos:end="1565:16"><specifier pos:start="1565:1" pos:end="1565:6">static</specifier> <name pos:start="1565:8" pos:end="1565:16">EST_ERROR</name></type> <name pos:start="1565:18" pos:end="1565:38">est_client_enroll_req</name> <parameter_list pos:start="1565:40" pos:end="1566:69">(<parameter pos:start="1565:41" pos:end="1565:52"><decl pos:start="1565:41" pos:end="1565:52"><type pos:start="1565:41" pos:end="1565:52"><name pos:start="1565:41" pos:end="1565:47">EST_CTX</name> <modifier pos:start="1565:49" pos:end="1565:49">*</modifier></type><name pos:start="1565:50" pos:end="1565:52">ctx</name></decl></parameter>, <parameter pos:start="1565:55" pos:end="1565:62"><decl pos:start="1565:55" pos:end="1565:62"><type pos:start="1565:55" pos:end="1565:62"><name pos:start="1565:55" pos:end="1565:57">SSL</name> <modifier pos:start="1565:59" pos:end="1565:59">*</modifier></type><name pos:start="1565:60" pos:end="1565:62">ssl</name></decl></parameter>, <parameter pos:start="1565:65" pos:end="1565:77"><decl pos:start="1565:65" pos:end="1565:77"><type pos:start="1565:65" pos:end="1565:77"><name pos:start="1565:65" pos:end="1565:72">X509_REQ</name> <modifier pos:start="1565:74" pos:end="1565:74">*</modifier></type><name pos:start="1565:75" pos:end="1565:77">req</name></decl></parameter>, 
	                                <parameter pos:start="1566:41" pos:end="1566:54"><decl pos:start="1566:41" pos:end="1566:54"><type pos:start="1566:41" pos:end="1566:54"><name pos:start="1566:41" pos:end="1566:43">int</name> <modifier pos:start="1566:45" pos:end="1566:45">*</modifier></type><name pos:start="1566:46" pos:end="1566:54">pkcs7_len</name></decl></parameter>, <parameter pos:start="1566:57" pos:end="1566:68"><decl pos:start="1566:57" pos:end="1566:68"><type pos:start="1566:57" pos:end="1566:68"><name pos:start="1566:57" pos:end="1566:59">int</name></type> <name pos:start="1566:61" pos:end="1566:68">reenroll</name></decl></parameter>)</parameter_list>
<block pos:start="1567:1" pos:end="1680:1">{<block_content pos:start="1568:5" pos:end="1679:16">
    <decl_stmt pos:start="1568:5" pos:end="1568:35"><decl pos:start="1568:5" pos:end="1568:34"><type pos:start="1568:5" pos:end="1568:13"><name pos:start="1568:5" pos:end="1568:13">EST_ERROR</name></type>    <name pos:start="1568:18" pos:end="1568:19">rv</name> <init pos:start="1568:21" pos:end="1568:34">= <expr pos:start="1568:23" pos:end="1568:34"><name pos:start="1568:23" pos:end="1568:34">EST_ERR_NONE</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="1569:5" pos:end="1569:37"><decl pos:start="1569:5" pos:end="1569:30"><type pos:start="1569:5" pos:end="1569:17"><name pos:start="1569:5" pos:end="1569:7">BIO</name>         <modifier pos:start="1569:17" pos:end="1569:17">*</modifier></type><name pos:start="1569:18" pos:end="1569:23">p10out</name> <init pos:start="1569:25" pos:end="1569:30">= <expr pos:start="1569:27" pos:end="1569:30"><name pos:start="1569:27" pos:end="1569:30">NULL</name></expr></init></decl>, <decl pos:start="1569:33" pos:end="1569:36"><type ref="prev" pos:start="1569:5" pos:end="1569:17"><modifier pos:start="1569:33" pos:end="1569:33">*</modifier></type><name pos:start="1569:34" pos:end="1569:36">b64</name></decl>;</decl_stmt>
    <decl_stmt pos:start="1570:5" pos:end="1570:29"><decl pos:start="1570:5" pos:end="1570:28"><type pos:start="1570:5" pos:end="1570:17"><name pos:start="1570:5" pos:end="1570:11">BUF_MEM</name>     <modifier pos:start="1570:17" pos:end="1570:17">*</modifier></type><name pos:start="1570:18" pos:end="1570:21">bptr</name> <init pos:start="1570:23" pos:end="1570:28">= <expr pos:start="1570:25" pos:end="1570:28"><name pos:start="1570:25" pos:end="1570:28">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="1571:5" pos:end="1571:28"><decl pos:start="1571:5" pos:end="1571:27"><type pos:start="1571:5" pos:end="1571:19"><name pos:start="1571:5" pos:end="1571:12">unsigned</name> <name pos:start="1571:14" pos:end="1571:17">char</name> <modifier pos:start="1571:19" pos:end="1571:19">*</modifier></type><name pos:start="1571:20" pos:end="1571:27">recv_buf</name></decl>;</decl_stmt>
    <decl_stmt pos:start="1572:5" pos:end="1572:32"><decl pos:start="1572:5" pos:end="1572:31"><type pos:start="1572:5" pos:end="1572:19"><name pos:start="1572:5" pos:end="1572:12">unsigned</name> <name pos:start="1572:14" pos:end="1572:17">char</name> <modifier pos:start="1572:19" pos:end="1572:19">*</modifier></type><name pos:start="1572:20" pos:end="1572:31">new_cert_buf</name></decl>;</decl_stmt>
    <decl_stmt pos:start="1573:5" pos:end="1573:34"><decl pos:start="1573:5" pos:end="1573:33"><type pos:start="1573:5" pos:end="1573:7"><name pos:start="1573:5" pos:end="1573:7">int</name></type>          <name pos:start="1573:18" pos:end="1573:33">new_cert_buf_len</name></decl>;</decl_stmt>

    <comment type="block" pos:start="1575:5" pos:end="1577:7">/*
     * Grab the PKCS10 PEM encoded data
     */</comment>
    <expr_stmt pos:start="1578:5" pos:end="1578:34"><expr pos:start="1578:5" pos:end="1578:33"><name pos:start="1578:5" pos:end="1578:7">b64</name> <operator pos:start="1578:9" pos:end="1578:9">=</operator> <call pos:start="1578:11" pos:end="1578:33"><name pos:start="1578:11" pos:end="1578:17">BIO_new</name><argument_list pos:start="1578:18" pos:end="1578:33">(<argument pos:start="1578:19" pos:end="1578:32"><expr pos:start="1578:19" pos:end="1578:32"><call pos:start="1578:19" pos:end="1578:32"><name pos:start="1578:19" pos:end="1578:30">BIO_f_base64</name><argument_list pos:start="1578:31" pos:end="1578:32">()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1579:5" pos:end="1583:5"><if pos:start="1579:5" pos:end="1583:5">if <condition pos:start="1579:8" pos:end="1579:13">(<expr pos:start="1579:9" pos:end="1579:12"><operator pos:start="1579:9" pos:end="1579:9">!</operator><name pos:start="1579:10" pos:end="1579:12">b64</name></expr>)</condition> <block pos:start="1579:15" pos:end="1583:5">{<block_content pos:start="1580:9" pos:end="1582:30">
        <expr_stmt pos:start="1580:9" pos:end="1580:38"><expr pos:start="1580:9" pos:end="1580:37"><call pos:start="1580:9" pos:end="1580:37"><name pos:start="1580:9" pos:end="1580:19">EST_LOG_ERR</name><argument_list pos:start="1580:20" pos:end="1580:37">(<argument pos:start="1580:21" pos:end="1580:36"><expr pos:start="1580:21" pos:end="1580:36"><literal type="string" pos:start="1580:21" pos:end="1580:36">"BIO_new failed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1581:9" pos:end="1581:31"><expr pos:start="1581:9" pos:end="1581:30"><call pos:start="1581:9" pos:end="1581:30"><name pos:start="1581:9" pos:end="1581:28">ossl_dump_ssl_errors</name><argument_list pos:start="1581:29" pos:end="1581:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="1582:9" pos:end="1582:30">return <expr pos:start="1582:16" pos:end="1582:29"><name pos:start="1582:16" pos:end="1582:29">EST_ERR_MALLOC</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="1584:5" pos:end="1584:34"><expr pos:start="1584:5" pos:end="1584:33"><name pos:start="1584:5" pos:end="1584:10">p10out</name> <operator pos:start="1584:12" pos:end="1584:12">=</operator> <call pos:start="1584:14" pos:end="1584:33"><name pos:start="1584:14" pos:end="1584:20">BIO_new</name><argument_list pos:start="1584:21" pos:end="1584:33">(<argument pos:start="1584:22" pos:end="1584:32"><expr pos:start="1584:22" pos:end="1584:32"><call pos:start="1584:22" pos:end="1584:32"><name pos:start="1584:22" pos:end="1584:30">BIO_s_mem</name><argument_list pos:start="1584:31" pos:end="1584:32">()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1585:5" pos:end="1589:5"><if pos:start="1585:5" pos:end="1589:5">if <condition pos:start="1585:8" pos:end="1585:16">(<expr pos:start="1585:9" pos:end="1585:15"><operator pos:start="1585:9" pos:end="1585:9">!</operator><name pos:start="1585:10" pos:end="1585:15">p10out</name></expr>)</condition> <block pos:start="1585:18" pos:end="1589:5">{<block_content pos:start="1586:9" pos:end="1588:30">
        <expr_stmt pos:start="1586:9" pos:end="1586:38"><expr pos:start="1586:9" pos:end="1586:37"><call pos:start="1586:9" pos:end="1586:37"><name pos:start="1586:9" pos:end="1586:19">EST_LOG_ERR</name><argument_list pos:start="1586:20" pos:end="1586:37">(<argument pos:start="1586:21" pos:end="1586:36"><expr pos:start="1586:21" pos:end="1586:36"><literal type="string" pos:start="1586:21" pos:end="1586:36">"BIO_new failed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt pos:start="1587:9" pos:end="1587:31"><expr pos:start="1587:9" pos:end="1587:30"><call pos:start="1587:9" pos:end="1587:30"><name pos:start="1587:9" pos:end="1587:28">ossl_dump_ssl_errors</name><argument_list pos:start="1587:29" pos:end="1587:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="1588:9" pos:end="1588:30">return <expr pos:start="1588:16" pos:end="1588:29"><name pos:start="1588:16" pos:end="1588:29">EST_ERR_MALLOC</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="1590:5" pos:end="1590:35"><expr pos:start="1590:5" pos:end="1590:34"><name pos:start="1590:5" pos:end="1590:10">p10out</name> <operator pos:start="1590:12" pos:end="1590:12">=</operator> <call pos:start="1590:14" pos:end="1590:34"><name pos:start="1590:14" pos:end="1590:21">BIO_push</name><argument_list pos:start="1590:22" pos:end="1590:34">(<argument pos:start="1590:23" pos:end="1590:25"><expr pos:start="1590:23" pos:end="1590:25"><name pos:start="1590:23" pos:end="1590:25">b64</name></expr></argument>, <argument pos:start="1590:28" pos:end="1590:33"><expr pos:start="1590:28" pos:end="1590:33"><name pos:start="1590:28" pos:end="1590:33">p10out</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block" pos:start="1592:5" pos:end="1599:9">/*
     * Encode using DER (ASN.1) 
     *
     * We have to set the modified flag on the X509_REQ because
     * OpenSSL keeps a cached copy of the DER encoded data in some
     * cases.  Setting this flag tells OpenSSL to run the ASN
     * encoding again rather than using the cached copy.
     * */</comment>
    <expr_stmt pos:start="1600:5" pos:end="1600:36"><expr pos:start="1600:5" pos:end="1600:35"><name pos:start="1600:5" pos:end="1600:31"><name pos:start="1600:5" pos:end="1600:7">req</name><operator pos:start="1600:8" pos:end="1600:9">-&gt;</operator><name pos:start="1600:10" pos:end="1600:17">req_info</name><operator pos:start="1600:18" pos:end="1600:19">-&gt;</operator><name pos:start="1600:20" pos:end="1600:22">enc</name><operator pos:start="1600:23" pos:end="1600:23">.</operator><name pos:start="1600:24" pos:end="1600:31">modified</name></name> <operator pos:start="1600:33" pos:end="1600:33">=</operator> <literal type="number" pos:start="1600:35" pos:end="1600:35">1</literal></expr>;</expr_stmt> 
    <expr_stmt pos:start="1601:5" pos:end="1601:34"><expr pos:start="1601:5" pos:end="1601:33"><call pos:start="1601:5" pos:end="1601:33"><name pos:start="1601:5" pos:end="1601:20">i2d_X509_REQ_bio</name><argument_list pos:start="1601:21" pos:end="1601:33">(<argument pos:start="1601:22" pos:end="1601:27"><expr pos:start="1601:22" pos:end="1601:27"><name pos:start="1601:22" pos:end="1601:27">p10out</name></expr></argument>, <argument pos:start="1601:30" pos:end="1601:32"><expr pos:start="1601:30" pos:end="1601:32"><name pos:start="1601:30" pos:end="1601:32">req</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1602:5" pos:end="1602:28"><expr pos:start="1602:5" pos:end="1602:27"><operator pos:start="1602:5" pos:end="1602:5">(</operator><name pos:start="1602:6" pos:end="1602:9">void</name><operator pos:start="1602:10" pos:end="1602:10">)</operator><call pos:start="1602:11" pos:end="1602:27"><name pos:start="1602:11" pos:end="1602:19">BIO_flush</name><argument_list pos:start="1602:20" pos:end="1602:27">(<argument pos:start="1602:21" pos:end="1602:26"><expr pos:start="1602:21" pos:end="1602:26"><name pos:start="1602:21" pos:end="1602:26">p10out</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="1603:5" pos:end="1603:35"><expr pos:start="1603:5" pos:end="1603:34"><call pos:start="1603:5" pos:end="1603:34"><name pos:start="1603:5" pos:end="1603:19">BIO_get_mem_ptr</name><argument_list pos:start="1603:20" pos:end="1603:34">(<argument pos:start="1603:21" pos:end="1603:26"><expr pos:start="1603:21" pos:end="1603:26"><name pos:start="1603:21" pos:end="1603:26">p10out</name></expr></argument>, <argument pos:start="1603:29" pos:end="1603:33"><expr pos:start="1603:29" pos:end="1603:33"><operator pos:start="1603:29" pos:end="1603:29">&amp;</operator><name pos:start="1603:30" pos:end="1603:33">bptr</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block" pos:start="1605:5" pos:end="1607:7">/*
     * Get the buffer in which to place the entire response from the server
     */</comment>
    <expr_stmt pos:start="1608:5" pos:end="1608:34"><expr pos:start="1608:5" pos:end="1608:33"><name pos:start="1608:5" pos:end="1608:12">recv_buf</name> <operator pos:start="1608:14" pos:end="1608:14">=</operator> <call pos:start="1608:16" pos:end="1608:33"><name pos:start="1608:16" pos:end="1608:21">malloc</name><argument_list pos:start="1608:22" pos:end="1608:33">(<argument pos:start="1608:23" pos:end="1608:32"><expr pos:start="1608:23" pos:end="1608:32"><name pos:start="1608:23" pos:end="1608:32">EST_CA_MAX</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1609:5" pos:end="1612:5"><if pos:start="1609:5" pos:end="1612:5">if <condition pos:start="1609:8" pos:end="1609:25">(<expr pos:start="1609:9" pos:end="1609:24"><name pos:start="1609:9" pos:end="1609:16">recv_buf</name> <operator pos:start="1609:18" pos:end="1609:19">==</operator> <name pos:start="1609:21" pos:end="1609:24">NULL</name></expr>)</condition> <block pos:start="1609:27" pos:end="1612:5">{<block_content pos:start="1610:9" pos:end="1611:30">
        <expr_stmt pos:start="1610:9" pos:end="1610:69"><expr pos:start="1610:9" pos:end="1610:68"><call pos:start="1610:9" pos:end="1610:68"><name pos:start="1610:9" pos:end="1610:19">EST_LOG_ERR</name><argument_list pos:start="1610:20" pos:end="1610:68">(<argument pos:start="1610:21" pos:end="1610:67"><expr pos:start="1610:21" pos:end="1610:67"><literal type="string" pos:start="1610:21" pos:end="1610:67">"Failed to allocate buffer for server response"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="1611:9" pos:end="1611:30">return <expr pos:start="1611:16" pos:end="1611:29"><name pos:start="1611:16" pos:end="1611:29">EST_ERR_MALLOC</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="1613:5" pos:end="1613:28"><expr pos:start="1613:5" pos:end="1613:27"><name pos:start="1613:5" pos:end="1613:16">new_cert_buf</name> <operator pos:start="1613:18" pos:end="1613:18">=</operator> <name pos:start="1613:20" pos:end="1613:27">recv_buf</name></expr>;</expr_stmt> 
    <expr_stmt pos:start="1614:5" pos:end="1614:25"><expr pos:start="1614:5" pos:end="1614:24"><name pos:start="1614:5" pos:end="1614:20">new_cert_buf_len</name> <operator pos:start="1614:22" pos:end="1614:22">=</operator> <literal type="number" pos:start="1614:24" pos:end="1614:24">0</literal></expr>;</expr_stmt>

    <comment type="block" pos:start="1616:5" pos:end="1618:7">/*
     * Send the PKCS10 as an HTTP request to the EST server
     */</comment>
    <expr_stmt pos:start="1619:5" pos:end="1621:50"><expr pos:start="1619:5" pos:end="1621:49"><name pos:start="1619:5" pos:end="1619:6">rv</name> <operator pos:start="1619:8" pos:end="1619:8">=</operator> <call pos:start="1619:10" pos:end="1621:49"><name pos:start="1619:10" pos:end="1619:39">est_client_send_enroll_request</name><argument_list pos:start="1619:40" pos:end="1621:49">(<argument pos:start="1619:41" pos:end="1619:43"><expr pos:start="1619:41" pos:end="1619:43"><name pos:start="1619:41" pos:end="1619:43">ctx</name></expr></argument>, <argument pos:start="1619:46" pos:end="1619:48"><expr pos:start="1619:46" pos:end="1619:48"><name pos:start="1619:46" pos:end="1619:48">ssl</name></expr></argument>, <argument pos:start="1619:51" pos:end="1619:54"><expr pos:start="1619:51" pos:end="1619:54"><name pos:start="1619:51" pos:end="1619:54">bptr</name></expr></argument>,
                                        <argument pos:start="1620:41" pos:end="1620:52"><expr pos:start="1620:41" pos:end="1620:52"><name pos:start="1620:41" pos:end="1620:52">new_cert_buf</name></expr></argument>, <argument pos:start="1620:55" pos:end="1620:71"><expr pos:start="1620:55" pos:end="1620:71"><operator pos:start="1620:55" pos:end="1620:55">&amp;</operator><name pos:start="1620:56" pos:end="1620:71">new_cert_buf_len</name></expr></argument>, 
					<argument pos:start="1621:41" pos:end="1621:48"><expr pos:start="1621:41" pos:end="1621:48"><name pos:start="1621:41" pos:end="1621:48">reenroll</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <switch pos:start="1622:5" pos:end="1673:5">switch <condition pos:start="1622:12" pos:end="1622:15">(<expr pos:start="1622:13" pos:end="1622:14"><name pos:start="1622:13" pos:end="1622:14">rv</name></expr>)</condition> <block pos:start="1622:17" pos:end="1673:5">{<block_content pos:start="1624:5" pos:end="1672:14">

    <case pos:start="1624:5" pos:end="1624:22">case <expr pos:start="1624:10" pos:end="1624:21"><name pos:start="1624:10" pos:end="1624:21">EST_ERR_NONE</name></expr>:</case>
        <comment type="block" pos:start="1625:9" pos:end="1628:11">/*
         * Make sure that even though we got a success return code, that we
         * actually received something
         */</comment>
        <if_stmt pos:start="1629:9" pos:end="1633:9"><if pos:start="1629:9" pos:end="1633:9">if <condition pos:start="1629:12" pos:end="1629:34">(<expr pos:start="1629:13" pos:end="1629:33"><name pos:start="1629:13" pos:end="1629:28">new_cert_buf_len</name> <operator pos:start="1629:30" pos:end="1629:31">==</operator> <literal type="number" pos:start="1629:33" pos:end="1629:33">0</literal></expr>)</condition> <block pos:start="1629:36" pos:end="1633:9">{<block_content pos:start="1630:13" pos:end="1632:18">
            <expr_stmt pos:start="1630:13" pos:end="1630:103"><expr pos:start="1630:13" pos:end="1630:102"><call pos:start="1630:13" pos:end="1630:102"><name pos:start="1630:13" pos:end="1630:23">EST_LOG_ERR</name><argument_list pos:start="1630:24" pos:end="1630:102">(<argument pos:start="1630:25" pos:end="1630:101"><expr pos:start="1630:25" pos:end="1630:101"><literal type="string" pos:start="1630:25" pos:end="1630:101">"Buffer containing newly enrolled client certificate is zero bytes in length"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="1631:13" pos:end="1631:41"><expr pos:start="1631:13" pos:end="1631:40"><name pos:start="1631:13" pos:end="1631:14">rv</name> <operator pos:start="1631:16" pos:end="1631:16">=</operator> <name pos:start="1631:18" pos:end="1631:40">EST_ERR_ZERO_LENGTH_BUF</name></expr>;</expr_stmt>
            <break pos:start="1632:13" pos:end="1632:18">break;</break>
        </block_content>}</block></if></if_stmt>

        <comment type="block" pos:start="1635:9" pos:end="1639:11">/*
         * Resize the buffer holding the retrieved client certificate and link
         * it into the ctx.  Get rid of the http hdr and any extra space on
         * the back.
         */</comment>
        <if_stmt pos:start="1640:9" pos:end="1642:9"><if pos:start="1640:9" pos:end="1642:9">if <condition pos:start="1640:12" pos:end="1640:46">(<expr pos:start="1640:13" pos:end="1640:45"><name pos:start="1640:13" pos:end="1640:37"><name pos:start="1640:13" pos:end="1640:15">ctx</name><operator pos:start="1640:16" pos:end="1640:17">-&gt;</operator><name pos:start="1640:18" pos:end="1640:37">enrolled_client_cert</name></name> <operator pos:start="1640:39" pos:end="1640:40">!=</operator> <name pos:start="1640:42" pos:end="1640:45">NULL</name></expr>)</condition><block pos:start="1640:47" pos:end="1642:9">{<block_content pos:start="1641:13" pos:end="1641:44">
            <expr_stmt pos:start="1641:13" pos:end="1641:44"><expr pos:start="1641:13" pos:end="1641:43"><call pos:start="1641:13" pos:end="1641:43"><name pos:start="1641:13" pos:end="1641:16">free</name><argument_list pos:start="1641:17" pos:end="1641:43">(<argument pos:start="1641:18" pos:end="1641:42"><expr pos:start="1641:18" pos:end="1641:42"><name pos:start="1641:18" pos:end="1641:42"><name pos:start="1641:18" pos:end="1641:20">ctx</name><operator pos:start="1641:21" pos:end="1641:22">-&gt;</operator><name pos:start="1641:23" pos:end="1641:42">enrolled_client_cert</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></if></if_stmt>
        <expr_stmt pos:start="1643:9" pos:end="1643:63"><expr pos:start="1643:9" pos:end="1643:62"><name pos:start="1643:9" pos:end="1643:33"><name pos:start="1643:9" pos:end="1643:11">ctx</name><operator pos:start="1643:12" pos:end="1643:13">-&gt;</operator><name pos:start="1643:14" pos:end="1643:33">enrolled_client_cert</name></name> <operator pos:start="1643:35" pos:end="1643:35">=</operator> <call pos:start="1643:37" pos:end="1643:62"><name pos:start="1643:37" pos:end="1643:42">malloc</name><argument_list pos:start="1643:43" pos:end="1643:62">(<argument pos:start="1643:44" pos:end="1643:61"><expr pos:start="1643:44" pos:end="1643:61"><name pos:start="1643:44" pos:end="1643:59">new_cert_buf_len</name><operator pos:start="1643:60" pos:end="1643:60">+</operator><literal type="number" pos:start="1643:61" pos:end="1643:61">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="1644:9" pos:end="1649:9"><if pos:start="1644:9" pos:end="1649:9">if <condition pos:start="1644:12" pos:end="1644:46">(<expr pos:start="1644:13" pos:end="1644:45"><name pos:start="1644:13" pos:end="1644:37"><name pos:start="1644:13" pos:end="1644:15">ctx</name><operator pos:start="1644:16" pos:end="1644:17">-&gt;</operator><name pos:start="1644:18" pos:end="1644:37">enrolled_client_cert</name></name> <operator pos:start="1644:39" pos:end="1644:40">==</operator> <name pos:start="1644:42" pos:end="1644:45">NULL</name></expr>)</condition> <block pos:start="1644:48" pos:end="1649:9">{<block_content pos:start="1646:13" pos:end="1648:18">
            
            <expr_stmt pos:start="1646:13" pos:end="1646:87"><expr pos:start="1646:13" pos:end="1646:86"><call pos:start="1646:13" pos:end="1646:86"><name pos:start="1646:13" pos:end="1646:23">EST_LOG_ERR</name><argument_list pos:start="1646:24" pos:end="1646:86">(<argument pos:start="1646:25" pos:end="1646:85"><expr pos:start="1646:25" pos:end="1646:85"><literal type="string" pos:start="1646:25" pos:end="1646:85">"Unable to allocate newly enrolled client certificate buffer"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="1647:13" pos:end="1647:32"><expr pos:start="1647:13" pos:end="1647:31"><name pos:start="1647:13" pos:end="1647:14">rv</name> <operator pos:start="1647:16" pos:end="1647:16">=</operator> <name pos:start="1647:18" pos:end="1647:31">EST_ERR_MALLOC</name></expr>;</expr_stmt>
            <break pos:start="1648:13" pos:end="1648:18">break;</break>
        </block_content>}</block></if></if_stmt>
        <expr_stmt pos:start="1650:9" pos:end="1650:59"><expr pos:start="1650:9" pos:end="1650:58"><name pos:start="1650:9" pos:end="1650:51"><name pos:start="1650:9" pos:end="1650:11">ctx</name><operator pos:start="1650:12" pos:end="1650:13">-&gt;</operator><name pos:start="1650:14" pos:end="1650:33">enrolled_client_cert</name><index pos:start="1650:34" pos:end="1650:51">[<expr pos:start="1650:35" pos:end="1650:50"><name pos:start="1650:35" pos:end="1650:50">new_cert_buf_len</name></expr>]</index></name> <operator pos:start="1650:53" pos:end="1650:53">=</operator> <literal type="char" pos:start="1650:55" pos:end="1650:58">'\0'</literal></expr>;</expr_stmt>
        <expr_stmt pos:start="1651:9" pos:end="1652:35"><expr pos:start="1651:9" pos:end="1652:34"><call pos:start="1651:9" pos:end="1652:34"><name pos:start="1651:9" pos:end="1651:16">memcpy_s</name><argument_list pos:start="1651:17" pos:end="1652:34">(<argument pos:start="1651:18" pos:end="1651:42"><expr pos:start="1651:18" pos:end="1651:42"><name pos:start="1651:18" pos:end="1651:42"><name pos:start="1651:18" pos:end="1651:20">ctx</name><operator pos:start="1651:21" pos:end="1651:22">-&gt;</operator><name pos:start="1651:23" pos:end="1651:42">enrolled_client_cert</name></name></expr></argument>, <argument pos:start="1651:45" pos:end="1651:62"><expr pos:start="1651:45" pos:end="1651:62"><name pos:start="1651:45" pos:end="1651:60">new_cert_buf_len</name><operator pos:start="1651:61" pos:end="1651:61">+</operator><literal type="number" pos:start="1651:62" pos:end="1651:62">1</literal></expr></argument>, <argument pos:start="1651:65" pos:end="1651:76"><expr pos:start="1651:65" pos:end="1651:76"><name pos:start="1651:65" pos:end="1651:76">new_cert_buf</name></expr></argument>,
                 <argument pos:start="1652:18" pos:end="1652:33"><expr pos:start="1652:18" pos:end="1652:33"><name pos:start="1652:18" pos:end="1652:33">new_cert_buf_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1653:9" pos:end="1653:57"><expr pos:start="1653:9" pos:end="1653:56"><name pos:start="1653:9" pos:end="1653:37"><name pos:start="1653:9" pos:end="1653:11">ctx</name><operator pos:start="1653:12" pos:end="1653:13">-&gt;</operator><name pos:start="1653:14" pos:end="1653:37">enrolled_client_cert_len</name></name> <operator pos:start="1653:39" pos:end="1653:39">=</operator> <name pos:start="1653:41" pos:end="1653:56">new_cert_buf_len</name></expr>;</expr_stmt>

        <comment type="block" pos:start="1655:9" pos:end="1657:11">/*
         * pass back the length of this newly enrolled cert
         */</comment>
        <expr_stmt pos:start="1658:9" pos:end="1658:51"><expr pos:start="1658:9" pos:end="1658:50"><operator pos:start="1658:9" pos:end="1658:9">*</operator><name pos:start="1658:10" pos:end="1658:18">pkcs7_len</name> <operator pos:start="1658:20" pos:end="1658:20">=</operator> <name pos:start="1658:22" pos:end="1658:50"><name pos:start="1658:22" pos:end="1658:24">ctx</name><operator pos:start="1658:25" pos:end="1658:26">-&gt;</operator><name pos:start="1658:27" pos:end="1658:50">enrolled_client_cert_len</name></name></expr>;</expr_stmt>
        
        <expr_stmt pos:start="1660:9" pos:end="1660:89"><expr pos:start="1660:9" pos:end="1660:88"><call pos:start="1660:9" pos:end="1660:88"><name pos:start="1660:9" pos:end="1660:20">EST_LOG_INFO</name><argument_list pos:start="1660:21" pos:end="1660:88">(<argument pos:start="1660:22" pos:end="1660:60"><expr pos:start="1660:22" pos:end="1660:60"><literal type="string" pos:start="1660:22" pos:end="1660:60">"Newly Enrolled Client certificate: %s"</literal></expr></argument>, <argument pos:start="1660:63" pos:end="1660:87"><expr pos:start="1660:63" pos:end="1660:87"><name pos:start="1660:63" pos:end="1660:87"><name pos:start="1660:63" pos:end="1660:65">ctx</name><operator pos:start="1660:66" pos:end="1660:67">-&gt;</operator><name pos:start="1660:68" pos:end="1660:87">enrolled_client_cert</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1661:9" pos:end="1661:66"><expr pos:start="1661:9" pos:end="1661:65"><call pos:start="1661:9" pos:end="1661:65"><name pos:start="1661:9" pos:end="1661:20">EST_LOG_INFO</name><argument_list pos:start="1661:21" pos:end="1661:65">(<argument pos:start="1661:22" pos:end="1661:33"><expr pos:start="1661:22" pos:end="1661:33"><literal type="string" pos:start="1661:22" pos:end="1661:33">"length: %d"</literal></expr></argument>, <argument pos:start="1661:36" pos:end="1661:64"><expr pos:start="1661:36" pos:end="1661:64"><name pos:start="1661:36" pos:end="1661:64"><name pos:start="1661:36" pos:end="1661:38">ctx</name><operator pos:start="1661:39" pos:end="1661:40">-&gt;</operator><name pos:start="1661:41" pos:end="1661:64">enrolled_client_cert_len</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <break pos:start="1662:9" pos:end="1662:14">break;</break>

    <case pos:start="1664:5" pos:end="1664:27">case <expr pos:start="1664:10" pos:end="1664:26"><name pos:start="1664:10" pos:end="1664:26">EST_ERR_AUTH_FAIL</name></expr>:</case>
        <expr_stmt pos:start="1665:9" pos:end="1665:92"><expr pos:start="1665:9" pos:end="1665:91"><call pos:start="1665:9" pos:end="1665:91"><name pos:start="1665:9" pos:end="1665:20">EST_LOG_INFO</name><argument_list pos:start="1665:21" pos:end="1665:91">(<argument pos:start="1665:22" pos:end="1665:74"><expr pos:start="1665:22" pos:end="1665:74"><literal type="string" pos:start="1665:22" pos:end="1665:74">"HTTP Authorization failed. Requested auth mode = %d"</literal></expr></argument>, <argument pos:start="1665:77" pos:end="1665:90"><expr pos:start="1665:77" pos:end="1665:90"><name pos:start="1665:77" pos:end="1665:90"><name pos:start="1665:77" pos:end="1665:79">ctx</name><operator pos:start="1665:80" pos:end="1665:81">-&gt;</operator><name pos:start="1665:82" pos:end="1665:90">auth_mode</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <break pos:start="1666:9" pos:end="1666:14">break;</break>

    <default pos:start="1668:5" pos:end="1668:12">default:</default>
        
        <expr_stmt pos:start="1670:9" pos:end="1671:44"><expr pos:start="1670:9" pos:end="1671:43"><call pos:start="1670:9" pos:end="1671:43"><name pos:start="1670:9" pos:end="1670:19">EST_LOG_ERR</name><argument_list pos:start="1670:20" pos:end="1671:43">(<argument pos:start="1670:21" pos:end="1670:66"><expr pos:start="1670:21" pos:end="1670:66"><literal type="string" pos:start="1670:21" pos:end="1670:66">"EST enrollment failed, error code is %d (%s)"</literal></expr></argument>, <argument pos:start="1670:69" pos:end="1670:70"><expr pos:start="1670:69" pos:end="1670:70"><name pos:start="1670:69" pos:end="1670:70">rv</name></expr></argument>,
                    <argument pos:start="1671:21" pos:end="1671:42"><expr pos:start="1671:21" pos:end="1671:42"><call pos:start="1671:21" pos:end="1671:42"><name pos:start="1671:21" pos:end="1671:38">EST_ERR_NUM_TO_STR</name><argument_list pos:start="1671:39" pos:end="1671:42">(<argument pos:start="1671:40" pos:end="1671:41"><expr pos:start="1671:40" pos:end="1671:41"><name pos:start="1671:40" pos:end="1671:41">rv</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <break pos:start="1672:9" pos:end="1672:14">break;</break>
    </block_content>}</block></switch>

    <if_stmt pos:start="1675:5" pos:end="1677:5"><if pos:start="1675:5" pos:end="1677:5">if <condition pos:start="1675:8" pos:end="1675:17">(<expr pos:start="1675:9" pos:end="1675:16"><name pos:start="1675:9" pos:end="1675:16">recv_buf</name></expr>)</condition> <block pos:start="1675:19" pos:end="1677:5">{<block_content pos:start="1676:9" pos:end="1676:23">
        <expr_stmt pos:start="1676:9" pos:end="1676:23"><expr pos:start="1676:9" pos:end="1676:22"><call pos:start="1676:9" pos:end="1676:22"><name pos:start="1676:9" pos:end="1676:12">free</name><argument_list pos:start="1676:13" pos:end="1676:22">(<argument pos:start="1676:14" pos:end="1676:21"><expr pos:start="1676:14" pos:end="1676:21"><name pos:start="1676:14" pos:end="1676:21">recv_buf</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="1678:5" pos:end="1678:25"><expr pos:start="1678:5" pos:end="1678:24"><call pos:start="1678:5" pos:end="1678:24"><name pos:start="1678:5" pos:end="1678:16">BIO_free_all</name><argument_list pos:start="1678:17" pos:end="1678:24">(<argument pos:start="1678:18" pos:end="1678:23"><expr pos:start="1678:18" pos:end="1678:23"><name pos:start="1678:18" pos:end="1678:23">p10out</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return pos:start="1679:5" pos:end="1679:16">return <expr pos:start="1679:12" pos:end="1679:15"><operator pos:start="1679:12" pos:end="1679:12">(</operator><name pos:start="1679:13" pos:end="1679:14">rv</name><operator pos:start="1679:15" pos:end="1679:15">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="1681:1" pos:end="1695:3">/*  est_client_enroll_pkcs10() This function implements the Simple Enroll
 *  flow. It signs the CSR that was provided and then sends the CSR
 *  to the EST server and retrieves the pkcs7 response.
 *
 *  Parameters:
 *    ctx    EST context
 *    ssl    SSL context being used for this EST session
 *    csr    Pointer to X509_REQ object containing the PKCS10 CSR
 *    pkcs7_len  pointer to an integer in which the length of the recieved
 *               pkcs7 response is placed.
 *    priv_key Pointer to the private key used to sign the CSR.
 *    reenroll Set to 1 to do a reenroll instead of an enroll
 *
 *  Returns EST_ERROR  
 */</comment>
<function pos:start="1696:1" pos:end="1744:1"><type pos:start="1696:1" pos:end="1696:16"><specifier pos:start="1696:1" pos:end="1696:6">static</specifier> <name pos:start="1696:8" pos:end="1696:16">EST_ERROR</name></type> <name pos:start="1696:18" pos:end="1696:41">est_client_enroll_pkcs10</name> <parameter_list pos:start="1696:43" pos:end="1698:56">(<parameter pos:start="1696:44" pos:end="1696:55"><decl pos:start="1696:44" pos:end="1696:55"><type pos:start="1696:44" pos:end="1696:55"><name pos:start="1696:44" pos:end="1696:50">EST_CTX</name> <modifier pos:start="1696:52" pos:end="1696:52">*</modifier></type><name pos:start="1696:53" pos:end="1696:55">ctx</name></decl></parameter>, <parameter pos:start="1696:58" pos:end="1696:65"><decl pos:start="1696:58" pos:end="1696:65"><type pos:start="1696:58" pos:end="1696:65"><name pos:start="1696:58" pos:end="1696:60">SSL</name> <modifier pos:start="1696:62" pos:end="1696:62">*</modifier></type><name pos:start="1696:63" pos:end="1696:65">ssl</name></decl></parameter>, <parameter pos:start="1696:68" pos:end="1696:80"><decl pos:start="1696:68" pos:end="1696:80"><type pos:start="1696:68" pos:end="1696:80"><name pos:start="1696:68" pos:end="1696:75">X509_REQ</name> <modifier pos:start="1696:77" pos:end="1696:77">*</modifier></type><name pos:start="1696:78" pos:end="1696:80">csr</name></decl></parameter>,
                                           <parameter pos:start="1697:44" pos:end="1697:57"><decl pos:start="1697:44" pos:end="1697:57"><type pos:start="1697:44" pos:end="1697:57"><name pos:start="1697:44" pos:end="1697:46">int</name> <modifier pos:start="1697:48" pos:end="1697:48">*</modifier></type><name pos:start="1697:49" pos:end="1697:57">pkcs7_len</name></decl></parameter>, <parameter pos:start="1697:60" pos:end="1697:77"><decl pos:start="1697:60" pos:end="1697:77"><type pos:start="1697:60" pos:end="1697:77"><name pos:start="1697:60" pos:end="1697:67">EVP_PKEY</name> <modifier pos:start="1697:69" pos:end="1697:69">*</modifier></type><name pos:start="1697:70" pos:end="1697:77">priv_key</name></decl></parameter>,
                                           <parameter pos:start="1698:44" pos:end="1698:55"><decl pos:start="1698:44" pos:end="1698:55"><type pos:start="1698:44" pos:end="1698:55"><name pos:start="1698:44" pos:end="1698:46">int</name></type> <name pos:start="1698:48" pos:end="1698:55">reenroll</name></decl></parameter>)</parameter_list>
<block pos:start="1699:1" pos:end="1744:1">{<block_content pos:start="1700:5" pos:end="1743:16">
    <decl_stmt pos:start="1700:5" pos:end="1700:35"><decl pos:start="1700:5" pos:end="1700:34"><type pos:start="1700:5" pos:end="1700:13"><name pos:start="1700:5" pos:end="1700:13">EST_ERROR</name></type>    <name pos:start="1700:18" pos:end="1700:19">rv</name> <init pos:start="1700:21" pos:end="1700:34">= <expr pos:start="1700:23" pos:end="1700:34"><name pos:start="1700:23" pos:end="1700:34">EST_ERR_NONE</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="1701:5" pos:end="1701:25"><decl pos:start="1701:5" pos:end="1701:24"><type pos:start="1701:5" pos:end="1701:17"><name pos:start="1701:5" pos:end="1701:8">char</name>        <modifier pos:start="1701:17" pos:end="1701:17">*</modifier></type><name pos:start="1701:18" pos:end="1701:24">tls_uid</name></decl>;</decl_stmt>
    <decl_stmt pos:start="1702:5" pos:end="1702:25"><decl pos:start="1702:5" pos:end="1702:24"><type pos:start="1702:5" pos:end="1702:7"><name pos:start="1702:5" pos:end="1702:7">int</name></type>          <name pos:start="1702:18" pos:end="1702:24">ossl_rv</name></decl>;</decl_stmt>

    <comment type="block" pos:start="1704:5" pos:end="1706:7">/*
     * Make sure the PoP is removed from the CSR before we proceed
     */</comment>
    <expr_stmt pos:start="1707:5" pos:end="1707:34"><expr pos:start="1707:5" pos:end="1707:33"><call pos:start="1707:5" pos:end="1707:33"><name pos:start="1707:5" pos:end="1707:28">est_client_clear_csr_pop</name><argument_list pos:start="1707:29" pos:end="1707:33">(<argument pos:start="1707:30" pos:end="1707:32"><expr pos:start="1707:30" pos:end="1707:32"><name pos:start="1707:30" pos:end="1707:32">csr</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block" pos:start="1709:5" pos:end="1712:7">/*
     * Get the PoP value from the TLS session and embed this into
     * the CSR if required.
     */</comment>
    <if_stmt pos:start="1713:5" pos:end="1729:5"><if pos:start="1713:5" pos:end="1729:5">if <condition pos:start="1713:8" pos:end="1713:55">(<expr pos:start="1713:9" pos:end="1713:54"><name pos:start="1713:9" pos:end="1713:29"><name pos:start="1713:9" pos:end="1713:11">ctx</name><operator pos:start="1713:12" pos:end="1713:13">-&gt;</operator><name pos:start="1713:14" pos:end="1713:29">csr_pop_required</name></name> <operator pos:start="1713:31" pos:end="1713:32">||</operator> <name pos:start="1713:34" pos:end="1713:54"><name pos:start="1713:34" pos:end="1713:36">ctx</name><operator pos:start="1713:37" pos:end="1713:38">-&gt;</operator><name pos:start="1713:39" pos:end="1713:54">client_force_pop</name></name></expr>)</condition> <block pos:start="1713:57" pos:end="1729:5">{<block_content pos:start="1714:9" pos:end="1728:9">
	<expr_stmt pos:start="1714:9" pos:end="1714:69"><expr pos:start="1714:9" pos:end="1714:68"><call pos:start="1714:9" pos:end="1714:68"><name pos:start="1714:9" pos:end="1714:20">EST_LOG_INFO</name><argument_list pos:start="1714:21" pos:end="1714:68">(<argument pos:start="1714:22" pos:end="1714:67"><expr pos:start="1714:22" pos:end="1714:67"><literal type="string" pos:start="1714:22" pos:end="1714:67">"Client will include challengePassword in CSR"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1715:9" pos:end="1715:42"><expr pos:start="1715:9" pos:end="1715:41"><name pos:start="1715:9" pos:end="1715:15">tls_uid</name> <operator pos:start="1715:17" pos:end="1715:17">=</operator> <call pos:start="1715:19" pos:end="1715:41"><name pos:start="1715:19" pos:end="1715:33">est_get_tls_uid</name><argument_list pos:start="1715:34" pos:end="1715:41">(<argument pos:start="1715:35" pos:end="1715:37"><expr pos:start="1715:35" pos:end="1715:37"><name pos:start="1715:35" pos:end="1715:37">ssl</name></expr></argument>, <argument pos:start="1715:40" pos:end="1715:40"><expr pos:start="1715:40" pos:end="1715:40"><literal type="number" pos:start="1715:40" pos:end="1715:40">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if_stmt pos:start="1716:9" pos:end="1728:9"><if pos:start="1716:9" pos:end="1725:9">if <condition pos:start="1716:12" pos:end="1716:20">(<expr pos:start="1716:13" pos:end="1716:19"><name pos:start="1716:13" pos:end="1716:19">tls_uid</name></expr>)</condition> <block pos:start="1716:22" pos:end="1725:9">{<block_content pos:start="1717:13" pos:end="1724:13">
	    <expr_stmt pos:start="1717:13" pos:end="1718:91"><expr pos:start="1717:13" pos:end="1718:90"><name pos:start="1717:13" pos:end="1717:19">ossl_rv</name> <operator pos:start="1717:21" pos:end="1717:21">=</operator> <call pos:start="1717:23" pos:end="1718:90"><name pos:start="1717:23" pos:end="1717:47">X509_REQ_add1_attr_by_NID</name><argument_list pos:start="1717:48" pos:end="1718:90">(<argument pos:start="1717:49" pos:end="1717:51"><expr pos:start="1717:49" pos:end="1717:51"><name pos:start="1717:49" pos:end="1717:51">csr</name></expr></argument>, <argument pos:start="1717:54" pos:end="1717:80"><expr pos:start="1717:54" pos:end="1717:80"><name pos:start="1717:54" pos:end="1717:80">NID_pkcs9_challengePassword</name></expr></argument>,
                                                <argument pos:start="1718:49" pos:end="1718:60"><expr pos:start="1718:49" pos:end="1718:60"><name pos:start="1718:49" pos:end="1718:60">MBSTRING_ASC</name></expr></argument>, <argument pos:start="1718:63" pos:end="1718:85"><expr pos:start="1718:63" pos:end="1718:85"><operator pos:start="1718:63" pos:end="1718:63">(</operator><name pos:start="1718:64" pos:end="1718:71">unsigned</name> <name pos:start="1718:73" pos:end="1718:76">char</name><operator pos:start="1718:77" pos:end="1718:77">*</operator><operator pos:start="1718:78" pos:end="1718:78">)</operator><name pos:start="1718:79" pos:end="1718:85">tls_uid</name></expr></argument>, <argument pos:start="1718:88" pos:end="1718:89"><expr pos:start="1718:88" pos:end="1718:89"><operator pos:start="1718:88" pos:end="1718:88">-</operator><literal type="number" pos:start="1718:89" pos:end="1718:89">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt pos:start="1719:13" pos:end="1719:26"><expr pos:start="1719:13" pos:end="1719:25"><call pos:start="1719:13" pos:end="1719:25"><name pos:start="1719:13" pos:end="1719:16">free</name><argument_list pos:start="1719:17" pos:end="1719:25">(<argument pos:start="1719:18" pos:end="1719:24"><expr pos:start="1719:18" pos:end="1719:24"><name pos:start="1719:18" pos:end="1719:24">tls_uid</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <if_stmt pos:start="1720:13" pos:end="1724:13"><if pos:start="1720:13" pos:end="1724:13">if <condition pos:start="1720:16" pos:end="1720:25">(<expr pos:start="1720:17" pos:end="1720:24"><operator pos:start="1720:17" pos:end="1720:17">!</operator><name pos:start="1720:18" pos:end="1720:24">ossl_rv</name></expr>)</condition> <block pos:start="1720:27" pos:end="1724:13">{<block_content pos:start="1721:17" pos:end="1723:43">
	        <expr_stmt pos:start="1721:17" pos:end="1721:78"><expr pos:start="1721:17" pos:end="1721:77"><call pos:start="1721:17" pos:end="1721:77"><name pos:start="1721:17" pos:end="1721:27">EST_LOG_ERR</name><argument_list pos:start="1721:28" pos:end="1721:77">(<argument pos:start="1721:29" pos:end="1721:76"><expr pos:start="1721:29" pos:end="1721:76"><literal type="string" pos:start="1721:29" pos:end="1721:76">"Unable to set X509 challengePassword attribute"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<expr_stmt pos:start="1722:17" pos:end="1722:39"><expr pos:start="1722:17" pos:end="1722:38"><call pos:start="1722:17" pos:end="1722:38"><name pos:start="1722:17" pos:end="1722:36">ossl_dump_ssl_errors</name><argument_list pos:start="1722:37" pos:end="1722:38">()</argument_list></call></expr>;</expr_stmt>
		<return pos:start="1723:17" pos:end="1723:43">return <expr pos:start="1723:24" pos:end="1723:42"><operator pos:start="1723:24" pos:end="1723:24">(</operator><name pos:start="1723:25" pos:end="1723:41">EST_ERR_X509_ATTR</name><operator pos:start="1723:42" pos:end="1723:42">)</operator></expr>;</return>
	    </block_content>}</block></if></if_stmt>
        </block_content>}</block></if> <else pos:start="1725:11" pos:end="1728:9">else <block pos:start="1725:16" pos:end="1728:9">{<block_content pos:start="1726:13" pos:end="1727:46">
            <expr_stmt pos:start="1726:13" pos:end="1726:56"><expr pos:start="1726:13" pos:end="1726:55"><call pos:start="1726:13" pos:end="1726:55"><name pos:start="1726:13" pos:end="1726:23">EST_LOG_ERR</name><argument_list pos:start="1726:24" pos:end="1726:55">(<argument pos:start="1726:25" pos:end="1726:54"><expr pos:start="1726:25" pos:end="1726:54"><literal type="string" pos:start="1726:25" pos:end="1726:54">"Unable to obtain the TLS UID"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <return pos:start="1727:13" pos:end="1727:46">return <expr pos:start="1727:20" pos:end="1727:45"><operator pos:start="1727:20" pos:end="1727:20">(</operator><name pos:start="1727:21" pos:end="1727:44">EST_ERR_AUTH_FAIL_TLSUID</name><operator pos:start="1727:45" pos:end="1727:45">)</operator></expr>;</return>
	</block_content>}</block></else></if_stmt>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="1731:5" pos:end="1733:7">/*
     * Sign the CSR
     */</comment>
    <expr_stmt pos:start="1734:5" pos:end="1734:75"><expr pos:start="1734:5" pos:end="1734:74"><name pos:start="1734:5" pos:end="1734:11">ossl_rv</name> <operator pos:start="1734:13" pos:end="1734:13">=</operator> <call pos:start="1734:15" pos:end="1734:74"><name pos:start="1734:15" pos:end="1734:38">est_client_X509_REQ_sign</name><argument_list pos:start="1734:39" pos:end="1734:74">(<argument pos:start="1734:40" pos:end="1734:42"><expr pos:start="1734:40" pos:end="1734:42"><name pos:start="1734:40" pos:end="1734:42">csr</name></expr></argument>, <argument pos:start="1734:45" pos:end="1734:52"><expr pos:start="1734:45" pos:end="1734:52"><name pos:start="1734:45" pos:end="1734:52">priv_key</name></expr></argument>, <argument pos:start="1734:55" pos:end="1734:73"><expr pos:start="1734:55" pos:end="1734:73"><name pos:start="1734:55" pos:end="1734:73"><name pos:start="1734:55" pos:end="1734:57">ctx</name><operator pos:start="1734:58" pos:end="1734:59">-&gt;</operator><name pos:start="1734:60" pos:end="1734:73">signing_digest</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1735:5" pos:end="1739:5"><if pos:start="1735:5" pos:end="1739:5">if <condition pos:start="1735:8" pos:end="1735:17">(<expr pos:start="1735:9" pos:end="1735:16"><operator pos:start="1735:9" pos:end="1735:9">!</operator><name pos:start="1735:10" pos:end="1735:16">ossl_rv</name></expr>)</condition> <block pos:start="1735:19" pos:end="1739:5">{<block_content pos:start="1736:9" pos:end="1738:35">
        <expr_stmt pos:start="1736:9" pos:end="1736:56"><expr pos:start="1736:9" pos:end="1736:55"><call pos:start="1736:9" pos:end="1736:55"><name pos:start="1736:9" pos:end="1736:19">EST_LOG_ERR</name><argument_list pos:start="1736:20" pos:end="1736:55">(<argument pos:start="1736:21" pos:end="1736:54"><expr pos:start="1736:21" pos:end="1736:54"><literal type="string" pos:start="1736:21" pos:end="1736:54">"Unable to sign X509 cert request"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1737:9" pos:end="1737:31"><expr pos:start="1737:9" pos:end="1737:30"><call pos:start="1737:9" pos:end="1737:30"><name pos:start="1737:9" pos:end="1737:28">ossl_dump_ssl_errors</name><argument_list pos:start="1737:29" pos:end="1737:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="1738:9" pos:end="1738:35">return <expr pos:start="1738:16" pos:end="1738:34"><operator pos:start="1738:16" pos:end="1738:16">(</operator><name pos:start="1738:17" pos:end="1738:33">EST_ERR_X509_SIGN</name><operator pos:start="1738:34" pos:end="1738:34">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="1741:5" pos:end="1741:67"><expr pos:start="1741:5" pos:end="1741:66"><name pos:start="1741:5" pos:end="1741:6">rv</name> <operator pos:start="1741:8" pos:end="1741:8">=</operator> <call pos:start="1741:10" pos:end="1741:66"><name pos:start="1741:10" pos:end="1741:30">est_client_enroll_req</name><argument_list pos:start="1741:31" pos:end="1741:66">(<argument pos:start="1741:32" pos:end="1741:34"><expr pos:start="1741:32" pos:end="1741:34"><name pos:start="1741:32" pos:end="1741:34">ctx</name></expr></argument>, <argument pos:start="1741:37" pos:end="1741:39"><expr pos:start="1741:37" pos:end="1741:39"><name pos:start="1741:37" pos:end="1741:39">ssl</name></expr></argument>, <argument pos:start="1741:42" pos:end="1741:44"><expr pos:start="1741:42" pos:end="1741:44"><name pos:start="1741:42" pos:end="1741:44">csr</name></expr></argument>, <argument pos:start="1741:47" pos:end="1741:55"><expr pos:start="1741:47" pos:end="1741:55"><name pos:start="1741:47" pos:end="1741:55">pkcs7_len</name></expr></argument>, <argument pos:start="1741:58" pos:end="1741:65"><expr pos:start="1741:58" pos:end="1741:65"><name pos:start="1741:58" pos:end="1741:65">reenroll</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <return pos:start="1743:5" pos:end="1743:16">return <expr pos:start="1743:12" pos:end="1743:15"><operator pos:start="1743:12" pos:end="1743:12">(</operator><name pos:start="1743:13" pos:end="1743:14">rv</name><operator pos:start="1743:15" pos:end="1743:15">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="1745:1" pos:end="1761:3">/*  est_client_enroll_cn() This function implements the Simple Enroll
    flow. It uses the private key to generate a CSR (pkcs10) request.  It
    then sends the request to the EST server and retrieves the pkcs7
    response.  The user of this function simply provides the CommonName
    value to be placed in the PKCS10 CSR.  This is a simplified interface,
    none of the other CSR attributes can be specified.

    @param ctx EST context
    @param ssl SSL context being used for this EST session
    @param cn pointer to the common name that is to be placed in the x509
    request
    @param pkcs7_len pointer to an integer in which the length of the recieved
    pkcs7 response is placed.
    @param pkey The new client public key that is to be enrolled

    @return EST_ERROR 
 */</comment>
<function pos:start="1762:1" pos:end="1795:1"><type pos:start="1762:1" pos:end="1762:16"><specifier pos:start="1762:1" pos:end="1762:6">static</specifier> <name pos:start="1762:8" pos:end="1762:16">EST_ERROR</name></type> <name pos:start="1762:18" pos:end="1762:37">est_client_enroll_cn</name> <parameter_list pos:start="1762:39" pos:end="1763:72">(<parameter pos:start="1762:40" pos:end="1762:51"><decl pos:start="1762:40" pos:end="1762:51"><type pos:start="1762:40" pos:end="1762:51"><name pos:start="1762:40" pos:end="1762:46">EST_CTX</name> <modifier pos:start="1762:48" pos:end="1762:48">*</modifier></type><name pos:start="1762:49" pos:end="1762:51">ctx</name></decl></parameter>, <parameter pos:start="1762:54" pos:end="1762:61"><decl pos:start="1762:54" pos:end="1762:61"><type pos:start="1762:54" pos:end="1762:61"><name pos:start="1762:54" pos:end="1762:56">SSL</name> <modifier pos:start="1762:58" pos:end="1762:58">*</modifier></type><name pos:start="1762:59" pos:end="1762:61">ssl</name></decl></parameter>, <parameter pos:start="1762:64" pos:end="1762:71"><decl pos:start="1762:64" pos:end="1762:71"><type pos:start="1762:64" pos:end="1762:71"><name pos:start="1762:64" pos:end="1762:67">char</name> <modifier pos:start="1762:69" pos:end="1762:69">*</modifier></type><name pos:start="1762:70" pos:end="1762:71">cn</name></decl></parameter>,
                                         <parameter pos:start="1763:42" pos:end="1763:55"><decl pos:start="1763:42" pos:end="1763:55"><type pos:start="1763:42" pos:end="1763:55"><name pos:start="1763:42" pos:end="1763:44">int</name> <modifier pos:start="1763:46" pos:end="1763:46">*</modifier></type><name pos:start="1763:47" pos:end="1763:55">pkcs7_len</name></decl></parameter>, <parameter pos:start="1763:58" pos:end="1763:71"><decl pos:start="1763:58" pos:end="1763:71"><type pos:start="1763:58" pos:end="1763:71"><name pos:start="1763:58" pos:end="1763:65">EVP_PKEY</name> <modifier pos:start="1763:67" pos:end="1763:67">*</modifier></type><name pos:start="1763:68" pos:end="1763:71">pkey</name></decl></parameter>)</parameter_list>
<block pos:start="1764:1" pos:end="1795:1">{<block_content pos:start="1765:5" pos:end="1794:16">
    <decl_stmt pos:start="1765:5" pos:end="1765:31"><decl pos:start="1765:5" pos:end="1765:30"><type pos:start="1765:5" pos:end="1765:17"><name pos:start="1765:5" pos:end="1765:12">X509_REQ</name>    <modifier pos:start="1765:17" pos:end="1765:17">*</modifier></type><name pos:start="1765:18" pos:end="1765:23">pkcs10</name> <init pos:start="1765:25" pos:end="1765:30">= <expr pos:start="1765:27" pos:end="1765:30"><name pos:start="1765:27" pos:end="1765:30">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="1766:5" pos:end="1766:35"><decl pos:start="1766:5" pos:end="1766:34"><type pos:start="1766:5" pos:end="1766:13"><name pos:start="1766:5" pos:end="1766:13">EST_ERROR</name></type>    <name pos:start="1766:18" pos:end="1766:19">rv</name> <init pos:start="1766:21" pos:end="1766:34">= <expr pos:start="1766:23" pos:end="1766:34"><name pos:start="1766:23" pos:end="1766:34">EST_ERR_NONE</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="1767:5" pos:end="1767:25"><decl pos:start="1767:5" pos:end="1767:24"><type pos:start="1767:5" pos:end="1767:17"><name pos:start="1767:5" pos:end="1767:8">char</name>        <modifier pos:start="1767:17" pos:end="1767:17">*</modifier></type><name pos:start="1767:18" pos:end="1767:24">tls_uid</name></decl>;</decl_stmt>

    <if_stmt pos:start="1769:5" pos:end="1771:5"><if pos:start="1769:5" pos:end="1771:5">if <condition pos:start="1769:8" pos:end="1769:13">(<expr pos:start="1769:9" pos:end="1769:12"><operator pos:start="1769:9" pos:end="1769:9">!</operator><name pos:start="1769:10" pos:end="1769:12">ctx</name></expr>)</condition> <block pos:start="1769:15" pos:end="1771:5">{<block_content pos:start="1770:9" pos:end="1770:32">
        <return pos:start="1770:9" pos:end="1770:32">return <expr pos:start="1770:16" pos:end="1770:31"><operator pos:start="1770:16" pos:end="1770:16">(</operator><name pos:start="1770:17" pos:end="1770:30">EST_ERR_NO_CTX</name><operator pos:start="1770:31" pos:end="1770:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="1773:5" pos:end="1776:7">/*
     * Attempt to create the PKCS10 certificate request.
     * Get the TLS uid in case we need it during populate.
     */</comment>
    <expr_stmt pos:start="1777:5" pos:end="1777:38"><expr pos:start="1777:5" pos:end="1777:37"><name pos:start="1777:5" pos:end="1777:11">tls_uid</name> <operator pos:start="1777:13" pos:end="1777:13">=</operator> <call pos:start="1777:15" pos:end="1777:37"><name pos:start="1777:15" pos:end="1777:29">est_get_tls_uid</name><argument_list pos:start="1777:30" pos:end="1777:37">(<argument pos:start="1777:31" pos:end="1777:33"><expr pos:start="1777:31" pos:end="1777:33"><name pos:start="1777:31" pos:end="1777:33">ssl</name></expr></argument>, <argument pos:start="1777:36" pos:end="1777:36"><expr pos:start="1777:36" pos:end="1777:36"><literal type="number" pos:start="1777:36" pos:end="1777:36">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1778:5" pos:end="1784:5"><if pos:start="1778:5" pos:end="1781:5">if <condition pos:start="1778:8" pos:end="1778:16">(<expr pos:start="1778:9" pos:end="1778:15"><name pos:start="1778:9" pos:end="1778:15">tls_uid</name></expr>)</condition> <block pos:start="1778:18" pos:end="1781:5">{<block_content pos:start="1779:9" pos:end="1780:22">
        <expr_stmt pos:start="1779:9" pos:end="1779:66"><expr pos:start="1779:9" pos:end="1779:65"><name pos:start="1779:9" pos:end="1779:10">rv</name> <operator pos:start="1779:12" pos:end="1779:12">=</operator> <call pos:start="1779:14" pos:end="1779:65"><name pos:start="1779:14" pos:end="1779:32">est_generate_pkcs10</name><argument_list pos:start="1779:33" pos:end="1779:65">(<argument pos:start="1779:34" pos:end="1779:36"><expr pos:start="1779:34" pos:end="1779:36"><name pos:start="1779:34" pos:end="1779:36">ctx</name></expr></argument>, <argument pos:start="1779:39" pos:end="1779:40"><expr pos:start="1779:39" pos:end="1779:40"><name pos:start="1779:39" pos:end="1779:40">cn</name></expr></argument>, <argument pos:start="1779:43" pos:end="1779:49"><expr pos:start="1779:43" pos:end="1779:49"><name pos:start="1779:43" pos:end="1779:49">tls_uid</name></expr></argument>, <argument pos:start="1779:52" pos:end="1779:55"><expr pos:start="1779:52" pos:end="1779:55"><name pos:start="1779:52" pos:end="1779:55">pkey</name></expr></argument>, <argument pos:start="1779:58" pos:end="1779:64"><expr pos:start="1779:58" pos:end="1779:64"><operator pos:start="1779:58" pos:end="1779:58">&amp;</operator><name pos:start="1779:59" pos:end="1779:64">pkcs10</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1780:9" pos:end="1780:22"><expr pos:start="1780:9" pos:end="1780:21"><call pos:start="1780:9" pos:end="1780:21"><name pos:start="1780:9" pos:end="1780:12">free</name><argument_list pos:start="1780:13" pos:end="1780:21">(<argument pos:start="1780:14" pos:end="1780:20"><expr pos:start="1780:14" pos:end="1780:20"><name pos:start="1780:14" pos:end="1780:20">tls_uid</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if> <else pos:start="1781:7" pos:end="1784:5">else <block pos:start="1781:12" pos:end="1784:5">{<block_content pos:start="1782:9" pos:end="1783:38">
        <expr_stmt pos:start="1782:9" pos:end="1782:52"><expr pos:start="1782:9" pos:end="1782:51"><call pos:start="1782:9" pos:end="1782:51"><name pos:start="1782:9" pos:end="1782:19">EST_LOG_ERR</name><argument_list pos:start="1782:20" pos:end="1782:51">(<argument pos:start="1782:21" pos:end="1782:50"><expr pos:start="1782:21" pos:end="1782:50"><literal type="string" pos:start="1782:21" pos:end="1782:50">"Unable to obtain the TLS UID"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="1783:9" pos:end="1783:38"><expr pos:start="1783:9" pos:end="1783:37"><name pos:start="1783:9" pos:end="1783:10">rv</name> <operator pos:start="1783:12" pos:end="1783:12">=</operator> <name pos:start="1783:14" pos:end="1783:37">EST_ERR_AUTH_FAIL_TLSUID</name></expr>;</expr_stmt>
    </block_content>}</block></else></if_stmt>

    <if_stmt pos:start="1786:5" pos:end="1788:5"><if pos:start="1786:5" pos:end="1788:5">if <condition pos:start="1786:8" pos:end="1786:27">(<expr pos:start="1786:9" pos:end="1786:26"><name pos:start="1786:9" pos:end="1786:10">rv</name> <operator pos:start="1786:12" pos:end="1786:13">==</operator> <name pos:start="1786:15" pos:end="1786:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="1786:29" pos:end="1788:5">{<block_content pos:start="1787:9" pos:end="1787:67">
        <expr_stmt pos:start="1787:9" pos:end="1787:67"><expr pos:start="1787:9" pos:end="1787:66"><name pos:start="1787:9" pos:end="1787:10">rv</name> <operator pos:start="1787:12" pos:end="1787:12">=</operator> <call pos:start="1787:14" pos:end="1787:66"><name pos:start="1787:14" pos:end="1787:34">est_client_enroll_req</name><argument_list pos:start="1787:35" pos:end="1787:66">(<argument pos:start="1787:36" pos:end="1787:38"><expr pos:start="1787:36" pos:end="1787:38"><name pos:start="1787:36" pos:end="1787:38">ctx</name></expr></argument>, <argument pos:start="1787:41" pos:end="1787:43"><expr pos:start="1787:41" pos:end="1787:43"><name pos:start="1787:41" pos:end="1787:43">ssl</name></expr></argument>, <argument pos:start="1787:46" pos:end="1787:51"><expr pos:start="1787:46" pos:end="1787:51"><name pos:start="1787:46" pos:end="1787:51">pkcs10</name></expr></argument>, <argument pos:start="1787:54" pos:end="1787:62"><expr pos:start="1787:54" pos:end="1787:62"><name pos:start="1787:54" pos:end="1787:62">pkcs7_len</name></expr></argument>, <argument pos:start="1787:65" pos:end="1787:65"><expr pos:start="1787:65" pos:end="1787:65"><literal type="number" pos:start="1787:65" pos:end="1787:65">0</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    
    <if_stmt pos:start="1790:5" pos:end="1792:5"><if pos:start="1790:5" pos:end="1792:5">if <condition pos:start="1790:8" pos:end="1790:15">(<expr pos:start="1790:9" pos:end="1790:14"><name pos:start="1790:9" pos:end="1790:14">pkcs10</name></expr>)</condition> <block pos:start="1790:17" pos:end="1792:5">{<block_content pos:start="1791:9" pos:end="1791:30">
        <expr_stmt pos:start="1791:9" pos:end="1791:30"><expr pos:start="1791:9" pos:end="1791:29"><call pos:start="1791:9" pos:end="1791:29"><name pos:start="1791:9" pos:end="1791:21">X509_REQ_free</name><argument_list pos:start="1791:22" pos:end="1791:29">(<argument pos:start="1791:23" pos:end="1791:28"><expr pos:start="1791:23" pos:end="1791:28"><name pos:start="1791:23" pos:end="1791:28">pkcs10</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>

    <return pos:start="1794:5" pos:end="1794:16">return <expr pos:start="1794:12" pos:end="1794:15"><operator pos:start="1794:12" pos:end="1794:12">(</operator><name pos:start="1794:13" pos:end="1794:14">rv</name><operator pos:start="1794:15" pos:end="1794:15">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="1796:1" pos:end="1805:3">/* 
 * The following function was taken from cURL
 *
 * The content that was incorporated were portions of
 * - lib/hostcheck.c
 * - lib/rawstr.c
 *
 * Portable, consistent toupper (remember EBCDIC). Do not use toupper() because
 * its behavior is altered by the current locale. 
 */</comment>
<function pos:start="1806:1" pos:end="1863:1"><type pos:start="1806:1" pos:end="1806:11"><specifier pos:start="1806:1" pos:end="1806:6">static</specifier> <name pos:start="1806:8" pos:end="1806:11">char</name></type> <name pos:start="1806:13" pos:end="1806:39">est_client_Curl_raw_toupper</name><parameter_list pos:start="1806:40" pos:end="1806:48">(<parameter pos:start="1806:41" pos:end="1806:47"><decl pos:start="1806:41" pos:end="1806:47"><type pos:start="1806:41" pos:end="1806:44"><name pos:start="1806:41" pos:end="1806:44">char</name></type> <name pos:start="1806:46" pos:end="1806:47">in</name></decl></parameter>)</parameter_list>
<block pos:start="1807:1" pos:end="1863:1">{<block_content pos:start="1808:5" pos:end="1862:14">
    <switch pos:start="1808:5" pos:end="1861:5">switch <condition pos:start="1808:12" pos:end="1808:15">(<expr pos:start="1808:13" pos:end="1808:14"><name pos:start="1808:13" pos:end="1808:14">in</name></expr>)</condition> <block pos:start="1808:17" pos:end="1861:5">{<block_content pos:start="1809:5" pos:end="1860:19">
    <case pos:start="1809:5" pos:end="1809:13">case <expr pos:start="1809:10" pos:end="1809:12"><literal type="char" pos:start="1809:10" pos:end="1809:12">'a'</literal></expr>:</case>
        <return pos:start="1810:9" pos:end="1810:19">return <expr pos:start="1810:16" pos:end="1810:18"><literal type="char" pos:start="1810:16" pos:end="1810:18">'A'</literal></expr>;</return>
    <case pos:start="1811:5" pos:end="1811:13">case <expr pos:start="1811:10" pos:end="1811:12"><literal type="char" pos:start="1811:10" pos:end="1811:12">'b'</literal></expr>:</case>
        <return pos:start="1812:9" pos:end="1812:19">return <expr pos:start="1812:16" pos:end="1812:18"><literal type="char" pos:start="1812:16" pos:end="1812:18">'B'</literal></expr>;</return>
    <case pos:start="1813:5" pos:end="1813:13">case <expr pos:start="1813:10" pos:end="1813:12"><literal type="char" pos:start="1813:10" pos:end="1813:12">'c'</literal></expr>:</case>
        <return pos:start="1814:9" pos:end="1814:19">return <expr pos:start="1814:16" pos:end="1814:18"><literal type="char" pos:start="1814:16" pos:end="1814:18">'C'</literal></expr>;</return>
    <case pos:start="1815:5" pos:end="1815:13">case <expr pos:start="1815:10" pos:end="1815:12"><literal type="char" pos:start="1815:10" pos:end="1815:12">'d'</literal></expr>:</case>
        <return pos:start="1816:9" pos:end="1816:19">return <expr pos:start="1816:16" pos:end="1816:18"><literal type="char" pos:start="1816:16" pos:end="1816:18">'D'</literal></expr>;</return>
    <case pos:start="1817:5" pos:end="1817:13">case <expr pos:start="1817:10" pos:end="1817:12"><literal type="char" pos:start="1817:10" pos:end="1817:12">'e'</literal></expr>:</case>
        <return pos:start="1818:9" pos:end="1818:19">return <expr pos:start="1818:16" pos:end="1818:18"><literal type="char" pos:start="1818:16" pos:end="1818:18">'E'</literal></expr>;</return>
    <case pos:start="1819:5" pos:end="1819:13">case <expr pos:start="1819:10" pos:end="1819:12"><literal type="char" pos:start="1819:10" pos:end="1819:12">'f'</literal></expr>:</case>
        <return pos:start="1820:9" pos:end="1820:19">return <expr pos:start="1820:16" pos:end="1820:18"><literal type="char" pos:start="1820:16" pos:end="1820:18">'F'</literal></expr>;</return>
    <case pos:start="1821:5" pos:end="1821:13">case <expr pos:start="1821:10" pos:end="1821:12"><literal type="char" pos:start="1821:10" pos:end="1821:12">'g'</literal></expr>:</case>
        <return pos:start="1822:9" pos:end="1822:19">return <expr pos:start="1822:16" pos:end="1822:18"><literal type="char" pos:start="1822:16" pos:end="1822:18">'G'</literal></expr>;</return>
    <case pos:start="1823:5" pos:end="1823:13">case <expr pos:start="1823:10" pos:end="1823:12"><literal type="char" pos:start="1823:10" pos:end="1823:12">'h'</literal></expr>:</case>
        <return pos:start="1824:9" pos:end="1824:19">return <expr pos:start="1824:16" pos:end="1824:18"><literal type="char" pos:start="1824:16" pos:end="1824:18">'H'</literal></expr>;</return>
    <case pos:start="1825:5" pos:end="1825:13">case <expr pos:start="1825:10" pos:end="1825:12"><literal type="char" pos:start="1825:10" pos:end="1825:12">'i'</literal></expr>:</case>
        <return pos:start="1826:9" pos:end="1826:19">return <expr pos:start="1826:16" pos:end="1826:18"><literal type="char" pos:start="1826:16" pos:end="1826:18">'I'</literal></expr>;</return>
    <case pos:start="1827:5" pos:end="1827:13">case <expr pos:start="1827:10" pos:end="1827:12"><literal type="char" pos:start="1827:10" pos:end="1827:12">'j'</literal></expr>:</case>
        <return pos:start="1828:9" pos:end="1828:19">return <expr pos:start="1828:16" pos:end="1828:18"><literal type="char" pos:start="1828:16" pos:end="1828:18">'J'</literal></expr>;</return>
    <case pos:start="1829:5" pos:end="1829:13">case <expr pos:start="1829:10" pos:end="1829:12"><literal type="char" pos:start="1829:10" pos:end="1829:12">'k'</literal></expr>:</case>
        <return pos:start="1830:9" pos:end="1830:19">return <expr pos:start="1830:16" pos:end="1830:18"><literal type="char" pos:start="1830:16" pos:end="1830:18">'K'</literal></expr>;</return>
    <case pos:start="1831:5" pos:end="1831:13">case <expr pos:start="1831:10" pos:end="1831:12"><literal type="char" pos:start="1831:10" pos:end="1831:12">'l'</literal></expr>:</case>
        <return pos:start="1832:9" pos:end="1832:19">return <expr pos:start="1832:16" pos:end="1832:18"><literal type="char" pos:start="1832:16" pos:end="1832:18">'L'</literal></expr>;</return>
    <case pos:start="1833:5" pos:end="1833:13">case <expr pos:start="1833:10" pos:end="1833:12"><literal type="char" pos:start="1833:10" pos:end="1833:12">'m'</literal></expr>:</case>
        <return pos:start="1834:9" pos:end="1834:19">return <expr pos:start="1834:16" pos:end="1834:18"><literal type="char" pos:start="1834:16" pos:end="1834:18">'M'</literal></expr>;</return>
    <case pos:start="1835:5" pos:end="1835:13">case <expr pos:start="1835:10" pos:end="1835:12"><literal type="char" pos:start="1835:10" pos:end="1835:12">'n'</literal></expr>:</case>
        <return pos:start="1836:9" pos:end="1836:19">return <expr pos:start="1836:16" pos:end="1836:18"><literal type="char" pos:start="1836:16" pos:end="1836:18">'N'</literal></expr>;</return>
    <case pos:start="1837:5" pos:end="1837:13">case <expr pos:start="1837:10" pos:end="1837:12"><literal type="char" pos:start="1837:10" pos:end="1837:12">'o'</literal></expr>:</case>
        <return pos:start="1838:9" pos:end="1838:19">return <expr pos:start="1838:16" pos:end="1838:18"><literal type="char" pos:start="1838:16" pos:end="1838:18">'O'</literal></expr>;</return>
    <case pos:start="1839:5" pos:end="1839:13">case <expr pos:start="1839:10" pos:end="1839:12"><literal type="char" pos:start="1839:10" pos:end="1839:12">'p'</literal></expr>:</case>
        <return pos:start="1840:9" pos:end="1840:19">return <expr pos:start="1840:16" pos:end="1840:18"><literal type="char" pos:start="1840:16" pos:end="1840:18">'P'</literal></expr>;</return>
    <case pos:start="1841:5" pos:end="1841:13">case <expr pos:start="1841:10" pos:end="1841:12"><literal type="char" pos:start="1841:10" pos:end="1841:12">'q'</literal></expr>:</case>
        <return pos:start="1842:9" pos:end="1842:19">return <expr pos:start="1842:16" pos:end="1842:18"><literal type="char" pos:start="1842:16" pos:end="1842:18">'Q'</literal></expr>;</return>
    <case pos:start="1843:5" pos:end="1843:13">case <expr pos:start="1843:10" pos:end="1843:12"><literal type="char" pos:start="1843:10" pos:end="1843:12">'r'</literal></expr>:</case>
        <return pos:start="1844:9" pos:end="1844:19">return <expr pos:start="1844:16" pos:end="1844:18"><literal type="char" pos:start="1844:16" pos:end="1844:18">'R'</literal></expr>;</return>
    <case pos:start="1845:5" pos:end="1845:13">case <expr pos:start="1845:10" pos:end="1845:12"><literal type="char" pos:start="1845:10" pos:end="1845:12">'s'</literal></expr>:</case>
        <return pos:start="1846:9" pos:end="1846:19">return <expr pos:start="1846:16" pos:end="1846:18"><literal type="char" pos:start="1846:16" pos:end="1846:18">'S'</literal></expr>;</return>
    <case pos:start="1847:5" pos:end="1847:13">case <expr pos:start="1847:10" pos:end="1847:12"><literal type="char" pos:start="1847:10" pos:end="1847:12">'t'</literal></expr>:</case>
        <return pos:start="1848:9" pos:end="1848:19">return <expr pos:start="1848:16" pos:end="1848:18"><literal type="char" pos:start="1848:16" pos:end="1848:18">'T'</literal></expr>;</return>
    <case pos:start="1849:5" pos:end="1849:13">case <expr pos:start="1849:10" pos:end="1849:12"><literal type="char" pos:start="1849:10" pos:end="1849:12">'u'</literal></expr>:</case>
        <return pos:start="1850:9" pos:end="1850:19">return <expr pos:start="1850:16" pos:end="1850:18"><literal type="char" pos:start="1850:16" pos:end="1850:18">'U'</literal></expr>;</return>
    <case pos:start="1851:5" pos:end="1851:13">case <expr pos:start="1851:10" pos:end="1851:12"><literal type="char" pos:start="1851:10" pos:end="1851:12">'v'</literal></expr>:</case>
        <return pos:start="1852:9" pos:end="1852:19">return <expr pos:start="1852:16" pos:end="1852:18"><literal type="char" pos:start="1852:16" pos:end="1852:18">'V'</literal></expr>;</return>
    <case pos:start="1853:5" pos:end="1853:13">case <expr pos:start="1853:10" pos:end="1853:12"><literal type="char" pos:start="1853:10" pos:end="1853:12">'w'</literal></expr>:</case>
        <return pos:start="1854:9" pos:end="1854:19">return <expr pos:start="1854:16" pos:end="1854:18"><literal type="char" pos:start="1854:16" pos:end="1854:18">'W'</literal></expr>;</return>
    <case pos:start="1855:5" pos:end="1855:13">case <expr pos:start="1855:10" pos:end="1855:12"><literal type="char" pos:start="1855:10" pos:end="1855:12">'x'</literal></expr>:</case>
        <return pos:start="1856:9" pos:end="1856:19">return <expr pos:start="1856:16" pos:end="1856:18"><literal type="char" pos:start="1856:16" pos:end="1856:18">'X'</literal></expr>;</return>
    <case pos:start="1857:5" pos:end="1857:13">case <expr pos:start="1857:10" pos:end="1857:12"><literal type="char" pos:start="1857:10" pos:end="1857:12">'y'</literal></expr>:</case>
        <return pos:start="1858:9" pos:end="1858:19">return <expr pos:start="1858:16" pos:end="1858:18"><literal type="char" pos:start="1858:16" pos:end="1858:18">'Y'</literal></expr>;</return>
    <case pos:start="1859:5" pos:end="1859:13">case <expr pos:start="1859:10" pos:end="1859:12"><literal type="char" pos:start="1859:10" pos:end="1859:12">'z'</literal></expr>:</case>
        <return pos:start="1860:9" pos:end="1860:19">return <expr pos:start="1860:16" pos:end="1860:18"><literal type="char" pos:start="1860:16" pos:end="1860:18">'Z'</literal></expr>;</return>
    </block_content>}</block></switch>
    <return pos:start="1862:5" pos:end="1862:14">return <expr pos:start="1862:12" pos:end="1862:13"><name pos:start="1862:12" pos:end="1862:13">in</name></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="1864:1" pos:end="1874:3">/*
 * The following function was taken from cURL
 *
 * Curl_raw_equal() is for doing "raw" case insensitive strings. This is meant
 * to be locale independent and only compare strings we know are safe for
 * this.  See http://daniel.haxx.se/blog/2008/10/15/strcasecmp-in-turkish/ for
 * some further explanation to why this function is necessary.
 *
 * The function is capable of comparing a-z case insensitively even for
 * non-ascii.
 */</comment>
<function pos:start="1875:1" pos:end="1889:1"><type pos:start="1875:1" pos:end="1875:10"><specifier pos:start="1875:1" pos:end="1875:6">static</specifier> <name pos:start="1875:8" pos:end="1875:10">int</name></type> <name pos:start="1875:12" pos:end="1875:36">est_client_Curl_raw_equal</name><parameter_list pos:start="1875:37" pos:end="1875:75">(<parameter pos:start="1875:38" pos:end="1875:54"><decl pos:start="1875:38" pos:end="1875:54"><type pos:start="1875:38" pos:end="1875:54"><specifier pos:start="1875:38" pos:end="1875:42">const</specifier> <name pos:start="1875:44" pos:end="1875:47">char</name> <modifier pos:start="1875:49" pos:end="1875:49">*</modifier></type><name pos:start="1875:50" pos:end="1875:54">first</name></decl></parameter>, <parameter pos:start="1875:57" pos:end="1875:74"><decl pos:start="1875:57" pos:end="1875:74"><type pos:start="1875:57" pos:end="1875:74"><specifier pos:start="1875:57" pos:end="1875:61">const</specifier> <name pos:start="1875:63" pos:end="1875:66">char</name> <modifier pos:start="1875:68" pos:end="1875:68">*</modifier></type><name pos:start="1875:69" pos:end="1875:74">second</name></decl></parameter>)</parameter_list>
<block pos:start="1876:1" pos:end="1889:1">{<block_content pos:start="1877:5" pos:end="1888:89">
    <while pos:start="1877:5" pos:end="1884:5">while<condition pos:start="1877:10" pos:end="1877:28">(<expr pos:start="1877:11" pos:end="1877:27"><operator pos:start="1877:11" pos:end="1877:11">*</operator><name pos:start="1877:12" pos:end="1877:16">first</name> <operator pos:start="1877:18" pos:end="1877:19">&amp;&amp;</operator> <operator pos:start="1877:21" pos:end="1877:21">*</operator><name pos:start="1877:22" pos:end="1877:27">second</name></expr>)</condition> <block pos:start="1877:30" pos:end="1884:5">{<block_content pos:start="1878:9" pos:end="1883:17">
	<if_stmt pos:start="1878:9" pos:end="1881:9"><if pos:start="1878:9" pos:end="1881:9">if<condition pos:start="1878:11" pos:end="1878:87">(<expr pos:start="1878:12" pos:end="1878:86"><call pos:start="1878:12" pos:end="1878:46"><name pos:start="1878:12" pos:end="1878:38">est_client_Curl_raw_toupper</name><argument_list pos:start="1878:39" pos:end="1878:46">(<argument pos:start="1878:40" pos:end="1878:45"><expr pos:start="1878:40" pos:end="1878:45"><operator pos:start="1878:40" pos:end="1878:40">*</operator><name pos:start="1878:41" pos:end="1878:45">first</name></expr></argument>)</argument_list></call> <operator pos:start="1878:48" pos:end="1878:49">!=</operator> <call pos:start="1878:51" pos:end="1878:86"><name pos:start="1878:51" pos:end="1878:77">est_client_Curl_raw_toupper</name><argument_list pos:start="1878:78" pos:end="1878:86">(<argument pos:start="1878:79" pos:end="1878:85"><expr pos:start="1878:79" pos:end="1878:85"><operator pos:start="1878:79" pos:end="1878:79">*</operator><name pos:start="1878:80" pos:end="1878:85">second</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="1878:89" pos:end="1881:9">{<block_content pos:start="1880:13" pos:end="1880:18">
	    <comment type="block" pos:start="1879:13" pos:end="1879:65">/* get out of the loop as soon as they don't match */</comment>
	    <break pos:start="1880:13" pos:end="1880:18">break;</break>
	</block_content>}</block></if></if_stmt>
	<expr_stmt pos:start="1882:9" pos:end="1882:16"><expr pos:start="1882:9" pos:end="1882:15"><name pos:start="1882:9" pos:end="1882:13">first</name><operator pos:start="1882:14" pos:end="1882:15">++</operator></expr>;</expr_stmt>
	<expr_stmt pos:start="1883:9" pos:end="1883:17"><expr pos:start="1883:9" pos:end="1883:16"><name pos:start="1883:9" pos:end="1883:14">second</name><operator pos:start="1883:15" pos:end="1883:16">++</operator></expr>;</expr_stmt>
    </block_content>}</block></while>
    <comment type="block" pos:start="1885:5" pos:end="1887:43">/* we do the comparison here (possibly again), just to make sure that if the
       loop above is skipped because one of the strings reached zero, we must not
       return this as a successful match */</comment>
    <return pos:start="1888:5" pos:end="1888:89">return <expr pos:start="1888:12" pos:end="1888:88"><operator pos:start="1888:12" pos:end="1888:12">(</operator><call pos:start="1888:13" pos:end="1888:47"><name pos:start="1888:13" pos:end="1888:39">est_client_Curl_raw_toupper</name><argument_list pos:start="1888:40" pos:end="1888:47">(<argument pos:start="1888:41" pos:end="1888:46"><expr pos:start="1888:41" pos:end="1888:46"><operator pos:start="1888:41" pos:end="1888:41">*</operator><name pos:start="1888:42" pos:end="1888:46">first</name></expr></argument>)</argument_list></call> <operator pos:start="1888:49" pos:end="1888:50">==</operator> <call pos:start="1888:52" pos:end="1888:87"><name pos:start="1888:52" pos:end="1888:78">est_client_Curl_raw_toupper</name><argument_list pos:start="1888:79" pos:end="1888:87">(<argument pos:start="1888:80" pos:end="1888:86"><expr pos:start="1888:80" pos:end="1888:86"><operator pos:start="1888:80" pos:end="1888:80">*</operator><name pos:start="1888:81" pos:end="1888:86">second</name></expr></argument>)</argument_list></call><operator pos:start="1888:88" pos:end="1888:88">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="1890:1" pos:end="1900:3">/*
 * The following function was taken from cURL
 *
 * Curl_raw_equal() is for doing "raw" case insensitive strings. This is meant
 * to be locale independent and only compare strings we know are safe for
 * this.  See http://daniel.haxx.se/blog/2008/10/15/strcasecmp-in-turkish/ for
 * some further explanation to why this function is necessary.
 *
 * The function is capable of comparing a-z case insensitively even for
 * non-ascii.
 */</comment>
<function pos:start="1901:1" pos:end="1916:1"><type pos:start="1901:1" pos:end="1901:10"><specifier pos:start="1901:1" pos:end="1901:6">static</specifier> <name pos:start="1901:8" pos:end="1901:10">int</name></type> <name pos:start="1901:12" pos:end="1901:37">est_client_Curl_raw_nequal</name><parameter_list pos:start="1901:38" pos:end="1901:88">(<parameter pos:start="1901:39" pos:end="1901:55"><decl pos:start="1901:39" pos:end="1901:55"><type pos:start="1901:39" pos:end="1901:55"><specifier pos:start="1901:39" pos:end="1901:43">const</specifier> <name pos:start="1901:45" pos:end="1901:48">char</name> <modifier pos:start="1901:50" pos:end="1901:50">*</modifier></type><name pos:start="1901:51" pos:end="1901:55">first</name></decl></parameter>, <parameter pos:start="1901:58" pos:end="1901:75"><decl pos:start="1901:58" pos:end="1901:75"><type pos:start="1901:58" pos:end="1901:75"><specifier pos:start="1901:58" pos:end="1901:62">const</specifier> <name pos:start="1901:64" pos:end="1901:67">char</name> <modifier pos:start="1901:69" pos:end="1901:69">*</modifier></type><name pos:start="1901:70" pos:end="1901:75">second</name></decl></parameter>, <parameter pos:start="1901:78" pos:end="1901:87"><decl pos:start="1901:78" pos:end="1901:87"><type pos:start="1901:78" pos:end="1901:87"><name pos:start="1901:78" pos:end="1901:83">size_t</name></type> <name pos:start="1901:85" pos:end="1901:87">max</name></decl></parameter>)</parameter_list>
<block pos:start="1902:1" pos:end="1916:1">{<block_content pos:start="1903:5" pos:end="1915:89">
    <while pos:start="1903:5" pos:end="1910:5">while<condition pos:start="1903:10" pos:end="1903:35">(<expr pos:start="1903:11" pos:end="1903:34"><operator pos:start="1903:11" pos:end="1903:11">*</operator><name pos:start="1903:12" pos:end="1903:16">first</name> <operator pos:start="1903:18" pos:end="1903:19">&amp;&amp;</operator> <operator pos:start="1903:21" pos:end="1903:21">*</operator><name pos:start="1903:22" pos:end="1903:27">second</name> <operator pos:start="1903:29" pos:end="1903:30">&amp;&amp;</operator> <name pos:start="1903:32" pos:end="1903:34">max</name></expr>)</condition> <block pos:start="1903:37" pos:end="1910:5">{<block_content pos:start="1904:9" pos:end="1909:17">
	<if_stmt pos:start="1904:9" pos:end="1906:9"><if pos:start="1904:9" pos:end="1906:9">if<condition pos:start="1904:11" pos:end="1904:87">(<expr pos:start="1904:12" pos:end="1904:86"><call pos:start="1904:12" pos:end="1904:46"><name pos:start="1904:12" pos:end="1904:38">est_client_Curl_raw_toupper</name><argument_list pos:start="1904:39" pos:end="1904:46">(<argument pos:start="1904:40" pos:end="1904:45"><expr pos:start="1904:40" pos:end="1904:45"><operator pos:start="1904:40" pos:end="1904:40">*</operator><name pos:start="1904:41" pos:end="1904:45">first</name></expr></argument>)</argument_list></call> <operator pos:start="1904:48" pos:end="1904:49">!=</operator> <call pos:start="1904:51" pos:end="1904:86"><name pos:start="1904:51" pos:end="1904:77">est_client_Curl_raw_toupper</name><argument_list pos:start="1904:78" pos:end="1904:86">(<argument pos:start="1904:79" pos:end="1904:85"><expr pos:start="1904:79" pos:end="1904:85"><operator pos:start="1904:79" pos:end="1904:79">*</operator><name pos:start="1904:80" pos:end="1904:85">second</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="1904:89" pos:end="1906:9">{<block_content pos:start="1905:13" pos:end="1905:18">
	    <break pos:start="1905:13" pos:end="1905:18">break;</break>
	</block_content>}</block></if></if_stmt>
	<expr_stmt pos:start="1907:9" pos:end="1907:14"><expr pos:start="1907:9" pos:end="1907:13"><name pos:start="1907:9" pos:end="1907:11">max</name><operator pos:start="1907:12" pos:end="1907:13">--</operator></expr>;</expr_stmt>
	<expr_stmt pos:start="1908:9" pos:end="1908:16"><expr pos:start="1908:9" pos:end="1908:15"><name pos:start="1908:9" pos:end="1908:13">first</name><operator pos:start="1908:14" pos:end="1908:15">++</operator></expr>;</expr_stmt>
	<expr_stmt pos:start="1909:9" pos:end="1909:17"><expr pos:start="1909:9" pos:end="1909:16"><name pos:start="1909:9" pos:end="1909:14">second</name><operator pos:start="1909:15" pos:end="1909:16">++</operator></expr>;</expr_stmt>
    </block_content>}</block></while>
    <if_stmt pos:start="1911:5" pos:end="1913:5"><if pos:start="1911:5" pos:end="1913:5">if<condition pos:start="1911:7" pos:end="1911:16">(<expr pos:start="1911:8" pos:end="1911:15"><literal type="number" pos:start="1911:8" pos:end="1911:8">0</literal> <operator pos:start="1911:10" pos:end="1911:11">==</operator> <name pos:start="1911:13" pos:end="1911:15">max</name></expr>)</condition> <block pos:start="1911:18" pos:end="1913:5">{<block_content pos:start="1912:9" pos:end="1912:17">
	<return pos:start="1912:9" pos:end="1912:17">return <expr pos:start="1912:16" pos:end="1912:16"><literal type="number" pos:start="1912:16" pos:end="1912:16">1</literal></expr>;</return> <comment type="block" pos:start="1912:19" pos:end="1912:47">/* they are equal this far */</comment>
    </block_content>}</block></if></if_stmt>

    <return pos:start="1915:5" pos:end="1915:89">return <expr pos:start="1915:12" pos:end="1915:88"><operator pos:start="1915:12" pos:end="1915:12">(</operator><call pos:start="1915:13" pos:end="1915:47"><name pos:start="1915:13" pos:end="1915:39">est_client_Curl_raw_toupper</name><argument_list pos:start="1915:40" pos:end="1915:47">(<argument pos:start="1915:41" pos:end="1915:46"><expr pos:start="1915:41" pos:end="1915:46"><operator pos:start="1915:41" pos:end="1915:41">*</operator><name pos:start="1915:42" pos:end="1915:46">first</name></expr></argument>)</argument_list></call> <operator pos:start="1915:49" pos:end="1915:50">==</operator> <call pos:start="1915:52" pos:end="1915:87"><name pos:start="1915:52" pos:end="1915:78">est_client_Curl_raw_toupper</name><argument_list pos:start="1915:79" pos:end="1915:87">(<argument pos:start="1915:80" pos:end="1915:86"><expr pos:start="1915:80" pos:end="1915:86"><operator pos:start="1915:80" pos:end="1915:80">*</operator><name pos:start="1915:81" pos:end="1915:86">second</name></expr></argument>)</argument_list></call><operator pos:start="1915:88" pos:end="1915:88">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="1917:1" pos:end="1927:3">/*
 * The following function was taken from cURL
 *
 * Curl_raw_equal() is for doing "raw" case insensitive strings. This is meant
 * to be locale independent and only compare strings we know are safe for
 * this.  See http://daniel.haxx.se/blog/2008/10/15/strcasecmp-in-turkish/ for
 * some further explanation to why this function is necessary.
 *
 * The function is capable of comparing a-z case insensitively even for
 * non-ascii.
 */</comment>
<function pos:start="1928:1" pos:end="1974:1"><type pos:start="1928:1" pos:end="1928:10"><specifier pos:start="1928:1" pos:end="1928:6">static</specifier> <name pos:start="1928:8" pos:end="1928:10">int</name></type> <name pos:start="1928:12" pos:end="1928:31">est_client_hostmatch</name><parameter_list pos:start="1928:32" pos:end="1928:74">(<parameter pos:start="1928:33" pos:end="1928:52"><decl pos:start="1928:33" pos:end="1928:52"><type pos:start="1928:33" pos:end="1928:52"><specifier pos:start="1928:33" pos:end="1928:37">const</specifier> <name pos:start="1928:39" pos:end="1928:42">char</name> <modifier pos:start="1928:44" pos:end="1928:44">*</modifier></type><name pos:start="1928:45" pos:end="1928:52">hostname</name></decl></parameter>, <parameter pos:start="1928:55" pos:end="1928:73"><decl pos:start="1928:55" pos:end="1928:73"><type pos:start="1928:55" pos:end="1928:73"><specifier pos:start="1928:55" pos:end="1928:59">const</specifier> <name pos:start="1928:61" pos:end="1928:64">char</name> <modifier pos:start="1928:66" pos:end="1928:66">*</modifier></type><name pos:start="1928:67" pos:end="1928:73">pattern</name></decl></parameter>)</parameter_list>
<block pos:start="1929:1" pos:end="1974:1">{<block_content pos:start="1930:5" pos:end="1973:80">
    <decl_stmt pos:start="1930:5" pos:end="1930:74"><decl pos:start="1930:5" pos:end="1930:33"><type pos:start="1930:5" pos:end="1930:16"><specifier pos:start="1930:5" pos:end="1930:9">const</specifier> <name pos:start="1930:11" pos:end="1930:14">char</name> <modifier pos:start="1930:16" pos:end="1930:16">*</modifier></type><name pos:start="1930:17" pos:end="1930:33">pattern_label_end</name></decl>, <decl pos:start="1930:36" pos:end="1930:52"><type ref="prev" pos:start="1930:5" pos:end="1930:16"><modifier pos:start="1930:36" pos:end="1930:36">*</modifier></type><name pos:start="1930:37" pos:end="1930:52">pattern_wildcard</name></decl>, <decl pos:start="1930:55" pos:end="1930:73"><type ref="prev" pos:start="1930:5" pos:end="1930:16"><modifier pos:start="1930:55" pos:end="1930:55">*</modifier></type><name pos:start="1930:56" pos:end="1930:73">hostname_label_end</name></decl>;</decl_stmt>
    <decl_stmt pos:start="1931:5" pos:end="1931:25"><decl pos:start="1931:5" pos:end="1931:24"><type pos:start="1931:5" pos:end="1931:7"><name pos:start="1931:5" pos:end="1931:7">int</name></type> <name pos:start="1931:9" pos:end="1931:24">wildcard_enabled</name></decl>;</decl_stmt>
    <decl_stmt pos:start="1932:5" pos:end="1932:32"><decl pos:start="1932:5" pos:end="1932:20"><type pos:start="1932:5" pos:end="1932:10"><name pos:start="1932:5" pos:end="1932:10">size_t</name></type> <name pos:start="1932:12" pos:end="1932:20">prefixlen</name></decl>, <decl pos:start="1932:23" pos:end="1932:31"><type ref="prev" pos:start="1932:5" pos:end="1932:10"/><name pos:start="1932:23" pos:end="1932:31">suffixlen</name></decl>;</decl_stmt>
    <decl_stmt pos:start="1933:5" pos:end="1933:27"><decl pos:start="1933:5" pos:end="1933:26"><type pos:start="1933:5" pos:end="1933:18"><name pos:start="1933:5" pos:end="1933:18"><name pos:start="1933:5" pos:end="1933:10">struct</name> <name pos:start="1933:12" pos:end="1933:18">in_addr</name></name></type> <name pos:start="1933:20" pos:end="1933:26">ignored</name></decl>;</decl_stmt>
    <decl_stmt pos:start="1934:5" pos:end="1934:28"><decl pos:start="1934:5" pos:end="1934:27"><type pos:start="1934:5" pos:end="1934:23"><name pos:start="1934:5" pos:end="1934:23"><name pos:start="1934:5" pos:end="1934:10">struct</name> <name pos:start="1934:12" pos:end="1934:23">sockaddr_in6</name></name></type> <name pos:start="1934:25" pos:end="1934:27">si6</name></decl>;</decl_stmt>

    <expr_stmt pos:start="1936:5" pos:end="1936:44"><expr pos:start="1936:5" pos:end="1936:43"><name pos:start="1936:5" pos:end="1936:20">pattern_wildcard</name> <operator pos:start="1936:22" pos:end="1936:22">=</operator> <call pos:start="1936:24" pos:end="1936:43"><name pos:start="1936:24" pos:end="1936:29">strchr</name><argument_list pos:start="1936:30" pos:end="1936:43">(<argument pos:start="1936:31" pos:end="1936:37"><expr pos:start="1936:31" pos:end="1936:37"><name pos:start="1936:31" pos:end="1936:37">pattern</name></expr></argument>, <argument pos:start="1936:40" pos:end="1936:42"><expr pos:start="1936:40" pos:end="1936:42"><literal type="char" pos:start="1936:40" pos:end="1936:42">'*'</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1937:5" pos:end="1939:5"><if pos:start="1937:5" pos:end="1939:5">if<condition pos:start="1937:7" pos:end="1937:32">(<expr pos:start="1937:8" pos:end="1937:31"><name pos:start="1937:8" pos:end="1937:23">pattern_wildcard</name> <operator pos:start="1937:25" pos:end="1937:26">==</operator> <name pos:start="1937:28" pos:end="1937:31">NULL</name></expr>)</condition> <block pos:start="1937:34" pos:end="1939:5">{<block_content pos:start="1938:9" pos:end="1938:88">
	<return pos:start="1938:9" pos:end="1938:88">return <expr pos:start="1938:16" pos:end="1938:87"><ternary pos:start="1938:16" pos:end="1938:87"><condition pos:start="1938:16" pos:end="1938:61"><expr pos:start="1938:16" pos:end="1938:59"><call pos:start="1938:16" pos:end="1938:59"><name pos:start="1938:16" pos:end="1938:40">est_client_Curl_raw_equal</name><argument_list pos:start="1938:41" pos:end="1938:59">(<argument pos:start="1938:42" pos:end="1938:48"><expr pos:start="1938:42" pos:end="1938:48"><name pos:start="1938:42" pos:end="1938:48">pattern</name></expr></argument>, <argument pos:start="1938:51" pos:end="1938:58"><expr pos:start="1938:51" pos:end="1938:58"><name pos:start="1938:51" pos:end="1938:58">hostname</name></expr></argument>)</argument_list></call></expr> ?</condition><then pos:start="1938:63" pos:end="1938:72"> <expr pos:start="1938:63" pos:end="1938:72"><name pos:start="1938:63" pos:end="1938:72">HOST_MATCH</name></expr> </then><else pos:start="1938:74" pos:end="1938:87">: <expr pos:start="1938:76" pos:end="1938:87"><name pos:start="1938:76" pos:end="1938:87">HOST_NOMATCH</name></expr></else></ternary></expr>;</return>
    </block_content>}</block></if></if_stmt>
    
    <comment type="block" pos:start="1941:5" pos:end="1941:64">/* detect IP address as hostname and fail the match if so */</comment>
    <if_stmt pos:start="1942:5" pos:end="1945:28"><if pos:start="1942:5" pos:end="1943:28">if<condition pos:start="1942:7" pos:end="1942:50">(<expr pos:start="1942:8" pos:end="1942:49"><call pos:start="1942:8" pos:end="1942:45"><name pos:start="1942:8" pos:end="1942:16">inet_pton</name><argument_list pos:start="1942:17" pos:end="1942:45">(<argument pos:start="1942:18" pos:end="1942:24"><expr pos:start="1942:18" pos:end="1942:24"><name pos:start="1942:18" pos:end="1942:24">AF_INET</name></expr></argument>, <argument pos:start="1942:27" pos:end="1942:34"><expr pos:start="1942:27" pos:end="1942:34"><name pos:start="1942:27" pos:end="1942:34">hostname</name></expr></argument>, <argument pos:start="1942:37" pos:end="1942:44"><expr pos:start="1942:37" pos:end="1942:44"><operator pos:start="1942:37" pos:end="1942:37">&amp;</operator><name pos:start="1942:38" pos:end="1942:44">ignored</name></expr></argument>)</argument_list></call> <operator pos:start="1942:47" pos:end="1942:47">&gt;</operator> <literal type="number" pos:start="1942:49" pos:end="1942:49">0</literal></expr>)</condition><block type="pseudo" pos:start="1943:9" pos:end="1943:28"><block_content pos:start="1943:9" pos:end="1943:28">
        <return pos:start="1943:9" pos:end="1943:28">return <expr pos:start="1943:16" pos:end="1943:27"><name pos:start="1943:16" pos:end="1943:27">HOST_NOMATCH</name></expr>;</return></block_content></block></if>
    <if type="elseif" pos:start="1944:5" pos:end="1945:28">else if<condition pos:start="1944:12" pos:end="1944:62">(<expr pos:start="1944:13" pos:end="1944:61"><call pos:start="1944:13" pos:end="1944:57"><name pos:start="1944:13" pos:end="1944:21">inet_pton</name><argument_list pos:start="1944:22" pos:end="1944:57">(<argument pos:start="1944:23" pos:end="1944:30"><expr pos:start="1944:23" pos:end="1944:30"><name pos:start="1944:23" pos:end="1944:30">AF_INET6</name></expr></argument>, <argument pos:start="1944:33" pos:end="1944:40"><expr pos:start="1944:33" pos:end="1944:40"><name pos:start="1944:33" pos:end="1944:40">hostname</name></expr></argument>, <argument pos:start="1944:43" pos:end="1944:56"><expr pos:start="1944:43" pos:end="1944:56"><operator pos:start="1944:43" pos:end="1944:43">&amp;</operator><name pos:start="1944:44" pos:end="1944:56"><name pos:start="1944:44" pos:end="1944:46">si6</name><operator pos:start="1944:47" pos:end="1944:47">.</operator><name pos:start="1944:48" pos:end="1944:56">sin6_addr</name></name></expr></argument>)</argument_list></call> <operator pos:start="1944:59" pos:end="1944:59">&gt;</operator> <literal type="number" pos:start="1944:61" pos:end="1944:61">0</literal></expr>)</condition><block type="pseudo" pos:start="1945:9" pos:end="1945:28"><block_content pos:start="1945:9" pos:end="1945:28">
        <return pos:start="1945:9" pos:end="1945:28">return <expr pos:start="1945:16" pos:end="1945:27"><name pos:start="1945:16" pos:end="1945:27">HOST_NOMATCH</name></expr>;</return></block_content></block></if></if_stmt>

    <comment type="block" pos:start="1947:5" pos:end="1948:16">/* We require at least 2 dots in pattern to avoid too wide wildcard
       match. */</comment>
    <expr_stmt pos:start="1949:5" pos:end="1949:25"><expr pos:start="1949:5" pos:end="1949:24"><name pos:start="1949:5" pos:end="1949:20">wildcard_enabled</name> <operator pos:start="1949:22" pos:end="1949:22">=</operator> <literal type="number" pos:start="1949:24" pos:end="1949:24">1</literal></expr>;</expr_stmt>
    <expr_stmt pos:start="1950:5" pos:end="1950:45"><expr pos:start="1950:5" pos:end="1950:44"><name pos:start="1950:5" pos:end="1950:21">pattern_label_end</name> <operator pos:start="1950:23" pos:end="1950:23">=</operator> <call pos:start="1950:25" pos:end="1950:44"><name pos:start="1950:25" pos:end="1950:30">strchr</name><argument_list pos:start="1950:31" pos:end="1950:44">(<argument pos:start="1950:32" pos:end="1950:38"><expr pos:start="1950:32" pos:end="1950:38"><name pos:start="1950:32" pos:end="1950:38">pattern</name></expr></argument>, <argument pos:start="1950:41" pos:end="1950:43"><expr pos:start="1950:41" pos:end="1950:43"><literal type="char" pos:start="1950:41" pos:end="1950:43">'.'</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1951:5" pos:end="1955:5"><if pos:start="1951:5" pos:end="1955:5">if<condition pos:start="1951:7" pos:end="1953:55">(<expr pos:start="1951:8" pos:end="1953:54"><name pos:start="1951:8" pos:end="1951:24">pattern_label_end</name> <operator pos:start="1951:26" pos:end="1951:27">==</operator> <name pos:start="1951:29" pos:end="1951:32">NULL</name> <operator pos:start="1951:34" pos:end="1951:35">||</operator> <call pos:start="1951:37" pos:end="1951:68"><name pos:start="1951:37" pos:end="1951:42">strchr</name><argument_list pos:start="1951:43" pos:end="1951:68">(<argument pos:start="1951:44" pos:end="1951:62"><expr pos:start="1951:44" pos:end="1951:62"><name pos:start="1951:44" pos:end="1951:60">pattern_label_end</name><operator pos:start="1951:61" pos:end="1951:61">+</operator><literal type="number" pos:start="1951:62" pos:end="1951:62">1</literal></expr></argument>, <argument pos:start="1951:65" pos:end="1951:67"><expr pos:start="1951:65" pos:end="1951:67"><literal type="char" pos:start="1951:65" pos:end="1951:67">'.'</literal></expr></argument>)</argument_list></call> <operator pos:start="1951:70" pos:end="1951:71">==</operator> <name pos:start="1951:73" pos:end="1951:76">NULL</name> <operator pos:start="1951:78" pos:end="1951:79">||</operator>
	<name pos:start="1952:9" pos:end="1952:24">pattern_wildcard</name> <operator pos:start="1952:26" pos:end="1952:26">&gt;</operator> <name pos:start="1952:28" pos:end="1952:44">pattern_label_end</name> <operator pos:start="1952:46" pos:end="1952:47">||</operator>
	<call pos:start="1953:9" pos:end="1953:54"><name pos:start="1953:9" pos:end="1953:34">est_client_Curl_raw_nequal</name><argument_list pos:start="1953:35" pos:end="1953:54">(<argument pos:start="1953:36" pos:end="1953:42"><expr pos:start="1953:36" pos:end="1953:42"><name pos:start="1953:36" pos:end="1953:42">pattern</name></expr></argument>, <argument pos:start="1953:45" pos:end="1953:50"><expr pos:start="1953:45" pos:end="1953:50"><literal type="string" pos:start="1953:45" pos:end="1953:50">"xn--"</literal></expr></argument>, <argument pos:start="1953:53" pos:end="1953:53"><expr pos:start="1953:53" pos:end="1953:53"><literal type="number" pos:start="1953:53" pos:end="1953:53">4</literal></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="1953:57" pos:end="1955:5">{<block_content pos:start="1954:9" pos:end="1954:29">
	<expr_stmt pos:start="1954:9" pos:end="1954:29"><expr pos:start="1954:9" pos:end="1954:28"><name pos:start="1954:9" pos:end="1954:24">wildcard_enabled</name> <operator pos:start="1954:26" pos:end="1954:26">=</operator> <literal type="number" pos:start="1954:28" pos:end="1954:28">0</literal></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    <if_stmt pos:start="1956:5" pos:end="1958:5"><if pos:start="1956:5" pos:end="1958:5">if<condition pos:start="1956:7" pos:end="1956:25">(<expr pos:start="1956:8" pos:end="1956:24"><operator pos:start="1956:8" pos:end="1956:8">!</operator><name pos:start="1956:9" pos:end="1956:24">wildcard_enabled</name></expr>)</condition> <block pos:start="1956:27" pos:end="1958:5">{<block_content pos:start="1957:9" pos:end="1957:88">
	<return pos:start="1957:9" pos:end="1957:88">return <expr pos:start="1957:16" pos:end="1957:87"><ternary pos:start="1957:16" pos:end="1957:87"><condition pos:start="1957:16" pos:end="1957:61"><expr pos:start="1957:16" pos:end="1957:59"><call pos:start="1957:16" pos:end="1957:59"><name pos:start="1957:16" pos:end="1957:40">est_client_Curl_raw_equal</name><argument_list pos:start="1957:41" pos:end="1957:59">(<argument pos:start="1957:42" pos:end="1957:48"><expr pos:start="1957:42" pos:end="1957:48"><name pos:start="1957:42" pos:end="1957:48">pattern</name></expr></argument>, <argument pos:start="1957:51" pos:end="1957:58"><expr pos:start="1957:51" pos:end="1957:58"><name pos:start="1957:51" pos:end="1957:58">hostname</name></expr></argument>)</argument_list></call></expr> ?</condition><then pos:start="1957:63" pos:end="1957:72"> <expr pos:start="1957:63" pos:end="1957:72"><name pos:start="1957:63" pos:end="1957:72">HOST_MATCH</name></expr> </then><else pos:start="1957:74" pos:end="1957:87">: <expr pos:start="1957:76" pos:end="1957:87"><name pos:start="1957:76" pos:end="1957:87">HOST_NOMATCH</name></expr></else></ternary></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="1959:5" pos:end="1959:47"><expr pos:start="1959:5" pos:end="1959:46"><name pos:start="1959:5" pos:end="1959:22">hostname_label_end</name> <operator pos:start="1959:24" pos:end="1959:24">=</operator> <call pos:start="1959:26" pos:end="1959:46"><name pos:start="1959:26" pos:end="1959:31">strchr</name><argument_list pos:start="1959:32" pos:end="1959:46">(<argument pos:start="1959:33" pos:end="1959:40"><expr pos:start="1959:33" pos:end="1959:40"><name pos:start="1959:33" pos:end="1959:40">hostname</name></expr></argument>, <argument pos:start="1959:43" pos:end="1959:45"><expr pos:start="1959:43" pos:end="1959:45"><literal type="char" pos:start="1959:43" pos:end="1959:45">'.'</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="1960:5" pos:end="1962:5"><if pos:start="1960:5" pos:end="1962:5">if<condition pos:start="1960:7" pos:end="1960:103">(<expr pos:start="1960:8" pos:end="1960:102"><name pos:start="1960:8" pos:end="1960:25">hostname_label_end</name> <operator pos:start="1960:27" pos:end="1960:28">==</operator> <name pos:start="1960:30" pos:end="1960:33">NULL</name> <operator pos:start="1960:35" pos:end="1960:36">||</operator> <operator pos:start="1960:38" pos:end="1960:38">!</operator><call pos:start="1960:39" pos:end="1960:102"><name pos:start="1960:39" pos:end="1960:63">est_client_Curl_raw_equal</name><argument_list pos:start="1960:64" pos:end="1960:102">(<argument pos:start="1960:65" pos:end="1960:81"><expr pos:start="1960:65" pos:end="1960:81"><name pos:start="1960:65" pos:end="1960:81">pattern_label_end</name></expr></argument>, <argument pos:start="1960:84" pos:end="1960:101"><expr pos:start="1960:84" pos:end="1960:101"><name pos:start="1960:84" pos:end="1960:101">hostname_label_end</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="1960:105" pos:end="1962:5">{<block_content pos:start="1961:9" pos:end="1961:28">
	<return pos:start="1961:9" pos:end="1961:28">return <expr pos:start="1961:16" pos:end="1961:27"><name pos:start="1961:16" pos:end="1961:27">HOST_NOMATCH</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <comment type="block" pos:start="1963:5" pos:end="1965:25">/* The wildcard must match at least one character, so the left-most
       label of the hostname is at least as large as the left-most label
       of the pattern. */</comment>
    <if_stmt pos:start="1966:5" pos:end="1968:5"><if pos:start="1966:5" pos:end="1968:5">if<condition pos:start="1966:7" pos:end="1966:67">(<expr pos:start="1966:8" pos:end="1966:66"><name pos:start="1966:8" pos:end="1966:25">hostname_label_end</name> <operator pos:start="1966:27" pos:end="1966:27">-</operator> <name pos:start="1966:29" pos:end="1966:36">hostname</name> <operator pos:start="1966:38" pos:end="1966:38">&lt;</operator> <name pos:start="1966:40" pos:end="1966:56">pattern_label_end</name> <operator pos:start="1966:58" pos:end="1966:58">-</operator> <name pos:start="1966:60" pos:end="1966:66">pattern</name></expr>)</condition> <block pos:start="1966:69" pos:end="1968:5">{<block_content pos:start="1967:9" pos:end="1967:28">
	<return pos:start="1967:9" pos:end="1967:28">return <expr pos:start="1967:16" pos:end="1967:27"><name pos:start="1967:16" pos:end="1967:27">HOST_NOMATCH</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="1969:5" pos:end="1969:43"><expr pos:start="1969:5" pos:end="1969:42"><name pos:start="1969:5" pos:end="1969:13">prefixlen</name> <operator pos:start="1969:15" pos:end="1969:15">=</operator> <name pos:start="1969:17" pos:end="1969:32">pattern_wildcard</name> <operator pos:start="1969:34" pos:end="1969:34">-</operator> <name pos:start="1969:36" pos:end="1969:42">pattern</name></expr>;</expr_stmt>
    <expr_stmt pos:start="1970:5" pos:end="1970:57"><expr pos:start="1970:5" pos:end="1970:56"><name pos:start="1970:5" pos:end="1970:13">suffixlen</name> <operator pos:start="1970:15" pos:end="1970:15">=</operator> <name pos:start="1970:17" pos:end="1970:33">pattern_label_end</name> <operator pos:start="1970:35" pos:end="1970:35">-</operator> <operator pos:start="1970:37" pos:end="1970:37">(</operator><name pos:start="1970:38" pos:end="1970:53">pattern_wildcard</name><operator pos:start="1970:54" pos:end="1970:54">+</operator><literal type="number" pos:start="1970:55" pos:end="1970:55">1</literal><operator pos:start="1970:56" pos:end="1970:56">)</operator></expr>;</expr_stmt>
    <return pos:start="1971:5" pos:end="1973:80">return <expr pos:start="1971:12" pos:end="1973:79"><operator pos:start="1971:12" pos:end="1971:12">(</operator><ternary pos:start="1971:13" pos:end="1973:78"><condition pos:start="1971:13" pos:end="1973:51"><expr pos:start="1971:13" pos:end="1973:49"><call pos:start="1971:13" pos:end="1971:68"><name pos:start="1971:13" pos:end="1971:38">est_client_Curl_raw_nequal</name><argument_list pos:start="1971:39" pos:end="1971:68">(<argument pos:start="1971:40" pos:end="1971:46"><expr pos:start="1971:40" pos:end="1971:46"><name pos:start="1971:40" pos:end="1971:46">pattern</name></expr></argument>, <argument pos:start="1971:49" pos:end="1971:56"><expr pos:start="1971:49" pos:end="1971:56"><name pos:start="1971:49" pos:end="1971:56">hostname</name></expr></argument>, <argument pos:start="1971:59" pos:end="1971:67"><expr pos:start="1971:59" pos:end="1971:67"><name pos:start="1971:59" pos:end="1971:67">prefixlen</name></expr></argument>)</argument_list></call> <operator pos:start="1971:70" pos:end="1971:71">&amp;&amp;</operator>
	    <call pos:start="1972:13" pos:end="1973:49"><name pos:start="1972:13" pos:end="1972:38">est_client_Curl_raw_nequal</name><argument_list pos:start="1972:39" pos:end="1973:49">(<argument pos:start="1972:40" pos:end="1972:57"><expr pos:start="1972:40" pos:end="1972:57"><name pos:start="1972:40" pos:end="1972:55">pattern_wildcard</name><operator pos:start="1972:56" pos:end="1972:56">+</operator><literal type="number" pos:start="1972:57" pos:end="1972:57">1</literal></expr></argument>, <argument pos:start="1972:60" pos:end="1972:89"><expr pos:start="1972:60" pos:end="1972:89"><name pos:start="1972:60" pos:end="1972:77">hostname_label_end</name> <operator pos:start="1972:79" pos:end="1972:79">-</operator> <name pos:start="1972:81" pos:end="1972:89">suffixlen</name></expr></argument>,
                                       <argument pos:start="1973:40" pos:end="1973:48"><expr pos:start="1973:40" pos:end="1973:48"><name pos:start="1973:40" pos:end="1973:48">suffixlen</name></expr></argument>)</argument_list></call></expr> ?</condition><then pos:start="1973:54" pos:end="1973:63">  <expr pos:start="1973:54" pos:end="1973:63"><name pos:start="1973:54" pos:end="1973:63">HOST_MATCH</name></expr> </then><else pos:start="1973:65" pos:end="1973:78">: <expr pos:start="1973:67" pos:end="1973:78"><name pos:start="1973:67" pos:end="1973:78">HOST_NOMATCH</name></expr></else></ternary><operator pos:start="1973:79" pos:end="1973:79">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="1975:1" pos:end="1978:3">/*
 * The following function was taken from cURL for the
 * FQDN check on the server cert
 */</comment>
<function pos:start="1979:1" pos:end="1999:1"><type pos:start="1979:1" pos:end="1979:10"><specifier pos:start="1979:1" pos:end="1979:6">static</specifier> <name pos:start="1979:8" pos:end="1979:10">int</name></type> <name pos:start="1979:12" pos:end="1979:36">est_client_cert_hostcheck</name><parameter_list pos:start="1979:37" pos:end="1979:85">(<parameter pos:start="1979:38" pos:end="1979:62"><decl pos:start="1979:38" pos:end="1979:62"><type pos:start="1979:38" pos:end="1979:62"><specifier pos:start="1979:38" pos:end="1979:42">const</specifier> <name pos:start="1979:44" pos:end="1979:47">char</name> <modifier pos:start="1979:49" pos:end="1979:49">*</modifier></type><name pos:start="1979:50" pos:end="1979:62">match_pattern</name></decl></parameter>, <parameter pos:start="1979:65" pos:end="1979:84"><decl pos:start="1979:65" pos:end="1979:84"><type pos:start="1979:65" pos:end="1979:84"><specifier pos:start="1979:65" pos:end="1979:69">const</specifier> <name pos:start="1979:71" pos:end="1979:74">char</name> <modifier pos:start="1979:76" pos:end="1979:76">*</modifier></type><name pos:start="1979:77" pos:end="1979:84">hostname</name></decl></parameter>)</parameter_list>
<block pos:start="1980:1" pos:end="1999:1">{<block_content pos:start="1984:5" pos:end="1998:13">
    <comment type="block" pos:start="1981:5" pos:end="1983:7">/*
     * Sanity check input 
     */</comment>
    <if_stmt pos:start="1984:5" pos:end="1986:5"><if pos:start="1984:5" pos:end="1986:5">if<condition pos:start="1984:7" pos:end="1984:68">(<expr pos:start="1984:8" pos:end="1984:67"><operator pos:start="1984:8" pos:end="1984:8">!</operator><name pos:start="1984:9" pos:end="1984:21">match_pattern</name> <operator pos:start="1984:23" pos:end="1984:24">||</operator> <operator pos:start="1984:26" pos:end="1984:26">!</operator><operator pos:start="1984:27" pos:end="1984:27">*</operator><name pos:start="1984:28" pos:end="1984:40">match_pattern</name> <operator pos:start="1984:42" pos:end="1984:43">||</operator> <operator pos:start="1984:45" pos:end="1984:45">!</operator><name pos:start="1984:46" pos:end="1984:53">hostname</name> <operator pos:start="1984:55" pos:end="1984:56">||</operator> <operator pos:start="1984:58" pos:end="1984:58">!</operator><operator pos:start="1984:59" pos:end="1984:59">*</operator><name pos:start="1984:60" pos:end="1984:67">hostname</name></expr>)</condition> <block pos:start="1984:70" pos:end="1986:5">{<block_content pos:start="1985:9" pos:end="1985:17"> 
	<return pos:start="1985:9" pos:end="1985:17">return <expr pos:start="1985:16" pos:end="1985:16"><literal type="number" pos:start="1985:16" pos:end="1985:16">0</literal></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="1988:5" pos:end="1990:7">/*
     * trival case
     */</comment>
    <if_stmt pos:start="1991:5" pos:end="1993:5"><if pos:start="1991:5" pos:end="1993:5">if<condition pos:start="1991:7" pos:end="1991:58">(<expr pos:start="1991:8" pos:end="1991:57"><call pos:start="1991:8" pos:end="1991:57"><name pos:start="1991:8" pos:end="1991:32">est_client_Curl_raw_equal</name><argument_list pos:start="1991:33" pos:end="1991:57">(<argument pos:start="1991:34" pos:end="1991:41"><expr pos:start="1991:34" pos:end="1991:41"><name pos:start="1991:34" pos:end="1991:41">hostname</name></expr></argument>, <argument pos:start="1991:44" pos:end="1991:56"><expr pos:start="1991:44" pos:end="1991:56"><name pos:start="1991:44" pos:end="1991:56">match_pattern</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="1991:60" pos:end="1993:5">{<block_content pos:start="1992:9" pos:end="1992:17">
	<return pos:start="1992:9" pos:end="1992:17">return <expr pos:start="1992:16" pos:end="1992:16"><literal type="number" pos:start="1992:16" pos:end="1992:16">1</literal></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="1995:5" pos:end="1997:5"><if pos:start="1995:5" pos:end="1997:5">if<condition pos:start="1995:7" pos:end="1995:66">(<expr pos:start="1995:8" pos:end="1995:65"><call pos:start="1995:8" pos:end="1995:51"><name pos:start="1995:8" pos:end="1995:27">est_client_hostmatch</name><argument_list pos:start="1995:28" pos:end="1995:51">(<argument pos:start="1995:29" pos:end="1995:36"><expr pos:start="1995:29" pos:end="1995:36"><name pos:start="1995:29" pos:end="1995:36">hostname</name></expr></argument>,<argument pos:start="1995:38" pos:end="1995:50"><expr pos:start="1995:38" pos:end="1995:50"><name pos:start="1995:38" pos:end="1995:50">match_pattern</name></expr></argument>)</argument_list></call> <operator pos:start="1995:53" pos:end="1995:54">==</operator> <name pos:start="1995:56" pos:end="1995:65">HOST_MATCH</name></expr>)</condition> <block pos:start="1995:68" pos:end="1997:5">{<block_content pos:start="1996:9" pos:end="1996:17">
	<return pos:start="1996:9" pos:end="1996:17">return <expr pos:start="1996:16" pos:end="1996:16"><literal type="number" pos:start="1996:16" pos:end="1996:16">1</literal></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <return pos:start="1998:5" pos:end="1998:13">return <expr pos:start="1998:12" pos:end="1998:12"><literal type="number" pos:start="1998:12" pos:end="1998:12">0</literal></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="2000:1" pos:end="2025:3">/* 
 * This function was taken from cURL and adapted to EST.
 *
 * cURL file name is ./lib/ssluse.c, function: verifyhost()
 *
 * Quote from RFC2818 section 3.1 "Server Identity"

   If a subjectAltName extension of type dNSName is present, that MUST
   be used as the identity. Otherwise, the (most specific) Common Name
   field in the Subject field of the certificate MUST be used. Although
   the use of the Common Name is existing practice, it is deprecated and
   Certification Authorities are encouraged to use the dNSName instead.

   Matching is performed using the matching rules specified by
   [RFC2459].  If more than one identity of a given type is present in
   the certificate (e.g., more than one dNSName name, a match in any one
   of the set is considered acceptable.) Names may contain the wildcard
   character * which is considered to match any single domain name
   component or component fragment. E.g., *.a.com matches foo.a.com but
   not bar.foo.a.com. f*.com matches foo.com but not bar.com.

   In some cases, the URI is specified as an IP address rather than a
   hostname. In this case, the iPAddress subjectAltName must be present
   in the certificate and must exactly match the IP in the URI.

 */</comment>
<function pos:start="2026:1" pos:end="2241:1"><type pos:start="2026:1" pos:end="2026:16"><specifier pos:start="2026:1" pos:end="2026:6">static</specifier> <name pos:start="2026:8" pos:end="2026:16">EST_ERROR</name></type> <name pos:start="2026:18" pos:end="2026:38">est_client_verifyhost</name> <parameter_list pos:start="2026:40" pos:end="2026:74">(<parameter pos:start="2026:41" pos:end="2026:54"><decl pos:start="2026:41" pos:end="2026:54"><type pos:start="2026:41" pos:end="2026:54"><name pos:start="2026:41" pos:end="2026:44">char</name> <modifier pos:start="2026:46" pos:end="2026:46">*</modifier></type><name pos:start="2026:47" pos:end="2026:54">hostname</name></decl></parameter>, <parameter pos:start="2026:57" pos:end="2026:73"><decl pos:start="2026:57" pos:end="2026:73"><type pos:start="2026:57" pos:end="2026:73"><name pos:start="2026:57" pos:end="2026:60">X509</name> <modifier pos:start="2026:62" pos:end="2026:62">*</modifier></type><name pos:start="2026:63" pos:end="2026:73">server_cert</name></decl></parameter>)</parameter_list>
<block pos:start="2027:1" pos:end="2241:1">{<block_content pos:start="2028:5" pos:end="2240:15">
    <decl_stmt pos:start="2028:5" pos:end="2028:21"><decl pos:start="2028:5" pos:end="2028:20"><type pos:start="2028:5" pos:end="2028:7"><name pos:start="2028:5" pos:end="2028:7">int</name></type> <name pos:start="2028:9" pos:end="2028:15">matched</name> <init pos:start="2028:17" pos:end="2028:20">= <expr pos:start="2028:19" pos:end="2028:20"><operator pos:start="2028:19" pos:end="2028:19">-</operator><literal type="number" pos:start="2028:20" pos:end="2028:20">1</literal></expr></init></decl>;</decl_stmt>     <comment type="block" pos:start="2028:27" pos:end="2029:46">/* -1 is no alternative match yet, 1 means match and 0
                             means mismatch */</comment>
    <decl_stmt pos:start="2030:5" pos:end="2030:23"><decl pos:start="2030:5" pos:end="2030:22"><type pos:start="2030:5" pos:end="2030:10"><name pos:start="2030:5" pos:end="2030:10">size_t</name></type> <name pos:start="2030:12" pos:end="2030:18">addrlen</name> <init pos:start="2030:20" pos:end="2030:22">= <expr pos:start="2030:22" pos:end="2030:22"><literal type="number" pos:start="2030:22" pos:end="2030:22">0</literal></expr></init></decl>;</decl_stmt>
    <expr_stmt pos:start="2031:5" pos:end="2031:38"><expr pos:start="2031:5" pos:end="2031:37"><call pos:start="2031:5" pos:end="2031:26"><name pos:start="2031:5" pos:end="2031:12">STACK_OF</name><argument_list pos:start="2031:13" pos:end="2031:26">(<argument pos:start="2031:14" pos:end="2031:25"><expr pos:start="2031:14" pos:end="2031:25"><name pos:start="2031:14" pos:end="2031:25">GENERAL_NAME</name></expr></argument>)</argument_list></call> <operator pos:start="2031:28" pos:end="2031:28">*</operator> <name pos:start="2031:30" pos:end="2031:37">altnames</name></expr>;</expr_stmt>
    <decl_stmt pos:start="2032:5" pos:end="2032:28"><decl pos:start="2032:5" pos:end="2032:27"><type pos:start="2032:5" pos:end="2032:19"><name pos:start="2032:5" pos:end="2032:19"><name pos:start="2032:5" pos:end="2032:10">struct</name> <name pos:start="2032:12" pos:end="2032:19">in6_addr</name></name></type> <name pos:start="2032:21" pos:end="2032:27">addr_v6</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2033:5" pos:end="2033:27"><decl pos:start="2033:5" pos:end="2033:26"><type pos:start="2033:5" pos:end="2033:18"><name pos:start="2033:5" pos:end="2033:18"><name pos:start="2033:5" pos:end="2033:10">struct</name> <name pos:start="2033:12" pos:end="2033:18">in_addr</name></name></type> <name pos:start="2033:20" pos:end="2033:26">addr_v4</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2034:5" pos:end="2034:23"><decl pos:start="2034:5" pos:end="2034:22"><type pos:start="2034:5" pos:end="2034:7"><name pos:start="2034:5" pos:end="2034:7">int</name></type> <name pos:start="2034:9" pos:end="2034:18">addr_is_v4</name> <init pos:start="2034:20" pos:end="2034:22">= <expr pos:start="2034:22" pos:end="2034:22"><literal type="number" pos:start="2034:22" pos:end="2034:22">0</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="2035:5" pos:end="2035:23"><decl pos:start="2035:5" pos:end="2035:22"><type pos:start="2035:5" pos:end="2035:7"><name pos:start="2035:5" pos:end="2035:7">int</name></type> <name pos:start="2035:9" pos:end="2035:18">addr_is_v6</name> <init pos:start="2035:20" pos:end="2035:22">= <expr pos:start="2035:22" pos:end="2035:22"><literal type="number" pos:start="2035:22" pos:end="2035:22">0</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="2036:5" pos:end="2036:33"><decl pos:start="2036:5" pos:end="2036:32"><type pos:start="2036:5" pos:end="2036:13"><name pos:start="2036:5" pos:end="2036:13">EST_ERROR</name></type> <name pos:start="2036:15" pos:end="2036:17">res</name> <init pos:start="2036:19" pos:end="2036:32">= <expr pos:start="2036:21" pos:end="2036:32"><name pos:start="2036:21" pos:end="2036:32">EST_ERR_NONE</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="2037:5" pos:end="2037:11"><decl pos:start="2037:5" pos:end="2037:10"><type pos:start="2037:5" pos:end="2037:7"><name pos:start="2037:5" pos:end="2037:7">int</name></type> <name pos:start="2037:9" pos:end="2037:10">rv</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2038:5" pos:end="2038:21"><decl pos:start="2038:5" pos:end="2038:20"><type pos:start="2038:5" pos:end="2038:11"><name pos:start="2038:5" pos:end="2038:11">errno_t</name></type> <name pos:start="2038:13" pos:end="2038:20">safec_rc</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2039:5" pos:end="2039:16"><decl pos:start="2039:5" pos:end="2039:15"><type pos:start="2039:5" pos:end="2039:7"><name pos:start="2039:5" pos:end="2039:7">int</name></type> <name pos:start="2039:9" pos:end="2039:15">numalts</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2040:5" pos:end="2040:13"><decl pos:start="2040:5" pos:end="2040:9"><type pos:start="2040:5" pos:end="2040:7"><name pos:start="2040:5" pos:end="2040:7">int</name></type> <name pos:start="2040:9" pos:end="2040:9">i</name></decl>, <decl pos:start="2040:12" pos:end="2040:12"><type ref="prev" pos:start="2040:5" pos:end="2040:7"/><name pos:start="2040:12" pos:end="2040:12">j</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2041:5" pos:end="2041:13"><decl pos:start="2041:5" pos:end="2041:12"><type pos:start="2041:5" pos:end="2041:7"><name pos:start="2041:5" pos:end="2041:7">int</name></type> <name pos:start="2041:9" pos:end="2041:12">diff</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2042:5" pos:end="2042:30"><decl pos:start="2042:5" pos:end="2042:29"><type pos:start="2042:5" pos:end="2042:24"><specifier pos:start="2042:5" pos:end="2042:9">const</specifier> <name pos:start="2042:11" pos:end="2042:22">GENERAL_NAME</name> <modifier pos:start="2042:24" pos:end="2042:24">*</modifier></type><name pos:start="2042:25" pos:end="2042:29">check</name></decl>;</decl_stmt> 
    <decl_stmt pos:start="2043:5" pos:end="2043:23"><decl pos:start="2043:5" pos:end="2043:22"><type pos:start="2043:5" pos:end="2043:16"><specifier pos:start="2043:5" pos:end="2043:9">const</specifier> <name pos:start="2043:11" pos:end="2043:14">char</name> <modifier pos:start="2043:16" pos:end="2043:16">*</modifier></type><name pos:start="2043:17" pos:end="2043:22">altptr</name></decl>;</decl_stmt> 
    <decl_stmt pos:start="2044:5" pos:end="2044:18"><decl pos:start="2044:5" pos:end="2044:17"><type pos:start="2044:5" pos:end="2044:10"><name pos:start="2044:5" pos:end="2044:10">size_t</name></type> <name pos:start="2044:12" pos:end="2044:17">altlen</name></decl>;</decl_stmt> 
    <decl_stmt pos:start="2045:5" pos:end="2045:26"><decl pos:start="2045:5" pos:end="2045:25"><type pos:start="2045:5" pos:end="2045:19"><name pos:start="2045:5" pos:end="2045:12">unsigned</name> <name pos:start="2045:14" pos:end="2045:17">char</name> <modifier pos:start="2045:19" pos:end="2045:19">*</modifier></type><name pos:start="2045:20" pos:end="2045:25">nulstr</name></decl>;</decl_stmt> 
    <decl_stmt pos:start="2046:5" pos:end="2046:27"><decl pos:start="2046:5" pos:end="2046:26"><type pos:start="2046:5" pos:end="2046:19"><name pos:start="2046:5" pos:end="2046:12">unsigned</name> <name pos:start="2046:14" pos:end="2046:17">char</name> <modifier pos:start="2046:19" pos:end="2046:19">*</modifier></type><name pos:start="2046:20" pos:end="2046:26">peer_CN</name></decl>;</decl_stmt> 
    <decl_stmt pos:start="2047:5" pos:end="2047:20"><decl pos:start="2047:5" pos:end="2047:19"><type pos:start="2047:5" pos:end="2047:15"><name pos:start="2047:5" pos:end="2047:13">X509_NAME</name> <modifier pos:start="2047:15" pos:end="2047:15">*</modifier></type><name pos:start="2047:16" pos:end="2047:19">name</name></decl>;</decl_stmt> 
    <decl_stmt pos:start="2048:5" pos:end="2048:21"><decl pos:start="2048:5" pos:end="2048:20"><type pos:start="2048:5" pos:end="2048:17"><name pos:start="2048:5" pos:end="2048:15">ASN1_STRING</name> <modifier pos:start="2048:17" pos:end="2048:17">*</modifier></type><name pos:start="2048:18" pos:end="2048:20">tmp</name></decl>;</decl_stmt>

    <comment type="block" pos:start="2050:5" pos:end="2052:7">/*
     * Attempt to resolve host name to v4 address 
     */</comment>
    <expr_stmt pos:start="2053:5" pos:end="2053:48"><expr pos:start="2053:5" pos:end="2053:47"><name pos:start="2053:5" pos:end="2053:6">rv</name> <operator pos:start="2053:8" pos:end="2053:8">=</operator> <call pos:start="2053:10" pos:end="2053:47"><name pos:start="2053:10" pos:end="2053:18">inet_pton</name><argument_list pos:start="2053:19" pos:end="2053:47">(<argument pos:start="2053:20" pos:end="2053:26"><expr pos:start="2053:20" pos:end="2053:26"><name pos:start="2053:20" pos:end="2053:26">AF_INET</name></expr></argument>, <argument pos:start="2053:29" pos:end="2053:36"><expr pos:start="2053:29" pos:end="2053:36"><name pos:start="2053:29" pos:end="2053:36">hostname</name></expr></argument>, <argument pos:start="2053:39" pos:end="2053:46"><expr pos:start="2053:39" pos:end="2053:46"><operator pos:start="2053:39" pos:end="2053:39">&amp;</operator><name pos:start="2053:40" pos:end="2053:46">addr_v4</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2054:5" pos:end="2066:5"><if pos:start="2054:5" pos:end="2057:5">if <condition pos:start="2054:8" pos:end="2054:11">(<expr pos:start="2054:9" pos:end="2054:10"><name pos:start="2054:9" pos:end="2054:10">rv</name></expr>)</condition> <block pos:start="2054:13" pos:end="2057:5">{<block_content pos:start="2055:9" pos:end="2056:41">
	<expr_stmt pos:start="2055:9" pos:end="2055:23"><expr pos:start="2055:9" pos:end="2055:22"><name pos:start="2055:9" pos:end="2055:18">addr_is_v4</name> <operator pos:start="2055:20" pos:end="2055:20">=</operator> <literal type="number" pos:start="2055:22" pos:end="2055:22">1</literal></expr>;</expr_stmt>
        <expr_stmt pos:start="2056:9" pos:end="2056:41"><expr pos:start="2056:9" pos:end="2056:40"><name pos:start="2056:9" pos:end="2056:15">addrlen</name> <operator pos:start="2056:17" pos:end="2056:17">=</operator> <sizeof pos:start="2056:19" pos:end="2056:40">sizeof<argument_list pos:start="2056:25" pos:end="2056:40">(<argument pos:start="2056:26" pos:end="2056:39"><expr pos:start="2056:26" pos:end="2056:39">struct <name pos:start="2056:33" pos:end="2056:39">in_addr</name></expr></argument>)</argument_list></sizeof></expr>;</expr_stmt>
    </block_content>}</block></if> <else pos:start="2057:7" pos:end="2066:5">else <block pos:start="2057:12" pos:end="2066:5">{<block_content pos:start="2061:9" pos:end="2065:9">
	<comment type="block" pos:start="2058:9" pos:end="2060:11">/*
	 * Try to see if hostname resolves to v6 address
	 */</comment>
	<expr_stmt pos:start="2061:9" pos:end="2061:53"><expr pos:start="2061:9" pos:end="2061:52"><name pos:start="2061:9" pos:end="2061:10">rv</name> <operator pos:start="2061:12" pos:end="2061:12">=</operator> <call pos:start="2061:14" pos:end="2061:52"><name pos:start="2061:14" pos:end="2061:22">inet_pton</name><argument_list pos:start="2061:23" pos:end="2061:52">(<argument pos:start="2061:24" pos:end="2061:31"><expr pos:start="2061:24" pos:end="2061:31"><name pos:start="2061:24" pos:end="2061:31">AF_INET6</name></expr></argument>, <argument pos:start="2061:34" pos:end="2061:41"><expr pos:start="2061:34" pos:end="2061:41"><name pos:start="2061:34" pos:end="2061:41">hostname</name></expr></argument>, <argument pos:start="2061:44" pos:end="2061:51"><expr pos:start="2061:44" pos:end="2061:51"><operator pos:start="2061:44" pos:end="2061:44">&amp;</operator><name pos:start="2061:45" pos:end="2061:51">addr_v6</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if_stmt pos:start="2062:9" pos:end="2065:9"><if pos:start="2062:9" pos:end="2065:9">if <condition pos:start="2062:12" pos:end="2062:15">(<expr pos:start="2062:13" pos:end="2062:14"><name pos:start="2062:13" pos:end="2062:14">rv</name></expr>)</condition> <block pos:start="2062:17" pos:end="2065:9">{<block_content pos:start="2063:13" pos:end="2064:46">
	    <expr_stmt pos:start="2063:13" pos:end="2063:27"><expr pos:start="2063:13" pos:end="2063:26"><name pos:start="2063:13" pos:end="2063:22">addr_is_v6</name> <operator pos:start="2063:24" pos:end="2063:24">=</operator> <literal type="number" pos:start="2063:26" pos:end="2063:26">1</literal></expr>;</expr_stmt>
	    <expr_stmt pos:start="2064:13" pos:end="2064:46"><expr pos:start="2064:13" pos:end="2064:45"><name pos:start="2064:13" pos:end="2064:19">addrlen</name> <operator pos:start="2064:21" pos:end="2064:21">=</operator> <sizeof pos:start="2064:23" pos:end="2064:45">sizeof<argument_list pos:start="2064:29" pos:end="2064:45">(<argument pos:start="2064:30" pos:end="2064:44"><expr pos:start="2064:30" pos:end="2064:44">struct <name pos:start="2064:37" pos:end="2064:44">in6_addr</name></expr></argument>)</argument_list></sizeof></expr>;</expr_stmt>
	</block_content>}</block></if></if_stmt>
    </block_content>}</block></else></if_stmt>

    <comment type="block" pos:start="2068:5" pos:end="2068:43">/* get a "list" of alternative names */</comment>
    <expr_stmt pos:start="2069:5" pos:end="2069:79"><expr pos:start="2069:5" pos:end="2069:78"><name pos:start="2069:5" pos:end="2069:12">altnames</name> <operator pos:start="2069:14" pos:end="2069:14">=</operator> <call pos:start="2069:16" pos:end="2069:78"><name pos:start="2069:16" pos:end="2069:31">X509_get_ext_d2i</name><argument_list pos:start="2069:32" pos:end="2069:78">(<argument pos:start="2069:33" pos:end="2069:43"><expr pos:start="2069:33" pos:end="2069:43"><name pos:start="2069:33" pos:end="2069:43">server_cert</name></expr></argument>, <argument pos:start="2069:46" pos:end="2069:65"><expr pos:start="2069:46" pos:end="2069:65"><name pos:start="2069:46" pos:end="2069:65">NID_subject_alt_name</name></expr></argument>, <argument pos:start="2069:68" pos:end="2069:71"><expr pos:start="2069:68" pos:end="2069:71"><name pos:start="2069:68" pos:end="2069:71">NULL</name></expr></argument>, <argument pos:start="2069:74" pos:end="2069:77"><expr pos:start="2069:74" pos:end="2069:77"><name pos:start="2069:74" pos:end="2069:77">NULL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <if_stmt pos:start="2071:5" pos:end="2145:5"><if pos:start="2071:5" pos:end="2145:5">if <condition pos:start="2071:8" pos:end="2071:17">(<expr pos:start="2071:9" pos:end="2071:16"><name pos:start="2071:9" pos:end="2071:16">altnames</name></expr>)</condition> <block pos:start="2071:19" pos:end="2145:5">{<block_content pos:start="2074:9" pos:end="2144:37">
        <comment type="block" pos:start="2072:9" pos:end="2073:47">/* get amount of alternatives, RFC2459 claims there MUST be at least
           one, but we don't depend on it... */</comment>
        <expr_stmt pos:start="2074:9" pos:end="2074:48"><expr pos:start="2074:9" pos:end="2074:47"><name pos:start="2074:9" pos:end="2074:15">numalts</name> <operator pos:start="2074:17" pos:end="2074:17">=</operator> <call pos:start="2074:19" pos:end="2074:47"><name pos:start="2074:19" pos:end="2074:37">sk_GENERAL_NAME_num</name><argument_list pos:start="2074:38" pos:end="2074:47">(<argument pos:start="2074:39" pos:end="2074:46"><expr pos:start="2074:39" pos:end="2074:46"><name pos:start="2074:39" pos:end="2074:46">altnames</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2075:9" pos:end="2075:64"><expr pos:start="2075:9" pos:end="2075:63"><call pos:start="2075:9" pos:end="2075:63"><name pos:start="2075:9" pos:end="2075:20">EST_LOG_INFO</name><argument_list pos:start="2075:21" pos:end="2075:63">(<argument pos:start="2075:22" pos:end="2075:53"><expr pos:start="2075:22" pos:end="2075:53"><literal type="string" pos:start="2075:22" pos:end="2075:53">"Found %d SubjectAlternateNames"</literal></expr></argument>, <argument pos:start="2075:56" pos:end="2075:62"><expr pos:start="2075:56" pos:end="2075:62"><name pos:start="2075:56" pos:end="2075:62">numalts</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

        <comment type="block" pos:start="2077:9" pos:end="2077:66">/* loop through all alternatives while none has matched */</comment>
        <for pos:start="2078:9" pos:end="2143:9">for <control pos:start="2078:13" pos:end="2078:57">(<init pos:start="2078:14" pos:end="2078:19"><expr pos:start="2078:14" pos:end="2078:18"><name pos:start="2078:14" pos:end="2078:14">i</name> <operator pos:start="2078:16" pos:end="2078:16">=</operator> <literal type="number" pos:start="2078:18" pos:end="2078:18">0</literal></expr>;</init> <condition pos:start="2078:21" pos:end="2078:52"><expr pos:start="2078:21" pos:end="2078:51"><operator pos:start="2078:21" pos:end="2078:21">(</operator><name pos:start="2078:22" pos:end="2078:22">i</name> <operator pos:start="2078:24" pos:end="2078:24">&lt;</operator> <name pos:start="2078:26" pos:end="2078:32">numalts</name><operator pos:start="2078:33" pos:end="2078:33">)</operator> <operator pos:start="2078:35" pos:end="2078:36">&amp;&amp;</operator> <operator pos:start="2078:38" pos:end="2078:38">(</operator><name pos:start="2078:39" pos:end="2078:45">matched</name> <operator pos:start="2078:47" pos:end="2078:48">!=</operator> <literal type="number" pos:start="2078:50" pos:end="2078:50">1</literal><operator pos:start="2078:51" pos:end="2078:51">)</operator></expr>;</condition> <incr pos:start="2078:54" pos:end="2078:56"><expr pos:start="2078:54" pos:end="2078:56"><name pos:start="2078:54" pos:end="2078:54">i</name><operator pos:start="2078:55" pos:end="2078:56">++</operator></expr></incr>)</control> <block pos:start="2078:59" pos:end="2143:9">{<block_content pos:start="2080:13" pos:end="2142:13">
            <comment type="block" pos:start="2079:13" pos:end="2079:59">/* get a handle to alternative name number i */</comment>
            <expr_stmt pos:start="2080:13" pos:end="2080:55"><expr pos:start="2080:13" pos:end="2080:54"><name pos:start="2080:13" pos:end="2080:17">check</name> <operator pos:start="2080:19" pos:end="2080:19">=</operator> <call pos:start="2080:21" pos:end="2080:54"><name pos:start="2080:21" pos:end="2080:41">sk_GENERAL_NAME_value</name><argument_list pos:start="2080:42" pos:end="2080:54">(<argument pos:start="2080:43" pos:end="2080:50"><expr pos:start="2080:43" pos:end="2080:50"><name pos:start="2080:43" pos:end="2080:50">altnames</name></expr></argument>, <argument pos:start="2080:53" pos:end="2080:53"><expr pos:start="2080:53" pos:end="2080:53"><name pos:start="2080:53" pos:end="2080:53">i</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

            <comment type="block" pos:start="2082:13" pos:end="2082:37">/* get data and length */</comment>
            <expr_stmt pos:start="2083:13" pos:end="2083:59"><expr pos:start="2083:13" pos:end="2083:58"><name pos:start="2083:13" pos:end="2083:18">altptr</name> <operator pos:start="2083:20" pos:end="2083:20">=</operator> <operator pos:start="2083:22" pos:end="2083:22">(</operator><name pos:start="2083:23" pos:end="2083:26">char</name><operator pos:start="2083:27" pos:end="2083:27">*</operator><operator pos:start="2083:28" pos:end="2083:28">)</operator><call pos:start="2083:29" pos:end="2083:58"><name pos:start="2083:29" pos:end="2083:44">ASN1_STRING_data</name><argument_list pos:start="2083:45" pos:end="2083:58">(<argument pos:start="2083:46" pos:end="2083:57"><expr pos:start="2083:46" pos:end="2083:57"><name pos:start="2083:46" pos:end="2083:57"><name pos:start="2083:46" pos:end="2083:50">check</name><operator pos:start="2083:51" pos:end="2083:52">-&gt;</operator><name pos:start="2083:53" pos:end="2083:53">d</name><operator pos:start="2083:54" pos:end="2083:54">.</operator><name pos:start="2083:55" pos:end="2083:57">ia5</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="2084:13" pos:end="2084:62"><expr pos:start="2084:13" pos:end="2084:61"><name pos:start="2084:13" pos:end="2084:18">altlen</name> <operator pos:start="2084:20" pos:end="2084:20">=</operator> <operator pos:start="2084:22" pos:end="2084:22">(</operator><name pos:start="2084:23" pos:end="2084:28">size_t</name><operator pos:start="2084:29" pos:end="2084:29">)</operator><call pos:start="2084:30" pos:end="2084:61"><name pos:start="2084:30" pos:end="2084:47">ASN1_STRING_length</name><argument_list pos:start="2084:48" pos:end="2084:61">(<argument pos:start="2084:49" pos:end="2084:60"><expr pos:start="2084:49" pos:end="2084:60"><name pos:start="2084:49" pos:end="2084:60"><name pos:start="2084:49" pos:end="2084:53">check</name><operator pos:start="2084:54" pos:end="2084:55">-&gt;</operator><name pos:start="2084:56" pos:end="2084:56">d</name><operator pos:start="2084:57" pos:end="2084:57">.</operator><name pos:start="2084:58" pos:end="2084:60">ia5</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

            <switch pos:start="2086:13" pos:end="2142:13">switch <condition pos:start="2086:20" pos:end="2086:32">(<expr pos:start="2086:21" pos:end="2086:31"><name pos:start="2086:21" pos:end="2086:31"><name pos:start="2086:21" pos:end="2086:25">check</name><operator pos:start="2086:26" pos:end="2086:27">-&gt;</operator><name pos:start="2086:28" pos:end="2086:31">type</name></name></expr>)</condition> <block pos:start="2086:34" pos:end="2142:13">{<block_content pos:start="2087:13" pos:end="2141:22">
            <case pos:start="2087:13" pos:end="2087:25">case <expr pos:start="2087:18" pos:end="2087:24"><name pos:start="2087:18" pos:end="2087:24">GEN_DNS</name></expr>:</case> <comment type="block" pos:start="2087:27" pos:end="2087:55">/* name/pattern comparison */</comment>
                <expr_stmt pos:start="2088:17" pos:end="2088:69"><expr pos:start="2088:17" pos:end="2088:68"><call pos:start="2088:17" pos:end="2088:68"><name pos:start="2088:17" pos:end="2088:28">EST_LOG_INFO</name><argument_list pos:start="2088:29" pos:end="2088:68">(<argument pos:start="2088:30" pos:end="2088:59"><expr pos:start="2088:30" pos:end="2088:59"><literal type="string" pos:start="2088:30" pos:end="2088:59">"Checking FQDN against SAN %s"</literal></expr></argument>, <argument pos:start="2088:62" pos:end="2088:67"><expr pos:start="2088:62" pos:end="2088:67"><name pos:start="2088:62" pos:end="2088:67">altptr</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <comment type="block" pos:start="2089:17" pos:end="2098:19">/* The OpenSSL man page explicitly says: "In general it cannot be
                   assumed that the data returned by ASN1_STRING_data() is null
                   terminated or does not contain embedded nulls." But also that
                   "The actual format of the data will depend on the actual string
                   type itself: for example for and IA5String the data will be ASCII"

                   Gisle researched the OpenSSL sources:
                   "I checked the 0.9.6 and 0.9.8 sources before my patch and
                   it always 0-terminates an IA5String."
                 */</comment>
                <if_stmt pos:start="2099:17" pos:end="2106:17"><if pos:start="2099:17" pos:end="2104:17">if <condition pos:start="2099:20" pos:end="2102:64">(<expr pos:start="2099:21" pos:end="2102:63"><operator pos:start="2099:21" pos:end="2099:21">(</operator><name pos:start="2099:22" pos:end="2099:27">altlen</name> <operator pos:start="2099:29" pos:end="2099:30">==</operator> <call pos:start="2099:32" pos:end="2099:72"><name pos:start="2099:32" pos:end="2099:40">strnlen_s</name><argument_list pos:start="2099:41" pos:end="2099:72">(<argument pos:start="2099:42" pos:end="2099:47"><expr pos:start="2099:42" pos:end="2099:47"><name pos:start="2099:42" pos:end="2099:47">altptr</name></expr></argument>, <argument pos:start="2099:50" pos:end="2099:71"><expr pos:start="2099:50" pos:end="2099:71"><name pos:start="2099:50" pos:end="2099:71">EST_MAX_SERVERNAME_LEN</name></expr></argument>)</argument_list></call><operator pos:start="2099:73" pos:end="2099:73">)</operator> <operator pos:start="2099:75" pos:end="2099:76">&amp;&amp;</operator>
                    <comment type="block" pos:start="2100:21" pos:end="2101:56">/* if this isn't true, there was an embedded zero in the name
                       string and we cannot match it. */</comment>
                    <call pos:start="2102:21" pos:end="2102:63"><name pos:start="2102:21" pos:end="2102:45">est_client_cert_hostcheck</name><argument_list pos:start="2102:46" pos:end="2102:63">(<argument pos:start="2102:47" pos:end="2102:52"><expr pos:start="2102:47" pos:end="2102:52"><name pos:start="2102:47" pos:end="2102:52">altptr</name></expr></argument>, <argument pos:start="2102:55" pos:end="2102:62"><expr pos:start="2102:55" pos:end="2102:62"><name pos:start="2102:55" pos:end="2102:62">hostname</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="2102:66" pos:end="2104:17">{<block_content pos:start="2103:21" pos:end="2103:32">
                    <expr_stmt pos:start="2103:21" pos:end="2103:32"><expr pos:start="2103:21" pos:end="2103:31"><name pos:start="2103:21" pos:end="2103:27">matched</name> <operator pos:start="2103:29" pos:end="2103:29">=</operator> <literal type="number" pos:start="2103:31" pos:end="2103:31">1</literal></expr>;</expr_stmt>
                </block_content>}</block></if> <else pos:start="2104:19" pos:end="2106:17">else<block pos:start="2104:23" pos:end="2106:17">{<block_content pos:start="2105:21" pos:end="2105:32">
                    <expr_stmt pos:start="2105:21" pos:end="2105:32"><expr pos:start="2105:21" pos:end="2105:31"><name pos:start="2105:21" pos:end="2105:27">matched</name> <operator pos:start="2105:29" pos:end="2105:29">=</operator> <literal type="number" pos:start="2105:31" pos:end="2105:31">0</literal></expr>;</expr_stmt>
                </block_content>}</block></else></if_stmt>
                <break pos:start="2107:17" pos:end="2107:22">break;</break>

            <case pos:start="2109:13" pos:end="2109:27">case <expr pos:start="2109:18" pos:end="2109:26"><name pos:start="2109:18" pos:end="2109:26">GEN_IPADD</name></expr>:</case> <comment type="block" pos:start="2109:29" pos:end="2109:55">/* IP address comparison */</comment>
                <comment type="block" pos:start="2110:17" pos:end="2111:46">/* compare alternative IP address if the data chunk is the same size
                   our server IP address is */</comment>

                <comment type="block" pos:start="2113:17" pos:end="2115:19">/*
                 * For PSB compliance, use SafeC library memcmp_s
                 */</comment> 
		
                 <if_stmt pos:start="2117:18" pos:end="2132:18"><if pos:start="2117:18" pos:end="2122:18">if <condition pos:start="2117:21" pos:end="2117:32">(<expr pos:start="2117:22" pos:end="2117:31"><name pos:start="2117:22" pos:end="2117:31">addr_is_v4</name></expr>)</condition> <block pos:start="2117:34" pos:end="2122:18">{<block_content pos:start="2118:21" pos:end="2121:21">
                    <expr_stmt pos:start="2118:21" pos:end="2118:81"><expr pos:start="2118:21" pos:end="2118:80"><name pos:start="2118:21" pos:end="2118:28">safec_rc</name> <operator pos:start="2118:30" pos:end="2118:30">=</operator> <call pos:start="2118:32" pos:end="2118:80"><name pos:start="2118:32" pos:end="2118:39">memcmp_s</name><argument_list pos:start="2118:40" pos:end="2118:80">(<argument pos:start="2118:41" pos:end="2118:46"><expr pos:start="2118:41" pos:end="2118:46"><name pos:start="2118:41" pos:end="2118:46">altptr</name></expr></argument>, <argument pos:start="2118:49" pos:end="2118:54"><expr pos:start="2118:49" pos:end="2118:54"><name pos:start="2118:49" pos:end="2118:54">altlen</name></expr></argument>, <argument pos:start="2118:57" pos:end="2118:64"><expr pos:start="2118:57" pos:end="2118:64"><operator pos:start="2118:57" pos:end="2118:57">&amp;</operator><name pos:start="2118:58" pos:end="2118:64">addr_v4</name></expr></argument>, <argument pos:start="2118:67" pos:end="2118:72"><expr pos:start="2118:67" pos:end="2118:72"><name pos:start="2118:67" pos:end="2118:72">altlen</name></expr></argument>, <argument pos:start="2118:75" pos:end="2118:79"><expr pos:start="2118:75" pos:end="2118:79"><operator pos:start="2118:75" pos:end="2118:75">&amp;</operator><name pos:start="2118:76" pos:end="2118:79">diff</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                    <if_stmt pos:start="2119:21" pos:end="2121:21"><if pos:start="2119:21" pos:end="2121:21">if <condition pos:start="2119:24" pos:end="2119:40">(<expr pos:start="2119:25" pos:end="2119:39"><name pos:start="2119:25" pos:end="2119:32">safec_rc</name> <operator pos:start="2119:34" pos:end="2119:35">!=</operator> <name pos:start="2119:37" pos:end="2119:39">EOK</name></expr>)</condition> <block pos:start="2119:42" pos:end="2121:21">{<block_content pos:start="2120:25" pos:end="2120:91">
                    	<expr_stmt pos:start="2120:25" pos:end="2120:91"><expr pos:start="2120:25" pos:end="2120:90"><call pos:start="2120:25" pos:end="2120:90"><name pos:start="2120:25" pos:end="2120:36">EST_LOG_INFO</name><argument_list pos:start="2120:37" pos:end="2120:90">(<argument pos:start="2120:38" pos:end="2120:79"><expr pos:start="2120:38" pos:end="2120:79"><literal type="string" pos:start="2120:38" pos:end="2120:79">"memcmp_s error 0x%xO with IPv4 address\n"</literal></expr></argument>, <argument pos:start="2120:82" pos:end="2120:89"><expr pos:start="2120:82" pos:end="2120:89"><name pos:start="2120:82" pos:end="2120:89">safec_rc</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                    </block_content>}</block></if></if_stmt>  
                 </block_content>}</block></if> <if type="elseif" pos:start="2122:20" pos:end="2127:18">else if <condition pos:start="2122:28" pos:end="2122:39">(<expr pos:start="2122:29" pos:end="2122:38"><name pos:start="2122:29" pos:end="2122:38">addr_is_v6</name></expr>)</condition> <block pos:start="2122:41" pos:end="2127:18">{<block_content pos:start="2123:21" pos:end="2126:21">
                    <expr_stmt pos:start="2123:21" pos:end="2123:81"><expr pos:start="2123:21" pos:end="2123:80"><name pos:start="2123:21" pos:end="2123:28">safec_rc</name> <operator pos:start="2123:30" pos:end="2123:30">=</operator> <call pos:start="2123:32" pos:end="2123:80"><name pos:start="2123:32" pos:end="2123:39">memcmp_s</name><argument_list pos:start="2123:40" pos:end="2123:80">(<argument pos:start="2123:41" pos:end="2123:46"><expr pos:start="2123:41" pos:end="2123:46"><name pos:start="2123:41" pos:end="2123:46">altptr</name></expr></argument>, <argument pos:start="2123:49" pos:end="2123:54"><expr pos:start="2123:49" pos:end="2123:54"><name pos:start="2123:49" pos:end="2123:54">altlen</name></expr></argument>, <argument pos:start="2123:57" pos:end="2123:64"><expr pos:start="2123:57" pos:end="2123:64"><operator pos:start="2123:57" pos:end="2123:57">&amp;</operator><name pos:start="2123:58" pos:end="2123:64">addr_v6</name></expr></argument>, <argument pos:start="2123:67" pos:end="2123:72"><expr pos:start="2123:67" pos:end="2123:72"><name pos:start="2123:67" pos:end="2123:72">altlen</name></expr></argument>, <argument pos:start="2123:75" pos:end="2123:79"><expr pos:start="2123:75" pos:end="2123:79"><operator pos:start="2123:75" pos:end="2123:75">&amp;</operator><name pos:start="2123:76" pos:end="2123:79">diff</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                    <if_stmt pos:start="2124:21" pos:end="2126:21"><if pos:start="2124:21" pos:end="2126:21">if <condition pos:start="2124:24" pos:end="2124:40">(<expr pos:start="2124:25" pos:end="2124:39"><name pos:start="2124:25" pos:end="2124:32">safec_rc</name> <operator pos:start="2124:34" pos:end="2124:35">!=</operator> <name pos:start="2124:37" pos:end="2124:39">EOK</name></expr>)</condition> <block pos:start="2124:42" pos:end="2126:21">{<block_content pos:start="2125:25" pos:end="2125:91">
                    	<expr_stmt pos:start="2125:25" pos:end="2125:91"><expr pos:start="2125:25" pos:end="2125:90"><call pos:start="2125:25" pos:end="2125:90"><name pos:start="2125:25" pos:end="2125:36">EST_LOG_INFO</name><argument_list pos:start="2125:37" pos:end="2125:90">(<argument pos:start="2125:38" pos:end="2125:79"><expr pos:start="2125:38" pos:end="2125:79"><literal type="string" pos:start="2125:38" pos:end="2125:79">"memcmp_s error 0x%xO with IPv6 address\n"</literal></expr></argument>, <argument pos:start="2125:82" pos:end="2125:89"><expr pos:start="2125:82" pos:end="2125:89"><name pos:start="2125:82" pos:end="2125:89">safec_rc</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                    </block_content>}</block></if></if_stmt>  
                 </block_content>}</block></if> <else pos:start="2127:20" pos:end="2132:18">else <block pos:start="2127:25" pos:end="2132:18">{<block_content pos:start="2131:20" pos:end="2131:29">
                   <comment type="block" pos:start="2128:20" pos:end="2130:22">/*
                    * Should never get here...so force matched to be 0
                    */</comment>
	           <expr_stmt pos:start="2131:20" pos:end="2131:29"><expr pos:start="2131:20" pos:end="2131:28"><name pos:start="2131:20" pos:end="2131:23">diff</name> <operator pos:start="2131:25" pos:end="2131:25">=</operator> <operator pos:start="2131:27" pos:end="2131:27">-</operator><literal type="number" pos:start="2131:28" pos:end="2131:28">1</literal></expr>;</expr_stmt> 
	 	 </block_content>}</block></else></if_stmt>

                <if_stmt pos:start="2134:17" pos:end="2140:17"><if pos:start="2134:17" pos:end="2136:17">if <condition pos:start="2134:20" pos:end="2134:65">(<expr pos:start="2134:21" pos:end="2134:64"><operator pos:start="2134:21" pos:end="2134:21">(</operator><name pos:start="2134:22" pos:end="2134:31">addr_is_v4</name><operator pos:start="2134:32" pos:end="2134:32">)</operator> <operator pos:start="2134:34" pos:end="2134:35">&amp;&amp;</operator> <operator pos:start="2134:37" pos:end="2134:37">(</operator><name pos:start="2134:38" pos:end="2134:43">altlen</name> <operator pos:start="2134:45" pos:end="2134:46">==</operator> <name pos:start="2134:48" pos:end="2134:54">addrlen</name><operator pos:start="2134:55" pos:end="2134:55">)</operator> <operator pos:start="2134:57" pos:end="2134:58">&amp;&amp;</operator> <operator pos:start="2134:60" pos:end="2134:60">!</operator><name pos:start="2134:61" pos:end="2134:64">diff</name></expr>)</condition> <block pos:start="2134:67" pos:end="2136:17">{<block_content pos:start="2135:21" pos:end="2135:32">
                    <expr_stmt pos:start="2135:21" pos:end="2135:32"><expr pos:start="2135:21" pos:end="2135:31"><name pos:start="2135:21" pos:end="2135:27">matched</name> <operator pos:start="2135:29" pos:end="2135:29">=</operator> <literal type="number" pos:start="2135:31" pos:end="2135:31">1</literal></expr>;</expr_stmt>
                </block_content>}</block></if> <if type="elseif" pos:start="2136:19" pos:end="2138:17">else if <condition pos:start="2136:27" pos:end="2136:72">(<expr pos:start="2136:28" pos:end="2136:71"><operator pos:start="2136:28" pos:end="2136:28">(</operator><name pos:start="2136:29" pos:end="2136:38">addr_is_v6</name><operator pos:start="2136:39" pos:end="2136:39">)</operator> <operator pos:start="2136:41" pos:end="2136:42">&amp;&amp;</operator> <operator pos:start="2136:44" pos:end="2136:44">(</operator><name pos:start="2136:45" pos:end="2136:50">altlen</name> <operator pos:start="2136:52" pos:end="2136:53">==</operator> <name pos:start="2136:55" pos:end="2136:61">addrlen</name><operator pos:start="2136:62" pos:end="2136:62">)</operator> <operator pos:start="2136:64" pos:end="2136:65">&amp;&amp;</operator> <operator pos:start="2136:67" pos:end="2136:67">!</operator><name pos:start="2136:68" pos:end="2136:71">diff</name></expr>)</condition> <block pos:start="2136:74" pos:end="2138:17">{<block_content pos:start="2137:21" pos:end="2137:32">
                    <expr_stmt pos:start="2137:21" pos:end="2137:32"><expr pos:start="2137:21" pos:end="2137:31"><name pos:start="2137:21" pos:end="2137:27">matched</name> <operator pos:start="2137:29" pos:end="2137:29">=</operator> <literal type="number" pos:start="2137:31" pos:end="2137:31">1</literal></expr>;</expr_stmt>
                </block_content>}</block></if> <else pos:start="2138:19" pos:end="2140:17">else<block pos:start="2138:23" pos:end="2140:17">{<block_content pos:start="2139:21" pos:end="2139:32">
                    <expr_stmt pos:start="2139:21" pos:end="2139:32"><expr pos:start="2139:21" pos:end="2139:31"><name pos:start="2139:21" pos:end="2139:27">matched</name> <operator pos:start="2139:29" pos:end="2139:29">=</operator> <literal type="number" pos:start="2139:31" pos:end="2139:31">0</literal></expr>;</expr_stmt>
                </block_content>}</block></else></if_stmt>
                <break pos:start="2141:17" pos:end="2141:22">break;</break>
            </block_content>}</block></switch>
        </block_content>}</block></for>
        <expr_stmt pos:start="2144:9" pos:end="2144:37"><expr pos:start="2144:9" pos:end="2144:36"><call pos:start="2144:9" pos:end="2144:36"><name pos:start="2144:9" pos:end="2144:26">GENERAL_NAMES_free</name><argument_list pos:start="2144:27" pos:end="2144:36">(<argument pos:start="2144:28" pos:end="2144:35"><expr pos:start="2144:28" pos:end="2144:35"><name pos:start="2144:28" pos:end="2144:35">altnames</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="2147:5" pos:end="2239:5"><if pos:start="2147:5" pos:end="2150:5">if <condition pos:start="2147:8" pos:end="2147:21">(<expr pos:start="2147:9" pos:end="2147:20"><name pos:start="2147:9" pos:end="2147:15">matched</name> <operator pos:start="2147:17" pos:end="2147:18">==</operator> <literal type="number" pos:start="2147:20" pos:end="2147:20">1</literal></expr>)</condition> <block pos:start="2147:23" pos:end="2150:5">{<block_content pos:start="2149:9" pos:end="2149:63">
        <comment type="block" pos:start="2148:9" pos:end="2148:61">/* an alternative name matched the server hostname */</comment>
        <expr_stmt pos:start="2149:9" pos:end="2149:63"><expr pos:start="2149:9" pos:end="2149:62"><call pos:start="2149:9" pos:end="2149:62"><name pos:start="2149:9" pos:end="2149:20">EST_LOG_INFO</name><argument_list pos:start="2149:21" pos:end="2149:62">(<argument pos:start="2149:22" pos:end="2149:51"><expr pos:start="2149:22" pos:end="2149:51"><literal type="string" pos:start="2149:22" pos:end="2149:51">"subjectAltName: %s matched\n"</literal></expr></argument>, <argument pos:start="2149:54" pos:end="2149:61"><expr pos:start="2149:54" pos:end="2149:61"><name pos:start="2149:54" pos:end="2149:61">hostname</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if> <if type="elseif" pos:start="2150:7" pos:end="2155:5">else if <condition pos:start="2150:15" pos:end="2150:28">(<expr pos:start="2150:16" pos:end="2150:27"><name pos:start="2150:16" pos:end="2150:22">matched</name> <operator pos:start="2150:24" pos:end="2150:25">==</operator> <literal type="number" pos:start="2150:27" pos:end="2150:27">0</literal></expr>)</condition> <block pos:start="2150:30" pos:end="2155:5">{<block_content pos:start="2153:9" pos:end="2154:36">
        <comment type="block" pos:start="2151:9" pos:end="2152:26">/* an alternative name field existed, but didn't match and then
           we MUST fail */</comment>
        <expr_stmt pos:start="2153:9" pos:end="2153:69"><expr pos:start="2153:9" pos:end="2153:68"><call pos:start="2153:9" pos:end="2153:68"><name pos:start="2153:9" pos:end="2153:20">EST_LOG_INFO</name><argument_list pos:start="2153:21" pos:end="2153:68">(<argument pos:start="2153:22" pos:end="2153:57"><expr pos:start="2153:22" pos:end="2153:57"><literal type="string" pos:start="2153:22" pos:end="2153:57">"subjectAltName does not match %s\n"</literal></expr></argument>, <argument pos:start="2153:60" pos:end="2153:67"><expr pos:start="2153:60" pos:end="2153:67"><name pos:start="2153:60" pos:end="2153:67">hostname</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2154:9" pos:end="2154:36"><expr pos:start="2154:9" pos:end="2154:35"><name pos:start="2154:9" pos:end="2154:11">res</name> <operator pos:start="2154:13" pos:end="2154:13">=</operator> <name pos:start="2154:15" pos:end="2154:35">EST_ERR_FQDN_MISMATCH</name></expr>;</expr_stmt>
    </block_content>}</block></if><else pos:start="2155:6" pos:end="2239:5">else  <block pos:start="2155:12" pos:end="2239:5">{<block_content pos:start="2158:9" pos:end="2238:9">
        <comment type="block" pos:start="2156:9" pos:end="2157:64">/* we have to look to the last occurrence of a commonName in the
           distinguished one to get the most significant one. */</comment>
        <expr_stmt pos:start="2158:9" pos:end="2158:15"><expr pos:start="2158:9" pos:end="2158:14"><name pos:start="2158:9" pos:end="2158:9">i</name> <operator pos:start="2158:11" pos:end="2158:11">=</operator> <operator pos:start="2158:13" pos:end="2158:13">-</operator><literal type="number" pos:start="2158:14" pos:end="2158:14">1</literal></expr>;</expr_stmt>

	<comment type="block" pos:start="2160:9" pos:end="2160:62">/* The following is done because of a bug in 0.9.6b */</comment>
        <expr_stmt pos:start="2161:9" pos:end="2161:36"><expr pos:start="2161:9" pos:end="2161:35"><name pos:start="2161:9" pos:end="2161:14">nulstr</name> <operator pos:start="2161:16" pos:end="2161:16">=</operator> <operator pos:start="2161:18" pos:end="2161:18">(</operator><name pos:start="2161:19" pos:end="2161:26">unsigned</name> <name pos:start="2161:28" pos:end="2161:31">char</name><operator pos:start="2161:32" pos:end="2161:32">*</operator><operator pos:start="2161:33" pos:end="2161:33">)</operator><literal type="string" pos:start="2161:34" pos:end="2161:35">""</literal></expr>;</expr_stmt>
        <expr_stmt pos:start="2162:9" pos:end="2162:25"><expr pos:start="2162:9" pos:end="2162:24"><name pos:start="2162:9" pos:end="2162:15">peer_CN</name> <operator pos:start="2162:17" pos:end="2162:17">=</operator> <name pos:start="2162:19" pos:end="2162:24">nulstr</name></expr>;</expr_stmt>

        <expr_stmt pos:start="2164:9" pos:end="2164:50"><expr pos:start="2164:9" pos:end="2164:49"><name pos:start="2164:9" pos:end="2164:12">name</name> <operator pos:start="2164:14" pos:end="2164:14">=</operator> <call pos:start="2164:16" pos:end="2164:49"><name pos:start="2164:16" pos:end="2164:36">X509_get_subject_name</name><argument_list pos:start="2164:37" pos:end="2164:49">(<argument pos:start="2164:38" pos:end="2164:48"><expr pos:start="2164:38" pos:end="2164:48"><name pos:start="2164:38" pos:end="2164:48">server_cert</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="2165:9" pos:end="2169:9"><if pos:start="2165:9" pos:end="2169:9">if <condition pos:start="2165:12" pos:end="2165:17">(<expr pos:start="2165:13" pos:end="2165:16"><name pos:start="2165:13" pos:end="2165:16">name</name></expr>)</condition> <block pos:start="2165:19" pos:end="2169:9">{<block_content pos:start="2166:13" pos:end="2168:13">
            <while pos:start="2166:13" pos:end="2168:13">while <condition pos:start="2166:19" pos:end="2166:82">(<expr pos:start="2166:20" pos:end="2166:81"><operator pos:start="2166:20" pos:end="2166:20">(</operator><name pos:start="2166:21" pos:end="2166:21">j</name> <operator pos:start="2166:23" pos:end="2166:23">=</operator> <call pos:start="2166:25" pos:end="2166:75"><name pos:start="2166:25" pos:end="2166:50">X509_NAME_get_index_by_NID</name><argument_list pos:start="2166:51" pos:end="2166:75">(<argument pos:start="2166:52" pos:end="2166:55"><expr pos:start="2166:52" pos:end="2166:55"><name pos:start="2166:52" pos:end="2166:55">name</name></expr></argument>, <argument pos:start="2166:58" pos:end="2166:71"><expr pos:start="2166:58" pos:end="2166:71"><name pos:start="2166:58" pos:end="2166:71">NID_commonName</name></expr></argument>, <argument pos:start="2166:74" pos:end="2166:74"><expr pos:start="2166:74" pos:end="2166:74"><name pos:start="2166:74" pos:end="2166:74">i</name></expr></argument>)</argument_list></call><operator pos:start="2166:76" pos:end="2166:76">)</operator> <operator pos:start="2166:78" pos:end="2166:79">&gt;=</operator> <literal type="number" pos:start="2166:81" pos:end="2166:81">0</literal></expr>)</condition> <block pos:start="2166:84" pos:end="2168:13">{<block_content pos:start="2167:17" pos:end="2167:22">
                <expr_stmt pos:start="2167:17" pos:end="2167:22"><expr pos:start="2167:17" pos:end="2167:21"><name pos:start="2167:17" pos:end="2167:17">i</name> <operator pos:start="2167:19" pos:end="2167:19">=</operator> <name pos:start="2167:21" pos:end="2167:21">j</name></expr>;</expr_stmt>
            </block_content>}</block></while>
        </block_content>}</block></if></if_stmt>

        <comment type="block" pos:start="2171:9" pos:end="2173:23">/* we have the name entry and we will now convert this to a string
           that we can use for comparison. Doing this we support BMPstring,
           UTF8 etc. */</comment>

        <if_stmt pos:start="2175:9" pos:end="2206:9"><if pos:start="2175:9" pos:end="2206:9">if <condition pos:start="2175:12" pos:end="2175:19">(<expr pos:start="2175:13" pos:end="2175:18"><name pos:start="2175:13" pos:end="2175:13">i</name> <operator pos:start="2175:15" pos:end="2175:16">&gt;=</operator> <literal type="number" pos:start="2175:18" pos:end="2175:18">0</literal></expr>)</condition> <block pos:start="2175:21" pos:end="2206:9">{<block_content pos:start="2176:13" pos:end="2205:13">
            <expr_stmt pos:start="2176:13" pos:end="2176:73"><expr pos:start="2176:13" pos:end="2176:72"><name pos:start="2176:13" pos:end="2176:15">tmp</name> <operator pos:start="2176:17" pos:end="2176:17">=</operator> <call pos:start="2176:19" pos:end="2176:72"><name pos:start="2176:19" pos:end="2176:42">X509_NAME_ENTRY_get_data</name><argument_list pos:start="2176:43" pos:end="2176:72">(<argument pos:start="2176:44" pos:end="2176:71"><expr pos:start="2176:44" pos:end="2176:71"><call pos:start="2176:44" pos:end="2176:71"><name pos:start="2176:44" pos:end="2176:62">X509_NAME_get_entry</name><argument_list pos:start="2176:63" pos:end="2176:71">(<argument pos:start="2176:64" pos:end="2176:67"><expr pos:start="2176:64" pos:end="2176:67"><name pos:start="2176:64" pos:end="2176:67">name</name></expr></argument>, <argument pos:start="2176:70" pos:end="2176:70"><expr pos:start="2176:70" pos:end="2176:70"><name pos:start="2176:70" pos:end="2176:70">i</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>

            <comment type="block" pos:start="2178:13" pos:end="2182:51">/* In OpenSSL 0.9.7d and earlier, ASN1_STRING_to_UTF8 fails if the input
               is already UTF-8 encoded. We check for this case and copy the raw
               string manually to avoid the problem. This code can be made
               conditional in the future when OpenSSL has been fixed. Work-around
               brought by Alexis S. L. Carvalho. */</comment>
            <if_stmt pos:start="2183:13" pos:end="2205:13"><if pos:start="2183:13" pos:end="2205:13">if <condition pos:start="2183:16" pos:end="2183:20">(<expr pos:start="2183:17" pos:end="2183:19"><name pos:start="2183:17" pos:end="2183:19">tmp</name></expr>)</condition> <block pos:start="2183:22" pos:end="2205:13">{<block_content pos:start="2184:17" pos:end="2204:17">
                <if_stmt pos:start="2184:17" pos:end="2198:17"><if pos:start="2184:17" pos:end="2196:17">if <condition pos:start="2184:20" pos:end="2184:63">(<expr pos:start="2184:21" pos:end="2184:62"><call pos:start="2184:21" pos:end="2184:41"><name pos:start="2184:21" pos:end="2184:36">ASN1_STRING_type</name><argument_list pos:start="2184:37" pos:end="2184:41">(<argument pos:start="2184:38" pos:end="2184:40"><expr pos:start="2184:38" pos:end="2184:40"><name pos:start="2184:38" pos:end="2184:40">tmp</name></expr></argument>)</argument_list></call> <operator pos:start="2184:43" pos:end="2184:44">==</operator> <name pos:start="2184:46" pos:end="2184:62">V_ASN1_UTF8STRING</name></expr>)</condition> <block pos:start="2184:65" pos:end="2196:17">{<block_content pos:start="2185:21" pos:end="2195:21">
                    <expr_stmt pos:start="2185:21" pos:end="2185:48"><expr pos:start="2185:21" pos:end="2185:47"><name pos:start="2185:21" pos:end="2185:21">j</name> <operator pos:start="2185:23" pos:end="2185:23">=</operator> <call pos:start="2185:25" pos:end="2185:47"><name pos:start="2185:25" pos:end="2185:42">ASN1_STRING_length</name><argument_list pos:start="2185:43" pos:end="2185:47">(<argument pos:start="2185:44" pos:end="2185:46"><expr pos:start="2185:44" pos:end="2185:46"><name pos:start="2185:44" pos:end="2185:46">tmp</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                    <if_stmt pos:start="2186:21" pos:end="2195:21"><if pos:start="2186:21" pos:end="2195:21">if <condition pos:start="2186:24" pos:end="2186:31">(<expr pos:start="2186:25" pos:end="2186:30"><name pos:start="2186:25" pos:end="2186:25">j</name> <operator pos:start="2186:27" pos:end="2186:28">&gt;=</operator> <literal type="number" pos:start="2186:30" pos:end="2186:30">0</literal></expr>)</condition> <block pos:start="2186:33" pos:end="2195:21">{<block_content pos:start="2187:25" pos:end="2194:25">
                        <expr_stmt pos:start="2187:25" pos:end="2187:48"><expr pos:start="2187:25" pos:end="2187:47"><name pos:start="2187:25" pos:end="2187:31">peer_CN</name> <operator pos:start="2187:33" pos:end="2187:33">=</operator> <call pos:start="2187:35" pos:end="2187:47"><name pos:start="2187:35" pos:end="2187:40">malloc</name><argument_list pos:start="2187:41" pos:end="2187:47">(<argument pos:start="2187:42" pos:end="2187:46"><expr pos:start="2187:42" pos:end="2187:46"><name pos:start="2187:42" pos:end="2187:42">j</name> <operator pos:start="2187:44" pos:end="2187:44">+</operator> <literal type="number" pos:start="2187:46" pos:end="2187:46">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                        <if_stmt pos:start="2188:25" pos:end="2194:25"><if pos:start="2188:25" pos:end="2194:25">if <condition pos:start="2188:28" pos:end="2188:36">(<expr pos:start="2188:29" pos:end="2188:35"><name pos:start="2188:29" pos:end="2188:35">peer_CN</name></expr>)</condition> <block pos:start="2188:38" pos:end="2194:25">{<block_content pos:start="2189:29" pos:end="2193:46">
			    <expr_stmt pos:start="2189:29" pos:end="2189:86"><expr pos:start="2189:29" pos:end="2189:85"><name pos:start="2189:29" pos:end="2189:36">safec_rc</name> <operator pos:start="2189:38" pos:end="2189:38">=</operator> <call pos:start="2189:40" pos:end="2189:85"><name pos:start="2189:40" pos:end="2189:47">memcpy_s</name><argument_list pos:start="2189:48" pos:end="2189:85">(<argument pos:start="2189:49" pos:end="2189:55"><expr pos:start="2189:49" pos:end="2189:55"><name pos:start="2189:49" pos:end="2189:55">peer_CN</name></expr></argument>, <argument pos:start="2189:58" pos:end="2189:58"><expr pos:start="2189:58" pos:end="2189:58"><name pos:start="2189:58" pos:end="2189:58">j</name></expr></argument>, <argument pos:start="2189:61" pos:end="2189:81"><expr pos:start="2189:61" pos:end="2189:81"><call pos:start="2189:61" pos:end="2189:81"><name pos:start="2189:61" pos:end="2189:76">ASN1_STRING_data</name><argument_list pos:start="2189:77" pos:end="2189:81">(<argument pos:start="2189:78" pos:end="2189:80"><expr pos:start="2189:78" pos:end="2189:80"><name pos:start="2189:78" pos:end="2189:80">tmp</name></expr></argument>)</argument_list></call></expr></argument>, <argument pos:start="2189:84" pos:end="2189:84"><expr pos:start="2189:84" pos:end="2189:84"><name pos:start="2189:84" pos:end="2189:84">j</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                            <if_stmt pos:start="2190:29" pos:end="2192:29"><if pos:start="2190:29" pos:end="2192:29">if <condition pos:start="2190:32" pos:end="2190:48">(<expr pos:start="2190:33" pos:end="2190:47"><name pos:start="2190:33" pos:end="2190:40">safec_rc</name> <operator pos:start="2190:42" pos:end="2190:43">!=</operator> <name pos:start="2190:45" pos:end="2190:47">EOK</name></expr>)</condition> <block pos:start="2190:50" pos:end="2192:29">{<block_content pos:start="2191:33" pos:end="2191:98">
				<expr_stmt pos:start="2191:33" pos:end="2191:98"><expr pos:start="2191:33" pos:end="2191:97"><call pos:start="2191:33" pos:end="2191:97"><name pos:start="2191:33" pos:end="2191:44">EST_LOG_INFO</name><argument_list pos:start="2191:45" pos:end="2191:97">(<argument pos:start="2191:46" pos:end="2191:86"><expr pos:start="2191:46" pos:end="2191:86"><literal type="string" pos:start="2191:46" pos:end="2191:86">"memcpy_s error 0x%xO with ASN1 string\n"</literal></expr></argument>, <argument pos:start="2191:89" pos:end="2191:96"><expr pos:start="2191:89" pos:end="2191:96"><name pos:start="2191:89" pos:end="2191:96">safec_rc</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                            </block_content>}</block></if></if_stmt>
                            <expr_stmt pos:start="2193:29" pos:end="2193:46"><expr pos:start="2193:29" pos:end="2193:45"><name pos:start="2193:29" pos:end="2193:38"><name pos:start="2193:29" pos:end="2193:35">peer_CN</name><index pos:start="2193:36" pos:end="2193:38">[<expr pos:start="2193:37" pos:end="2193:37"><name pos:start="2193:37" pos:end="2193:37">j</name></expr>]</index></name> <operator pos:start="2193:40" pos:end="2193:40">=</operator> <literal type="char" pos:start="2193:42" pos:end="2193:45">'\0'</literal></expr>;</expr_stmt>
                        </block_content>}</block></if></if_stmt>
                    </block_content>}</block></if></if_stmt>
                </block_content>}</block></if><else pos:start="2196:18" pos:end="2198:17">else  <block pos:start="2196:24" pos:end="2198:17">{<block_content pos:start="2197:21" pos:end="2197:59"> <comment type="block" pos:start="2196:26" pos:end="2196:46">/* not a UTF8 name */</comment>
                    <expr_stmt pos:start="2197:21" pos:end="2197:59"><expr pos:start="2197:21" pos:end="2197:58"><name pos:start="2197:21" pos:end="2197:21">j</name> <operator pos:start="2197:23" pos:end="2197:23">=</operator> <call pos:start="2197:25" pos:end="2197:58"><name pos:start="2197:25" pos:end="2197:43">ASN1_STRING_to_UTF8</name><argument_list pos:start="2197:44" pos:end="2197:58">(<argument pos:start="2197:45" pos:end="2197:52"><expr pos:start="2197:45" pos:end="2197:52"><operator pos:start="2197:45" pos:end="2197:45">&amp;</operator><name pos:start="2197:46" pos:end="2197:52">peer_CN</name></expr></argument>, <argument pos:start="2197:55" pos:end="2197:57"><expr pos:start="2197:55" pos:end="2197:57"><name pos:start="2197:55" pos:end="2197:57">tmp</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                </block_content>}</block></else></if_stmt>
                <if_stmt pos:start="2199:17" pos:end="2204:17"><if pos:start="2199:17" pos:end="2204:17">if <condition pos:start="2199:20" pos:end="2199:88">(<expr pos:start="2199:21" pos:end="2199:87"><name pos:start="2199:21" pos:end="2199:27">peer_CN</name> <operator pos:start="2199:29" pos:end="2199:30">&amp;&amp;</operator> <operator pos:start="2199:32" pos:end="2199:32">(</operator><call pos:start="2199:33" pos:end="2199:81"><name pos:start="2199:33" pos:end="2199:41">strnlen_s</name><argument_list pos:start="2199:42" pos:end="2199:81">(<argument pos:start="2199:43" pos:end="2199:56"><expr pos:start="2199:43" pos:end="2199:56"><operator pos:start="2199:43" pos:end="2199:43">(</operator><name pos:start="2199:44" pos:end="2199:47">char</name><operator pos:start="2199:48" pos:end="2199:48">*</operator><operator pos:start="2199:49" pos:end="2199:49">)</operator><name pos:start="2199:50" pos:end="2199:56">peer_CN</name></expr></argument>, <argument pos:start="2199:59" pos:end="2199:80"><expr pos:start="2199:59" pos:end="2199:80"><name pos:start="2199:59" pos:end="2199:80">EST_MAX_SERVERNAME_LEN</name></expr></argument>)</argument_list></call> <operator pos:start="2199:83" pos:end="2199:84">!=</operator> <name pos:start="2199:86" pos:end="2199:86">j</name><operator pos:start="2199:87" pos:end="2199:87">)</operator></expr>)</condition> <block pos:start="2199:90" pos:end="2204:17">{<block_content pos:start="2202:21" pos:end="2203:48">
                    <comment type="block" pos:start="2200:21" pos:end="2201:61">/* there was a terminating zero before the end of string, this
                       cannot match and we return failure! */</comment>
                    <expr_stmt pos:start="2202:21" pos:end="2202:65"><expr pos:start="2202:21" pos:end="2202:64"><call pos:start="2202:21" pos:end="2202:64"><name pos:start="2202:21" pos:end="2202:32">EST_LOG_WARN</name><argument_list pos:start="2202:33" pos:end="2202:64">(<argument pos:start="2202:34" pos:end="2202:63"><expr pos:start="2202:34" pos:end="2202:63"><literal type="string" pos:start="2202:34" pos:end="2202:63">"SSL: illegal cert name field"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                    <expr_stmt pos:start="2203:21" pos:end="2203:48"><expr pos:start="2203:21" pos:end="2203:47"><name pos:start="2203:21" pos:end="2203:23">res</name> <operator pos:start="2203:25" pos:end="2203:25">=</operator> <name pos:start="2203:27" pos:end="2203:47">EST_ERR_FQDN_MISMATCH</name></expr>;</expr_stmt>
                </block_content>}</block></if></if_stmt>
            </block_content>}</block></if></if_stmt>
        </block_content>}</block></if></if_stmt>

        <if_stmt pos:start="2208:9" pos:end="2221:9"><if pos:start="2208:9" pos:end="2210:9">if <condition pos:start="2208:12" pos:end="2208:30">(<expr pos:start="2208:13" pos:end="2208:29"><name pos:start="2208:13" pos:end="2208:19">peer_CN</name> <operator pos:start="2208:21" pos:end="2208:22">==</operator> <name pos:start="2208:24" pos:end="2208:29">nulstr</name></expr>)</condition> <block pos:start="2208:32" pos:end="2210:9">{<block_content pos:start="2209:13" pos:end="2209:27">
            <expr_stmt pos:start="2209:13" pos:end="2209:27"><expr pos:start="2209:13" pos:end="2209:26"><name pos:start="2209:13" pos:end="2209:19">peer_CN</name> <operator pos:start="2209:21" pos:end="2209:21">=</operator> <name pos:start="2209:23" pos:end="2209:26">NULL</name></expr>;</expr_stmt>
        </block_content>}</block></if> <else pos:start="2210:11" pos:end="2221:9">else<block pos:start="2210:15" pos:end="2221:9">{<block_content>
            <comment type="block" pos:start="2211:13" pos:end="2211:43">/* convert peer_CN from UTF8 */</comment>
<cpp:if pos:start="2212:1" pos:end="2212:5">#<cpp:directive pos:start="2212:2" pos:end="2212:3">if</cpp:directive> <expr pos:start="2212:5" pos:end="2212:5"><literal type="number" pos:start="2212:5" pos:end="2212:5">0</literal></expr></cpp:if>
<comment type="line" pos:start="2213:1" pos:end="2213:62">// UTF8 currently not supported in the first release of libest</comment>
            CURLcode rc = Curl_convert_from_utf8(data, peer_CN, strlen(peer_CN));
            <comment type="block" pos:start="2215:13" pos:end="2215:68">/* Curl_convert_from_utf8 calls failf if unsuccessful */</comment>
            if (rc) {
                free(peer_CN);
                return EST_ERR_FQDN_MISMATCH;
            }
<cpp:endif pos:start="2220:1" pos:end="2220:6">#<cpp:directive pos:start="2220:2" pos:end="2220:6">endif</cpp:directive></cpp:endif>
        </block_content>}</block></else></if_stmt>

        <if_stmt pos:start="2223:9" pos:end="2235:9"><if pos:start="2223:9" pos:end="2226:9">if <condition pos:start="2223:12" pos:end="2223:32">(<expr pos:start="2223:13" pos:end="2223:31"><name pos:start="2223:13" pos:end="2223:15">res</name> <operator pos:start="2223:17" pos:end="2223:18">!=</operator> <name pos:start="2223:20" pos:end="2223:31">EST_ERR_NONE</name></expr>)</condition> <block pos:start="2223:34" pos:end="2226:9">{<block_content pos:start="2225:13" pos:end="2225:13">
            <comment type="block" pos:start="2224:13" pos:end="2224:54">/* error already detected, pass through */</comment>
            <empty_stmt pos:start="2225:13" pos:end="2225:13">;</empty_stmt>
        </block_content>}</block></if> <if type="elseif" pos:start="2226:11" pos:end="2229:9">else if <condition pos:start="2226:19" pos:end="2226:28">(<expr pos:start="2226:20" pos:end="2226:27"><operator pos:start="2226:20" pos:end="2226:20">!</operator><name pos:start="2226:21" pos:end="2226:27">peer_CN</name></expr>)</condition> <block pos:start="2226:30" pos:end="2229:9">{<block_content pos:start="2227:13" pos:end="2228:40">
            <expr_stmt pos:start="2227:13" pos:end="2227:84"><expr pos:start="2227:13" pos:end="2227:83"><call pos:start="2227:13" pos:end="2227:83"><name pos:start="2227:13" pos:end="2227:24">EST_LOG_WARN</name><argument_list pos:start="2227:25" pos:end="2227:83">(<argument pos:start="2227:26" pos:end="2227:82"><expr pos:start="2227:26" pos:end="2227:82"><literal type="string" pos:start="2227:26" pos:end="2227:82">"SSL: unable to obtain common name from peer certificate"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="2228:13" pos:end="2228:40"><expr pos:start="2228:13" pos:end="2228:39"><name pos:start="2228:13" pos:end="2228:15">res</name> <operator pos:start="2228:17" pos:end="2228:17">=</operator> <name pos:start="2228:19" pos:end="2228:39">EST_ERR_FQDN_MISMATCH</name></expr>;</expr_stmt>
        </block_content>}</block></if><if type="elseif" pos:start="2229:10" pos:end="2233:9">else if <condition pos:start="2229:18" pos:end="2229:77">(<expr pos:start="2229:19" pos:end="2229:76"><operator pos:start="2229:19" pos:end="2229:19">!</operator><call pos:start="2229:20" pos:end="2229:76"><name pos:start="2229:20" pos:end="2229:44">est_client_cert_hostcheck</name><argument_list pos:start="2229:45" pos:end="2229:76">(<argument pos:start="2229:46" pos:end="2229:65"><expr pos:start="2229:46" pos:end="2229:65"><operator pos:start="2229:46" pos:end="2229:46">(</operator><specifier pos:start="2229:47" pos:end="2229:51">const</specifier> <name pos:start="2229:53" pos:end="2229:56">char</name><operator pos:start="2229:57" pos:end="2229:57">*</operator><operator pos:start="2229:58" pos:end="2229:58">)</operator><name pos:start="2229:59" pos:end="2229:65">peer_CN</name></expr></argument>, <argument pos:start="2229:68" pos:end="2229:75"><expr pos:start="2229:68" pos:end="2229:75"><name pos:start="2229:68" pos:end="2229:75">hostname</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="2229:79" pos:end="2233:9">{<block_content pos:start="2230:13" pos:end="2232:40">
            <expr_stmt pos:start="2230:13" pos:end="2231:66"><expr pos:start="2230:13" pos:end="2231:65"><call pos:start="2230:13" pos:end="2231:65"><name pos:start="2230:13" pos:end="2230:24">EST_LOG_WARN</name><argument_list pos:start="2230:25" pos:end="2231:65">(<argument pos:start="2230:26" pos:end="2231:45"><expr pos:start="2230:26" pos:end="2231:45"><literal type="string" pos:start="2230:26" pos:end="2230:98">"SSL: FQDN hostname mismatch in server certificate, '%s' does not match "</literal>
                      <literal type="string" pos:start="2231:23" pos:end="2231:45">"target host name '%s'"</literal></expr></argument>, <argument pos:start="2231:48" pos:end="2231:54"><expr pos:start="2231:48" pos:end="2231:54"><name pos:start="2231:48" pos:end="2231:54">peer_CN</name></expr></argument>, <argument pos:start="2231:57" pos:end="2231:64"><expr pos:start="2231:57" pos:end="2231:64"><name pos:start="2231:57" pos:end="2231:64">hostname</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="2232:13" pos:end="2232:40"><expr pos:start="2232:13" pos:end="2232:39"><name pos:start="2232:13" pos:end="2232:15">res</name> <operator pos:start="2232:17" pos:end="2232:17">=</operator> <name pos:start="2232:19" pos:end="2232:39">EST_ERR_FQDN_MISMATCH</name></expr>;</expr_stmt>
        </block_content>}</block></if><else pos:start="2233:10" pos:end="2235:9">else  <block pos:start="2233:16" pos:end="2235:9">{<block_content pos:start="2234:13" pos:end="2234:63">
            <expr_stmt pos:start="2234:13" pos:end="2234:63"><expr pos:start="2234:13" pos:end="2234:62"><call pos:start="2234:13" pos:end="2234:62"><name pos:start="2234:13" pos:end="2234:24">EST_LOG_INFO</name><argument_list pos:start="2234:25" pos:end="2234:62">(<argument pos:start="2234:26" pos:end="2234:52"><expr pos:start="2234:26" pos:end="2234:52"><literal type="string" pos:start="2234:26" pos:end="2234:52">"common name: %s (matched)"</literal></expr></argument>, <argument pos:start="2234:55" pos:end="2234:61"><expr pos:start="2234:55" pos:end="2234:61"><name pos:start="2234:55" pos:end="2234:61">peer_CN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></else></if_stmt>
        <if_stmt pos:start="2236:9" pos:end="2238:9"><if pos:start="2236:9" pos:end="2238:9">if <condition pos:start="2236:12" pos:end="2236:20">(<expr pos:start="2236:13" pos:end="2236:19"><name pos:start="2236:13" pos:end="2236:19">peer_CN</name></expr>)</condition> <block pos:start="2236:22" pos:end="2238:9">{<block_content pos:start="2237:13" pos:end="2237:26">
            <expr_stmt pos:start="2237:13" pos:end="2237:26"><expr pos:start="2237:13" pos:end="2237:25"><call pos:start="2237:13" pos:end="2237:25"><name pos:start="2237:13" pos:end="2237:16">free</name><argument_list pos:start="2237:17" pos:end="2237:25">(<argument pos:start="2237:18" pos:end="2237:24"><expr pos:start="2237:18" pos:end="2237:24"><name pos:start="2237:18" pos:end="2237:24">peer_CN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></if></if_stmt>
    </block_content>}</block></else></if_stmt>
    <return pos:start="2240:5" pos:end="2240:15">return <expr pos:start="2240:12" pos:end="2240:14"><name pos:start="2240:12" pos:end="2240:14">res</name></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="2242:1" pos:end="2254:3">/*
 * This routine checks the FQDN in the server certificate
 * against the configure server name used to establish
 * the TCP connection with the EST server.
 * This is required per section 3.6 in the EST spec.
 * Note, we only do the FQDN check as defined in RFC 6125.
 * We do not look for the id-kp-cmcRA extended key usage
 * extension in the server cert.  While this is more 
 * restrictive by not allowing FQDN mismatches when the
 * id-kp-cmcRA is present, we currently have no way to
 * determine when we're using the explicit trust anchor to
 * allow this additional flexibility.
 */</comment>
<function pos:start="2255:1" pos:end="2273:1"><type pos:start="2255:1" pos:end="2255:16"><specifier pos:start="2255:1" pos:end="2255:6">static</specifier> <name pos:start="2255:8" pos:end="2255:16">EST_ERROR</name></type> <name pos:start="2255:18" pos:end="2255:38">est_client_check_fqdn</name> <parameter_list pos:start="2255:40" pos:end="2255:63">(<parameter pos:start="2255:41" pos:end="2255:52"><decl pos:start="2255:41" pos:end="2255:52"><type pos:start="2255:41" pos:end="2255:52"><name pos:start="2255:41" pos:end="2255:47">EST_CTX</name> <modifier pos:start="2255:49" pos:end="2255:49">*</modifier></type><name pos:start="2255:50" pos:end="2255:52">ctx</name></decl></parameter>, <parameter pos:start="2255:55" pos:end="2255:62"><decl pos:start="2255:55" pos:end="2255:62"><type pos:start="2255:55" pos:end="2255:62"><name pos:start="2255:55" pos:end="2255:57">SSL</name> <modifier pos:start="2255:59" pos:end="2255:59">*</modifier></type><name pos:start="2255:60" pos:end="2255:62">ssl</name></decl></parameter>)</parameter_list>
<block pos:start="2256:1" pos:end="2273:1">{<block_content pos:start="2257:5" pos:end="2272:5">
    <decl_stmt pos:start="2257:5" pos:end="2257:15"><decl pos:start="2257:5" pos:end="2257:14"><type pos:start="2257:5" pos:end="2257:10"><name pos:start="2257:5" pos:end="2257:8">X509</name> <modifier pos:start="2257:10" pos:end="2257:10">*</modifier></type><name pos:start="2257:11" pos:end="2257:14">cert</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2258:5" pos:end="2258:17"><decl pos:start="2258:5" pos:end="2258:16"><type pos:start="2258:5" pos:end="2258:13"><name pos:start="2258:5" pos:end="2258:13">EST_ERROR</name></type> <name pos:start="2258:15" pos:end="2258:16">er</name></decl>;</decl_stmt>

    <expr_stmt pos:start="2260:5" pos:end="2260:41"><expr pos:start="2260:5" pos:end="2260:40"><name pos:start="2260:5" pos:end="2260:8">cert</name> <operator pos:start="2260:10" pos:end="2260:10">=</operator> <call pos:start="2260:12" pos:end="2260:40"><name pos:start="2260:12" pos:end="2260:35">SSL_get_peer_certificate</name><argument_list pos:start="2260:36" pos:end="2260:40">(<argument pos:start="2260:37" pos:end="2260:39"><expr pos:start="2260:37" pos:end="2260:39"><name pos:start="2260:37" pos:end="2260:39">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <if_stmt pos:start="2262:5" pos:end="2272:5"><if pos:start="2262:5" pos:end="2266:5">if <condition pos:start="2262:8" pos:end="2262:13">(<expr pos:start="2262:9" pos:end="2262:12"><name pos:start="2262:9" pos:end="2262:12">cert</name></expr>)</condition> <block pos:start="2262:15" pos:end="2266:5">{<block_content pos:start="2263:9" pos:end="2265:20">
	<expr_stmt pos:start="2263:9" pos:end="2263:58"><expr pos:start="2263:9" pos:end="2263:57"><name pos:start="2263:9" pos:end="2263:10">er</name> <operator pos:start="2263:12" pos:end="2263:12">=</operator> <call pos:start="2263:14" pos:end="2263:57"><name pos:start="2263:14" pos:end="2263:34">est_client_verifyhost</name><argument_list pos:start="2263:35" pos:end="2263:57">(<argument pos:start="2263:36" pos:end="2263:50"><expr pos:start="2263:36" pos:end="2263:50"><name pos:start="2263:36" pos:end="2263:50"><name pos:start="2263:36" pos:end="2263:38">ctx</name><operator pos:start="2263:39" pos:end="2263:40">-&gt;</operator><name pos:start="2263:41" pos:end="2263:50">est_server</name></name></expr></argument>, <argument pos:start="2263:53" pos:end="2263:56"><expr pos:start="2263:53" pos:end="2263:56"><name pos:start="2263:53" pos:end="2263:56">cert</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt pos:start="2264:9" pos:end="2264:24"><expr pos:start="2264:9" pos:end="2264:23"><call pos:start="2264:9" pos:end="2264:23"><name pos:start="2264:9" pos:end="2264:17">X509_free</name><argument_list pos:start="2264:18" pos:end="2264:23">(<argument pos:start="2264:19" pos:end="2264:22"><expr pos:start="2264:19" pos:end="2264:22"><name pos:start="2264:19" pos:end="2264:22">cert</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return pos:start="2265:9" pos:end="2265:20">return <expr pos:start="2265:16" pos:end="2265:19"><operator pos:start="2265:16" pos:end="2265:16">(</operator><name pos:start="2265:17" pos:end="2265:18">er</name><operator pos:start="2265:19" pos:end="2265:19">)</operator></expr>;</return>
    </block_content>}</block></if> <if type="elseif" pos:start="2266:7" pos:end="2269:5">else if <condition pos:start="2266:15" pos:end="2266:40">(<expr pos:start="2266:16" pos:end="2266:39"><operator pos:start="2266:16" pos:end="2266:16">!</operator><name pos:start="2266:17" pos:end="2266:20">cert</name> <operator pos:start="2266:22" pos:end="2266:23">&amp;&amp;</operator> <name pos:start="2266:25" pos:end="2266:39"><name pos:start="2266:25" pos:end="2266:27">ctx</name><operator pos:start="2266:28" pos:end="2266:29">-&gt;</operator><name pos:start="2266:30" pos:end="2266:39">enable_srp</name></name></expr>)</condition> <block pos:start="2266:42" pos:end="2269:5">{<block_content pos:start="2267:9" pos:end="2268:28">
	<expr_stmt pos:start="2267:9" pos:end="2267:87"><expr pos:start="2267:9" pos:end="2267:86"><call pos:start="2267:9" pos:end="2267:86"><name pos:start="2267:9" pos:end="2267:20">EST_LOG_INFO</name><argument_list pos:start="2267:21" pos:end="2267:86">(<argument pos:start="2267:22" pos:end="2267:85"><expr pos:start="2267:22" pos:end="2267:85"><literal type="string" pos:start="2267:22" pos:end="2267:85">"No peer certificate, skipping FQDN check since SRP is enabled."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return pos:start="2268:9" pos:end="2268:28">return <expr pos:start="2268:16" pos:end="2268:27"><name pos:start="2268:16" pos:end="2268:27">EST_ERR_NONE</name></expr>;</return>
    </block_content>}</block></if> <else pos:start="2269:7" pos:end="2272:5">else <block pos:start="2269:12" pos:end="2272:5">{<block_content pos:start="2270:9" pos:end="2271:37">
	<expr_stmt pos:start="2270:9" pos:end="2270:75"><expr pos:start="2270:9" pos:end="2270:74"><call pos:start="2270:9" pos:end="2270:74"><name pos:start="2270:9" pos:end="2270:20">EST_LOG_WARN</name><argument_list pos:start="2270:21" pos:end="2270:74">(<argument pos:start="2270:22" pos:end="2270:73"><expr pos:start="2270:22" pos:end="2270:73"><literal type="string" pos:start="2270:22" pos:end="2270:73">"Unable to perform FQDN check, no peer certificate."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return pos:start="2271:9" pos:end="2271:37">return <expr pos:start="2271:16" pos:end="2271:36"><name pos:start="2271:16" pos:end="2271:36">EST_ERR_FQDN_MISMATCH</name></expr>;</return>
    </block_content>}</block></else></if_stmt>
</block_content>}</block></function>
<comment type="block" pos:start="2274:1" pos:end="2284:3">/*
 * This function will open a TCP socket and establish a TLS session
 * with the EST server.  This should be called after est_client_init().
 *
 * Parameters:
 *	ctx:	    Pointer to EST context for client session
 *      ssl:        pointer to an SSL context structure to return the
 *                  SSL context created,
 * Reurns:
 *	EST_ERR_NONE if success
 */</comment>
<function pos:start="2285:1" pos:end="2420:1"><type pos:start="2285:1" pos:end="2285:9"><name pos:start="2285:1" pos:end="2285:9">EST_ERROR</name></type> <name pos:start="2285:11" pos:end="2285:28">est_client_connect</name> <parameter_list pos:start="2285:30" pos:end="2285:54">(<parameter pos:start="2285:31" pos:end="2285:42"><decl pos:start="2285:31" pos:end="2285:42"><type pos:start="2285:31" pos:end="2285:42"><name pos:start="2285:31" pos:end="2285:37">EST_CTX</name> <modifier pos:start="2285:39" pos:end="2285:39">*</modifier></type><name pos:start="2285:40" pos:end="2285:42">ctx</name></decl></parameter>, <parameter pos:start="2285:45" pos:end="2285:53"><decl pos:start="2285:45" pos:end="2285:53"><type pos:start="2285:45" pos:end="2285:53"><name pos:start="2285:45" pos:end="2285:47">SSL</name> <modifier pos:start="2285:49" pos:end="2285:49">*</modifier><modifier pos:start="2285:50" pos:end="2285:50">*</modifier></type><name pos:start="2285:51" pos:end="2285:53">ssl</name></decl></parameter>)</parameter_list>
<block pos:start="2286:1" pos:end="2420:1">{<block_content pos:start="2287:5" pos:end="2419:14">
    <decl_stmt pos:start="2287:5" pos:end="2287:25"><decl pos:start="2287:5" pos:end="2287:24"><type pos:start="2287:5" pos:end="2287:21"><name pos:start="2287:5" pos:end="2287:7">BIO</name>             <modifier pos:start="2287:21" pos:end="2287:21">*</modifier></type><name pos:start="2287:22" pos:end="2287:24">tcp</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2288:5" pos:end="2288:27"><decl pos:start="2288:5" pos:end="2288:26"><type pos:start="2288:5" pos:end="2288:21"><name pos:start="2288:5" pos:end="2288:11">SSL_CTX</name>         <modifier pos:start="2288:21" pos:end="2288:21">*</modifier></type><name pos:start="2288:22" pos:end="2288:26">s_ctx</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2289:5" pos:end="2291:0"><decl pos:start="2289:5" pos:end="2289:37"><type pos:start="2289:5" pos:end="2289:13"><name pos:start="2289:5" pos:end="2289:13">EST_ERROR</name></type>       <name pos:start="2289:21" pos:end="2289:22">rv</name> <init pos:start="2289:24" pos:end="2289:37">= <expr pos:start="2289:26" pos:end="2289:37"><name pos:start="2289:26" pos:end="2289:37">EST_ERR_NONE</name></expr></init></decl>;</decl_stmt>
<cpp:ifndef pos:start="2290:1" pos:end="2290:13">#<cpp:directive pos:start="2290:2" pos:end="2290:7">ifndef</cpp:directive> <name pos:start="2290:9" pos:end="2290:13">WIN32</name></cpp:ifndef>
    <decl_stmt pos:start="2291:5" pos:end="2293:0"><decl pos:start="2291:5" pos:end="2291:24"><type pos:start="2291:5" pos:end="2291:7"><name pos:start="2291:5" pos:end="2291:7">int</name></type>             <name pos:start="2291:21" pos:end="2291:24">sock</name></decl>;</decl_stmt>
<cpp:else pos:start="2292:1" pos:end="2292:5">#<cpp:directive pos:start="2292:2" pos:end="2292:5">else</cpp:directive></cpp:else>
    <decl_stmt pos:start="2293:5" pos:end="2295:0"><decl pos:start="2293:5" pos:end="2293:41"><type pos:start="2293:5" pos:end="2293:10"><name pos:start="2293:5" pos:end="2293:10">SOCKET</name></type>          <name pos:start="2293:21" pos:end="2293:24">sock</name> <init pos:start="2293:26" pos:end="2293:41">= <expr pos:start="2293:28" pos:end="2293:41"><name pos:start="2293:28" pos:end="2293:41">INVALID_SOCKET</name></expr></init></decl>;</decl_stmt>
<cpp:endif pos:start="2294:1" pos:end="2294:6">#<cpp:directive pos:start="2294:2" pos:end="2294:6">endif</cpp:directive></cpp:endif>
    <decl_stmt pos:start="2295:5" pos:end="2295:23"><decl pos:start="2295:5" pos:end="2295:22"><type pos:start="2295:5" pos:end="2295:7"><name pos:start="2295:5" pos:end="2295:7">int</name></type>             <name pos:start="2295:21" pos:end="2295:22">rc</name></decl>;</decl_stmt> 
    <decl_stmt pos:start="2296:5" pos:end="2296:29"><decl pos:start="2296:5" pos:end="2296:28"><type pos:start="2296:5" pos:end="2296:7"><name pos:start="2296:5" pos:end="2296:7">int</name></type>             <name pos:start="2296:21" pos:end="2296:24">oval</name> <init pos:start="2296:26" pos:end="2296:28">= <expr pos:start="2296:28" pos:end="2296:28"><literal type="number" pos:start="2296:28" pos:end="2296:28">1</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="2297:5" pos:end="2297:41"><decl pos:start="2297:5" pos:end="2297:40"><type pos:start="2297:5" pos:end="2297:7"><name pos:start="2297:5" pos:end="2297:7">int</name></type>             <name pos:start="2297:21" pos:end="2297:35">ssl_connect_ret</name> <init pos:start="2297:37" pos:end="2297:40">= <expr pos:start="2297:39" pos:end="2297:40"><operator pos:start="2297:39" pos:end="2297:39">-</operator><literal type="number" pos:start="2297:40" pos:end="2297:40">1</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="2298:5" pos:end="2298:28"><decl pos:start="2298:5" pos:end="2298:27"><type pos:start="2298:5" pos:end="2298:13"><name pos:start="2298:5" pos:end="2298:13">tcw_err_t</name></type>       <name pos:start="2298:21" pos:end="2298:27">tcw_err</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2299:5" pos:end="2299:37"><decl pos:start="2299:5" pos:end="2299:36"><type pos:start="2299:5" pos:end="2299:14"><name pos:start="2299:5" pos:end="2299:14">tcw_opts_t</name></type>      <name pos:start="2299:21" pos:end="2299:28">tcw_opts</name> <init pos:start="2299:30" pos:end="2299:36">= <expr pos:start="2299:32" pos:end="2299:36"><block pos:start="2299:32" pos:end="2299:36">{ <expr pos:start="2299:34" pos:end="2299:34"><literal type="number" pos:start="2299:34" pos:end="2299:34">0</literal></expr> }</block></expr></init></decl>;</decl_stmt>
    
    <if_stmt pos:start="2301:5" pos:end="2303:5"><if pos:start="2301:5" pos:end="2303:5">if <condition pos:start="2301:8" pos:end="2301:13">(<expr pos:start="2301:9" pos:end="2301:12"><operator pos:start="2301:9" pos:end="2301:9">!</operator><name pos:start="2301:10" pos:end="2301:12">ctx</name></expr>)</condition> <block pos:start="2301:15" pos:end="2303:5">{<block_content pos:start="2302:9" pos:end="2302:30">
        <return pos:start="2302:9" pos:end="2302:30">return <expr pos:start="2302:16" pos:end="2302:29"><name pos:start="2302:16" pos:end="2302:29">EST_ERR_NO_CTX</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="2305:5" pos:end="2305:25"><expr pos:start="2305:5" pos:end="2305:24"><name pos:start="2305:5" pos:end="2305:9">s_ctx</name> <operator pos:start="2305:11" pos:end="2305:11">=</operator> <name pos:start="2305:13" pos:end="2305:24"><name pos:start="2305:13" pos:end="2305:15">ctx</name><operator pos:start="2305:16" pos:end="2305:17">-&gt;</operator><name pos:start="2305:18" pos:end="2305:24">ssl_ctx</name></name></expr>;</expr_stmt>

    <comment type="block" pos:start="2307:5" pos:end="2309:7">/*
     * Establish the connection through a proxy (if applicable)
     */</comment>
    <if_stmt pos:start="2310:5" pos:end="2333:5"><if pos:start="2310:5" pos:end="2331:5">if <condition pos:start="2310:8" pos:end="2310:23">(<expr pos:start="2310:9" pos:end="2310:22"><name pos:start="2310:9" pos:end="2310:22"><name pos:start="2310:9" pos:end="2310:11">ctx</name><operator pos:start="2310:12" pos:end="2310:13">-&gt;</operator><name pos:start="2310:14" pos:end="2310:22">use_proxy</name></name></expr>)</condition> <block pos:start="2310:25" pos:end="2331:5">{<block_content pos:start="2312:9" pos:end="2330:9">

        <expr_stmt pos:start="2312:9" pos:end="2312:48"><expr pos:start="2312:9" pos:end="2312:47"><name pos:start="2312:9" pos:end="2312:28"><name pos:start="2312:9" pos:end="2312:16">tcw_opts</name><operator pos:start="2312:17" pos:end="2312:17">.</operator><name pos:start="2312:18" pos:end="2312:28">proxy_proto</name></name> <operator pos:start="2312:30" pos:end="2312:30">=</operator> <name pos:start="2312:32" pos:end="2312:47"><name pos:start="2312:32" pos:end="2312:34">ctx</name><operator pos:start="2312:35" pos:end="2312:36">-&gt;</operator><name pos:start="2312:37" pos:end="2312:47">proxy_proto</name></name></expr>;</expr_stmt>
        
        <expr_stmt pos:start="2314:9" pos:end="2314:48"><expr pos:start="2314:9" pos:end="2314:47"><name pos:start="2314:9" pos:end="2314:27"><name pos:start="2314:9" pos:end="2314:16">tcw_opts</name><operator pos:start="2314:17" pos:end="2314:17">.</operator><name pos:start="2314:18" pos:end="2314:27">proxy_host</name></name> <operator pos:start="2314:29" pos:end="2314:29">=</operator> <name pos:start="2314:31" pos:end="2314:47"><name pos:start="2314:31" pos:end="2314:33">ctx</name><operator pos:start="2314:34" pos:end="2314:35">-&gt;</operator><name pos:start="2314:36" pos:end="2314:47">proxy_server</name></name></expr>;</expr_stmt>
        <expr_stmt pos:start="2315:9" pos:end="2315:46"><expr pos:start="2315:9" pos:end="2315:45"><name pos:start="2315:9" pos:end="2315:27"><name pos:start="2315:9" pos:end="2315:16">tcw_opts</name><operator pos:start="2315:17" pos:end="2315:17">.</operator><name pos:start="2315:18" pos:end="2315:27">proxy_port</name></name> <operator pos:start="2315:29" pos:end="2315:29">=</operator> <name pos:start="2315:31" pos:end="2315:45"><name pos:start="2315:31" pos:end="2315:33">ctx</name><operator pos:start="2315:34" pos:end="2315:35">-&gt;</operator><name pos:start="2315:36" pos:end="2315:45">proxy_port</name></name></expr>;</expr_stmt>
        
        <if_stmt pos:start="2317:9" pos:end="2330:9"><if pos:start="2317:9" pos:end="2330:9">if <condition pos:start="2317:12" pos:end="2318:62">(<expr pos:start="2317:13" pos:end="2318:61"><name pos:start="2317:13" pos:end="2317:34"><name pos:start="2317:13" pos:end="2317:15">ctx</name><operator pos:start="2317:16" pos:end="2317:17">-&gt;</operator><name pos:start="2317:18" pos:end="2317:31">proxy_username</name><index pos:start="2317:32" pos:end="2317:34">[<expr pos:start="2317:33" pos:end="2317:33"><literal type="number" pos:start="2317:33" pos:end="2317:33">0</literal></expr>]</index></name> <operator pos:start="2317:36" pos:end="2317:37">&amp;&amp;</operator> <name pos:start="2317:39" pos:end="2317:60"><name pos:start="2317:39" pos:end="2317:41">ctx</name><operator pos:start="2317:42" pos:end="2317:43">-&gt;</operator><name pos:start="2317:44" pos:end="2317:57">proxy_password</name><index pos:start="2317:58" pos:end="2317:60">[<expr pos:start="2317:59" pos:end="2317:59"><literal type="number" pos:start="2317:59" pos:end="2317:59">0</literal></expr>]</index></name> <operator pos:start="2317:62" pos:end="2317:63">&amp;&amp;</operator>
                <name pos:start="2318:17" pos:end="2318:31"><name pos:start="2318:17" pos:end="2318:19">ctx</name><operator pos:start="2318:20" pos:end="2318:21">-&gt;</operator><name pos:start="2318:22" pos:end="2318:31">proxy_auth</name></name> <operator pos:start="2318:33" pos:end="2318:34">!=</operator> <name pos:start="2318:36" pos:end="2318:61">EST_CLIENT_PROXY_AUTH_NONE</name></expr>)</condition> <block pos:start="2318:64" pos:end="2330:9">{<block_content pos:start="2319:13" pos:end="2328:13">
            <expr_stmt pos:start="2319:13" pos:end="2319:58"><expr pos:start="2319:13" pos:end="2319:57"><name pos:start="2319:13" pos:end="2319:35"><name pos:start="2319:13" pos:end="2319:20">tcw_opts</name><operator pos:start="2319:21" pos:end="2319:21">.</operator><name pos:start="2319:22" pos:end="2319:35">proxy_username</name></name> <operator pos:start="2319:37" pos:end="2319:37">=</operator> <name pos:start="2319:39" pos:end="2319:57"><name pos:start="2319:39" pos:end="2319:41">ctx</name><operator pos:start="2319:42" pos:end="2319:43">-&gt;</operator><name pos:start="2319:44" pos:end="2319:57">proxy_username</name></name></expr>;</expr_stmt>
            <expr_stmt pos:start="2320:13" pos:end="2320:58"><expr pos:start="2320:13" pos:end="2320:57"><name pos:start="2320:13" pos:end="2320:35"><name pos:start="2320:13" pos:end="2320:20">tcw_opts</name><operator pos:start="2320:21" pos:end="2320:21">.</operator><name pos:start="2320:22" pos:end="2320:35">proxy_password</name></name> <operator pos:start="2320:37" pos:end="2320:37">=</operator> <name pos:start="2320:39" pos:end="2320:57"><name pos:start="2320:39" pos:end="2320:41">ctx</name><operator pos:start="2320:42" pos:end="2320:43">-&gt;</operator><name pos:start="2320:44" pos:end="2320:57">proxy_password</name></name></expr>;</expr_stmt>
            
            <expr_stmt pos:start="2322:13" pos:end="2322:36"><expr pos:start="2322:13" pos:end="2322:35"><name pos:start="2322:13" pos:end="2322:31"><name pos:start="2322:13" pos:end="2322:20">tcw_opts</name><operator pos:start="2322:21" pos:end="2322:21">.</operator><name pos:start="2322:22" pos:end="2322:31">proxy_auth</name></name> <operator pos:start="2322:33" pos:end="2322:33">=</operator> <literal type="number" pos:start="2322:35" pos:end="2322:35">0</literal></expr>;</expr_stmt>  <comment type="block" pos:start="2322:39" pos:end="2322:54">/* initialize */</comment>
            <if_stmt pos:start="2323:13" pos:end="2325:13"><if pos:start="2323:13" pos:end="2325:13">if <condition pos:start="2323:16" pos:end="2323:62">(<expr pos:start="2323:17" pos:end="2323:61"><name pos:start="2323:17" pos:end="2323:31"><name pos:start="2323:17" pos:end="2323:19">ctx</name><operator pos:start="2323:20" pos:end="2323:21">-&gt;</operator><name pos:start="2323:22" pos:end="2323:31">proxy_auth</name></name> <operator pos:start="2323:33" pos:end="2323:33">&amp;</operator> <name pos:start="2323:35" pos:end="2323:61">EST_CLIENT_PROXY_AUTH_BASIC</name></expr>)</condition> <block pos:start="2323:64" pos:end="2325:13">{<block_content pos:start="2324:17" pos:end="2324:67">
                <expr_stmt pos:start="2324:17" pos:end="2324:67"><expr pos:start="2324:17" pos:end="2324:66"><name pos:start="2324:17" pos:end="2324:35"><name pos:start="2324:17" pos:end="2324:24">tcw_opts</name><operator pos:start="2324:25" pos:end="2324:25">.</operator><name pos:start="2324:26" pos:end="2324:35">proxy_auth</name></name> <operator pos:start="2324:37" pos:end="2324:38">|=</operator> <name pos:start="2324:40" pos:end="2324:66">EST_CLIENT_PROXY_AUTH_BASIC</name></expr>;</expr_stmt>
            </block_content>}</block></if></if_stmt>
            <if_stmt pos:start="2326:13" pos:end="2328:13"><if pos:start="2326:13" pos:end="2328:13">if <condition pos:start="2326:16" pos:end="2326:61">(<expr pos:start="2326:17" pos:end="2326:60"><name pos:start="2326:17" pos:end="2326:31"><name pos:start="2326:17" pos:end="2326:19">ctx</name><operator pos:start="2326:20" pos:end="2326:21">-&gt;</operator><name pos:start="2326:22" pos:end="2326:31">proxy_auth</name></name> <operator pos:start="2326:33" pos:end="2326:33">&amp;</operator> <name pos:start="2326:35" pos:end="2326:60">EST_CLIENT_PROXY_AUTH_NTLM</name></expr>)</condition> <block pos:start="2326:63" pos:end="2328:13">{<block_content pos:start="2327:17" pos:end="2327:66">
                <expr_stmt pos:start="2327:17" pos:end="2327:66"><expr pos:start="2327:17" pos:end="2327:65"><name pos:start="2327:17" pos:end="2327:35"><name pos:start="2327:17" pos:end="2327:24">tcw_opts</name><operator pos:start="2327:25" pos:end="2327:25">.</operator><name pos:start="2327:26" pos:end="2327:35">proxy_auth</name></name> <operator pos:start="2327:37" pos:end="2327:38">|=</operator> <name pos:start="2327:40" pos:end="2327:65">EST_CLIENT_PROXY_AUTH_NTLM</name></expr>;</expr_stmt>
            </block_content>}</block></if></if_stmt>
            
        </block_content>}</block></if></if_stmt>
    </block_content>}</block></if> <else pos:start="2331:7" pos:end="2333:5">else <block pos:start="2331:12" pos:end="2333:5">{<block_content pos:start="2332:9" pos:end="2332:53">
        <expr_stmt pos:start="2332:9" pos:end="2332:53"><expr pos:start="2332:9" pos:end="2332:52"><name pos:start="2332:9" pos:end="2332:28"><name pos:start="2332:9" pos:end="2332:16">tcw_opts</name><operator pos:start="2332:17" pos:end="2332:17">.</operator><name pos:start="2332:18" pos:end="2332:28">proxy_proto</name></name> <operator pos:start="2332:30" pos:end="2332:30">=</operator> <name pos:start="2332:32" pos:end="2332:52">EST_CLIENT_PROXY_NONE</name></expr>;</expr_stmt>
    </block_content>}</block></else></if_stmt>

    <expr_stmt pos:start="2335:5" pos:end="2336:69"><expr pos:start="2335:5" pos:end="2336:68"><name pos:start="2335:5" pos:end="2335:11">tcw_err</name> <operator pos:start="2335:13" pos:end="2335:13">=</operator> <call pos:start="2335:15" pos:end="2336:68"><name pos:start="2335:15" pos:end="2335:25">tcw_connect</name><argument_list pos:start="2335:26" pos:end="2336:68">(<argument pos:start="2335:27" pos:end="2335:40"><expr pos:start="2335:27" pos:end="2335:40"><operator pos:start="2335:27" pos:end="2335:27">&amp;</operator><name pos:start="2335:28" pos:end="2335:40"><name pos:start="2335:28" pos:end="2335:30">ctx</name><operator pos:start="2335:31" pos:end="2335:32">-&gt;</operator><name pos:start="2335:33" pos:end="2335:40">tcw_sock</name></name></expr></argument>, <argument pos:start="2335:43" pos:end="2335:51"><expr pos:start="2335:43" pos:end="2335:51"><operator pos:start="2335:43" pos:end="2335:43">&amp;</operator><name pos:start="2335:44" pos:end="2335:51">tcw_opts</name></expr></argument>,
                          <argument pos:start="2336:27" pos:end="2336:41"><expr pos:start="2336:27" pos:end="2336:41"><name pos:start="2336:27" pos:end="2336:41"><name pos:start="2336:27" pos:end="2336:29">ctx</name><operator pos:start="2336:30" pos:end="2336:31">-&gt;</operator><name pos:start="2336:32" pos:end="2336:41">est_server</name></name></expr></argument>, <argument pos:start="2336:44" pos:end="2336:60"><expr pos:start="2336:44" pos:end="2336:60"><name pos:start="2336:44" pos:end="2336:60"><name pos:start="2336:44" pos:end="2336:46">ctx</name><operator pos:start="2336:47" pos:end="2336:48">-&gt;</operator><name pos:start="2336:49" pos:end="2336:60">est_port_num</name></name></expr></argument>, <argument pos:start="2336:63" pos:end="2336:67"><expr pos:start="2336:63" pos:end="2336:67"><operator pos:start="2336:63" pos:end="2336:63">&amp;</operator><name pos:start="2336:64" pos:end="2336:67">sock</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2337:5" pos:end="2340:5"><if pos:start="2337:5" pos:end="2340:5">if <condition pos:start="2337:8" pos:end="2337:34">(<expr pos:start="2337:9" pos:end="2337:33"><name pos:start="2337:9" pos:end="2337:15">tcw_err</name> <operator pos:start="2337:17" pos:end="2337:18">==</operator> <name pos:start="2337:20" pos:end="2337:33">TCW_ERR_RESOLV</name></expr>)</condition> <block pos:start="2337:36" pos:end="2340:5">{<block_content pos:start="2338:9" pos:end="2339:36">
        <expr_stmt pos:start="2338:9" pos:end="2338:70"><expr pos:start="2338:9" pos:end="2338:69"><call pos:start="2338:9" pos:end="2338:69"><name pos:start="2338:9" pos:end="2338:19">EST_LOG_ERR</name><argument_list pos:start="2338:20" pos:end="2338:69">(<argument pos:start="2338:21" pos:end="2338:51"><expr pos:start="2338:21" pos:end="2338:51"><literal type="string" pos:start="2338:21" pos:end="2338:51">"Unable to lookup hostname %s."</literal></expr></argument>, <argument pos:start="2338:54" pos:end="2338:68"><expr pos:start="2338:54" pos:end="2338:68"><name pos:start="2338:54" pos:end="2338:68"><name pos:start="2338:54" pos:end="2338:56">ctx</name><operator pos:start="2338:57" pos:end="2338:58">-&gt;</operator><name pos:start="2338:59" pos:end="2338:68">est_server</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="2339:9" pos:end="2339:36">return <expr pos:start="2339:16" pos:end="2339:35"><operator pos:start="2339:16" pos:end="2339:16">(</operator><name pos:start="2339:17" pos:end="2339:34">EST_ERR_IP_GETADDR</name><operator pos:start="2339:35" pos:end="2339:35">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <if_stmt pos:start="2341:5" pos:end="2344:5"><if pos:start="2341:5" pos:end="2344:5">if <condition pos:start="2341:8" pos:end="2341:26">(<expr pos:start="2341:9" pos:end="2341:25"><name pos:start="2341:9" pos:end="2341:15">tcw_err</name> <operator pos:start="2341:17" pos:end="2341:18">!=</operator> <name pos:start="2341:20" pos:end="2341:25">TCW_OK</name></expr>)</condition> <block pos:start="2341:28" pos:end="2344:5">{<block_content pos:start="2342:9" pos:end="2343:36">
        <expr_stmt pos:start="2342:9" pos:end="2342:78"><expr pos:start="2342:9" pos:end="2342:77"><call pos:start="2342:9" pos:end="2342:77"><name pos:start="2342:9" pos:end="2342:19">EST_LOG_ERR</name><argument_list pos:start="2342:20" pos:end="2342:77">(<argument pos:start="2342:21" pos:end="2342:59"><expr pos:start="2342:21" pos:end="2342:59"><literal type="string" pos:start="2342:21" pos:end="2342:59">"Unable to connect to EST server at %s"</literal></expr></argument>, <argument pos:start="2342:62" pos:end="2342:76"><expr pos:start="2342:62" pos:end="2342:76"><name pos:start="2342:62" pos:end="2342:76"><name pos:start="2342:62" pos:end="2342:64">ctx</name><operator pos:start="2342:65" pos:end="2342:66">-&gt;</operator><name pos:start="2342:67" pos:end="2342:76">est_server</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="2343:9" pos:end="2343:36">return <expr pos:start="2343:16" pos:end="2343:35"><operator pos:start="2343:16" pos:end="2343:16">(</operator><name pos:start="2343:17" pos:end="2343:34">EST_ERR_IP_CONNECT</name><operator pos:start="2343:35" pos:end="2343:35">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="2346:5" pos:end="2348:7">/*
     * Enable TCP keep-alive
     */</comment>
    <expr_stmt pos:start="2349:5" pos:end="2349:80"><expr pos:start="2349:5" pos:end="2349:79"><name pos:start="2349:5" pos:end="2349:6">rc</name> <operator pos:start="2349:8" pos:end="2349:8">=</operator> <call pos:start="2349:10" pos:end="2349:79"><name pos:start="2349:10" pos:end="2349:19">setsockopt</name><argument_list pos:start="2349:20" pos:end="2349:79">(<argument pos:start="2349:21" pos:end="2349:24"><expr pos:start="2349:21" pos:end="2349:24"><name pos:start="2349:21" pos:end="2349:24">sock</name></expr></argument>, <argument pos:start="2349:27" pos:end="2349:36"><expr pos:start="2349:27" pos:end="2349:36"><name pos:start="2349:27" pos:end="2349:36">SOL_SOCKET</name></expr></argument>,<argument pos:start="2349:38" pos:end="2349:49"><expr pos:start="2349:38" pos:end="2349:49"><name pos:start="2349:38" pos:end="2349:49">SO_KEEPALIVE</name></expr></argument>, <argument pos:start="2349:52" pos:end="2349:64"><expr pos:start="2349:52" pos:end="2349:64"><operator pos:start="2349:52" pos:end="2349:52">(</operator><name pos:start="2349:53" pos:end="2349:56">char</name> <operator pos:start="2349:58" pos:end="2349:58">*</operator><operator pos:start="2349:59" pos:end="2349:59">)</operator><operator pos:start="2349:60" pos:end="2349:60">&amp;</operator><name pos:start="2349:61" pos:end="2349:64">oval</name></expr></argument>, <argument pos:start="2349:67" pos:end="2349:78"><expr pos:start="2349:67" pos:end="2349:78"><sizeof pos:start="2349:67" pos:end="2349:78">sizeof<argument_list pos:start="2349:73" pos:end="2349:78">(<argument pos:start="2349:74" pos:end="2349:77"><expr pos:start="2349:74" pos:end="2349:77"><name pos:start="2349:74" pos:end="2349:77">oval</name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2350:5" pos:end="2355:5"><if pos:start="2350:5" pos:end="2355:5">if <condition pos:start="2350:8" pos:end="2350:15">(<expr pos:start="2350:9" pos:end="2350:14"><name pos:start="2350:9" pos:end="2350:10">rc</name> <operator pos:start="2350:12" pos:end="2350:12">&lt;</operator> <literal type="number" pos:start="2350:14" pos:end="2350:14">0</literal></expr>)</condition> <block pos:start="2350:17" pos:end="2355:5">{<block_content pos:start="2351:9" pos:end="2354:36">
        <expr_stmt pos:start="2351:9" pos:end="2351:34"><expr pos:start="2351:9" pos:end="2351:33"><call pos:start="2351:9" pos:end="2351:33"><name pos:start="2351:9" pos:end="2351:17">tcw_close</name><argument_list pos:start="2351:18" pos:end="2351:33">(<argument pos:start="2351:19" pos:end="2351:32"><expr pos:start="2351:19" pos:end="2351:32"><operator pos:start="2351:19" pos:end="2351:19">&amp;</operator><name pos:start="2351:20" pos:end="2351:32"><name pos:start="2351:20" pos:end="2351:22">ctx</name><operator pos:start="2351:23" pos:end="2351:24">-&gt;</operator><name pos:start="2351:25" pos:end="2351:32">tcw_sock</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2352:9" pos:end="2352:28"><expr pos:start="2352:9" pos:end="2352:27"><name pos:start="2352:9" pos:end="2352:12">sock</name> <operator pos:start="2352:14" pos:end="2352:14">=</operator> <name pos:start="2352:16" pos:end="2352:27">SOCK_INVALID</name></expr>;</expr_stmt>
        <expr_stmt pos:start="2353:9" pos:end="2353:86"><expr pos:start="2353:9" pos:end="2353:85"><call pos:start="2353:9" pos:end="2353:85"><name pos:start="2353:9" pos:end="2353:19">EST_LOG_ERR</name><argument_list pos:start="2353:20" pos:end="2353:85">(<argument pos:start="2353:21" pos:end="2353:67"><expr pos:start="2353:21" pos:end="2353:67"><literal type="string" pos:start="2353:21" pos:end="2353:67">"Unable to connect to EST server at address %s"</literal></expr></argument>, <argument pos:start="2353:70" pos:end="2353:84"><expr pos:start="2353:70" pos:end="2353:84"><name pos:start="2353:70" pos:end="2353:84"><name pos:start="2353:70" pos:end="2353:72">ctx</name><operator pos:start="2353:73" pos:end="2353:74">-&gt;</operator><name pos:start="2353:75" pos:end="2353:84">est_server</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="2354:9" pos:end="2354:36">return <expr pos:start="2354:16" pos:end="2354:35"><operator pos:start="2354:16" pos:end="2354:16">(</operator><name pos:start="2354:17" pos:end="2354:34">EST_ERR_IP_CONNECT</name><operator pos:start="2354:35" pos:end="2354:35">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <comment type="block" pos:start="2356:5" pos:end="2359:7">/*
     * Pass the socket to the BIO interface, which OpenSSL uses
     * to create the TLS session.
     */</comment>
    <expr_stmt pos:start="2360:5" pos:end="2360:44"><expr pos:start="2360:5" pos:end="2360:43"><name pos:start="2360:5" pos:end="2360:7">tcp</name> <operator pos:start="2360:9" pos:end="2360:9">=</operator> <call pos:start="2360:11" pos:end="2360:43"><name pos:start="2360:11" pos:end="2360:24">BIO_new_socket</name><argument_list pos:start="2360:25" pos:end="2360:43">(<argument pos:start="2360:26" pos:end="2360:29"><expr pos:start="2360:26" pos:end="2360:29"><name pos:start="2360:26" pos:end="2360:29">sock</name></expr></argument>, <argument pos:start="2360:32" pos:end="2360:42"><expr pos:start="2360:32" pos:end="2360:42"><name pos:start="2360:32" pos:end="2360:42">BIO_NOCLOSE</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2361:5" pos:end="2367:5"><if pos:start="2361:5" pos:end="2367:5">if <condition pos:start="2361:8" pos:end="2361:20">(<expr pos:start="2361:9" pos:end="2361:19"><name pos:start="2361:9" pos:end="2361:11">tcp</name> <operator pos:start="2361:13" pos:end="2361:14">==</operator> <name pos:start="2361:16" pos:end="2361:19">NULL</name></expr>)</condition> <block pos:start="2361:22" pos:end="2367:5">{<block_content pos:start="2362:9" pos:end="2366:36">
        <expr_stmt pos:start="2362:9" pos:end="2362:48"><expr pos:start="2362:9" pos:end="2362:47"><call pos:start="2362:9" pos:end="2362:47"><name pos:start="2362:9" pos:end="2362:19">EST_LOG_ERR</name><argument_list pos:start="2362:20" pos:end="2362:47">(<argument pos:start="2362:21" pos:end="2362:46"><expr pos:start="2362:21" pos:end="2362:46"><literal type="string" pos:start="2362:21" pos:end="2362:46">"Error creating IP socket"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2363:9" pos:end="2363:34"><expr pos:start="2363:9" pos:end="2363:33"><call pos:start="2363:9" pos:end="2363:33"><name pos:start="2363:9" pos:end="2363:17">tcw_close</name><argument_list pos:start="2363:18" pos:end="2363:33">(<argument pos:start="2363:19" pos:end="2363:32"><expr pos:start="2363:19" pos:end="2363:32"><operator pos:start="2363:19" pos:end="2363:19">&amp;</operator><name pos:start="2363:20" pos:end="2363:32"><name pos:start="2363:20" pos:end="2363:22">ctx</name><operator pos:start="2363:23" pos:end="2363:24">-&gt;</operator><name pos:start="2363:25" pos:end="2363:32">tcw_sock</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2364:9" pos:end="2364:28"><expr pos:start="2364:9" pos:end="2364:27"><name pos:start="2364:9" pos:end="2364:12">sock</name> <operator pos:start="2364:14" pos:end="2364:14">=</operator> <name pos:start="2364:16" pos:end="2364:27">SOCK_INVALID</name></expr>;</expr_stmt>        
        <expr_stmt pos:start="2365:9" pos:end="2365:31"><expr pos:start="2365:9" pos:end="2365:30"><call pos:start="2365:9" pos:end="2365:30"><name pos:start="2365:9" pos:end="2365:28">ossl_dump_ssl_errors</name><argument_list pos:start="2365:29" pos:end="2365:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="2366:9" pos:end="2366:36">return <expr pos:start="2366:16" pos:end="2366:35"><operator pos:start="2366:16" pos:end="2366:16">(</operator><name pos:start="2366:17" pos:end="2366:34">EST_ERR_IP_CONNECT</name><operator pos:start="2366:35" pos:end="2366:35">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>        
    
    <if_stmt pos:start="2369:5" pos:end="2376:5"><if pos:start="2369:5" pos:end="2376:5">if <condition pos:start="2369:8" pos:end="2369:33">(<expr pos:start="2369:9" pos:end="2369:32"><operator pos:start="2369:9" pos:end="2369:9">!</operator><operator pos:start="2369:10" pos:end="2369:10">(</operator><operator pos:start="2369:11" pos:end="2369:11">*</operator><name pos:start="2369:12" pos:end="2369:14">ssl</name> <operator pos:start="2369:16" pos:end="2369:16">=</operator> <call pos:start="2369:18" pos:end="2369:31"><name pos:start="2369:18" pos:end="2369:24">SSL_new</name><argument_list pos:start="2369:25" pos:end="2369:31">(<argument pos:start="2369:26" pos:end="2369:30"><expr pos:start="2369:26" pos:end="2369:30"><name pos:start="2369:26" pos:end="2369:30">s_ctx</name></expr></argument>)</argument_list></call><operator pos:start="2369:32" pos:end="2369:32">)</operator></expr>)</condition> <block pos:start="2369:35" pos:end="2376:5">{<block_content pos:start="2370:9" pos:end="2375:33">
        <expr_stmt pos:start="2370:9" pos:end="2370:50"><expr pos:start="2370:9" pos:end="2370:49"><call pos:start="2370:9" pos:end="2370:49"><name pos:start="2370:9" pos:end="2370:19">EST_LOG_ERR</name><argument_list pos:start="2370:20" pos:end="2370:49">(<argument pos:start="2370:21" pos:end="2370:48"><expr pos:start="2370:21" pos:end="2370:48"><literal type="string" pos:start="2370:21" pos:end="2370:48">"Error creating TLS context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2371:9" pos:end="2371:31"><expr pos:start="2371:9" pos:end="2371:30"><call pos:start="2371:9" pos:end="2371:30"><name pos:start="2371:9" pos:end="2371:28">ossl_dump_ssl_errors</name><argument_list pos:start="2371:29" pos:end="2371:30">()</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2372:9" pos:end="2372:26"><expr pos:start="2372:9" pos:end="2372:25"><call pos:start="2372:9" pos:end="2372:25"><name pos:start="2372:9" pos:end="2372:20">BIO_free_all</name><argument_list pos:start="2372:21" pos:end="2372:25">(<argument pos:start="2372:22" pos:end="2372:24"><expr pos:start="2372:22" pos:end="2372:24"><name pos:start="2372:22" pos:end="2372:24">tcp</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>    
        <expr_stmt pos:start="2373:9" pos:end="2373:34"><expr pos:start="2373:9" pos:end="2373:33"><call pos:start="2373:9" pos:end="2373:33"><name pos:start="2373:9" pos:end="2373:17">tcw_close</name><argument_list pos:start="2373:18" pos:end="2373:33">(<argument pos:start="2373:19" pos:end="2373:32"><expr pos:start="2373:19" pos:end="2373:32"><operator pos:start="2373:19" pos:end="2373:19">&amp;</operator><name pos:start="2373:20" pos:end="2373:32"><name pos:start="2373:20" pos:end="2373:22">ctx</name><operator pos:start="2373:23" pos:end="2373:24">-&gt;</operator><name pos:start="2373:25" pos:end="2373:32">tcw_sock</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2374:9" pos:end="2374:28"><expr pos:start="2374:9" pos:end="2374:27"><name pos:start="2374:9" pos:end="2374:12">sock</name> <operator pos:start="2374:14" pos:end="2374:14">=</operator> <name pos:start="2374:16" pos:end="2374:27">SOCK_INVALID</name></expr>;</expr_stmt>
        <return pos:start="2375:9" pos:end="2375:33">return <expr pos:start="2375:16" pos:end="2375:32"><operator pos:start="2375:16" pos:end="2375:16">(</operator><name pos:start="2375:17" pos:end="2375:31">EST_ERR_SSL_NEW</name><operator pos:start="2375:32" pos:end="2375:32">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="2378:5" pos:end="2381:7">/*
     * Need to set the EST ctx into the exdata of the SSL session context so
     * that it can be retrieved on a per session basis.
     */</comment>
    <expr_stmt pos:start="2382:5" pos:end="2382:55"><expr pos:start="2382:5" pos:end="2382:54"><call pos:start="2382:5" pos:end="2382:54"><name pos:start="2382:5" pos:end="2382:19">SSL_set_ex_data</name><argument_list pos:start="2382:20" pos:end="2382:54">(<argument pos:start="2382:21" pos:end="2382:24"><expr pos:start="2382:21" pos:end="2382:24"><operator pos:start="2382:21" pos:end="2382:21">*</operator><name pos:start="2382:22" pos:end="2382:24">ssl</name></expr></argument>, <argument pos:start="2382:27" pos:end="2382:48"><expr pos:start="2382:27" pos:end="2382:48"><name pos:start="2382:27" pos:end="2382:48">e_ctx_ssl_exdata_index</name></expr></argument>, <argument pos:start="2382:51" pos:end="2382:53"><expr pos:start="2382:51" pos:end="2382:53"><name pos:start="2382:51" pos:end="2382:53">ctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block" pos:start="2384:5" pos:end="2387:7">/*
     * Set the EST server name in the SSL context so that it'll be sent in the
     * in the server name extension in the client hello.
     */</comment>
    <expr_stmt pos:start="2388:5" pos:end="2388:52"><expr pos:start="2388:5" pos:end="2388:51"><call pos:start="2388:5" pos:end="2388:51"><name pos:start="2388:5" pos:end="2388:28">SSL_set_tlsext_host_name</name><argument_list pos:start="2388:29" pos:end="2388:51">(<argument pos:start="2388:30" pos:end="2388:33"><expr pos:start="2388:30" pos:end="2388:33"><operator pos:start="2388:30" pos:end="2388:30">*</operator><name pos:start="2388:31" pos:end="2388:33">ssl</name></expr></argument>, <argument pos:start="2388:36" pos:end="2388:50"><expr pos:start="2388:36" pos:end="2388:50"><name pos:start="2388:36" pos:end="2388:50"><name pos:start="2388:36" pos:end="2388:38">ctx</name><operator pos:start="2388:39" pos:end="2388:40">-&gt;</operator><name pos:start="2388:41" pos:end="2388:50">est_server</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <expr_stmt pos:start="2390:5" pos:end="2390:32"><expr pos:start="2390:5" pos:end="2390:31"><call pos:start="2390:5" pos:end="2390:31"><name pos:start="2390:5" pos:end="2390:15">SSL_set_bio</name><argument_list pos:start="2390:16" pos:end="2390:31">(<argument pos:start="2390:17" pos:end="2390:20"><expr pos:start="2390:17" pos:end="2390:20"><operator pos:start="2390:17" pos:end="2390:17">*</operator><name pos:start="2390:18" pos:end="2390:20">ssl</name></expr></argument>, <argument pos:start="2390:23" pos:end="2390:25"><expr pos:start="2390:23" pos:end="2390:25"><name pos:start="2390:23" pos:end="2390:25">tcp</name></expr></argument>, <argument pos:start="2390:28" pos:end="2390:30"><expr pos:start="2390:28" pos:end="2390:30"><name pos:start="2390:28" pos:end="2390:30">tcp</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2391:5" pos:end="2393:5"><if pos:start="2391:5" pos:end="2393:5">if <condition pos:start="2391:8" pos:end="2391:18">(<expr pos:start="2391:9" pos:end="2391:17"><name pos:start="2391:9" pos:end="2391:17"><name pos:start="2391:9" pos:end="2391:11">ctx</name><operator pos:start="2391:12" pos:end="2391:13">-&gt;</operator><name pos:start="2391:14" pos:end="2391:17">sess</name></name></expr>)</condition> <block pos:start="2391:20" pos:end="2393:5">{<block_content pos:start="2392:9" pos:end="2392:41">
	<expr_stmt pos:start="2392:9" pos:end="2392:41"><expr pos:start="2392:9" pos:end="2392:40"><call pos:start="2392:9" pos:end="2392:40"><name pos:start="2392:9" pos:end="2392:23">SSL_set_session</name><argument_list pos:start="2392:24" pos:end="2392:40">(<argument pos:start="2392:25" pos:end="2392:28"><expr pos:start="2392:25" pos:end="2392:28"><operator pos:start="2392:25" pos:end="2392:25">*</operator><name pos:start="2392:26" pos:end="2392:28">ssl</name></expr></argument>, <argument pos:start="2392:31" pos:end="2392:39"><expr pos:start="2392:31" pos:end="2392:39"><name pos:start="2392:31" pos:end="2392:39"><name pos:start="2392:31" pos:end="2392:33">ctx</name><operator pos:start="2392:34" pos:end="2392:35">-&gt;</operator><name pos:start="2392:36" pos:end="2392:39">sess</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    <if_stmt pos:start="2394:5" pos:end="2402:5"><if pos:start="2394:5" pos:end="2400:5">if <condition pos:start="2394:8" pos:end="2394:51">(<expr pos:start="2394:9" pos:end="2394:50"><operator pos:start="2394:9" pos:end="2394:9">(</operator><name pos:start="2394:10" pos:end="2394:24">ssl_connect_ret</name> <operator pos:start="2394:26" pos:end="2394:26">=</operator> <call pos:start="2394:28" pos:end="2394:44"><name pos:start="2394:28" pos:end="2394:38">SSL_connect</name><argument_list pos:start="2394:39" pos:end="2394:44">(<argument pos:start="2394:40" pos:end="2394:43"><expr pos:start="2394:40" pos:end="2394:43"><operator pos:start="2394:40" pos:end="2394:40">*</operator><name pos:start="2394:41" pos:end="2394:43">ssl</name></expr></argument>)</argument_list></call><operator pos:start="2394:45" pos:end="2394:45">)</operator> <operator pos:start="2394:47" pos:end="2394:48">&lt;=</operator> <literal type="number" pos:start="2394:50" pos:end="2394:50">0</literal></expr>)</condition> <block pos:start="2394:53" pos:end="2400:5">{<block_content pos:start="2395:9" pos:end="2399:33">
        <expr_stmt pos:start="2395:9" pos:end="2395:94"><expr pos:start="2395:9" pos:end="2395:93"><call pos:start="2395:9" pos:end="2395:93"><name pos:start="2395:9" pos:end="2395:19">EST_LOG_ERR</name><argument_list pos:start="2395:20" pos:end="2395:93">(<argument pos:start="2395:21" pos:end="2395:54"><expr pos:start="2395:21" pos:end="2395:54"><literal type="string" pos:start="2395:21" pos:end="2395:54">"Error connecting TLS context. %d"</literal></expr></argument>, <argument pos:start="2395:57" pos:end="2395:92"><expr pos:start="2395:57" pos:end="2395:92"><call pos:start="2395:57" pos:end="2395:92"><name pos:start="2395:57" pos:end="2395:69">SSL_get_error</name><argument_list pos:start="2395:70" pos:end="2395:92">(<argument pos:start="2395:71" pos:end="2395:74"><expr pos:start="2395:71" pos:end="2395:74"><operator pos:start="2395:71" pos:end="2395:71">*</operator><name pos:start="2395:72" pos:end="2395:74">ssl</name></expr></argument>, <argument pos:start="2395:77" pos:end="2395:91"><expr pos:start="2395:77" pos:end="2395:91"><name pos:start="2395:77" pos:end="2395:91">ssl_connect_ret</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2396:9" pos:end="2396:31"><expr pos:start="2396:9" pos:end="2396:30"><call pos:start="2396:9" pos:end="2396:30"><name pos:start="2396:9" pos:end="2396:28">ossl_dump_ssl_errors</name><argument_list pos:start="2396:29" pos:end="2396:30">()</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2397:9" pos:end="2397:34"><expr pos:start="2397:9" pos:end="2397:33"><call pos:start="2397:9" pos:end="2397:33"><name pos:start="2397:9" pos:end="2397:17">tcw_close</name><argument_list pos:start="2397:18" pos:end="2397:33">(<argument pos:start="2397:19" pos:end="2397:32"><expr pos:start="2397:19" pos:end="2397:32"><operator pos:start="2397:19" pos:end="2397:19">&amp;</operator><name pos:start="2397:20" pos:end="2397:32"><name pos:start="2397:20" pos:end="2397:22">ctx</name><operator pos:start="2397:23" pos:end="2397:24">-&gt;</operator><name pos:start="2397:25" pos:end="2397:32">tcw_sock</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2398:9" pos:end="2398:28"><expr pos:start="2398:9" pos:end="2398:27"><name pos:start="2398:9" pos:end="2398:12">sock</name> <operator pos:start="2398:14" pos:end="2398:14">=</operator> <name pos:start="2398:16" pos:end="2398:27">SOCK_INVALID</name></expr>;</expr_stmt>
        <expr_stmt pos:start="2399:9" pos:end="2399:33"><expr pos:start="2399:9" pos:end="2399:32"><name pos:start="2399:9" pos:end="2399:10">rv</name> <operator pos:start="2399:12" pos:end="2399:12">=</operator> <name pos:start="2399:14" pos:end="2399:32">EST_ERR_SSL_CONNECT</name></expr>;</expr_stmt>
    </block_content>}</block></if> <else pos:start="2400:7" pos:end="2402:5">else <block pos:start="2400:12" pos:end="2402:5">{<block_content pos:start="2401:9" pos:end="2401:36">
        <expr_stmt pos:start="2401:9" pos:end="2401:36"><expr pos:start="2401:9" pos:end="2401:35"><name pos:start="2401:9" pos:end="2401:31"><name pos:start="2401:9" pos:end="2401:11">ctx</name><operator pos:start="2401:12" pos:end="2401:13">-&gt;</operator><name pos:start="2401:14" pos:end="2401:31">tcw_sock_connected</name></name> <operator pos:start="2401:33" pos:end="2401:33">=</operator> <literal type="number" pos:start="2401:35" pos:end="2401:35">1</literal></expr>;</expr_stmt>
    </block_content>}</block></else></if_stmt>

    <comment type="block" pos:start="2404:5" pos:end="2409:7">/*
     * Now that we've established a TLS session with the EST server,
     * we need to verify that the FQDN in the server cert matches
     * the server name we used to establish the connection.
     * This is from section 3.6 in the EST spec.
     */</comment>
    <if_stmt pos:start="2410:5" pos:end="2417:5"><if pos:start="2410:5" pos:end="2417:5">if <condition pos:start="2410:8" pos:end="2410:65">(<expr pos:start="2410:9" pos:end="2410:64"><operator pos:start="2410:9" pos:end="2410:9">(</operator><name pos:start="2410:10" pos:end="2410:21">EST_ERR_NONE</name> <operator pos:start="2410:23" pos:end="2410:24">==</operator> <name pos:start="2410:26" pos:end="2410:27">rv</name><operator pos:start="2410:28" pos:end="2410:28">)</operator> <operator pos:start="2410:30" pos:end="2410:31">&amp;&amp;</operator> <call pos:start="2410:33" pos:end="2410:64"><name pos:start="2410:33" pos:end="2410:53">est_client_check_fqdn</name><argument_list pos:start="2410:54" pos:end="2410:64">(<argument pos:start="2410:55" pos:end="2410:57"><expr pos:start="2410:55" pos:end="2410:57"><name pos:start="2410:55" pos:end="2410:57">ctx</name></expr></argument>, <argument pos:start="2410:60" pos:end="2410:63"><expr pos:start="2410:60" pos:end="2410:63"><operator pos:start="2410:60" pos:end="2410:60">*</operator><name pos:start="2410:61" pos:end="2410:63">ssl</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="2410:67" pos:end="2417:5">{<block_content pos:start="2414:9" pos:end="2416:35">
	<comment type="block" pos:start="2411:9" pos:end="2413:11">/*
	 * The host name did not match, shut down the tunnel and bail
	 */</comment>
	<expr_stmt pos:start="2414:9" pos:end="2414:40"><expr pos:start="2414:9" pos:end="2414:39"><call pos:start="2414:9" pos:end="2414:39"><name pos:start="2414:9" pos:end="2414:29">est_client_disconnect</name><argument_list pos:start="2414:30" pos:end="2414:39">(<argument pos:start="2414:31" pos:end="2414:33"><expr pos:start="2414:31" pos:end="2414:33"><name pos:start="2414:31" pos:end="2414:33">ctx</name></expr></argument>, <argument pos:start="2414:36" pos:end="2414:38"><expr pos:start="2414:36" pos:end="2414:38"><name pos:start="2414:36" pos:end="2414:38">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2415:9" pos:end="2415:82"><expr pos:start="2415:9" pos:end="2415:81"><call pos:start="2415:9" pos:end="2415:81"><name pos:start="2415:9" pos:end="2415:20">EST_LOG_WARN</name><argument_list pos:start="2415:21" pos:end="2415:81">(<argument pos:start="2415:22" pos:end="2415:80"><expr pos:start="2415:22" pos:end="2415:80"><literal type="string" pos:start="2415:22" pos:end="2415:80">"EST server name did not match FQDN in server certificate."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2416:9" pos:end="2416:35"><expr pos:start="2416:9" pos:end="2416:34"><name pos:start="2416:9" pos:end="2416:10">rv</name> <operator pos:start="2416:12" pos:end="2416:12">=</operator> <name pos:start="2416:14" pos:end="2416:34">EST_ERR_FQDN_MISMATCH</name></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>

    <return pos:start="2419:5" pos:end="2419:14">return <expr pos:start="2419:12" pos:end="2419:13"><name pos:start="2419:12" pos:end="2419:13">rv</name></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="2421:1" pos:end="2427:3">/*
 * This function will close the TLS session and the underlying socket.
 *
 * Parameters:
 *	ssl:	    Pointer to SSL context that has been set up for this connection
 *                  to the EST server.
 */</comment>
<function pos:start="2428:1" pos:end="2461:1"><type pos:start="2428:1" pos:end="2428:4"><name pos:start="2428:1" pos:end="2428:4">void</name></type> <name pos:start="2428:6" pos:end="2428:26">est_client_disconnect</name> <parameter_list pos:start="2428:28" pos:end="2428:52">(<parameter pos:start="2428:29" pos:end="2428:40"><decl pos:start="2428:29" pos:end="2428:40"><type pos:start="2428:29" pos:end="2428:40"><name pos:start="2428:29" pos:end="2428:35">EST_CTX</name> <modifier pos:start="2428:37" pos:end="2428:37">*</modifier></type><name pos:start="2428:38" pos:end="2428:40">ctx</name></decl></parameter>, <parameter pos:start="2428:43" pos:end="2428:51"><decl pos:start="2428:43" pos:end="2428:51"><type pos:start="2428:43" pos:end="2428:51"><name pos:start="2428:43" pos:end="2428:45">SSL</name> <modifier pos:start="2428:47" pos:end="2428:47">*</modifier><modifier pos:start="2428:48" pos:end="2428:48">*</modifier></type><name pos:start="2428:49" pos:end="2428:51">ssl</name></decl></parameter>)</parameter_list>
<block pos:start="2429:1" pos:end="2461:1">{<block_content pos:start="2430:5" pos:end="2460:5">
    <decl_stmt pos:start="2430:5" pos:end="2430:26"><decl pos:start="2430:5" pos:end="2430:25"><type pos:start="2430:5" pos:end="2430:17"><name pos:start="2430:5" pos:end="2430:15">SSL_SESSION</name> <modifier pos:start="2430:17" pos:end="2430:17">*</modifier></type><name pos:start="2430:18" pos:end="2430:25">new_sess</name></decl>;</decl_stmt>
    
    <if_stmt pos:start="2432:5" pos:end="2434:5"><if pos:start="2432:5" pos:end="2434:5">if <condition pos:start="2432:8" pos:end="2432:14">(<expr pos:start="2432:9" pos:end="2432:13"><operator pos:start="2432:9" pos:end="2432:9">!</operator><operator pos:start="2432:10" pos:end="2432:10">*</operator><name pos:start="2432:11" pos:end="2432:13">ssl</name></expr>)</condition> <block pos:start="2432:16" pos:end="2434:5">{<block_content pos:start="2433:9" pos:end="2433:15">
        <return pos:start="2433:9" pos:end="2433:15">return;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="2436:5" pos:end="2439:7">/*
     * if first disconnect, get the session id to cache it away to use for
     * session resumption.
     */</comment>
    <if_stmt pos:start="2440:5" pos:end="2451:5"><if pos:start="2440:5" pos:end="2442:5">if <condition pos:start="2440:8" pos:end="2440:19">(<expr pos:start="2440:9" pos:end="2440:18"><operator pos:start="2440:9" pos:end="2440:9">!</operator><name pos:start="2440:10" pos:end="2440:18"><name pos:start="2440:10" pos:end="2440:12">ctx</name><operator pos:start="2440:13" pos:end="2440:14">-&gt;</operator><name pos:start="2440:15" pos:end="2440:18">sess</name></name></expr>)</condition> <block pos:start="2440:21" pos:end="2442:5">{<block_content pos:start="2441:9" pos:end="2441:43">
	<expr_stmt pos:start="2441:9" pos:end="2441:43"><expr pos:start="2441:9" pos:end="2441:42"><name pos:start="2441:9" pos:end="2441:17"><name pos:start="2441:9" pos:end="2441:11">ctx</name><operator pos:start="2441:12" pos:end="2441:13">-&gt;</operator><name pos:start="2441:14" pos:end="2441:17">sess</name></name> <operator pos:start="2441:19" pos:end="2441:19">=</operator> <call pos:start="2441:21" pos:end="2441:42"><name pos:start="2441:21" pos:end="2441:36">SSL_get1_session</name><argument_list pos:start="2441:37" pos:end="2441:42">(<argument pos:start="2441:38" pos:end="2441:41"><expr pos:start="2441:38" pos:end="2441:41"><operator pos:start="2441:38" pos:end="2441:38">*</operator><name pos:start="2441:39" pos:end="2441:41">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if> <else pos:start="2442:7" pos:end="2451:5">else <block pos:start="2442:12" pos:end="2451:5">{<block_content pos:start="2447:9" pos:end="2450:9">
        <comment type="block" pos:start="2443:9" pos:end="2446:11">/*
         * if not the first time to disconnect, see if the session id changed.
         * If it did, officially re-obtain it with a get1 call and cache it away
         */</comment>
        <expr_stmt pos:start="2447:9" pos:end="2447:42"><expr pos:start="2447:9" pos:end="2447:41"><name pos:start="2447:9" pos:end="2447:16">new_sess</name> <operator pos:start="2447:18" pos:end="2447:18">=</operator> <call pos:start="2447:20" pos:end="2447:41"><name pos:start="2447:20" pos:end="2447:35">SSL_get0_session</name><argument_list pos:start="2447:36" pos:end="2447:41">(<argument pos:start="2447:37" pos:end="2447:40"><expr pos:start="2447:37" pos:end="2447:40"><operator pos:start="2447:37" pos:end="2447:37">*</operator><name pos:start="2447:38" pos:end="2447:40">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="2448:9" pos:end="2450:9"><if pos:start="2448:9" pos:end="2450:9">if <condition pos:start="2448:12" pos:end="2448:34">(<expr pos:start="2448:13" pos:end="2448:33"><name pos:start="2448:13" pos:end="2448:20">new_sess</name> <operator pos:start="2448:22" pos:end="2448:23">!=</operator> <name pos:start="2448:25" pos:end="2448:33"><name pos:start="2448:25" pos:end="2448:27">ctx</name><operator pos:start="2448:28" pos:end="2448:29">-&gt;</operator><name pos:start="2448:30" pos:end="2448:33">sess</name></name></expr>)</condition> <block pos:start="2448:36" pos:end="2450:9">{<block_content pos:start="2449:13" pos:end="2449:47">
            <expr_stmt pos:start="2449:13" pos:end="2449:47"><expr pos:start="2449:13" pos:end="2449:46"><name pos:start="2449:13" pos:end="2449:21"><name pos:start="2449:13" pos:end="2449:15">ctx</name><operator pos:start="2449:16" pos:end="2449:17">-&gt;</operator><name pos:start="2449:18" pos:end="2449:21">sess</name></name> <operator pos:start="2449:23" pos:end="2449:23">=</operator> <call pos:start="2449:25" pos:end="2449:46"><name pos:start="2449:25" pos:end="2449:40">SSL_get1_session</name><argument_list pos:start="2449:41" pos:end="2449:46">(<argument pos:start="2449:42" pos:end="2449:45"><expr pos:start="2449:42" pos:end="2449:45"><operator pos:start="2449:42" pos:end="2449:42">*</operator><name pos:start="2449:43" pos:end="2449:45">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></if></if_stmt>
    </block_content>}</block></else></if_stmt>
    
    <expr_stmt pos:start="2453:5" pos:end="2453:23"><expr pos:start="2453:5" pos:end="2453:22"><call pos:start="2453:5" pos:end="2453:22"><name pos:start="2453:5" pos:end="2453:16">SSL_shutdown</name><argument_list pos:start="2453:17" pos:end="2453:22">(<argument pos:start="2453:18" pos:end="2453:21"><expr pos:start="2453:18" pos:end="2453:21"><operator pos:start="2453:18" pos:end="2453:18">*</operator><name pos:start="2453:19" pos:end="2453:21">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="2454:5" pos:end="2454:19"><expr pos:start="2454:5" pos:end="2454:18"><call pos:start="2454:5" pos:end="2454:18"><name pos:start="2454:5" pos:end="2454:12">SSL_free</name><argument_list pos:start="2454:13" pos:end="2454:18">(<argument pos:start="2454:14" pos:end="2454:17"><expr pos:start="2454:14" pos:end="2454:17"><operator pos:start="2454:14" pos:end="2454:14">*</operator><name pos:start="2454:15" pos:end="2454:17">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="2455:5" pos:end="2455:16"><expr pos:start="2455:5" pos:end="2455:15"><operator pos:start="2455:5" pos:end="2455:5">*</operator><name pos:start="2455:6" pos:end="2455:8">ssl</name> <operator pos:start="2455:10" pos:end="2455:10">=</operator> <name pos:start="2455:12" pos:end="2455:15">NULL</name></expr>;</expr_stmt>

    <if_stmt pos:start="2457:5" pos:end="2460:5"><if pos:start="2457:5" pos:end="2460:5">if <condition pos:start="2457:8" pos:end="2457:32">(<expr pos:start="2457:9" pos:end="2457:31"><name pos:start="2457:9" pos:end="2457:31"><name pos:start="2457:9" pos:end="2457:11">ctx</name><operator pos:start="2457:12" pos:end="2457:13">-&gt;</operator><name pos:start="2457:14" pos:end="2457:31">tcw_sock_connected</name></name></expr>)</condition> <block pos:start="2457:34" pos:end="2460:5">{<block_content pos:start="2458:9" pos:end="2459:36">
        <expr_stmt pos:start="2458:9" pos:end="2458:34"><expr pos:start="2458:9" pos:end="2458:33"><call pos:start="2458:9" pos:end="2458:33"><name pos:start="2458:9" pos:end="2458:17">tcw_close</name><argument_list pos:start="2458:18" pos:end="2458:33">(<argument pos:start="2458:19" pos:end="2458:32"><expr pos:start="2458:19" pos:end="2458:32"><operator pos:start="2458:19" pos:end="2458:19">&amp;</operator><name pos:start="2458:20" pos:end="2458:32"><name pos:start="2458:20" pos:end="2458:22">ctx</name><operator pos:start="2458:23" pos:end="2458:24">-&gt;</operator><name pos:start="2458:25" pos:end="2458:32">tcw_sock</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2459:9" pos:end="2459:36"><expr pos:start="2459:9" pos:end="2459:35"><name pos:start="2459:9" pos:end="2459:31"><name pos:start="2459:9" pos:end="2459:11">ctx</name><operator pos:start="2459:12" pos:end="2459:13">-&gt;</operator><name pos:start="2459:14" pos:end="2459:31">tcw_sock_connected</name></name> <operator pos:start="2459:33" pos:end="2459:33">=</operator> <literal type="number" pos:start="2459:35" pos:end="2459:35">0</literal></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
</block_content>}</block></function>
<comment type="block" pos:start="2462:1" pos:end="2470:3">/*
 * This function does the work for the CACerts request flow.
 *
 * Parameters:
 *	ctx:	    EST context
 *	ssl:	    SSL context
 *      ca_certs_len: pointer to the unsigned int that will hold the length of the
 *                    returned CA certs.
 */</comment>
<function pos:start="2471:1" pos:end="2608:1"><type pos:start="2471:1" pos:end="2471:10"><specifier pos:start="2471:1" pos:end="2471:6">static</specifier> <name pos:start="2471:8" pos:end="2471:10">int</name></type> <name pos:start="2471:12" pos:end="2471:42">est_client_send_cacerts_request</name> <parameter_list pos:start="2471:44" pos:end="2472:62">(<parameter pos:start="2471:45" pos:end="2471:56"><decl pos:start="2471:45" pos:end="2471:56"><type pos:start="2471:45" pos:end="2471:56"><name pos:start="2471:45" pos:end="2471:51">EST_CTX</name> <modifier pos:start="2471:53" pos:end="2471:53">*</modifier></type><name pos:start="2471:54" pos:end="2471:56">ctx</name></decl></parameter>, <parameter pos:start="2471:59" pos:end="2471:66"><decl pos:start="2471:59" pos:end="2471:66"><type pos:start="2471:59" pos:end="2471:66"><name pos:start="2471:59" pos:end="2471:61">SSL</name> <modifier pos:start="2471:63" pos:end="2471:63">*</modifier></type><name pos:start="2471:64" pos:end="2471:66">ssl</name></decl></parameter>,
                                            <parameter pos:start="2472:45" pos:end="2472:61"><decl pos:start="2472:45" pos:end="2472:61"><type pos:start="2472:45" pos:end="2472:61"><name pos:start="2472:45" pos:end="2472:47">int</name> <modifier pos:start="2472:49" pos:end="2472:49">*</modifier></type><name pos:start="2472:50" pos:end="2472:61">ca_certs_len</name></decl></parameter>)</parameter_list>
<block pos:start="2473:1" pos:end="2608:1">{<block_content pos:start="2474:5" pos:end="2607:16">
    <decl_stmt pos:start="2474:5" pos:end="2474:20"><decl pos:start="2474:5" pos:end="2474:19"><type pos:start="2474:5" pos:end="2474:10"><name pos:start="2474:5" pos:end="2474:8">char</name> <modifier pos:start="2474:10" pos:end="2474:10">*</modifier></type><name pos:start="2474:11" pos:end="2474:19">http_data</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2475:5" pos:end="2475:17"><decl pos:start="2475:5" pos:end="2475:16"><type pos:start="2475:5" pos:end="2475:7"><name pos:start="2475:5" pos:end="2475:7">int</name></type>  <name pos:start="2475:10" pos:end="2475:16">hdr_len</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2476:5" pos:end="2476:20"><decl pos:start="2476:5" pos:end="2476:19"><type pos:start="2476:5" pos:end="2476:7"><name pos:start="2476:5" pos:end="2476:7">int</name></type>  <name pos:start="2476:10" pos:end="2476:19">write_size</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2477:5" pos:end="2477:12"><decl pos:start="2477:5" pos:end="2477:11"><type pos:start="2477:5" pos:end="2477:7"><name pos:start="2477:5" pos:end="2477:7">int</name></type>  <name pos:start="2477:10" pos:end="2477:11">rv</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2478:5" pos:end="2478:39"><decl pos:start="2478:5" pos:end="2478:38"><type pos:start="2478:5" pos:end="2478:19"><name pos:start="2478:5" pos:end="2478:12">unsigned</name> <name pos:start="2478:14" pos:end="2478:17">char</name> <modifier pos:start="2478:19" pos:end="2478:19">*</modifier></type><name pos:start="2478:20" pos:end="2478:31">ca_certs_buf</name> <init pos:start="2478:33" pos:end="2478:38">= <expr pos:start="2478:35" pos:end="2478:38"><name pos:start="2478:35" pos:end="2478:38">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="2479:5" pos:end="2479:30"><decl pos:start="2479:5" pos:end="2479:29"><type pos:start="2479:5" pos:end="2479:7"><name pos:start="2479:5" pos:end="2479:7">int</name></type>  <name pos:start="2479:10" pos:end="2479:25">ca_certs_buf_len</name> <init pos:start="2479:27" pos:end="2479:29">= <expr pos:start="2479:29" pos:end="2479:29"><literal type="number" pos:start="2479:29" pos:end="2479:29">0</literal></expr></init></decl>;</decl_stmt>

    <comment type="block" pos:start="2481:5" pos:end="2487:7">/*
     * Build the HTTP request
     * - allocate buffer: header, no data, terminating characters
     * - build the header
     * - no data
     * - terminate it
     */</comment>
    <expr_stmt pos:start="2488:5" pos:end="2488:47"><expr pos:start="2488:5" pos:end="2488:46"><name pos:start="2488:5" pos:end="2488:13">http_data</name> <operator pos:start="2488:15" pos:end="2488:15">=</operator> <call pos:start="2488:17" pos:end="2488:46"><name pos:start="2488:17" pos:end="2488:22">malloc</name><argument_list pos:start="2488:23" pos:end="2488:46">(<argument pos:start="2488:24" pos:end="2488:45"><expr pos:start="2488:24" pos:end="2488:45"><name pos:start="2488:24" pos:end="2488:45">EST_HTTP_REQ_TOTAL_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2489:5" pos:end="2492:5"><if pos:start="2489:5" pos:end="2492:5">if <condition pos:start="2489:8" pos:end="2489:26">(<expr pos:start="2489:9" pos:end="2489:25"><name pos:start="2489:9" pos:end="2489:17">http_data</name> <operator pos:start="2489:19" pos:end="2489:20">==</operator> <name pos:start="2489:22" pos:end="2489:25">NULL</name></expr>)</condition> <block pos:start="2489:28" pos:end="2492:5">{<block_content pos:start="2490:9" pos:end="2491:30">
        <expr_stmt pos:start="2490:9" pos:end="2490:63"><expr pos:start="2490:9" pos:end="2490:62"><call pos:start="2490:9" pos:end="2490:62"><name pos:start="2490:9" pos:end="2490:19">EST_LOG_ERR</name><argument_list pos:start="2490:20" pos:end="2490:62">(<argument pos:start="2490:21" pos:end="2490:61"><expr pos:start="2490:21" pos:end="2490:61"><literal type="string" pos:start="2490:21" pos:end="2490:61">"Unable to allocate memory for http_data"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="2491:9" pos:end="2491:30">return <expr pos:start="2491:16" pos:end="2491:29"><name pos:start="2491:16" pos:end="2491:29">EST_ERR_MALLOC</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    
    <expr_stmt pos:start="2494:5" pos:end="2494:62"><expr pos:start="2494:5" pos:end="2494:61"><name pos:start="2494:5" pos:end="2494:11">hdr_len</name> <operator pos:start="2494:13" pos:end="2494:13">=</operator> <call pos:start="2494:15" pos:end="2494:61"><name pos:start="2494:15" pos:end="2494:45">est_client_build_cacerts_header</name><argument_list pos:start="2494:46" pos:end="2494:61">(<argument pos:start="2494:47" pos:end="2494:49"><expr pos:start="2494:47" pos:end="2494:49"><name pos:start="2494:47" pos:end="2494:49">ctx</name></expr></argument>, <argument pos:start="2494:52" pos:end="2494:60"><expr pos:start="2494:52" pos:end="2494:60"><name pos:start="2494:52" pos:end="2494:60">http_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <comment type="block" pos:start="2495:5" pos:end="2497:7">/*
     * terminate the HTTP header
     */</comment>
    <expr_stmt pos:start="2498:5" pos:end="2498:73"><expr pos:start="2498:5" pos:end="2498:72"><call pos:start="2498:5" pos:end="2498:72"><name pos:start="2498:5" pos:end="2498:12">snprintf</name><argument_list pos:start="2498:13" pos:end="2498:72">(<argument pos:start="2498:14" pos:end="2498:32"><expr pos:start="2498:14" pos:end="2498:32"><name pos:start="2498:14" pos:end="2498:22">http_data</name> <operator pos:start="2498:24" pos:end="2498:24">+</operator> <name pos:start="2498:26" pos:end="2498:32">hdr_len</name></expr></argument>, <argument pos:start="2498:35" pos:end="2498:64"><expr pos:start="2498:35" pos:end="2498:64"><name pos:start="2498:35" pos:end="2498:56">EST_HTTP_REQ_TOTAL_LEN</name><operator pos:start="2498:57" pos:end="2498:57">-</operator><name pos:start="2498:58" pos:end="2498:64">hdr_len</name></expr></argument>,<argument pos:start="2498:66" pos:end="2498:71"><expr pos:start="2498:66" pos:end="2498:71"><literal type="string" pos:start="2498:66" pos:end="2498:71">"\r\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="2499:5" pos:end="2499:17"><expr pos:start="2499:5" pos:end="2499:16"><name pos:start="2499:5" pos:end="2499:11">hdr_len</name> <operator pos:start="2499:13" pos:end="2499:14">+=</operator> <literal type="number" pos:start="2499:16" pos:end="2499:16">2</literal></expr>;</expr_stmt>

    <comment type="block" pos:start="2501:5" pos:end="2503:7">/*
     * no data is being sent so go ahead and terminate the HTTP request
     */</comment>
    <expr_stmt pos:start="2504:5" pos:end="2504:73"><expr pos:start="2504:5" pos:end="2504:72"><call pos:start="2504:5" pos:end="2504:72"><name pos:start="2504:5" pos:end="2504:12">snprintf</name><argument_list pos:start="2504:13" pos:end="2504:72">(<argument pos:start="2504:14" pos:end="2504:32"><expr pos:start="2504:14" pos:end="2504:32"><name pos:start="2504:14" pos:end="2504:22">http_data</name> <operator pos:start="2504:24" pos:end="2504:24">+</operator> <name pos:start="2504:26" pos:end="2504:32">hdr_len</name></expr></argument>,<argument pos:start="2504:34" pos:end="2504:63"><expr pos:start="2504:34" pos:end="2504:63"><name pos:start="2504:34" pos:end="2504:55">EST_HTTP_REQ_TOTAL_LEN</name><operator pos:start="2504:56" pos:end="2504:56">-</operator><name pos:start="2504:57" pos:end="2504:63">hdr_len</name></expr></argument>, <argument pos:start="2504:66" pos:end="2504:71"><expr pos:start="2504:66" pos:end="2504:71"><literal type="string" pos:start="2504:66" pos:end="2504:71">"\r\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="2505:5" pos:end="2505:17"><expr pos:start="2505:5" pos:end="2505:16"><name pos:start="2505:5" pos:end="2505:11">hdr_len</name> <operator pos:start="2505:13" pos:end="2505:14">+=</operator> <literal type="number" pos:start="2505:16" pos:end="2505:16">2</literal></expr>;</expr_stmt>
    
    <comment type="block" pos:start="2507:5" pos:end="2509:7">/*
     * Send the request to the server and wait for a response
     */</comment>
    <expr_stmt pos:start="2510:5" pos:end="2510:30"><expr pos:start="2510:5" pos:end="2510:29"><name pos:start="2510:5" pos:end="2510:25"><name pos:start="2510:5" pos:end="2510:7">ctx</name><operator pos:start="2510:8" pos:end="2510:9">-&gt;</operator><name pos:start="2510:10" pos:end="2510:25">last_http_status</name></name> <operator pos:start="2510:27" pos:end="2510:27">=</operator> <literal type="number" pos:start="2510:29" pos:end="2510:29">0</literal></expr>;</expr_stmt>
    <expr_stmt pos:start="2511:5" pos:end="2511:52"><expr pos:start="2511:5" pos:end="2511:51"><name pos:start="2511:5" pos:end="2511:14">write_size</name> <operator pos:start="2511:16" pos:end="2511:16">=</operator> <call pos:start="2511:18" pos:end="2511:51"><name pos:start="2511:18" pos:end="2511:26">SSL_write</name><argument_list pos:start="2511:27" pos:end="2511:51">(<argument pos:start="2511:28" pos:end="2511:30"><expr pos:start="2511:28" pos:end="2511:30"><name pos:start="2511:28" pos:end="2511:30">ssl</name></expr></argument>, <argument pos:start="2511:33" pos:end="2511:41"><expr pos:start="2511:33" pos:end="2511:41"><name pos:start="2511:33" pos:end="2511:41">http_data</name></expr></argument>, <argument pos:start="2511:44" pos:end="2511:50"><expr pos:start="2511:44" pos:end="2511:50"><name pos:start="2511:44" pos:end="2511:50">hdr_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2512:5" pos:end="2598:5"><if pos:start="2512:5" pos:end="2516:5">if <condition pos:start="2512:8" pos:end="2512:23">(<expr pos:start="2512:9" pos:end="2512:22"><name pos:start="2512:9" pos:end="2512:18">write_size</name> <operator pos:start="2512:20" pos:end="2512:20">&lt;</operator> <literal type="number" pos:start="2512:22" pos:end="2512:22">0</literal></expr>)</condition> <block pos:start="2512:25" pos:end="2516:5">{<block_content pos:start="2513:9" pos:end="2515:31">
        <expr_stmt pos:start="2513:9" pos:end="2513:39"><expr pos:start="2513:9" pos:end="2513:38"><call pos:start="2513:9" pos:end="2513:38"><name pos:start="2513:9" pos:end="2513:19">EST_LOG_ERR</name><argument_list pos:start="2513:20" pos:end="2513:38">(<argument pos:start="2513:21" pos:end="2513:37"><expr pos:start="2513:21" pos:end="2513:37"><literal type="string" pos:start="2513:21" pos:end="2513:37">"TLS write error"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt pos:start="2514:9" pos:end="2514:31"><expr pos:start="2514:9" pos:end="2514:30"><call pos:start="2514:9" pos:end="2514:30"><name pos:start="2514:9" pos:end="2514:28">ossl_dump_ssl_errors</name><argument_list pos:start="2514:29" pos:end="2514:30">()</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2515:9" pos:end="2515:31"><expr pos:start="2515:9" pos:end="2515:30"><name pos:start="2515:9" pos:end="2515:10">rv</name> <operator pos:start="2515:12" pos:end="2515:12">=</operator> <name pos:start="2515:14" pos:end="2515:30">EST_ERR_SSL_WRITE</name></expr>;</expr_stmt>
    </block_content>}</block></if> <else pos:start="2516:7" pos:end="2598:5">else <block pos:start="2516:12" pos:end="2598:5">{<block_content pos:start="2517:9" pos:end="2597:9">
        <expr_stmt pos:start="2517:9" pos:end="2518:42"><expr pos:start="2517:9" pos:end="2518:41"><call pos:start="2517:9" pos:end="2518:41"><name pos:start="2517:9" pos:end="2517:20">EST_LOG_INFO</name><argument_list pos:start="2517:21" pos:end="2518:41">(<argument pos:start="2517:22" pos:end="2517:63"><expr pos:start="2517:22" pos:end="2517:63"><literal type="string" pos:start="2517:22" pos:end="2517:63">"TLS wrote %d bytes, attempted %d bytes\n"</literal></expr></argument>,
                     <argument pos:start="2518:22" pos:end="2518:31"><expr pos:start="2518:22" pos:end="2518:31"><name pos:start="2518:22" pos:end="2518:31">write_size</name></expr></argument>, <argument pos:start="2518:34" pos:end="2518:40"><expr pos:start="2518:34" pos:end="2518:40"><name pos:start="2518:34" pos:end="2518:40">hdr_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

        <comment type="block" pos:start="2520:9" pos:end="2522:11">/*
         * Try to get the response from the server
         */</comment>
        <expr_stmt pos:start="2523:9" pos:end="2524:67"><expr pos:start="2523:9" pos:end="2524:66"><name pos:start="2523:9" pos:end="2523:10">rv</name> <operator pos:start="2523:12" pos:end="2523:12">=</operator> <call pos:start="2523:14" pos:end="2524:66"><name pos:start="2523:14" pos:end="2523:32">est_io_get_response</name><argument_list pos:start="2523:33" pos:end="2524:66">(<argument pos:start="2523:34" pos:end="2523:36"><expr pos:start="2523:34" pos:end="2523:36"><name pos:start="2523:34" pos:end="2523:36">ctx</name></expr></argument>, <argument pos:start="2523:39" pos:end="2523:41"><expr pos:start="2523:39" pos:end="2523:41"><name pos:start="2523:39" pos:end="2523:41">ssl</name></expr></argument>, <argument pos:start="2523:44" pos:end="2523:57"><expr pos:start="2523:44" pos:end="2523:57"><name pos:start="2523:44" pos:end="2523:57">EST_OP_CACERTS</name></expr></argument>,
                                 <argument pos:start="2524:34" pos:end="2524:46"><expr pos:start="2524:34" pos:end="2524:46"><operator pos:start="2524:34" pos:end="2524:34">&amp;</operator><name pos:start="2524:35" pos:end="2524:46">ca_certs_buf</name></expr></argument>, <argument pos:start="2524:49" pos:end="2524:65"><expr pos:start="2524:49" pos:end="2524:65"><operator pos:start="2524:49" pos:end="2524:49">&amp;</operator><name pos:start="2524:50" pos:end="2524:65">ca_certs_buf_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

        <switch pos:start="2526:9" pos:end="2597:9">switch <condition pos:start="2526:16" pos:end="2526:19">(<expr pos:start="2526:17" pos:end="2526:18"><name pos:start="2526:17" pos:end="2526:18">rv</name></expr>)</condition> <block pos:start="2526:21" pos:end="2597:9">{<block_content pos:start="2527:9" pos:end="2596:18">
        <case pos:start="2527:9" pos:end="2527:26">case <expr pos:start="2527:14" pos:end="2527:25"><name pos:start="2527:14" pos:end="2527:25">EST_ERR_NONE</name></expr>:</case>
            
            <comment type="block" pos:start="2529:13" pos:end="2532:15">/*
             * Make sure that even though we got a success return code, that we
             * actually received something
             */</comment>
            <if_stmt pos:start="2533:13" pos:end="2537:13"><if pos:start="2533:13" pos:end="2537:13">if <condition pos:start="2533:16" pos:end="2533:38">(<expr pos:start="2533:17" pos:end="2533:37"><name pos:start="2533:17" pos:end="2533:32">ca_certs_buf_len</name> <operator pos:start="2533:34" pos:end="2533:35">==</operator> <literal type="number" pos:start="2533:37" pos:end="2533:37">0</literal></expr>)</condition> <block pos:start="2533:40" pos:end="2537:13">{<block_content pos:start="2534:17" pos:end="2536:22">
                <expr_stmt pos:start="2534:17" pos:end="2534:77"><expr pos:start="2534:17" pos:end="2534:76"><call pos:start="2534:17" pos:end="2534:76"><name pos:start="2534:17" pos:end="2534:27">EST_LOG_ERR</name><argument_list pos:start="2534:28" pos:end="2534:76">(<argument pos:start="2534:29" pos:end="2534:75"><expr pos:start="2534:29" pos:end="2534:75"><literal type="string" pos:start="2534:29" pos:end="2534:75">"Retrieved CA Cert buf is zero bytes in length"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt pos:start="2535:17" pos:end="2535:45"><expr pos:start="2535:17" pos:end="2535:44"><name pos:start="2535:17" pos:end="2535:18">rv</name> <operator pos:start="2535:20" pos:end="2535:20">=</operator> <name pos:start="2535:22" pos:end="2535:44">EST_ERR_ZERO_LENGTH_BUF</name></expr>;</expr_stmt>
                <break pos:start="2536:17" pos:end="2536:22">break;</break>
            </block_content>}</block></if></if_stmt>
            <if_stmt pos:start="2538:13" pos:end="2542:13"><if pos:start="2538:13" pos:end="2542:13">if <condition pos:start="2538:16" pos:end="2538:48">(<expr pos:start="2538:17" pos:end="2538:47"><name pos:start="2538:17" pos:end="2538:32">ca_certs_buf_len</name><operator pos:start="2538:33" pos:end="2538:33">+</operator><literal type="number" pos:start="2538:34" pos:end="2538:34">1</literal> <operator pos:start="2538:36" pos:end="2538:36">&gt;</operator> <name pos:start="2538:38" pos:end="2538:47">EST_CA_MAX</name></expr>)</condition> <block pos:start="2538:50" pos:end="2542:13">{<block_content pos:start="2539:17" pos:end="2541:22">
                <expr_stmt pos:start="2539:17" pos:end="2539:84"><expr pos:start="2539:17" pos:end="2539:83"><call pos:start="2539:17" pos:end="2539:83"><name pos:start="2539:17" pos:end="2539:27">EST_LOG_ERR</name><argument_list pos:start="2539:28" pos:end="2539:83">(<argument pos:start="2539:29" pos:end="2539:82"><expr pos:start="2539:29" pos:end="2539:82"><literal type="string" pos:start="2539:29" pos:end="2539:82">"Retrieved CA Cert buf is larger than maximum allowed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt pos:start="2540:17" pos:end="2540:49"><expr pos:start="2540:17" pos:end="2540:48"><name pos:start="2540:17" pos:end="2540:18">rv</name> <operator pos:start="2540:20" pos:end="2540:20">=</operator> <name pos:start="2540:22" pos:end="2540:48">EST_ERR_BUF_EXCEEDS_MAX_LEN</name></expr>;</expr_stmt>
                <break pos:start="2541:17" pos:end="2541:22">break;</break>
            </block_content>}</block></if></if_stmt>
            
            <comment type="block" pos:start="2544:13" pos:end="2548:15">/*
             * Resize the buffer holding the retrieved CA cert and link it
             * into the ctx.  Get rid of the http hdr and any extra space on
             * the back.
             */</comment>
            <if_stmt pos:start="2549:13" pos:end="2551:13"><if pos:start="2549:13" pos:end="2551:13">if <condition pos:start="2549:16" pos:end="2549:48">(<expr pos:start="2549:17" pos:end="2549:47"><name pos:start="2549:17" pos:end="2549:39"><name pos:start="2549:17" pos:end="2549:19">ctx</name><operator pos:start="2549:20" pos:end="2549:21">-&gt;</operator><name pos:start="2549:22" pos:end="2549:39">retrieved_ca_certs</name></name> <operator pos:start="2549:41" pos:end="2549:42">!=</operator> <name pos:start="2549:44" pos:end="2549:47">NULL</name></expr>)</condition><block pos:start="2549:49" pos:end="2551:13">{<block_content pos:start="2550:17" pos:end="2550:46">
                <expr_stmt pos:start="2550:17" pos:end="2550:46"><expr pos:start="2550:17" pos:end="2550:45"><call pos:start="2550:17" pos:end="2550:45"><name pos:start="2550:17" pos:end="2550:20">free</name><argument_list pos:start="2550:21" pos:end="2550:45">(<argument pos:start="2550:22" pos:end="2550:44"><expr pos:start="2550:22" pos:end="2550:44"><name pos:start="2550:22" pos:end="2550:44"><name pos:start="2550:22" pos:end="2550:24">ctx</name><operator pos:start="2550:25" pos:end="2550:26">-&gt;</operator><name pos:start="2550:27" pos:end="2550:44">retrieved_ca_certs</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            </block_content>}</block></if></if_stmt>
            <expr_stmt pos:start="2552:13" pos:end="2552:65"><expr pos:start="2552:13" pos:end="2552:64"><name pos:start="2552:13" pos:end="2552:35"><name pos:start="2552:13" pos:end="2552:15">ctx</name><operator pos:start="2552:16" pos:end="2552:17">-&gt;</operator><name pos:start="2552:18" pos:end="2552:35">retrieved_ca_certs</name></name> <operator pos:start="2552:37" pos:end="2552:37">=</operator> <call pos:start="2552:39" pos:end="2552:64"><name pos:start="2552:39" pos:end="2552:44">malloc</name><argument_list pos:start="2552:45" pos:end="2552:64">(<argument pos:start="2552:46" pos:end="2552:63"><expr pos:start="2552:46" pos:end="2552:63"><name pos:start="2552:46" pos:end="2552:61">ca_certs_buf_len</name><operator pos:start="2552:62" pos:end="2552:62">+</operator><literal type="number" pos:start="2552:63" pos:end="2552:63">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <if_stmt pos:start="2553:13" pos:end="2558:13"><if pos:start="2553:13" pos:end="2558:13">if <condition pos:start="2553:16" pos:end="2553:48">(<expr pos:start="2553:17" pos:end="2553:47"><name pos:start="2553:17" pos:end="2553:39"><name pos:start="2553:17" pos:end="2553:19">ctx</name><operator pos:start="2553:20" pos:end="2553:21">-&gt;</operator><name pos:start="2553:22" pos:end="2553:39">retrieved_ca_certs</name></name> <operator pos:start="2553:41" pos:end="2553:42">==</operator> <name pos:start="2553:44" pos:end="2553:47">NULL</name></expr>)</condition> <block pos:start="2553:50" pos:end="2558:13">{<block_content pos:start="2555:17" pos:end="2557:22">
                
                <expr_stmt pos:start="2555:17" pos:end="2555:66"><expr pos:start="2555:17" pos:end="2555:65"><call pos:start="2555:17" pos:end="2555:65"><name pos:start="2555:17" pos:end="2555:27">EST_LOG_ERR</name><argument_list pos:start="2555:28" pos:end="2555:65">(<argument pos:start="2555:29" pos:end="2555:64"><expr pos:start="2555:29" pos:end="2555:64"><literal type="string" pos:start="2555:29" pos:end="2555:64">"Unable to allocate CA certs buffer"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt pos:start="2556:17" pos:end="2556:36"><expr pos:start="2556:17" pos:end="2556:35"><name pos:start="2556:17" pos:end="2556:18">rv</name> <operator pos:start="2556:20" pos:end="2556:20">=</operator> <name pos:start="2556:22" pos:end="2556:35">EST_ERR_MALLOC</name></expr>;</expr_stmt>
                <break pos:start="2557:17" pos:end="2557:22">break;</break>
            </block_content>}</block></if></if_stmt>
            
            <expr_stmt pos:start="2560:13" pos:end="2560:61"><expr pos:start="2560:13" pos:end="2560:60"><name pos:start="2560:13" pos:end="2560:53"><name pos:start="2560:13" pos:end="2560:15">ctx</name><operator pos:start="2560:16" pos:end="2560:17">-&gt;</operator><name pos:start="2560:18" pos:end="2560:35">retrieved_ca_certs</name><index pos:start="2560:36" pos:end="2560:53">[<expr pos:start="2560:37" pos:end="2560:52"><name pos:start="2560:37" pos:end="2560:52">ca_certs_buf_len</name></expr>]</index></name> <operator pos:start="2560:55" pos:end="2560:55">=</operator> <literal type="char" pos:start="2560:57" pos:end="2560:60">'\0'</literal></expr>;</expr_stmt>
            <expr_stmt pos:start="2561:13" pos:end="2562:37"><expr pos:start="2561:13" pos:end="2562:36"><call pos:start="2561:13" pos:end="2562:36"><name pos:start="2561:13" pos:end="2561:20">memcpy_s</name><argument_list pos:start="2561:21" pos:end="2562:36">(<argument pos:start="2561:22" pos:end="2561:44"><expr pos:start="2561:22" pos:end="2561:44"><name pos:start="2561:22" pos:end="2561:44"><name pos:start="2561:22" pos:end="2561:24">ctx</name><operator pos:start="2561:25" pos:end="2561:26">-&gt;</operator><name pos:start="2561:27" pos:end="2561:44">retrieved_ca_certs</name></name></expr></argument>, <argument pos:start="2561:47" pos:end="2561:64"><expr pos:start="2561:47" pos:end="2561:64"><name pos:start="2561:47" pos:end="2561:62">ca_certs_buf_len</name><operator pos:start="2561:63" pos:end="2561:63">+</operator><literal type="number" pos:start="2561:64" pos:end="2561:64">1</literal></expr></argument>, <argument pos:start="2561:67" pos:end="2561:78"><expr pos:start="2561:67" pos:end="2561:78"><name pos:start="2561:67" pos:end="2561:78">ca_certs_buf</name></expr></argument>,
                   <argument pos:start="2562:20" pos:end="2562:35"><expr pos:start="2562:20" pos:end="2562:35"><name pos:start="2562:20" pos:end="2562:35">ca_certs_buf_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="2563:13" pos:end="2563:59"><expr pos:start="2563:13" pos:end="2563:58"><name pos:start="2563:13" pos:end="2563:39"><name pos:start="2563:13" pos:end="2563:15">ctx</name><operator pos:start="2563:16" pos:end="2563:17">-&gt;</operator><name pos:start="2563:18" pos:end="2563:39">retrieved_ca_certs_len</name></name> <operator pos:start="2563:41" pos:end="2563:41">=</operator> <name pos:start="2563:43" pos:end="2563:58">ca_certs_buf_len</name></expr>;</expr_stmt>

            <comment type="block" pos:start="2565:13" pos:end="2567:15">/*
             * Verify the returned CA cert chain
             */</comment>
            <expr_stmt pos:start="2568:13" pos:end="2569:66"><expr pos:start="2568:13" pos:end="2569:65"><name pos:start="2568:13" pos:end="2568:14">rv</name> <operator pos:start="2568:16" pos:end="2568:16">=</operator> <call pos:start="2568:18" pos:end="2569:65"><name pos:start="2568:18" pos:end="2568:35">verify_cacert_resp</name><argument_list pos:start="2568:36" pos:end="2569:65">(<argument pos:start="2568:37" pos:end="2568:39"><expr pos:start="2568:37" pos:end="2568:39"><name pos:start="2568:37" pos:end="2568:39">ctx</name></expr></argument>, <argument pos:start="2568:42" pos:end="2568:64"><expr pos:start="2568:42" pos:end="2568:64"><name pos:start="2568:42" pos:end="2568:64"><name pos:start="2568:42" pos:end="2568:44">ctx</name><operator pos:start="2568:45" pos:end="2568:46">-&gt;</operator><name pos:start="2568:47" pos:end="2568:64">retrieved_ca_certs</name></name></expr></argument>,
                                    <argument pos:start="2569:37" pos:end="2569:64"><expr pos:start="2569:37" pos:end="2569:64"><operator pos:start="2569:37" pos:end="2569:37">&amp;</operator><name pos:start="2569:38" pos:end="2569:64"><name pos:start="2569:38" pos:end="2569:40">ctx</name><operator pos:start="2569:41" pos:end="2569:42">-&gt;</operator><name pos:start="2569:43" pos:end="2569:64">retrieved_ca_certs_len</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <if_stmt pos:start="2570:13" pos:end="2578:13"><if pos:start="2570:13" pos:end="2578:13">if <condition pos:start="2570:16" pos:end="2570:35">(<expr pos:start="2570:17" pos:end="2570:34"><name pos:start="2570:17" pos:end="2570:18">rv</name> <operator pos:start="2570:20" pos:end="2570:21">!=</operator> <name pos:start="2570:23" pos:end="2570:34">EST_ERR_NONE</name></expr>)</condition> <block pos:start="2570:37" pos:end="2578:13">{<block_content pos:start="2571:17" pos:end="2577:22">
                <expr_stmt pos:start="2571:17" pos:end="2571:66"><expr pos:start="2571:17" pos:end="2571:65"><call pos:start="2571:17" pos:end="2571:65"><name pos:start="2571:17" pos:end="2571:27">EST_LOG_ERR</name><argument_list pos:start="2571:28" pos:end="2571:65">(<argument pos:start="2571:29" pos:end="2571:64"><expr pos:start="2571:29" pos:end="2571:64"><literal type="string" pos:start="2571:29" pos:end="2571:64">"Returned CACerts chain was invalid"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>

                <expr_stmt pos:start="2573:17" pos:end="2573:46"><expr pos:start="2573:17" pos:end="2573:45"><call pos:start="2573:17" pos:end="2573:45"><name pos:start="2573:17" pos:end="2573:20">free</name><argument_list pos:start="2573:21" pos:end="2573:45">(<argument pos:start="2573:22" pos:end="2573:44"><expr pos:start="2573:22" pos:end="2573:44"><name pos:start="2573:22" pos:end="2573:44"><name pos:start="2573:22" pos:end="2573:24">ctx</name><operator pos:start="2573:25" pos:end="2573:26">-&gt;</operator><name pos:start="2573:27" pos:end="2573:44">retrieved_ca_certs</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt pos:start="2574:17" pos:end="2574:47"><expr pos:start="2574:17" pos:end="2574:46"><name pos:start="2574:17" pos:end="2574:39"><name pos:start="2574:17" pos:end="2574:19">ctx</name><operator pos:start="2574:20" pos:end="2574:21">-&gt;</operator><name pos:start="2574:22" pos:end="2574:39">retrieved_ca_certs</name></name> <operator pos:start="2574:41" pos:end="2574:41">=</operator> <name pos:start="2574:43" pos:end="2574:46">NULL</name></expr>;</expr_stmt>
                <expr_stmt pos:start="2575:17" pos:end="2575:48"><expr pos:start="2575:17" pos:end="2575:47"><name pos:start="2575:17" pos:end="2575:43"><name pos:start="2575:17" pos:end="2575:19">ctx</name><operator pos:start="2575:20" pos:end="2575:21">-&gt;</operator><name pos:start="2575:22" pos:end="2575:43">retrieved_ca_certs_len</name></name> <operator pos:start="2575:45" pos:end="2575:45">=</operator> <literal type="number" pos:start="2575:47" pos:end="2575:47">0</literal></expr>;</expr_stmt>
                <expr_stmt pos:start="2576:17" pos:end="2576:60"><expr pos:start="2576:17" pos:end="2576:59"><operator pos:start="2576:17" pos:end="2576:17">*</operator><name pos:start="2576:18" pos:end="2576:29">ca_certs_len</name> <operator pos:start="2576:31" pos:end="2576:31">=</operator> <name pos:start="2576:33" pos:end="2576:59"><name pos:start="2576:33" pos:end="2576:35">ctx</name><operator pos:start="2576:36" pos:end="2576:37">-&gt;</operator><name pos:start="2576:38" pos:end="2576:59">retrieved_ca_certs_len</name></name></expr>;</expr_stmt>
                <break pos:start="2577:17" pos:end="2577:22">break;</break>
            </block_content>}</block></if></if_stmt>
            
            <comment type="block" pos:start="2580:13" pos:end="2582:15">/*
             * pass back the length of the retrieved CA cert buffer
             */</comment>
            <expr_stmt pos:start="2583:13" pos:end="2583:56"><expr pos:start="2583:13" pos:end="2583:55"><operator pos:start="2583:13" pos:end="2583:13">*</operator><name pos:start="2583:14" pos:end="2583:25">ca_certs_len</name> <operator pos:start="2583:27" pos:end="2583:27">=</operator> <name pos:start="2583:29" pos:end="2583:55"><name pos:start="2583:29" pos:end="2583:31">ctx</name><operator pos:start="2583:32" pos:end="2583:33">-&gt;</operator><name pos:start="2583:34" pos:end="2583:55">retrieved_ca_certs_len</name></name></expr>;</expr_stmt>
            
            <expr_stmt pos:start="2585:13" pos:end="2585:69"><expr pos:start="2585:13" pos:end="2585:68"><call pos:start="2585:13" pos:end="2585:68"><name pos:start="2585:13" pos:end="2585:24">EST_LOG_INFO</name><argument_list pos:start="2585:25" pos:end="2585:68">(<argument pos:start="2585:26" pos:end="2585:42"><expr pos:start="2585:26" pos:end="2585:42"><literal type="string" pos:start="2585:26" pos:end="2585:42">"CACerts buf: %s"</literal></expr></argument>, <argument pos:start="2585:45" pos:end="2585:67"><expr pos:start="2585:45" pos:end="2585:67"><name pos:start="2585:45" pos:end="2585:67"><name pos:start="2585:45" pos:end="2585:47">ctx</name><operator pos:start="2585:48" pos:end="2585:49">-&gt;</operator><name pos:start="2585:50" pos:end="2585:67">retrieved_ca_certs</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="2586:13" pos:end="2586:76"><expr pos:start="2586:13" pos:end="2586:75"><call pos:start="2586:13" pos:end="2586:75"><name pos:start="2586:13" pos:end="2586:24">EST_LOG_INFO</name><argument_list pos:start="2586:25" pos:end="2586:75">(<argument pos:start="2586:26" pos:end="2586:45"><expr pos:start="2586:26" pos:end="2586:45"><literal type="string" pos:start="2586:26" pos:end="2586:45">"CACerts length: %d"</literal></expr></argument>, <argument pos:start="2586:48" pos:end="2586:74"><expr pos:start="2586:48" pos:end="2586:74"><name pos:start="2586:48" pos:end="2586:74"><name pos:start="2586:48" pos:end="2586:50">ctx</name><operator pos:start="2586:51" pos:end="2586:52">-&gt;</operator><name pos:start="2586:53" pos:end="2586:74">retrieved_ca_certs_len</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <break pos:start="2587:13" pos:end="2587:18">break;</break>
        <case pos:start="2588:9" pos:end="2588:31">case <expr pos:start="2588:14" pos:end="2588:30"><name pos:start="2588:14" pos:end="2588:30">EST_ERR_AUTH_FAIL</name></expr>:</case>
            <expr_stmt pos:start="2589:13" pos:end="2589:45"><expr pos:start="2589:13" pos:end="2589:44"><call pos:start="2589:13" pos:end="2589:44"><name pos:start="2589:13" pos:end="2589:23">EST_LOG_ERR</name><argument_list pos:start="2589:24" pos:end="2589:44">(<argument pos:start="2589:25" pos:end="2589:43"><expr pos:start="2589:25" pos:end="2589:43"><literal type="string" pos:start="2589:25" pos:end="2589:43">"HTTP auth failure"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <break pos:start="2590:13" pos:end="2590:18">break;</break>
        <case pos:start="2591:9" pos:end="2591:37">case <expr pos:start="2591:14" pos:end="2591:36"><name pos:start="2591:14" pos:end="2591:36">EST_ERR_CA_ENROLL_RETRY</name></expr>:</case>
            <expr_stmt pos:start="2592:13" pos:end="2592:72"><expr pos:start="2592:13" pos:end="2592:71"><call pos:start="2592:13" pos:end="2592:71"><name pos:start="2592:13" pos:end="2592:24">EST_LOG_INFO</name><argument_list pos:start="2592:25" pos:end="2592:71">(<argument pos:start="2592:26" pos:end="2592:70"><expr pos:start="2592:26" pos:end="2592:70"><literal type="string" pos:start="2592:26" pos:end="2592:70">"HTTP request failed with a RETRY AFTER resp"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <break pos:start="2593:13" pos:end="2593:18">break;</break>
        <default pos:start="2594:9" pos:end="2594:16">default:</default>
            <expr_stmt pos:start="2595:13" pos:end="2595:83"><expr pos:start="2595:13" pos:end="2595:82"><call pos:start="2595:13" pos:end="2595:82"><name pos:start="2595:13" pos:end="2595:23">EST_LOG_ERR</name><argument_list pos:start="2595:24" pos:end="2595:82">(<argument pos:start="2595:25" pos:end="2595:53"><expr pos:start="2595:25" pos:end="2595:53"><literal type="string" pos:start="2595:25" pos:end="2595:53">"EST request failed: %d (%s)"</literal></expr></argument>, <argument pos:start="2595:56" pos:end="2595:57"><expr pos:start="2595:56" pos:end="2595:57"><name pos:start="2595:56" pos:end="2595:57">rv</name></expr></argument>, <argument pos:start="2595:60" pos:end="2595:81"><expr pos:start="2595:60" pos:end="2595:81"><call pos:start="2595:60" pos:end="2595:81"><name pos:start="2595:60" pos:end="2595:77">EST_ERR_NUM_TO_STR</name><argument_list pos:start="2595:78" pos:end="2595:81">(<argument pos:start="2595:79" pos:end="2595:80"><expr pos:start="2595:79" pos:end="2595:80"><name pos:start="2595:79" pos:end="2595:80">rv</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <break pos:start="2596:13" pos:end="2596:18">break;</break>
        </block_content>}</block></switch>
    </block_content>}</block></else></if_stmt>
    
    <if_stmt pos:start="2600:5" pos:end="2602:5"><if pos:start="2600:5" pos:end="2602:5">if <condition pos:start="2600:8" pos:end="2600:18">(<expr pos:start="2600:9" pos:end="2600:17"><name pos:start="2600:9" pos:end="2600:17">http_data</name></expr>)</condition> <block pos:start="2600:20" pos:end="2602:5">{<block_content pos:start="2601:9" pos:end="2601:24">
        <expr_stmt pos:start="2601:9" pos:end="2601:24"><expr pos:start="2601:9" pos:end="2601:23"><call pos:start="2601:9" pos:end="2601:23"><name pos:start="2601:9" pos:end="2601:12">free</name><argument_list pos:start="2601:13" pos:end="2601:23">(<argument pos:start="2601:14" pos:end="2601:22"><expr pos:start="2601:14" pos:end="2601:22"><name pos:start="2601:14" pos:end="2601:22">http_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    <if_stmt pos:start="2603:5" pos:end="2605:5"><if pos:start="2603:5" pos:end="2605:5">if <condition pos:start="2603:8" pos:end="2603:21">(<expr pos:start="2603:9" pos:end="2603:20"><name pos:start="2603:9" pos:end="2603:20">ca_certs_buf</name></expr>)</condition> <block pos:start="2603:23" pos:end="2605:5">{<block_content pos:start="2604:9" pos:end="2604:27">
        <expr_stmt pos:start="2604:9" pos:end="2604:27"><expr pos:start="2604:9" pos:end="2604:26"><call pos:start="2604:9" pos:end="2604:26"><name pos:start="2604:9" pos:end="2604:12">free</name><argument_list pos:start="2604:13" pos:end="2604:26">(<argument pos:start="2604:14" pos:end="2604:25"><expr pos:start="2604:14" pos:end="2604:25"><name pos:start="2604:14" pos:end="2604:25">ca_certs_buf</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    
    <return pos:start="2607:5" pos:end="2607:16">return <expr pos:start="2607:12" pos:end="2607:15"><operator pos:start="2607:12" pos:end="2607:12">(</operator><name pos:start="2607:13" pos:end="2607:14">rv</name><operator pos:start="2607:15" pos:end="2607:15">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" pos:start="2609:1" pos:end="2617:3">/*
 * This function does the work for the CACerts request flow.
 *
 * Parameters:
 *	ctx:	    EST context
 *	ssl:	    SSL context
 *      ca_certs_len: pointer to the unsigned int that will hold the length of the
 *                    returned CA certs.
 */</comment>
<function pos:start="2618:1" pos:end="2649:1"><type pos:start="2618:1" pos:end="2618:9"><name pos:start="2618:1" pos:end="2618:9">EST_ERROR</name></type> <name pos:start="2618:11" pos:end="2618:31">est_client_set_uid_pw</name> <parameter_list pos:start="2618:33" pos:end="2618:80">(<parameter pos:start="2618:34" pos:end="2618:45"><decl pos:start="2618:34" pos:end="2618:45"><type pos:start="2618:34" pos:end="2618:45"><name pos:start="2618:34" pos:end="2618:40">EST_CTX</name> <modifier pos:start="2618:42" pos:end="2618:42">*</modifier></type><name pos:start="2618:43" pos:end="2618:45">ctx</name></decl></parameter>, <parameter pos:start="2618:48" pos:end="2618:62"><decl pos:start="2618:48" pos:end="2618:62"><type pos:start="2618:48" pos:end="2618:62"><specifier pos:start="2618:48" pos:end="2618:52">const</specifier> <name pos:start="2618:54" pos:end="2618:57">char</name> <modifier pos:start="2618:59" pos:end="2618:59">*</modifier></type><name pos:start="2618:60" pos:end="2618:62">uid</name></decl></parameter>, <parameter pos:start="2618:65" pos:end="2618:79"><decl pos:start="2618:65" pos:end="2618:79"><type pos:start="2618:65" pos:end="2618:79"><specifier pos:start="2618:65" pos:end="2618:69">const</specifier> <name pos:start="2618:71" pos:end="2618:74">char</name> <modifier pos:start="2618:76" pos:end="2618:76">*</modifier></type><name pos:start="2618:77" pos:end="2618:79">pwd</name></decl></parameter>)</parameter_list> 
<block pos:start="2619:1" pos:end="2649:1">{<block_content pos:start="2625:5" pos:end="2648:26">
    <comment type="block" pos:start="2620:5" pos:end="2624:7">/*
     * If there's a userid, there must be a password, and vice versa.
     * The userid can still be an empty string ( "" ), but it cannot
     * be NULL if there's a password. (3.2.3).
     */</comment>
    <if_stmt pos:start="2625:5" pos:end="2628:5"><if pos:start="2625:5" pos:end="2628:5">if <condition pos:start="2625:8" pos:end="2625:35">(<expr pos:start="2625:9" pos:end="2625:34"><name pos:start="2625:9" pos:end="2625:11">uid</name> <operator pos:start="2625:13" pos:end="2625:14">!=</operator> <name pos:start="2625:16" pos:end="2625:19">NULL</name> <operator pos:start="2625:21" pos:end="2625:22">&amp;&amp;</operator> <name pos:start="2625:24" pos:end="2625:26">pwd</name> <operator pos:start="2625:28" pos:end="2625:29">==</operator> <name pos:start="2625:31" pos:end="2625:34">NULL</name></expr>)</condition> <block pos:start="2625:37" pos:end="2628:5">{<block_content pos:start="2626:9" pos:end="2627:42">
        <expr_stmt pos:start="2626:9" pos:end="2626:57"><expr pos:start="2626:9" pos:end="2626:56"><call pos:start="2626:9" pos:end="2626:56"><name pos:start="2626:9" pos:end="2626:19">EST_LOG_ERR</name><argument_list pos:start="2626:20" pos:end="2626:56">(<argument pos:start="2626:21" pos:end="2626:55"><expr pos:start="2626:21" pos:end="2626:55"><literal type="string" pos:start="2626:21" pos:end="2626:55">"User ID provided with no password"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="2627:9" pos:end="2627:42">return <expr pos:start="2627:16" pos:end="2627:41"><name pos:start="2627:16" pos:end="2627:41">EST_ERR_INVALID_PARAMETERS</name></expr>;</return>
    </block_content>}</block></if></if_stmt>        
    <if_stmt pos:start="2629:5" pos:end="2632:5"><if pos:start="2629:5" pos:end="2632:5">if <condition pos:start="2629:8" pos:end="2629:35">(<expr pos:start="2629:9" pos:end="2629:34"><name pos:start="2629:9" pos:end="2629:11">uid</name> <operator pos:start="2629:13" pos:end="2629:14">==</operator> <name pos:start="2629:16" pos:end="2629:19">NULL</name> <operator pos:start="2629:21" pos:end="2629:22">&amp;&amp;</operator> <name pos:start="2629:24" pos:end="2629:26">pwd</name> <operator pos:start="2629:28" pos:end="2629:29">!=</operator> <name pos:start="2629:31" pos:end="2629:34">NULL</name></expr>)</condition> <block pos:start="2629:37" pos:end="2632:5">{<block_content pos:start="2630:9" pos:end="2631:42">
        <expr_stmt pos:start="2630:9" pos:end="2630:57"><expr pos:start="2630:9" pos:end="2630:56"><call pos:start="2630:9" pos:end="2630:56"><name pos:start="2630:9" pos:end="2630:19">EST_LOG_ERR</name><argument_list pos:start="2630:20" pos:end="2630:56">(<argument pos:start="2630:21" pos:end="2630:55"><expr pos:start="2630:21" pos:end="2630:55"><literal type="string" pos:start="2630:21" pos:end="2630:55">"Password provided with no user ID"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="2631:9" pos:end="2631:42">return <expr pos:start="2631:16" pos:end="2631:41"><name pos:start="2631:16" pos:end="2631:41">EST_ERR_INVALID_PARAMETERS</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="2634:5" pos:end="2636:7">/*
     * if uid/pwd set, then we're doing basic/digest authentication
     */</comment>
    <if_stmt pos:start="2637:5" pos:end="2646:5"><if pos:start="2637:5" pos:end="2646:5">if <condition pos:start="2637:8" pos:end="2637:20">(<expr pos:start="2637:9" pos:end="2637:19"><name pos:start="2637:9" pos:end="2637:11">uid</name> <operator pos:start="2637:13" pos:end="2637:14">!=</operator> <name pos:start="2637:16" pos:end="2637:19">NULL</name></expr>)</condition> <block pos:start="2637:22" pos:end="2646:5">{<block_content pos:start="2638:9" pos:end="2645:9">
        <if_stmt pos:start="2638:9" pos:end="2641:9"><if pos:start="2638:9" pos:end="2641:9">if <condition pos:start="2638:12" pos:end="2638:71">(<expr pos:start="2638:13" pos:end="2638:70"><name pos:start="2638:13" pos:end="2638:15">EOK</name> <operator pos:start="2638:17" pos:end="2638:18">!=</operator> <call pos:start="2638:20" pos:end="2638:70"><name pos:start="2638:20" pos:end="2638:28">strncpy_s</name><argument_list pos:start="2638:29" pos:end="2638:70">(<argument pos:start="2638:30" pos:end="2638:40"><expr pos:start="2638:30" pos:end="2638:40"><name pos:start="2638:30" pos:end="2638:40"><name pos:start="2638:30" pos:end="2638:32">ctx</name><operator pos:start="2638:33" pos:end="2638:34">-&gt;</operator><name pos:start="2638:35" pos:end="2638:40">userid</name></name></expr></argument>, <argument pos:start="2638:43" pos:end="2638:52"><expr pos:start="2638:43" pos:end="2638:52"><name pos:start="2638:43" pos:end="2638:52">MAX_UIDPWD</name></expr></argument>, <argument pos:start="2638:55" pos:end="2638:57"><expr pos:start="2638:55" pos:end="2638:57"><name pos:start="2638:55" pos:end="2638:57">uid</name></expr></argument>, <argument pos:start="2638:60" pos:end="2638:69"><expr pos:start="2638:60" pos:end="2638:69"><name pos:start="2638:60" pos:end="2638:69">MAX_UIDPWD</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="2638:73" pos:end="2641:9">{<block_content pos:start="2639:13" pos:end="2640:46">
            <expr_stmt pos:start="2639:13" pos:end="2639:52"><expr pos:start="2639:13" pos:end="2639:51"><call pos:start="2639:13" pos:end="2639:51"><name pos:start="2639:13" pos:end="2639:23">EST_LOG_ERR</name><argument_list pos:start="2639:24" pos:end="2639:51">(<argument pos:start="2639:25" pos:end="2639:50"><expr pos:start="2639:25" pos:end="2639:50"><literal type="string" pos:start="2639:25" pos:end="2639:50">"Invalid User ID provided"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return pos:start="2640:13" pos:end="2640:46">return <expr pos:start="2640:20" pos:end="2640:45"><name pos:start="2640:20" pos:end="2640:45">EST_ERR_INVALID_PARAMETERS</name></expr>;</return>   
        </block_content>}</block></if></if_stmt>
        <if_stmt pos:start="2642:9" pos:end="2645:9"><if pos:start="2642:9" pos:end="2645:9">if <condition pos:start="2642:12" pos:end="2642:73">(<expr pos:start="2642:13" pos:end="2642:72"><name pos:start="2642:13" pos:end="2642:15">EOK</name> <operator pos:start="2642:17" pos:end="2642:18">!=</operator> <call pos:start="2642:20" pos:end="2642:72"><name pos:start="2642:20" pos:end="2642:28">strncpy_s</name><argument_list pos:start="2642:29" pos:end="2642:72">(<argument pos:start="2642:30" pos:end="2642:42"><expr pos:start="2642:30" pos:end="2642:42"><name pos:start="2642:30" pos:end="2642:42"><name pos:start="2642:30" pos:end="2642:32">ctx</name><operator pos:start="2642:33" pos:end="2642:34">-&gt;</operator><name pos:start="2642:35" pos:end="2642:42">password</name></name></expr></argument>, <argument pos:start="2642:45" pos:end="2642:54"><expr pos:start="2642:45" pos:end="2642:54"><name pos:start="2642:45" pos:end="2642:54">MAX_UIDPWD</name></expr></argument>, <argument pos:start="2642:57" pos:end="2642:59"><expr pos:start="2642:57" pos:end="2642:59"><name pos:start="2642:57" pos:end="2642:59">pwd</name></expr></argument>, <argument pos:start="2642:62" pos:end="2642:71"><expr pos:start="2642:62" pos:end="2642:71"><name pos:start="2642:62" pos:end="2642:71">MAX_UIDPWD</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="2642:75" pos:end="2645:9">{<block_content pos:start="2643:13" pos:end="2644:46">
            <expr_stmt pos:start="2643:13" pos:end="2643:53"><expr pos:start="2643:13" pos:end="2643:52"><call pos:start="2643:13" pos:end="2643:52"><name pos:start="2643:13" pos:end="2643:23">EST_LOG_ERR</name><argument_list pos:start="2643:24" pos:end="2643:52">(<argument pos:start="2643:25" pos:end="2643:51"><expr pos:start="2643:25" pos:end="2643:51"><literal type="string" pos:start="2643:25" pos:end="2643:51">"Invalid Password provided"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return pos:start="2644:13" pos:end="2644:46">return <expr pos:start="2644:20" pos:end="2644:45"><name pos:start="2644:20" pos:end="2644:45">EST_ERR_INVALID_PARAMETERS</name></expr>;</return>
        </block_content>}</block></if></if_stmt>
    </block_content>}</block></if></if_stmt>

    <return pos:start="2648:5" pos:end="2648:26">return <expr pos:start="2648:12" pos:end="2648:25"><operator pos:start="2648:12" pos:end="2648:12">(</operator><name pos:start="2648:13" pos:end="2648:24">EST_ERR_NONE</name><operator pos:start="2648:25" pos:end="2648:25">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="2650:1" pos:end="2692:3">/*! @brief est_client_enroll_csr() performs the simple enroll request with the EST
     server using a PKCS10 CSR provided by the application layer.
 
    @param ctx Pointer to an EST context
    @param csr Pointer to the PKCS10 CSR data, which is defined as an OpenSSL
    X509_REQ.
    @param pkcs7_len Pointer to an integer to hold the length of the PKCS7
    buffer.
    @param priv_key Pointer to the private key that will be used to sign the CSR,
    or NULL
 
    @return EST_ERROR

    est_client_enroll_csr() connects to the EST server, establishes a SSL/TLS
    connection to the EST server that was configured with the previous call to
    est_client_set_server(), and sends the simple enroll request.  The application
    layer must provide the PKCS10 CSR that will be enrolled.
    If the priv_key argument given is not NULL, then the CSR should not
    need to be signed by the private key. However, the CSR must contain everything 
    else that is required, including the public key. If the private key is provided
    with an already signed CSR, then the EST library will re-sign the CSR. 
    
    The enroll response is stored in the EST context and the length 
    is passed back to the application through the pkcs7_len paramter of this 
    function.  The application can then allocate a correctly sized buffer and 
    call est_client_copy_enrolled_cert() to retrieve the new client certificate 
    from the context.

    Unless the CSR is not already signed, which is indicated by a NULL priv_key,
    the application must provide a pointer to the private key used to sign the CSR.
    This is required by the EST library in the event that the EST server has
    requested the proof-of-possession value be included in the CSR.  The EST library
    will automatically include the proof-of-posession value and sign the CSR
    again.

    Be aware that the X509_REQ data passed to this function must be valid.  Passing
    corrupted CSR data may result in a system crash.  libEST utilizes the OpenSSL
    ASN decoding logic to read the X509_REQ data.  OpenSSL does not perform
    safety checks on the X509_REQ data when parsing.  If your application is
    reading externally generated PEM or DER encoded CSR data, then please use
    the est_read_x509_request() helper function to convert the PEM/DER CSR into a
    valid X509_REQ pointer.
 */</comment>
<function pos:start="2693:1" pos:end="2765:1"><type pos:start="2693:1" pos:end="2693:9"><name pos:start="2693:1" pos:end="2693:9">EST_ERROR</name></type> <name pos:start="2693:11" pos:end="2693:31">est_client_enroll_csr</name> <parameter_list pos:start="2693:33" pos:end="2693:97">(<parameter pos:start="2693:34" pos:end="2693:45"><decl pos:start="2693:34" pos:end="2693:45"><type pos:start="2693:34" pos:end="2693:45"><name pos:start="2693:34" pos:end="2693:40">EST_CTX</name> <modifier pos:start="2693:42" pos:end="2693:42">*</modifier></type><name pos:start="2693:43" pos:end="2693:45">ctx</name></decl></parameter>, <parameter pos:start="2693:48" pos:end="2693:60"><decl pos:start="2693:48" pos:end="2693:60"><type pos:start="2693:48" pos:end="2693:60"><name pos:start="2693:48" pos:end="2693:55">X509_REQ</name> <modifier pos:start="2693:57" pos:end="2693:57">*</modifier></type><name pos:start="2693:58" pos:end="2693:60">csr</name></decl></parameter>, <parameter pos:start="2693:63" pos:end="2693:76"><decl pos:start="2693:63" pos:end="2693:76"><type pos:start="2693:63" pos:end="2693:76"><name pos:start="2693:63" pos:end="2693:65">int</name> <modifier pos:start="2693:67" pos:end="2693:67">*</modifier></type><name pos:start="2693:68" pos:end="2693:76">pkcs7_len</name></decl></parameter>, <parameter pos:start="2693:79" pos:end="2693:96"><decl pos:start="2693:79" pos:end="2693:96"><type pos:start="2693:79" pos:end="2693:96"><name pos:start="2693:79" pos:end="2693:86">EVP_PKEY</name> <modifier pos:start="2693:88" pos:end="2693:88">*</modifier></type><name pos:start="2693:89" pos:end="2693:96">priv_key</name></decl></parameter>)</parameter_list>
<block pos:start="2694:1" pos:end="2765:1">{<block_content pos:start="2695:5" pos:end="2763:16">
    <decl_stmt pos:start="2695:5" pos:end="2695:17"><decl pos:start="2695:5" pos:end="2695:16"><type pos:start="2695:5" pos:end="2695:13"><name pos:start="2695:5" pos:end="2695:13">EST_ERROR</name></type> <name pos:start="2695:15" pos:end="2695:16">rv</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2696:5" pos:end="2696:20"><decl pos:start="2696:5" pos:end="2696:19"><type pos:start="2696:5" pos:end="2696:9"><name pos:start="2696:5" pos:end="2696:7">SSL</name> <modifier pos:start="2696:9" pos:end="2696:9">*</modifier></type><name pos:start="2696:10" pos:end="2696:12">ssl</name> <init pos:start="2696:14" pos:end="2696:19">= <expr pos:start="2696:16" pos:end="2696:19"><name pos:start="2696:16" pos:end="2696:19">NULL</name></expr></init></decl>;</decl_stmt>

    <if_stmt pos:start="2698:5" pos:end="2700:5"><if pos:start="2698:5" pos:end="2700:5">if <condition pos:start="2698:8" pos:end="2698:13">(<expr pos:start="2698:9" pos:end="2698:12"><operator pos:start="2698:9" pos:end="2698:9">!</operator><name pos:start="2698:10" pos:end="2698:12">ctx</name></expr>)</condition> <block pos:start="2698:15" pos:end="2700:5">{<block_content pos:start="2699:9" pos:end="2699:32">
        <return pos:start="2699:9" pos:end="2699:32">return <expr pos:start="2699:16" pos:end="2699:31"><operator pos:start="2699:16" pos:end="2699:16">(</operator><name pos:start="2699:17" pos:end="2699:30">EST_ERR_NO_CTX</name><operator pos:start="2699:31" pos:end="2699:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="2702:5" pos:end="2704:5"><if pos:start="2702:5" pos:end="2704:5">if <condition pos:start="2702:8" pos:end="2702:13">(<expr pos:start="2702:9" pos:end="2702:12"><operator pos:start="2702:9" pos:end="2702:9">!</operator><name pos:start="2702:10" pos:end="2702:12">csr</name></expr>)</condition> <block pos:start="2702:15" pos:end="2704:5">{<block_content pos:start="2703:9" pos:end="2703:32">
        <return pos:start="2703:9" pos:end="2703:32">return <expr pos:start="2703:16" pos:end="2703:31"><operator pos:start="2703:16" pos:end="2703:16">(</operator><name pos:start="2703:17" pos:end="2703:30">EST_ERR_NO_CSR</name><operator pos:start="2703:31" pos:end="2703:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="2706:5" pos:end="2708:5"><if pos:start="2706:5" pos:end="2708:5">if <condition pos:start="2706:8" pos:end="2706:37">(<expr pos:start="2706:9" pos:end="2706:36"><operator pos:start="2706:9" pos:end="2706:9">!</operator><name pos:start="2706:10" pos:end="2706:36"><name pos:start="2706:10" pos:end="2706:12">ctx</name><operator pos:start="2706:13" pos:end="2706:14">-&gt;</operator><name pos:start="2706:15" pos:end="2706:36">est_client_initialized</name></name></expr>)</condition> <block pos:start="2706:39" pos:end="2708:5">{<block_content pos:start="2707:9" pos:end="2707:46">
        <return pos:start="2707:9" pos:end="2707:46">return <expr pos:start="2707:16" pos:end="2707:45"><name pos:start="2707:16" pos:end="2707:45">EST_ERR_CLIENT_NOT_INITIALIZED</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="2710:5" pos:end="2712:7">/*
     * Establish TLS session with the EST server
     */</comment>
    <expr_stmt pos:start="2713:5" pos:end="2713:39"><expr pos:start="2713:5" pos:end="2713:38"><name pos:start="2713:5" pos:end="2713:6">rv</name> <operator pos:start="2713:8" pos:end="2713:8">=</operator> <call pos:start="2713:10" pos:end="2713:38"><name pos:start="2713:10" pos:end="2713:27">est_client_connect</name><argument_list pos:start="2713:28" pos:end="2713:38">(<argument pos:start="2713:29" pos:end="2713:31"><expr pos:start="2713:29" pos:end="2713:31"><name pos:start="2713:29" pos:end="2713:31">ctx</name></expr></argument>, <argument pos:start="2713:34" pos:end="2713:37"><expr pos:start="2713:34" pos:end="2713:37"><operator pos:start="2713:34" pos:end="2713:34">&amp;</operator><name pos:start="2713:35" pos:end="2713:37">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2714:5" pos:end="2716:5"><if pos:start="2714:5" pos:end="2716:5">if <condition pos:start="2714:8" pos:end="2714:27">(<expr pos:start="2714:9" pos:end="2714:26"><name pos:start="2714:9" pos:end="2714:10">rv</name> <operator pos:start="2714:12" pos:end="2714:13">!=</operator> <name pos:start="2714:15" pos:end="2714:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="2714:29" pos:end="2716:5">{<block_content pos:start="2715:9" pos:end="2715:17">
        <goto pos:start="2715:9" pos:end="2715:17">goto <name pos:start="2715:14" pos:end="2715:16">err</name>;</goto>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="2718:5" pos:end="2722:5"><if pos:start="2718:5" pos:end="2720:5">if <condition pos:start="2718:8" pos:end="2718:17">(<expr pos:start="2718:9" pos:end="2718:16"><name pos:start="2718:9" pos:end="2718:16">priv_key</name></expr>)</condition> <block pos:start="2718:19" pos:end="2720:5">{<block_content pos:start="2719:7" pos:end="2719:75">
      <expr_stmt pos:start="2719:7" pos:end="2719:75"><expr pos:start="2719:7" pos:end="2719:74"><name pos:start="2719:7" pos:end="2719:8">rv</name> <operator pos:start="2719:10" pos:end="2719:10">=</operator> <call pos:start="2719:12" pos:end="2719:74"><name pos:start="2719:12" pos:end="2719:35">est_client_enroll_pkcs10</name><argument_list pos:start="2719:36" pos:end="2719:74">(<argument pos:start="2719:37" pos:end="2719:39"><expr pos:start="2719:37" pos:end="2719:39"><name pos:start="2719:37" pos:end="2719:39">ctx</name></expr></argument>, <argument pos:start="2719:42" pos:end="2719:44"><expr pos:start="2719:42" pos:end="2719:44"><name pos:start="2719:42" pos:end="2719:44">ssl</name></expr></argument>, <argument pos:start="2719:47" pos:end="2719:49"><expr pos:start="2719:47" pos:end="2719:49"><name pos:start="2719:47" pos:end="2719:49">csr</name></expr></argument>, <argument pos:start="2719:52" pos:end="2719:60"><expr pos:start="2719:52" pos:end="2719:60"><name pos:start="2719:52" pos:end="2719:60">pkcs7_len</name></expr></argument>, <argument pos:start="2719:63" pos:end="2719:70"><expr pos:start="2719:63" pos:end="2719:70"><name pos:start="2719:63" pos:end="2719:70">priv_key</name></expr></argument>, <argument pos:start="2719:73" pos:end="2719:73"><expr pos:start="2719:73" pos:end="2719:73"><literal type="number" pos:start="2719:73" pos:end="2719:73">0</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if> <else pos:start="2720:7" pos:end="2722:5">else <block pos:start="2720:12" pos:end="2722:5">{<block_content pos:start="2721:9" pos:end="2721:64">
        <expr_stmt pos:start="2721:9" pos:end="2721:64"><expr pos:start="2721:9" pos:end="2721:63"><name pos:start="2721:9" pos:end="2721:10">rv</name> <operator pos:start="2721:12" pos:end="2721:12">=</operator> <call pos:start="2721:14" pos:end="2721:63"><name pos:start="2721:14" pos:end="2721:34">est_client_enroll_req</name><argument_list pos:start="2721:35" pos:end="2721:63">(<argument pos:start="2721:36" pos:end="2721:38"><expr pos:start="2721:36" pos:end="2721:38"><name pos:start="2721:36" pos:end="2721:38">ctx</name></expr></argument>, <argument pos:start="2721:41" pos:end="2721:43"><expr pos:start="2721:41" pos:end="2721:43"><name pos:start="2721:41" pos:end="2721:43">ssl</name></expr></argument>, <argument pos:start="2721:46" pos:end="2721:48"><expr pos:start="2721:46" pos:end="2721:48"><name pos:start="2721:46" pos:end="2721:48">csr</name></expr></argument>, <argument pos:start="2721:51" pos:end="2721:59"><expr pos:start="2721:51" pos:end="2721:59"><name pos:start="2721:51" pos:end="2721:59">pkcs7_len</name></expr></argument>, <argument pos:start="2721:62" pos:end="2721:62"><expr pos:start="2721:62" pos:end="2721:62"><literal type="number" pos:start="2721:62" pos:end="2721:62">0</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></else></if_stmt>
    <expr_stmt pos:start="2723:5" pos:end="2723:37"><expr pos:start="2723:5" pos:end="2723:36"><call pos:start="2723:5" pos:end="2723:36"><name pos:start="2723:5" pos:end="2723:25">est_client_disconnect</name><argument_list pos:start="2723:26" pos:end="2723:36">(<argument pos:start="2723:27" pos:end="2723:29"><expr pos:start="2723:27" pos:end="2723:29"><name pos:start="2723:27" pos:end="2723:29">ctx</name></expr></argument>, <argument pos:start="2723:32" pos:end="2723:35"><expr pos:start="2723:32" pos:end="2723:35"><operator pos:start="2723:32" pos:end="2723:32">&amp;</operator><name pos:start="2723:33" pos:end="2723:35">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2724:5" pos:end="2755:5"><if pos:start="2724:5" pos:end="2755:5">if <condition pos:start="2724:8" pos:end="2727:39">(<expr pos:start="2724:9" pos:end="2727:38"><name pos:start="2724:9" pos:end="2724:10">rv</name> <operator pos:start="2724:12" pos:end="2724:13">==</operator> <name pos:start="2724:15" pos:end="2724:31">EST_ERR_AUTH_FAIL</name> <operator pos:start="2724:33" pos:end="2724:34">&amp;&amp;</operator>
        <operator pos:start="2725:9" pos:end="2725:9">(</operator><name pos:start="2725:10" pos:end="2725:23"><name pos:start="2725:10" pos:end="2725:12">ctx</name><operator pos:start="2725:13" pos:end="2725:14">-&gt;</operator><name pos:start="2725:15" pos:end="2725:23">auth_mode</name></name> <operator pos:start="2725:25" pos:end="2725:26">==</operator> <name pos:start="2725:28" pos:end="2725:38">AUTH_DIGEST</name> <operator pos:start="2725:40" pos:end="2725:41">||</operator>
         <name pos:start="2726:10" pos:end="2726:23"><name pos:start="2726:10" pos:end="2726:12">ctx</name><operator pos:start="2726:13" pos:end="2726:14">-&gt;</operator><name pos:start="2726:15" pos:end="2726:23">auth_mode</name></name> <operator pos:start="2726:25" pos:end="2726:26">==</operator> <name pos:start="2726:28" pos:end="2726:37">AUTH_BASIC</name>  <operator pos:start="2726:40" pos:end="2726:41">||</operator>
         <name pos:start="2727:10" pos:end="2727:23"><name pos:start="2727:10" pos:end="2727:12">ctx</name><operator pos:start="2727:13" pos:end="2727:14">-&gt;</operator><name pos:start="2727:15" pos:end="2727:23">auth_mode</name></name> <operator pos:start="2727:25" pos:end="2727:26">==</operator> <name pos:start="2727:28" pos:end="2727:37">AUTH_TOKEN</name><operator pos:start="2727:38" pos:end="2727:38">)</operator></expr>)</condition> <block pos:start="2727:41" pos:end="2755:5">{<block_content pos:start="2733:9" pos:end="2754:41">

        <comment type="block" pos:start="2729:9" pos:end="2732:11">/*
         * HTTPS digest mode requires the use of MD5.  Make sure we're not
         * in FIPS mode and can use MD5
         */</comment>
        <if_stmt pos:start="2733:9" pos:end="2737:9"><if pos:start="2733:9" pos:end="2737:9">if <condition pos:start="2733:12" pos:end="2733:59">(<expr pos:start="2733:13" pos:end="2733:58"><name pos:start="2733:13" pos:end="2733:26"><name pos:start="2733:13" pos:end="2733:15">ctx</name><operator pos:start="2733:16" pos:end="2733:17">-&gt;</operator><name pos:start="2733:18" pos:end="2733:26">auth_mode</name></name> <operator pos:start="2733:28" pos:end="2733:29">==</operator> <name pos:start="2733:31" pos:end="2733:41">AUTH_DIGEST</name> <operator pos:start="2733:43" pos:end="2733:44">&amp;&amp;</operator> <operator pos:start="2733:46" pos:end="2733:46">(</operator><call pos:start="2733:47" pos:end="2733:57"><name pos:start="2733:47" pos:end="2733:55">FIPS_mode</name><argument_list pos:start="2733:56" pos:end="2733:57">()</argument_list></call><operator pos:start="2733:58" pos:end="2733:58">)</operator></expr>)</condition><block pos:start="2733:60" pos:end="2737:9">{<block_content pos:start="2734:13" pos:end="2736:21">
	    <expr_stmt pos:start="2734:13" pos:end="2734:75"><expr pos:start="2734:13" pos:end="2734:74"><call pos:start="2734:13" pos:end="2734:74"><name pos:start="2734:13" pos:end="2734:23">EST_LOG_ERR</name><argument_list pos:start="2734:24" pos:end="2734:74">(<argument pos:start="2734:25" pos:end="2734:73"><expr pos:start="2734:25" pos:end="2734:73"><literal type="string" pos:start="2734:25" pos:end="2734:73">"HTTP digest auth not allowed while in FIPS mode"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt pos:start="2735:13" pos:end="2735:34"><expr pos:start="2735:13" pos:end="2735:33"><name pos:start="2735:13" pos:end="2735:14">rv</name> <operator pos:start="2735:16" pos:end="2735:16">=</operator> <name pos:start="2735:18" pos:end="2735:33">EST_ERR_BAD_MODE</name></expr>;</expr_stmt>
            <goto pos:start="2736:13" pos:end="2736:21">goto <name pos:start="2736:18" pos:end="2736:20">err</name>;</goto>
        </block_content>}</block></if></if_stmt>
        
        <comment type="block" pos:start="2739:9" pos:end="2739:58">/* Try one more time if we're doing Digest auth */</comment>
        <expr_stmt pos:start="2740:9" pos:end="2740:84"><expr pos:start="2740:9" pos:end="2740:83"><call pos:start="2740:9" pos:end="2740:83"><name pos:start="2740:9" pos:end="2740:20">EST_LOG_INFO</name><argument_list pos:start="2740:21" pos:end="2740:83">(<argument pos:start="2740:22" pos:end="2740:82"><expr pos:start="2740:22" pos:end="2740:82"><literal type="string" pos:start="2740:22" pos:end="2740:82">"HTTP Auth failed, trying again with digest/basic parameters"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2741:9" pos:end="2741:43"><expr pos:start="2741:9" pos:end="2741:42"><name pos:start="2741:9" pos:end="2741:10">rv</name> <operator pos:start="2741:12" pos:end="2741:12">=</operator> <call pos:start="2741:14" pos:end="2741:42"><name pos:start="2741:14" pos:end="2741:31">est_client_connect</name><argument_list pos:start="2741:32" pos:end="2741:42">(<argument pos:start="2741:33" pos:end="2741:35"><expr pos:start="2741:33" pos:end="2741:35"><name pos:start="2741:33" pos:end="2741:35">ctx</name></expr></argument>, <argument pos:start="2741:38" pos:end="2741:41"><expr pos:start="2741:38" pos:end="2741:41"><operator pos:start="2741:38" pos:end="2741:38">&amp;</operator><name pos:start="2741:39" pos:end="2741:41">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="2742:9" pos:end="2745:9"><if pos:start="2742:9" pos:end="2745:9">if <condition pos:start="2742:12" pos:end="2742:31">(<expr pos:start="2742:13" pos:end="2742:30"><name pos:start="2742:13" pos:end="2742:14">rv</name> <operator pos:start="2742:16" pos:end="2742:17">!=</operator> <name pos:start="2742:19" pos:end="2742:30">EST_ERR_NONE</name></expr>)</condition> <block pos:start="2742:33" pos:end="2745:9">{<block_content pos:start="2743:13" pos:end="2744:21">
            <expr_stmt pos:start="2743:13" pos:end="2743:92"><expr pos:start="2743:13" pos:end="2743:91"><call pos:start="2743:13" pos:end="2743:91"><name pos:start="2743:13" pos:end="2743:23">EST_LOG_ERR</name><argument_list pos:start="2743:24" pos:end="2743:91">(<argument pos:start="2743:25" pos:end="2743:90"><expr pos:start="2743:25" pos:end="2743:90"><literal type="string" pos:start="2743:25" pos:end="2743:90">"Connection failed on second attempt with basic/digest parameters"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <goto pos:start="2744:13" pos:end="2744:21">goto <name pos:start="2744:18" pos:end="2744:20">err</name>;</goto>
        </block_content>}</block></if></if_stmt>
	<if_stmt pos:start="2746:9" pos:end="2750:9"><if pos:start="2746:9" pos:end="2748:9">if <condition pos:start="2746:12" pos:end="2746:21">(<expr pos:start="2746:13" pos:end="2746:20"><name pos:start="2746:13" pos:end="2746:20">priv_key</name></expr>)</condition> <block pos:start="2746:23" pos:end="2748:9">{<block_content pos:start="2747:11" pos:end="2747:79">
	  <expr_stmt pos:start="2747:11" pos:end="2747:79"><expr pos:start="2747:11" pos:end="2747:78"><name pos:start="2747:11" pos:end="2747:12">rv</name> <operator pos:start="2747:14" pos:end="2747:14">=</operator> <call pos:start="2747:16" pos:end="2747:78"><name pos:start="2747:16" pos:end="2747:39">est_client_enroll_pkcs10</name><argument_list pos:start="2747:40" pos:end="2747:78">(<argument pos:start="2747:41" pos:end="2747:43"><expr pos:start="2747:41" pos:end="2747:43"><name pos:start="2747:41" pos:end="2747:43">ctx</name></expr></argument>, <argument pos:start="2747:46" pos:end="2747:48"><expr pos:start="2747:46" pos:end="2747:48"><name pos:start="2747:46" pos:end="2747:48">ssl</name></expr></argument>, <argument pos:start="2747:51" pos:end="2747:53"><expr pos:start="2747:51" pos:end="2747:53"><name pos:start="2747:51" pos:end="2747:53">csr</name></expr></argument>, <argument pos:start="2747:56" pos:end="2747:64"><expr pos:start="2747:56" pos:end="2747:64"><name pos:start="2747:56" pos:end="2747:64">pkcs7_len</name></expr></argument>, <argument pos:start="2747:67" pos:end="2747:74"><expr pos:start="2747:67" pos:end="2747:74"><name pos:start="2747:67" pos:end="2747:74">priv_key</name></expr></argument>, <argument pos:start="2747:77" pos:end="2747:77"><expr pos:start="2747:77" pos:end="2747:77"><literal type="number" pos:start="2747:77" pos:end="2747:77">0</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	</block_content>}</block></if> <else pos:start="2748:11" pos:end="2750:9">else <block pos:start="2748:16" pos:end="2750:9">{<block_content pos:start="2749:11" pos:end="2749:66">
	  <expr_stmt pos:start="2749:11" pos:end="2749:66"><expr pos:start="2749:11" pos:end="2749:65"><name pos:start="2749:11" pos:end="2749:12">rv</name> <operator pos:start="2749:14" pos:end="2749:14">=</operator> <call pos:start="2749:16" pos:end="2749:65"><name pos:start="2749:16" pos:end="2749:36">est_client_enroll_req</name><argument_list pos:start="2749:37" pos:end="2749:65">(<argument pos:start="2749:38" pos:end="2749:40"><expr pos:start="2749:38" pos:end="2749:40"><name pos:start="2749:38" pos:end="2749:40">ctx</name></expr></argument>, <argument pos:start="2749:43" pos:end="2749:45"><expr pos:start="2749:43" pos:end="2749:45"><name pos:start="2749:43" pos:end="2749:45">ssl</name></expr></argument>, <argument pos:start="2749:48" pos:end="2749:50"><expr pos:start="2749:48" pos:end="2749:50"><name pos:start="2749:48" pos:end="2749:50">csr</name></expr></argument>, <argument pos:start="2749:53" pos:end="2749:61"><expr pos:start="2749:53" pos:end="2749:61"><name pos:start="2749:53" pos:end="2749:61">pkcs7_len</name></expr></argument>, <argument pos:start="2749:64" pos:end="2749:64"><expr pos:start="2749:64" pos:end="2749:64"><literal type="number" pos:start="2749:64" pos:end="2749:64">0</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	</block_content>}</block></else></if_stmt>
        <if_stmt pos:start="2751:9" pos:end="2753:9"><if pos:start="2751:9" pos:end="2753:9">if <condition pos:start="2751:12" pos:end="2751:31">(<expr pos:start="2751:13" pos:end="2751:30"><name pos:start="2751:13" pos:end="2751:14">rv</name> <operator pos:start="2751:16" pos:end="2751:17">!=</operator> <name pos:start="2751:19" pos:end="2751:30">EST_ERR_NONE</name></expr>)</condition> <block pos:start="2751:33" pos:end="2753:9">{<block_content pos:start="2752:13" pos:end="2752:94">
            <expr_stmt pos:start="2752:13" pos:end="2752:94"><expr pos:start="2752:13" pos:end="2752:93"><call pos:start="2752:13" pos:end="2752:93"><name pos:start="2752:13" pos:end="2752:23">EST_LOG_ERR</name><argument_list pos:start="2752:24" pos:end="2752:93">(<argument pos:start="2752:25" pos:end="2752:92"><expr pos:start="2752:25" pos:end="2752:92"><literal type="string" pos:start="2752:25" pos:end="2752:92">"Enroll failed on second attempt during basic/digest authentication"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></if></if_stmt>
        <expr_stmt pos:start="2754:9" pos:end="2754:41"><expr pos:start="2754:9" pos:end="2754:40"><call pos:start="2754:9" pos:end="2754:40"><name pos:start="2754:9" pos:end="2754:29">est_client_disconnect</name><argument_list pos:start="2754:30" pos:end="2754:40">(<argument pos:start="2754:31" pos:end="2754:33"><expr pos:start="2754:31" pos:end="2754:33"><name pos:start="2754:31" pos:end="2754:33">ctx</name></expr></argument>, <argument pos:start="2754:36" pos:end="2754:39"><expr pos:start="2754:36" pos:end="2754:39"><operator pos:start="2754:36" pos:end="2754:36">&amp;</operator><name pos:start="2754:37" pos:end="2754:39">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>

<label pos:start="2757:1" pos:end="2757:4"><name pos:start="2757:1" pos:end="2757:3">err</name>:</label>    
    <if_stmt pos:start="2758:5" pos:end="2761:5"><if pos:start="2758:5" pos:end="2761:5">if <condition pos:start="2758:8" pos:end="2758:12">(<expr pos:start="2758:9" pos:end="2758:11"><name pos:start="2758:9" pos:end="2758:11">ssl</name></expr>)</condition> <block pos:start="2758:14" pos:end="2761:5">{<block_content pos:start="2759:9" pos:end="2760:22">
        <expr_stmt pos:start="2759:9" pos:end="2759:26"><expr pos:start="2759:9" pos:end="2759:25"><call pos:start="2759:9" pos:end="2759:25"><name pos:start="2759:9" pos:end="2759:20">SSL_shutdown</name><argument_list pos:start="2759:21" pos:end="2759:25">(<argument pos:start="2759:22" pos:end="2759:24"><expr pos:start="2759:22" pos:end="2759:24"><name pos:start="2759:22" pos:end="2759:24">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2760:9" pos:end="2760:22"><expr pos:start="2760:9" pos:end="2760:21"><call pos:start="2760:9" pos:end="2760:21"><name pos:start="2760:9" pos:end="2760:16">SSL_free</name><argument_list pos:start="2760:17" pos:end="2760:21">(<argument pos:start="2760:18" pos:end="2760:20"><expr pos:start="2760:18" pos:end="2760:20"><name pos:start="2760:18" pos:end="2760:20">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>

    <return pos:start="2763:5" pos:end="2763:16">return <expr pos:start="2763:12" pos:end="2763:15"><operator pos:start="2763:12" pos:end="2763:12">(</operator><name pos:start="2763:13" pos:end="2763:14">rv</name><operator pos:start="2763:15" pos:end="2763:15">)</operator></expr>;</return>

</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="2766:1" pos:end="2790:3">/*! @brief est_client_enroll() performs the simple enroll request with the EST
     server
 
    @param ctx Pointer to an EST context
    @param cn Pointer to the Common Name value to be used in the enrollment
    request.
    @param pkcs7_len Pointer to an integer to hold the length of the PKCS7
    buffer.
    @param new_public_key Pointer an EVP_PKEY structure that holds the
    client's key pair to be used in the simple enroll request .  The public
    key is included in the Certificate Signing Request (CSR) sent to the CA
    Server, and the private key is used to sign the request.
 
    @return EST_ERROR

    est_client_enroll() connects to the EST server, builds a simple enroll
    request using the Common Name passed in cn, establishes a SSL/TLS
    connection to the EST server that was configured with the previous call to
    est_client_set_server(), and sends the simple enroll request.  The
    response is stored in the EST context and the length is passed back to the
    application through the pkcs7_len parameter of this function.  The
    application can then allocate a correctly sized buffer and call
    est_client_copy_enrolled_cert() to retrieve the new client certificate
    from the context.
 */</comment>
<function pos:start="2791:1" pos:end="2866:1"><type pos:start="2791:1" pos:end="2791:9"><name pos:start="2791:1" pos:end="2791:9">EST_ERROR</name></type> <name pos:start="2791:11" pos:end="2791:27">est_client_enroll</name> <parameter_list pos:start="2791:29" pos:end="2792:54">(<parameter pos:start="2791:30" pos:end="2791:41"><decl pos:start="2791:30" pos:end="2791:41"><type pos:start="2791:30" pos:end="2791:41"><name pos:start="2791:30" pos:end="2791:36">EST_CTX</name> <modifier pos:start="2791:38" pos:end="2791:38">*</modifier></type><name pos:start="2791:39" pos:end="2791:41">ctx</name></decl></parameter>, <parameter pos:start="2791:44" pos:end="2791:51"><decl pos:start="2791:44" pos:end="2791:51"><type pos:start="2791:44" pos:end="2791:51"><name pos:start="2791:44" pos:end="2791:47">char</name> <modifier pos:start="2791:49" pos:end="2791:49">*</modifier></type><name pos:start="2791:50" pos:end="2791:51">cn</name></decl></parameter>, <parameter pos:start="2791:54" pos:end="2791:67"><decl pos:start="2791:54" pos:end="2791:67"><type pos:start="2791:54" pos:end="2791:67"><name pos:start="2791:54" pos:end="2791:56">int</name> <modifier pos:start="2791:58" pos:end="2791:58">*</modifier></type><name pos:start="2791:59" pos:end="2791:67">pkcs7_len</name></decl></parameter>,
                             <parameter pos:start="2792:30" pos:end="2792:53"><decl pos:start="2792:30" pos:end="2792:53"><type pos:start="2792:30" pos:end="2792:53"><name pos:start="2792:30" pos:end="2792:37">EVP_PKEY</name> <modifier pos:start="2792:39" pos:end="2792:39">*</modifier></type><name pos:start="2792:40" pos:end="2792:53">new_public_key</name></decl></parameter>)</parameter_list>
<block pos:start="2793:1" pos:end="2866:1">{<block_content pos:start="2794:5" pos:end="2865:16">
    <decl_stmt pos:start="2794:5" pos:end="2794:17"><decl pos:start="2794:5" pos:end="2794:16"><type pos:start="2794:5" pos:end="2794:13"><name pos:start="2794:5" pos:end="2794:13">EST_ERROR</name></type> <name pos:start="2794:15" pos:end="2794:16">rv</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2795:5" pos:end="2795:20"><decl pos:start="2795:5" pos:end="2795:19"><type pos:start="2795:5" pos:end="2795:9"><name pos:start="2795:5" pos:end="2795:7">SSL</name> <modifier pos:start="2795:9" pos:end="2795:9">*</modifier></type><name pos:start="2795:10" pos:end="2795:12">ssl</name> <init pos:start="2795:14" pos:end="2795:19">= <expr pos:start="2795:16" pos:end="2795:19"><name pos:start="2795:16" pos:end="2795:19">NULL</name></expr></init></decl>;</decl_stmt>

    <if_stmt pos:start="2797:5" pos:end="2799:5"><if pos:start="2797:5" pos:end="2799:5">if <condition pos:start="2797:8" pos:end="2797:13">(<expr pos:start="2797:9" pos:end="2797:12"><operator pos:start="2797:9" pos:end="2797:9">!</operator><name pos:start="2797:10" pos:end="2797:12">ctx</name></expr>)</condition> <block pos:start="2797:15" pos:end="2799:5">{<block_content pos:start="2798:9" pos:end="2798:32">
        <return pos:start="2798:9" pos:end="2798:32">return <expr pos:start="2798:16" pos:end="2798:31"><operator pos:start="2798:16" pos:end="2798:16">(</operator><name pos:start="2798:17" pos:end="2798:30">EST_ERR_NO_CTX</name><operator pos:start="2798:31" pos:end="2798:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="2801:5" pos:end="2803:5"><if pos:start="2801:5" pos:end="2803:5">if <condition pos:start="2801:8" pos:end="2801:24">(<expr pos:start="2801:9" pos:end="2801:23"><operator pos:start="2801:9" pos:end="2801:9">!</operator><name pos:start="2801:10" pos:end="2801:23">new_public_key</name></expr>)</condition> <block pos:start="2801:26" pos:end="2803:5">{<block_content pos:start="2802:9" pos:end="2802:32">
        <return pos:start="2802:9" pos:end="2802:32">return <expr pos:start="2802:16" pos:end="2802:31"><operator pos:start="2802:16" pos:end="2802:16">(</operator><name pos:start="2802:17" pos:end="2802:30">EST_ERR_NO_KEY</name><operator pos:start="2802:31" pos:end="2802:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="2805:5" pos:end="2807:5"><if pos:start="2805:5" pos:end="2807:5">if <condition pos:start="2805:8" pos:end="2805:37">(<expr pos:start="2805:9" pos:end="2805:36"><operator pos:start="2805:9" pos:end="2805:9">!</operator><name pos:start="2805:10" pos:end="2805:36"><name pos:start="2805:10" pos:end="2805:12">ctx</name><operator pos:start="2805:13" pos:end="2805:14">-&gt;</operator><name pos:start="2805:15" pos:end="2805:36">est_client_initialized</name></name></expr>)</condition> <block pos:start="2805:39" pos:end="2807:5">{<block_content pos:start="2806:9" pos:end="2806:46">
        <return pos:start="2806:9" pos:end="2806:46">return <expr pos:start="2806:16" pos:end="2806:45"><name pos:start="2806:16" pos:end="2806:45">EST_ERR_CLIENT_NOT_INITIALIZED</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="2809:5" pos:end="2809:39"><expr pos:start="2809:5" pos:end="2809:38"><name pos:start="2809:5" pos:end="2809:6">rv</name> <operator pos:start="2809:8" pos:end="2809:8">=</operator> <call pos:start="2809:10" pos:end="2809:38"><name pos:start="2809:10" pos:end="2809:27">est_client_connect</name><argument_list pos:start="2809:28" pos:end="2809:38">(<argument pos:start="2809:29" pos:end="2809:31"><expr pos:start="2809:29" pos:end="2809:31"><name pos:start="2809:29" pos:end="2809:31">ctx</name></expr></argument>, <argument pos:start="2809:34" pos:end="2809:37"><expr pos:start="2809:34" pos:end="2809:37"><operator pos:start="2809:34" pos:end="2809:34">&amp;</operator><name pos:start="2809:35" pos:end="2809:37">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2810:5" pos:end="2812:5"><if pos:start="2810:5" pos:end="2812:5">if <condition pos:start="2810:8" pos:end="2810:27">(<expr pos:start="2810:9" pos:end="2810:26"><name pos:start="2810:9" pos:end="2810:10">rv</name> <operator pos:start="2810:12" pos:end="2810:13">!=</operator> <name pos:start="2810:15" pos:end="2810:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="2810:29" pos:end="2812:5">{<block_content pos:start="2811:9" pos:end="2811:17">
        <goto pos:start="2811:9" pos:end="2811:17">goto <name pos:start="2811:14" pos:end="2811:16">err</name>;</goto>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="2813:5" pos:end="2813:71"><expr pos:start="2813:5" pos:end="2813:70"><name pos:start="2813:5" pos:end="2813:6">rv</name> <operator pos:start="2813:8" pos:end="2813:8">=</operator> <call pos:start="2813:10" pos:end="2813:70"><name pos:start="2813:10" pos:end="2813:29">est_client_enroll_cn</name><argument_list pos:start="2813:30" pos:end="2813:70">(<argument pos:start="2813:31" pos:end="2813:33"><expr pos:start="2813:31" pos:end="2813:33"><name pos:start="2813:31" pos:end="2813:33">ctx</name></expr></argument>, <argument pos:start="2813:36" pos:end="2813:38"><expr pos:start="2813:36" pos:end="2813:38"><name pos:start="2813:36" pos:end="2813:38">ssl</name></expr></argument>, <argument pos:start="2813:41" pos:end="2813:42"><expr pos:start="2813:41" pos:end="2813:42"><name pos:start="2813:41" pos:end="2813:42">cn</name></expr></argument>, <argument pos:start="2813:45" pos:end="2813:53"><expr pos:start="2813:45" pos:end="2813:53"><name pos:start="2813:45" pos:end="2813:53">pkcs7_len</name></expr></argument>, <argument pos:start="2813:56" pos:end="2813:69"><expr pos:start="2813:56" pos:end="2813:69"><name pos:start="2813:56" pos:end="2813:69">new_public_key</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="2814:5" pos:end="2814:37"><expr pos:start="2814:5" pos:end="2814:36"><call pos:start="2814:5" pos:end="2814:36"><name pos:start="2814:5" pos:end="2814:25">est_client_disconnect</name><argument_list pos:start="2814:26" pos:end="2814:36">(<argument pos:start="2814:27" pos:end="2814:29"><expr pos:start="2814:27" pos:end="2814:29"><name pos:start="2814:27" pos:end="2814:29">ctx</name></expr></argument>, <argument pos:start="2814:32" pos:end="2814:35"><expr pos:start="2814:32" pos:end="2814:35"><operator pos:start="2814:32" pos:end="2814:32">&amp;</operator><name pos:start="2814:33" pos:end="2814:35">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2815:5" pos:end="2855:5"><if pos:start="2815:5" pos:end="2855:5">if <condition pos:start="2815:8" pos:end="2818:39">(<expr pos:start="2815:9" pos:end="2818:38"><name pos:start="2815:9" pos:end="2815:10">rv</name> <operator pos:start="2815:12" pos:end="2815:13">==</operator> <name pos:start="2815:15" pos:end="2815:31">EST_ERR_AUTH_FAIL</name> <operator pos:start="2815:33" pos:end="2815:34">&amp;&amp;</operator>
        <operator pos:start="2816:9" pos:end="2816:9">(</operator><name pos:start="2816:10" pos:end="2816:23"><name pos:start="2816:10" pos:end="2816:12">ctx</name><operator pos:start="2816:13" pos:end="2816:14">-&gt;</operator><name pos:start="2816:15" pos:end="2816:23">auth_mode</name></name> <operator pos:start="2816:25" pos:end="2816:26">==</operator> <name pos:start="2816:28" pos:end="2816:38">AUTH_DIGEST</name> <operator pos:start="2816:40" pos:end="2816:41">||</operator>
         <name pos:start="2817:10" pos:end="2817:23"><name pos:start="2817:10" pos:end="2817:12">ctx</name><operator pos:start="2817:13" pos:end="2817:14">-&gt;</operator><name pos:start="2817:15" pos:end="2817:23">auth_mode</name></name> <operator pos:start="2817:25" pos:end="2817:26">==</operator> <name pos:start="2817:28" pos:end="2817:37">AUTH_BASIC</name>  <operator pos:start="2817:40" pos:end="2817:41">||</operator>
         <name pos:start="2818:10" pos:end="2818:23"><name pos:start="2818:10" pos:end="2818:12">ctx</name><operator pos:start="2818:13" pos:end="2818:14">-&gt;</operator><name pos:start="2818:15" pos:end="2818:23">auth_mode</name></name> <operator pos:start="2818:25" pos:end="2818:26">==</operator> <name pos:start="2818:28" pos:end="2818:37">AUTH_TOKEN</name><operator pos:start="2818:38" pos:end="2818:38">)</operator></expr>)</condition> <block pos:start="2818:41" pos:end="2855:5">{<block_content pos:start="2824:9" pos:end="2854:41">

        <comment type="block" pos:start="2820:9" pos:end="2823:11">/*
         * HTTPS digest mode requires the use of MD5.  Make sure we're not
         * in FIPS mode and can use MD5
         */</comment>
        <if_stmt pos:start="2824:9" pos:end="2828:9"><if pos:start="2824:9" pos:end="2828:9">if <condition pos:start="2824:12" pos:end="2824:59">(<expr pos:start="2824:13" pos:end="2824:58"><name pos:start="2824:13" pos:end="2824:26"><name pos:start="2824:13" pos:end="2824:15">ctx</name><operator pos:start="2824:16" pos:end="2824:17">-&gt;</operator><name pos:start="2824:18" pos:end="2824:26">auth_mode</name></name> <operator pos:start="2824:28" pos:end="2824:29">==</operator> <name pos:start="2824:31" pos:end="2824:41">AUTH_DIGEST</name> <operator pos:start="2824:43" pos:end="2824:44">&amp;&amp;</operator> <operator pos:start="2824:46" pos:end="2824:46">(</operator><call pos:start="2824:47" pos:end="2824:57"><name pos:start="2824:47" pos:end="2824:55">FIPS_mode</name><argument_list pos:start="2824:56" pos:end="2824:57">()</argument_list></call><operator pos:start="2824:58" pos:end="2824:58">)</operator></expr>)</condition><block pos:start="2824:60" pos:end="2828:9">{<block_content pos:start="2825:13" pos:end="2827:21">
	    <expr_stmt pos:start="2825:13" pos:end="2825:75"><expr pos:start="2825:13" pos:end="2825:74"><call pos:start="2825:13" pos:end="2825:74"><name pos:start="2825:13" pos:end="2825:23">EST_LOG_ERR</name><argument_list pos:start="2825:24" pos:end="2825:74">(<argument pos:start="2825:25" pos:end="2825:73"><expr pos:start="2825:25" pos:end="2825:73"><literal type="string" pos:start="2825:25" pos:end="2825:73">"HTTP digest auth not allowed while in FIPS mode"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt pos:start="2826:13" pos:end="2826:34"><expr pos:start="2826:13" pos:end="2826:33"><name pos:start="2826:13" pos:end="2826:14">rv</name> <operator pos:start="2826:16" pos:end="2826:16">=</operator> <name pos:start="2826:18" pos:end="2826:33">EST_ERR_BAD_MODE</name></expr>;</expr_stmt>
            <goto pos:start="2827:13" pos:end="2827:21">goto <name pos:start="2827:18" pos:end="2827:20">err</name>;</goto>
        </block_content>}</block></if></if_stmt>
        
        <comment type="block" pos:start="2830:9" pos:end="2830:58">/* Try one more time if we're doing Digest auth */</comment>
        <expr_stmt pos:start="2831:9" pos:end="2831:90"><expr pos:start="2831:9" pos:end="2831:89"><call pos:start="2831:9" pos:end="2831:89"><name pos:start="2831:9" pos:end="2831:20">EST_LOG_INFO</name><argument_list pos:start="2831:21" pos:end="2831:89">(<argument pos:start="2831:22" pos:end="2831:88"><expr pos:start="2831:22" pos:end="2831:88"><literal type="string" pos:start="2831:22" pos:end="2831:88">"HTTP Auth failed, trying again with basic/digest/token parameters"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2832:9" pos:end="2832:43"><expr pos:start="2832:9" pos:end="2832:42"><name pos:start="2832:9" pos:end="2832:10">rv</name> <operator pos:start="2832:12" pos:end="2832:12">=</operator> <call pos:start="2832:14" pos:end="2832:42"><name pos:start="2832:14" pos:end="2832:31">est_client_connect</name><argument_list pos:start="2832:32" pos:end="2832:42">(<argument pos:start="2832:33" pos:end="2832:35"><expr pos:start="2832:33" pos:end="2832:35"><name pos:start="2832:33" pos:end="2832:35">ctx</name></expr></argument>, <argument pos:start="2832:38" pos:end="2832:41"><expr pos:start="2832:38" pos:end="2832:41"><operator pos:start="2832:38" pos:end="2832:38">&amp;</operator><name pos:start="2832:39" pos:end="2832:41">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="2833:9" pos:end="2836:9"><if pos:start="2833:9" pos:end="2836:9">if <condition pos:start="2833:12" pos:end="2833:31">(<expr pos:start="2833:13" pos:end="2833:30"><name pos:start="2833:13" pos:end="2833:14">rv</name> <operator pos:start="2833:16" pos:end="2833:17">!=</operator> <name pos:start="2833:19" pos:end="2833:30">EST_ERR_NONE</name></expr>)</condition> <block pos:start="2833:33" pos:end="2836:9">{<block_content pos:start="2834:13" pos:end="2835:21">
            <expr_stmt pos:start="2834:13" pos:end="2834:98"><expr pos:start="2834:13" pos:end="2834:97"><call pos:start="2834:13" pos:end="2834:97"><name pos:start="2834:13" pos:end="2834:23">EST_LOG_ERR</name><argument_list pos:start="2834:24" pos:end="2834:97">(<argument pos:start="2834:25" pos:end="2834:96"><expr pos:start="2834:25" pos:end="2834:96"><literal type="string" pos:start="2834:25" pos:end="2834:96">"Connection failed on second attempt with basic/digest/token parameters"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <goto pos:start="2835:13" pos:end="2835:21">goto <name pos:start="2835:18" pos:end="2835:20">err</name>;</goto>
        </block_content>}</block></if></if_stmt>
        <expr_stmt pos:start="2837:9" pos:end="2837:75"><expr pos:start="2837:9" pos:end="2837:74"><name pos:start="2837:9" pos:end="2837:10">rv</name> <operator pos:start="2837:12" pos:end="2837:12">=</operator> <call pos:start="2837:14" pos:end="2837:74"><name pos:start="2837:14" pos:end="2837:33">est_client_enroll_cn</name><argument_list pos:start="2837:34" pos:end="2837:74">(<argument pos:start="2837:35" pos:end="2837:37"><expr pos:start="2837:35" pos:end="2837:37"><name pos:start="2837:35" pos:end="2837:37">ctx</name></expr></argument>, <argument pos:start="2837:40" pos:end="2837:42"><expr pos:start="2837:40" pos:end="2837:42"><name pos:start="2837:40" pos:end="2837:42">ssl</name></expr></argument>, <argument pos:start="2837:45" pos:end="2837:46"><expr pos:start="2837:45" pos:end="2837:46"><name pos:start="2837:45" pos:end="2837:46">cn</name></expr></argument>, <argument pos:start="2837:49" pos:end="2837:57"><expr pos:start="2837:49" pos:end="2837:57"><name pos:start="2837:49" pos:end="2837:57">pkcs7_len</name></expr></argument>, <argument pos:start="2837:60" pos:end="2837:73"><expr pos:start="2837:60" pos:end="2837:73"><name pos:start="2837:60" pos:end="2837:73">new_public_key</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="2838:9" pos:end="2852:9"><if pos:start="2838:9" pos:end="2852:9">if <condition pos:start="2838:12" pos:end="2838:31">(<expr pos:start="2838:13" pos:end="2838:30"><name pos:start="2838:13" pos:end="2838:14">rv</name> <operator pos:start="2838:16" pos:end="2838:17">!=</operator> <name pos:start="2838:19" pos:end="2838:30">EST_ERR_NONE</name></expr>)</condition> <block pos:start="2838:33" pos:end="2852:9">{<block_content pos:start="2839:13" pos:end="2851:13">
            <expr_stmt pos:start="2839:13" pos:end="2839:94"><expr pos:start="2839:13" pos:end="2839:93"><call pos:start="2839:13" pos:end="2839:93"><name pos:start="2839:13" pos:end="2839:23">EST_LOG_ERR</name><argument_list pos:start="2839:24" pos:end="2839:93">(<argument pos:start="2839:25" pos:end="2839:92"><expr pos:start="2839:25" pos:end="2839:92"><literal type="string" pos:start="2839:25" pos:end="2839:92">"Enroll failed on second attempt during basic/digest authentication"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>

            <comment type="block" pos:start="2841:13" pos:end="2844:15">/*
             * If we're attempting token mode for the second time, and
             * the server responded with error attributes, log them now
             */</comment>
            <if_stmt pos:start="2845:13" pos:end="2851:13"><if pos:start="2845:13" pos:end="2851:13">if <condition pos:start="2845:16" pos:end="2845:80">(<expr pos:start="2845:17" pos:end="2845:79"><name pos:start="2845:17" pos:end="2845:35"><name pos:start="2845:17" pos:end="2845:19">ctx</name><operator pos:start="2845:20" pos:end="2845:21">-&gt;</operator><name pos:start="2845:22" pos:end="2845:32">token_error</name><index pos:start="2845:33" pos:end="2845:35">[<expr pos:start="2845:34" pos:end="2845:34"><literal type="number" pos:start="2845:34" pos:end="2845:34">0</literal></expr>]</index></name> <operator pos:start="2845:37" pos:end="2845:38">!=</operator> <literal type="char" pos:start="2845:40" pos:end="2845:43">'\0'</literal> <operator pos:start="2845:45" pos:end="2845:46">||</operator> <name pos:start="2845:48" pos:end="2845:71"><name pos:start="2845:48" pos:end="2845:50">ctx</name><operator pos:start="2845:51" pos:end="2845:52">-&gt;</operator><name pos:start="2845:53" pos:end="2845:68">token_error_desc</name><index pos:start="2845:69" pos:end="2845:71">[<expr pos:start="2845:70" pos:end="2845:70"><literal type="number" pos:start="2845:70" pos:end="2845:70">0</literal></expr>]</index></name> <operator pos:start="2845:73" pos:end="2845:74">!=</operator> <literal type="char" pos:start="2845:76" pos:end="2845:79">'\0'</literal></expr>)</condition> <block pos:start="2845:82" pos:end="2851:13">{<block_content pos:start="2846:17" pos:end="2850:48">
                <expr_stmt pos:start="2846:17" pos:end="2848:69"><expr pos:start="2846:17" pos:end="2848:68"><call pos:start="2846:17" pos:end="2848:68"><name pos:start="2846:17" pos:end="2846:27">EST_LOG_ERR</name><argument_list pos:start="2846:28" pos:end="2848:68">(<argument pos:start="2846:29" pos:end="2847:67"><expr pos:start="2846:29" pos:end="2847:67"><literal type="string" pos:start="2846:29" pos:end="2846:91">"Token Auth mode failed, server provided error information: \n"</literal>
                            <literal type="string" pos:start="2847:29" pos:end="2847:67">"   Error = %s\n Error description: %s"</literal></expr></argument>,
                            <argument pos:start="2848:29" pos:end="2848:44"><expr pos:start="2848:29" pos:end="2848:44"><name pos:start="2848:29" pos:end="2848:44"><name pos:start="2848:29" pos:end="2848:31">ctx</name><operator pos:start="2848:32" pos:end="2848:33">-&gt;</operator><name pos:start="2848:34" pos:end="2848:44">token_error</name></name></expr></argument>, <argument pos:start="2848:47" pos:end="2848:67"><expr pos:start="2848:47" pos:end="2848:67"><name pos:start="2848:47" pos:end="2848:67"><name pos:start="2848:47" pos:end="2848:49">ctx</name><operator pos:start="2848:50" pos:end="2848:51">-&gt;</operator><name pos:start="2848:52" pos:end="2848:67">token_error_desc</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt pos:start="2849:17" pos:end="2849:43"><expr pos:start="2849:17" pos:end="2849:42"><name pos:start="2849:17" pos:end="2849:35"><name pos:start="2849:17" pos:end="2849:19">ctx</name><operator pos:start="2849:20" pos:end="2849:21">-&gt;</operator><name pos:start="2849:22" pos:end="2849:32">token_error</name><index pos:start="2849:33" pos:end="2849:35">[<expr pos:start="2849:34" pos:end="2849:34"><literal type="number" pos:start="2849:34" pos:end="2849:34">0</literal></expr>]</index></name> <operator pos:start="2849:37" pos:end="2849:37">=</operator> <literal type="char" pos:start="2849:39" pos:end="2849:42">'\0'</literal></expr>;</expr_stmt>
                <expr_stmt pos:start="2850:17" pos:end="2850:48"><expr pos:start="2850:17" pos:end="2850:47"><name pos:start="2850:17" pos:end="2850:40"><name pos:start="2850:17" pos:end="2850:19">ctx</name><operator pos:start="2850:20" pos:end="2850:21">-&gt;</operator><name pos:start="2850:22" pos:end="2850:37">token_error_desc</name><index pos:start="2850:38" pos:end="2850:40">[<expr pos:start="2850:39" pos:end="2850:39"><literal type="number" pos:start="2850:39" pos:end="2850:39">0</literal></expr>]</index></name> <operator pos:start="2850:42" pos:end="2850:42">=</operator> <literal type="char" pos:start="2850:44" pos:end="2850:47">'\0'</literal></expr>;</expr_stmt>
            </block_content>}</block></if></if_stmt>            
        </block_content>}</block></if></if_stmt>
        
        <expr_stmt pos:start="2854:9" pos:end="2854:41"><expr pos:start="2854:9" pos:end="2854:40"><call pos:start="2854:9" pos:end="2854:40"><name pos:start="2854:9" pos:end="2854:29">est_client_disconnect</name><argument_list pos:start="2854:30" pos:end="2854:40">(<argument pos:start="2854:31" pos:end="2854:33"><expr pos:start="2854:31" pos:end="2854:33"><name pos:start="2854:31" pos:end="2854:33">ctx</name></expr></argument>, <argument pos:start="2854:36" pos:end="2854:39"><expr pos:start="2854:36" pos:end="2854:39"><operator pos:start="2854:36" pos:end="2854:36">&amp;</operator><name pos:start="2854:37" pos:end="2854:39">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="2857:5" pos:end="2857:31"><expr pos:start="2857:5" pos:end="2857:30"><name pos:start="2857:5" pos:end="2857:18"><name pos:start="2857:5" pos:end="2857:7">ctx</name><operator pos:start="2857:8" pos:end="2857:9">-&gt;</operator><name pos:start="2857:10" pos:end="2857:18">auth_mode</name></name> <operator pos:start="2857:20" pos:end="2857:20">=</operator> <name pos:start="2857:22" pos:end="2857:30">AUTH_NONE</name></expr>;</expr_stmt>

  <label pos:start="2859:3" pos:end="2859:6"><name pos:start="2859:3" pos:end="2859:5">err</name>:</label>    
    <if_stmt pos:start="2860:5" pos:end="2863:5"><if pos:start="2860:5" pos:end="2863:5">if <condition pos:start="2860:8" pos:end="2860:12">(<expr pos:start="2860:9" pos:end="2860:11"><name pos:start="2860:9" pos:end="2860:11">ssl</name></expr>)</condition> <block pos:start="2860:14" pos:end="2863:5">{<block_content pos:start="2861:9" pos:end="2862:22">
        <expr_stmt pos:start="2861:9" pos:end="2861:26"><expr pos:start="2861:9" pos:end="2861:25"><call pos:start="2861:9" pos:end="2861:25"><name pos:start="2861:9" pos:end="2861:20">SSL_shutdown</name><argument_list pos:start="2861:21" pos:end="2861:25">(<argument pos:start="2861:22" pos:end="2861:24"><expr pos:start="2861:22" pos:end="2861:24"><name pos:start="2861:22" pos:end="2861:24">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2862:9" pos:end="2862:22"><expr pos:start="2862:9" pos:end="2862:21"><call pos:start="2862:9" pos:end="2862:21"><name pos:start="2862:9" pos:end="2862:16">SSL_free</name><argument_list pos:start="2862:17" pos:end="2862:21">(<argument pos:start="2862:18" pos:end="2862:20"><expr pos:start="2862:18" pos:end="2862:20"><name pos:start="2862:18" pos:end="2862:20">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>

    <return pos:start="2865:5" pos:end="2865:16">return <expr pos:start="2865:12" pos:end="2865:15"><operator pos:start="2865:12" pos:end="2865:12">(</operator><name pos:start="2865:13" pos:end="2865:14">rv</name><operator pos:start="2865:15" pos:end="2865:15">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="2867:1" pos:end="2914:3">/*! @brief est_client_provision_cert() performs the full sequence of
    EST operations to enroll a new certificate using a trusted message flow.
 
    @param ctx Pointer to an EST context
    @param cn Pointer to the Common Name value to be used in the enrollment
    request.
    @param pkcs7_len Pointer to an integer to hold the length of the PKCS7
    certificate returned from the RA or CA.
    @param ca_cert_len Pointer to an integer to hold the length of the buffer 
    that will hold the new trusted CA certificates.
    @param new_public_key Pointer an EVP_PKEY structure that holds the
    client's key pair to be used in the simple enroll request .  The public
    key is included in the Certificate Signing Request (CSR) sent to the CA
    Server, and the private key is used to sign the request.
 
    @return EST_ERROR

    est_client_provision_cert() connects to the EST server, retrieves the
    latest trusted CA certifictes from the server, retrieves the CSR attributes
    from the server, and sends the simple enroll request to the server to
    provision a new certificate from the RA or CA.  This is a convenience 
    function that is equivalent to invoking the following three functions
    in order:

    est_client_get_cacerts()
    est_client_get_csrattrs()
    est_client_enroll() 

    This function takes a Common Name (CN) as the only entity identifier
    that will be used in the CSR.  If additional X509 attributes
    or extensions are required because the EST server is enforcing the
    presence of all the CSR attributes, then this function should not be used
    to provision a certificate.  The est_client_enroll_csr() function should
    be used when additional X509 attributes are to be included in the
    enroll request. 

    The provisioning response is stored in the EST context and the length is passed 
    back to the application through the pkcs7_len parameter of this function.  The
    application can then allocate a correctly sized buffer and call
    est_client_copy_enrolled_cert() to retrieve the new client certificate
    from the context.

    The provisioning response also includes the latest copy of the trusted
    CA certificates from the EST server.  These should be persisted locally
    by the application for future use.  The ca_cert_len argument will contain the 
    length of the certicates, which can then be retrieved by invoking 
    est_client_copy_cacerts().
 */</comment>
<function pos:start="2915:1" pos:end="3014:1"><type pos:start="2915:1" pos:end="2915:9"><name pos:start="2915:1" pos:end="2915:9">EST_ERROR</name></type> <name pos:start="2915:11" pos:end="2915:35">est_client_provision_cert</name> <parameter_list pos:start="2915:37" pos:end="2918:62">(<parameter pos:start="2915:38" pos:end="2915:49"><decl pos:start="2915:38" pos:end="2915:49"><type pos:start="2915:38" pos:end="2915:49"><name pos:start="2915:38" pos:end="2915:44">EST_CTX</name> <modifier pos:start="2915:46" pos:end="2915:46">*</modifier></type><name pos:start="2915:47" pos:end="2915:49">ctx</name></decl></parameter>, <parameter pos:start="2915:52" pos:end="2915:59"><decl pos:start="2915:52" pos:end="2915:59"><type pos:start="2915:52" pos:end="2915:59"><name pos:start="2915:52" pos:end="2915:55">char</name> <modifier pos:start="2915:57" pos:end="2915:57">*</modifier></type><name pos:start="2915:58" pos:end="2915:59">cn</name></decl></parameter>, 
	                             <parameter pos:start="2916:38" pos:end="2916:51"><decl pos:start="2916:38" pos:end="2916:51"><type pos:start="2916:38" pos:end="2916:51"><name pos:start="2916:38" pos:end="2916:40">int</name> <modifier pos:start="2916:42" pos:end="2916:42">*</modifier></type><name pos:start="2916:43" pos:end="2916:51">pkcs7_len</name></decl></parameter>,
				     <parameter pos:start="2917:38" pos:end="2917:53"><decl pos:start="2917:38" pos:end="2917:53"><type pos:start="2917:38" pos:end="2917:53"><name pos:start="2917:38" pos:end="2917:40">int</name> <modifier pos:start="2917:42" pos:end="2917:42">*</modifier></type><name pos:start="2917:43" pos:end="2917:53">ca_cert_len</name></decl></parameter>,
                                     <parameter pos:start="2918:38" pos:end="2918:61"><decl pos:start="2918:38" pos:end="2918:61"><type pos:start="2918:38" pos:end="2918:61"><name pos:start="2918:38" pos:end="2918:45">EVP_PKEY</name> <modifier pos:start="2918:47" pos:end="2918:47">*</modifier></type><name pos:start="2918:48" pos:end="2918:61">new_public_key</name></decl></parameter>)</parameter_list>
<block pos:start="2919:1" pos:end="3014:1">{<block_content pos:start="2920:5" pos:end="3013:16">
    <decl_stmt pos:start="2920:5" pos:end="2920:17"><decl pos:start="2920:5" pos:end="2920:16"><type pos:start="2920:5" pos:end="2920:13"><name pos:start="2920:5" pos:end="2920:13">EST_ERROR</name></type> <name pos:start="2920:15" pos:end="2920:16">rv</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2921:5" pos:end="2921:29"><decl pos:start="2921:5" pos:end="2921:28"><type pos:start="2921:5" pos:end="2921:19"><name pos:start="2921:5" pos:end="2921:12">unsigned</name> <name pos:start="2921:14" pos:end="2921:17">char</name> <modifier pos:start="2921:19" pos:end="2921:19">*</modifier></type><name pos:start="2921:20" pos:end="2921:28">new_ta_p7</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2922:5" pos:end="2922:30"><decl pos:start="2922:5" pos:end="2922:29"><type pos:start="2922:5" pos:end="2922:19"><name pos:start="2922:5" pos:end="2922:12">unsigned</name> <name pos:start="2922:14" pos:end="2922:17">char</name> <modifier pos:start="2922:19" pos:end="2922:19">*</modifier></type><name pos:start="2922:20" pos:end="2922:29">new_ta_pem</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2923:5" pos:end="2923:36"><decl pos:start="2923:5" pos:end="2923:35"><type pos:start="2923:5" pos:end="2923:19"><name pos:start="2923:5" pos:end="2923:12">unsigned</name> <name pos:start="2923:14" pos:end="2923:17">char</name> <modifier pos:start="2923:19" pos:end="2923:19">*</modifier></type><name pos:start="2923:20" pos:end="2923:28">attr_data</name> <init pos:start="2923:30" pos:end="2923:35">= <expr pos:start="2923:32" pos:end="2923:35"><name pos:start="2923:32" pos:end="2923:35">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="2924:5" pos:end="2924:17"><decl pos:start="2924:5" pos:end="2924:16"><type pos:start="2924:5" pos:end="2924:7"><name pos:start="2924:5" pos:end="2924:7">int</name></type> <name pos:start="2924:9" pos:end="2924:16">attr_len</name></decl>;</decl_stmt>
    <decl_stmt pos:start="2925:5" pos:end="2925:19"><decl pos:start="2925:5" pos:end="2925:18"><type pos:start="2925:5" pos:end="2925:7"><name pos:start="2925:5" pos:end="2925:7">int</name></type> <name pos:start="2925:9" pos:end="2925:18">new_ta_len</name></decl>;</decl_stmt>

    <if_stmt pos:start="2927:5" pos:end="2929:5"><if pos:start="2927:5" pos:end="2929:5">if <condition pos:start="2927:8" pos:end="2927:13">(<expr pos:start="2927:9" pos:end="2927:12"><operator pos:start="2927:9" pos:end="2927:9">!</operator><name pos:start="2927:10" pos:end="2927:12">ctx</name></expr>)</condition> <block pos:start="2927:15" pos:end="2929:5">{<block_content pos:start="2928:9" pos:end="2928:32">
        <return pos:start="2928:9" pos:end="2928:32">return <expr pos:start="2928:16" pos:end="2928:31"><operator pos:start="2928:16" pos:end="2928:16">(</operator><name pos:start="2928:17" pos:end="2928:30">EST_ERR_NO_CTX</name><operator pos:start="2928:31" pos:end="2928:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="2931:5" pos:end="2933:7">/*
     * Make sure we have non-NULL pointers for the lengths
     */</comment>
    <if_stmt pos:start="2934:5" pos:end="2936:5"><if pos:start="2934:5" pos:end="2936:5">if <condition pos:start="2934:8" pos:end="2934:35">(<expr pos:start="2934:9" pos:end="2934:34"><operator pos:start="2934:9" pos:end="2934:9">!</operator><name pos:start="2934:10" pos:end="2934:18">pkcs7_len</name> <operator pos:start="2934:20" pos:end="2934:21">||</operator> <operator pos:start="2934:23" pos:end="2934:23">!</operator><name pos:start="2934:24" pos:end="2934:34">ca_cert_len</name></expr>)</condition> <block pos:start="2934:37" pos:end="2936:5">{<block_content pos:start="2935:9" pos:end="2935:44">
	<return pos:start="2935:9" pos:end="2935:44">return <expr pos:start="2935:16" pos:end="2935:43"><operator pos:start="2935:16" pos:end="2935:16">(</operator><name pos:start="2935:17" pos:end="2935:42">EST_ERR_INVALID_PARAMETERS</name><operator pos:start="2935:43" pos:end="2935:43">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="2938:5" pos:end="2940:5"><if pos:start="2938:5" pos:end="2940:5">if <condition pos:start="2938:8" pos:end="2938:37">(<expr pos:start="2938:9" pos:end="2938:36"><operator pos:start="2938:9" pos:end="2938:9">!</operator><name pos:start="2938:10" pos:end="2938:36"><name pos:start="2938:10" pos:end="2938:12">ctx</name><operator pos:start="2938:13" pos:end="2938:14">-&gt;</operator><name pos:start="2938:15" pos:end="2938:36">est_client_initialized</name></name></expr>)</condition> <block pos:start="2938:39" pos:end="2940:5">{<block_content pos:start="2939:9" pos:end="2939:46">
        <return pos:start="2939:9" pos:end="2939:46">return <expr pos:start="2939:16" pos:end="2939:45"><name pos:start="2939:16" pos:end="2939:45">EST_ERR_CLIENT_NOT_INITIALIZED</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="2942:5" pos:end="2944:5"><if pos:start="2942:5" pos:end="2944:5">if <condition pos:start="2942:8" pos:end="2942:24">(<expr pos:start="2942:9" pos:end="2942:23"><operator pos:start="2942:9" pos:end="2942:9">!</operator><name pos:start="2942:10" pos:end="2942:23">new_public_key</name></expr>)</condition> <block pos:start="2942:26" pos:end="2944:5">{<block_content pos:start="2943:9" pos:end="2943:32">
        <return pos:start="2943:9" pos:end="2943:32">return <expr pos:start="2943:16" pos:end="2943:31"><operator pos:start="2943:16" pos:end="2943:16">(</operator><name pos:start="2943:17" pos:end="2943:30">EST_ERR_NO_KEY</name><operator pos:start="2943:31" pos:end="2943:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="2946:5" pos:end="2948:7">/*
     * First, get the latest trust anchor certs from the server.
     */</comment>
    <expr_stmt pos:start="2949:5" pos:end="2949:50"><expr pos:start="2949:5" pos:end="2949:49"><name pos:start="2949:5" pos:end="2949:6">rv</name> <operator pos:start="2949:8" pos:end="2949:8">=</operator> <call pos:start="2949:10" pos:end="2949:49"><name pos:start="2949:10" pos:end="2949:31">est_client_get_cacerts</name><argument_list pos:start="2949:32" pos:end="2949:49">(<argument pos:start="2949:33" pos:end="2949:35"><expr pos:start="2949:33" pos:end="2949:35"><name pos:start="2949:33" pos:end="2949:35">ctx</name></expr></argument>, <argument pos:start="2949:38" pos:end="2949:48"><expr pos:start="2949:38" pos:end="2949:48"><name pos:start="2949:38" pos:end="2949:48">ca_cert_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2950:5" pos:end="2952:5"><if pos:start="2950:5" pos:end="2952:5">if <condition pos:start="2950:8" pos:end="2950:27">(<expr pos:start="2950:9" pos:end="2950:26"><name pos:start="2950:9" pos:end="2950:10">rv</name> <operator pos:start="2950:12" pos:end="2950:13">!=</operator> <name pos:start="2950:15" pos:end="2950:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="2950:29" pos:end="2952:5">{<block_content pos:start="2951:9" pos:end="2951:18">
	<return pos:start="2951:9" pos:end="2951:18">return <expr pos:start="2951:16" pos:end="2951:17"><name pos:start="2951:16" pos:end="2951:17">rv</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="2953:5" pos:end="2953:37"><expr pos:start="2953:5" pos:end="2953:36"><name pos:start="2953:5" pos:end="2953:13">new_ta_p7</name> <operator pos:start="2953:15" pos:end="2953:15">=</operator> <call pos:start="2953:17" pos:end="2953:36"><name pos:start="2953:17" pos:end="2953:22">malloc</name><argument_list pos:start="2953:23" pos:end="2953:36">(<argument pos:start="2953:24" pos:end="2953:35"><expr pos:start="2953:24" pos:end="2953:35"><operator pos:start="2953:24" pos:end="2953:24">*</operator><name pos:start="2953:25" pos:end="2953:35">ca_cert_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2954:5" pos:end="2958:5"><if pos:start="2954:5" pos:end="2958:5">if <condition pos:start="2954:8" pos:end="2954:26">(<expr pos:start="2954:9" pos:end="2954:25"><name pos:start="2954:9" pos:end="2954:17">new_ta_p7</name> <operator pos:start="2954:19" pos:end="2954:20">==</operator> <name pos:start="2954:22" pos:end="2954:25">NULL</name></expr>)</condition> <block pos:start="2954:28" pos:end="2958:5">{<block_content pos:start="2955:9" pos:end="2957:18">
        <expr_stmt pos:start="2955:9" pos:end="2955:58"><expr pos:start="2955:9" pos:end="2955:57"><call pos:start="2955:9" pos:end="2955:57"><name pos:start="2955:9" pos:end="2955:19">EST_LOG_ERR</name><argument_list pos:start="2955:20" pos:end="2955:57">(<argument pos:start="2955:21" pos:end="2955:56"><expr pos:start="2955:21" pos:end="2955:56"><literal type="string" pos:start="2955:21" pos:end="2955:56">"Unable to allocate CA certs buffer"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="2956:9" pos:end="2956:28"><expr pos:start="2956:9" pos:end="2956:27"><name pos:start="2956:9" pos:end="2956:10">rv</name> <operator pos:start="2956:12" pos:end="2956:12">=</operator> <name pos:start="2956:14" pos:end="2956:27">EST_ERR_MALLOC</name></expr>;</expr_stmt>
        <return pos:start="2957:9" pos:end="2957:18">return <expr pos:start="2957:16" pos:end="2957:17"><name pos:start="2957:16" pos:end="2957:17">rv</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="2959:5" pos:end="2959:49"><expr pos:start="2959:5" pos:end="2959:48"><name pos:start="2959:5" pos:end="2959:6">rv</name> <operator pos:start="2959:8" pos:end="2959:8">=</operator> <call pos:start="2959:10" pos:end="2959:48"><name pos:start="2959:10" pos:end="2959:32">est_client_copy_cacerts</name><argument_list pos:start="2959:33" pos:end="2959:48">(<argument pos:start="2959:34" pos:end="2959:36"><expr pos:start="2959:34" pos:end="2959:36"><name pos:start="2959:34" pos:end="2959:36">ctx</name></expr></argument>, <argument pos:start="2959:39" pos:end="2959:47"><expr pos:start="2959:39" pos:end="2959:47"><name pos:start="2959:39" pos:end="2959:47">new_ta_p7</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2960:5" pos:end="2963:5"><if pos:start="2960:5" pos:end="2963:5">if <condition pos:start="2960:8" pos:end="2960:27">(<expr pos:start="2960:9" pos:end="2960:26"><name pos:start="2960:9" pos:end="2960:10">rv</name> <operator pos:start="2960:12" pos:end="2960:13">!=</operator> <name pos:start="2960:15" pos:end="2960:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="2960:29" pos:end="2963:5">{<block_content pos:start="2961:9" pos:end="2962:20">
	<expr_stmt pos:start="2961:9" pos:end="2961:24"><expr pos:start="2961:9" pos:end="2961:23"><call pos:start="2961:9" pos:end="2961:23"><name pos:start="2961:9" pos:end="2961:12">free</name><argument_list pos:start="2961:13" pos:end="2961:23">(<argument pos:start="2961:14" pos:end="2961:22"><expr pos:start="2961:14" pos:end="2961:22"><name pos:start="2961:14" pos:end="2961:22">new_ta_p7</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return pos:start="2962:9" pos:end="2962:20">return <expr pos:start="2962:16" pos:end="2962:19"><operator pos:start="2962:16" pos:end="2962:16">(</operator><name pos:start="2962:17" pos:end="2962:18">rv</name><operator pos:start="2962:19" pos:end="2962:19">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="2965:5" pos:end="2968:7">/*
     * The certs are base64 DER encoded.  We need to convert
     * them to PEM.
     */</comment>
    <expr_stmt pos:start="2969:5" pos:end="2969:81"><expr pos:start="2969:5" pos:end="2969:80"><name pos:start="2969:5" pos:end="2969:14">new_ta_len</name> <operator pos:start="2969:16" pos:end="2969:16">=</operator> <call pos:start="2969:18" pos:end="2969:80"><name pos:start="2969:18" pos:end="2969:41">est_convert_p7b64_to_pem</name> <argument_list pos:start="2969:43" pos:end="2969:80">(<argument pos:start="2969:44" pos:end="2969:52"><expr pos:start="2969:44" pos:end="2969:52"><name pos:start="2969:44" pos:end="2969:52">new_ta_p7</name></expr></argument>, <argument pos:start="2969:55" pos:end="2969:66"><expr pos:start="2969:55" pos:end="2969:66"><operator pos:start="2969:55" pos:end="2969:55">*</operator><name pos:start="2969:56" pos:end="2969:66">ca_cert_len</name></expr></argument>, <argument pos:start="2969:69" pos:end="2969:79"><expr pos:start="2969:69" pos:end="2969:79"><operator pos:start="2969:69" pos:end="2969:69">&amp;</operator><name pos:start="2969:70" pos:end="2969:79">new_ta_pem</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="2970:5" pos:end="2970:20"><expr pos:start="2970:5" pos:end="2970:19"><call pos:start="2970:5" pos:end="2970:19"><name pos:start="2970:5" pos:end="2970:8">free</name><argument_list pos:start="2970:9" pos:end="2970:19">(<argument pos:start="2970:10" pos:end="2970:18"><expr pos:start="2970:10" pos:end="2970:18"><name pos:start="2970:10" pos:end="2970:18">new_ta_p7</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2971:5" pos:end="2973:5"><if pos:start="2971:5" pos:end="2973:5">if <condition pos:start="2971:8" pos:end="2971:24">(<expr pos:start="2971:9" pos:end="2971:23"><name pos:start="2971:9" pos:end="2971:18">new_ta_len</name> <operator pos:start="2971:20" pos:end="2971:21">&lt;=</operator> <literal type="number" pos:start="2971:23" pos:end="2971:23">0</literal></expr>)</condition> <block pos:start="2971:26" pos:end="2973:5">{<block_content pos:start="2972:9" pos:end="2972:34">
	<return pos:start="2972:9" pos:end="2972:34">return <expr pos:start="2972:16" pos:end="2972:33"><operator pos:start="2972:16" pos:end="2972:16">(</operator><name pos:start="2972:17" pos:end="2972:32">EST_ERR_PEM_READ</name><operator pos:start="2972:33" pos:end="2972:33">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="2975:5" pos:end="2980:7">/*
     * We now have the new trust anchor and it's PEM encoded.
     * Let's load it into the current EST context.  All
     * future EST operations will then be using this new
     * trust anchor.
     */</comment>
    <if_stmt pos:start="2981:5" pos:end="2983:5"><if pos:start="2981:5" pos:end="2983:5">if <condition pos:start="2981:8" pos:end="2981:41">(<expr pos:start="2981:9" pos:end="2981:40"><name pos:start="2981:9" pos:end="2981:32"><name pos:start="2981:9" pos:end="2981:11">ctx</name><operator pos:start="2981:12" pos:end="2981:13">-&gt;</operator><name pos:start="2981:14" pos:end="2981:32">trusted_certs_store</name></name> <operator pos:start="2981:34" pos:end="2981:35">!=</operator> <name pos:start="2981:37" pos:end="2981:40">NULL</name></expr>)</condition> <block pos:start="2981:43" pos:end="2983:5">{<block_content pos:start="2982:9" pos:end="2982:50">
        <expr_stmt pos:start="2982:9" pos:end="2982:50"><expr pos:start="2982:9" pos:end="2982:49"><call pos:start="2982:9" pos:end="2982:49"><name pos:start="2982:9" pos:end="2982:23">X509_STORE_free</name><argument_list pos:start="2982:24" pos:end="2982:49">(<argument pos:start="2982:25" pos:end="2982:48"><expr pos:start="2982:25" pos:end="2982:48"><name pos:start="2982:25" pos:end="2982:48"><name pos:start="2982:25" pos:end="2982:27">ctx</name><operator pos:start="2982:28" pos:end="2982:29">-&gt;</operator><name pos:start="2982:30" pos:end="2982:48">trusted_certs_store</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="2984:5" pos:end="2984:61"><expr pos:start="2984:5" pos:end="2984:60"><name pos:start="2984:5" pos:end="2984:6">rv</name> <operator pos:start="2984:8" pos:end="2984:8">=</operator> <call pos:start="2984:10" pos:end="2984:60"><name pos:start="2984:10" pos:end="2984:31">est_load_trusted_certs</name><argument_list pos:start="2984:32" pos:end="2984:60">(<argument pos:start="2984:33" pos:end="2984:35"><expr pos:start="2984:33" pos:end="2984:35"><name pos:start="2984:33" pos:end="2984:35">ctx</name></expr></argument>, <argument pos:start="2984:38" pos:end="2984:47"><expr pos:start="2984:38" pos:end="2984:47"><name pos:start="2984:38" pos:end="2984:47">new_ta_pem</name></expr></argument>, <argument pos:start="2984:50" pos:end="2984:59"><expr pos:start="2984:50" pos:end="2984:59"><name pos:start="2984:50" pos:end="2984:59">new_ta_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="2985:5" pos:end="2985:21"><expr pos:start="2985:5" pos:end="2985:20"><call pos:start="2985:5" pos:end="2985:20"><name pos:start="2985:5" pos:end="2985:8">free</name><argument_list pos:start="2985:9" pos:end="2985:20">(<argument pos:start="2985:10" pos:end="2985:19"><expr pos:start="2985:10" pos:end="2985:19"><name pos:start="2985:10" pos:end="2985:19">new_ta_pem</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="2986:5" pos:end="2988:5"><if pos:start="2986:5" pos:end="2988:5">if <condition pos:start="2986:8" pos:end="2986:27">(<expr pos:start="2986:9" pos:end="2986:26"><name pos:start="2986:9" pos:end="2986:10">rv</name> <operator pos:start="2986:12" pos:end="2986:13">!=</operator> <name pos:start="2986:15" pos:end="2986:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="2986:29" pos:end="2988:5">{<block_content pos:start="2987:9" pos:end="2987:18">
        <return pos:start="2987:9" pos:end="2987:18">return <expr pos:start="2987:16" pos:end="2987:17"><name pos:start="2987:16" pos:end="2987:17">rv</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    
    <comment type="block" pos:start="2990:5" pos:end="2993:7">/*
     * Since we've reset the trust store, mark the client
     * context as initialized.
     */</comment>
    <expr_stmt pos:start="2994:5" pos:end="2994:36"><expr pos:start="2994:5" pos:end="2994:35"><name pos:start="2994:5" pos:end="2994:31"><name pos:start="2994:5" pos:end="2994:7">ctx</name><operator pos:start="2994:8" pos:end="2994:9">-&gt;</operator><name pos:start="2994:10" pos:end="2994:31">est_client_initialized</name></name> <operator pos:start="2994:33" pos:end="2994:33">=</operator> <literal type="number" pos:start="2994:35" pos:end="2994:35">1</literal></expr>;</expr_stmt>

    <comment type="block" pos:start="2996:5" pos:end="3000:7">/*
     * Next we need to get the CSR attributes, which allows libEST
     * to know if the challengePassword needs to be included in the
     * CSR.
     */</comment>
    <expr_stmt pos:start="3001:5" pos:end="3001:61"><expr pos:start="3001:5" pos:end="3001:60"><name pos:start="3001:5" pos:end="3001:6">rv</name> <operator pos:start="3001:8" pos:end="3001:8">=</operator> <call pos:start="3001:10" pos:end="3001:60"><name pos:start="3001:10" pos:end="3001:32">est_client_get_csrattrs</name><argument_list pos:start="3001:33" pos:end="3001:60">(<argument pos:start="3001:34" pos:end="3001:36"><expr pos:start="3001:34" pos:end="3001:36"><name pos:start="3001:34" pos:end="3001:36">ctx</name></expr></argument>, <argument pos:start="3001:39" pos:end="3001:48"><expr pos:start="3001:39" pos:end="3001:48"><operator pos:start="3001:39" pos:end="3001:39">&amp;</operator><name pos:start="3001:40" pos:end="3001:48">attr_data</name></expr></argument>, <argument pos:start="3001:51" pos:end="3001:59"><expr pos:start="3001:51" pos:end="3001:59"><operator pos:start="3001:51" pos:end="3001:51">&amp;</operator><name pos:start="3001:52" pos:end="3001:59">attr_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="3002:5" pos:end="3005:5"><if pos:start="3002:5" pos:end="3005:5">if <condition pos:start="3002:8" pos:end="3002:27">(<expr pos:start="3002:9" pos:end="3002:26"><name pos:start="3002:9" pos:end="3002:10">rv</name> <operator pos:start="3002:12" pos:end="3002:13">!=</operator> <name pos:start="3002:15" pos:end="3002:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="3002:29" pos:end="3005:5">{<block_content pos:start="3003:9" pos:end="3004:20">
	<expr_stmt pos:start="3003:9" pos:end="3003:89"><expr pos:start="3003:9" pos:end="3003:88"><call pos:start="3003:9" pos:end="3003:88"><name pos:start="3003:9" pos:end="3003:19">EST_LOG_ERR</name><argument_list pos:start="3003:20" pos:end="3003:88">(<argument pos:start="3003:21" pos:end="3003:87"><expr pos:start="3003:21" pos:end="3003:87"><literal type="string" pos:start="3003:21" pos:end="3003:87">"Unable to get CSR attributes while provisioning a new certificate"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return pos:start="3004:9" pos:end="3004:20">return <expr pos:start="3004:16" pos:end="3004:19"><operator pos:start="3004:16" pos:end="3004:16">(</operator><name pos:start="3004:17" pos:end="3004:18">rv</name><operator pos:start="3004:19" pos:end="3004:19">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="3007:5" pos:end="3010:7">/*
     * Finally, we can attempt to enroll a new certificate using the
     * Common Name provided by the application.
     */</comment>
    <expr_stmt pos:start="3011:5" pos:end="3011:63"><expr pos:start="3011:5" pos:end="3011:62"><name pos:start="3011:5" pos:end="3011:6">rv</name> <operator pos:start="3011:8" pos:end="3011:8">=</operator> <call pos:start="3011:10" pos:end="3011:62"><name pos:start="3011:10" pos:end="3011:26">est_client_enroll</name><argument_list pos:start="3011:27" pos:end="3011:62">(<argument pos:start="3011:28" pos:end="3011:30"><expr pos:start="3011:28" pos:end="3011:30"><name pos:start="3011:28" pos:end="3011:30">ctx</name></expr></argument>, <argument pos:start="3011:33" pos:end="3011:34"><expr pos:start="3011:33" pos:end="3011:34"><name pos:start="3011:33" pos:end="3011:34">cn</name></expr></argument>, <argument pos:start="3011:37" pos:end="3011:45"><expr pos:start="3011:37" pos:end="3011:45"><name pos:start="3011:37" pos:end="3011:45">pkcs7_len</name></expr></argument>, <argument pos:start="3011:48" pos:end="3011:61"><expr pos:start="3011:48" pos:end="3011:61"><name pos:start="3011:48" pos:end="3011:61">new_public_key</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <return pos:start="3013:5" pos:end="3013:16">return <expr pos:start="3013:12" pos:end="3013:15"><operator pos:start="3013:12" pos:end="3013:12">(</operator><name pos:start="3013:13" pos:end="3013:14">rv</name><operator pos:start="3013:15" pos:end="3013:15">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="3015:1" pos:end="3052:3">/*! @brief est_client_reenroll() performs a re-enroll request with the EST
     server using an existing X509 certificate.
 
    @param ctx Pointer to an EST context
    @param cert Pointer to the X509 certificate, which is defined as an OpenSSL
    X509.
    @param pkcs7_len Pointer to an integer to hold the length of the PKCS7
    buffer.
    @param priv_key Pointer to the private key that will be used to sign the CSR.
 
    @return EST_ERROR

    est_client_reenroll() connects to the EST server, establishes a SSL/TLS
    connection to the EST server that was configured with the previous call to
    est_client_set_server(), and sends the re-enroll request.  The application
    layer must provide the X509 certificate that will be enrolled.  This certificate
    should have previously been enrolled with the CA.  The application also
    needs to provide the private key associated with the public key in the
    X509 certificate.  This private key is required to sign the CSR that is
    generated from the X509 certificate. 
    
    The enroll response is stored in the EST context and the length 
    is passed back to the application through the pkcs7_len paramter of this 
    function.  The application can then allocate a correctly sized buffer and 
    call est_client_copy_enrolled_cert() to retrieve the new client certificate 
    from the context.

    The application must provide a pointer to the private key used to sign the CSR.
    This is required by the EST library in the event that the EST server has
    requested the proof-of-possession value be included in the CSR.  The EST library
    will automatically include the proof-of-posession value and sign the CSR
    again.

    Be aware that only the public key and subject name from the X509 certificate
    are included in the re-enroll request sent to the EST server.  The CA is
    responsible for re-applying any X509 extensions that are to be issued with
    the renewed certificate.
 */</comment>
<function pos:start="3053:1" pos:end="3185:1"><type pos:start="3053:1" pos:end="3053:9"><name pos:start="3053:1" pos:end="3053:9">EST_ERROR</name></type> <name pos:start="3053:11" pos:end="3053:29">est_client_reenroll</name> <parameter_list pos:start="3053:31" pos:end="3053:92">(<parameter pos:start="3053:32" pos:end="3053:43"><decl pos:start="3053:32" pos:end="3053:43"><type pos:start="3053:32" pos:end="3053:43"><name pos:start="3053:32" pos:end="3053:38">EST_CTX</name> <modifier pos:start="3053:40" pos:end="3053:40">*</modifier></type><name pos:start="3053:41" pos:end="3053:43">ctx</name></decl></parameter>, <parameter pos:start="3053:46" pos:end="3053:55"><decl pos:start="3053:46" pos:end="3053:55"><type pos:start="3053:46" pos:end="3053:55"><name pos:start="3053:46" pos:end="3053:49">X509</name> <modifier pos:start="3053:51" pos:end="3053:51">*</modifier></type><name pos:start="3053:52" pos:end="3053:55">cert</name></decl></parameter>, <parameter pos:start="3053:58" pos:end="3053:71"><decl pos:start="3053:58" pos:end="3053:71"><type pos:start="3053:58" pos:end="3053:71"><name pos:start="3053:58" pos:end="3053:60">int</name> <modifier pos:start="3053:62" pos:end="3053:62">*</modifier></type><name pos:start="3053:63" pos:end="3053:71">pkcs7_len</name></decl></parameter>, <parameter pos:start="3053:74" pos:end="3053:91"><decl pos:start="3053:74" pos:end="3053:91"><type pos:start="3053:74" pos:end="3053:91"><name pos:start="3053:74" pos:end="3053:81">EVP_PKEY</name> <modifier pos:start="3053:83" pos:end="3053:83">*</modifier></type><name pos:start="3053:84" pos:end="3053:91">priv_key</name></decl></parameter>)</parameter_list>
<block pos:start="3054:1" pos:end="3185:1">{<block_content pos:start="3055:5" pos:end="3182:16">
    <decl_stmt pos:start="3055:5" pos:end="3055:18"><decl pos:start="3055:5" pos:end="3055:17"><type pos:start="3055:5" pos:end="3055:14"><name pos:start="3055:5" pos:end="3055:12">X509_REQ</name> <modifier pos:start="3055:14" pos:end="3055:14">*</modifier></type><name pos:start="3055:15" pos:end="3055:17">req</name></decl>;</decl_stmt>
    <decl_stmt pos:start="3056:5" pos:end="3056:17"><decl pos:start="3056:5" pos:end="3056:16"><type pos:start="3056:5" pos:end="3056:13"><name pos:start="3056:5" pos:end="3056:13">EST_ERROR</name></type> <name pos:start="3056:15" pos:end="3056:16">rv</name></decl>;</decl_stmt>
    <decl_stmt pos:start="3057:5" pos:end="3057:20"><decl pos:start="3057:5" pos:end="3057:19"><type pos:start="3057:5" pos:end="3057:9"><name pos:start="3057:5" pos:end="3057:7">SSL</name> <modifier pos:start="3057:9" pos:end="3057:9">*</modifier></type><name pos:start="3057:10" pos:end="3057:12">ssl</name> <init pos:start="3057:14" pos:end="3057:19">= <expr pos:start="3057:16" pos:end="3057:19"><name pos:start="3057:16" pos:end="3057:19">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="3058:5" pos:end="3058:16"><decl pos:start="3058:5" pos:end="3058:15"><type pos:start="3058:5" pos:end="3058:7"><name pos:start="3058:5" pos:end="3058:7">int</name></type> <name pos:start="3058:9" pos:end="3058:15">ossl_rv</name></decl>;</decl_stmt>

    <if_stmt pos:start="3060:5" pos:end="3062:5"><if pos:start="3060:5" pos:end="3062:5">if <condition pos:start="3060:8" pos:end="3060:13">(<expr pos:start="3060:9" pos:end="3060:12"><operator pos:start="3060:9" pos:end="3060:9">!</operator><name pos:start="3060:10" pos:end="3060:12">ctx</name></expr>)</condition> <block pos:start="3060:15" pos:end="3062:5">{<block_content pos:start="3061:9" pos:end="3061:32">
        <return pos:start="3061:9" pos:end="3061:32">return <expr pos:start="3061:16" pos:end="3061:31"><operator pos:start="3061:16" pos:end="3061:16">(</operator><name pos:start="3061:17" pos:end="3061:30">EST_ERR_NO_CTX</name><operator pos:start="3061:31" pos:end="3061:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3064:5" pos:end="3066:5"><if pos:start="3064:5" pos:end="3066:5">if <condition pos:start="3064:8" pos:end="3064:14">(<expr pos:start="3064:9" pos:end="3064:13"><operator pos:start="3064:9" pos:end="3064:9">!</operator><name pos:start="3064:10" pos:end="3064:13">cert</name></expr>)</condition> <block pos:start="3064:16" pos:end="3066:5">{<block_content pos:start="3065:9" pos:end="3065:33">
        <return pos:start="3065:9" pos:end="3065:33">return <expr pos:start="3065:16" pos:end="3065:32"><operator pos:start="3065:16" pos:end="3065:16">(</operator><name pos:start="3065:17" pos:end="3065:31">EST_ERR_NO_CERT</name><operator pos:start="3065:32" pos:end="3065:32">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3068:5" pos:end="3070:5"><if pos:start="3068:5" pos:end="3070:5">if <condition pos:start="3068:8" pos:end="3068:18">(<expr pos:start="3068:9" pos:end="3068:17"><operator pos:start="3068:9" pos:end="3068:9">!</operator><name pos:start="3068:10" pos:end="3068:17">priv_key</name></expr>)</condition> <block pos:start="3068:20" pos:end="3070:5">{<block_content pos:start="3069:9" pos:end="3069:32">
        <return pos:start="3069:9" pos:end="3069:32">return <expr pos:start="3069:16" pos:end="3069:31"><operator pos:start="3069:16" pos:end="3069:16">(</operator><name pos:start="3069:17" pos:end="3069:30">EST_ERR_NO_KEY</name><operator pos:start="3069:31" pos:end="3069:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3072:5" pos:end="3074:5"><if pos:start="3072:5" pos:end="3074:5">if <condition pos:start="3072:8" pos:end="3072:37">(<expr pos:start="3072:9" pos:end="3072:36"><operator pos:start="3072:9" pos:end="3072:9">!</operator><name pos:start="3072:10" pos:end="3072:36"><name pos:start="3072:10" pos:end="3072:12">ctx</name><operator pos:start="3072:13" pos:end="3072:14">-&gt;</operator><name pos:start="3072:15" pos:end="3072:36">est_client_initialized</name></name></expr>)</condition> <block pos:start="3072:39" pos:end="3074:5">{<block_content pos:start="3073:9" pos:end="3073:48">
        <return pos:start="3073:9" pos:end="3073:48">return <expr pos:start="3073:16" pos:end="3073:47"><operator pos:start="3073:16" pos:end="3073:16">(</operator><name pos:start="3073:17" pos:end="3073:46">EST_ERR_CLIENT_NOT_INITIALIZED</name><operator pos:start="3073:47" pos:end="3073:47">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="3076:5" pos:end="3078:7">/*
     * Check the X509 given to us
     */</comment>
    <expr_stmt pos:start="3079:5" pos:end="3079:37"><expr pos:start="3079:5" pos:end="3079:36"><name pos:start="3079:5" pos:end="3079:6">rv</name> <operator pos:start="3079:8" pos:end="3079:8">=</operator> <call pos:start="3079:10" pos:end="3079:36"><name pos:start="3079:10" pos:end="3079:30">est_client_check_x509</name><argument_list pos:start="3079:31" pos:end="3079:36">(<argument pos:start="3079:32" pos:end="3079:35"><expr pos:start="3079:32" pos:end="3079:35"><name pos:start="3079:32" pos:end="3079:35">cert</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="3080:5" pos:end="3082:5"><if pos:start="3080:5" pos:end="3082:5">if <condition pos:start="3080:8" pos:end="3080:27">(<expr pos:start="3080:9" pos:end="3080:26"><name pos:start="3080:9" pos:end="3080:10">rv</name> <operator pos:start="3080:12" pos:end="3080:13">!=</operator> <name pos:start="3080:15" pos:end="3080:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="3080:29" pos:end="3082:5">{<block_content pos:start="3081:9" pos:end="3081:20">
	<return pos:start="3081:9" pos:end="3081:20">return <expr pos:start="3081:16" pos:end="3081:19"><operator pos:start="3081:16" pos:end="3081:16">(</operator><name pos:start="3081:17" pos:end="3081:18">rv</name><operator pos:start="3081:19" pos:end="3081:19">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="3084:5" pos:end="3087:7">/*
     * Check that the private key matches the public key
     * in the cert.
     */</comment>
    <if_stmt pos:start="3088:5" pos:end="3090:5"><if pos:start="3088:5" pos:end="3090:5">if <condition pos:start="3088:8" pos:end="3088:52">(<expr pos:start="3088:9" pos:end="3088:51"><call pos:start="3088:9" pos:end="3088:46"><name pos:start="3088:9" pos:end="3088:30">X509_check_private_key</name><argument_list pos:start="3088:31" pos:end="3088:46">(<argument pos:start="3088:32" pos:end="3088:35"><expr pos:start="3088:32" pos:end="3088:35"><name pos:start="3088:32" pos:end="3088:35">cert</name></expr></argument>, <argument pos:start="3088:38" pos:end="3088:45"><expr pos:start="3088:38" pos:end="3088:45"><name pos:start="3088:38" pos:end="3088:45">priv_key</name></expr></argument>)</argument_list></call> <operator pos:start="3088:48" pos:end="3088:49">&lt;=</operator> <literal type="number" pos:start="3088:51" pos:end="3088:51">0</literal></expr>)</condition> <block pos:start="3088:54" pos:end="3090:5">{<block_content pos:start="3089:9" pos:end="3089:44">
        <return pos:start="3089:9" pos:end="3089:44">return <expr pos:start="3089:16" pos:end="3089:43"><operator pos:start="3089:16" pos:end="3089:16">(</operator><name pos:start="3089:17" pos:end="3089:42">EST_ERR_CLIENT_INVALID_KEY</name><operator pos:start="3089:43" pos:end="3089:43">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="3092:5" pos:end="3097:7">/*
     * Convert the existing certificate to a CSR
     * This will copy the subject name from the cert into
     * a new CSR.  We pass in NULL for the private key parameter
     * below because we will sign this CSR ourselves later.
     */</comment>
    <expr_stmt pos:start="3098:5" pos:end="3098:60"><expr pos:start="3098:5" pos:end="3098:59"><name pos:start="3098:5" pos:end="3098:7">req</name> <operator pos:start="3098:9" pos:end="3098:9">=</operator> <call pos:start="3098:11" pos:end="3098:59"><name pos:start="3098:11" pos:end="3098:26">X509_to_X509_REQ</name><argument_list pos:start="3098:27" pos:end="3098:59">(<argument pos:start="3098:28" pos:end="3098:31"><expr pos:start="3098:28" pos:end="3098:31"><name pos:start="3098:28" pos:end="3098:31">cert</name></expr></argument>, <argument pos:start="3098:34" pos:end="3098:37"><expr pos:start="3098:34" pos:end="3098:37"><name pos:start="3098:34" pos:end="3098:37">NULL</name></expr></argument>, <argument pos:start="3098:40" pos:end="3098:58"><expr pos:start="3098:40" pos:end="3098:58"><name pos:start="3098:40" pos:end="3098:58"><name pos:start="3098:40" pos:end="3098:42">ctx</name><operator pos:start="3098:43" pos:end="3098:44">-&gt;</operator><name pos:start="3098:45" pos:end="3098:58">signing_digest</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="3099:5" pos:end="3103:5"><if pos:start="3099:5" pos:end="3103:5">if <condition pos:start="3099:8" pos:end="3099:13">(<expr pos:start="3099:9" pos:end="3099:12"><operator pos:start="3099:9" pos:end="3099:9">!</operator><name pos:start="3099:10" pos:end="3099:12">req</name></expr>)</condition> <block pos:start="3099:15" pos:end="3103:5">{<block_content pos:start="3100:9" pos:end="3102:32">
	<expr_stmt pos:start="3100:9" pos:end="3100:54"><expr pos:start="3100:9" pos:end="3100:53"><call pos:start="3100:9" pos:end="3100:53"><name pos:start="3100:9" pos:end="3100:19">EST_LOG_ERR</name><argument_list pos:start="3100:20" pos:end="3100:53">(<argument pos:start="3100:21" pos:end="3100:52"><expr pos:start="3100:21" pos:end="3100:52"><literal type="string" pos:start="3100:21" pos:end="3100:52">"X509 to CSR conversion failed."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="3101:9" pos:end="3101:31"><expr pos:start="3101:9" pos:end="3101:30"><call pos:start="3101:9" pos:end="3101:30"><name pos:start="3101:9" pos:end="3101:28">ossl_dump_ssl_errors</name><argument_list pos:start="3101:29" pos:end="3101:30">()</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3102:9" pos:end="3102:32">return <expr pos:start="3102:16" pos:end="3102:31"><operator pos:start="3102:16" pos:end="3102:16">(</operator><name pos:start="3102:17" pos:end="3102:30">EST_ERR_NO_CSR</name><operator pos:start="3102:31" pos:end="3102:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="3105:5" pos:end="3112:7">/*
     * Copy the X509 extensions from the old certificate
     * to the CSR.  The CA may or may not retain these, as
     * this behavior depends on policy.  When using the 
     * OpenSSL test CA, set the copy_extensions setting 
     * in the config file to copyall to retain the
     * extensions in the CSR when issuing a new cert.
     */</comment>
    <if_stmt pos:start="3113:5" pos:end="3118:5"><if pos:start="3113:5" pos:end="3118:5">if <condition pos:start="3113:8" pos:end="3113:55">(<expr pos:start="3113:9" pos:end="3113:54"><name pos:start="3113:9" pos:end="3113:23"><name pos:start="3113:9" pos:end="3113:12">cert</name><operator pos:start="3113:13" pos:end="3113:14">-&gt;</operator><name pos:start="3113:15" pos:end="3113:23">cert_info</name></name> <operator pos:start="3113:25" pos:end="3113:26">&amp;&amp;</operator> <name pos:start="3113:28" pos:end="3113:54"><name pos:start="3113:28" pos:end="3113:31">cert</name><operator pos:start="3113:32" pos:end="3113:33">-&gt;</operator><name pos:start="3113:34" pos:end="3113:42">cert_info</name><operator pos:start="3113:43" pos:end="3113:44">-&gt;</operator><name pos:start="3113:45" pos:end="3113:54">extensions</name></name></expr>)</condition> <block pos:start="3113:57" pos:end="3118:5">{<block_content pos:start="3114:9" pos:end="3117:9">
	<expr_stmt pos:start="3114:9" pos:end="3114:76"><expr pos:start="3114:9" pos:end="3114:75"><name pos:start="3114:9" pos:end="3114:15">ossl_rv</name> <operator pos:start="3114:17" pos:end="3114:17">=</operator> <call pos:start="3114:19" pos:end="3114:75"><name pos:start="3114:19" pos:end="3114:41">X509_REQ_add_extensions</name><argument_list pos:start="3114:42" pos:end="3114:75">(<argument pos:start="3114:43" pos:end="3114:45"><expr pos:start="3114:43" pos:end="3114:45"><name pos:start="3114:43" pos:end="3114:45">req</name></expr></argument>, <argument pos:start="3114:48" pos:end="3114:74"><expr pos:start="3114:48" pos:end="3114:74"><name pos:start="3114:48" pos:end="3114:74"><name pos:start="3114:48" pos:end="3114:51">cert</name><operator pos:start="3114:52" pos:end="3114:53">-&gt;</operator><name pos:start="3114:54" pos:end="3114:62">cert_info</name><operator pos:start="3114:63" pos:end="3114:64">-&gt;</operator><name pos:start="3114:65" pos:end="3114:74">extensions</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if_stmt pos:start="3115:9" pos:end="3117:9"><if pos:start="3115:9" pos:end="3117:9">if <condition pos:start="3115:12" pos:end="3115:21">(<expr pos:start="3115:13" pos:end="3115:20"><operator pos:start="3115:13" pos:end="3115:13">!</operator><name pos:start="3115:14" pos:end="3115:20">ossl_rv</name></expr>)</condition> <block pos:start="3115:23" pos:end="3117:9">{<block_content pos:start="3116:13" pos:end="3116:155">
	    <expr_stmt pos:start="3116:13" pos:end="3116:155"><expr pos:start="3116:13" pos:end="3116:154"><call pos:start="3116:13" pos:end="3116:154"><name pos:start="3116:13" pos:end="3116:24">EST_LOG_WARN</name><argument_list pos:start="3116:25" pos:end="3116:154">(<argument pos:start="3116:26" pos:end="3116:153"><expr pos:start="3116:26" pos:end="3116:153"><literal type="string" pos:start="3116:26" pos:end="3116:153">"Failed to copy X509 extensions to the CSR. Your new certificate may not contain the extensions present in the old certificate."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	</block_content>}</block></if></if_stmt>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="3120:5" pos:end="3122:7">/*
     * Establish TLS session with the EST server
     */</comment>
    <expr_stmt pos:start="3123:5" pos:end="3123:39"><expr pos:start="3123:5" pos:end="3123:38"><name pos:start="3123:5" pos:end="3123:6">rv</name> <operator pos:start="3123:8" pos:end="3123:8">=</operator> <call pos:start="3123:10" pos:end="3123:38"><name pos:start="3123:10" pos:end="3123:27">est_client_connect</name><argument_list pos:start="3123:28" pos:end="3123:38">(<argument pos:start="3123:29" pos:end="3123:31"><expr pos:start="3123:29" pos:end="3123:31"><name pos:start="3123:29" pos:end="3123:31">ctx</name></expr></argument>, <argument pos:start="3123:34" pos:end="3123:37"><expr pos:start="3123:34" pos:end="3123:37"><operator pos:start="3123:34" pos:end="3123:34">&amp;</operator><name pos:start="3123:35" pos:end="3123:37">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="3124:5" pos:end="3126:5"><if pos:start="3124:5" pos:end="3126:5">if <condition pos:start="3124:8" pos:end="3124:27">(<expr pos:start="3124:9" pos:end="3124:26"><name pos:start="3124:9" pos:end="3124:10">rv</name> <operator pos:start="3124:12" pos:end="3124:13">!=</operator> <name pos:start="3124:15" pos:end="3124:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="3124:29" pos:end="3126:5">{<block_content pos:start="3125:9" pos:end="3125:17">
        <goto pos:start="3125:9" pos:end="3125:17">goto <name pos:start="3125:14" pos:end="3125:16">err</name>;</goto>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="3128:5" pos:end="3130:7">/*
     * Send the re-enroll request
     */</comment>
    <expr_stmt pos:start="3131:5" pos:end="3131:73"><expr pos:start="3131:5" pos:end="3131:72"><name pos:start="3131:5" pos:end="3131:6">rv</name> <operator pos:start="3131:8" pos:end="3131:8">=</operator> <call pos:start="3131:10" pos:end="3131:72"><name pos:start="3131:10" pos:end="3131:33">est_client_enroll_pkcs10</name><argument_list pos:start="3131:34" pos:end="3131:72">(<argument pos:start="3131:35" pos:end="3131:37"><expr pos:start="3131:35" pos:end="3131:37"><name pos:start="3131:35" pos:end="3131:37">ctx</name></expr></argument>, <argument pos:start="3131:40" pos:end="3131:42"><expr pos:start="3131:40" pos:end="3131:42"><name pos:start="3131:40" pos:end="3131:42">ssl</name></expr></argument>, <argument pos:start="3131:45" pos:end="3131:47"><expr pos:start="3131:45" pos:end="3131:47"><name pos:start="3131:45" pos:end="3131:47">req</name></expr></argument>, <argument pos:start="3131:50" pos:end="3131:58"><expr pos:start="3131:50" pos:end="3131:58"><name pos:start="3131:50" pos:end="3131:58">pkcs7_len</name></expr></argument>, <argument pos:start="3131:61" pos:end="3131:68"><expr pos:start="3131:61" pos:end="3131:68"><name pos:start="3131:61" pos:end="3131:68">priv_key</name></expr></argument>, <argument pos:start="3131:71" pos:end="3131:71"><expr pos:start="3131:71" pos:end="3131:71"><literal type="number" pos:start="3131:71" pos:end="3131:71">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="3132:5" pos:end="3132:37"><expr pos:start="3132:5" pos:end="3132:36"><call pos:start="3132:5" pos:end="3132:36"><name pos:start="3132:5" pos:end="3132:25">est_client_disconnect</name><argument_list pos:start="3132:26" pos:end="3132:36">(<argument pos:start="3132:27" pos:end="3132:29"><expr pos:start="3132:27" pos:end="3132:29"><name pos:start="3132:27" pos:end="3132:29">ctx</name></expr></argument>, <argument pos:start="3132:32" pos:end="3132:35"><expr pos:start="3132:32" pos:end="3132:35"><operator pos:start="3132:32" pos:end="3132:32">&amp;</operator><name pos:start="3132:33" pos:end="3132:35">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="3133:5" pos:end="3173:5"><if pos:start="3133:5" pos:end="3173:5">if <condition pos:start="3133:8" pos:end="3136:39">(<expr pos:start="3133:9" pos:end="3136:38"><name pos:start="3133:9" pos:end="3133:10">rv</name> <operator pos:start="3133:12" pos:end="3133:13">==</operator> <name pos:start="3133:15" pos:end="3133:31">EST_ERR_AUTH_FAIL</name> <operator pos:start="3133:33" pos:end="3133:34">&amp;&amp;</operator>
        <operator pos:start="3134:9" pos:end="3134:9">(</operator><name pos:start="3134:10" pos:end="3134:23"><name pos:start="3134:10" pos:end="3134:12">ctx</name><operator pos:start="3134:13" pos:end="3134:14">-&gt;</operator><name pos:start="3134:15" pos:end="3134:23">auth_mode</name></name> <operator pos:start="3134:25" pos:end="3134:26">==</operator> <name pos:start="3134:28" pos:end="3134:38">AUTH_DIGEST</name> <operator pos:start="3134:40" pos:end="3134:41">||</operator>
         <name pos:start="3135:10" pos:end="3135:23"><name pos:start="3135:10" pos:end="3135:12">ctx</name><operator pos:start="3135:13" pos:end="3135:14">-&gt;</operator><name pos:start="3135:15" pos:end="3135:23">auth_mode</name></name> <operator pos:start="3135:25" pos:end="3135:26">==</operator> <name pos:start="3135:28" pos:end="3135:37">AUTH_BASIC</name>  <operator pos:start="3135:40" pos:end="3135:41">||</operator>
         <name pos:start="3136:10" pos:end="3136:23"><name pos:start="3136:10" pos:end="3136:12">ctx</name><operator pos:start="3136:13" pos:end="3136:14">-&gt;</operator><name pos:start="3136:15" pos:end="3136:23">auth_mode</name></name> <operator pos:start="3136:25" pos:end="3136:26">==</operator> <name pos:start="3136:28" pos:end="3136:37">AUTH_TOKEN</name><operator pos:start="3136:38" pos:end="3136:38">)</operator></expr>)</condition> <block pos:start="3136:41" pos:end="3173:5">{<block_content pos:start="3142:9" pos:end="3172:41">

        <comment type="block" pos:start="3138:9" pos:end="3141:11">/*
         * HTTPS digest mode requires the use of MD5.  Make sure we're not
         * in FIPS mode and can use MD5
         */</comment>
        <if_stmt pos:start="3142:9" pos:end="3146:9"><if pos:start="3142:9" pos:end="3146:9">if <condition pos:start="3142:12" pos:end="3142:59">(<expr pos:start="3142:13" pos:end="3142:58"><name pos:start="3142:13" pos:end="3142:26"><name pos:start="3142:13" pos:end="3142:15">ctx</name><operator pos:start="3142:16" pos:end="3142:17">-&gt;</operator><name pos:start="3142:18" pos:end="3142:26">auth_mode</name></name> <operator pos:start="3142:28" pos:end="3142:29">==</operator> <name pos:start="3142:31" pos:end="3142:41">AUTH_DIGEST</name> <operator pos:start="3142:43" pos:end="3142:44">&amp;&amp;</operator> <operator pos:start="3142:46" pos:end="3142:46">(</operator><call pos:start="3142:47" pos:end="3142:57"><name pos:start="3142:47" pos:end="3142:55">FIPS_mode</name><argument_list pos:start="3142:56" pos:end="3142:57">()</argument_list></call><operator pos:start="3142:58" pos:end="3142:58">)</operator></expr>)</condition><block pos:start="3142:60" pos:end="3146:9">{<block_content pos:start="3143:13" pos:end="3145:21">
	    <expr_stmt pos:start="3143:13" pos:end="3143:75"><expr pos:start="3143:13" pos:end="3143:74"><call pos:start="3143:13" pos:end="3143:74"><name pos:start="3143:13" pos:end="3143:23">EST_LOG_ERR</name><argument_list pos:start="3143:24" pos:end="3143:74">(<argument pos:start="3143:25" pos:end="3143:73"><expr pos:start="3143:25" pos:end="3143:73"><literal type="string" pos:start="3143:25" pos:end="3143:73">"HTTP digest auth not allowed while in FIPS mode"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt pos:start="3144:13" pos:end="3144:34"><expr pos:start="3144:13" pos:end="3144:33"><name pos:start="3144:13" pos:end="3144:14">rv</name> <operator pos:start="3144:16" pos:end="3144:16">=</operator> <name pos:start="3144:18" pos:end="3144:33">EST_ERR_BAD_MODE</name></expr>;</expr_stmt>
            <goto pos:start="3145:13" pos:end="3145:21">goto <name pos:start="3145:18" pos:end="3145:20">err</name>;</goto>
        </block_content>}</block></if></if_stmt>
        
        <comment type="block" pos:start="3148:9" pos:end="3148:58">/* Try one more time if we're doing Digest auth */</comment>
        <expr_stmt pos:start="3149:9" pos:end="3149:84"><expr pos:start="3149:9" pos:end="3149:83"><call pos:start="3149:9" pos:end="3149:83"><name pos:start="3149:9" pos:end="3149:20">EST_LOG_INFO</name><argument_list pos:start="3149:21" pos:end="3149:83">(<argument pos:start="3149:22" pos:end="3149:82"><expr pos:start="3149:22" pos:end="3149:82"><literal type="string" pos:start="3149:22" pos:end="3149:82">"HTTP Auth failed, trying again with digest/basic parameters"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="3150:9" pos:end="3150:43"><expr pos:start="3150:9" pos:end="3150:42"><name pos:start="3150:9" pos:end="3150:10">rv</name> <operator pos:start="3150:12" pos:end="3150:12">=</operator> <call pos:start="3150:14" pos:end="3150:42"><name pos:start="3150:14" pos:end="3150:31">est_client_connect</name><argument_list pos:start="3150:32" pos:end="3150:42">(<argument pos:start="3150:33" pos:end="3150:35"><expr pos:start="3150:33" pos:end="3150:35"><name pos:start="3150:33" pos:end="3150:35">ctx</name></expr></argument>, <argument pos:start="3150:38" pos:end="3150:41"><expr pos:start="3150:38" pos:end="3150:41"><operator pos:start="3150:38" pos:end="3150:38">&amp;</operator><name pos:start="3150:39" pos:end="3150:41">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="3151:9" pos:end="3154:9"><if pos:start="3151:9" pos:end="3154:9">if <condition pos:start="3151:12" pos:end="3151:31">(<expr pos:start="3151:13" pos:end="3151:30"><name pos:start="3151:13" pos:end="3151:14">rv</name> <operator pos:start="3151:16" pos:end="3151:17">!=</operator> <name pos:start="3151:19" pos:end="3151:30">EST_ERR_NONE</name></expr>)</condition> <block pos:start="3151:33" pos:end="3154:9">{<block_content pos:start="3152:13" pos:end="3153:21">
            <expr_stmt pos:start="3152:13" pos:end="3152:92"><expr pos:start="3152:13" pos:end="3152:91"><call pos:start="3152:13" pos:end="3152:91"><name pos:start="3152:13" pos:end="3152:23">EST_LOG_ERR</name><argument_list pos:start="3152:24" pos:end="3152:91">(<argument pos:start="3152:25" pos:end="3152:90"><expr pos:start="3152:25" pos:end="3152:90"><literal type="string" pos:start="3152:25" pos:end="3152:90">"Connection failed on second attempt with basic/digest parameters"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <goto pos:start="3153:13" pos:end="3153:21">goto <name pos:start="3153:18" pos:end="3153:20">err</name>;</goto>
        </block_content>}</block></if></if_stmt>
        <expr_stmt pos:start="3155:9" pos:end="3155:77"><expr pos:start="3155:9" pos:end="3155:76"><name pos:start="3155:9" pos:end="3155:10">rv</name> <operator pos:start="3155:12" pos:end="3155:12">=</operator> <call pos:start="3155:14" pos:end="3155:76"><name pos:start="3155:14" pos:end="3155:37">est_client_enroll_pkcs10</name><argument_list pos:start="3155:38" pos:end="3155:76">(<argument pos:start="3155:39" pos:end="3155:41"><expr pos:start="3155:39" pos:end="3155:41"><name pos:start="3155:39" pos:end="3155:41">ctx</name></expr></argument>, <argument pos:start="3155:44" pos:end="3155:46"><expr pos:start="3155:44" pos:end="3155:46"><name pos:start="3155:44" pos:end="3155:46">ssl</name></expr></argument>, <argument pos:start="3155:49" pos:end="3155:51"><expr pos:start="3155:49" pos:end="3155:51"><name pos:start="3155:49" pos:end="3155:51">req</name></expr></argument>, <argument pos:start="3155:54" pos:end="3155:62"><expr pos:start="3155:54" pos:end="3155:62"><name pos:start="3155:54" pos:end="3155:62">pkcs7_len</name></expr></argument>, <argument pos:start="3155:65" pos:end="3155:72"><expr pos:start="3155:65" pos:end="3155:72"><name pos:start="3155:65" pos:end="3155:72">priv_key</name></expr></argument>, <argument pos:start="3155:75" pos:end="3155:75"><expr pos:start="3155:75" pos:end="3155:75"><literal type="number" pos:start="3155:75" pos:end="3155:75">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="3156:9" pos:end="3171:9"><if pos:start="3156:9" pos:end="3171:9">if <condition pos:start="3156:12" pos:end="3156:31">(<expr pos:start="3156:13" pos:end="3156:30"><name pos:start="3156:13" pos:end="3156:14">rv</name> <operator pos:start="3156:16" pos:end="3156:17">!=</operator> <name pos:start="3156:19" pos:end="3156:30">EST_ERR_NONE</name></expr>)</condition> <block pos:start="3156:33" pos:end="3171:9">{<block_content pos:start="3157:13" pos:end="3169:13">
            <expr_stmt pos:start="3157:13" pos:end="3157:96"><expr pos:start="3157:13" pos:end="3157:95"><call pos:start="3157:13" pos:end="3157:95"><name pos:start="3157:13" pos:end="3157:23">EST_LOG_ERR</name><argument_list pos:start="3157:24" pos:end="3157:95">(<argument pos:start="3157:25" pos:end="3157:94"><expr pos:start="3157:25" pos:end="3157:94"><literal type="string" pos:start="3157:25" pos:end="3157:94">"Reenroll failed on second attempt during basic/digest authentication"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            
            <comment type="block" pos:start="3159:13" pos:end="3162:15">/*
             * If we're attempting token mode for the second time, and
             * the server responded with error attributes, log them now
             */</comment>
            <if_stmt pos:start="3163:13" pos:end="3169:13"><if pos:start="3163:13" pos:end="3169:13">if <condition pos:start="3163:16" pos:end="3163:80">(<expr pos:start="3163:17" pos:end="3163:79"><name pos:start="3163:17" pos:end="3163:35"><name pos:start="3163:17" pos:end="3163:19">ctx</name><operator pos:start="3163:20" pos:end="3163:21">-&gt;</operator><name pos:start="3163:22" pos:end="3163:32">token_error</name><index pos:start="3163:33" pos:end="3163:35">[<expr pos:start="3163:34" pos:end="3163:34"><literal type="number" pos:start="3163:34" pos:end="3163:34">0</literal></expr>]</index></name> <operator pos:start="3163:37" pos:end="3163:38">!=</operator> <literal type="char" pos:start="3163:40" pos:end="3163:43">'\0'</literal> <operator pos:start="3163:45" pos:end="3163:46">||</operator> <name pos:start="3163:48" pos:end="3163:71"><name pos:start="3163:48" pos:end="3163:50">ctx</name><operator pos:start="3163:51" pos:end="3163:52">-&gt;</operator><name pos:start="3163:53" pos:end="3163:68">token_error_desc</name><index pos:start="3163:69" pos:end="3163:71">[<expr pos:start="3163:70" pos:end="3163:70"><literal type="number" pos:start="3163:70" pos:end="3163:70">0</literal></expr>]</index></name> <operator pos:start="3163:73" pos:end="3163:74">!=</operator> <literal type="char" pos:start="3163:76" pos:end="3163:79">'\0'</literal></expr>)</condition> <block pos:start="3163:82" pos:end="3169:13">{<block_content pos:start="3164:17" pos:end="3168:48">
                <expr_stmt pos:start="3164:17" pos:end="3166:69"><expr pos:start="3164:17" pos:end="3166:68"><call pos:start="3164:17" pos:end="3166:68"><name pos:start="3164:17" pos:end="3164:27">EST_LOG_ERR</name><argument_list pos:start="3164:28" pos:end="3166:68">(<argument pos:start="3164:29" pos:end="3165:67"><expr pos:start="3164:29" pos:end="3165:67"><literal type="string" pos:start="3164:29" pos:end="3164:91">"Token Auth mode failed, server provided error information: \n"</literal>
                            <literal type="string" pos:start="3165:29" pos:end="3165:67">"   Error = %s\n Error description: %s"</literal></expr></argument>,
                            <argument pos:start="3166:29" pos:end="3166:44"><expr pos:start="3166:29" pos:end="3166:44"><name pos:start="3166:29" pos:end="3166:44"><name pos:start="3166:29" pos:end="3166:31">ctx</name><operator pos:start="3166:32" pos:end="3166:33">-&gt;</operator><name pos:start="3166:34" pos:end="3166:44">token_error</name></name></expr></argument>, <argument pos:start="3166:47" pos:end="3166:67"><expr pos:start="3166:47" pos:end="3166:67"><name pos:start="3166:47" pos:end="3166:67"><name pos:start="3166:47" pos:end="3166:49">ctx</name><operator pos:start="3166:50" pos:end="3166:51">-&gt;</operator><name pos:start="3166:52" pos:end="3166:67">token_error_desc</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt pos:start="3167:17" pos:end="3167:43"><expr pos:start="3167:17" pos:end="3167:42"><name pos:start="3167:17" pos:end="3167:35"><name pos:start="3167:17" pos:end="3167:19">ctx</name><operator pos:start="3167:20" pos:end="3167:21">-&gt;</operator><name pos:start="3167:22" pos:end="3167:32">token_error</name><index pos:start="3167:33" pos:end="3167:35">[<expr pos:start="3167:34" pos:end="3167:34"><literal type="number" pos:start="3167:34" pos:end="3167:34">0</literal></expr>]</index></name> <operator pos:start="3167:37" pos:end="3167:37">=</operator> <literal type="char" pos:start="3167:39" pos:end="3167:42">'\0'</literal></expr>;</expr_stmt>
                <expr_stmt pos:start="3168:17" pos:end="3168:48"><expr pos:start="3168:17" pos:end="3168:47"><name pos:start="3168:17" pos:end="3168:40"><name pos:start="3168:17" pos:end="3168:19">ctx</name><operator pos:start="3168:20" pos:end="3168:21">-&gt;</operator><name pos:start="3168:22" pos:end="3168:37">token_error_desc</name><index pos:start="3168:38" pos:end="3168:40">[<expr pos:start="3168:39" pos:end="3168:39"><literal type="number" pos:start="3168:39" pos:end="3168:39">0</literal></expr>]</index></name> <operator pos:start="3168:42" pos:end="3168:42">=</operator> <literal type="char" pos:start="3168:44" pos:end="3168:47">'\0'</literal></expr>;</expr_stmt>
            </block_content>}</block></if></if_stmt>            
            
        </block_content>}</block></if></if_stmt>
        <expr_stmt pos:start="3172:9" pos:end="3172:41"><expr pos:start="3172:9" pos:end="3172:40"><call pos:start="3172:9" pos:end="3172:40"><name pos:start="3172:9" pos:end="3172:29">est_client_disconnect</name><argument_list pos:start="3172:30" pos:end="3172:40">(<argument pos:start="3172:31" pos:end="3172:33"><expr pos:start="3172:31" pos:end="3172:33"><name pos:start="3172:31" pos:end="3172:33">ctx</name></expr></argument>, <argument pos:start="3172:36" pos:end="3172:39"><expr pos:start="3172:36" pos:end="3172:39"><operator pos:start="3172:36" pos:end="3172:36">&amp;</operator><name pos:start="3172:37" pos:end="3172:39">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>

<label pos:start="3175:1" pos:end="3175:4"><name pos:start="3175:1" pos:end="3175:3">err</name>:</label>    
    <if_stmt pos:start="3176:5" pos:end="3179:5"><if pos:start="3176:5" pos:end="3179:5">if <condition pos:start="3176:8" pos:end="3176:12">(<expr pos:start="3176:9" pos:end="3176:11"><name pos:start="3176:9" pos:end="3176:11">ssl</name></expr>)</condition> <block pos:start="3176:14" pos:end="3179:5">{<block_content pos:start="3177:9" pos:end="3178:22">
        <expr_stmt pos:start="3177:9" pos:end="3177:26"><expr pos:start="3177:9" pos:end="3177:25"><call pos:start="3177:9" pos:end="3177:25"><name pos:start="3177:9" pos:end="3177:20">SSL_shutdown</name><argument_list pos:start="3177:21" pos:end="3177:25">(<argument pos:start="3177:22" pos:end="3177:24"><expr pos:start="3177:22" pos:end="3177:24"><name pos:start="3177:22" pos:end="3177:24">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="3178:9" pos:end="3178:22"><expr pos:start="3178:9" pos:end="3178:21"><call pos:start="3178:9" pos:end="3178:21"><name pos:start="3178:9" pos:end="3178:16">SSL_free</name><argument_list pos:start="3178:17" pos:end="3178:21">(<argument pos:start="3178:18" pos:end="3178:20"><expr pos:start="3178:18" pos:end="3178:20"><name pos:start="3178:18" pos:end="3178:20">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="3180:5" pos:end="3180:23"><expr pos:start="3180:5" pos:end="3180:22"><call pos:start="3180:5" pos:end="3180:22"><name pos:start="3180:5" pos:end="3180:17">X509_REQ_free</name><argument_list pos:start="3180:18" pos:end="3180:22">(<argument pos:start="3180:19" pos:end="3180:21"><expr pos:start="3180:19" pos:end="3180:21"><name pos:start="3180:19" pos:end="3180:21">req</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <return pos:start="3182:5" pos:end="3182:16">return <expr pos:start="3182:12" pos:end="3182:15"><operator pos:start="3182:12" pos:end="3182:12">(</operator><name pos:start="3182:13" pos:end="3182:14">rv</name><operator pos:start="3182:15" pos:end="3182:15">)</operator></expr>;</return>

    
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="3186:1" pos:end="3202:3">/*! @brief est_client_copy_enrolled_cert() passes back the client certificate
    that was previously obtained from the EST server by the call to
    est_client_enroll().
 
    @param ctx Pointer to an EST context
    @param cn Pointer to the Common Name value to be used in the enrollment
    request.
    @param pkcs7 Pointer to a pointer that will point to the buffer that
    contains the newly enrolled client certificate.
 
    @return EST_ERROR

    est_client_copy_enrolled_cert() copies the previously obtained client
    certificate from the EST context to the application's buffer.  Once this
    client certificate is copied out of the context it is removed from the
    context.
 */</comment>
<function pos:start="3203:1" pos:end="3237:1"><type pos:start="3203:1" pos:end="3203:9"><name pos:start="3203:1" pos:end="3203:9">EST_ERROR</name></type> <name pos:start="3203:11" pos:end="3203:39">est_client_copy_enrolled_cert</name> <parameter_list pos:start="3203:41" pos:end="3203:76">(<parameter pos:start="3203:42" pos:end="3203:53"><decl pos:start="3203:42" pos:end="3203:53"><type pos:start="3203:42" pos:end="3203:53"><name pos:start="3203:42" pos:end="3203:48">EST_CTX</name> <modifier pos:start="3203:50" pos:end="3203:50">*</modifier></type><name pos:start="3203:51" pos:end="3203:53">ctx</name></decl></parameter>, <parameter pos:start="3203:56" pos:end="3203:75"><decl pos:start="3203:56" pos:end="3203:75"><type pos:start="3203:56" pos:end="3203:75"><name pos:start="3203:56" pos:end="3203:63">unsigned</name> <name pos:start="3203:65" pos:end="3203:68">char</name> <modifier pos:start="3203:70" pos:end="3203:70">*</modifier></type><name pos:start="3203:71" pos:end="3203:75">pkcs7</name></decl></parameter>)</parameter_list>
<block pos:start="3204:1" pos:end="3237:1">{<block_content pos:start="3206:5" pos:end="3236:26">

    <if_stmt pos:start="3206:5" pos:end="3208:5"><if pos:start="3206:5" pos:end="3208:5">if <condition pos:start="3206:8" pos:end="3206:13">(<expr pos:start="3206:9" pos:end="3206:12"><operator pos:start="3206:9" pos:end="3206:9">!</operator><name pos:start="3206:10" pos:end="3206:12">ctx</name></expr>)</condition> <block pos:start="3206:15" pos:end="3208:5">{<block_content pos:start="3207:9" pos:end="3207:32">
        <return pos:start="3207:9" pos:end="3207:32">return <expr pos:start="3207:16" pos:end="3207:31"><operator pos:start="3207:16" pos:end="3207:16">(</operator><name pos:start="3207:17" pos:end="3207:30">EST_ERR_NO_CTX</name><operator pos:start="3207:31" pos:end="3207:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3210:5" pos:end="3212:5"><if pos:start="3210:5" pos:end="3212:5">if <condition pos:start="3210:8" pos:end="3210:37">(<expr pos:start="3210:9" pos:end="3210:36"><operator pos:start="3210:9" pos:end="3210:9">!</operator><name pos:start="3210:10" pos:end="3210:36"><name pos:start="3210:10" pos:end="3210:12">ctx</name><operator pos:start="3210:13" pos:end="3210:14">-&gt;</operator><name pos:start="3210:15" pos:end="3210:36">est_client_initialized</name></name></expr>)</condition> <block pos:start="3210:39" pos:end="3212:5">{<block_content pos:start="3211:9" pos:end="3211:46">
        <return pos:start="3211:9" pos:end="3211:46">return <expr pos:start="3211:16" pos:end="3211:45"><name pos:start="3211:16" pos:end="3211:45">EST_ERR_CLIENT_NOT_INITIALIZED</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3214:5" pos:end="3217:5"><if pos:start="3214:5" pos:end="3217:5">if <condition pos:start="3214:8" pos:end="3214:22">(<expr pos:start="3214:9" pos:end="3214:21"><name pos:start="3214:9" pos:end="3214:13">pkcs7</name> <operator pos:start="3214:15" pos:end="3214:16">==</operator> <name pos:start="3214:18" pos:end="3214:21">NULL</name></expr>)</condition><block pos:start="3214:23" pos:end="3217:5">{<block_content pos:start="3215:9" pos:end="3216:42">
        <expr_stmt pos:start="3215:9" pos:end="3215:68"><expr pos:start="3215:9" pos:end="3215:67"><call pos:start="3215:9" pos:end="3215:67"><name pos:start="3215:9" pos:end="3215:19">EST_LOG_ERR</name><argument_list pos:start="3215:20" pos:end="3215:67">(<argument pos:start="3215:21" pos:end="3215:66"><expr pos:start="3215:21" pos:end="3215:66"><literal type="string" pos:start="3215:21" pos:end="3215:66">"EST Client: Simple Enroll, invalid parameter"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3216:9" pos:end="3216:42">return <expr pos:start="3216:16" pos:end="3216:41"><name pos:start="3216:16" pos:end="3216:41">EST_ERR_INVALID_PARAMETERS</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
         
    <if_stmt pos:start="3219:5" pos:end="3222:5"><if pos:start="3219:5" pos:end="3222:5">if <condition pos:start="3219:8" pos:end="3219:42">(<expr pos:start="3219:9" pos:end="3219:41"><name pos:start="3219:9" pos:end="3219:33"><name pos:start="3219:9" pos:end="3219:11">ctx</name><operator pos:start="3219:12" pos:end="3219:13">-&gt;</operator><name pos:start="3219:14" pos:end="3219:33">enrolled_client_cert</name></name> <operator pos:start="3219:35" pos:end="3219:36">==</operator> <name pos:start="3219:38" pos:end="3219:41">NULL</name></expr>)</condition><block pos:start="3219:43" pos:end="3222:5">{<block_content pos:start="3220:9" pos:end="3221:39">
        <expr_stmt pos:start="3220:9" pos:end="3220:53"><expr pos:start="3220:9" pos:end="3220:52"><call pos:start="3220:9" pos:end="3220:52"><name pos:start="3220:9" pos:end="3220:19">EST_LOG_ERR</name><argument_list pos:start="3220:20" pos:end="3220:52">(<argument pos:start="3220:21" pos:end="3220:51"><expr pos:start="3220:21" pos:end="3220:51"><literal type="string" pos:start="3220:21" pos:end="3220:51">"No client certificate to copy"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3221:9" pos:end="3221:39">return<expr pos:start="3221:15" pos:end="3221:38"><operator pos:start="3221:15" pos:end="3221:15">(</operator><name pos:start="3221:16" pos:end="3221:37">EST_ERR_NO_CERTIFICATE</name><operator pos:start="3221:38" pos:end="3221:38">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="3224:5" pos:end="3224:52"><expr pos:start="3224:5" pos:end="3224:51"><call pos:start="3224:5" pos:end="3224:51"><name pos:start="3224:5" pos:end="3224:13">memzero_s</name><argument_list pos:start="3224:14" pos:end="3224:51">(<argument pos:start="3224:15" pos:end="3224:19"><expr pos:start="3224:15" pos:end="3224:19"><name pos:start="3224:15" pos:end="3224:19">pkcs7</name></expr></argument>, <argument pos:start="3224:22" pos:end="3224:50"><expr pos:start="3224:22" pos:end="3224:50"><name pos:start="3224:22" pos:end="3224:50"><name pos:start="3224:22" pos:end="3224:24">ctx</name><operator pos:start="3224:25" pos:end="3224:26">-&gt;</operator><name pos:start="3224:27" pos:end="3224:50">enrolled_client_cert_len</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="3225:5" pos:end="3226:44"><expr pos:start="3225:5" pos:end="3226:43"><call pos:start="3225:5" pos:end="3226:43"><name pos:start="3225:5" pos:end="3225:12">memcpy_s</name><argument_list pos:start="3225:13" pos:end="3226:43">(<argument pos:start="3225:14" pos:end="3225:18"><expr pos:start="3225:14" pos:end="3225:18"><name pos:start="3225:14" pos:end="3225:18">pkcs7</name></expr></argument>, <argument pos:start="3225:21" pos:end="3225:49"><expr pos:start="3225:21" pos:end="3225:49"><name pos:start="3225:21" pos:end="3225:49"><name pos:start="3225:21" pos:end="3225:23">ctx</name><operator pos:start="3225:24" pos:end="3225:25">-&gt;</operator><name pos:start="3225:26" pos:end="3225:49">enrolled_client_cert_len</name></name></expr></argument>, <argument pos:start="3225:52" pos:end="3225:76"><expr pos:start="3225:52" pos:end="3225:76"><name pos:start="3225:52" pos:end="3225:76"><name pos:start="3225:52" pos:end="3225:54">ctx</name><operator pos:start="3225:55" pos:end="3225:56">-&gt;</operator><name pos:start="3225:57" pos:end="3225:76">enrolled_client_cert</name></name></expr></argument>,
             <argument pos:start="3226:14" pos:end="3226:42"><expr pos:start="3226:14" pos:end="3226:42"><name pos:start="3226:14" pos:end="3226:42"><name pos:start="3226:14" pos:end="3226:16">ctx</name><operator pos:start="3226:17" pos:end="3226:18">-&gt;</operator><name pos:start="3226:19" pos:end="3226:42">enrolled_client_cert_len</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    
    <comment type="block" pos:start="3228:5" pos:end="3231:7">/*
     * Now that the copy in the context has been handed over,
     * free it up
     */</comment>
    <expr_stmt pos:start="3232:5" pos:end="3232:36"><expr pos:start="3232:5" pos:end="3232:35"><call pos:start="3232:5" pos:end="3232:35"><name pos:start="3232:5" pos:end="3232:8">free</name><argument_list pos:start="3232:9" pos:end="3232:35">(<argument pos:start="3232:10" pos:end="3232:34"><expr pos:start="3232:10" pos:end="3232:34"><name pos:start="3232:10" pos:end="3232:34"><name pos:start="3232:10" pos:end="3232:12">ctx</name><operator pos:start="3232:13" pos:end="3232:14">-&gt;</operator><name pos:start="3232:15" pos:end="3232:34">enrolled_client_cert</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="3233:5" pos:end="3233:37"><expr pos:start="3233:5" pos:end="3233:36"><name pos:start="3233:5" pos:end="3233:29"><name pos:start="3233:5" pos:end="3233:7">ctx</name><operator pos:start="3233:8" pos:end="3233:9">-&gt;</operator><name pos:start="3233:10" pos:end="3233:29">enrolled_client_cert</name></name> <operator pos:start="3233:31" pos:end="3233:31">=</operator> <name pos:start="3233:33" pos:end="3233:36">NULL</name></expr>;</expr_stmt>
    <expr_stmt pos:start="3234:5" pos:end="3234:38"><expr pos:start="3234:5" pos:end="3234:37"><name pos:start="3234:5" pos:end="3234:33"><name pos:start="3234:5" pos:end="3234:7">ctx</name><operator pos:start="3234:8" pos:end="3234:9">-&gt;</operator><name pos:start="3234:10" pos:end="3234:33">enrolled_client_cert_len</name></name> <operator pos:start="3234:35" pos:end="3234:35">=</operator> <literal type="number" pos:start="3234:37" pos:end="3234:37">0</literal></expr>;</expr_stmt>

    <return pos:start="3236:5" pos:end="3236:26">return <expr pos:start="3236:12" pos:end="3236:25"><operator pos:start="3236:12" pos:end="3236:12">(</operator><name pos:start="3236:13" pos:end="3236:24">EST_ERR_NONE</name><operator pos:start="3236:25" pos:end="3236:25">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="3238:1" pos:end="3256:3">/*! @brief est_client_get_cacerts() performs a CAcerts GET request to the EST server
 
    @param ctx Pointer to an EST context
    @param ca_certs_len Pointer to an integer to hold the length of the CA certs
    buffer
 
    @return EST_ERROR

    est_client_get_cacerts() connects to the EST server, builds a CA certs
    request, and sends the GET CA certs request.  The response is placed in a
    buffer allocated and maintained by the EST client library and a pointer to
    this buffer is returned to the calling application.  The returned CA certs
    are in base64 encoded DER format and is stored in a NULL terminated string
    buffer.

    Once the CA certificates are retrieved from the EST server, the ET Client
    library must be reset.  The retrieved CA certificates should now be passed
    into the EST client initialization function as the explicit TA database.
 */</comment>
<function pos:start="3257:1" pos:end="3292:1"><type pos:start="3257:1" pos:end="3257:9"><name pos:start="3257:1" pos:end="3257:9">EST_ERROR</name></type> <name pos:start="3257:11" pos:end="3257:32">est_client_get_cacerts</name> <parameter_list pos:start="3257:34" pos:end="3257:66">(<parameter pos:start="3257:35" pos:end="3257:46"><decl pos:start="3257:35" pos:end="3257:46"><type pos:start="3257:35" pos:end="3257:46"><name pos:start="3257:35" pos:end="3257:41">EST_CTX</name> <modifier pos:start="3257:43" pos:end="3257:43">*</modifier></type><name pos:start="3257:44" pos:end="3257:46">ctx</name></decl></parameter>, <parameter pos:start="3257:49" pos:end="3257:65"><decl pos:start="3257:49" pos:end="3257:65"><type pos:start="3257:49" pos:end="3257:65"><name pos:start="3257:49" pos:end="3257:51">int</name> <modifier pos:start="3257:53" pos:end="3257:53">*</modifier></type><name pos:start="3257:54" pos:end="3257:65">ca_certs_len</name></decl></parameter>)</parameter_list>
<block pos:start="3258:1" pos:end="3292:1">{<block_content pos:start="3259:5" pos:end="3291:16">
    <decl_stmt pos:start="3259:5" pos:end="3259:32"><decl pos:start="3259:5" pos:end="3259:31"><type pos:start="3259:5" pos:end="3259:13"><name pos:start="3259:5" pos:end="3259:13">EST_ERROR</name></type> <name pos:start="3259:15" pos:end="3259:16">rv</name> <init pos:start="3259:18" pos:end="3259:31">= <expr pos:start="3259:20" pos:end="3259:31"><name pos:start="3259:20" pos:end="3259:31">EST_ERR_NONE</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="3260:5" pos:end="3260:20"><decl pos:start="3260:5" pos:end="3260:19"><type pos:start="3260:5" pos:end="3260:9"><name pos:start="3260:5" pos:end="3260:7">SSL</name> <modifier pos:start="3260:9" pos:end="3260:9">*</modifier></type><name pos:start="3260:10" pos:end="3260:12">ssl</name> <init pos:start="3260:14" pos:end="3260:19">= <expr pos:start="3260:16" pos:end="3260:19"><name pos:start="3260:16" pos:end="3260:19">NULL</name></expr></init></decl>;</decl_stmt>

    <if_stmt pos:start="3262:5" pos:end="3264:5"><if pos:start="3262:5" pos:end="3264:5">if <condition pos:start="3262:8" pos:end="3262:13">(<expr pos:start="3262:9" pos:end="3262:12"><operator pos:start="3262:9" pos:end="3262:9">!</operator><name pos:start="3262:10" pos:end="3262:12">ctx</name></expr>)</condition> <block pos:start="3262:15" pos:end="3264:5">{<block_content pos:start="3263:9" pos:end="3263:32">
        <return pos:start="3263:9" pos:end="3263:32">return <expr pos:start="3263:16" pos:end="3263:31"><operator pos:start="3263:16" pos:end="3263:16">(</operator><name pos:start="3263:17" pos:end="3263:30">EST_ERR_NO_CTX</name><operator pos:start="3263:31" pos:end="3263:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3266:5" pos:end="3268:5"><if pos:start="3266:5" pos:end="3268:5">if <condition pos:start="3266:8" pos:end="3266:37">(<expr pos:start="3266:9" pos:end="3266:36"><operator pos:start="3266:9" pos:end="3266:9">!</operator><name pos:start="3266:10" pos:end="3266:36"><name pos:start="3266:10" pos:end="3266:12">ctx</name><operator pos:start="3266:13" pos:end="3266:14">-&gt;</operator><name pos:start="3266:15" pos:end="3266:36">est_client_initialized</name></name></expr>)</condition> <block pos:start="3266:39" pos:end="3268:5">{<block_content pos:start="3267:9" pos:end="3267:46">
        <return pos:start="3267:9" pos:end="3267:46">return <expr pos:start="3267:16" pos:end="3267:45"><name pos:start="3267:16" pos:end="3267:45">EST_ERR_CLIENT_NOT_INITIALIZED</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3270:5" pos:end="3273:5"><if pos:start="3270:5" pos:end="3273:5">if <condition pos:start="3270:8" pos:end="3270:29">(<expr pos:start="3270:9" pos:end="3270:28"><name pos:start="3270:9" pos:end="3270:20">ca_certs_len</name> <operator pos:start="3270:22" pos:end="3270:23">==</operator> <name pos:start="3270:25" pos:end="3270:28">NULL</name></expr>)</condition> <block pos:start="3270:31" pos:end="3273:5">{<block_content pos:start="3271:9" pos:end="3272:42">
        <expr_stmt pos:start="3271:9" pos:end="3271:66"><expr pos:start="3271:9" pos:end="3271:65"><call pos:start="3271:9" pos:end="3271:65"><name pos:start="3271:9" pos:end="3271:19">EST_LOG_ERR</name><argument_list pos:start="3271:20" pos:end="3271:65">(<argument pos:start="3271:21" pos:end="3271:64"><expr pos:start="3271:21" pos:end="3271:64"><literal type="string" pos:start="3271:21" pos:end="3271:64">"EST Client: Get CACerts, invalid parameter"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3272:9" pos:end="3272:42">return <expr pos:start="3272:16" pos:end="3272:41"><name pos:start="3272:16" pos:end="3272:41">EST_ERR_INVALID_PARAMETERS</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    
    <expr_stmt pos:start="3275:5" pos:end="3275:39"><expr pos:start="3275:5" pos:end="3275:38"><name pos:start="3275:5" pos:end="3275:6">rv</name> <operator pos:start="3275:8" pos:end="3275:8">=</operator> <call pos:start="3275:10" pos:end="3275:38"><name pos:start="3275:10" pos:end="3275:27">est_client_connect</name><argument_list pos:start="3275:28" pos:end="3275:38">(<argument pos:start="3275:29" pos:end="3275:31"><expr pos:start="3275:29" pos:end="3275:31"><name pos:start="3275:29" pos:end="3275:31">ctx</name></expr></argument>, <argument pos:start="3275:34" pos:end="3275:37"><expr pos:start="3275:34" pos:end="3275:37"><operator pos:start="3275:34" pos:end="3275:34">&amp;</operator><name pos:start="3275:35" pos:end="3275:37">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="3276:5" pos:end="3282:5"><if pos:start="3276:5" pos:end="3282:5">if <condition pos:start="3276:8" pos:end="3276:27">(<expr pos:start="3276:9" pos:end="3276:26"><name pos:start="3276:9" pos:end="3276:10">rv</name> <operator pos:start="3276:12" pos:end="3276:13">!=</operator> <name pos:start="3276:15" pos:end="3276:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="3276:29" pos:end="3282:5">{<block_content pos:start="3277:9" pos:end="3281:20">
        <if_stmt pos:start="3277:9" pos:end="3280:9"><if pos:start="3277:9" pos:end="3280:9">if <condition pos:start="3277:12" pos:end="3277:16">(<expr pos:start="3277:13" pos:end="3277:15"><name pos:start="3277:13" pos:end="3277:15">ssl</name></expr>)</condition> <block pos:start="3277:18" pos:end="3280:9">{<block_content pos:start="3278:13" pos:end="3279:26">
            <expr_stmt pos:start="3278:13" pos:end="3278:30"><expr pos:start="3278:13" pos:end="3278:29"><call pos:start="3278:13" pos:end="3278:29"><name pos:start="3278:13" pos:end="3278:24">SSL_shutdown</name><argument_list pos:start="3278:25" pos:end="3278:29">(<argument pos:start="3278:26" pos:end="3278:28"><expr pos:start="3278:26" pos:end="3278:28"><name pos:start="3278:26" pos:end="3278:28">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="3279:13" pos:end="3279:26"><expr pos:start="3279:13" pos:end="3279:25"><call pos:start="3279:13" pos:end="3279:25"><name pos:start="3279:13" pos:end="3279:20">SSL_free</name><argument_list pos:start="3279:21" pos:end="3279:25">(<argument pos:start="3279:22" pos:end="3279:24"><expr pos:start="3279:22" pos:end="3279:24"><name pos:start="3279:22" pos:end="3279:24">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></if></if_stmt>        
        <return pos:start="3281:9" pos:end="3281:20">return <expr pos:start="3281:16" pos:end="3281:19"><operator pos:start="3281:16" pos:end="3281:16">(</operator><name pos:start="3281:17" pos:end="3281:18">rv</name><operator pos:start="3281:19" pos:end="3281:19">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="3283:5" pos:end="3283:65"><expr pos:start="3283:5" pos:end="3283:64"><name pos:start="3283:5" pos:end="3283:6">rv</name> <operator pos:start="3283:8" pos:end="3283:8">=</operator> <call pos:start="3283:10" pos:end="3283:64"><name pos:start="3283:10" pos:end="3283:40">est_client_send_cacerts_request</name><argument_list pos:start="3283:41" pos:end="3283:64">(<argument pos:start="3283:42" pos:end="3283:44"><expr pos:start="3283:42" pos:end="3283:44"><name pos:start="3283:42" pos:end="3283:44">ctx</name></expr></argument>, <argument pos:start="3283:47" pos:end="3283:49"><expr pos:start="3283:47" pos:end="3283:49"><name pos:start="3283:47" pos:end="3283:49">ssl</name></expr></argument>, <argument pos:start="3283:52" pos:end="3283:63"><expr pos:start="3283:52" pos:end="3283:63"><name pos:start="3283:52" pos:end="3283:63">ca_certs_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="3284:5" pos:end="3284:37"><expr pos:start="3284:5" pos:end="3284:36"><call pos:start="3284:5" pos:end="3284:36"><name pos:start="3284:5" pos:end="3284:25">est_client_disconnect</name><argument_list pos:start="3284:26" pos:end="3284:36">(<argument pos:start="3284:27" pos:end="3284:29"><expr pos:start="3284:27" pos:end="3284:29"><name pos:start="3284:27" pos:end="3284:29">ctx</name></expr></argument>, <argument pos:start="3284:32" pos:end="3284:35"><expr pos:start="3284:32" pos:end="3284:35"><operator pos:start="3284:32" pos:end="3284:32">&amp;</operator><name pos:start="3284:33" pos:end="3284:35">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <if_stmt pos:start="3286:5" pos:end="3289:5"><if pos:start="3286:5" pos:end="3289:5">if <condition pos:start="3286:8" pos:end="3286:12">(<expr pos:start="3286:9" pos:end="3286:11"><name pos:start="3286:9" pos:end="3286:11">ssl</name></expr>)</condition> <block pos:start="3286:14" pos:end="3289:5">{<block_content pos:start="3287:9" pos:end="3288:22">
        <expr_stmt pos:start="3287:9" pos:end="3287:26"><expr pos:start="3287:9" pos:end="3287:25"><call pos:start="3287:9" pos:end="3287:25"><name pos:start="3287:9" pos:end="3287:20">SSL_shutdown</name><argument_list pos:start="3287:21" pos:end="3287:25">(<argument pos:start="3287:22" pos:end="3287:24"><expr pos:start="3287:22" pos:end="3287:24"><name pos:start="3287:22" pos:end="3287:24">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>    
        <expr_stmt pos:start="3288:9" pos:end="3288:22"><expr pos:start="3288:9" pos:end="3288:21"><call pos:start="3288:9" pos:end="3288:21"><name pos:start="3288:9" pos:end="3288:16">SSL_free</name><argument_list pos:start="3288:17" pos:end="3288:21">(<argument pos:start="3288:18" pos:end="3288:20"><expr pos:start="3288:18" pos:end="3288:20"><name pos:start="3288:18" pos:end="3288:20">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    
    <return pos:start="3291:5" pos:end="3291:16">return <expr pos:start="3291:12" pos:end="3291:15"><operator pos:start="3291:12" pos:end="3291:12">(</operator><name pos:start="3291:13" pos:end="3291:14">rv</name><operator pos:start="3291:15" pos:end="3291:15">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="3293:1" pos:end="3311:3">/*! @brief est_client_copy_cacerts() copies the previously retrieved CA
    certificates to the application's buffer.
 
    @param ctx Pointer to the current EST context.
    @param ca_certs Pointer to the buffer into which the retrieved CA certificates
    are to be copied. 
 
    @return EST_ERROR

    est_client_copy_cacerts() copies the most recently retrieved CA
    certificates from the EST server.  Once these CA certificates are copied
    to the application's buffer pointed to by ca_certs they are removed from
    the EST clietn context.

    Once the CA certificates are retrieved by the application, the EST client
    library must be reset.  When this reset is performed, the CA certificates
    retrieved in this est_client_copy_cacerts call should be passed into the
    EST client initialization function as the explicit TA database.
 */</comment>
<function pos:start="3312:1" pos:end="3343:1"><type pos:start="3312:1" pos:end="3312:9"><name pos:start="3312:1" pos:end="3312:9">EST_ERROR</name></type> <name pos:start="3312:11" pos:end="3312:33">est_client_copy_cacerts</name> <parameter_list pos:start="3312:35" pos:end="3312:73">(<parameter pos:start="3312:36" pos:end="3312:47"><decl pos:start="3312:36" pos:end="3312:47"><type pos:start="3312:36" pos:end="3312:47"><name pos:start="3312:36" pos:end="3312:42">EST_CTX</name> <modifier pos:start="3312:44" pos:end="3312:44">*</modifier></type><name pos:start="3312:45" pos:end="3312:47">ctx</name></decl></parameter>, <parameter pos:start="3312:50" pos:end="3312:72"><decl pos:start="3312:50" pos:end="3312:72"><type pos:start="3312:50" pos:end="3312:72"><name pos:start="3312:50" pos:end="3312:57">unsigned</name> <name pos:start="3312:59" pos:end="3312:62">char</name> <modifier pos:start="3312:64" pos:end="3312:64">*</modifier></type><name pos:start="3312:65" pos:end="3312:72">ca_certs</name></decl></parameter>)</parameter_list>
<block pos:start="3313:1" pos:end="3343:1">{<block_content pos:start="3315:5" pos:end="3342:26">

    <if_stmt pos:start="3315:5" pos:end="3317:5"><if pos:start="3315:5" pos:end="3317:5">if <condition pos:start="3315:8" pos:end="3315:13">(<expr pos:start="3315:9" pos:end="3315:12"><operator pos:start="3315:9" pos:end="3315:9">!</operator><name pos:start="3315:10" pos:end="3315:12">ctx</name></expr>)</condition> <block pos:start="3315:15" pos:end="3317:5">{<block_content pos:start="3316:9" pos:end="3316:32">
        <return pos:start="3316:9" pos:end="3316:32">return <expr pos:start="3316:16" pos:end="3316:31"><operator pos:start="3316:16" pos:end="3316:16">(</operator><name pos:start="3316:17" pos:end="3316:30">EST_ERR_NO_CTX</name><operator pos:start="3316:31" pos:end="3316:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3319:5" pos:end="3321:5"><if pos:start="3319:5" pos:end="3321:5">if <condition pos:start="3319:8" pos:end="3319:37">(<expr pos:start="3319:9" pos:end="3319:36"><operator pos:start="3319:9" pos:end="3319:9">!</operator><name pos:start="3319:10" pos:end="3319:36"><name pos:start="3319:10" pos:end="3319:12">ctx</name><operator pos:start="3319:13" pos:end="3319:14">-&gt;</operator><name pos:start="3319:15" pos:end="3319:36">est_client_initialized</name></name></expr>)</condition> <block pos:start="3319:39" pos:end="3321:5">{<block_content pos:start="3320:9" pos:end="3320:46">
        <return pos:start="3320:9" pos:end="3320:46">return <expr pos:start="3320:16" pos:end="3320:45"><name pos:start="3320:16" pos:end="3320:45">EST_ERR_CLIENT_NOT_INITIALIZED</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3323:5" pos:end="3326:5"><if pos:start="3323:5" pos:end="3326:5">if <condition pos:start="3323:8" pos:end="3323:25">(<expr pos:start="3323:9" pos:end="3323:24"><name pos:start="3323:9" pos:end="3323:16">ca_certs</name> <operator pos:start="3323:18" pos:end="3323:19">==</operator> <name pos:start="3323:21" pos:end="3323:24">NULL</name></expr>)</condition> <block pos:start="3323:27" pos:end="3326:5">{<block_content pos:start="3324:9" pos:end="3325:42">
        <expr_stmt pos:start="3324:9" pos:end="3324:66"><expr pos:start="3324:9" pos:end="3324:65"><call pos:start="3324:9" pos:end="3324:65"><name pos:start="3324:9" pos:end="3324:19">EST_LOG_ERR</name><argument_list pos:start="3324:20" pos:end="3324:65">(<argument pos:start="3324:21" pos:end="3324:64"><expr pos:start="3324:21" pos:end="3324:64"><literal type="string" pos:start="3324:21" pos:end="3324:64">"EST Client: Get CACerts, invalid parameter"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3325:9" pos:end="3325:42">return <expr pos:start="3325:16" pos:end="3325:41"><name pos:start="3325:16" pos:end="3325:41">EST_ERR_INVALID_PARAMETERS</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    
    <if_stmt pos:start="3328:5" pos:end="3331:5"><if pos:start="3328:5" pos:end="3331:5">if <condition pos:start="3328:8" pos:end="3328:40">(<expr pos:start="3328:9" pos:end="3328:39"><name pos:start="3328:9" pos:end="3328:31"><name pos:start="3328:9" pos:end="3328:11">ctx</name><operator pos:start="3328:12" pos:end="3328:13">-&gt;</operator><name pos:start="3328:14" pos:end="3328:31">retrieved_ca_certs</name></name> <operator pos:start="3328:33" pos:end="3328:34">==</operator> <name pos:start="3328:36" pos:end="3328:39">NULL</name></expr>)</condition> <block pos:start="3328:42" pos:end="3331:5">{<block_content pos:start="3329:9" pos:end="3330:39">
        <expr_stmt pos:start="3329:9" pos:end="3329:50"><expr pos:start="3329:9" pos:end="3329:49"><call pos:start="3329:9" pos:end="3329:49"><name pos:start="3329:9" pos:end="3329:19">EST_LOG_ERR</name><argument_list pos:start="3329:20" pos:end="3329:49">(<argument pos:start="3329:21" pos:end="3329:48"><expr pos:start="3329:21" pos:end="3329:48"><literal type="string" pos:start="3329:21" pos:end="3329:48">"No CA certificates to copy"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3330:9" pos:end="3330:39">return<expr pos:start="3330:15" pos:end="3330:38"><operator pos:start="3330:15" pos:end="3330:15">(</operator><name pos:start="3330:16" pos:end="3330:37">EST_ERR_NO_CERTIFICATE</name><operator pos:start="3330:38" pos:end="3330:38">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="3333:5" pos:end="3333:53"><expr pos:start="3333:5" pos:end="3333:52"><call pos:start="3333:5" pos:end="3333:52"><name pos:start="3333:5" pos:end="3333:13">memzero_s</name><argument_list pos:start="3333:14" pos:end="3333:52">(<argument pos:start="3333:15" pos:end="3333:22"><expr pos:start="3333:15" pos:end="3333:22"><name pos:start="3333:15" pos:end="3333:22">ca_certs</name></expr></argument>, <argument pos:start="3333:25" pos:end="3333:51"><expr pos:start="3333:25" pos:end="3333:51"><name pos:start="3333:25" pos:end="3333:51"><name pos:start="3333:25" pos:end="3333:27">ctx</name><operator pos:start="3333:28" pos:end="3333:29">-&gt;</operator><name pos:start="3333:30" pos:end="3333:51">retrieved_ca_certs_len</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="3334:5" pos:end="3335:42"><expr pos:start="3334:5" pos:end="3335:41"><call pos:start="3334:5" pos:end="3335:41"><name pos:start="3334:5" pos:end="3334:12">memcpy_s</name><argument_list pos:start="3334:13" pos:end="3335:41">(<argument pos:start="3334:14" pos:end="3334:21"><expr pos:start="3334:14" pos:end="3334:21"><name pos:start="3334:14" pos:end="3334:21">ca_certs</name></expr></argument>, <argument pos:start="3334:24" pos:end="3334:50"><expr pos:start="3334:24" pos:end="3334:50"><name pos:start="3334:24" pos:end="3334:50"><name pos:start="3334:24" pos:end="3334:26">ctx</name><operator pos:start="3334:27" pos:end="3334:28">-&gt;</operator><name pos:start="3334:29" pos:end="3334:50">retrieved_ca_certs_len</name></name></expr></argument>, <argument pos:start="3334:53" pos:end="3334:75"><expr pos:start="3334:53" pos:end="3334:75"><name pos:start="3334:53" pos:end="3334:75"><name pos:start="3334:53" pos:end="3334:55">ctx</name><operator pos:start="3334:56" pos:end="3334:57">-&gt;</operator><name pos:start="3334:58" pos:end="3334:75">retrieved_ca_certs</name></name></expr></argument>,
             <argument pos:start="3335:14" pos:end="3335:40"><expr pos:start="3335:14" pos:end="3335:40"><name pos:start="3335:14" pos:end="3335:40"><name pos:start="3335:14" pos:end="3335:16">ctx</name><operator pos:start="3335:17" pos:end="3335:18">-&gt;</operator><name pos:start="3335:19" pos:end="3335:40">retrieved_ca_certs_len</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block" pos:start="3337:5" pos:end="3339:7">/*
     * if the CA certs were obtained, then the client lib needs to be reset.
     */</comment>
    <expr_stmt pos:start="3340:5" pos:end="3340:36"><expr pos:start="3340:5" pos:end="3340:35"><name pos:start="3340:5" pos:end="3340:31"><name pos:start="3340:5" pos:end="3340:7">ctx</name><operator pos:start="3340:8" pos:end="3340:9">-&gt;</operator><name pos:start="3340:10" pos:end="3340:31">est_client_initialized</name></name> <operator pos:start="3340:33" pos:end="3340:33">=</operator> <literal type="number" pos:start="3340:35" pos:end="3340:35">0</literal></expr>;</expr_stmt>
    
    <return pos:start="3342:5" pos:end="3342:26">return <expr pos:start="3342:12" pos:end="3342:25"><operator pos:start="3342:12" pos:end="3342:12">(</operator><name pos:start="3342:13" pos:end="3342:24">EST_ERR_NONE</name><operator pos:start="3342:25" pos:end="3342:25">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="3344:1" pos:end="3358:3">/*! @brief est_client_get_csrattrs() performs the CSR attributes request to
    the EST server.
 
    @param ctx Pointer to EST context for a client session
    @param csr_data Pointer to a buffer that is to hold the returned CSR
    attributes
    @param csr_len Pointer to an integer that is to hold the length of the CSR
    attributes buffer
 
    @return EST_ERROR

    est_client_get_csrattrs() connects to the EST server, sends the CSR attributes
    request to the server, saves aways the returned CSR attribute data, and then
    disconnects from the EST server.
 */</comment>
<function pos:start="3359:1" pos:end="3463:1"><type pos:start="3359:1" pos:end="3359:9"><name pos:start="3359:1" pos:end="3359:9">EST_ERROR</name></type> <name pos:start="3359:11" pos:end="3359:33">est_client_get_csrattrs</name> <parameter_list pos:start="3359:35" pos:end="3359:88">(<parameter pos:start="3359:36" pos:end="3359:47"><decl pos:start="3359:36" pos:end="3359:47"><type pos:start="3359:36" pos:end="3359:47"><name pos:start="3359:36" pos:end="3359:42">EST_CTX</name> <modifier pos:start="3359:44" pos:end="3359:44">*</modifier></type><name pos:start="3359:45" pos:end="3359:47">ctx</name></decl></parameter>, <parameter pos:start="3359:50" pos:end="3359:73"><decl pos:start="3359:50" pos:end="3359:73"><type pos:start="3359:50" pos:end="3359:73"><name pos:start="3359:50" pos:end="3359:57">unsigned</name> <name pos:start="3359:59" pos:end="3359:62">char</name> <modifier pos:start="3359:64" pos:end="3359:64">*</modifier><modifier pos:start="3359:65" pos:end="3359:65">*</modifier></type><name pos:start="3359:66" pos:end="3359:73">csr_data</name></decl></parameter>, <parameter pos:start="3359:76" pos:end="3359:87"><decl pos:start="3359:76" pos:end="3359:87"><type pos:start="3359:76" pos:end="3359:87"><name pos:start="3359:76" pos:end="3359:78">int</name> <modifier pos:start="3359:80" pos:end="3359:80">*</modifier></type><name pos:start="3359:81" pos:end="3359:87">csr_len</name></decl></parameter>)</parameter_list>
<block pos:start="3360:1" pos:end="3463:1">{<block_content pos:start="3361:5" pos:end="3462:16">
    <decl_stmt pos:start="3361:5" pos:end="3361:42"><decl pos:start="3361:5" pos:end="3361:10"><type pos:start="3361:5" pos:end="3361:7"><name pos:start="3361:5" pos:end="3361:7">int</name></type> <name pos:start="3361:9" pos:end="3361:10">rv</name></decl>, <decl pos:start="3361:13" pos:end="3361:23"><type ref="prev" pos:start="3361:5" pos:end="3361:7"/><name pos:start="3361:13" pos:end="3361:23">new_csr_len</name></decl>, <decl pos:start="3361:26" pos:end="3361:41"><type ref="prev" pos:start="3361:5" pos:end="3361:7"/><name pos:start="3361:26" pos:end="3361:37">pop_required</name> <init pos:start="3361:39" pos:end="3361:41">= <expr pos:start="3361:41" pos:end="3361:41"><literal type="number" pos:start="3361:41" pos:end="3361:41">0</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="3362:5" pos:end="3362:20"><decl pos:start="3362:5" pos:end="3362:19"><type pos:start="3362:5" pos:end="3362:9"><name pos:start="3362:5" pos:end="3362:7">SSL</name> <modifier pos:start="3362:9" pos:end="3362:9">*</modifier></type><name pos:start="3362:10" pos:end="3362:12">ssl</name> <init pos:start="3362:14" pos:end="3362:19">= <expr pos:start="3362:16" pos:end="3362:19"><name pos:start="3362:16" pos:end="3362:19">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="3363:5" pos:end="3363:32"><decl pos:start="3363:5" pos:end="3363:31"><type pos:start="3363:5" pos:end="3363:19"><name pos:start="3363:5" pos:end="3363:12">unsigned</name> <name pos:start="3363:14" pos:end="3363:17">char</name> <modifier pos:start="3363:19" pos:end="3363:19">*</modifier></type><name pos:start="3363:20" pos:end="3363:31">new_csr_data</name></decl>;</decl_stmt>

    <if_stmt pos:start="3365:5" pos:end="3367:5"><if pos:start="3365:5" pos:end="3367:5">if <condition pos:start="3365:8" pos:end="3365:13">(<expr pos:start="3365:9" pos:end="3365:12"><operator pos:start="3365:9" pos:end="3365:9">!</operator><name pos:start="3365:10" pos:end="3365:12">ctx</name></expr>)</condition> <block pos:start="3365:15" pos:end="3367:5">{<block_content pos:start="3366:9" pos:end="3366:32">
        <return pos:start="3366:9" pos:end="3366:32">return <expr pos:start="3366:16" pos:end="3366:31"><operator pos:start="3366:16" pos:end="3366:16">(</operator><name pos:start="3366:17" pos:end="3366:30">EST_ERR_NO_CTX</name><operator pos:start="3366:31" pos:end="3366:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3369:5" pos:end="3371:5"><if pos:start="3369:5" pos:end="3371:5">if <condition pos:start="3369:8" pos:end="3369:18">(<expr pos:start="3369:9" pos:end="3369:17"><operator pos:start="3369:9" pos:end="3369:9">!</operator><name pos:start="3369:10" pos:end="3369:17">csr_data</name></expr>)</condition> <block pos:start="3369:20" pos:end="3371:5">{<block_content pos:start="3370:9" pos:end="3370:44">
        <return pos:start="3370:9" pos:end="3370:44">return <expr pos:start="3370:16" pos:end="3370:43"><operator pos:start="3370:16" pos:end="3370:16">(</operator><name pos:start="3370:17" pos:end="3370:42">EST_ERR_INVALID_PARAMETERS</name><operator pos:start="3370:43" pos:end="3370:43">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3373:5" pos:end="3375:5"><if pos:start="3373:5" pos:end="3375:5">if <condition pos:start="3373:8" pos:end="3373:17">(<expr pos:start="3373:9" pos:end="3373:16"><operator pos:start="3373:9" pos:end="3373:9">!</operator><name pos:start="3373:10" pos:end="3373:16">csr_len</name></expr>)</condition> <block pos:start="3373:19" pos:end="3375:5">{<block_content pos:start="3374:9" pos:end="3374:44">
        <return pos:start="3374:9" pos:end="3374:44">return <expr pos:start="3374:16" pos:end="3374:43"><operator pos:start="3374:16" pos:end="3374:16">(</operator><name pos:start="3374:17" pos:end="3374:42">EST_ERR_INVALID_PARAMETERS</name><operator pos:start="3374:43" pos:end="3374:43">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="3377:5" pos:end="3377:23">/* assume defeat */</comment>
    <expr_stmt pos:start="3378:5" pos:end="3378:21"><expr pos:start="3378:5" pos:end="3378:20"><operator pos:start="3378:5" pos:end="3378:5">*</operator><name pos:start="3378:6" pos:end="3378:13">csr_data</name> <operator pos:start="3378:15" pos:end="3378:15">=</operator> <name pos:start="3378:17" pos:end="3378:20">NULL</name></expr>;</expr_stmt>
    <expr_stmt pos:start="3379:5" pos:end="3379:17"><expr pos:start="3379:5" pos:end="3379:16"><operator pos:start="3379:5" pos:end="3379:5">*</operator><name pos:start="3379:6" pos:end="3379:12">csr_len</name> <operator pos:start="3379:14" pos:end="3379:14">=</operator> <literal type="number" pos:start="3379:16" pos:end="3379:16">0</literal></expr>;</expr_stmt>
    
    <comment type="block" pos:start="3381:5" pos:end="3383:7">/*
     * Connect to the EST server
     */</comment>
    <expr_stmt pos:start="3384:5" pos:end="3384:39"><expr pos:start="3384:5" pos:end="3384:38"><name pos:start="3384:5" pos:end="3384:6">rv</name> <operator pos:start="3384:8" pos:end="3384:8">=</operator> <call pos:start="3384:10" pos:end="3384:38"><name pos:start="3384:10" pos:end="3384:27">est_client_connect</name><argument_list pos:start="3384:28" pos:end="3384:38">(<argument pos:start="3384:29" pos:end="3384:31"><expr pos:start="3384:29" pos:end="3384:31"><name pos:start="3384:29" pos:end="3384:31">ctx</name></expr></argument>, <argument pos:start="3384:34" pos:end="3384:37"><expr pos:start="3384:34" pos:end="3384:37"><operator pos:start="3384:34" pos:end="3384:34">&amp;</operator><name pos:start="3384:35" pos:end="3384:37">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="3385:5" pos:end="3392:5"><if pos:start="3385:5" pos:end="3392:5">if <condition pos:start="3385:8" pos:end="3385:27">(<expr pos:start="3385:9" pos:end="3385:26"><name pos:start="3385:9" pos:end="3385:10">rv</name> <operator pos:start="3385:12" pos:end="3385:13">!=</operator> <name pos:start="3385:15" pos:end="3385:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="3385:29" pos:end="3392:5">{<block_content pos:start="3386:9" pos:end="3391:20">
        <if_stmt pos:start="3386:9" pos:end="3389:9"><if pos:start="3386:9" pos:end="3389:9">if <condition pos:start="3386:12" pos:end="3386:16">(<expr pos:start="3386:13" pos:end="3386:15"><name pos:start="3386:13" pos:end="3386:15">ssl</name></expr>)</condition> <block pos:start="3386:18" pos:end="3389:9">{<block_content pos:start="3387:13" pos:end="3388:26">
            <expr_stmt pos:start="3387:13" pos:end="3387:30"><expr pos:start="3387:13" pos:end="3387:29"><call pos:start="3387:13" pos:end="3387:29"><name pos:start="3387:13" pos:end="3387:24">SSL_shutdown</name><argument_list pos:start="3387:25" pos:end="3387:29">(<argument pos:start="3387:26" pos:end="3387:28"><expr pos:start="3387:26" pos:end="3387:28"><name pos:start="3387:26" pos:end="3387:28">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt pos:start="3388:13" pos:end="3388:26"><expr pos:start="3388:13" pos:end="3388:25"><call pos:start="3388:13" pos:end="3388:25"><name pos:start="3388:13" pos:end="3388:20">SSL_free</name><argument_list pos:start="3388:21" pos:end="3388:25">(<argument pos:start="3388:22" pos:end="3388:24"><expr pos:start="3388:22" pos:end="3388:24"><name pos:start="3388:22" pos:end="3388:24">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        </block_content>}</block></if></if_stmt>

        <return pos:start="3391:9" pos:end="3391:20">return <expr pos:start="3391:16" pos:end="3391:19"><operator pos:start="3391:16" pos:end="3391:16">(</operator><name pos:start="3391:17" pos:end="3391:18">rv</name><operator pos:start="3391:19" pos:end="3391:19">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="3394:5" pos:end="3396:7">/*
     * free the current attributes if cached
     */</comment>
    <if_stmt pos:start="3397:5" pos:end="3401:5"><if pos:start="3397:5" pos:end="3401:5">if <condition pos:start="3397:8" pos:end="3397:32">(<expr pos:start="3397:9" pos:end="3397:31"><name pos:start="3397:9" pos:end="3397:31"><name pos:start="3397:9" pos:end="3397:11">ctx</name><operator pos:start="3397:12" pos:end="3397:13">-&gt;</operator><name pos:start="3397:14" pos:end="3397:31">retrieved_csrattrs</name></name></expr>)</condition> <block pos:start="3397:34" pos:end="3401:5">{<block_content pos:start="3398:9" pos:end="3400:40">
        <expr_stmt pos:start="3398:9" pos:end="3398:38"><expr pos:start="3398:9" pos:end="3398:37"><call pos:start="3398:9" pos:end="3398:37"><name pos:start="3398:9" pos:end="3398:12">free</name><argument_list pos:start="3398:13" pos:end="3398:37">(<argument pos:start="3398:14" pos:end="3398:36"><expr pos:start="3398:14" pos:end="3398:36"><name pos:start="3398:14" pos:end="3398:36"><name pos:start="3398:14" pos:end="3398:16">ctx</name><operator pos:start="3398:17" pos:end="3398:18">-&gt;</operator><name pos:start="3398:19" pos:end="3398:36">retrieved_csrattrs</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt pos:start="3399:9" pos:end="3399:39"><expr pos:start="3399:9" pos:end="3399:38"><name pos:start="3399:9" pos:end="3399:31"><name pos:start="3399:9" pos:end="3399:11">ctx</name><operator pos:start="3399:12" pos:end="3399:13">-&gt;</operator><name pos:start="3399:14" pos:end="3399:31">retrieved_csrattrs</name></name> <operator pos:start="3399:33" pos:end="3399:33">=</operator> <name pos:start="3399:35" pos:end="3399:38">NULL</name></expr>;</expr_stmt>
        <expr_stmt pos:start="3400:9" pos:end="3400:40"><expr pos:start="3400:9" pos:end="3400:39"><name pos:start="3400:9" pos:end="3400:35"><name pos:start="3400:9" pos:end="3400:11">ctx</name><operator pos:start="3400:12" pos:end="3400:13">-&gt;</operator><name pos:start="3400:14" pos:end="3400:35">retrieved_csrattrs_len</name></name> <operator pos:start="3400:37" pos:end="3400:37">=</operator> <literal type="number" pos:start="3400:39" pos:end="3400:39">0</literal></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="3402:5" pos:end="3402:36"><expr pos:start="3402:5" pos:end="3402:35"><name pos:start="3402:5" pos:end="3402:31"><name pos:start="3402:5" pos:end="3402:7">ctx</name><operator pos:start="3402:8" pos:end="3402:9">-&gt;</operator><name pos:start="3402:10" pos:end="3402:31">retrieved_csrattrs_len</name></name> <operator pos:start="3402:33" pos:end="3402:33">=</operator> <literal type="number" pos:start="3402:35" pos:end="3402:35">0</literal></expr>;</expr_stmt>
    <expr_stmt pos:start="3403:5" pos:end="3403:35"><expr pos:start="3403:5" pos:end="3403:34"><name pos:start="3403:5" pos:end="3403:27"><name pos:start="3403:5" pos:end="3403:7">ctx</name><operator pos:start="3403:8" pos:end="3403:9">-&gt;</operator><name pos:start="3403:10" pos:end="3403:27">retrieved_csrattrs</name></name> <operator pos:start="3403:29" pos:end="3403:29">=</operator> <name pos:start="3403:31" pos:end="3403:34">NULL</name></expr>;</expr_stmt>

    <comment type="block" pos:start="3405:5" pos:end="3407:7">/*
     * Send the HTTP request to the EST server
     */</comment>
    <expr_stmt pos:start="3408:5" pos:end="3408:81"><expr pos:start="3408:5" pos:end="3408:80"><name pos:start="3408:5" pos:end="3408:6">rv</name> <operator pos:start="3408:8" pos:end="3408:8">=</operator> <call pos:start="3408:10" pos:end="3408:80"><name pos:start="3408:10" pos:end="3408:41">est_client_send_csrattrs_request</name><argument_list pos:start="3408:42" pos:end="3408:80">(<argument pos:start="3408:43" pos:end="3408:45"><expr pos:start="3408:43" pos:end="3408:45"><name pos:start="3408:43" pos:end="3408:45">ctx</name></expr></argument>, <argument pos:start="3408:48" pos:end="3408:50"><expr pos:start="3408:48" pos:end="3408:50"><name pos:start="3408:48" pos:end="3408:50">ssl</name></expr></argument>, <argument pos:start="3408:53" pos:end="3408:65"><expr pos:start="3408:53" pos:end="3408:65"><operator pos:start="3408:53" pos:end="3408:53">&amp;</operator><name pos:start="3408:54" pos:end="3408:65">new_csr_data</name></expr></argument>, <argument pos:start="3408:68" pos:end="3408:79"><expr pos:start="3408:68" pos:end="3408:79"><operator pos:start="3408:68" pos:end="3408:68">&amp;</operator><name pos:start="3408:69" pos:end="3408:79">new_csr_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="3409:5" pos:end="3409:37"><expr pos:start="3409:5" pos:end="3409:36"><call pos:start="3409:5" pos:end="3409:36"><name pos:start="3409:5" pos:end="3409:25">est_client_disconnect</name><argument_list pos:start="3409:26" pos:end="3409:36">(<argument pos:start="3409:27" pos:end="3409:29"><expr pos:start="3409:27" pos:end="3409:29"><name pos:start="3409:27" pos:end="3409:29">ctx</name></expr></argument>, <argument pos:start="3409:32" pos:end="3409:35"><expr pos:start="3409:32" pos:end="3409:35"><operator pos:start="3409:32" pos:end="3409:32">&amp;</operator><name pos:start="3409:33" pos:end="3409:35">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <if_stmt pos:start="3411:5" pos:end="3421:5"><if pos:start="3411:5" pos:end="3421:5">if <condition pos:start="3411:8" pos:end="3411:27">(<expr pos:start="3411:9" pos:end="3411:26"><name pos:start="3411:9" pos:end="3411:10">rv</name> <operator pos:start="3411:12" pos:end="3411:13">!=</operator> <name pos:start="3411:15" pos:end="3411:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="3411:29" pos:end="3421:5">{<block_content pos:start="3412:9" pos:end="3420:20">
        <expr_stmt pos:start="3412:9" pos:end="3412:93"><expr pos:start="3412:9" pos:end="3412:92"><call pos:start="3412:9" pos:end="3412:92"><name pos:start="3412:9" pos:end="3412:19">EST_LOG_ERR</name><argument_list pos:start="3412:20" pos:end="3412:92">(<argument pos:start="3412:21" pos:end="3412:63"><expr pos:start="3412:21" pos:end="3412:63"><literal type="string" pos:start="3412:21" pos:end="3412:63">"CSR request failed, error code is %d (%s)"</literal></expr></argument>, <argument pos:start="3412:66" pos:end="3412:67"><expr pos:start="3412:66" pos:end="3412:67"><name pos:start="3412:66" pos:end="3412:67">rv</name></expr></argument>, <argument pos:start="3412:70" pos:end="3412:91"><expr pos:start="3412:70" pos:end="3412:91"><call pos:start="3412:70" pos:end="3412:91"><name pos:start="3412:70" pos:end="3412:87">EST_ERR_NUM_TO_STR</name><argument_list pos:start="3412:88" pos:end="3412:91">(<argument pos:start="3412:89" pos:end="3412:90"><expr pos:start="3412:89" pos:end="3412:90"><name pos:start="3412:89" pos:end="3412:90">rv</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if_stmt pos:start="3413:9" pos:end="3415:9"><if pos:start="3413:9" pos:end="3415:9">if <condition pos:start="3413:12" pos:end="3413:25">(<expr pos:start="3413:13" pos:end="3413:24"><name pos:start="3413:13" pos:end="3413:24">new_csr_data</name></expr>)</condition> <block pos:start="3413:27" pos:end="3415:9">{<block_content pos:start="3414:13" pos:end="3414:31">
	    <expr_stmt pos:start="3414:13" pos:end="3414:31"><expr pos:start="3414:13" pos:end="3414:30"><call pos:start="3414:13" pos:end="3414:30"><name pos:start="3414:13" pos:end="3414:16">free</name><argument_list pos:start="3414:17" pos:end="3414:30">(<argument pos:start="3414:18" pos:end="3414:29"><expr pos:start="3414:18" pos:end="3414:29"><name pos:start="3414:18" pos:end="3414:29">new_csr_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	</block_content>}</block></if></if_stmt>
	<if_stmt pos:start="3416:9" pos:end="3419:9"><if pos:start="3416:9" pos:end="3419:9">if <condition pos:start="3416:12" pos:end="3416:16">(<expr pos:start="3416:13" pos:end="3416:15"><name pos:start="3416:13" pos:end="3416:15">ssl</name></expr>)</condition> <block pos:start="3416:18" pos:end="3419:9">{<block_content pos:start="3417:13" pos:end="3418:26">
	    <expr_stmt pos:start="3417:13" pos:end="3417:30"><expr pos:start="3417:13" pos:end="3417:29"><call pos:start="3417:13" pos:end="3417:29"><name pos:start="3417:13" pos:end="3417:24">SSL_shutdown</name><argument_list pos:start="3417:25" pos:end="3417:29">(<argument pos:start="3417:26" pos:end="3417:28"><expr pos:start="3417:26" pos:end="3417:28"><name pos:start="3417:26" pos:end="3417:28">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt pos:start="3418:13" pos:end="3418:26"><expr pos:start="3418:13" pos:end="3418:25"><call pos:start="3418:13" pos:end="3418:25"><name pos:start="3418:13" pos:end="3418:20">SSL_free</name><argument_list pos:start="3418:21" pos:end="3418:25">(<argument pos:start="3418:22" pos:end="3418:24"><expr pos:start="3418:22" pos:end="3418:24"><name pos:start="3418:22" pos:end="3418:24">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	</block_content>}</block></if></if_stmt>
	<return pos:start="3420:9" pos:end="3420:20">return <expr pos:start="3420:16" pos:end="3420:19"><operator pos:start="3420:16" pos:end="3420:16">(</operator><name pos:start="3420:17" pos:end="3420:18">rv</name><operator pos:start="3420:19" pos:end="3420:19">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3423:5" pos:end="3426:5"><if pos:start="3423:5" pos:end="3426:5">if <condition pos:start="3423:8" pos:end="3423:12">(<expr pos:start="3423:9" pos:end="3423:11"><name pos:start="3423:9" pos:end="3423:11">ssl</name></expr>)</condition> <block pos:start="3423:14" pos:end="3426:5">{<block_content pos:start="3424:9" pos:end="3425:22">
        <expr_stmt pos:start="3424:9" pos:end="3424:26"><expr pos:start="3424:9" pos:end="3424:25"><call pos:start="3424:9" pos:end="3424:25"><name pos:start="3424:9" pos:end="3424:20">SSL_shutdown</name><argument_list pos:start="3424:21" pos:end="3424:25">(<argument pos:start="3424:22" pos:end="3424:24"><expr pos:start="3424:22" pos:end="3424:24"><name pos:start="3424:22" pos:end="3424:24">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="3425:9" pos:end="3425:22"><expr pos:start="3425:9" pos:end="3425:21"><call pos:start="3425:9" pos:end="3425:21"><name pos:start="3425:9" pos:end="3425:16">SSL_free</name><argument_list pos:start="3425:17" pos:end="3425:21">(<argument pos:start="3425:18" pos:end="3425:20"><expr pos:start="3425:18" pos:end="3425:20"><name pos:start="3425:18" pos:end="3425:20">ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3428:5" pos:end="3431:5"><if pos:start="3428:5" pos:end="3431:5">if <condition pos:start="3428:8" pos:end="3428:29">(<expr pos:start="3428:9" pos:end="3428:28"><name pos:start="3428:9" pos:end="3428:20">new_csr_data</name> <operator pos:start="3428:22" pos:end="3428:23">==</operator> <name pos:start="3428:25" pos:end="3428:28">NULL</name></expr>)</condition> <block pos:start="3428:31" pos:end="3431:5">{<block_content pos:start="3429:9" pos:end="3430:30">
        <expr_stmt pos:start="3429:9" pos:end="3429:49"><expr pos:start="3429:9" pos:end="3429:48"><call pos:start="3429:9" pos:end="3429:48"><name pos:start="3429:9" pos:end="3429:20">EST_LOG_INFO</name><argument_list pos:start="3429:21" pos:end="3429:48">(<argument pos:start="3429:22" pos:end="3429:47"><expr pos:start="3429:22" pos:end="3429:47"><literal type="string" pos:start="3429:22" pos:end="3429:47">"CSR attributes are: NULL"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return pos:start="3430:9" pos:end="3430:30">return <expr pos:start="3430:16" pos:end="3430:29"><operator pos:start="3430:16" pos:end="3430:16">(</operator><name pos:start="3430:17" pos:end="3430:28">EST_ERR_NONE</name><operator pos:start="3430:29" pos:end="3430:29">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <comment type="block" pos:start="3432:5" pos:end="3435:7">/* 
     * have to allocate the new memory prior to 
     * parsing to be sure it is null terminated.
     */</comment>
    <expr_stmt pos:start="3436:5" pos:end="3436:54"><expr pos:start="3436:5" pos:end="3436:53"><name pos:start="3436:5" pos:end="3436:27"><name pos:start="3436:5" pos:end="3436:7">ctx</name><operator pos:start="3436:8" pos:end="3436:9">-&gt;</operator><name pos:start="3436:10" pos:end="3436:27">retrieved_csrattrs</name></name> <operator pos:start="3436:29" pos:end="3436:29">=</operator> <call pos:start="3436:31" pos:end="3436:53"><name pos:start="3436:31" pos:end="3436:36">malloc</name><argument_list pos:start="3436:37" pos:end="3436:53">(<argument pos:start="3436:38" pos:end="3436:52"><expr pos:start="3436:38" pos:end="3436:52"><name pos:start="3436:38" pos:end="3436:48">new_csr_len</name> <operator pos:start="3436:50" pos:end="3436:50">+</operator> <literal type="number" pos:start="3436:52" pos:end="3436:52">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="3437:5" pos:end="3440:5"><if pos:start="3437:5" pos:end="3440:5">if <condition pos:start="3437:8" pos:end="3437:33">(<expr pos:start="3437:9" pos:end="3437:32"><operator pos:start="3437:9" pos:end="3437:9">!</operator><name pos:start="3437:10" pos:end="3437:32"><name pos:start="3437:10" pos:end="3437:12">ctx</name><operator pos:start="3437:13" pos:end="3437:14">-&gt;</operator><name pos:start="3437:15" pos:end="3437:32">retrieved_csrattrs</name></name></expr>)</condition> <block pos:start="3437:35" pos:end="3440:5">{<block_content pos:start="3438:9" pos:end="3439:32">
        <expr_stmt pos:start="3438:9" pos:end="3438:27"><expr pos:start="3438:9" pos:end="3438:26"><call pos:start="3438:9" pos:end="3438:26"><name pos:start="3438:9" pos:end="3438:12">free</name><argument_list pos:start="3438:13" pos:end="3438:26">(<argument pos:start="3438:14" pos:end="3438:25"><expr pos:start="3438:14" pos:end="3438:25"><name pos:start="3438:14" pos:end="3438:25">new_csr_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return pos:start="3439:9" pos:end="3439:32">return <expr pos:start="3439:16" pos:end="3439:31"><operator pos:start="3439:16" pos:end="3439:16">(</operator><name pos:start="3439:17" pos:end="3439:30">EST_ERR_MALLOC</name><operator pos:start="3439:31" pos:end="3439:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="3442:5" pos:end="3442:46"><expr pos:start="3442:5" pos:end="3442:45"><name pos:start="3442:5" pos:end="3442:31"><name pos:start="3442:5" pos:end="3442:7">ctx</name><operator pos:start="3442:8" pos:end="3442:9">-&gt;</operator><name pos:start="3442:10" pos:end="3442:31">retrieved_csrattrs_len</name></name> <operator pos:start="3442:33" pos:end="3442:33">=</operator> <name pos:start="3442:35" pos:end="3442:45">new_csr_len</name></expr>;</expr_stmt>
    <expr_stmt pos:start="3443:5" pos:end="3443:80"><expr pos:start="3443:5" pos:end="3443:79"><call pos:start="3443:5" pos:end="3443:79"><name pos:start="3443:5" pos:end="3443:12">memcpy_s</name><argument_list pos:start="3443:13" pos:end="3443:79">(<argument pos:start="3443:14" pos:end="3443:36"><expr pos:start="3443:14" pos:end="3443:36"><name pos:start="3443:14" pos:end="3443:36"><name pos:start="3443:14" pos:end="3443:16">ctx</name><operator pos:start="3443:17" pos:end="3443:18">-&gt;</operator><name pos:start="3443:19" pos:end="3443:36">retrieved_csrattrs</name></name></expr></argument>, <argument pos:start="3443:39" pos:end="3443:51"><expr pos:start="3443:39" pos:end="3443:51"><name pos:start="3443:39" pos:end="3443:49">new_csr_len</name><operator pos:start="3443:50" pos:end="3443:50">+</operator><literal type="number" pos:start="3443:51" pos:end="3443:51">1</literal></expr></argument>, <argument pos:start="3443:54" pos:end="3443:65"><expr pos:start="3443:54" pos:end="3443:65"><name pos:start="3443:54" pos:end="3443:65">new_csr_data</name></expr></argument>, <argument pos:start="3443:68" pos:end="3443:78"><expr pos:start="3443:68" pos:end="3443:78"><name pos:start="3443:68" pos:end="3443:78">new_csr_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="3444:5" pos:end="3444:45"><expr pos:start="3444:5" pos:end="3444:44"><name pos:start="3444:5" pos:end="3444:40"><name pos:start="3444:5" pos:end="3444:7">ctx</name><operator pos:start="3444:8" pos:end="3444:9">-&gt;</operator><name pos:start="3444:10" pos:end="3444:27">retrieved_csrattrs</name><index pos:start="3444:28" pos:end="3444:40">[<expr pos:start="3444:29" pos:end="3444:39"><name pos:start="3444:29" pos:end="3444:39">new_csr_len</name></expr>]</index></name> <operator pos:start="3444:42" pos:end="3444:42">=</operator> <literal type="number" pos:start="3444:44" pos:end="3444:44">0</literal></expr>;</expr_stmt>
    <expr_stmt pos:start="3445:5" pos:end="3446:42"><expr pos:start="3445:5" pos:end="3446:41"><call pos:start="3445:5" pos:end="3446:41"><name pos:start="3445:5" pos:end="3445:16">EST_LOG_INFO</name><argument_list pos:start="3445:17" pos:end="3446:41">(<argument pos:start="3445:18" pos:end="3445:45"><expr pos:start="3445:18" pos:end="3445:45"><literal type="string" pos:start="3445:18" pos:end="3445:45">"CSR attributes are(%d): %s"</literal></expr></argument>, <argument pos:start="3445:48" pos:end="3445:74"><expr pos:start="3445:48" pos:end="3445:74"><name pos:start="3445:48" pos:end="3445:74"><name pos:start="3445:48" pos:end="3445:50">ctx</name><operator pos:start="3445:51" pos:end="3445:52">-&gt;</operator><name pos:start="3445:53" pos:end="3445:74">retrieved_csrattrs_len</name></name></expr></argument>, 
		 <argument pos:start="3446:18" pos:end="3446:40"><expr pos:start="3446:18" pos:end="3446:40"><name pos:start="3446:18" pos:end="3446:40"><name pos:start="3446:18" pos:end="3446:20">ctx</name><operator pos:start="3446:21" pos:end="3446:22">-&gt;</operator><name pos:start="3446:23" pos:end="3446:40">retrieved_csrattrs</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="3447:5" pos:end="3447:23"><expr pos:start="3447:5" pos:end="3447:22"><call pos:start="3447:5" pos:end="3447:22"><name pos:start="3447:5" pos:end="3447:8">free</name><argument_list pos:start="3447:9" pos:end="3447:22">(<argument pos:start="3447:10" pos:end="3447:21"><expr pos:start="3447:10" pos:end="3447:21"><name pos:start="3447:10" pos:end="3447:21">new_csr_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block" pos:start="3449:5" pos:end="3449:41">/* Now make sure the data is valid */</comment>
    <expr_stmt pos:start="3450:5" pos:end="3451:50"><expr pos:start="3450:5" pos:end="3451:49"><name pos:start="3450:5" pos:end="3450:6">rv</name> <operator pos:start="3450:8" pos:end="3450:8">=</operator> <call pos:start="3450:10" pos:end="3451:49"><name pos:start="3450:10" pos:end="3450:34">est_asn1_parse_attributes</name><argument_list pos:start="3450:35" pos:end="3451:49">(<argument pos:start="3450:36" pos:end="3450:66"><expr pos:start="3450:36" pos:end="3450:66"><operator pos:start="3450:36" pos:end="3450:36">(</operator><name pos:start="3450:37" pos:end="3450:40">char</name> <operator pos:start="3450:42" pos:end="3450:42">*</operator><operator pos:start="3450:43" pos:end="3450:43">)</operator><name pos:start="3450:44" pos:end="3450:66"><name pos:start="3450:44" pos:end="3450:46">ctx</name><operator pos:start="3450:47" pos:end="3450:48">-&gt;</operator><name pos:start="3450:49" pos:end="3450:66">retrieved_csrattrs</name></name></expr></argument>, <argument pos:start="3450:69" pos:end="3450:95"><expr pos:start="3450:69" pos:end="3450:95"><name pos:start="3450:69" pos:end="3450:95"><name pos:start="3450:69" pos:end="3450:71">ctx</name><operator pos:start="3450:72" pos:end="3450:73">-&gt;</operator><name pos:start="3450:74" pos:end="3450:95">retrieved_csrattrs_len</name></name></expr></argument>,
				   <argument pos:start="3451:36" pos:end="3451:48"><expr pos:start="3451:36" pos:end="3451:48"><operator pos:start="3451:36" pos:end="3451:36">&amp;</operator><name pos:start="3451:37" pos:end="3451:48">pop_required</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="3452:5" pos:end="3459:5"><if pos:start="3452:5" pos:end="3456:5">if <condition pos:start="3452:8" pos:end="3452:27">(<expr pos:start="3452:9" pos:end="3452:26"><name pos:start="3452:9" pos:end="3452:10">rv</name> <operator pos:start="3452:12" pos:end="3452:13">!=</operator> <name pos:start="3452:15" pos:end="3452:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="3452:29" pos:end="3456:5">{<block_content pos:start="3453:9" pos:end="3455:40">
	<expr_stmt pos:start="3453:9" pos:end="3453:38"><expr pos:start="3453:9" pos:end="3453:37"><call pos:start="3453:9" pos:end="3453:37"><name pos:start="3453:9" pos:end="3453:12">free</name><argument_list pos:start="3453:13" pos:end="3453:37">(<argument pos:start="3453:14" pos:end="3453:36"><expr pos:start="3453:14" pos:end="3453:36"><name pos:start="3453:14" pos:end="3453:36"><name pos:start="3453:14" pos:end="3453:16">ctx</name><operator pos:start="3453:17" pos:end="3453:18">-&gt;</operator><name pos:start="3453:19" pos:end="3453:36">retrieved_csrattrs</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="3454:9" pos:end="3454:39"><expr pos:start="3454:9" pos:end="3454:38"><name pos:start="3454:9" pos:end="3454:31"><name pos:start="3454:9" pos:end="3454:11">ctx</name><operator pos:start="3454:12" pos:end="3454:13">-&gt;</operator><name pos:start="3454:14" pos:end="3454:31">retrieved_csrattrs</name></name> <operator pos:start="3454:33" pos:end="3454:33">=</operator> <name pos:start="3454:35" pos:end="3454:38">NULL</name></expr>;</expr_stmt>
        <expr_stmt pos:start="3455:9" pos:end="3455:40"><expr pos:start="3455:9" pos:end="3455:39"><name pos:start="3455:9" pos:end="3455:35"><name pos:start="3455:9" pos:end="3455:11">ctx</name><operator pos:start="3455:12" pos:end="3455:13">-&gt;</operator><name pos:start="3455:14" pos:end="3455:35">retrieved_csrattrs_len</name></name> <operator pos:start="3455:37" pos:end="3455:37">=</operator> <literal type="number" pos:start="3455:39" pos:end="3455:39">0</literal></expr>;</expr_stmt>
    </block_content>}</block></if> <else pos:start="3456:7" pos:end="3459:5">else <block pos:start="3456:12" pos:end="3459:5">{<block_content pos:start="3457:9" pos:end="3458:47">
        <expr_stmt pos:start="3457:9" pos:end="3457:44"><expr pos:start="3457:9" pos:end="3457:43"><operator pos:start="3457:9" pos:end="3457:9">*</operator><name pos:start="3457:10" pos:end="3457:17">csr_data</name> <operator pos:start="3457:19" pos:end="3457:19">=</operator> <name pos:start="3457:21" pos:end="3457:43"><name pos:start="3457:21" pos:end="3457:23">ctx</name><operator pos:start="3457:24" pos:end="3457:25">-&gt;</operator><name pos:start="3457:26" pos:end="3457:43">retrieved_csrattrs</name></name></expr>;</expr_stmt>
        <expr_stmt pos:start="3458:9" pos:end="3458:47"><expr pos:start="3458:9" pos:end="3458:46"><operator pos:start="3458:9" pos:end="3458:9">*</operator><name pos:start="3458:10" pos:end="3458:16">csr_len</name> <operator pos:start="3458:18" pos:end="3458:18">=</operator> <name pos:start="3458:20" pos:end="3458:46"><name pos:start="3458:20" pos:end="3458:22">ctx</name><operator pos:start="3458:23" pos:end="3458:24">-&gt;</operator><name pos:start="3458:25" pos:end="3458:46">retrieved_csrattrs_len</name></name></expr>;</expr_stmt>
    </block_content>}</block></else></if_stmt>
    <expr_stmt pos:start="3460:5" pos:end="3460:41"><expr pos:start="3460:5" pos:end="3460:40"><name pos:start="3460:5" pos:end="3460:25"><name pos:start="3460:5" pos:end="3460:7">ctx</name><operator pos:start="3460:8" pos:end="3460:9">-&gt;</operator><name pos:start="3460:10" pos:end="3460:25">csr_pop_required</name></name> <operator pos:start="3460:27" pos:end="3460:27">=</operator> <name pos:start="3460:29" pos:end="3460:40">pop_required</name></expr>;</expr_stmt>
    
    <return pos:start="3462:5" pos:end="3462:16">return <expr pos:start="3462:12" pos:end="3462:15"><operator pos:start="3462:12" pos:end="3462:12">(</operator><name pos:start="3462:13" pos:end="3462:14">rv</name><operator pos:start="3462:15" pos:end="3462:15">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="3464:1" pos:end="3489:2">/*! @brief est_client_enable_srp() is used by an application to enable
    TLS-SRP as the transport, which is used in place of traditional
    TLS.  TLS-SRP allows for secure transport when an X.509 certificate
    is not available or when a trust anchor is not available.
 
    @param ctx EST context obtained from the est_client_init() call.
    @param strength Specifies the SRP strength to use.
    @param uid char buffer containing the user id to be used as the
    SRP user name. 
    @param pwd char buffer containing the passowrd to be used as the
    SRP password.

    This function allows an application to enable TLS-SRP cipher suites,
    which is another form for TLS.  This could be used when the EST client
    does not have an X.509 certificate to identify itself to the EST
    server.  It can also be used by the EST client when a trust anchor
    is not available to authenticate the EST server identity.  
    The EST server must support TLS-SRP when using this API. 

    This function must be invoked after est_client_init() and prior to 
    issuing any EST commands..

    All string parameters are NULL terminated strings.
    
    @return EST_ERROR.  
*/</comment>
<function pos:start="3490:1" pos:end="3561:1"><type pos:start="3490:1" pos:end="3490:9"><name pos:start="3490:1" pos:end="3490:9">EST_ERROR</name></type> <name pos:start="3490:11" pos:end="3490:31">est_client_enable_srp</name> <parameter_list pos:start="3490:33" pos:end="3490:82">(<parameter pos:start="3490:34" pos:end="3490:45"><decl pos:start="3490:34" pos:end="3490:45"><type pos:start="3490:34" pos:end="3490:45"><name pos:start="3490:34" pos:end="3490:40">EST_CTX</name> <modifier pos:start="3490:42" pos:end="3490:42">*</modifier></type><name pos:start="3490:43" pos:end="3490:45">ctx</name></decl></parameter>, <parameter pos:start="3490:48" pos:end="3490:59"><decl pos:start="3490:48" pos:end="3490:59"><type pos:start="3490:48" pos:end="3490:59"><name pos:start="3490:48" pos:end="3490:50">int</name></type> <name pos:start="3490:52" pos:end="3490:59">strength</name></decl></parameter>, <parameter pos:start="3490:62" pos:end="3490:70"><decl pos:start="3490:62" pos:end="3490:70"><type pos:start="3490:62" pos:end="3490:70"><name pos:start="3490:62" pos:end="3490:65">char</name> <modifier pos:start="3490:67" pos:end="3490:67">*</modifier></type><name pos:start="3490:68" pos:end="3490:70">uid</name></decl></parameter>, <parameter pos:start="3490:73" pos:end="3490:81"><decl pos:start="3490:73" pos:end="3490:81"><type pos:start="3490:73" pos:end="3490:81"><name pos:start="3490:73" pos:end="3490:76">char</name> <modifier pos:start="3490:78" pos:end="3490:78">*</modifier></type><name pos:start="3490:79" pos:end="3490:81">pwd</name></decl></parameter>)</parameter_list> 
<block pos:start="3491:1" pos:end="3561:1">{<block_content pos:start="3492:5" pos:end="3560:26">
    <decl_stmt pos:start="3492:5" pos:end="3492:22"><decl pos:start="3492:5" pos:end="3492:21"><type pos:start="3492:5" pos:end="3492:16"><name pos:start="3492:5" pos:end="3492:14">X509_STORE</name> <modifier pos:start="3492:16" pos:end="3492:16">*</modifier></type><name pos:start="3492:17" pos:end="3492:21">store</name></decl>;</decl_stmt>
    <decl_stmt pos:start="3493:5" pos:end="3493:11"><decl pos:start="3493:5" pos:end="3493:10"><type pos:start="3493:5" pos:end="3493:7"><name pos:start="3493:5" pos:end="3493:7">int</name></type> <name pos:start="3493:9" pos:end="3493:10">rv</name></decl>;</decl_stmt>

    <if_stmt pos:start="3495:5" pos:end="3498:5"><if pos:start="3495:5" pos:end="3498:5">if <condition pos:start="3495:8" pos:end="3495:20">(<expr pos:start="3495:9" pos:end="3495:19"><name pos:start="3495:9" pos:end="3495:11">ctx</name> <operator pos:start="3495:13" pos:end="3495:14">==</operator> <name pos:start="3495:16" pos:end="3495:19">NULL</name></expr>)</condition> <block pos:start="3495:22" pos:end="3498:5">{<block_content pos:start="3496:9" pos:end="3497:32">
	<expr_stmt pos:start="3496:9" pos:end="3496:43"><expr pos:start="3496:9" pos:end="3496:42"><call pos:start="3496:9" pos:end="3496:42"><name pos:start="3496:9" pos:end="3496:19">EST_LOG_ERR</name><argument_list pos:start="3496:20" pos:end="3496:42">(<argument pos:start="3496:21" pos:end="3496:41"><expr pos:start="3496:21" pos:end="3496:41"><literal type="string" pos:start="3496:21" pos:end="3496:41">"Null context passed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3497:9" pos:end="3497:32">return <expr pos:start="3497:16" pos:end="3497:31"><operator pos:start="3497:16" pos:end="3497:16">(</operator><name pos:start="3497:17" pos:end="3497:30">EST_ERR_NO_CTX</name><operator pos:start="3497:31" pos:end="3497:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>    

    <if_stmt pos:start="3500:5" pos:end="3503:5"><if pos:start="3500:5" pos:end="3503:5">if <condition pos:start="3500:8" pos:end="3500:29">(<expr pos:start="3500:9" pos:end="3500:28"><name pos:start="3500:9" pos:end="3500:20"><name pos:start="3500:9" pos:end="3500:11">ctx</name><operator pos:start="3500:12" pos:end="3500:13">-&gt;</operator><name pos:start="3500:14" pos:end="3500:20">ssl_ctx</name></name> <operator pos:start="3500:22" pos:end="3500:23">==</operator> <name pos:start="3500:25" pos:end="3500:28">NULL</name></expr>)</condition> <block pos:start="3500:31" pos:end="3503:5">{<block_content pos:start="3501:9" pos:end="3502:36">
	<expr_stmt pos:start="3501:9" pos:end="3501:60"><expr pos:start="3501:9" pos:end="3501:59"><call pos:start="3501:9" pos:end="3501:59"><name pos:start="3501:9" pos:end="3501:19">EST_LOG_ERR</name><argument_list pos:start="3501:20" pos:end="3501:59">(<argument pos:start="3501:21" pos:end="3501:58"><expr pos:start="3501:21" pos:end="3501:58"><literal type="string" pos:start="3501:21" pos:end="3501:58">"SSL context has not been initialized"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3502:9" pos:end="3502:36">return <expr pos:start="3502:16" pos:end="3502:35"><operator pos:start="3502:16" pos:end="3502:16">(</operator><name pos:start="3502:17" pos:end="3502:34">EST_ERR_NO_SSL_CTX</name><operator pos:start="3502:35" pos:end="3502:35">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
    
    <if_stmt pos:start="3505:5" pos:end="3508:5"><if pos:start="3505:5" pos:end="3508:5">if <condition pos:start="3505:8" pos:end="3505:40">(<expr pos:start="3505:9" pos:end="3505:39"><name pos:start="3505:9" pos:end="3505:16">strength</name> <operator pos:start="3505:18" pos:end="3505:18">&lt;</operator> <name pos:start="3505:20" pos:end="3505:39">EST_SRP_STRENGTH_MIN</name></expr>)</condition> <block pos:start="3505:42" pos:end="3508:5">{<block_content pos:start="3506:9" pos:end="3507:42">
	<expr_stmt pos:start="3506:9" pos:end="3506:82"><expr pos:start="3506:9" pos:end="3506:81"><call pos:start="3506:9" pos:end="3506:81"><name pos:start="3506:9" pos:end="3506:19">EST_LOG_ERR</name><argument_list pos:start="3506:20" pos:end="3506:81">(<argument pos:start="3506:21" pos:end="3506:58"><expr pos:start="3506:21" pos:end="3506:58"><literal type="string" pos:start="3506:21" pos:end="3506:58">"SRP strength must be greater than %d"</literal></expr></argument>, <argument pos:start="3506:61" pos:end="3506:80"><expr pos:start="3506:61" pos:end="3506:80"><name pos:start="3506:61" pos:end="3506:80">EST_SRP_STRENGTH_MIN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3507:9" pos:end="3507:42">return <expr pos:start="3507:16" pos:end="3507:41"><operator pos:start="3507:16" pos:end="3507:16">(</operator><name pos:start="3507:17" pos:end="3507:40">EST_ERR_SRP_STRENGTH_LOW</name><operator pos:start="3507:41" pos:end="3507:41">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3510:5" pos:end="3513:5"><if pos:start="3510:5" pos:end="3513:5">if <condition pos:start="3510:8" pos:end="3510:20">(<expr pos:start="3510:9" pos:end="3510:19"><name pos:start="3510:9" pos:end="3510:11">uid</name> <operator pos:start="3510:13" pos:end="3510:14">==</operator> <name pos:start="3510:16" pos:end="3510:19">NULL</name></expr>)</condition> <block pos:start="3510:22" pos:end="3513:5">{<block_content pos:start="3511:9" pos:end="3512:44">
	<expr_stmt pos:start="3511:9" pos:end="3511:52"><expr pos:start="3511:9" pos:end="3511:51"><call pos:start="3511:9" pos:end="3511:51"><name pos:start="3511:9" pos:end="3511:19">EST_LOG_ERR</name><argument_list pos:start="3511:20" pos:end="3511:51">(<argument pos:start="3511:21" pos:end="3511:50"><expr pos:start="3511:21" pos:end="3511:50"><literal type="string" pos:start="3511:21" pos:end="3511:50">"SRP user ID must be provided"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return pos:start="3512:9" pos:end="3512:44">return <expr pos:start="3512:16" pos:end="3512:43"><operator pos:start="3512:16" pos:end="3512:16">(</operator><name pos:start="3512:17" pos:end="3512:42">EST_ERR_INVALID_PARAMETERS</name><operator pos:start="3512:43" pos:end="3512:43">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3515:5" pos:end="3518:5"><if pos:start="3515:5" pos:end="3518:5">if <condition pos:start="3515:8" pos:end="3515:20">(<expr pos:start="3515:9" pos:end="3515:19"><name pos:start="3515:9" pos:end="3515:11">pwd</name> <operator pos:start="3515:13" pos:end="3515:14">==</operator> <name pos:start="3515:16" pos:end="3515:19">NULL</name></expr>)</condition> <block pos:start="3515:22" pos:end="3518:5">{<block_content pos:start="3516:9" pos:end="3517:44">
	<expr_stmt pos:start="3516:9" pos:end="3516:53"><expr pos:start="3516:9" pos:end="3516:52"><call pos:start="3516:9" pos:end="3516:52"><name pos:start="3516:9" pos:end="3516:19">EST_LOG_ERR</name><argument_list pos:start="3516:20" pos:end="3516:52">(<argument pos:start="3516:21" pos:end="3516:51"><expr pos:start="3516:21" pos:end="3516:51"><literal type="string" pos:start="3516:21" pos:end="3516:51">"SRP password must be provided"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return pos:start="3517:9" pos:end="3517:44">return <expr pos:start="3517:16" pos:end="3517:43"><operator pos:start="3517:16" pos:end="3517:16">(</operator><name pos:start="3517:17" pos:end="3517:42">EST_ERR_INVALID_PARAMETERS</name><operator pos:start="3517:43" pos:end="3517:43">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="3520:5" pos:end="3520:24"><expr pos:start="3520:5" pos:end="3520:23"><name pos:start="3520:5" pos:end="3520:19"><name pos:start="3520:5" pos:end="3520:7">ctx</name><operator pos:start="3520:8" pos:end="3520:9">-&gt;</operator><name pos:start="3520:10" pos:end="3520:19">enable_srp</name></name> <operator pos:start="3520:21" pos:end="3520:21">=</operator> <literal type="number" pos:start="3520:23" pos:end="3520:23">1</literal></expr>;</expr_stmt>

    <comment type="block" pos:start="3522:5" pos:end="3528:7">/*
     * Enable just the SRP cipher suites.  When SRP is enabled,
     * it's used exclusively.
     *
     * Check if we have a trust anchor configured.  We will
     * enable the DSS and RSA auth cipher suites if we do.
     */</comment>
    <expr_stmt pos:start="3529:5" pos:end="3529:49"><expr pos:start="3529:5" pos:end="3529:48"><name pos:start="3529:5" pos:end="3529:9">store</name> <operator pos:start="3529:11" pos:end="3529:11">=</operator> <call pos:start="3529:13" pos:end="3529:48"><name pos:start="3529:13" pos:end="3529:34">SSL_CTX_get_cert_store</name><argument_list pos:start="3529:35" pos:end="3529:48">(<argument pos:start="3529:36" pos:end="3529:47"><expr pos:start="3529:36" pos:end="3529:47"><name pos:start="3529:36" pos:end="3529:47"><name pos:start="3529:36" pos:end="3529:38">ctx</name><operator pos:start="3529:39" pos:end="3529:40">-&gt;</operator><name pos:start="3529:41" pos:end="3529:47">ssl_ctx</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="3530:5" pos:end="3536:5"><if pos:start="3530:5" pos:end="3533:5">if <condition pos:start="3530:8" pos:end="3530:68">(<expr pos:start="3530:9" pos:end="3530:67"><name pos:start="3530:9" pos:end="3530:13">store</name> <operator pos:start="3530:15" pos:end="3530:16">&amp;&amp;</operator> <name pos:start="3530:18" pos:end="3530:28"><name pos:start="3530:18" pos:end="3530:22">store</name><operator pos:start="3530:23" pos:end="3530:24">-&gt;</operator><name pos:start="3530:25" pos:end="3530:28">objs</name></name> <operator pos:start="3530:30" pos:end="3530:31">&amp;&amp;</operator> <call pos:start="3530:33" pos:end="3530:63"><name pos:start="3530:33" pos:end="3530:50">sk_X509_OBJECT_num</name><argument_list pos:start="3530:51" pos:end="3530:63">(<argument pos:start="3530:52" pos:end="3530:62"><expr pos:start="3530:52" pos:end="3530:62"><name pos:start="3530:52" pos:end="3530:62"><name pos:start="3530:52" pos:end="3530:56">store</name><operator pos:start="3530:57" pos:end="3530:58">-&gt;</operator><name pos:start="3530:59" pos:end="3530:62">objs</name></name></expr></argument>)</argument_list></call> <operator pos:start="3530:65" pos:end="3530:65">&gt;</operator> <literal type="number" pos:start="3530:67" pos:end="3530:67">0</literal></expr>)</condition> <block pos:start="3530:70" pos:end="3533:5">{<block_content pos:start="3531:9" pos:end="3532:77">
	<expr_stmt pos:start="3531:9" pos:end="3531:68"><expr pos:start="3531:9" pos:end="3531:67"><call pos:start="3531:9" pos:end="3531:67"><name pos:start="3531:9" pos:end="3531:20">EST_LOG_INFO</name><argument_list pos:start="3531:21" pos:end="3531:67">(<argument pos:start="3531:22" pos:end="3531:66"><expr pos:start="3531:22" pos:end="3531:66"><literal type="string" pos:start="3531:22" pos:end="3531:66">"Enable SSL SRP cipher suites with RSA/DSS\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="3532:9" pos:end="3532:77"><expr pos:start="3532:9" pos:end="3532:76"><name pos:start="3532:9" pos:end="3532:10">rv</name> <operator pos:start="3532:12" pos:end="3532:12">=</operator> <call pos:start="3532:14" pos:end="3532:76"><name pos:start="3532:14" pos:end="3532:36">SSL_CTX_set_cipher_list</name><argument_list pos:start="3532:37" pos:end="3532:76">(<argument pos:start="3532:38" pos:end="3532:49"><expr pos:start="3532:38" pos:end="3532:49"><name pos:start="3532:38" pos:end="3532:49"><name pos:start="3532:38" pos:end="3532:40">ctx</name><operator pos:start="3532:41" pos:end="3532:42">-&gt;</operator><name pos:start="3532:43" pos:end="3532:49">ssl_ctx</name></name></expr></argument>, <argument pos:start="3532:52" pos:end="3532:75"><expr pos:start="3532:52" pos:end="3532:75"><name pos:start="3532:52" pos:end="3532:75">EST_CIPHER_LIST_SRP_AUTH</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></if> <else pos:start="3533:7" pos:end="3536:5">else <block pos:start="3533:12" pos:end="3536:5">{<block_content pos:start="3534:9" pos:end="3535:77">
	<expr_stmt pos:start="3534:9" pos:end="3534:67"><expr pos:start="3534:9" pos:end="3534:66"><call pos:start="3534:9" pos:end="3534:66"><name pos:start="3534:9" pos:end="3534:20">EST_LOG_INFO</name><argument_list pos:start="3534:21" pos:end="3534:66">(<argument pos:start="3534:22" pos:end="3534:65"><expr pos:start="3534:22" pos:end="3534:65"><literal type="string" pos:start="3534:22" pos:end="3534:65">"Enable SSL SRP cipher suites w/o RSA/DSS\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="3535:9" pos:end="3535:77"><expr pos:start="3535:9" pos:end="3535:76"><name pos:start="3535:9" pos:end="3535:10">rv</name> <operator pos:start="3535:12" pos:end="3535:12">=</operator> <call pos:start="3535:14" pos:end="3535:76"><name pos:start="3535:14" pos:end="3535:36">SSL_CTX_set_cipher_list</name><argument_list pos:start="3535:37" pos:end="3535:76">(<argument pos:start="3535:38" pos:end="3535:49"><expr pos:start="3535:38" pos:end="3535:49"><name pos:start="3535:38" pos:end="3535:49"><name pos:start="3535:38" pos:end="3535:40">ctx</name><operator pos:start="3535:41" pos:end="3535:42">-&gt;</operator><name pos:start="3535:43" pos:end="3535:49">ssl_ctx</name></name></expr></argument>, <argument pos:start="3535:52" pos:end="3535:75"><expr pos:start="3535:52" pos:end="3535:75"><name pos:start="3535:52" pos:end="3535:75">EST_CIPHER_LIST_SRP_ONLY</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></else></if_stmt>
    <if_stmt pos:start="3537:5" pos:end="3541:5"><if pos:start="3537:5" pos:end="3541:5">if <condition pos:start="3537:8" pos:end="3537:12">(<expr pos:start="3537:9" pos:end="3537:11"><operator pos:start="3537:9" pos:end="3537:9">!</operator><name pos:start="3537:10" pos:end="3537:11">rv</name></expr>)</condition> <block pos:start="3537:14" pos:end="3541:5">{<block_content pos:start="3538:9" pos:end="3540:39"> 
	<expr_stmt pos:start="3538:9" pos:end="3538:61"><expr pos:start="3538:9" pos:end="3538:60"><call pos:start="3538:9" pos:end="3538:60"><name pos:start="3538:9" pos:end="3538:19">EST_LOG_ERR</name><argument_list pos:start="3538:20" pos:end="3538:60">(<argument pos:start="3538:21" pos:end="3538:59"><expr pos:start="3538:21" pos:end="3538:59"><literal type="string" pos:start="3538:21" pos:end="3538:59">"Failed to set SSL SRP cipher suites\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt pos:start="3539:9" pos:end="3539:31"><expr pos:start="3539:9" pos:end="3539:30"><call pos:start="3539:9" pos:end="3539:30"><name pos:start="3539:9" pos:end="3539:28">ossl_dump_ssl_errors</name><argument_list pos:start="3539:29" pos:end="3539:30">()</argument_list></call></expr>;</expr_stmt>
	<return pos:start="3540:9" pos:end="3540:39">return <expr pos:start="3540:16" pos:end="3540:38"><name pos:start="3540:16" pos:end="3540:38">EST_ERR_SSL_CIPHER_LIST</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
	
    <comment type="block" pos:start="3543:5" pos:end="3545:7">/* 
     * Set the SRP user name and password.  
     */</comment>
    <if_stmt pos:start="3546:5" pos:end="3550:5"><if pos:start="3546:5" pos:end="3550:5">if <condition pos:start="3546:8" pos:end="3546:53">(<expr pos:start="3546:9" pos:end="3546:52"><operator pos:start="3546:9" pos:end="3546:9">!</operator><call pos:start="3546:10" pos:end="3546:52"><name pos:start="3546:10" pos:end="3546:33">SSL_CTX_set_srp_username</name><argument_list pos:start="3546:34" pos:end="3546:52">(<argument pos:start="3546:35" pos:end="3546:46"><expr pos:start="3546:35" pos:end="3546:46"><name pos:start="3546:35" pos:end="3546:46"><name pos:start="3546:35" pos:end="3546:37">ctx</name><operator pos:start="3546:38" pos:end="3546:39">-&gt;</operator><name pos:start="3546:40" pos:end="3546:46">ssl_ctx</name></name></expr></argument>, <argument pos:start="3546:49" pos:end="3546:51"><expr pos:start="3546:49" pos:end="3546:51"><name pos:start="3546:49" pos:end="3546:51">uid</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="3546:55" pos:end="3550:5">{<block_content pos:start="3547:9" pos:end="3549:31">
	<expr_stmt pos:start="3547:9" pos:end="3547:52"><expr pos:start="3547:9" pos:end="3547:51"><call pos:start="3547:9" pos:end="3547:51"><name pos:start="3547:9" pos:end="3547:19">EST_LOG_ERR</name><argument_list pos:start="3547:20" pos:end="3547:51">(<argument pos:start="3547:21" pos:end="3547:50"><expr pos:start="3547:21" pos:end="3547:50"><literal type="string" pos:start="3547:21" pos:end="3547:50">"Unable to set SRP username\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt pos:start="3548:9" pos:end="3548:31"><expr pos:start="3548:9" pos:end="3548:30"><call pos:start="3548:9" pos:end="3548:30"><name pos:start="3548:9" pos:end="3548:28">ossl_dump_ssl_errors</name><argument_list pos:start="3548:29" pos:end="3548:30">()</argument_list></call></expr>;</expr_stmt>
	<return pos:start="3549:9" pos:end="3549:31">return <expr pos:start="3549:16" pos:end="3549:30"><name pos:start="3549:16" pos:end="3549:30">EST_ERR_UNKNOWN</name></expr>;</return> 
    </block_content>}</block></if></if_stmt>
    <if_stmt pos:start="3551:5" pos:end="3555:5"><if pos:start="3551:5" pos:end="3555:5">if <condition pos:start="3551:8" pos:end="3551:53">(<expr pos:start="3551:9" pos:end="3551:52"><operator pos:start="3551:9" pos:end="3551:9">!</operator><call pos:start="3551:10" pos:end="3551:52"><name pos:start="3551:10" pos:end="3551:33">SSL_CTX_set_srp_password</name><argument_list pos:start="3551:34" pos:end="3551:52">(<argument pos:start="3551:35" pos:end="3551:46"><expr pos:start="3551:35" pos:end="3551:46"><name pos:start="3551:35" pos:end="3551:46"><name pos:start="3551:35" pos:end="3551:37">ctx</name><operator pos:start="3551:38" pos:end="3551:39">-&gt;</operator><name pos:start="3551:40" pos:end="3551:46">ssl_ctx</name></name></expr></argument>, <argument pos:start="3551:49" pos:end="3551:51"><expr pos:start="3551:49" pos:end="3551:51"><name pos:start="3551:49" pos:end="3551:51">pwd</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="3551:55" pos:end="3555:5">{<block_content pos:start="3552:9" pos:end="3554:31">
	<expr_stmt pos:start="3552:9" pos:end="3552:52"><expr pos:start="3552:9" pos:end="3552:51"><call pos:start="3552:9" pos:end="3552:51"><name pos:start="3552:9" pos:end="3552:19">EST_LOG_ERR</name><argument_list pos:start="3552:20" pos:end="3552:51">(<argument pos:start="3552:21" pos:end="3552:50"><expr pos:start="3552:21" pos:end="3552:50"><literal type="string" pos:start="3552:21" pos:end="3552:50">"Unable to set SRP password\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt pos:start="3553:9" pos:end="3553:31"><expr pos:start="3553:9" pos:end="3553:30"><call pos:start="3553:9" pos:end="3553:30"><name pos:start="3553:9" pos:end="3553:28">ossl_dump_ssl_errors</name><argument_list pos:start="3553:29" pos:end="3553:30">()</argument_list></call></expr>;</expr_stmt>
	<return pos:start="3554:9" pos:end="3554:31">return <expr pos:start="3554:16" pos:end="3554:30"><name pos:start="3554:16" pos:end="3554:30">EST_ERR_UNKNOWN</name></expr>;</return> 
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="3556:5" pos:end="3556:53"><expr pos:start="3556:5" pos:end="3556:52"><call pos:start="3556:5" pos:end="3556:52"><name pos:start="3556:5" pos:end="3556:28">SSL_CTX_set_srp_strength</name><argument_list pos:start="3556:29" pos:end="3556:52">(<argument pos:start="3556:30" pos:end="3556:41"><expr pos:start="3556:30" pos:end="3556:41"><name pos:start="3556:30" pos:end="3556:41"><name pos:start="3556:30" pos:end="3556:32">ctx</name><operator pos:start="3556:33" pos:end="3556:34">-&gt;</operator><name pos:start="3556:35" pos:end="3556:41">ssl_ctx</name></name></expr></argument>, <argument pos:start="3556:44" pos:end="3556:51"><expr pos:start="3556:44" pos:end="3556:51"><name pos:start="3556:44" pos:end="3556:51">strength</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <expr_stmt pos:start="3558:5" pos:end="3558:36"><expr pos:start="3558:5" pos:end="3558:35"><call pos:start="3558:5" pos:end="3558:35"><name pos:start="3558:5" pos:end="3558:16">EST_LOG_INFO</name><argument_list pos:start="3558:17" pos:end="3558:35">(<argument pos:start="3558:18" pos:end="3558:34"><expr pos:start="3558:18" pos:end="3558:34"><literal type="string" pos:start="3558:18" pos:end="3558:34">"TLS-SRP enabled"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <return pos:start="3560:5" pos:end="3560:26">return <expr pos:start="3560:12" pos:end="3560:25"><operator pos:start="3560:12" pos:end="3560:12">(</operator><name pos:start="3560:13" pos:end="3560:24">EST_ERR_NONE</name><operator pos:start="3560:25" pos:end="3560:25">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="3562:1" pos:end="3589:2">/*! @brief est_client_set_auth() is used by an application to set up the
    authentication parameters to be used.
 
    @param ctx EST context obtained from the est_client_init() call.
    @param uid char buffer containing the user id to be used for basic
    and digest based authentication
    @param pwd char buffer containing the passowrd to be used for basic
    and digest based authentication
    @param client_cert_raw char buffer containing the client application
    certificate.
    @param pkey_raw Private key that can be used with the client cert
    @param pkey_len Length of buffer holding the private key

    This function allows an application to provide the information required
    for authenticating the EST client with the EST server.  Until this call is
    made, the only accepted request is the GET CA Certs.  If the user id is
    provided, a password must also be provided.

    The application may pass the private key (pkey_raw/pkey_len) to be used
    for signing requests to the server, otherwise, only basic or digest based
    authentication will be performed on the TLS session for these requests.
    If the private key is passed, it must contain the private key that matches
    the public key contained in the client_cert parameter.

    All string parameters are NULL terminated strings.
    
    @return EST_ERROR.  If error, NULL.
*/</comment>
<function pos:start="3590:1" pos:end="3627:1"><type pos:start="3590:1" pos:end="3590:9"><name pos:start="3590:1" pos:end="3590:9">EST_ERROR</name></type> <name pos:start="3590:11" pos:end="3590:29">est_client_set_auth</name> <parameter_list pos:start="3590:31" pos:end="3591:72">(<parameter pos:start="3590:32" pos:end="3590:43"><decl pos:start="3590:32" pos:end="3590:43"><type pos:start="3590:32" pos:end="3590:43"><name pos:start="3590:32" pos:end="3590:38">EST_CTX</name> <modifier pos:start="3590:40" pos:end="3590:40">*</modifier></type><name pos:start="3590:41" pos:end="3590:43">ctx</name></decl></parameter>, <parameter pos:start="3590:46" pos:end="3590:60"><decl pos:start="3590:46" pos:end="3590:60"><type pos:start="3590:46" pos:end="3590:60"><specifier pos:start="3590:46" pos:end="3590:50">const</specifier> <name pos:start="3590:52" pos:end="3590:55">char</name> <modifier pos:start="3590:57" pos:end="3590:57">*</modifier></type><name pos:start="3590:58" pos:end="3590:60">uid</name></decl></parameter>, <parameter pos:start="3590:63" pos:end="3590:77"><decl pos:start="3590:63" pos:end="3590:77"><type pos:start="3590:63" pos:end="3590:77"><specifier pos:start="3590:63" pos:end="3590:67">const</specifier> <name pos:start="3590:69" pos:end="3590:72">char</name> <modifier pos:start="3590:74" pos:end="3590:74">*</modifier></type><name pos:start="3590:75" pos:end="3590:77">pwd</name></decl></parameter>,
                               <parameter pos:start="3591:32" pos:end="3591:48"><decl pos:start="3591:32" pos:end="3591:48"><type pos:start="3591:32" pos:end="3591:48"><name pos:start="3591:32" pos:end="3591:35">X509</name> <modifier pos:start="3591:37" pos:end="3591:37">*</modifier></type><name pos:start="3591:38" pos:end="3591:48">client_cert</name></decl></parameter>, <parameter pos:start="3591:51" pos:end="3591:71"><decl pos:start="3591:51" pos:end="3591:71"><type pos:start="3591:51" pos:end="3591:71"><name pos:start="3591:51" pos:end="3591:58">EVP_PKEY</name> <modifier pos:start="3591:60" pos:end="3591:60">*</modifier></type><name pos:start="3591:61" pos:end="3591:71">private_key</name></decl></parameter>)</parameter_list>
<block pos:start="3592:1" pos:end="3627:1">{<block_content pos:start="3593:5" pos:end="3626:24">
    <decl_stmt pos:start="3593:5" pos:end="3593:32"><decl pos:start="3593:5" pos:end="3593:31"><type pos:start="3593:5" pos:end="3593:13"><name pos:start="3593:5" pos:end="3593:13">EST_ERROR</name></type> <name pos:start="3593:15" pos:end="3593:16">rv</name> <init pos:start="3593:18" pos:end="3593:31">= <expr pos:start="3593:20" pos:end="3593:31"><name pos:start="3593:20" pos:end="3593:31">EST_ERR_NONE</name></expr></init></decl>;</decl_stmt>
    
    <if_stmt pos:start="3595:5" pos:end="3598:5"><if pos:start="3595:5" pos:end="3598:5">if <condition pos:start="3595:8" pos:end="3595:20">(<expr pos:start="3595:9" pos:end="3595:19"><name pos:start="3595:9" pos:end="3595:11">ctx</name> <operator pos:start="3595:13" pos:end="3595:14">==</operator> <name pos:start="3595:16" pos:end="3595:19">NULL</name></expr>)</condition> <block pos:start="3595:22" pos:end="3598:5">{<block_content pos:start="3596:9" pos:end="3597:32">
	<expr_stmt pos:start="3596:9" pos:end="3596:43"><expr pos:start="3596:9" pos:end="3596:42"><call pos:start="3596:9" pos:end="3596:42"><name pos:start="3596:9" pos:end="3596:19">EST_LOG_ERR</name><argument_list pos:start="3596:20" pos:end="3596:42">(<argument pos:start="3596:21" pos:end="3596:41"><expr pos:start="3596:21" pos:end="3596:41"><literal type="string" pos:start="3596:21" pos:end="3596:41">"Null context passed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3597:9" pos:end="3597:32">return <expr pos:start="3597:16" pos:end="3597:31"><operator pos:start="3597:16" pos:end="3597:16">(</operator><name pos:start="3597:17" pos:end="3597:30">EST_ERR_NO_CTX</name><operator pos:start="3597:31" pos:end="3597:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>    

    <expr_stmt pos:start="3600:5" pos:end="3600:46"><expr pos:start="3600:5" pos:end="3600:45"><name pos:start="3600:5" pos:end="3600:6">rv</name> <operator pos:start="3600:8" pos:end="3600:8">=</operator> <call pos:start="3600:10" pos:end="3600:45"><name pos:start="3600:10" pos:end="3600:30">est_client_set_uid_pw</name><argument_list pos:start="3600:31" pos:end="3600:45">(<argument pos:start="3600:32" pos:end="3600:34"><expr pos:start="3600:32" pos:end="3600:34"><name pos:start="3600:32" pos:end="3600:34">ctx</name></expr></argument>, <argument pos:start="3600:37" pos:end="3600:39"><expr pos:start="3600:37" pos:end="3600:39"><name pos:start="3600:37" pos:end="3600:39">uid</name></expr></argument>, <argument pos:start="3600:42" pos:end="3600:44"><expr pos:start="3600:42" pos:end="3600:44"><name pos:start="3600:42" pos:end="3600:44">pwd</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="3601:5" pos:end="3603:5"><if pos:start="3601:5" pos:end="3603:5">if <condition pos:start="3601:8" pos:end="3601:27">(<expr pos:start="3601:9" pos:end="3601:26"><name pos:start="3601:9" pos:end="3601:10">rv</name> <operator pos:start="3601:12" pos:end="3601:13">!=</operator> <name pos:start="3601:15" pos:end="3601:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="3601:29" pos:end="3603:5">{<block_content pos:start="3602:9" pos:end="3602:20">
        <return pos:start="3602:9" pos:end="3602:20">return <expr pos:start="3602:16" pos:end="3602:19"><operator pos:start="3602:16" pos:end="3602:16">(</operator><name pos:start="3602:17" pos:end="3602:18">rv</name><operator pos:start="3602:19" pos:end="3602:19">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>            

    <expr_stmt pos:start="3605:5" pos:end="3605:31"><expr pos:start="3605:5" pos:end="3605:30"><name pos:start="3605:5" pos:end="3605:18"><name pos:start="3605:5" pos:end="3605:7">ctx</name><operator pos:start="3605:8" pos:end="3605:9">-&gt;</operator><name pos:start="3605:10" pos:end="3605:18">auth_mode</name></name> <operator pos:start="3605:20" pos:end="3605:20">=</operator> <name pos:start="3605:22" pos:end="3605:30">AUTH_NONE</name></expr>;</expr_stmt>

    <comment type="block" pos:start="3607:5" pos:end="3610:7">/*
     * cache away the client cert and the associated private key, then
     * get them loaded into the SSL context so that they'll be used.
     */</comment>
    <expr_stmt pos:start="3611:5" pos:end="3611:34"><expr pos:start="3611:5" pos:end="3611:33"><name pos:start="3611:5" pos:end="3611:19"><name pos:start="3611:5" pos:end="3611:7">ctx</name><operator pos:start="3611:8" pos:end="3611:9">-&gt;</operator><name pos:start="3611:10" pos:end="3611:19">client_key</name></name> <operator pos:start="3611:21" pos:end="3611:21">=</operator> <name pos:start="3611:23" pos:end="3611:33">private_key</name></expr>;</expr_stmt>
    <expr_stmt pos:start="3612:5" pos:end="3612:35"><expr pos:start="3612:5" pos:end="3612:34"><name pos:start="3612:5" pos:end="3612:20"><name pos:start="3612:5" pos:end="3612:7">ctx</name><operator pos:start="3612:8" pos:end="3612:9">-&gt;</operator><name pos:start="3612:10" pos:end="3612:20">client_cert</name></name> <operator pos:start="3612:22" pos:end="3612:22">=</operator> <name pos:start="3612:24" pos:end="3612:34">client_cert</name></expr>;</expr_stmt>
    
    <comment type="block" pos:start="3614:5" pos:end="3616:7">/*
     * Load the client cert if it's available
     */</comment>
    <if_stmt pos:start="3617:5" pos:end="3624:5"><if pos:start="3617:5" pos:end="3622:5">if <condition pos:start="3617:8" pos:end="3617:44">(<expr pos:start="3617:9" pos:end="3617:43"><name pos:start="3617:9" pos:end="3617:24"><name pos:start="3617:9" pos:end="3617:11">ctx</name><operator pos:start="3617:12" pos:end="3617:13">-&gt;</operator><name pos:start="3617:14" pos:end="3617:24">client_cert</name></name> <operator pos:start="3617:26" pos:end="3617:27">&amp;&amp;</operator> <name pos:start="3617:29" pos:end="3617:43"><name pos:start="3617:29" pos:end="3617:31">ctx</name><operator pos:start="3617:32" pos:end="3617:33">-&gt;</operator><name pos:start="3617:34" pos:end="3617:43">client_key</name></name></expr>)</condition> <block pos:start="3617:46" pos:end="3622:5">{<block_content pos:start="3618:9" pos:end="3621:9">
        <if_stmt pos:start="3618:9" pos:end="3621:9"><if pos:start="3618:9" pos:end="3621:9">if <condition pos:start="3618:12" pos:end="3618:89">(<expr pos:start="3618:13" pos:end="3618:88"><call pos:start="3618:13" pos:end="3618:88"><name pos:start="3618:13" pos:end="3618:39">est_client_set_cert_and_key</name><argument_list pos:start="3618:40" pos:end="3618:88">(<argument pos:start="3618:41" pos:end="3618:52"><expr pos:start="3618:41" pos:end="3618:52"><name pos:start="3618:41" pos:end="3618:52"><name pos:start="3618:41" pos:end="3618:43">ctx</name><operator pos:start="3618:44" pos:end="3618:45">-&gt;</operator><name pos:start="3618:46" pos:end="3618:52">ssl_ctx</name></name></expr></argument>, <argument pos:start="3618:55" pos:end="3618:70"><expr pos:start="3618:55" pos:end="3618:70"><name pos:start="3618:55" pos:end="3618:70"><name pos:start="3618:55" pos:end="3618:57">ctx</name><operator pos:start="3618:58" pos:end="3618:59">-&gt;</operator><name pos:start="3618:60" pos:end="3618:70">client_cert</name></name></expr></argument>, <argument pos:start="3618:73" pos:end="3618:87"><expr pos:start="3618:73" pos:end="3618:87"><name pos:start="3618:73" pos:end="3618:87"><name pos:start="3618:73" pos:end="3618:75">ctx</name><operator pos:start="3618:76" pos:end="3618:77">-&gt;</operator><name pos:start="3618:78" pos:end="3618:87">client_key</name></name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="3618:91" pos:end="3621:9">{<block_content pos:start="3619:13" pos:end="3620:46">
            <expr_stmt pos:start="3619:13" pos:end="3619:76"><expr pos:start="3619:13" pos:end="3619:75"><call pos:start="3619:13" pos:end="3619:75"><name pos:start="3619:13" pos:end="3619:23">EST_LOG_ERR</name><argument_list pos:start="3619:24" pos:end="3619:75">(<argument pos:start="3619:25" pos:end="3619:74"><expr pos:start="3619:25" pos:end="3619:74"><literal type="string" pos:start="3619:25" pos:end="3619:74">"Unable to load local certificate and private key"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return pos:start="3620:13" pos:end="3620:46">return <expr pos:start="3620:20" pos:end="3620:45"><name pos:start="3620:20" pos:end="3620:45">EST_ERR_CLIENT_INVALID_KEY</name></expr>;</return>
        </block_content>}</block></if></if_stmt>
    </block_content>}</block></if> <else pos:start="3622:7" pos:end="3624:5">else <block pos:start="3622:12" pos:end="3624:5">{<block_content pos:start="3623:9" pos:end="3623:110">
        <expr_stmt pos:start="3623:9" pos:end="3623:110"><expr pos:start="3623:9" pos:end="3623:109"><call pos:start="3623:9" pos:end="3623:109"><name pos:start="3623:9" pos:end="3623:20">EST_LOG_WARN</name><argument_list pos:start="3623:21" pos:end="3623:109">(<argument pos:start="3623:22" pos:end="3623:108"><expr pos:start="3623:22" pos:end="3623:108"><literal type="string" pos:start="3623:22" pos:end="3623:108">"Not using client certificate for TLS session, HTTP basic or digest auth will be used."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </block_content>}</block></else></if_stmt>
    
    <return pos:start="3626:5" pos:end="3626:24">return <expr pos:start="3626:12" pos:end="3626:23"><name pos:start="3626:12" pos:end="3626:23">EST_ERR_NONE</name></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="3628:1" pos:end="3675:2">/*! @brief est_client_set_auth_cred_cb() is used by an application to register
  its callback function.
    
  @param ctx EST context obtained from the est_client_init() call.
  @param auth_credentials_cb  Function pointer to the application layer callback

  The registered callback function is used by the EST client library to obtain
  authentication credentials.  The application can provide authentication
  credentials during initialization if they are available, such as the userid
  and password used with HTTP basic authentication.  During the processing of
  a request, the EST client library will call this application callback in the
  event that it does not have the authentication credentials that are being
  requested by the EST server.

  The callback function definition must match the following function
  prototype,

  int (*auth_credentials_cb)(EST_HTTP_AUTH_HDR *auth_credentials);

  auth_credentials - A pointer to a EST_HTTP_AUTH_HDR structure.  The
                     structure is provided by the EST library and the callback
                     function fills in the specific credentials being
                     requested.  These credential values must be passed in the
                     format in which they will be sent to the server, that is,
                     the EST client library will perform no reformatting of
                     these credentials.  Ownership of the memory holding these
                     credential values is transferred from the application
                     layer to the EST library when the application layer
                     returns these values to the EST library.  This allows the
                     EST library to free up this memory as soon as it is done
                     using these values.
                         
  The return value from the callback must be one of the following values:

  EST_HTTP_AUTH_CRED_SUCCESS - If the callback was able to provide the
                               requested credentials.
  EST_HTTP_AUTH_CRED_NOT_AVAILABLE - If the callback could not provide the
                                     requested credentials.

  The auth_credentials_cb parameter can be set to NULL to reset the callback
  function.
  
  All string parameters are NULL terminated strings.
    
  @return EST_ERROR.
  EST_ERR_NONE - Success.
  EST_ERR_NO_CTX
*/</comment>
<function pos:start="3676:1" pos:end="3686:1"><type pos:start="3676:1" pos:end="3676:9"><name pos:start="3676:1" pos:end="3676:9">EST_ERROR</name></type> <name pos:start="3676:11" pos:end="3676:37">est_client_set_auth_cred_cb</name> <parameter_list pos:start="3676:39" pos:end="3676:82">(<parameter pos:start="3676:40" pos:end="3676:51"><decl pos:start="3676:40" pos:end="3676:51"><type pos:start="3676:40" pos:end="3676:51"><name pos:start="3676:40" pos:end="3676:46">EST_CTX</name> <modifier pos:start="3676:48" pos:end="3676:48">*</modifier></type><name pos:start="3676:49" pos:end="3676:51">ctx</name></decl></parameter>, <parameter pos:start="3676:54" pos:end="3676:81"><decl pos:start="3676:54" pos:end="3676:81"><type pos:start="3676:54" pos:end="3676:81"><name pos:start="3676:54" pos:end="3676:72">auth_credentials_cb</name></type> <name pos:start="3676:74" pos:end="3676:81">callback</name></decl></parameter>)</parameter_list>
<block pos:start="3677:1" pos:end="3686:1">{<block_content pos:start="3678:5" pos:end="3685:24">
    <if_stmt pos:start="3678:5" pos:end="3681:5"><if pos:start="3678:5" pos:end="3681:5">if <condition pos:start="3678:8" pos:end="3678:20">(<expr pos:start="3678:9" pos:end="3678:19"><name pos:start="3678:9" pos:end="3678:11">ctx</name> <operator pos:start="3678:13" pos:end="3678:14">==</operator> <name pos:start="3678:16" pos:end="3678:19">NULL</name></expr>)</condition> <block pos:start="3678:22" pos:end="3681:5">{<block_content pos:start="3679:9" pos:end="3680:32">
	<expr_stmt pos:start="3679:9" pos:end="3679:43"><expr pos:start="3679:9" pos:end="3679:42"><call pos:start="3679:9" pos:end="3679:42"><name pos:start="3679:9" pos:end="3679:19">EST_LOG_ERR</name><argument_list pos:start="3679:20" pos:end="3679:42">(<argument pos:start="3679:21" pos:end="3679:41"><expr pos:start="3679:21" pos:end="3679:41"><literal type="string" pos:start="3679:21" pos:end="3679:41">"Null context passed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3680:9" pos:end="3680:32">return <expr pos:start="3680:16" pos:end="3680:31"><operator pos:start="3680:16" pos:end="3680:16">(</operator><name pos:start="3680:17" pos:end="3680:30">EST_ERR_NO_CTX</name><operator pos:start="3680:31" pos:end="3680:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
    
    <expr_stmt pos:start="3683:5" pos:end="3683:40"><expr pos:start="3683:5" pos:end="3683:39"><name pos:start="3683:5" pos:end="3683:28"><name pos:start="3683:5" pos:end="3683:7">ctx</name><operator pos:start="3683:8" pos:end="3683:9">-&gt;</operator><name pos:start="3683:10" pos:end="3683:28">auth_credentials_cb</name></name> <operator pos:start="3683:30" pos:end="3683:30">=</operator> <name pos:start="3683:32" pos:end="3683:39">callback</name></expr>;</expr_stmt>
    
    <return pos:start="3685:5" pos:end="3685:24">return <expr pos:start="3685:12" pos:end="3685:23"><name pos:start="3685:12" pos:end="3685:23">EST_ERR_NONE</name></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="3687:1" pos:end="3709:2">/*! @brief est_client_enable_basic_auth_hint() is used by an application to 
    reduce overhead at the TCP and TLS layers when the client knows that
    the EST server is using HTTP Basic Authentication. 
 
    @param ctx Pointer to EST context for a client session

    Normally libEST will send an anonymous HTTP request when doing the
    initial request from the EST server.  This function allows an application 
    to improve performance by sending the HTTP Basic Auth header in the initial 
    request sent to the EST server.  This eliminates the need for the server to send
    the HTTP authentication challene response, which eliminates a round-trip
    between the EST client and server.  This function should be called immediately
    after invoking est_client_set_auth().

    Precautions should be taken by your application to ensure this hint is
    only enabled when it is known that the EST server is configured for HTTP
    Basic Authentication.  If the EST server is configured for HTTP Digest
    Authentication, then enabling this hint will cause the EST transaction
    to fail.
 
    @return EST_ERROR
    EST_ERR_NONE - Success.
*/</comment>
<function pos:start="3710:1" pos:end="3719:1"><type pos:start="3710:1" pos:end="3710:9"><name pos:start="3710:1" pos:end="3710:9">EST_ERROR</name></type> <name pos:start="3710:11" pos:end="3710:43">est_client_enable_basic_auth_hint</name> <parameter_list pos:start="3710:45" pos:end="3710:58">(<parameter pos:start="3710:46" pos:end="3710:57"><decl pos:start="3710:46" pos:end="3710:57"><type pos:start="3710:46" pos:end="3710:54"><name pos:start="3710:46" pos:end="3710:52">EST_CTX</name> <modifier pos:start="3710:54" pos:end="3710:54">*</modifier></type><name pos:start="3710:55" pos:end="3710:57">ctx</name></decl></parameter>)</parameter_list>
<block pos:start="3711:1" pos:end="3719:1">{<block_content pos:start="3712:5" pos:end="3718:26">
    <if_stmt pos:start="3712:5" pos:end="3715:5"><if pos:start="3712:5" pos:end="3715:5">if <condition pos:start="3712:8" pos:end="3712:20">(<expr pos:start="3712:9" pos:end="3712:19"><name pos:start="3712:9" pos:end="3712:11">ctx</name> <operator pos:start="3712:13" pos:end="3712:14">==</operator> <name pos:start="3712:16" pos:end="3712:19">NULL</name></expr>)</condition> <block pos:start="3712:22" pos:end="3715:5">{<block_content pos:start="3713:9" pos:end="3714:32">
	<expr_stmt pos:start="3713:9" pos:end="3713:43"><expr pos:start="3713:9" pos:end="3713:42"><call pos:start="3713:9" pos:end="3713:42"><name pos:start="3713:9" pos:end="3713:19">EST_LOG_ERR</name><argument_list pos:start="3713:20" pos:end="3713:42">(<argument pos:start="3713:21" pos:end="3713:41"><expr pos:start="3713:21" pos:end="3713:41"><literal type="string" pos:start="3713:21" pos:end="3713:41">"Null context passed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3714:9" pos:end="3714:32">return <expr pos:start="3714:16" pos:end="3714:31"><operator pos:start="3714:16" pos:end="3714:16">(</operator><name pos:start="3714:17" pos:end="3714:30">EST_ERR_NO_CTX</name><operator pos:start="3714:31" pos:end="3714:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>    

    <expr_stmt pos:start="3717:5" pos:end="3717:32"><expr pos:start="3717:5" pos:end="3717:31"><name pos:start="3717:5" pos:end="3717:18"><name pos:start="3717:5" pos:end="3717:7">ctx</name><operator pos:start="3717:8" pos:end="3717:9">-&gt;</operator><name pos:start="3717:10" pos:end="3717:18">auth_mode</name></name> <operator pos:start="3717:20" pos:end="3717:20">=</operator> <name pos:start="3717:22" pos:end="3717:31">AUTH_BASIC</name></expr>;</expr_stmt>
    <return pos:start="3718:5" pos:end="3718:26">return <expr pos:start="3718:12" pos:end="3718:25"><operator pos:start="3718:12" pos:end="3718:12">(</operator><name pos:start="3718:13" pos:end="3718:24">EST_ERR_NONE</name><operator pos:start="3718:25" pos:end="3718:25">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="3720:1" pos:end="3750:2">/*! @brief est_client_init() is used by an application to create
    a context in the EST library.  This context is used when invoking
    other functions in the client API.
 
    @param ca_chain Required char buffer containing CA certificates as raw byte
    data, to be used for authenticating the EST server
    @param ca_chain_len length of ca_chain char buffer.
    @param cert_format defines the format of the certificates that will be
    passed down during this instantiation of the EST client library.  Currently,
    the only value accepted is EST_CERT_FORMAT_PEM
    @param cert_verify_cb A pointer to a function in the EST client application
    that is called when a received server identity certificate has failed
    verification from the SSL code.  This function takes as input two
    parameters, a pointer to the X509 structure containing the server's
    certificate, and a integer value set to the OpenSSL defined error
    for this certificate.  This callback function returns a 0 if the server's
    identity certificate has been rejected, and any other value if it
    has been approved.

    This function allows an application to initialize an EST client context.
    The application must provide the local CA certificates
    (ca_chain/ca_chain_len) to use for client operation.  The certificates
    provided must be in the format specified by the cert_format parameter.
    Currently, only PEM encoded certificates are supported.  The length
    parameters for the certificates (ca_chain_len) are to be used when DER
    formatted certificates are passed.  The CA certificates may contain CRL
    entries that will be used when authenticating the certificates received
    from the server.
 
    @return EST_CTX.  If error, NULL.
*/</comment>
<function pos:start="3751:1" pos:end="3841:1"><type pos:start="3751:1" pos:end="3751:9"><name pos:start="3751:1" pos:end="3751:7">EST_CTX</name> <modifier pos:start="3751:9" pos:end="3751:9">*</modifier></type><name pos:start="3751:10" pos:end="3751:24">est_client_init</name> <parameter_list pos:start="3751:26" pos:end="3753:61">(<parameter pos:start="3751:27" pos:end="3751:49"><decl pos:start="3751:27" pos:end="3751:49"><type pos:start="3751:27" pos:end="3751:49"><name pos:start="3751:27" pos:end="3751:34">unsigned</name> <name pos:start="3751:36" pos:end="3751:39">char</name> <modifier pos:start="3751:41" pos:end="3751:41">*</modifier></type><name pos:start="3751:42" pos:end="3751:49">ca_chain</name></decl></parameter>, <parameter pos:start="3751:52" pos:end="3751:67"><decl pos:start="3751:52" pos:end="3751:67"><type pos:start="3751:52" pos:end="3751:67"><name pos:start="3751:52" pos:end="3751:54">int</name></type> <name pos:start="3751:56" pos:end="3751:67">ca_chain_len</name></decl></parameter>,
                          <parameter pos:start="3752:27" pos:end="3752:53"><decl pos:start="3752:27" pos:end="3752:53"><type pos:start="3752:27" pos:end="3752:53"><name pos:start="3752:27" pos:end="3752:41">EST_CERT_FORMAT</name></type> <name pos:start="3752:43" pos:end="3752:53">cert_format</name></decl></parameter>,
                          <parameter pos:start="3753:27" pos:end="3753:60"><function_decl pos:start="3753:27" pos:end="3753:60"><type pos:start="3753:27" pos:end="3753:29"><name pos:start="3753:27" pos:end="3753:29">int</name></type> (<modifier pos:start="3753:32" pos:end="3753:32">*</modifier><name pos:start="3753:33" pos:end="3753:46">cert_verify_cb</name>)<parameter_list pos:start="3753:48" pos:end="3753:60">(<parameter pos:start="3753:49" pos:end="3753:54"><decl pos:start="3753:49" pos:end="3753:54"><type pos:start="3753:49" pos:end="3753:54"><name pos:start="3753:49" pos:end="3753:52">X509</name> <modifier pos:start="3753:54" pos:end="3753:54">*</modifier></type></decl></parameter>, <parameter pos:start="3753:57" pos:end="3753:59"><decl pos:start="3753:57" pos:end="3753:59"><type pos:start="3753:57" pos:end="3753:59"><name pos:start="3753:57" pos:end="3753:59">int</name></type></decl></parameter>)</parameter_list></function_decl></parameter>)</parameter_list>
<block pos:start="3754:1" pos:end="3841:1">{<block_content pos:start="3755:5" pos:end="3840:17">
    <decl_stmt pos:start="3755:5" pos:end="3755:17"><decl pos:start="3755:5" pos:end="3755:16"><type pos:start="3755:5" pos:end="3755:13"><name pos:start="3755:5" pos:end="3755:11">EST_CTX</name> <modifier pos:start="3755:13" pos:end="3755:13">*</modifier></type><name pos:start="3755:14" pos:end="3755:16">ctx</name></decl>;</decl_stmt>
    <decl_stmt pos:start="3756:5" pos:end="3756:21"><decl pos:start="3756:5" pos:end="3756:20"><type pos:start="3756:5" pos:end="3756:16"><specifier pos:start="3756:5" pos:end="3756:12">volatile</specifier> <name pos:start="3756:14" pos:end="3756:16">int</name></type> <name pos:start="3756:18" pos:end="3756:20">len</name></decl>;</decl_stmt>
    <decl_stmt pos:start="3757:5" pos:end="3760:0"><decl pos:start="3757:5" pos:end="3757:10"><type pos:start="3757:5" pos:end="3757:7"><name pos:start="3757:5" pos:end="3757:7">int</name></type> <name pos:start="3757:9" pos:end="3757:10">rv</name></decl>;</decl_stmt>
	
<cpp:ifdef pos:start="3759:1" pos:end="3759:12">#<cpp:directive pos:start="3759:2" pos:end="3759:6">ifdef</cpp:directive> <name pos:start="3759:8" pos:end="3759:12">WIN32</name></cpp:ifdef>
	<decl_stmt pos:start="3760:9" pos:end="3760:20"><decl pos:start="3760:9" pos:end="3760:19"><type pos:start="3760:9" pos:end="3760:11"><name pos:start="3760:9" pos:end="3760:11">int</name></type> <name pos:start="3760:13" pos:end="3760:19">iResult</name></decl>;</decl_stmt>

	<comment type="block" pos:start="3762:9" pos:end="3764:10">/*
	*Initialize Winsock
	*/</comment>
	<expr_stmt pos:start="3765:9" pos:end="3765:55"><expr pos:start="3765:9" pos:end="3765:54"><name pos:start="3765:9" pos:end="3765:15">iResult</name> <operator pos:start="3765:17" pos:end="3765:17">=</operator> <call pos:start="3765:19" pos:end="3765:54"><name pos:start="3765:19" pos:end="3765:28">WSAStartup</name><argument_list pos:start="3765:29" pos:end="3765:54">(<argument pos:start="3765:30" pos:end="3765:43"><expr pos:start="3765:30" pos:end="3765:43"><call pos:start="3765:30" pos:end="3765:43"><name pos:start="3765:30" pos:end="3765:37">MAKEWORD</name><argument_list pos:start="3765:38" pos:end="3765:43">(<argument pos:start="3765:39" pos:end="3765:39"><expr pos:start="3765:39" pos:end="3765:39"><literal type="number" pos:start="3765:39" pos:end="3765:39">2</literal></expr></argument>, <argument pos:start="3765:42" pos:end="3765:42"><expr pos:start="3765:42" pos:end="3765:42"><literal type="number" pos:start="3765:42" pos:end="3765:42">2</literal></expr></argument>)</argument_list></call></expr></argument>, <argument pos:start="3765:46" pos:end="3765:53"><expr pos:start="3765:46" pos:end="3765:53"><operator pos:start="3765:46" pos:end="3765:46">&amp;</operator><name pos:start="3765:47" pos:end="3765:53">wsaData</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if_stmt pos:start="3766:9" pos:end="3772:0"><if pos:start="3766:9" pos:end="3772:0">if <condition pos:start="3766:12" pos:end="3766:25">(<expr pos:start="3766:13" pos:end="3766:24"><name pos:start="3766:13" pos:end="3766:19">iResult</name> <operator pos:start="3766:21" pos:end="3766:22">!=</operator> <literal type="number" pos:start="3766:24" pos:end="3766:24">0</literal></expr>)</condition> <block pos:start="3766:27" pos:end="3772:0">{<block_content pos:start="3767:17" pos:end="3768:25">
		<expr_stmt pos:start="3767:17" pos:end="3767:64"><expr pos:start="3767:17" pos:end="3767:63"><call pos:start="3767:17" pos:end="3767:63"><name pos:start="3767:17" pos:end="3767:27">EST_LOG_ERR</name><argument_list pos:start="3767:28" pos:end="3767:63">(<argument pos:start="3767:29" pos:end="3767:53"><expr pos:start="3767:29" pos:end="3767:53"><literal type="string" pos:start="3767:29" pos:end="3767:53">"WSAStartup Failed: %d\n"</literal></expr></argument>, <argument pos:start="3767:56" pos:end="3767:62"><expr pos:start="3767:56" pos:end="3767:62"><name pos:start="3767:56" pos:end="3767:62">iResult</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<return pos:start="3768:17" pos:end="3768:25">return <expr pos:start="3768:24" pos:end="3768:24"><literal type="number" pos:start="3768:24" pos:end="3768:24">0</literal></expr>;</return>

	</block_content>}</block></if></if_stmt>
<cpp:endif pos:start="3771:1" pos:end="3771:6">#<cpp:directive pos:start="3771:2" pos:end="3771:6">endif</cpp:directive></cpp:endif>	

    <if_stmt pos:start="3773:5" pos:end="3776:5"><if pos:start="3773:5" pos:end="3776:5">if <condition pos:start="3773:8" pos:end="3773:43">(<expr pos:start="3773:9" pos:end="3773:42"><name pos:start="3773:9" pos:end="3773:19">cert_format</name> <operator pos:start="3773:21" pos:end="3773:22">!=</operator> <name pos:start="3773:24" pos:end="3773:42">EST_CERT_FORMAT_PEM</name></expr>)</condition> <block pos:start="3773:45" pos:end="3776:5">{<block_content pos:start="3774:9" pos:end="3775:20">
        <expr_stmt pos:start="3774:9" pos:end="3774:71"><expr pos:start="3774:9" pos:end="3774:70"><call pos:start="3774:9" pos:end="3774:70"><name pos:start="3774:9" pos:end="3774:19">EST_LOG_ERR</name><argument_list pos:start="3774:20" pos:end="3774:70">(<argument pos:start="3774:21" pos:end="3774:69"><expr pos:start="3774:21" pos:end="3774:69"><literal type="string" pos:start="3774:21" pos:end="3774:69">"Only PEM encoding of certificates is supported."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3775:9" pos:end="3775:20">return <expr pos:start="3775:16" pos:end="3775:19"><name pos:start="3775:16" pos:end="3775:19">NULL</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
        
    <comment type="block" pos:start="3778:5" pos:end="3783:7">/* 
     * If a CA chain was passed in, then check the length value passed in.  It
     * should match the calculated length of the buffer.  This will verify
     * both that the length value is correct, and that the buffer is properly
     * null terminated.
     */</comment>
    <if_stmt pos:start="3784:5" pos:end="3790:5"><if pos:start="3784:5" pos:end="3790:5">if <condition pos:start="3784:8" pos:end="3784:17">(<expr pos:start="3784:9" pos:end="3784:16"><name pos:start="3784:9" pos:end="3784:16">ca_chain</name></expr>)</condition> <block pos:start="3784:19" pos:end="3790:5">{<block_content pos:start="3785:9" pos:end="3789:9">    
        <expr_stmt pos:start="3785:9" pos:end="3785:60"><expr pos:start="3785:9" pos:end="3785:59"><name pos:start="3785:9" pos:end="3785:11">len</name> <operator pos:start="3785:13" pos:end="3785:13">=</operator> <operator pos:start="3785:15" pos:end="3785:15">(</operator><name pos:start="3785:16" pos:end="3785:18">int</name><operator pos:start="3785:19" pos:end="3785:19">)</operator> <call pos:start="3785:21" pos:end="3785:59"><name pos:start="3785:21" pos:end="3785:29">strnlen_s</name><argument_list pos:start="3785:30" pos:end="3785:59">(<argument pos:start="3785:31" pos:end="3785:46"><expr pos:start="3785:31" pos:end="3785:46"><operator pos:start="3785:31" pos:end="3785:31">(</operator><name pos:start="3785:32" pos:end="3785:35">char</name> <operator pos:start="3785:37" pos:end="3785:37">*</operator><operator pos:start="3785:38" pos:end="3785:38">)</operator><name pos:start="3785:39" pos:end="3785:46">ca_chain</name></expr></argument>, <argument pos:start="3785:49" pos:end="3785:58"><expr pos:start="3785:49" pos:end="3785:58"><name pos:start="3785:49" pos:end="3785:58">EST_CA_MAX</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if_stmt pos:start="3786:9" pos:end="3789:9"><if pos:start="3786:9" pos:end="3789:9">if <condition pos:start="3786:12" pos:end="3786:32">(<expr pos:start="3786:13" pos:end="3786:31"><name pos:start="3786:13" pos:end="3786:15">len</name> <operator pos:start="3786:17" pos:end="3786:18">!=</operator> <name pos:start="3786:20" pos:end="3786:31">ca_chain_len</name></expr>)</condition> <block pos:start="3786:34" pos:end="3789:9">{<block_content pos:start="3787:13" pos:end="3788:24">
            <expr_stmt pos:start="3787:13" pos:end="3787:80"><expr pos:start="3787:13" pos:end="3787:79"><call pos:start="3787:13" pos:end="3787:79"><name pos:start="3787:13" pos:end="3787:23">EST_LOG_ERR</name><argument_list pos:start="3787:24" pos:end="3787:79">(<argument pos:start="3787:25" pos:end="3787:78"><expr pos:start="3787:25" pos:end="3787:78"><literal type="string" pos:start="3787:25" pos:end="3787:78">"Length of ca_chain doesn't match passed ca_chain_len"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return pos:start="3788:13" pos:end="3788:24">return <expr pos:start="3788:20" pos:end="3788:23"><name pos:start="3788:20" pos:end="3788:23">NULL</name></expr>;</return>
        </block_content>}</block></if></if_stmt>
    </block_content>}</block></if></if_stmt>
    
    <expr_stmt pos:start="3792:5" pos:end="3792:34"><expr pos:start="3792:5" pos:end="3792:33"><name pos:start="3792:5" pos:end="3792:7">ctx</name> <operator pos:start="3792:9" pos:end="3792:9">=</operator> <call pos:start="3792:11" pos:end="3792:33"><name pos:start="3792:11" pos:end="3792:16">malloc</name><argument_list pos:start="3792:17" pos:end="3792:33">(<argument pos:start="3792:18" pos:end="3792:32"><expr pos:start="3792:18" pos:end="3792:32"><sizeof pos:start="3792:18" pos:end="3792:32">sizeof<argument_list pos:start="3792:24" pos:end="3792:32">(<argument pos:start="3792:25" pos:end="3792:31"><expr pos:start="3792:25" pos:end="3792:31"><name pos:start="3792:25" pos:end="3792:31">EST_CTX</name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="3793:5" pos:end="3796:5"><if pos:start="3793:5" pos:end="3796:5">if <condition pos:start="3793:8" pos:end="3793:13">(<expr pos:start="3793:9" pos:end="3793:12"><operator pos:start="3793:9" pos:end="3793:9">!</operator><name pos:start="3793:10" pos:end="3793:12">ctx</name></expr>)</condition> <block pos:start="3793:15" pos:end="3796:5">{<block_content pos:start="3794:9" pos:end="3795:20">
        <expr_stmt pos:start="3794:9" pos:end="3794:65"><expr pos:start="3794:9" pos:end="3794:64"><call pos:start="3794:9" pos:end="3794:64"><name pos:start="3794:9" pos:end="3794:19">EST_LOG_ERR</name><argument_list pos:start="3794:20" pos:end="3794:64">(<argument pos:start="3794:21" pos:end="3794:63"><expr pos:start="3794:21" pos:end="3794:63"><literal type="string" pos:start="3794:21" pos:end="3794:63">"Unable to allocate memory for EST Context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3795:9" pos:end="3795:20">return <expr pos:start="3795:16" pos:end="3795:19"><name pos:start="3795:16" pos:end="3795:19">NULL</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="3797:5" pos:end="3797:36"><expr pos:start="3797:5" pos:end="3797:35"><call pos:start="3797:5" pos:end="3797:35"><name pos:start="3797:5" pos:end="3797:13">memzero_s</name><argument_list pos:start="3797:14" pos:end="3797:35">(<argument pos:start="3797:15" pos:end="3797:17"><expr pos:start="3797:15" pos:end="3797:17"><name pos:start="3797:15" pos:end="3797:17">ctx</name></expr></argument>, <argument pos:start="3797:20" pos:end="3797:34"><expr pos:start="3797:20" pos:end="3797:34"><sizeof pos:start="3797:20" pos:end="3797:34">sizeof<argument_list pos:start="3797:26" pos:end="3797:34">(<argument pos:start="3797:27" pos:end="3797:33"><expr pos:start="3797:27" pos:end="3797:33"><name pos:start="3797:27" pos:end="3797:33">EST_CTX</name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="3798:5" pos:end="3798:31"><expr pos:start="3798:5" pos:end="3798:30"><name pos:start="3798:5" pos:end="3798:17"><name pos:start="3798:5" pos:end="3798:7">ctx</name><operator pos:start="3798:8" pos:end="3798:9">-&gt;</operator><name pos:start="3798:10" pos:end="3798:17">est_mode</name></name> <operator pos:start="3798:19" pos:end="3798:19">=</operator> <name pos:start="3798:21" pos:end="3798:30">EST_CLIENT</name></expr>;</expr_stmt>

    <comment type="block" pos:start="3800:5" pos:end="3803:7">/*
     * Load the local CA certificates into memory and retain
     * for future use.  This will be used for /CACerts requests.
     */</comment>
    <if_stmt pos:start="3804:5" pos:end="3808:5"><if pos:start="3804:5" pos:end="3808:5">if <condition pos:start="3804:8" pos:end="3804:60">(<expr pos:start="3804:9" pos:end="3804:59"><call pos:start="3804:9" pos:end="3804:59"><name pos:start="3804:9" pos:end="3804:30">est_load_trusted_certs</name><argument_list pos:start="3804:31" pos:end="3804:59">(<argument pos:start="3804:32" pos:end="3804:34"><expr pos:start="3804:32" pos:end="3804:34"><name pos:start="3804:32" pos:end="3804:34">ctx</name></expr></argument>, <argument pos:start="3804:37" pos:end="3804:44"><expr pos:start="3804:37" pos:end="3804:44"><name pos:start="3804:37" pos:end="3804:44">ca_chain</name></expr></argument>, <argument pos:start="3804:47" pos:end="3804:58"><expr pos:start="3804:47" pos:end="3804:58"><name pos:start="3804:47" pos:end="3804:58">ca_chain_len</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="3804:62" pos:end="3808:5">{<block_content pos:start="3805:9" pos:end="3807:20">
        <expr_stmt pos:start="3805:9" pos:end="3805:64"><expr pos:start="3805:9" pos:end="3805:63"><call pos:start="3805:9" pos:end="3805:63"><name pos:start="3805:9" pos:end="3805:19">EST_LOG_ERR</name><argument_list pos:start="3805:20" pos:end="3805:63">(<argument pos:start="3805:21" pos:end="3805:62"><expr pos:start="3805:21" pos:end="3805:62"><literal type="string" pos:start="3805:21" pos:end="3805:62">"Failed to load trusted certificate store"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="3806:9" pos:end="3806:25"><expr pos:start="3806:9" pos:end="3806:24"><call pos:start="3806:9" pos:end="3806:24"><name pos:start="3806:9" pos:end="3806:19">est_destroy</name><argument_list pos:start="3806:20" pos:end="3806:24">(<argument pos:start="3806:21" pos:end="3806:23"><expr pos:start="3806:21" pos:end="3806:23"><name pos:start="3806:21" pos:end="3806:23">ctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3807:9" pos:end="3807:20">return <expr pos:start="3807:16" pos:end="3807:19"><name pos:start="3807:16" pos:end="3807:19">NULL</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="3810:5" pos:end="3810:38"><expr pos:start="3810:5" pos:end="3810:37"><name pos:start="3810:5" pos:end="3810:6">rv</name> <operator pos:start="3810:8" pos:end="3810:8">=</operator> <call pos:start="3810:10" pos:end="3810:37"><name pos:start="3810:10" pos:end="3810:32">est_client_init_ssl_ctx</name><argument_list pos:start="3810:33" pos:end="3810:37">(<argument pos:start="3810:34" pos:end="3810:36"><expr pos:start="3810:34" pos:end="3810:36"><name pos:start="3810:34" pos:end="3810:36">ctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="3811:5" pos:end="3815:5"><if pos:start="3811:5" pos:end="3815:5">if <condition pos:start="3811:8" pos:end="3811:27">(<expr pos:start="3811:9" pos:end="3811:26"><name pos:start="3811:9" pos:end="3811:10">rv</name> <operator pos:start="3811:12" pos:end="3811:13">!=</operator> <name pos:start="3811:15" pos:end="3811:26">EST_ERR_NONE</name></expr>)</condition> <block pos:start="3811:29" pos:end="3815:5">{<block_content pos:start="3812:9" pos:end="3814:20">
        <expr_stmt pos:start="3812:9" pos:end="3812:97"><expr pos:start="3812:9" pos:end="3812:96"><call pos:start="3812:9" pos:end="3812:96"><name pos:start="3812:9" pos:end="3812:19">EST_LOG_ERR</name><argument_list pos:start="3812:20" pos:end="3812:96">(<argument pos:start="3812:21" pos:end="3812:95"><expr pos:start="3812:21" pos:end="3812:95"><literal type="string" pos:start="3812:21" pos:end="3812:95">"Failed to initialize SSL context with certificiate and private key passed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="3813:9" pos:end="3813:25"><expr pos:start="3813:9" pos:end="3813:24"><call pos:start="3813:9" pos:end="3813:24"><name pos:start="3813:9" pos:end="3813:19">est_destroy</name><argument_list pos:start="3813:20" pos:end="3813:24">(<argument pos:start="3813:21" pos:end="3813:23"><expr pos:start="3813:21" pos:end="3813:23"><name pos:start="3813:21" pos:end="3813:23">ctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3814:9" pos:end="3814:20">return <expr pos:start="3814:16" pos:end="3814:19"><name pos:start="3814:16" pos:end="3814:19">NULL</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="3817:5" pos:end="3820:7">/*
     * save away the client's callback function that allows for manual verification of
     * the server's identity certificate
     */</comment>
    <expr_stmt pos:start="3821:5" pos:end="3821:48"><expr pos:start="3821:5" pos:end="3821:47"><name pos:start="3821:5" pos:end="3821:30"><name pos:start="3821:5" pos:end="3821:7">ctx</name><operator pos:start="3821:8" pos:end="3821:9">-&gt;</operator><name pos:start="3821:10" pos:end="3821:30">manual_cert_verify_cb</name></name> <operator pos:start="3821:32" pos:end="3821:32">=</operator> <name pos:start="3821:34" pos:end="3821:47">cert_verify_cb</name></expr>;</expr_stmt>
    
    <comment type="block" pos:start="3823:5" pos:end="3825:7">/*
     * Set the default value for the  socket read timeout.
     */</comment>
    <expr_stmt pos:start="3826:5" pos:end="3826:49"><expr pos:start="3826:5" pos:end="3826:48"><name pos:start="3826:5" pos:end="3826:21"><name pos:start="3826:5" pos:end="3826:7">ctx</name><operator pos:start="3826:8" pos:end="3826:9">-&gt;</operator><name pos:start="3826:10" pos:end="3826:21">read_timeout</name></name> <operator pos:start="3826:23" pos:end="3826:23">=</operator> <name pos:start="3826:25" pos:end="3826:48">EST_SSL_READ_TIMEOUT_DEF</name></expr>;</expr_stmt>

    <comment type="block" pos:start="3828:5" pos:end="3833:7">/*
     * We use SHA-256 as the default hash algorithm
     * for signing the CSR.  This can be changed by the
     * application by using the est_client_set_sign_digest() 
     * function.
     */</comment>
    <expr_stmt pos:start="3834:5" pos:end="3834:39"><expr pos:start="3834:5" pos:end="3834:38"><name pos:start="3834:5" pos:end="3834:23"><name pos:start="3834:5" pos:end="3834:7">ctx</name><operator pos:start="3834:8" pos:end="3834:9">-&gt;</operator><name pos:start="3834:10" pos:end="3834:23">signing_digest</name></name> <operator pos:start="3834:25" pos:end="3834:25">=</operator> <call pos:start="3834:27" pos:end="3834:38"><name pos:start="3834:27" pos:end="3834:36">EVP_sha256</name><argument_list pos:start="3834:37" pos:end="3834:38">()</argument_list></call></expr>;</expr_stmt> 

    <expr_stmt pos:start="3836:5" pos:end="3836:31"><expr pos:start="3836:5" pos:end="3836:30"><name pos:start="3836:5" pos:end="3836:26"><name pos:start="3836:5" pos:end="3836:7">ctx</name><operator pos:start="3836:8" pos:end="3836:9">-&gt;</operator><name pos:start="3836:10" pos:end="3836:26">retry_after_delay</name></name> <operator pos:start="3836:28" pos:end="3836:28">=</operator> <literal type="number" pos:start="3836:30" pos:end="3836:30">0</literal></expr>;</expr_stmt>
    <expr_stmt pos:start="3837:5" pos:end="3837:30"><expr pos:start="3837:5" pos:end="3837:29"><name pos:start="3837:5" pos:end="3837:25"><name pos:start="3837:5" pos:end="3837:7">ctx</name><operator pos:start="3837:8" pos:end="3837:9">-&gt;</operator><name pos:start="3837:10" pos:end="3837:25">retry_after_date</name></name> <operator pos:start="3837:27" pos:end="3837:27">=</operator> <literal type="number" pos:start="3837:29" pos:end="3837:29">0</literal></expr>;</expr_stmt>
    
    <expr_stmt pos:start="3839:5" pos:end="3839:36"><expr pos:start="3839:5" pos:end="3839:35"><name pos:start="3839:5" pos:end="3839:31"><name pos:start="3839:5" pos:end="3839:7">ctx</name><operator pos:start="3839:8" pos:end="3839:9">-&gt;</operator><name pos:start="3839:10" pos:end="3839:31">est_client_initialized</name></name> <operator pos:start="3839:33" pos:end="3839:33">=</operator> <literal type="number" pos:start="3839:35" pos:end="3839:35">1</literal></expr>;</expr_stmt>
    <return pos:start="3840:5" pos:end="3840:17">return <expr pos:start="3840:12" pos:end="3840:16"><operator pos:start="3840:12" pos:end="3840:12">(</operator><name pos:start="3840:13" pos:end="3840:15">ctx</name><operator pos:start="3840:16" pos:end="3840:16">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="3842:1" pos:end="3872:2">/*! @brief est_client_init() is used by an application to create
    a context in the EST library.  This context is used when invoking
    other functions in the client API.
 
    @param ca_chain Required char buffer containing CA certificates as raw byte
    data, to be used for authenticating the EST server
    @param ca_chain_len length of ca_chain char buffer.
    @param cert_format defines the format of the certificates that will be
    passed down during this instantiation of the EST client library.  Currently,
    the only value accepted is EST_CERT_FORMAT_PEM
    @param cert_verify_cb A pointer to a function in the EST client application
    that is called when a received server identity certificate has failed
    verification from the SSL code.  This function takes as input two
    parameters, a pointer to the X509 structure containing the server's
    certificate, and a integer value set to the OpenSSL defined error
    for this certificate.  This callback function returns a 0 if the server's
    identity certificate has been rejected, and any other value if it
    has been approved.

    This function allows an application to initialize an EST client context.
    The application must provide the local CA certificates
    (ca_chain/ca_chain_len) to use for client operation.  The certificates
    provided must be in the format specified by the cert_format parameter.
    Currently, only PEM encoded certificates are supported.  The length
    parameters for the certificates (ca_chain_len) are to be used when DER
    formatted certificates are passed.  The CA certificates may contain CRL
    entries that will be used when authenticating the certificates received
    from the server.
 
    @return EST_CTX.  If error, NULL.
*/</comment>
<function pos:start="3873:1" pos:end="3934:1"><type pos:start="3873:1" pos:end="3873:16"><specifier pos:start="3873:1" pos:end="3873:6">static</specifier> <name pos:start="3873:8" pos:end="3873:16">EST_ERROR</name></type> <name pos:start="3873:18" pos:end="3873:42">est_client_parse_path_seg</name> <parameter_list pos:start="3873:44" pos:end="3873:59">(<parameter pos:start="3873:45" pos:end="3873:58"><decl pos:start="3873:45" pos:end="3873:58"><type pos:start="3873:45" pos:end="3873:50"><name pos:start="3873:45" pos:end="3873:48">char</name> <modifier pos:start="3873:50" pos:end="3873:50">*</modifier></type><name pos:start="3873:51" pos:end="3873:58">path_seg</name></decl></parameter>)</parameter_list> 
<block pos:start="3874:1" pos:end="3934:1">{<block_content pos:start="3875:5" pos:end="3933:26">
    <decl_stmt pos:start="3875:5" pos:end="3875:26"><decl pos:start="3875:5" pos:end="3875:25"><type pos:start="3875:5" pos:end="3875:19"><name pos:start="3875:5" pos:end="3875:19">UriParserStateA</name></type> <name pos:start="3875:21" pos:end="3875:25">state</name></decl>;</decl_stmt>
    <decl_stmt pos:start="3876:5" pos:end="3876:23"><decl pos:start="3876:5" pos:end="3876:22"><type pos:start="3876:5" pos:end="3876:11"><name pos:start="3876:5" pos:end="3876:11">UriUriA</name></type> <name pos:start="3876:13" pos:end="3876:22">parsed_uri</name></decl>;</decl_stmt>
    <decl_stmt pos:start="3877:5" pos:end="3877:20"><decl pos:start="3877:5" pos:end="3877:19"><type pos:start="3877:5" pos:end="3877:7"><name pos:start="3877:5" pos:end="3877:7">int</name></type> <name pos:start="3877:9" pos:end="3877:19">uriparse_rc</name></decl>;</decl_stmt>
    <decl_stmt pos:start="3878:5" pos:end="3878:36"><decl pos:start="3878:5" pos:end="3878:35"><type pos:start="3878:5" pos:end="3878:21"><name pos:start="3878:5" pos:end="3878:19">UriPathSegmentA</name> <modifier pos:start="3878:21" pos:end="3878:21">*</modifier></type><name pos:start="3878:22" pos:end="3878:28">cur_seg</name> <init pos:start="3878:30" pos:end="3878:35">= <expr pos:start="3878:32" pos:end="3878:35"><name pos:start="3878:32" pos:end="3878:35">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="3879:5" pos:end="3879:29"><decl pos:start="3879:5" pos:end="3879:28"><type pos:start="3879:5" pos:end="3879:10"><name pos:start="3879:5" pos:end="3879:8">char</name> <modifier pos:start="3879:10" pos:end="3879:10">*</modifier></type><name pos:start="3879:11" pos:end="3879:21">cur_seg_str</name> <init pos:start="3879:23" pos:end="3879:28">= <expr pos:start="3879:25" pos:end="3879:28"><name pos:start="3879:25" pos:end="3879:28">NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt pos:start="3880:5" pos:end="3880:28"><decl pos:start="3880:5" pos:end="3880:27"><type pos:start="3880:5" pos:end="3880:17"><name pos:start="3880:5" pos:end="3880:17">EST_OPERATION</name></type> <name pos:start="3880:19" pos:end="3880:27">operation</name></decl>;</decl_stmt>
    <decl_stmt pos:start="3881:5" pos:end="3881:37"><decl pos:start="3881:5" pos:end="3881:36"><type pos:start="3881:5" pos:end="3881:8"><name pos:start="3881:5" pos:end="3881:8">char</name></type> <name pos:start="3881:10" pos:end="3881:36"><name pos:start="3881:10" pos:end="3881:19">canned_uri</name><index pos:start="3881:20" pos:end="3881:36">[<expr pos:start="3881:21" pos:end="3881:35"><name pos:start="3881:21" pos:end="3881:35">EST_URI_MAX_LEN</name></expr>]</index></name></decl>;</decl_stmt>

    <comment type="block" pos:start="3883:5" pos:end="3889:7">/*
     * build out a canned URI to pass to the uriparser library.
     * This will cause the incoming path segment to be in the
     * correct spot within a URI as it gets validated.  Main issue
     * is the possible use of a ':' in the path segment becoming a
     * theme delimiter
     */</comment>
    <expr_stmt pos:start="3890:5" pos:end="3890:43"><expr pos:start="3890:5" pos:end="3890:42"><call pos:start="3890:5" pos:end="3890:42"><name pos:start="3890:5" pos:end="3890:13">memzero_s</name><argument_list pos:start="3890:14" pos:end="3890:42">(<argument pos:start="3890:15" pos:end="3890:24"><expr pos:start="3890:15" pos:end="3890:24"><name pos:start="3890:15" pos:end="3890:24">canned_uri</name></expr></argument>, <argument pos:start="3890:27" pos:end="3890:41"><expr pos:start="3890:27" pos:end="3890:41"><name pos:start="3890:27" pos:end="3890:41">EST_URI_MAX_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="3891:5" pos:end="3891:63"><expr pos:start="3891:5" pos:end="3891:62"><call pos:start="3891:5" pos:end="3891:62"><name pos:start="3891:5" pos:end="3891:12">strcpy_s</name><argument_list pos:start="3891:13" pos:end="3891:62">(<argument pos:start="3891:14" pos:end="3891:23"><expr pos:start="3891:14" pos:end="3891:23"><name pos:start="3891:14" pos:end="3891:23">canned_uri</name></expr></argument>, <argument pos:start="3891:26" pos:end="3891:40"><expr pos:start="3891:26" pos:end="3891:40"><name pos:start="3891:26" pos:end="3891:40">EST_URI_MAX_LEN</name></expr></argument>, <argument pos:start="3891:43" pos:end="3891:61"><expr pos:start="3891:43" pos:end="3891:61"><literal type="string" pos:start="3891:43" pos:end="3891:61">"/.well-known/est/"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt pos:start="3892:5" pos:end="3892:52"><expr pos:start="3892:5" pos:end="3892:51"><call pos:start="3892:5" pos:end="3892:51"><name pos:start="3892:5" pos:end="3892:12">strcat_s</name><argument_list pos:start="3892:13" pos:end="3892:51">(<argument pos:start="3892:14" pos:end="3892:23"><expr pos:start="3892:14" pos:end="3892:23"><name pos:start="3892:14" pos:end="3892:23">canned_uri</name></expr></argument>, <argument pos:start="3892:26" pos:end="3892:40"><expr pos:start="3892:26" pos:end="3892:40"><name pos:start="3892:26" pos:end="3892:40">EST_URI_MAX_LEN</name></expr></argument>, <argument pos:start="3892:43" pos:end="3892:50"><expr pos:start="3892:43" pos:end="3892:50"><name pos:start="3892:43" pos:end="3892:50">path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <expr_stmt pos:start="3894:5" pos:end="3894:28"><expr pos:start="3894:5" pos:end="3894:27"><name pos:start="3894:5" pos:end="3894:13"><name pos:start="3894:5" pos:end="3894:9">state</name><operator pos:start="3894:10" pos:end="3894:10">.</operator><name pos:start="3894:11" pos:end="3894:13">uri</name></name> <operator pos:start="3894:15" pos:end="3894:15">=</operator> <operator pos:start="3894:17" pos:end="3894:17">&amp;</operator><name pos:start="3894:18" pos:end="3894:27">parsed_uri</name></expr>;</expr_stmt>
    <expr_stmt pos:start="3895:5" pos:end="3895:51"><expr pos:start="3895:5" pos:end="3895:50"><name pos:start="3895:5" pos:end="3895:15">uriparse_rc</name> <operator pos:start="3895:17" pos:end="3895:17">=</operator> <call pos:start="3895:19" pos:end="3895:50"><name pos:start="3895:19" pos:end="3895:30">uriParseUriA</name><argument_list pos:start="3895:31" pos:end="3895:50">(<argument pos:start="3895:32" pos:end="3895:37"><expr pos:start="3895:32" pos:end="3895:37"><operator pos:start="3895:32" pos:end="3895:32">&amp;</operator><name pos:start="3895:33" pos:end="3895:37">state</name></expr></argument>, <argument pos:start="3895:40" pos:end="3895:49"><expr pos:start="3895:40" pos:end="3895:49"><name pos:start="3895:40" pos:end="3895:49">canned_uri</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if_stmt pos:start="3896:5" pos:end="3899:5"><if pos:start="3896:5" pos:end="3899:5">if <condition pos:start="3896:8" pos:end="3896:35">(<expr pos:start="3896:9" pos:end="3896:34"><name pos:start="3896:9" pos:end="3896:19">uriparse_rc</name> <operator pos:start="3896:21" pos:end="3896:22">!=</operator> <name pos:start="3896:24" pos:end="3896:34">URI_SUCCESS</name></expr>)</condition> <block pos:start="3896:37" pos:end="3899:5">{<block_content pos:start="3897:9" pos:end="3898:51">
        <expr_stmt pos:start="3897:9" pos:end="3897:38"><expr pos:start="3897:9" pos:end="3897:37"><call pos:start="3897:9" pos:end="3897:37"><name pos:start="3897:9" pos:end="3897:26">uriFreeUriMembersA</name><argument_list pos:start="3897:27" pos:end="3897:37">(<argument pos:start="3897:28" pos:end="3897:36"><expr pos:start="3897:28" pos:end="3897:36"><name pos:start="3897:28" pos:end="3897:36"><name pos:start="3897:28" pos:end="3897:32">state</name><operator pos:start="3897:33" pos:end="3897:33">.</operator><name pos:start="3897:34" pos:end="3897:36">uri</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3898:9" pos:end="3898:51">return <expr pos:start="3898:16" pos:end="3898:50"><operator pos:start="3898:16" pos:end="3898:16">(</operator><name pos:start="3898:17" pos:end="3898:49">EST_ERR_HTTP_INVALID_PATH_SEGMENT</name><operator pos:start="3898:50" pos:end="3898:50">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="3901:5" pos:end="3901:34"><expr pos:start="3901:5" pos:end="3901:33"><name pos:start="3901:5" pos:end="3901:11">cur_seg</name> <operator pos:start="3901:13" pos:end="3901:13">=</operator> <name pos:start="3901:15" pos:end="3901:33"><name pos:start="3901:15" pos:end="3901:24">parsed_uri</name><operator pos:start="3901:25" pos:end="3901:25">.</operator><name pos:start="3901:26" pos:end="3901:33">pathHead</name></name></expr>;</expr_stmt>
    <if_stmt pos:start="3902:5" pos:end="3906:5"><if pos:start="3902:5" pos:end="3906:5">if <condition pos:start="3902:8" pos:end="3902:24">(<expr pos:start="3902:9" pos:end="3902:23"><name pos:start="3902:9" pos:end="3902:15">cur_seg</name> <operator pos:start="3902:17" pos:end="3902:18">==</operator> <name pos:start="3902:20" pos:end="3902:23">NULL</name></expr>)</condition> <block pos:start="3902:26" pos:end="3906:5">{<block_content pos:start="3903:9" pos:end="3905:51">
        <expr_stmt pos:start="3903:9" pos:end="3903:64"><expr pos:start="3903:9" pos:end="3903:63"><call pos:start="3903:9" pos:end="3903:63"><name pos:start="3903:9" pos:end="3903:19">EST_LOG_ERR</name><argument_list pos:start="3903:20" pos:end="3903:63">(<argument pos:start="3903:21" pos:end="3903:62"><expr pos:start="3903:21" pos:end="3903:62"><literal type="string" pos:start="3903:21" pos:end="3903:62">"No valid path segment in supplied string"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="3904:9" pos:end="3904:38"><expr pos:start="3904:9" pos:end="3904:37"><call pos:start="3904:9" pos:end="3904:37"><name pos:start="3904:9" pos:end="3904:26">uriFreeUriMembersA</name><argument_list pos:start="3904:27" pos:end="3904:37">(<argument pos:start="3904:28" pos:end="3904:36"><expr pos:start="3904:28" pos:end="3904:36"><name pos:start="3904:28" pos:end="3904:36"><name pos:start="3904:28" pos:end="3904:32">state</name><operator pos:start="3904:33" pos:end="3904:33">.</operator><name pos:start="3904:34" pos:end="3904:36">uri</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3905:9" pos:end="3905:51">return <expr pos:start="3905:16" pos:end="3905:50"><operator pos:start="3905:16" pos:end="3905:16">(</operator><name pos:start="3905:17" pos:end="3905:49">EST_ERR_HTTP_INVALID_PATH_SEGMENT</name><operator pos:start="3905:50" pos:end="3905:50">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="3908:5" pos:end="3908:34"><expr pos:start="3908:5" pos:end="3908:33"><name pos:start="3908:5" pos:end="3908:11">cur_seg</name> <operator pos:start="3908:13" pos:end="3908:13">=</operator> <name pos:start="3908:15" pos:end="3908:33"><name pos:start="3908:15" pos:end="3908:21">cur_seg</name><operator pos:start="3908:22" pos:end="3908:23">-&gt;</operator><name pos:start="3908:24" pos:end="3908:27">next</name><operator pos:start="3908:28" pos:end="3908:29">-&gt;</operator><name pos:start="3908:30" pos:end="3908:33">next</name></name></expr>;</expr_stmt>
    <expr_stmt pos:start="3909:5" pos:end="3909:46"><expr pos:start="3909:5" pos:end="3909:45"><name pos:start="3909:5" pos:end="3909:15">cur_seg_str</name> <operator pos:start="3909:17" pos:end="3909:17">=</operator> <operator pos:start="3909:19" pos:end="3909:19">(</operator><name pos:start="3909:20" pos:end="3909:23">char</name> <operator pos:start="3909:25" pos:end="3909:25">*</operator><operator pos:start="3909:26" pos:end="3909:26">)</operator><name pos:start="3909:27" pos:end="3909:45"><name pos:start="3909:27" pos:end="3909:33">cur_seg</name><operator pos:start="3909:34" pos:end="3909:35">-&gt;</operator><name pos:start="3909:36" pos:end="3909:39">text</name><operator pos:start="3909:40" pos:end="3909:40">.</operator><name pos:start="3909:41" pos:end="3909:45">first</name></name></expr>;</expr_stmt>
    <expr_stmt pos:start="3910:5" pos:end="3910:49"><expr pos:start="3910:5" pos:end="3910:48"><name pos:start="3910:5" pos:end="3910:13">operation</name> <operator pos:start="3910:15" pos:end="3910:15">=</operator> <call pos:start="3910:17" pos:end="3910:48"><name pos:start="3910:17" pos:end="3910:35">est_parse_operation</name><argument_list pos:start="3910:36" pos:end="3910:48">(<argument pos:start="3910:37" pos:end="3910:47"><expr pos:start="3910:37" pos:end="3910:47"><name pos:start="3910:37" pos:end="3910:47">cur_seg_str</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <comment type="block" pos:start="3911:9" pos:end="3916:11">/*
         * look to see if the operation path comes next:
         * cacerts, csrattrs, simpleenroll, simplereenroll.
         * If any of the operations occur in this path segment
         * string, then this is a problem.
         */</comment>
    <if_stmt pos:start="3917:5" pos:end="3921:5"><if pos:start="3917:5" pos:end="3921:5">if <condition pos:start="3917:8" pos:end="3917:32">(<expr pos:start="3917:9" pos:end="3917:31"><name pos:start="3917:9" pos:end="3917:17">operation</name> <operator pos:start="3917:19" pos:end="3917:20">!=</operator> <name pos:start="3917:22" pos:end="3917:31">EST_OP_MAX</name></expr>)</condition> <block pos:start="3917:34" pos:end="3921:5">{<block_content pos:start="3918:9" pos:end="3920:51">
        <expr_stmt pos:start="3918:9" pos:end="3918:116"><expr pos:start="3918:9" pos:end="3918:115"><call pos:start="3918:9" pos:end="3918:115"><name pos:start="3918:9" pos:end="3918:19">EST_LOG_ERR</name><argument_list pos:start="3918:20" pos:end="3918:115">(<argument pos:start="3918:21" pos:end="3918:101"><expr pos:start="3918:21" pos:end="3918:101"><literal type="string" pos:start="3918:21" pos:end="3918:101">"Path segment string contains an operation value. path segment passed in =  %s\n"</literal></expr></argument>, <argument pos:start="3918:104" pos:end="3918:114"><expr pos:start="3918:104" pos:end="3918:114"><name pos:start="3918:104" pos:end="3918:114">cur_seg_str</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="3919:9" pos:end="3919:38"><expr pos:start="3919:9" pos:end="3919:37"><call pos:start="3919:9" pos:end="3919:37"><name pos:start="3919:9" pos:end="3919:26">uriFreeUriMembersA</name><argument_list pos:start="3919:27" pos:end="3919:37">(<argument pos:start="3919:28" pos:end="3919:36"><expr pos:start="3919:28" pos:end="3919:36"><name pos:start="3919:28" pos:end="3919:36"><name pos:start="3919:28" pos:end="3919:32">state</name><operator pos:start="3919:33" pos:end="3919:33">.</operator><name pos:start="3919:34" pos:end="3919:36">uri</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="3920:9" pos:end="3920:51">return <expr pos:start="3920:16" pos:end="3920:50"><operator pos:start="3920:16" pos:end="3920:16">(</operator><name pos:start="3920:17" pos:end="3920:49">EST_ERR_HTTP_INVALID_PATH_SEGMENT</name><operator pos:start="3920:50" pos:end="3920:50">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <comment type="block" pos:start="3923:5" pos:end="3925:7">/*
     * Look to see if there are multiple segments
     */</comment>
    <if_stmt pos:start="3926:5" pos:end="3930:5"><if pos:start="3926:5" pos:end="3930:5">if <condition pos:start="3926:8" pos:end="3926:76">(<expr pos:start="3926:9" pos:end="3926:75"><operator pos:start="3926:9" pos:end="3926:9">(</operator><name pos:start="3926:10" pos:end="3926:13">char</name> <operator pos:start="3926:15" pos:end="3926:15">*</operator><operator pos:start="3926:16" pos:end="3926:16">)</operator><name pos:start="3926:17" pos:end="3926:29"><name pos:start="3926:17" pos:end="3926:23">cur_seg</name><operator pos:start="3926:24" pos:end="3926:25">-&gt;</operator><name pos:start="3926:26" pos:end="3926:29">next</name></name> <operator pos:start="3926:31" pos:end="3926:32">!=</operator> <name pos:start="3926:34" pos:end="3926:37">NULL</name> <operator pos:start="3926:39" pos:end="3926:40">||</operator> <operator pos:start="3926:42" pos:end="3926:42">*</operator><operator pos:start="3926:43" pos:end="3926:43">(</operator><name pos:start="3926:44" pos:end="3926:66"><name pos:start="3926:44" pos:end="3926:50">cur_seg</name><operator pos:start="3926:51" pos:end="3926:52">-&gt;</operator><name pos:start="3926:53" pos:end="3926:56">text</name><operator pos:start="3926:57" pos:end="3926:57">.</operator><name pos:start="3926:58" pos:end="3926:66">afterLast</name></name><operator pos:start="3926:67" pos:end="3926:67">)</operator> <operator pos:start="3926:69" pos:end="3926:70">!=</operator> <literal type="char" pos:start="3926:72" pos:end="3926:75">'\0'</literal></expr>)</condition> <block pos:start="3926:78" pos:end="3930:5">{<block_content pos:start="3927:9" pos:end="3929:51">
        <expr_stmt pos:start="3927:9" pos:end="3927:103"><expr pos:start="3927:9" pos:end="3927:102"><call pos:start="3927:9" pos:end="3927:102"><name pos:start="3927:9" pos:end="3927:19">EST_LOG_ERR</name><argument_list pos:start="3927:20" pos:end="3927:102">(<argument pos:start="3927:21" pos:end="3927:101"><expr pos:start="3927:21" pos:end="3927:101"><literal type="string" pos:start="3927:21" pos:end="3927:101">"Path segment string contains multiple path segments or more than a path segment"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt pos:start="3928:9" pos:end="3928:38"><expr pos:start="3928:9" pos:end="3928:37"><call pos:start="3928:9" pos:end="3928:37"><name pos:start="3928:9" pos:end="3928:26">uriFreeUriMembersA</name><argument_list pos:start="3928:27" pos:end="3928:37">(<argument pos:start="3928:28" pos:end="3928:36"><expr pos:start="3928:28" pos:end="3928:36"><name pos:start="3928:28" pos:end="3928:36"><name pos:start="3928:28" pos:end="3928:32">state</name><operator pos:start="3928:33" pos:end="3928:33">.</operator><name pos:start="3928:34" pos:end="3928:36">uri</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>        
        <return pos:start="3929:9" pos:end="3929:51">return <expr pos:start="3929:16" pos:end="3929:50"><operator pos:start="3929:16" pos:end="3929:16">(</operator><name pos:start="3929:17" pos:end="3929:49">EST_ERR_HTTP_INVALID_PATH_SEGMENT</name><operator pos:start="3929:50" pos:end="3929:50">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
    
    <expr_stmt pos:start="3932:5" pos:end="3932:34"><expr pos:start="3932:5" pos:end="3932:33"><call pos:start="3932:5" pos:end="3932:33"><name pos:start="3932:5" pos:end="3932:22">uriFreeUriMembersA</name><argument_list pos:start="3932:23" pos:end="3932:33">(<argument pos:start="3932:24" pos:end="3932:32"><expr pos:start="3932:24" pos:end="3932:32"><name pos:start="3932:24" pos:end="3932:32"><name pos:start="3932:24" pos:end="3932:28">state</name><operator pos:start="3932:29" pos:end="3932:29">.</operator><name pos:start="3932:30" pos:end="3932:32">uri</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>    
    <return pos:start="3933:5" pos:end="3933:26">return <expr pos:start="3933:12" pos:end="3933:25"><operator pos:start="3933:12" pos:end="3933:12">(</operator><name pos:start="3933:13" pos:end="3933:24">EST_ERR_NONE</name><operator pos:start="3933:25" pos:end="3933:25">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="3935:1" pos:end="3957:3">/*! @brief est_client_set_server() is called by the application layer to
     specify the address/port of the EST server. It must be called after
     est_client_init() and prior to issuing any EST commands.
 
    @param ctx Pointer to EST context for a client session
    @param server Name of the EST server to connect to.  The ASCII string
    representing the name of the server is limited to 254 characters
    @param port TCP port on the EST server to connect
    @param path_segment A string containing the optional path segment
    to be added to the URI.  If not used, set to NULL.
 
    @return EST_ERROR
    EST_ERR_NONE - Success.
    EST_ERR_NO_CTX - NULL value passed for EST context
    EST_ERR_INVALID_SERVER_NAME - NULL value passed for EST server name, or
    server name string too long
    EST_ERR_CLIENT_NOT_INITIALIZED - Called before est_client_init()
    EST_ERR_INVALID_PORT_NUM - Invalid port number input, less than zero or
    greater than 65535

    est_client_set_server error checks its input parameters and then stores
    both the hostname and port number into the EST context.
 */</comment>
<function pos:start="3958:1" pos:end="4036:1"><type pos:start="3958:1" pos:end="3958:9"><name pos:start="3958:1" pos:end="3958:9">EST_ERROR</name></type> <name pos:start="3958:11" pos:end="3958:31">est_client_set_server</name> <parameter_list pos:start="3958:33" pos:end="3959:52">(<parameter pos:start="3958:34" pos:end="3958:45"><decl pos:start="3958:34" pos:end="3958:45"><type pos:start="3958:34" pos:end="3958:45"><name pos:start="3958:34" pos:end="3958:40">EST_CTX</name> <modifier pos:start="3958:42" pos:end="3958:42">*</modifier></type><name pos:start="3958:43" pos:end="3958:45">ctx</name></decl></parameter>, <parameter pos:start="3958:48" pos:end="3958:65"><decl pos:start="3958:48" pos:end="3958:65"><type pos:start="3958:48" pos:end="3958:65"><specifier pos:start="3958:48" pos:end="3958:52">const</specifier> <name pos:start="3958:54" pos:end="3958:57">char</name> <modifier pos:start="3958:59" pos:end="3958:59">*</modifier></type><name pos:start="3958:60" pos:end="3958:65">server</name></decl></parameter>, <parameter pos:start="3958:68" pos:end="3958:75"><decl pos:start="3958:68" pos:end="3958:75"><type pos:start="3958:68" pos:end="3958:75"><name pos:start="3958:68" pos:end="3958:70">int</name></type> <name pos:start="3958:72" pos:end="3958:75">port</name></decl></parameter>,
                                 <parameter pos:start="3959:34" pos:end="3959:51"><decl pos:start="3959:34" pos:end="3959:51"><type pos:start="3959:34" pos:end="3959:51"><name pos:start="3959:34" pos:end="3959:37">char</name> <modifier pos:start="3959:39" pos:end="3959:39">*</modifier></type><name pos:start="3959:40" pos:end="3959:51">path_segment</name></decl></parameter>)</parameter_list>
<block pos:start="3960:1" pos:end="4036:1">{<block_content pos:start="3962:5" pos:end="4035:24">
    
    <if_stmt pos:start="3962:5" pos:end="3964:5"><if pos:start="3962:5" pos:end="3964:5">if <condition pos:start="3962:8" pos:end="3962:13">(<expr pos:start="3962:9" pos:end="3962:12"><operator pos:start="3962:9" pos:end="3962:9">!</operator><name pos:start="3962:10" pos:end="3962:12">ctx</name></expr>)</condition> <block pos:start="3962:15" pos:end="3964:5">{<block_content pos:start="3963:9" pos:end="3963:30">
        <return pos:start="3963:9" pos:end="3963:30">return <expr pos:start="3963:16" pos:end="3963:29"><name pos:start="3963:16" pos:end="3963:29">EST_ERR_NO_CTX</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3966:5" pos:end="3968:5"><if pos:start="3966:5" pos:end="3968:5">if <condition pos:start="3966:8" pos:end="3966:37">(<expr pos:start="3966:9" pos:end="3966:36"><operator pos:start="3966:9" pos:end="3966:9">!</operator><name pos:start="3966:10" pos:end="3966:36"><name pos:start="3966:10" pos:end="3966:12">ctx</name><operator pos:start="3966:13" pos:end="3966:14">-&gt;</operator><name pos:start="3966:15" pos:end="3966:36">est_client_initialized</name></name></expr>)</condition> <block pos:start="3966:39" pos:end="3968:5">{<block_content pos:start="3967:9" pos:end="3967:46">
        <return pos:start="3967:9" pos:end="3967:46">return <expr pos:start="3967:16" pos:end="3967:45"><name pos:start="3967:16" pos:end="3967:45">EST_ERR_CLIENT_NOT_INITIALIZED</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="3970:5" pos:end="3972:5"><if pos:start="3970:5" pos:end="3972:5">if <condition pos:start="3970:8" pos:end="3970:23">(<expr pos:start="3970:9" pos:end="3970:22"><name pos:start="3970:9" pos:end="3970:14">server</name> <operator pos:start="3970:16" pos:end="3970:17">==</operator> <name pos:start="3970:19" pos:end="3970:22">NULL</name></expr>)</condition> <block pos:start="3970:25" pos:end="3972:5">{<block_content pos:start="3971:9" pos:end="3971:43">
        <return pos:start="3971:9" pos:end="3971:43">return <expr pos:start="3971:16" pos:end="3971:42"><name pos:start="3971:16" pos:end="3971:42">EST_ERR_INVALID_SERVER_NAME</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    
    <if_stmt pos:start="3974:5" pos:end="3976:5"><if pos:start="3974:5" pos:end="3976:5">if <condition pos:start="3974:8" pos:end="3974:34">(<expr pos:start="3974:9" pos:end="3974:33"><name pos:start="3974:9" pos:end="3974:12">port</name> <operator pos:start="3974:14" pos:end="3974:15">&lt;=</operator> <literal type="number" pos:start="3974:17" pos:end="3974:17">0</literal> <operator pos:start="3974:19" pos:end="3974:20">||</operator> <name pos:start="3974:22" pos:end="3974:25">port</name> <operator pos:start="3974:27" pos:end="3974:27">&gt;</operator> <literal type="number" pos:start="3974:29" pos:end="3974:33">65535</literal></expr>)</condition> <block pos:start="3974:36" pos:end="3976:5">{<block_content pos:start="3975:9" pos:end="3975:40">
        <return pos:start="3975:9" pos:end="3975:40">return <expr pos:start="3975:16" pos:end="3975:39"><name pos:start="3975:16" pos:end="3975:39">EST_ERR_INVALID_PORT_NUM</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    
    <if_stmt pos:start="3978:5" pos:end="3981:5"><if pos:start="3978:5" pos:end="3981:5">if <condition pos:start="3978:8" pos:end="3979:49">(<expr pos:start="3978:9" pos:end="3979:48"><name pos:start="3978:9" pos:end="3978:11">EOK</name> <operator pos:start="3978:13" pos:end="3978:14">!=</operator> <call pos:start="3978:16" pos:end="3979:48"><name pos:start="3978:16" pos:end="3978:24">strncpy_s</name><argument_list pos:start="3978:25" pos:end="3979:48">(<argument pos:start="3978:26" pos:end="3978:40"><expr pos:start="3978:26" pos:end="3978:40"><name pos:start="3978:26" pos:end="3978:40"><name pos:start="3978:26" pos:end="3978:28">ctx</name><operator pos:start="3978:29" pos:end="3978:30">-&gt;</operator><name pos:start="3978:31" pos:end="3978:40">est_server</name></name></expr></argument>, <argument pos:start="3978:43" pos:end="3978:64"><expr pos:start="3978:43" pos:end="3978:64"><name pos:start="3978:43" pos:end="3978:64">EST_MAX_SERVERNAME_LEN</name></expr></argument>, <argument pos:start="3978:67" pos:end="3978:72"><expr pos:start="3978:67" pos:end="3978:72"><name pos:start="3978:67" pos:end="3978:72">server</name></expr></argument>,
                         <argument pos:start="3979:26" pos:end="3979:47"><expr pos:start="3979:26" pos:end="3979:47"><name pos:start="3979:26" pos:end="3979:47">EST_MAX_SERVERNAME_LEN</name></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="3979:51" pos:end="3981:5">{<block_content pos:start="3980:9" pos:end="3980:43">
        <return pos:start="3980:9" pos:end="3980:43">return <expr pos:start="3980:16" pos:end="3980:42"><name pos:start="3980:16" pos:end="3980:42">EST_ERR_INVALID_SERVER_NAME</name></expr>;</return>
    </block_content>}</block></if></if_stmt>   

    <expr_stmt pos:start="3983:5" pos:end="3986:0"><expr pos:start="3983:5" pos:end="3983:28"><name pos:start="3983:5" pos:end="3983:21"><name pos:start="3983:5" pos:end="3983:7">ctx</name><operator pos:start="3983:8" pos:end="3983:9">-&gt;</operator><name pos:start="3983:10" pos:end="3983:21">est_port_num</name></name> <operator pos:start="3983:23" pos:end="3983:23">=</operator> <name pos:start="3983:25" pos:end="3983:28">port</name></expr>;</expr_stmt>

<cpp:ifdef pos:start="3985:1" pos:end="3985:21">#<cpp:directive pos:start="3985:2" pos:end="3985:6">ifdef</cpp:directive> <name pos:start="3985:8" pos:end="3985:21">HAVE_URIPARSER</name></cpp:ifdef>
    <block pos:start="3986:5" pos:end="4024:0">{<block_content pos:start="3987:9" pos:end="4021:9">
        <decl_stmt pos:start="3987:9" pos:end="3987:29"><decl pos:start="3987:9" pos:end="3987:28"><type pos:start="3987:9" pos:end="3987:11"><name pos:start="3987:9" pos:end="3987:11">int</name></type> <name pos:start="3987:13" pos:end="3987:28">path_segment_len</name></decl>;</decl_stmt>
        <decl_stmt pos:start="3988:9" pos:end="3988:21"><decl pos:start="3988:9" pos:end="3988:20"><type pos:start="3988:9" pos:end="3988:17"><name pos:start="3988:9" pos:end="3988:17">EST_ERROR</name></type> <name pos:start="3988:19" pos:end="3988:20">rc</name></decl>;</decl_stmt>

        <if_stmt pos:start="3990:9" pos:end="4021:9"><if pos:start="3990:9" pos:end="4021:9">if <condition pos:start="3990:12" pos:end="3990:33">(<expr pos:start="3990:13" pos:end="3990:32"><name pos:start="3990:13" pos:end="3990:24">path_segment</name> <operator pos:start="3990:26" pos:end="3990:27">!=</operator> <name pos:start="3990:29" pos:end="3990:32">NULL</name></expr>)</condition> <block pos:start="3990:35" pos:end="4021:9">{<block_content pos:start="3992:13" pos:end="4020:13">

            <if_stmt pos:start="3992:13" pos:end="3994:13"><if pos:start="3992:13" pos:end="3994:13">if <condition pos:start="3992:16" pos:end="3992:38">(<expr pos:start="3992:17" pos:end="3992:37"><operator pos:start="3992:17" pos:end="3992:17">*</operator><name pos:start="3992:18" pos:end="3992:29">path_segment</name> <operator pos:start="3992:31" pos:end="3992:32">==</operator> <literal type="char" pos:start="3992:34" pos:end="3992:37">'\0'</literal></expr>)</condition> <block pos:start="3992:40" pos:end="3994:13">{<block_content pos:start="3993:17" pos:end="3993:57">
                <return pos:start="3993:17" pos:end="3993:57">return <expr pos:start="3993:24" pos:end="3993:56"><name pos:start="3993:24" pos:end="3993:56">EST_ERR_HTTP_INVALID_PATH_SEGMENT</name></expr>;</return>
            </block_content>}</block></if></if_stmt>
            
            <comment type="block" pos:start="3996:13" pos:end="3998:15">/*
             * Make sure it's not too long
             */</comment>
            <expr_stmt pos:start="3999:13" pos:end="3999:83"><expr pos:start="3999:13" pos:end="3999:82"><name pos:start="3999:13" pos:end="3999:28">path_segment_len</name> <operator pos:start="3999:30" pos:end="3999:30">=</operator> <call pos:start="3999:32" pos:end="3999:82"><name pos:start="3999:32" pos:end="3999:40">strnlen_s</name><argument_list pos:start="3999:41" pos:end="3999:82">(<argument pos:start="3999:42" pos:end="3999:53"><expr pos:start="3999:42" pos:end="3999:53"><name pos:start="3999:42" pos:end="3999:53">path_segment</name></expr></argument>, <argument pos:start="3999:56" pos:end="3999:81"><expr pos:start="3999:56" pos:end="3999:81"><name pos:start="3999:56" pos:end="3999:79">EST_MAX_PATH_SEGMENT_LEN</name><operator pos:start="3999:80" pos:end="3999:80">+</operator><literal type="number" pos:start="3999:81" pos:end="3999:81">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <if_stmt pos:start="4000:13" pos:end="4002:13"><if pos:start="4000:13" pos:end="4002:13">if <condition pos:start="4000:16" pos:end="4000:60">(<expr pos:start="4000:17" pos:end="4000:59"><name pos:start="4000:17" pos:end="4000:32">path_segment_len</name> <operator pos:start="4000:34" pos:end="4000:34">&gt;</operator> <name pos:start="4000:36" pos:end="4000:59">EST_MAX_PATH_SEGMENT_LEN</name></expr>)</condition> <block pos:start="4000:62" pos:end="4002:13">{<block_content pos:start="4001:17" pos:end="4001:57">
                <return pos:start="4001:17" pos:end="4001:57">return <expr pos:start="4001:24" pos:end="4001:56"><name pos:start="4001:24" pos:end="4001:56">EST_ERR_HTTP_INVALID_PATH_SEGMENT</name></expr>;</return>
            </block_content>}</block></if></if_stmt>

            <comment type="block" pos:start="4004:13" pos:end="4006:15">/*
             * Validate the incoming path segment string
             */</comment>
            <expr_stmt pos:start="4007:13" pos:end="4007:57"><expr pos:start="4007:13" pos:end="4007:56"><name pos:start="4007:13" pos:end="4007:14">rc</name> <operator pos:start="4007:16" pos:end="4007:16">=</operator> <call pos:start="4007:18" pos:end="4007:56"><name pos:start="4007:18" pos:end="4007:42">est_client_parse_path_seg</name><argument_list pos:start="4007:43" pos:end="4007:56">(<argument pos:start="4007:44" pos:end="4007:55"><expr pos:start="4007:44" pos:end="4007:55"><name pos:start="4007:44" pos:end="4007:55">path_segment</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <if_stmt pos:start="4008:13" pos:end="4011:13"><if pos:start="4008:13" pos:end="4011:13">if <condition pos:start="4008:16" pos:end="4008:35">(<expr pos:start="4008:17" pos:end="4008:34"><name pos:start="4008:17" pos:end="4008:18">rc</name> <operator pos:start="4008:20" pos:end="4008:21">!=</operator> <name pos:start="4008:23" pos:end="4008:34">EST_ERR_NONE</name></expr>)</condition> <block pos:start="4008:37" pos:end="4011:13">{<block_content pos:start="4009:17" pos:end="4010:28">
                <expr_stmt pos:start="4009:17" pos:end="4009:63"><expr pos:start="4009:17" pos:end="4009:62"><call pos:start="4009:17" pos:end="4009:62"><name pos:start="4009:17" pos:end="4009:27">EST_LOG_ERR</name><argument_list pos:start="4009:28" pos:end="4009:62">(<argument pos:start="4009:29" pos:end="4009:61"><expr pos:start="4009:29" pos:end="4009:61"><literal type="string" pos:start="4009:29" pos:end="4009:61">"path segment failed validation."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <return pos:start="4010:17" pos:end="4010:28">return <expr pos:start="4010:24" pos:end="4010:27"><operator pos:start="4010:24" pos:end="4010:24">(</operator><name pos:start="4010:25" pos:end="4010:26">rc</name><operator pos:start="4010:27" pos:end="4010:27">)</operator></expr>;</return>
            </block_content>}</block></if></if_stmt>

            <comment type="block" pos:start="4013:13" pos:end="4015:15">/*
             * valid.  store it away in the context
             */</comment>
            <expr_stmt pos:start="4016:13" pos:end="4016:77"><expr pos:start="4016:13" pos:end="4016:76"><name pos:start="4016:13" pos:end="4016:14">rc</name> <operator pos:start="4016:16" pos:end="4016:16">=</operator> <call pos:start="4016:18" pos:end="4016:76"><name pos:start="4016:18" pos:end="4016:39">est_store_path_segment</name><argument_list pos:start="4016:40" pos:end="4016:76">(<argument pos:start="4016:41" pos:end="4016:43"><expr pos:start="4016:41" pos:end="4016:43"><name pos:start="4016:41" pos:end="4016:43">ctx</name></expr></argument>, <argument pos:start="4016:46" pos:end="4016:57"><expr pos:start="4016:46" pos:end="4016:57"><name pos:start="4016:46" pos:end="4016:57">path_segment</name></expr></argument>, <argument pos:start="4016:60" pos:end="4016:75"><expr pos:start="4016:60" pos:end="4016:75"><name pos:start="4016:60" pos:end="4016:75">path_segment_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <if_stmt pos:start="4017:13" pos:end="4020:13"><if pos:start="4017:13" pos:end="4020:13">if <condition pos:start="4017:16" pos:end="4017:35">(<expr pos:start="4017:17" pos:end="4017:34"><name pos:start="4017:17" pos:end="4017:18">rc</name> <operator pos:start="4017:20" pos:end="4017:21">!=</operator> <name pos:start="4017:23" pos:end="4017:34">EST_ERR_NONE</name></expr>)</condition> <block pos:start="4017:37" pos:end="4020:13">{<block_content pos:start="4018:17" pos:end="4019:28">
                <expr_stmt pos:start="4018:17" pos:end="4018:65"><expr pos:start="4018:17" pos:end="4018:64"><call pos:start="4018:17" pos:end="4018:64"><name pos:start="4018:17" pos:end="4018:27">EST_LOG_ERR</name><argument_list pos:start="4018:28" pos:end="4018:64">(<argument pos:start="4018:29" pos:end="4018:63"><expr pos:start="4018:29" pos:end="4018:63"><literal type="string" pos:start="4018:29" pos:end="4018:63">"Failed to store URI path segment."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <return pos:start="4019:17" pos:end="4019:28">return <expr pos:start="4019:24" pos:end="4019:27"><operator pos:start="4019:24" pos:end="4019:24">(</operator><name pos:start="4019:25" pos:end="4019:26">rc</name><operator pos:start="4019:27" pos:end="4019:27">)</operator></expr>;</return>
            </block_content>}</block></if></if_stmt>        
        </block_content>}</block></if></if_stmt>
    </block_content>}</block>
<cpp:else pos:start="4023:1" pos:end="4023:5">#<cpp:directive pos:start="4023:2" pos:end="4023:5">else</cpp:directive></cpp:else>
    <block pos:start="4024:5" pos:end="4035:0">{<block_content pos:start="4029:9" pos:end="4032:9">
        <comment type="block" pos:start="4025:9" pos:end="4028:11">/*
         * If no uriparser support, then we cannot support
         * a path segment being passed in
         */</comment>
        <if_stmt pos:start="4029:9" pos:end="4032:9"><if pos:start="4029:9" pos:end="4032:9">if <condition pos:start="4029:12" pos:end="4029:25">(<expr pos:start="4029:13" pos:end="4029:24"><name pos:start="4029:13" pos:end="4029:24">path_segment</name></expr>)</condition> <block pos:start="4029:27" pos:end="4032:9">{<block_content pos:start="4030:13" pos:end="4031:59">
            <expr_stmt pos:start="4030:13" pos:end="4030:87"><expr pos:start="4030:13" pos:end="4030:86"><call pos:start="4030:13" pos:end="4030:86"><name pos:start="4030:13" pos:end="4030:23">EST_LOG_ERR</name><argument_list pos:start="4030:24" pos:end="4030:86">(<argument pos:start="4030:25" pos:end="4030:85"><expr pos:start="4030:25" pos:end="4030:85"><literal type="string" pos:start="4030:25" pos:end="4030:85">"Use of path segments not supported in this build of libEST."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return pos:start="4031:13" pos:end="4031:59">return <expr pos:start="4031:20" pos:end="4031:58"><name pos:start="4031:20" pos:end="4031:58">EST_ERR_HTTP_PATH_SEGMENT_NOT_SUPPORTED</name></expr>;</return>
        </block_content>}</block></if></if_stmt>  
    </block_content>}</block>
<cpp:endif pos:start="4034:1" pos:end="4034:6">#<cpp:directive pos:start="4034:2" pos:end="4034:6">endif</cpp:directive></cpp:endif>
    <return pos:start="4035:5" pos:end="4035:24">return <expr pos:start="4035:12" pos:end="4035:23"><name pos:start="4035:12" pos:end="4035:23">EST_ERR_NONE</name></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="4037:1" pos:end="4070:3">/*! @brief est_client_set_proxy() is called by the application layer to
    specify the proxy to the EST server. It must be called after
    est_client_init() and prior to issuing any EST commands.

    @param ctx Pointer to EST context for a client session
    @param proxy_proto Proxy protocol
    @param proxy_server Name of the proxy server to connect to.  The ASCII string
    representing the name of the server is limited to 254 characters (EST_MAX_SERVERNAME_LEN)
    @param port TCP port on the proxy server to connect
    @param proxy_auth Proxy authentication method
    @param username Username to use to authenticate with the proxy
    @param password Password to use to authenticate with the proxy

    @return EST_ERROR
    EST_ERR_NONE - Success.
    EST_ERR_NO_CTX - NULL value passed for EST context
    EST_ERR_INVALID_SERVER_NAME - NULL value passed for EST server name, or
    server name string too long
    EST_ERR_INVALID_PORT_NUM - port num to proxy server is invalid
    EST_ERR_CLIENT_NOT_INITIALIZED - Called before est_client_init()
    EST_ERR_INVALID_PARAMETERS - NULL value passed for either username or password
    OR username or password is too long
    EST_ERR_CLIENT_PROXY_MODE_NOT_SUPPORTED - client proxy mode is only supported when
    built with libcurl support
    EST_ERR_INVALID_CLIENT_PROXY_PROTOCOL - An invalid proxy protocol has been specified 
    
    est_client_set_proxy error checks its input parameters and then stores
    the proxy information into the EST context.

    NOTE: HTTP proxy tunnelling is not supported by libEST in server mode.
    If configuring libEST in client mode to communicate with libEST in
    server mode, then EST_CLIENT_PROXY_HTTP_NOTUNNEL must be specified
    for the proxy protocol.
 */</comment>
<function pos:start="4071:1" pos:end="4160:1"><type pos:start="4071:1" pos:end="4071:9"><name pos:start="4071:1" pos:end="4071:9">EST_ERROR</name></type> <name pos:start="4071:11" pos:end="4071:30">est_client_set_proxy</name> <parameter_list pos:start="4071:32" pos:end="4074:53">(<parameter pos:start="4071:33" pos:end="4071:44"><decl pos:start="4071:33" pos:end="4071:44"><type pos:start="4071:33" pos:end="4071:44"><name pos:start="4071:33" pos:end="4071:39">EST_CTX</name> <modifier pos:start="4071:41" pos:end="4071:41">*</modifier></type><name pos:start="4071:42" pos:end="4071:44">ctx</name></decl></parameter>, <parameter pos:start="4071:47" pos:end="4071:80"><decl pos:start="4071:47" pos:end="4071:80"><type pos:start="4071:47" pos:end="4071:80"><name pos:start="4071:47" pos:end="4071:68">EST_CLIENT_PROXY_PROTO</name></type> <name pos:start="4071:70" pos:end="4071:80">proxy_proto</name></decl></parameter>,
                                <parameter pos:start="4072:33" pos:end="4072:56"><decl pos:start="4072:33" pos:end="4072:56"><type pos:start="4072:33" pos:end="4072:56"><specifier pos:start="4072:33" pos:end="4072:37">const</specifier> <name pos:start="4072:39" pos:end="4072:42">char</name> <modifier pos:start="4072:44" pos:end="4072:44">*</modifier></type><name pos:start="4072:45" pos:end="4072:56">proxy_server</name></decl></parameter>, <parameter pos:start="4072:59" pos:end="4072:87"><decl pos:start="4072:59" pos:end="4072:87"><type pos:start="4072:59" pos:end="4072:87"><name pos:start="4072:59" pos:end="4072:66">unsigned</name> <name pos:start="4072:68" pos:end="4072:72">short</name> <name pos:start="4072:74" pos:end="4072:76">int</name></type> <name pos:start="4072:78" pos:end="4072:87">proxy_port</name></decl></parameter>,
                                <parameter pos:start="4073:33" pos:end="4073:55"><decl pos:start="4073:33" pos:end="4073:55"><type pos:start="4073:33" pos:end="4073:55"><name pos:start="4073:33" pos:end="4073:40">unsigned</name> <name pos:start="4073:42" pos:end="4073:44">int</name></type> <name pos:start="4073:46" pos:end="4073:55">proxy_auth</name></decl></parameter>, <parameter pos:start="4073:58" pos:end="4073:77"><decl pos:start="4073:58" pos:end="4073:77"><type pos:start="4073:58" pos:end="4073:77"><specifier pos:start="4073:58" pos:end="4073:62">const</specifier> <name pos:start="4073:64" pos:end="4073:67">char</name> <modifier pos:start="4073:69" pos:end="4073:69">*</modifier></type><name pos:start="4073:70" pos:end="4073:77">username</name></decl></parameter>,
                                <parameter pos:start="4074:33" pos:end="4074:52"><decl pos:start="4074:33" pos:end="4074:52"><type pos:start="4074:33" pos:end="4074:52"><specifier pos:start="4074:33" pos:end="4074:37">const</specifier> <name pos:start="4074:39" pos:end="4074:42">char</name> <modifier pos:start="4074:44" pos:end="4074:44">*</modifier></type><name pos:start="4074:45" pos:end="4074:52">password</name></decl></parameter>)</parameter_list>
<block pos:start="4075:1" pos:end="4160:1">{<block_content pos:start="4077:5" pos:end="4160:0">
<cpp:ifdef pos:start="4076:1" pos:end="4076:19">#<cpp:directive pos:start="4076:2" pos:end="4076:6">ifdef</cpp:directive> <name pos:start="4076:8" pos:end="4076:19">HAVE_LIBCURL</name></cpp:ifdef>
    <if_stmt pos:start="4077:5" pos:end="4079:5"><if pos:start="4077:5" pos:end="4079:5">if <condition pos:start="4077:8" pos:end="4077:13">(<expr pos:start="4077:9" pos:end="4077:12"><operator pos:start="4077:9" pos:end="4077:9">!</operator><name pos:start="4077:10" pos:end="4077:12">ctx</name></expr>)</condition> <block pos:start="4077:15" pos:end="4079:5">{<block_content pos:start="4078:9" pos:end="4078:30">
        <return pos:start="4078:9" pos:end="4078:30">return <expr pos:start="4078:16" pos:end="4078:29"><name pos:start="4078:16" pos:end="4078:29">EST_ERR_NO_CTX</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="4081:5" pos:end="4083:5"><if pos:start="4081:5" pos:end="4083:5">if <condition pos:start="4081:8" pos:end="4081:37">(<expr pos:start="4081:9" pos:end="4081:36"><operator pos:start="4081:9" pos:end="4081:9">!</operator><name pos:start="4081:10" pos:end="4081:36"><name pos:start="4081:10" pos:end="4081:12">ctx</name><operator pos:start="4081:13" pos:end="4081:14">-&gt;</operator><name pos:start="4081:15" pos:end="4081:36">est_client_initialized</name></name></expr>)</condition> <block pos:start="4081:39" pos:end="4083:5">{<block_content pos:start="4082:9" pos:end="4082:46">
        <return pos:start="4082:9" pos:end="4082:46">return <expr pos:start="4082:16" pos:end="4082:45"><name pos:start="4082:16" pos:end="4082:45">EST_ERR_CLIENT_NOT_INITIALIZED</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="4085:5" pos:end="4087:5"><if pos:start="4085:5" pos:end="4087:5">if <condition pos:start="4085:8" pos:end="4085:56">(<expr pos:start="4085:9" pos:end="4085:55"><name pos:start="4085:9" pos:end="4085:20">proxy_server</name> <operator pos:start="4085:22" pos:end="4085:23">==</operator> <name pos:start="4085:25" pos:end="4085:28">NULL</name> <operator pos:start="4085:30" pos:end="4085:31">||</operator> <name pos:start="4085:33" pos:end="4085:47"><name pos:start="4085:33" pos:end="4085:44">proxy_server</name><index pos:start="4085:45" pos:end="4085:47">[<expr pos:start="4085:46" pos:end="4085:46"><literal type="number" pos:start="4085:46" pos:end="4085:46">0</literal></expr>]</index></name> <operator pos:start="4085:49" pos:end="4085:50">==</operator> <literal type="char" pos:start="4085:52" pos:end="4085:55">'\0'</literal></expr>)</condition> <block pos:start="4085:58" pos:end="4087:5">{<block_content pos:start="4086:9" pos:end="4086:43">
        <return pos:start="4086:9" pos:end="4086:43">return <expr pos:start="4086:16" pos:end="4086:42"><name pos:start="4086:16" pos:end="4086:42">EST_ERR_INVALID_SERVER_NAME</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="4089:5" pos:end="4091:5"><if pos:start="4089:5" pos:end="4091:5">if <condition pos:start="4089:8" pos:end="4089:83">(<expr pos:start="4089:9" pos:end="4089:82"><name pos:start="4089:9" pos:end="4089:30">EST_MAX_SERVERNAME_LEN</name> <operator pos:start="4089:32" pos:end="4089:32">&lt;</operator> <call pos:start="4089:34" pos:end="4089:82"><name pos:start="4089:34" pos:end="4089:42">strnlen_s</name><argument_list pos:start="4089:43" pos:end="4089:82">(<argument pos:start="4089:44" pos:end="4089:55"><expr pos:start="4089:44" pos:end="4089:55"><name pos:start="4089:44" pos:end="4089:55">proxy_server</name></expr></argument>, <argument pos:start="4089:58" pos:end="4089:81"><expr pos:start="4089:58" pos:end="4089:81"><name pos:start="4089:58" pos:end="4089:79">EST_MAX_SERVERNAME_LEN</name><operator pos:start="4089:80" pos:end="4089:80">+</operator><literal type="number" pos:start="4089:81" pos:end="4089:81">2</literal></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="4089:85" pos:end="4091:5">{<block_content pos:start="4090:9" pos:end="4090:43">
        <return pos:start="4090:9" pos:end="4090:43">return <expr pos:start="4090:16" pos:end="4090:42"><name pos:start="4090:16" pos:end="4090:42">EST_ERR_INVALID_SERVER_NAME</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="4093:5" pos:end="4093:32"><expr pos:start="4093:5" pos:end="4093:31"><name pos:start="4093:5" pos:end="4093:24"><name pos:start="4093:5" pos:end="4093:7">ctx</name><operator pos:start="4093:8" pos:end="4093:9">-&gt;</operator><name pos:start="4093:10" pos:end="4093:21">proxy_server</name><index pos:start="4093:22" pos:end="4093:24">[<expr pos:start="4093:23" pos:end="4093:23"><literal type="number" pos:start="4093:23" pos:end="4093:23">0</literal></expr>]</index></name> <operator pos:start="4093:26" pos:end="4093:26">=</operator> <literal type="char" pos:start="4093:28" pos:end="4093:31">'\0'</literal></expr>;</expr_stmt>
    <if_stmt pos:start="4094:5" pos:end="4097:5"><if pos:start="4094:5" pos:end="4097:5">if <condition pos:start="4094:8" pos:end="4095:66">(<expr pos:start="4094:9" pos:end="4095:65"><name pos:start="4094:9" pos:end="4094:11">EOK</name> <operator pos:start="4094:13" pos:end="4094:14">!=</operator> <call pos:start="4094:16" pos:end="4095:65"><name pos:start="4094:16" pos:end="4094:24">strncpy_s</name><argument_list pos:start="4094:25" pos:end="4095:65">(<argument pos:start="4094:26" pos:end="4094:42"><expr pos:start="4094:26" pos:end="4094:42"><name pos:start="4094:26" pos:end="4094:42"><name pos:start="4094:26" pos:end="4094:28">ctx</name><operator pos:start="4094:29" pos:end="4094:30">-&gt;</operator><name pos:start="4094:31" pos:end="4094:42">proxy_server</name></name></expr></argument>, <argument pos:start="4094:45" pos:end="4094:69"><expr pos:start="4094:45" pos:end="4094:69"><sizeof pos:start="4094:45" pos:end="4094:69">sizeof<argument_list pos:start="4094:51" pos:end="4094:69">(<argument pos:start="4094:52" pos:end="4094:68"><expr pos:start="4094:52" pos:end="4094:68"><name pos:start="4094:52" pos:end="4094:68"><name pos:start="4094:52" pos:end="4094:54">ctx</name><operator pos:start="4094:55" pos:end="4094:56">-&gt;</operator><name pos:start="4094:57" pos:end="4094:68">proxy_server</name></name></expr></argument>)</argument_list></sizeof></expr></argument>,
                         <argument pos:start="4095:26" pos:end="4095:37"><expr pos:start="4095:26" pos:end="4095:37"><name pos:start="4095:26" pos:end="4095:37">proxy_server</name></expr></argument>, <argument pos:start="4095:40" pos:end="4095:64"><expr pos:start="4095:40" pos:end="4095:64"><sizeof pos:start="4095:40" pos:end="4095:64">sizeof<argument_list pos:start="4095:46" pos:end="4095:64">(<argument pos:start="4095:47" pos:end="4095:63"><expr pos:start="4095:47" pos:end="4095:63"><name pos:start="4095:47" pos:end="4095:63"><name pos:start="4095:47" pos:end="4095:49">ctx</name><operator pos:start="4095:50" pos:end="4095:51">-&gt;</operator><name pos:start="4095:52" pos:end="4095:63">proxy_server</name></name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="4095:68" pos:end="4097:5">{<block_content pos:start="4096:9" pos:end="4096:43">
        <return pos:start="4096:9" pos:end="4096:43">return <expr pos:start="4096:16" pos:end="4096:42"><name pos:start="4096:16" pos:end="4096:42">EST_ERR_INVALID_SERVER_NAME</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="4099:5" pos:end="4101:5"><if pos:start="4099:5" pos:end="4101:5">if <condition pos:start="4099:8" pos:end="4099:46">(<expr pos:start="4099:9" pos:end="4099:45"><name pos:start="4099:9" pos:end="4099:18">proxy_port</name> <operator pos:start="4099:20" pos:end="4099:21">&lt;=</operator> <literal type="number" pos:start="4099:23" pos:end="4099:23">0</literal> <operator pos:start="4099:25" pos:end="4099:26">||</operator> <name pos:start="4099:28" pos:end="4099:37">proxy_port</name> <operator pos:start="4099:39" pos:end="4099:39">&gt;</operator> <literal type="number" pos:start="4099:41" pos:end="4099:45">65535</literal></expr>)</condition> <block pos:start="4099:48" pos:end="4101:5">{<block_content pos:start="4100:9" pos:end="4100:40">
        <return pos:start="4100:9" pos:end="4100:40">return <expr pos:start="4100:16" pos:end="4100:39"><name pos:start="4100:16" pos:end="4100:39">EST_ERR_INVALID_PORT_NUM</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="4102:5" pos:end="4102:33"><expr pos:start="4102:5" pos:end="4102:32"><name pos:start="4102:5" pos:end="4102:19"><name pos:start="4102:5" pos:end="4102:7">ctx</name><operator pos:start="4102:8" pos:end="4102:9">-&gt;</operator><name pos:start="4102:10" pos:end="4102:19">proxy_port</name></name> <operator pos:start="4102:21" pos:end="4102:21">=</operator> <name pos:start="4102:23" pos:end="4102:32">proxy_port</name></expr>;</expr_stmt>
    
    <if_stmt pos:start="4104:5" pos:end="4107:5"><if pos:start="4104:5" pos:end="4107:5">if <condition pos:start="4104:8" pos:end="4105:55">(<expr pos:start="4104:9" pos:end="4105:54"><name pos:start="4104:9" pos:end="4105:21"><name pos:start="4104:9" pos:end="4104:19">proxy_proto</name> <argument_list type="generic" pos:start="4104:21" pos:end="4105:21">&lt; <argument pos:start="4104:23" pos:end="4105:19"><expr pos:start="4104:23" pos:end="4105:19"><name pos:start="4104:23" pos:end="4104:52">EST_CLIENT_PROXY_HTTP_NOTUNNEL</name> <operator pos:start="4104:54" pos:end="4104:55">||</operator>
        <name pos:start="4105:9" pos:end="4105:19">proxy_proto</name></expr></argument> &gt;</argument_list></name> <name pos:start="4105:23" pos:end="4105:54">EST_CLIENT_PROXY_SOCKS5_HOSTNAME</name></expr>)</condition> <block pos:start="4105:57" pos:end="4107:5">{<block_content pos:start="4106:9" pos:end="4106:53">
        <return pos:start="4106:9" pos:end="4106:53">return <expr pos:start="4106:16" pos:end="4106:52"><name pos:start="4106:16" pos:end="4106:52">EST_ERR_INVALID_CLIENT_PROXY_PROTOCOL</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="4108:5" pos:end="4108:35"><expr pos:start="4108:5" pos:end="4108:34"><name pos:start="4108:5" pos:end="4108:20"><name pos:start="4108:5" pos:end="4108:7">ctx</name><operator pos:start="4108:8" pos:end="4108:9">-&gt;</operator><name pos:start="4108:10" pos:end="4108:20">proxy_proto</name></name> <operator pos:start="4108:22" pos:end="4108:22">=</operator> <name pos:start="4108:24" pos:end="4108:34">proxy_proto</name></expr>;</expr_stmt>

    <if_stmt pos:start="4110:5" pos:end="4113:5"><if pos:start="4110:5" pos:end="4113:5">if <condition pos:start="4110:8" pos:end="4111:88">(<expr pos:start="4110:9" pos:end="4111:87"><name pos:start="4110:9" pos:end="4110:18">proxy_auth</name> <operator pos:start="4110:20" pos:end="4110:21">!=</operator> <name pos:start="4110:23" pos:end="4110:48">EST_CLIENT_PROXY_AUTH_NONE</name> <operator pos:start="4110:50" pos:end="4110:51">&amp;&amp;</operator>
        <operator pos:start="4111:9" pos:end="4111:9">(</operator><literal type="number" pos:start="4111:10" pos:end="4111:10">0</literal> <operator pos:start="4111:12" pos:end="4111:13">!=</operator> <operator pos:start="4111:15" pos:end="4111:15">(</operator><name pos:start="4111:16" pos:end="4111:25">proxy_auth</name> <operator pos:start="4111:27" pos:end="4111:27">&amp;</operator> <operator pos:start="4111:29" pos:end="4111:29">~</operator><operator pos:start="4111:30" pos:end="4111:30">(</operator><name pos:start="4111:31" pos:end="4111:57">EST_CLIENT_PROXY_AUTH_BASIC</name><operator pos:start="4111:58" pos:end="4111:58">|</operator><name pos:start="4111:59" pos:end="4111:84">EST_CLIENT_PROXY_AUTH_NTLM</name><operator pos:start="4111:85" pos:end="4111:85">)</operator><operator pos:start="4111:86" pos:end="4111:86">)</operator><operator pos:start="4111:87" pos:end="4111:87">)</operator></expr>)</condition> <block pos:start="4111:90" pos:end="4113:5">{<block_content pos:start="4112:9" pos:end="4112:49">
        <return pos:start="4112:9" pos:end="4112:49">return <expr pos:start="4112:16" pos:end="4112:48"><name pos:start="4112:16" pos:end="4112:48">EST_ERR_INVALID_CLIENT_PROXY_AUTH</name></expr>;</return>
    </block_content>}</block></if></if_stmt>
    <expr_stmt pos:start="4114:5" pos:end="4114:33"><expr pos:start="4114:5" pos:end="4114:32"><name pos:start="4114:5" pos:end="4114:19"><name pos:start="4114:5" pos:end="4114:7">ctx</name><operator pos:start="4114:8" pos:end="4114:9">-&gt;</operator><name pos:start="4114:10" pos:end="4114:19">proxy_auth</name></name> <operator pos:start="4114:21" pos:end="4114:21">=</operator> <name pos:start="4114:23" pos:end="4114:32">proxy_auth</name></expr>;</expr_stmt>

    <if_stmt pos:start="4116:5" pos:end="4147:5"><if pos:start="4116:5" pos:end="4147:5">if <condition pos:start="4116:8" pos:end="4116:73">(<expr pos:start="4116:9" pos:end="4116:72"><name pos:start="4116:9" pos:end="4116:16">username</name> <operator pos:start="4116:18" pos:end="4116:19">&amp;&amp;</operator> <name pos:start="4116:21" pos:end="4116:28">password</name> <operator pos:start="4116:30" pos:end="4116:31">&amp;&amp;</operator> <name pos:start="4116:33" pos:end="4116:42">proxy_auth</name> <operator pos:start="4116:44" pos:end="4116:45">!=</operator> <name pos:start="4116:47" pos:end="4116:72">EST_CLIENT_PROXY_AUTH_NONE</name></expr>)</condition> <block pos:start="4116:75" pos:end="4147:5">{<block_content pos:start="4118:9" pos:end="4146:37">
        
        <if_stmt pos:start="4118:9" pos:end="4120:9"><if pos:start="4118:9" pos:end="4120:9">if <condition pos:start="4118:12" pos:end="4118:59">(<expr pos:start="4118:13" pos:end="4118:58"><name pos:start="4118:13" pos:end="4118:22">MAX_UIDPWD</name> <operator pos:start="4118:24" pos:end="4118:24">&lt;</operator> <call pos:start="4118:26" pos:end="4118:58"><name pos:start="4118:26" pos:end="4118:34">strnlen_s</name><argument_list pos:start="4118:35" pos:end="4118:58">(<argument pos:start="4118:36" pos:end="4118:43"><expr pos:start="4118:36" pos:end="4118:43"><name pos:start="4118:36" pos:end="4118:43">username</name></expr></argument>, <argument pos:start="4118:46" pos:end="4118:57"><expr pos:start="4118:46" pos:end="4118:57"><name pos:start="4118:46" pos:end="4118:55">MAX_UIDPWD</name><operator pos:start="4118:56" pos:end="4118:56">+</operator><literal type="number" pos:start="4118:57" pos:end="4118:57">2</literal></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="4118:61" pos:end="4120:9">{<block_content pos:start="4119:13" pos:end="4119:46">
            <return pos:start="4119:13" pos:end="4119:46">return <expr pos:start="4119:20" pos:end="4119:45"><name pos:start="4119:20" pos:end="4119:45">EST_ERR_INVALID_PARAMETERS</name></expr>;</return>
        </block_content>}</block></if></if_stmt>

        <if_stmt pos:start="4122:9" pos:end="4124:9"><if pos:start="4122:9" pos:end="4124:9">if <condition pos:start="4122:12" pos:end="4122:32">(<expr pos:start="4122:13" pos:end="4122:31"><name pos:start="4122:13" pos:end="4122:23"><name pos:start="4122:13" pos:end="4122:20">username</name><index pos:start="4122:21" pos:end="4122:23">[<expr pos:start="4122:22" pos:end="4122:22"><literal type="number" pos:start="4122:22" pos:end="4122:22">0</literal></expr>]</index></name> <operator pos:start="4122:25" pos:end="4122:26">==</operator> <literal type="char" pos:start="4122:28" pos:end="4122:31">'\0'</literal></expr>)</condition> <block pos:start="4122:34" pos:end="4124:9">{<block_content pos:start="4123:13" pos:end="4123:46">
            <return pos:start="4123:13" pos:end="4123:46">return <expr pos:start="4123:20" pos:end="4123:45"><name pos:start="4123:20" pos:end="4123:45">EST_ERR_INVALID_PARAMETERS</name></expr>;</return>
        </block_content>}</block></if></if_stmt>

        <expr_stmt pos:start="4126:9" pos:end="4126:38"><expr pos:start="4126:9" pos:end="4126:37"><name pos:start="4126:9" pos:end="4126:30"><name pos:start="4126:9" pos:end="4126:11">ctx</name><operator pos:start="4126:12" pos:end="4126:13">-&gt;</operator><name pos:start="4126:14" pos:end="4126:27">proxy_username</name><index pos:start="4126:28" pos:end="4126:30">[<expr pos:start="4126:29" pos:end="4126:29"><literal type="number" pos:start="4126:29" pos:end="4126:29">0</literal></expr>]</index></name> <operator pos:start="4126:32" pos:end="4126:32">=</operator> <literal type="char" pos:start="4126:34" pos:end="4126:37">'\0'</literal></expr>;</expr_stmt>
        <if_stmt pos:start="4127:9" pos:end="4130:9"><if pos:start="4127:9" pos:end="4130:9">if <condition pos:start="4127:12" pos:end="4128:68">(<expr pos:start="4127:13" pos:end="4128:67"><name pos:start="4127:13" pos:end="4127:15">EOK</name> <operator pos:start="4127:17" pos:end="4127:18">!=</operator> <call pos:start="4127:20" pos:end="4128:67"><name pos:start="4127:20" pos:end="4127:28">strncpy_s</name><argument_list pos:start="4127:29" pos:end="4128:67">(<argument pos:start="4127:30" pos:end="4127:48"><expr pos:start="4127:30" pos:end="4127:48"><name pos:start="4127:30" pos:end="4127:48"><name pos:start="4127:30" pos:end="4127:32">ctx</name><operator pos:start="4127:33" pos:end="4127:34">-&gt;</operator><name pos:start="4127:35" pos:end="4127:48">proxy_username</name></name></expr></argument>, <argument pos:start="4127:51" pos:end="4127:77"><expr pos:start="4127:51" pos:end="4127:77"><sizeof pos:start="4127:51" pos:end="4127:77">sizeof<argument_list pos:start="4127:57" pos:end="4127:77">(<argument pos:start="4127:58" pos:end="4127:76"><expr pos:start="4127:58" pos:end="4127:76"><name pos:start="4127:58" pos:end="4127:76"><name pos:start="4127:58" pos:end="4127:60">ctx</name><operator pos:start="4127:61" pos:end="4127:62">-&gt;</operator><name pos:start="4127:63" pos:end="4127:76">proxy_username</name></name></expr></argument>)</argument_list></sizeof></expr></argument>,
                             <argument pos:start="4128:30" pos:end="4128:37"><expr pos:start="4128:30" pos:end="4128:37"><name pos:start="4128:30" pos:end="4128:37">username</name></expr></argument>, <argument pos:start="4128:40" pos:end="4128:66"><expr pos:start="4128:40" pos:end="4128:66"><sizeof pos:start="4128:40" pos:end="4128:66">sizeof<argument_list pos:start="4128:46" pos:end="4128:66">(<argument pos:start="4128:47" pos:end="4128:65"><expr pos:start="4128:47" pos:end="4128:65"><name pos:start="4128:47" pos:end="4128:65"><name pos:start="4128:47" pos:end="4128:49">ctx</name><operator pos:start="4128:50" pos:end="4128:51">-&gt;</operator><name pos:start="4128:52" pos:end="4128:65">proxy_username</name></name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="4128:70" pos:end="4130:9">{<block_content pos:start="4129:13" pos:end="4129:46">
            <return pos:start="4129:13" pos:end="4129:46">return <expr pos:start="4129:20" pos:end="4129:45"><name pos:start="4129:20" pos:end="4129:45">EST_ERR_INVALID_PARAMETERS</name></expr>;</return>
        </block_content>}</block></if></if_stmt>

        <if_stmt pos:start="4132:9" pos:end="4134:9"><if pos:start="4132:9" pos:end="4134:9">if <condition pos:start="4132:12" pos:end="4132:59">(<expr pos:start="4132:13" pos:end="4132:58"><name pos:start="4132:13" pos:end="4132:22">MAX_UIDPWD</name> <operator pos:start="4132:24" pos:end="4132:24">&lt;</operator> <call pos:start="4132:26" pos:end="4132:58"><name pos:start="4132:26" pos:end="4132:34">strnlen_s</name><argument_list pos:start="4132:35" pos:end="4132:58">(<argument pos:start="4132:36" pos:end="4132:43"><expr pos:start="4132:36" pos:end="4132:43"><name pos:start="4132:36" pos:end="4132:43">password</name></expr></argument>, <argument pos:start="4132:46" pos:end="4132:57"><expr pos:start="4132:46" pos:end="4132:57"><name pos:start="4132:46" pos:end="4132:55">MAX_UIDPWD</name><operator pos:start="4132:56" pos:end="4132:56">+</operator><literal type="number" pos:start="4132:57" pos:end="4132:57">2</literal></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="4132:61" pos:end="4134:9">{<block_content pos:start="4133:13" pos:end="4133:46">
            <return pos:start="4133:13" pos:end="4133:46">return <expr pos:start="4133:20" pos:end="4133:45"><name pos:start="4133:20" pos:end="4133:45">EST_ERR_INVALID_PARAMETERS</name></expr>;</return>
        </block_content>}</block></if></if_stmt>

        <if_stmt pos:start="4136:9" pos:end="4138:9"><if pos:start="4136:9" pos:end="4138:9">if <condition pos:start="4136:12" pos:end="4136:32">(<expr pos:start="4136:13" pos:end="4136:31"><name pos:start="4136:13" pos:end="4136:23"><name pos:start="4136:13" pos:end="4136:20">password</name><index pos:start="4136:21" pos:end="4136:23">[<expr pos:start="4136:22" pos:end="4136:22"><literal type="number" pos:start="4136:22" pos:end="4136:22">0</literal></expr>]</index></name> <operator pos:start="4136:25" pos:end="4136:26">==</operator> <literal type="char" pos:start="4136:28" pos:end="4136:31">'\0'</literal></expr>)</condition> <block pos:start="4136:34" pos:end="4138:9">{<block_content pos:start="4137:13" pos:end="4137:46">
            <return pos:start="4137:13" pos:end="4137:46">return <expr pos:start="4137:20" pos:end="4137:45"><name pos:start="4137:20" pos:end="4137:45">EST_ERR_INVALID_PARAMETERS</name></expr>;</return>
        </block_content>}</block></if></if_stmt>

        <expr_stmt pos:start="4140:9" pos:end="4140:38"><expr pos:start="4140:9" pos:end="4140:37"><name pos:start="4140:9" pos:end="4140:30"><name pos:start="4140:9" pos:end="4140:11">ctx</name><operator pos:start="4140:12" pos:end="4140:13">-&gt;</operator><name pos:start="4140:14" pos:end="4140:27">proxy_password</name><index pos:start="4140:28" pos:end="4140:30">[<expr pos:start="4140:29" pos:end="4140:29"><literal type="number" pos:start="4140:29" pos:end="4140:29">0</literal></expr>]</index></name> <operator pos:start="4140:32" pos:end="4140:32">=</operator> <literal type="char" pos:start="4140:34" pos:end="4140:37">'\0'</literal></expr>;</expr_stmt>
        <if_stmt pos:start="4141:9" pos:end="4144:9"><if pos:start="4141:9" pos:end="4144:9">if <condition pos:start="4141:12" pos:end="4142:58">(<expr pos:start="4141:13" pos:end="4142:57"><name pos:start="4141:13" pos:end="4141:15">EOK</name> <operator pos:start="4141:17" pos:end="4141:18">!=</operator> <call pos:start="4141:20" pos:end="4142:57"><name pos:start="4141:20" pos:end="4141:28">strncpy_s</name><argument_list pos:start="4141:29" pos:end="4142:57">(<argument pos:start="4141:30" pos:end="4141:48"><expr pos:start="4141:30" pos:end="4141:48"><name pos:start="4141:30" pos:end="4141:48"><name pos:start="4141:30" pos:end="4141:32">ctx</name><operator pos:start="4141:33" pos:end="4141:34">-&gt;</operator><name pos:start="4141:35" pos:end="4141:48">proxy_password</name></name></expr></argument>, <argument pos:start="4141:51" pos:end="4141:77"><expr pos:start="4141:51" pos:end="4141:77"><sizeof pos:start="4141:51" pos:end="4141:77">sizeof<argument_list pos:start="4141:57" pos:end="4141:77">(<argument pos:start="4141:58" pos:end="4141:76"><expr pos:start="4141:58" pos:end="4141:76"><name pos:start="4141:58" pos:end="4141:76"><name pos:start="4141:58" pos:end="4141:60">ctx</name><operator pos:start="4141:61" pos:end="4141:62">-&gt;</operator><name pos:start="4141:63" pos:end="4141:76">proxy_password</name></name></expr></argument>)</argument_list></sizeof></expr></argument>, <argument pos:start="4141:80" pos:end="4141:87"><expr pos:start="4141:80" pos:end="4141:87"><name pos:start="4141:80" pos:end="4141:87">password</name></expr></argument>,
                             <argument pos:start="4142:30" pos:end="4142:56"><expr pos:start="4142:30" pos:end="4142:56"><sizeof pos:start="4142:30" pos:end="4142:56">sizeof<argument_list pos:start="4142:36" pos:end="4142:56">(<argument pos:start="4142:37" pos:end="4142:55"><expr pos:start="4142:37" pos:end="4142:55"><name pos:start="4142:37" pos:end="4142:55"><name pos:start="4142:37" pos:end="4142:39">ctx</name><operator pos:start="4142:40" pos:end="4142:41">-&gt;</operator><name pos:start="4142:42" pos:end="4142:55">proxy_password</name></name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>)</condition> <block pos:start="4142:60" pos:end="4144:9">{<block_content pos:start="4143:13" pos:end="4143:46">
            <return pos:start="4143:13" pos:end="4143:46">return <expr pos:start="4143:20" pos:end="4143:45"><name pos:start="4143:20" pos:end="4143:45">EST_ERR_INVALID_PARAMETERS</name></expr>;</return>
        </block_content>}</block></if></if_stmt>

        <expr_stmt pos:start="4146:9" pos:end="4146:37"><expr pos:start="4146:9" pos:end="4146:36"><name pos:start="4146:9" pos:end="4146:23"><name pos:start="4146:9" pos:end="4146:11">ctx</name><operator pos:start="4146:12" pos:end="4146:13">-&gt;</operator><name pos:start="4146:14" pos:end="4146:23">proxy_auth</name></name> <operator pos:start="4146:25" pos:end="4146:25">=</operator> <name pos:start="4146:27" pos:end="4146:36">proxy_auth</name></expr>;</expr_stmt>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="4149:5" pos:end="4149:23"><expr pos:start="4149:5" pos:end="4149:22"><name pos:start="4149:5" pos:end="4149:18"><name pos:start="4149:5" pos:end="4149:7">ctx</name><operator pos:start="4149:8" pos:end="4149:9">-&gt;</operator><name pos:start="4149:10" pos:end="4149:18">use_proxy</name></name> <operator pos:start="4149:20" pos:end="4149:20">=</operator> <literal type="number" pos:start="4149:22" pos:end="4149:22">1</literal></expr>;</expr_stmt>
    
    <return pos:start="4151:5" pos:end="4153:0">return <expr pos:start="4151:12" pos:end="4151:23"><name pos:start="4151:12" pos:end="4151:23">EST_ERR_NONE</name></expr>;</return>
<cpp:else pos:start="4152:1" pos:end="4152:5">#<cpp:directive pos:start="4152:2" pos:end="4152:5">else</cpp:directive></cpp:else>
    <comment type="block" pos:start="4153:5" pos:end="4156:7">/*
     * If the EST library was not built with support for libcurl then client
     * proxy mode is not supported.
     */</comment>
    <expr_stmt pos:start="4157:5" pos:end="4157:79"><expr pos:start="4157:5" pos:end="4157:78"><call pos:start="4157:5" pos:end="4157:78"><name pos:start="4157:5" pos:end="4157:15">EST_LOG_ERR</name><argument_list pos:start="4157:16" pos:end="4157:78">(<argument pos:start="4157:17" pos:end="4157:77"><expr pos:start="4157:17" pos:end="4157:77"><literal type="string" pos:start="4157:17" pos:end="4157:77">"Client proxy mode requires libest to be built with libcurl."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return pos:start="4158:5" pos:end="4160:0">return <expr pos:start="4158:12" pos:end="4158:50"><name pos:start="4158:12" pos:end="4158:50">EST_ERR_CLIENT_PROXY_MODE_NOT_SUPPORTED</name></expr>;</return>
<cpp:endif pos:start="4159:1" pos:end="4159:6">#<cpp:directive pos:start="4159:2" pos:end="4159:6">endif</cpp:directive></cpp:endif>    
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="4161:1" pos:end="4185:3">/*! @brief est_client_set_sign_digest() is called by the application layer to
     specify the hash algorithm used to sign the PKCS10 CSR during the
     enroll operation. It must be called after
     est_client_init() and prior to issuing any EST commands.
 
    @param ctx Pointer to EST context for a client session
    @param nid This is the NID value defined in the OpenSSL header file obj_mac.h
               for the desired digest to use for signing.  
 
    @return EST_ERROR
    EST_ERR_NONE - Success.
    EST_ERR_NO_CTX - NULL value passed for EST context
    EST_ERR_INVALID_DIGEST - An unsupported NID was provided.

    libEST supports SHA1, SHA224, SHA256, SHA384, and SHA512 digests.  
    SHA256 is the default digest to use for signing.  There's no need
    to invoke this function unless another digest is desired. The
    supported NID values are:
	NID_sha1
	NID_sha224 
	NID_sha256 
	NID_sha384 
	NID_sha512 
    
 */</comment>
<function pos:start="4186:1" pos:end="4214:1"><type pos:start="4186:1" pos:end="4186:9"><name pos:start="4186:1" pos:end="4186:9">EST_ERROR</name></type> <name pos:start="4186:11" pos:end="4186:36">est_client_set_sign_digest</name> <parameter_list pos:start="4186:38" pos:end="4186:60">(<parameter pos:start="4186:39" pos:end="4186:50"><decl pos:start="4186:39" pos:end="4186:50"><type pos:start="4186:39" pos:end="4186:50"><name pos:start="4186:39" pos:end="4186:45">EST_CTX</name> <modifier pos:start="4186:47" pos:end="4186:47">*</modifier></type><name pos:start="4186:48" pos:end="4186:50">ctx</name></decl></parameter>, <parameter pos:start="4186:53" pos:end="4186:59"><decl pos:start="4186:53" pos:end="4186:59"><type pos:start="4186:53" pos:end="4186:59"><name pos:start="4186:53" pos:end="4186:55">int</name></type> <name pos:start="4186:57" pos:end="4186:59">nid</name></decl></parameter>)</parameter_list> 
<block pos:start="4187:1" pos:end="4214:1">{<block_content pos:start="4188:5" pos:end="4213:26">
    <if_stmt pos:start="4188:5" pos:end="4190:5"><if pos:start="4188:5" pos:end="4190:5">if <condition pos:start="4188:8" pos:end="4188:13">(<expr pos:start="4188:9" pos:end="4188:12"><operator pos:start="4188:9" pos:end="4188:9">!</operator><name pos:start="4188:10" pos:end="4188:12">ctx</name></expr>)</condition> <block pos:start="4188:15" pos:end="4190:5">{<block_content pos:start="4189:9" pos:end="4189:30">
        <return pos:start="4189:9" pos:end="4189:30">return <expr pos:start="4189:16" pos:end="4189:29"><name pos:start="4189:16" pos:end="4189:29">EST_ERR_NO_CTX</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <switch pos:start="4192:5" pos:end="4211:5">switch <condition pos:start="4192:12" pos:end="4192:16">(<expr pos:start="4192:13" pos:end="4192:15"><name pos:start="4192:13" pos:end="4192:15">nid</name></expr>)</condition> <block pos:start="4192:18" pos:end="4211:5">{<block_content pos:start="4193:5" pos:end="4210:14">
    <case pos:start="4193:5" pos:end="4193:20">case <expr pos:start="4193:10" pos:end="4193:19"><name pos:start="4193:10" pos:end="4193:19">NID_sha512</name></expr>:</case>
        <expr_stmt pos:start="4194:9" pos:end="4194:43"><expr pos:start="4194:9" pos:end="4194:42"><name pos:start="4194:9" pos:end="4194:27"><name pos:start="4194:9" pos:end="4194:11">ctx</name><operator pos:start="4194:12" pos:end="4194:13">-&gt;</operator><name pos:start="4194:14" pos:end="4194:27">signing_digest</name></name> <operator pos:start="4194:29" pos:end="4194:29">=</operator> <call pos:start="4194:31" pos:end="4194:42"><name pos:start="4194:31" pos:end="4194:40">EVP_sha512</name><argument_list pos:start="4194:41" pos:end="4194:42">()</argument_list></call></expr>;</expr_stmt> 
        <break pos:start="4195:9" pos:end="4195:14">break;</break>
    <case pos:start="4196:5" pos:end="4196:20">case <expr pos:start="4196:10" pos:end="4196:19"><name pos:start="4196:10" pos:end="4196:19">NID_sha384</name></expr>:</case>
        <expr_stmt pos:start="4197:9" pos:end="4197:43"><expr pos:start="4197:9" pos:end="4197:42"><name pos:start="4197:9" pos:end="4197:27"><name pos:start="4197:9" pos:end="4197:11">ctx</name><operator pos:start="4197:12" pos:end="4197:13">-&gt;</operator><name pos:start="4197:14" pos:end="4197:27">signing_digest</name></name> <operator pos:start="4197:29" pos:end="4197:29">=</operator> <call pos:start="4197:31" pos:end="4197:42"><name pos:start="4197:31" pos:end="4197:40">EVP_sha384</name><argument_list pos:start="4197:41" pos:end="4197:42">()</argument_list></call></expr>;</expr_stmt> 
        <break pos:start="4198:9" pos:end="4198:14">break;</break>
    <case pos:start="4199:5" pos:end="4199:20">case <expr pos:start="4199:10" pos:end="4199:19"><name pos:start="4199:10" pos:end="4199:19">NID_sha256</name></expr>:</case>
        <expr_stmt pos:start="4200:9" pos:end="4200:43"><expr pos:start="4200:9" pos:end="4200:42"><name pos:start="4200:9" pos:end="4200:27"><name pos:start="4200:9" pos:end="4200:11">ctx</name><operator pos:start="4200:12" pos:end="4200:13">-&gt;</operator><name pos:start="4200:14" pos:end="4200:27">signing_digest</name></name> <operator pos:start="4200:29" pos:end="4200:29">=</operator> <call pos:start="4200:31" pos:end="4200:42"><name pos:start="4200:31" pos:end="4200:40">EVP_sha256</name><argument_list pos:start="4200:41" pos:end="4200:42">()</argument_list></call></expr>;</expr_stmt> 
        <break pos:start="4201:9" pos:end="4201:14">break;</break>
    <case pos:start="4202:5" pos:end="4202:20">case <expr pos:start="4202:10" pos:end="4202:19"><name pos:start="4202:10" pos:end="4202:19">NID_sha224</name></expr>:</case>
        <expr_stmt pos:start="4203:9" pos:end="4203:43"><expr pos:start="4203:9" pos:end="4203:42"><name pos:start="4203:9" pos:end="4203:27"><name pos:start="4203:9" pos:end="4203:11">ctx</name><operator pos:start="4203:12" pos:end="4203:13">-&gt;</operator><name pos:start="4203:14" pos:end="4203:27">signing_digest</name></name> <operator pos:start="4203:29" pos:end="4203:29">=</operator> <call pos:start="4203:31" pos:end="4203:42"><name pos:start="4203:31" pos:end="4203:40">EVP_sha224</name><argument_list pos:start="4203:41" pos:end="4203:42">()</argument_list></call></expr>;</expr_stmt> 
        <break pos:start="4204:9" pos:end="4204:14">break;</break>
    <case pos:start="4205:5" pos:end="4205:18">case <expr pos:start="4205:10" pos:end="4205:17"><name pos:start="4205:10" pos:end="4205:17">NID_sha1</name></expr>:</case>
        <expr_stmt pos:start="4206:9" pos:end="4206:41"><expr pos:start="4206:9" pos:end="4206:40"><name pos:start="4206:9" pos:end="4206:27"><name pos:start="4206:9" pos:end="4206:11">ctx</name><operator pos:start="4206:12" pos:end="4206:13">-&gt;</operator><name pos:start="4206:14" pos:end="4206:27">signing_digest</name></name> <operator pos:start="4206:29" pos:end="4206:29">=</operator> <call pos:start="4206:31" pos:end="4206:40"><name pos:start="4206:31" pos:end="4206:38">EVP_sha1</name><argument_list pos:start="4206:39" pos:end="4206:40">()</argument_list></call></expr>;</expr_stmt> 
        <break pos:start="4207:9" pos:end="4207:14">break;</break>
    <default pos:start="4208:5" pos:end="4208:12">default:</default>
	<return pos:start="4209:9" pos:end="4209:40">return <expr pos:start="4209:16" pos:end="4209:39"><operator pos:start="4209:16" pos:end="4209:16">(</operator><name pos:start="4209:17" pos:end="4209:38">EST_ERR_INVALID_DIGEST</name><operator pos:start="4209:39" pos:end="4209:39">)</operator></expr>;</return>
        <break pos:start="4210:9" pos:end="4210:14">break;</break>
    </block_content>}</block></switch>

    <return pos:start="4213:5" pos:end="4213:26">return <expr pos:start="4213:12" pos:end="4213:25"><operator pos:start="4213:12" pos:end="4213:12">(</operator><name pos:start="4213:13" pos:end="4213:24">EST_ERR_NONE</name><operator pos:start="4213:25" pos:end="4213:25">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="4215:1" pos:end="4256:3">/*! @brief est_client_copy_retry_after() copies the retry after value stored
    in this client context.
 
    @param ctx Pointer to the current EST context.
    
    @param retry_delay Pointer to the integer where the retry-after delay secs
    value is copied.  If the server sent a retry-after in delay seconds format
    then it will be passed here.  If it did not, then this value will be zero.
    
    @param retry_time Pointer to the time_t where the retry-after time date
    value is copied.  If the server sent a retry-after in time and date string
    format then this string is converted into a time_t value and passed up
    in this parameter.  This value will only be set if the server sent a time
    and date string response, otherwise, this value is set to zero.
 
    @return EST_ERROR

    When a response is received from the EST server the headers are checked to
    see if the server has included a Retry-After header, indicating that this
    request currently cannot be processed.  If a Retry-After HTTP header is
    included in the received response from the server the delay value is saved
    in the context and an EST error code is given to the application on this
    request indicating that the client must retry the request at a later time.

    The value specified by the server can be in one of two basic formats, a
    string version of a integer value that represents the number of seconds
    the client must wait before retrying the request, and a string containing
    a date and time when the client can retry the request.  The date and time
    string can be in any format specified in RFC 2616.  If the second delay
    value is sent it is converted into an integer and saved in the EST context
    and if the date time string value is sent it is converted into a time_t
    value and saved into the EST context.  The application must then call
    est_client_copy_retry_after() to obtain the amount of time to wait before
    retrying the request.  est_client_copy_retry_after() copies the current
    retry-after value from the client context and returns it to the
    application.  Only one of the two return values will be set with a
    non-zero value.

    NOTE: The processing of a Retry-After value in time/date format is currently
    not supported.  The EST Client will always return only a retry delay
    value in seconds.
 */</comment>
<function pos:start="4257:1" pos:end="4276:1"><type pos:start="4257:1" pos:end="4257:9"><name pos:start="4257:1" pos:end="4257:9">EST_ERROR</name></type> <name pos:start="4257:11" pos:end="4257:37">est_client_copy_retry_after</name> <parameter_list pos:start="4257:39" pos:end="4258:58">(<parameter pos:start="4257:40" pos:end="4257:51"><decl pos:start="4257:40" pos:end="4257:51"><type pos:start="4257:40" pos:end="4257:51"><name pos:start="4257:40" pos:end="4257:46">EST_CTX</name> <modifier pos:start="4257:48" pos:end="4257:48">*</modifier></type><name pos:start="4257:49" pos:end="4257:51">ctx</name></decl></parameter>, <parameter pos:start="4257:54" pos:end="4257:69"><decl pos:start="4257:54" pos:end="4257:69"><type pos:start="4257:54" pos:end="4257:69"><name pos:start="4257:54" pos:end="4257:56">int</name> <modifier pos:start="4257:58" pos:end="4257:58">*</modifier></type><name pos:start="4257:59" pos:end="4257:69">retry_delay</name></decl></parameter>,
                                       <parameter pos:start="4258:40" pos:end="4258:57"><decl pos:start="4258:40" pos:end="4258:57"><type pos:start="4258:40" pos:end="4258:57"><name pos:start="4258:40" pos:end="4258:45">time_t</name> <modifier pos:start="4258:47" pos:end="4258:47">*</modifier></type><name pos:start="4258:48" pos:end="4258:57">retry_time</name></decl></parameter>)</parameter_list>
<block pos:start="4259:1" pos:end="4276:1">{<block_content pos:start="4261:5" pos:end="4275:26">

    <if_stmt pos:start="4261:5" pos:end="4263:5"><if pos:start="4261:5" pos:end="4263:5">if <condition pos:start="4261:8" pos:end="4261:13">(<expr pos:start="4261:9" pos:end="4261:12"><operator pos:start="4261:9" pos:end="4261:9">!</operator><name pos:start="4261:10" pos:end="4261:12">ctx</name></expr>)</condition> <block pos:start="4261:15" pos:end="4263:5">{<block_content pos:start="4262:9" pos:end="4262:32">
        <return pos:start="4262:9" pos:end="4262:32">return <expr pos:start="4262:16" pos:end="4262:31"><operator pos:start="4262:16" pos:end="4262:16">(</operator><name pos:start="4262:17" pos:end="4262:30">EST_ERR_NO_CTX</name><operator pos:start="4262:31" pos:end="4262:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="4265:5" pos:end="4267:5"><if pos:start="4265:5" pos:end="4267:5">if <condition pos:start="4265:8" pos:end="4265:37">(<expr pos:start="4265:9" pos:end="4265:36"><operator pos:start="4265:9" pos:end="4265:9">!</operator><name pos:start="4265:10" pos:end="4265:36"><name pos:start="4265:10" pos:end="4265:12">ctx</name><operator pos:start="4265:13" pos:end="4265:14">-&gt;</operator><name pos:start="4265:15" pos:end="4265:36">est_client_initialized</name></name></expr>)</condition> <block pos:start="4265:39" pos:end="4267:5">{<block_content pos:start="4266:9" pos:end="4266:46">
        <return pos:start="4266:9" pos:end="4266:46">return <expr pos:start="4266:16" pos:end="4266:45"><name pos:start="4266:16" pos:end="4266:45">EST_ERR_CLIENT_NOT_INITIALIZED</name></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="4269:5" pos:end="4269:42"><expr pos:start="4269:5" pos:end="4269:41"><operator pos:start="4269:5" pos:end="4269:5">*</operator><name pos:start="4269:6" pos:end="4269:16">retry_delay</name> <operator pos:start="4269:18" pos:end="4269:18">=</operator> <name pos:start="4269:20" pos:end="4269:41"><name pos:start="4269:20" pos:end="4269:22">ctx</name><operator pos:start="4269:23" pos:end="4269:24">-&gt;</operator><name pos:start="4269:25" pos:end="4269:41">retry_after_delay</name></name></expr>;</expr_stmt>
    <expr_stmt pos:start="4270:5" pos:end="4270:31"><expr pos:start="4270:5" pos:end="4270:30"><name pos:start="4270:5" pos:end="4270:26"><name pos:start="4270:5" pos:end="4270:7">ctx</name><operator pos:start="4270:8" pos:end="4270:9">-&gt;</operator><name pos:start="4270:10" pos:end="4270:26">retry_after_delay</name></name> <operator pos:start="4270:28" pos:end="4270:28">=</operator> <literal type="number" pos:start="4270:30" pos:end="4270:30">0</literal></expr>;</expr_stmt>

    <expr_stmt pos:start="4272:5" pos:end="4272:40"><expr pos:start="4272:5" pos:end="4272:39"><operator pos:start="4272:5" pos:end="4272:5">*</operator><name pos:start="4272:6" pos:end="4272:15">retry_time</name> <operator pos:start="4272:17" pos:end="4272:17">=</operator> <name pos:start="4272:19" pos:end="4272:39"><name pos:start="4272:19" pos:end="4272:21">ctx</name><operator pos:start="4272:22" pos:end="4272:23">-&gt;</operator><name pos:start="4272:24" pos:end="4272:39">retry_after_date</name></name></expr>;</expr_stmt>
    <expr_stmt pos:start="4273:5" pos:end="4273:30"><expr pos:start="4273:5" pos:end="4273:29"><name pos:start="4273:5" pos:end="4273:25"><name pos:start="4273:5" pos:end="4273:7">ctx</name><operator pos:start="4273:8" pos:end="4273:9">-&gt;</operator><name pos:start="4273:10" pos:end="4273:25">retry_after_date</name></name> <operator pos:start="4273:27" pos:end="4273:27">=</operator> <literal type="number" pos:start="4273:29" pos:end="4273:29">0</literal></expr>;</expr_stmt>
    
    <return pos:start="4275:5" pos:end="4275:26">return <expr pos:start="4275:12" pos:end="4275:25"><operator pos:start="4275:12" pos:end="4275:12">(</operator><name pos:start="4275:13" pos:end="4275:24">EST_ERR_NONE</name><operator pos:start="4275:25" pos:end="4275:25">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="4277:1" pos:end="4293:3">/*! @brief est_client_force_pop() is used by an application to enable 
    the proof-of-possession generation at the EST client.  This proves
    that the EST client that sent the CSR to the server/proxy is in possession
    of the private key that was used to sign the CSR.  This binds the TLS 
    session ID to the CSR.

    Note, if the CSR attributes configured on the server require PoP 
    checking, then there is no need to call this function to enable
    PoP.  The PoP will be enabled automatically under this scenario
    when the CSR attributes are requested from the server/proxy.
    
    @param ctx Pointer to the EST context

    This function may be called at any time.   
 
    @return EST_ERROR.
 */</comment>
<function pos:start="4294:1" pos:end="4303:1"><type pos:start="4294:1" pos:end="4294:9"><name pos:start="4294:1" pos:end="4294:9">EST_ERROR</name></type> <name pos:start="4294:11" pos:end="4294:30">est_client_force_pop</name> <parameter_list pos:start="4294:32" pos:end="4294:45">(<parameter pos:start="4294:33" pos:end="4294:44"><decl pos:start="4294:33" pos:end="4294:44"><type pos:start="4294:33" pos:end="4294:41"><name pos:start="4294:33" pos:end="4294:39">EST_CTX</name> <modifier pos:start="4294:41" pos:end="4294:41">*</modifier></type><name pos:start="4294:42" pos:end="4294:44">ctx</name></decl></parameter>)</parameter_list>
<block pos:start="4295:1" pos:end="4303:1">{<block_content pos:start="4296:5" pos:end="4302:26">
    <if_stmt pos:start="4296:5" pos:end="4299:5"><if pos:start="4296:5" pos:end="4299:5">if <condition pos:start="4296:8" pos:end="4296:13">(<expr pos:start="4296:9" pos:end="4296:12"><operator pos:start="4296:9" pos:end="4296:9">!</operator><name pos:start="4296:10" pos:end="4296:12">ctx</name></expr>)</condition> <block pos:start="4296:15" pos:end="4299:5">{<block_content pos:start="4297:9" pos:end="4298:32">
	<expr_stmt pos:start="4297:9" pos:end="4297:36"><expr pos:start="4297:9" pos:end="4297:35"><call pos:start="4297:9" pos:end="4297:35"><name pos:start="4297:9" pos:end="4297:19">EST_LOG_ERR</name><argument_list pos:start="4297:20" pos:end="4297:35">(<argument pos:start="4297:21" pos:end="4297:34"><expr pos:start="4297:21" pos:end="4297:34"><literal type="string" pos:start="4297:21" pos:end="4297:34">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="4298:9" pos:end="4298:32">return <expr pos:start="4298:16" pos:end="4298:31"><operator pos:start="4298:16" pos:end="4298:16">(</operator><name pos:start="4298:17" pos:end="4298:30">EST_ERR_NO_CTX</name><operator pos:start="4298:31" pos:end="4298:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="4301:5" pos:end="4301:30"><expr pos:start="4301:5" pos:end="4301:29"><name pos:start="4301:5" pos:end="4301:25"><name pos:start="4301:5" pos:end="4301:7">ctx</name><operator pos:start="4301:8" pos:end="4301:9">-&gt;</operator><name pos:start="4301:10" pos:end="4301:25">client_force_pop</name></name> <operator pos:start="4301:27" pos:end="4301:27">=</operator> <literal type="number" pos:start="4301:29" pos:end="4301:29">1</literal></expr>;</expr_stmt>
    <return pos:start="4302:5" pos:end="4302:26">return <expr pos:start="4302:12" pos:end="4302:25"><operator pos:start="4302:12" pos:end="4302:12">(</operator><name pos:start="4302:13" pos:end="4302:24">EST_ERR_NONE</name><operator pos:start="4302:25" pos:end="4302:25">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="4304:1" pos:end="4314:3">/*! @brief est_client_unforce_pop() is used by an application to disable 
    the proof-of-possession generation at the EST client.  Please see
    the documenation for est_client_force_pop() for more information
    on the proof-of-possession check.

    @param ctx Pointer to the EST context

    This function may be called at any time.   
 
    @return EST_ERROR.
 */</comment>
<function pos:start="4315:1" pos:end="4324:1"><type pos:start="4315:1" pos:end="4315:9"><name pos:start="4315:1" pos:end="4315:9">EST_ERROR</name></type> <name pos:start="4315:11" pos:end="4315:32">est_client_unforce_pop</name> <parameter_list pos:start="4315:34" pos:end="4315:47">(<parameter pos:start="4315:35" pos:end="4315:46"><decl pos:start="4315:35" pos:end="4315:46"><type pos:start="4315:35" pos:end="4315:43"><name pos:start="4315:35" pos:end="4315:41">EST_CTX</name> <modifier pos:start="4315:43" pos:end="4315:43">*</modifier></type><name pos:start="4315:44" pos:end="4315:46">ctx</name></decl></parameter>)</parameter_list>
<block pos:start="4316:1" pos:end="4324:1">{<block_content pos:start="4317:5" pos:end="4323:26">
    <if_stmt pos:start="4317:5" pos:end="4320:5"><if pos:start="4317:5" pos:end="4320:5">if <condition pos:start="4317:8" pos:end="4317:13">(<expr pos:start="4317:9" pos:end="4317:12"><operator pos:start="4317:9" pos:end="4317:9">!</operator><name pos:start="4317:10" pos:end="4317:12">ctx</name></expr>)</condition> <block pos:start="4317:15" pos:end="4320:5">{<block_content pos:start="4318:9" pos:end="4319:32">
	<expr_stmt pos:start="4318:9" pos:end="4318:36"><expr pos:start="4318:9" pos:end="4318:35"><call pos:start="4318:9" pos:end="4318:35"><name pos:start="4318:9" pos:end="4318:19">EST_LOG_ERR</name><argument_list pos:start="4318:20" pos:end="4318:35">(<argument pos:start="4318:21" pos:end="4318:34"><expr pos:start="4318:21" pos:end="4318:34"><literal type="string" pos:start="4318:21" pos:end="4318:34">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="4319:9" pos:end="4319:32">return <expr pos:start="4319:16" pos:end="4319:31"><operator pos:start="4319:16" pos:end="4319:16">(</operator><name pos:start="4319:17" pos:end="4319:30">EST_ERR_NO_CTX</name><operator pos:start="4319:31" pos:end="4319:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <expr_stmt pos:start="4322:5" pos:end="4322:30"><expr pos:start="4322:5" pos:end="4322:29"><name pos:start="4322:5" pos:end="4322:25"><name pos:start="4322:5" pos:end="4322:7">ctx</name><operator pos:start="4322:8" pos:end="4322:9">-&gt;</operator><name pos:start="4322:10" pos:end="4322:25">client_force_pop</name></name> <operator pos:start="4322:27" pos:end="4322:27">=</operator> <literal type="number" pos:start="4322:29" pos:end="4322:29">0</literal></expr>;</expr_stmt>
    <return pos:start="4323:5" pos:end="4323:26">return <expr pos:start="4323:12" pos:end="4323:25"><operator pos:start="4323:12" pos:end="4323:12">(</operator><name pos:start="4323:13" pos:end="4323:24">EST_ERR_NONE</name><operator pos:start="4323:25" pos:end="4323:25">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="4325:1" pos:end="4337:3">/*! @brief est_client_set_read_timeout() is used by an application to set
    timeout value of read operations.  After the EST client sends a request to
    the EST server it will attempt to read the response from the server.  This
    timeout value limits the amount of time the client will wait for the
    response.

    @param ctx Pointer to the EST context
    @param timeout Integer value representing the read timeout in seconds.
    The minimum value is EST_SSL_READ_TIMEOUT_MIN and the maximum value is
    EST_SSL_READ_TIMEOUT_MAX.
 
    @return EST_ERROR.
 */</comment>
<function pos:start="4338:1" pos:end="4353:1"><type pos:start="4338:1" pos:end="4338:9"><name pos:start="4338:1" pos:end="4338:9">EST_ERROR</name></type> <name pos:start="4338:11" pos:end="4338:37">est_client_set_read_timeout</name> <parameter_list pos:start="4338:39" pos:end="4338:65">(<parameter pos:start="4338:40" pos:end="4338:51"><decl pos:start="4338:40" pos:end="4338:51"><type pos:start="4338:40" pos:end="4338:51"><name pos:start="4338:40" pos:end="4338:46">EST_CTX</name> <modifier pos:start="4338:48" pos:end="4338:48">*</modifier></type><name pos:start="4338:49" pos:end="4338:51">ctx</name></decl></parameter>, <parameter pos:start="4338:54" pos:end="4338:64"><decl pos:start="4338:54" pos:end="4338:64"><type pos:start="4338:54" pos:end="4338:64"><name pos:start="4338:54" pos:end="4338:56">int</name></type> <name pos:start="4338:58" pos:end="4338:64">timeout</name></decl></parameter>)</parameter_list>
<block pos:start="4339:1" pos:end="4353:1">{<block_content pos:start="4340:5" pos:end="4352:26">
    <if_stmt pos:start="4340:5" pos:end="4343:5"><if pos:start="4340:5" pos:end="4343:5">if <condition pos:start="4340:8" pos:end="4340:13">(<expr pos:start="4340:9" pos:end="4340:12"><operator pos:start="4340:9" pos:end="4340:9">!</operator><name pos:start="4340:10" pos:end="4340:12">ctx</name></expr>)</condition> <block pos:start="4340:15" pos:end="4343:5">{<block_content pos:start="4341:9" pos:end="4342:32">
	<expr_stmt pos:start="4341:9" pos:end="4341:36"><expr pos:start="4341:9" pos:end="4341:35"><call pos:start="4341:9" pos:end="4341:35"><name pos:start="4341:9" pos:end="4341:19">EST_LOG_ERR</name><argument_list pos:start="4341:20" pos:end="4341:35">(<argument pos:start="4341:21" pos:end="4341:34"><expr pos:start="4341:21" pos:end="4341:34"><literal type="string" pos:start="4341:21" pos:end="4341:34">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="4342:9" pos:end="4342:32">return <expr pos:start="4342:16" pos:end="4342:31"><operator pos:start="4342:16" pos:end="4342:16">(</operator><name pos:start="4342:17" pos:end="4342:30">EST_ERR_NO_CTX</name><operator pos:start="4342:31" pos:end="4342:31">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>

    <if_stmt pos:start="4345:5" pos:end="4349:5"><if pos:start="4345:5" pos:end="4349:5">if <condition pos:start="4345:8" pos:end="4346:43">(<expr pos:start="4345:9" pos:end="4346:42"><name pos:start="4345:9" pos:end="4346:17"><name pos:start="4345:9" pos:end="4345:15">timeout</name> <argument_list type="generic" pos:start="4345:17" pos:end="4346:17">&lt; <argument pos:start="4345:19" pos:end="4346:15"><expr pos:start="4345:19" pos:end="4346:15"><name pos:start="4345:19" pos:end="4345:42">EST_SSL_READ_TIMEOUT_MIN</name> <operator pos:start="4345:44" pos:end="4345:45">||</operator>
        <name pos:start="4346:9" pos:end="4346:15">timeout</name></expr></argument> &gt;</argument_list></name> <name pos:start="4346:19" pos:end="4346:42">EST_SSL_READ_TIMEOUT_MAX</name></expr>)</condition> <block pos:start="4346:45" pos:end="4349:5">{<block_content pos:start="4347:9" pos:end="4348:44">
	<expr_stmt pos:start="4347:9" pos:end="4347:71"><expr pos:start="4347:9" pos:end="4347:70"><call pos:start="4347:9" pos:end="4347:70"><name pos:start="4347:9" pos:end="4347:19">EST_LOG_ERR</name><argument_list pos:start="4347:20" pos:end="4347:70">(<argument pos:start="4347:21" pos:end="4347:60"><expr pos:start="4347:21" pos:end="4347:60"><literal type="string" pos:start="4347:21" pos:end="4347:60">"Invalid read timeout value passed: %d "</literal></expr></argument>, <argument pos:start="4347:63" pos:end="4347:69"><expr pos:start="4347:63" pos:end="4347:69"><name pos:start="4347:63" pos:end="4347:69">timeout</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return pos:start="4348:9" pos:end="4348:44">return <expr pos:start="4348:16" pos:end="4348:43"><operator pos:start="4348:16" pos:end="4348:16">(</operator><name pos:start="4348:17" pos:end="4348:42">EST_ERR_INVALID_PARAMETERS</name><operator pos:start="4348:43" pos:end="4348:43">)</operator></expr>;</return>
    </block_content>}</block></if></if_stmt>
        
    <expr_stmt pos:start="4351:5" pos:end="4351:32"><expr pos:start="4351:5" pos:end="4351:31"><name pos:start="4351:5" pos:end="4351:21"><name pos:start="4351:5" pos:end="4351:7">ctx</name><operator pos:start="4351:8" pos:end="4351:9">-&gt;</operator><name pos:start="4351:10" pos:end="4351:21">read_timeout</name></name> <operator pos:start="4351:23" pos:end="4351:23">=</operator> <name pos:start="4351:25" pos:end="4351:31">timeout</name></expr>;</expr_stmt>
    <return pos:start="4352:5" pos:end="4352:26">return <expr pos:start="4352:12" pos:end="4352:25"><operator pos:start="4352:12" pos:end="4352:12">(</operator><name pos:start="4352:13" pos:end="4352:24">EST_ERR_NONE</name><operator pos:start="4352:25" pos:end="4352:25">)</operator></expr>;</return>
</block_content>}</block></function>
<comment type="block" format="doxygen" pos:start="4354:1" pos:end="4371:3">/*! @brief est_client_get_last_http_status() is used by an application to get
    the HTTP status code returned by the EST server for the most recent
    operation. 

    @param ctx Pointer to the EST context

    This can be called after an EST operation, such as an enroll operation.
    This function will return the most recent HTTP status code received
    from the EST server.  Normally, a status of 200 would be returned
    by the EST server to indicate a successful operation.  However, if the
    operation failed for some reason, the HTTP status code may be useful
    to understand the reason for failure.  For instance, the EST server 
    would return a HTTP status of 401 if the EST client was not authorized.
    Please see RFC 2616 for a description of the various HTTP status codes.
 
    @return int value representing the HTTP status code, or NULL if the
    a NULL EST context was provided.
 */</comment>
<function pos:start="4372:1" pos:end="4379:1"><type pos:start="4372:1" pos:end="4372:3"><name pos:start="4372:1" pos:end="4372:3">int</name></type> <name pos:start="4372:5" pos:end="4372:35">est_client_get_last_http_status</name> <parameter_list pos:start="4372:37" pos:end="4372:50">(<parameter pos:start="4372:38" pos:end="4372:49"><decl pos:start="4372:38" pos:end="4372:49"><type pos:start="4372:38" pos:end="4372:46"><name pos:start="4372:38" pos:end="4372:44">EST_CTX</name> <modifier pos:start="4372:46" pos:end="4372:46">*</modifier></type><name pos:start="4372:47" pos:end="4372:49">ctx</name></decl></parameter>)</parameter_list>
<block pos:start="4373:1" pos:end="4379:1">{<block_content pos:start="4374:5" pos:end="4378:5">
    <if_stmt pos:start="4374:5" pos:end="4378:5"><if pos:start="4374:5" pos:end="4376:5">if <condition pos:start="4374:8" pos:end="4374:12">(<expr pos:start="4374:9" pos:end="4374:11"><name pos:start="4374:9" pos:end="4374:11">ctx</name></expr>)</condition> <block pos:start="4374:14" pos:end="4376:5">{<block_content pos:start="4375:9" pos:end="4375:37">
	<return pos:start="4375:9" pos:end="4375:37">return <expr pos:start="4375:16" pos:end="4375:36"><name pos:start="4375:16" pos:end="4375:36"><name pos:start="4375:16" pos:end="4375:18">ctx</name><operator pos:start="4375:19" pos:end="4375:20">-&gt;</operator><name pos:start="4375:21" pos:end="4375:36">last_http_status</name></name></expr>;</return>
    </block_content>}</block></if> <else pos:start="4376:7" pos:end="4378:5">else <block pos:start="4376:12" pos:end="4378:5">{<block_content pos:start="4377:9" pos:end="4377:17">
	<return pos:start="4377:9" pos:end="4377:17">return <expr pos:start="4377:16" pos:end="4377:16"><literal type="number" pos:start="4377:16" pos:end="4377:16">0</literal></expr>;</return>
    </block_content>}</block></else></if_stmt>
</block_content>}</block></function>
</unit>
